<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Browse Offerings â€” AFL</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700;9..40,800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<!-- Load shared.js when running standalone (shell will have already loaded it in production) -->
<script>
if (!window.AFL) {
  document.write('<script src="shared.js"><\/script>');
}
</script>
<style>
/* â”€â”€ Design tokens â”€â”€ */
:root {
  --navy:    #0B1F3B;
  --navy2:   #1C3A63;
  --navy3:   #2A4D7A;
  --slate:   #3A5270;
  --slate2:  #5C7A99;
  --fog:     #8FA3BA;
  --mist:    #C8D8E8;
  --ice:     #E8F0F8;
  --white:   #FFFFFF;
  --surface: #F4F7FB;
  --surface2:#EEF3FA;
  --green:   #1A7A4A;
  --green-lt:#E8F7EF;
  --amber:   #B45309;
  --amber-lt:#FEF3C7;
  --red:     #991B1B;
  --red-lt:  #FEE2E2;
  --blue:    #1D4ED8;
  --blue-lt: #EFF6FF;
  --radius:  8px;
  --radius-lg: 14px;
  --shadow-sm: 0 1px 3px rgba(11,31,59,0.08), 0 1px 2px rgba(11,31,59,0.05);
  --shadow:    0 4px 12px rgba(11,31,59,0.10);
  --shadow-lg: 0 12px 32px rgba(11,31,59,0.14);
  --font: 'DM Sans', sans-serif;
  --transition: 0.18s cubic-bezier(0.4,0,0.2,1);
}

/* â”€â”€ Reset & base â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: var(--font); background: var(--surface); color: var(--slate); }

/* â”€â”€ Browse root layout â”€â”€ */
#browse-root {
  display: flex;
  height: 100%;
  overflow: hidden;
  font-family: var(--font);
}

/* â”€â”€ Filter sidebar â”€â”€ */
#filter-panel {
  width: 236px;
  min-width: 236px;
  background: var(--white);
  border-right: 1px solid var(--mist);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: width var(--transition), min-width var(--transition);
}
#filter-panel.collapsed {
  width: 0;
  min-width: 0;
  overflow: hidden;
}
.filter-header {
  padding: 16px 16px 12px;
  border-bottom: 1px solid var(--mist);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-shrink: 0;
}
.filter-header-title {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--fog);
}
.filter-clear-btn {
  font-size: 11px;
  font-weight: 600;
  color: var(--blue);
  background: none;
  border: none;
  cursor: pointer;
  padding: 2px 4px;
  border-radius: 4px;
  transition: background var(--transition);
}
.filter-clear-btn:hover { background: var(--blue-lt); }

.filter-scroll {
  flex: 1;
  overflow-y: auto;
  padding: 12px 0;
}
.filter-scroll::-webkit-scrollbar { width: 4px; }
.filter-scroll::-webkit-scrollbar-thumb { background: var(--mist); border-radius: 2px; }

.filter-section {
  padding: 0 16px 16px;
  border-bottom: 1px solid var(--surface2);
  margin-bottom: 4px;
}
.filter-section:last-child { border-bottom: none; }
.filter-section-label {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--fog);
  margin-bottom: 8px;
  margin-top: 12px;
}
.filter-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
}
.filter-chip {
  font-size: 12px;
  font-weight: 500;
  padding: 4px 10px;
  border-radius: 100px;
  border: 1.5px solid var(--mist);
  background: var(--white);
  color: var(--slate2);
  cursor: pointer;
  transition: all var(--transition);
  white-space: nowrap;
  user-select: none;
}
.filter-chip:hover { border-color: var(--navy2); color: var(--navy2); }
.filter-chip.active {
  background: var(--navy2);
  border-color: var(--navy2);
  color: var(--white);
}
.filter-range-row {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 6px;
}
.filter-range-label {
  font-size: 11px;
  color: var(--fog);
  width: 28px;
  flex-shrink: 0;
}
.filter-range-input {
  flex: 1;
  height: 3px;
  -webkit-appearance: none;
  background: var(--mist);
  border-radius: 2px;
  outline: none;
  cursor: pointer;
}
.filter-range-input::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: var(--navy2);
  cursor: pointer;
  box-shadow: var(--shadow-sm);
}
.filter-range-val {
  font-size: 11px;
  font-weight: 600;
  color: var(--slate);
  min-width: 38px;
  text-align: right;
  font-family: 'DM Mono', monospace;
}

.filter-state-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 4px;
}
.filter-state-btn {
  font-size: 10px;
  font-weight: 600;
  padding: 4px 2px;
  border-radius: 4px;
  border: 1.5px solid var(--mist);
  background: var(--white);
  color: var(--slate2);
  cursor: pointer;
  text-align: center;
  transition: all var(--transition);
  user-select: none;
}
.filter-state-btn:hover { border-color: var(--navy2); color: var(--navy2); }
.filter-state-btn.active { background: var(--navy2); border-color: var(--navy2); color: var(--white); }

/* â”€â”€ Main content area â”€â”€ */
#browse-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-width: 0;
}

/* â”€â”€ Action bar â”€â”€ */
.browse-action-bar {
  background: var(--white);
  border-bottom: 1px solid var(--mist);
  padding: 10px 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
  flex-wrap: wrap;
}
.btn-filter-toggle {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  font-weight: 600;
  color: var(--slate);
  background: var(--surface);
  border: 1.5px solid var(--mist);
  border-radius: var(--radius);
  padding: 7px 12px;
  cursor: pointer;
  transition: all var(--transition);
  white-space: nowrap;
}
.btn-filter-toggle:hover { background: var(--ice); border-color: var(--navy2); color: var(--navy2); }
.btn-filter-toggle svg { width: 15px; height: 15px; }

.search-wrap {
  flex: 1;
  min-width: 180px;
  max-width: 380px;
  position: relative;
}
.search-wrap svg {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 15px;
  height: 15px;
  color: var(--fog);
  pointer-events: none;
}
.search-input {
  width: 100%;
  padding: 8px 12px 8px 32px;
  font-family: var(--font);
  font-size: 13px;
  background: var(--surface);
  border: 1.5px solid var(--mist);
  border-radius: var(--radius);
  outline: none;
  color: var(--slate);
  transition: border-color var(--transition);
}
.search-input::placeholder { color: var(--fog); }
.search-input:focus { border-color: var(--navy2); background: var(--white); }

.sort-select {
  font-family: var(--font);
  font-size: 13px;
  font-weight: 500;
  color: var(--slate);
  background: var(--surface);
  border: 1.5px solid var(--mist);
  border-radius: var(--radius);
  padding: 7px 30px 7px 12px;
  outline: none;
  cursor: pointer;
  -webkit-appearance: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' fill='none'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%238FA3BA' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  transition: border-color var(--transition);
}
.sort-select:focus { border-color: var(--navy2); }

.result-count {
  font-size: 12px;
  color: var(--fog);
  font-weight: 500;
  white-space: nowrap;
}

.spacer { flex: 1; }

.view-toggle {
  display: flex;
  border: 1.5px solid var(--mist);
  border-radius: var(--radius);
  overflow: hidden;
  background: var(--surface);
}
.view-btn {
  padding: 6px 10px;
  border: none;
  background: transparent;
  cursor: pointer;
  color: var(--fog);
  display: flex;
  align-items: center;
  transition: all var(--transition);
}
.view-btn.active { background: var(--navy2); color: var(--white); }
.view-btn:hover:not(.active) { background: var(--ice); color: var(--slate); }
.view-btn svg { width: 15px; height: 15px; }

/* â”€â”€ Active filter pills â”€â”€ */
.active-filters {
  background: var(--surface2);
  border-bottom: 1px solid var(--mist);
  padding: 6px 20px;
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
  flex-shrink: 0;
}
.active-filters.hidden { display: none; }
.active-filter-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--fog);
  letter-spacing: 0.05em;
  text-transform: uppercase;
  margin-right: 2px;
}
.active-filter-pill {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  font-weight: 500;
  color: var(--navy2);
  background: var(--ice);
  border: 1px solid var(--mist);
  border-radius: 100px;
  padding: 2px 8px 2px 10px;
}
.active-filter-pill button {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--fog);
  font-size: 14px;
  line-height: 1;
  padding: 0 0 0 2px;
  display: flex;
  align-items: center;
  transition: color var(--transition);
}
.active-filter-pill button:hover { color: var(--red); }

/* â”€â”€ Grid/List content â”€â”€ */
.browse-content {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}
.browse-content::-webkit-scrollbar { width: 6px; }
.browse-content::-webkit-scrollbar-thumb { background: var(--mist); border-radius: 3px; }

/* â”€â”€ Card grid â”€â”€ */
.card-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px;
}

/* â”€â”€ Fund Card â”€â”€ */
.fund-card {
  background: var(--white);
  border-radius: var(--radius-lg);
  border: 1.5px solid var(--mist);
  overflow: hidden;
  cursor: pointer;
  transition: all var(--transition);
  display: flex;
  flex-direction: column;
  position: relative;
}
.fund-card:hover {
  border-color: var(--navy2);
  box-shadow: var(--shadow);
  transform: translateY(-2px);
}
.fund-card.in-basket {
  border-color: var(--navy2);
  background: linear-gradient(180deg, var(--blue-lt) 0%, var(--white) 60px);
}

.card-top {
  padding: 14px 16px 10px;
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 10px;
}
.card-logo-wrap {
  width: 44px;
  height: 44px;
  border-radius: 10px;
  background: var(--ice);
  border: 1px solid var(--mist);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  overflow: hidden;
}
.card-logo-wrap img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  padding: 4px;
}
.card-logo-initials {
  font-size: 13px;
  font-weight: 800;
  color: var(--navy2);
  letter-spacing: -0.02em;
}
.card-title-area { flex: 1; min-width: 0; }
.card-sponsor {
  font-size: 10px;
  font-weight: 600;
  color: var(--fog);
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-bottom: 2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.card-name {
  font-size: 14px;
  font-weight: 700;
  color: var(--navy);
  line-height: 1.25;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.card-badges {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 4px;
  flex-shrink: 0;
}
.status-badge {
  font-size: 10px;
  font-weight: 700;
  padding: 3px 8px;
  border-radius: 100px;
  letter-spacing: 0.04em;
  white-space: nowrap;
}
.status-badge.open     { background: var(--green-lt); color: var(--green); }
.status-badge.closing  { background: var(--amber-lt); color: var(--amber); }
.status-badge.closed   { background: var(--red-lt);   color: var(--red);   }
.basket-badge {
  font-size: 10px;
  font-weight: 700;
  padding: 2px 7px;
  border-radius: 100px;
  background: var(--blue-lt);
  color: var(--blue);
  letter-spacing: 0.02em;
}

/* sector/class tag */
.card-meta-row {
  padding: 0 16px 10px;
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
}
.card-tag {
  font-size: 11px;
  font-weight: 500;
  padding: 2px 8px;
  border-radius: 4px;
  background: var(--surface);
  border: 1px solid var(--mist);
  color: var(--slate2);
}
.card-tag.asset { background: var(--ice); border-color: var(--navy3); color: var(--navy3); }

/* KPI row */
.card-kpi-row {
  padding: 10px 16px;
  background: var(--surface);
  border-top: 1px solid var(--mist);
  border-bottom: 1px solid var(--mist);
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 4px;
}
.kpi-cell {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 4px 2px;
}
.kpi-label {
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.07em;
  color: var(--fog);
  margin-bottom: 2px;
}
.kpi-val {
  font-size: 15px;
  font-weight: 700;
  color: var(--navy);
  font-family: 'DM Mono', monospace;
  line-height: 1.1;
}
.kpi-val.highlight { color: var(--green); }
.kpi-val.warn      { color: var(--amber); }
.kpi-val.muted     { color: var(--fog); font-size: 12px; font-weight: 500; }

/* â”€â”€ Enhanced raise progress bar â”€â”€ */
.card-raise-row {
  padding: 11px 16px 10px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.raise-label-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
}
.raise-label {
  font-size: 10px;
  font-weight: 700;
  color: var(--fog);
  text-transform: uppercase;
  letter-spacing: 0.07em;
}
.raise-pct {
  font-size: 12px;
  font-weight: 700;
  color: var(--slate);
  font-family: 'DM Mono', monospace;
}

/* Thick 3D-style bar */
.raise-bar-track {
  height: 12px;
  background: var(--ice);
  border-radius: 6px;
  overflow: hidden;
  box-shadow: inset 0 2px 4px rgba(11,31,59,0.12), inset 0 1px 2px rgba(11,31,59,0.08);
  position: relative;
}
.raise-bar-fill {
  height: 100%;
  border-radius: 6px;
  background: linear-gradient(180deg,
    #4A90D9 0%,
    #1C3A63 50%,
    #0B2445 100%
  );
  box-shadow:
    0 2px 4px rgba(11,31,59,0.35),
    inset 0 1px 0 rgba(255,255,255,0.25);
  position: relative;
  transition: width 0.5s cubic-bezier(0.4,0,0.2,1);
}
/* Sheen highlight on bar */
.raise-bar-fill::after {
  content: '';
  position: absolute;
  top: 1px;
  left: 4px;
  right: 4px;
  height: 40%;
  background: linear-gradient(180deg, rgba(255,255,255,0.30) 0%, rgba(255,255,255,0) 100%);
  border-radius: 3px;
}
.raise-bar-fill.closing-soon {
  background: linear-gradient(180deg,
    #F59E3A 0%,
    #B45309 50%,
    #7C3A00 100%
  );
}
.raise-bar-fill.nearly-done {
  background: linear-gradient(180deg,
    #F87171 0%,
    #991B1B 50%,
    #6B0000 100%
  );
}

/* Raise $ breakdown row */
.raise-amounts {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 4px;
  margin-top: 2px;
}
.raise-amount-cell {
  display: flex;
  flex-direction: column;
  align-items: center;
}
.raise-amount-label {
  font-size: 8.5px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--fog);
  margin-bottom: 1px;
}
.raise-amount-val {
  font-size: 11px;
  font-weight: 700;
  color: var(--slate);
  font-family: 'DM Mono', monospace;
}
.raise-amount-val.filed   { color: var(--navy2); }
.raise-amount-val.current { color: var(--green); }
.raise-amount-val.remaining { color: var(--amber); }

/* suitability chip */
.suit-chip {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 11px;
  font-weight: 600;
  padding: 3px 8px;
  border-radius: 100px;
}
.suit-chip.high  { background: var(--green-lt); color: var(--green); }
.suit-chip.mid   { background: var(--amber-lt); color: var(--amber); }
.suit-chip.low   { background: var(--red-lt);   color: var(--red);   }
.suit-chip.none  { background: var(--ice);       color: var(--fog);   }

/* card footer */
.card-footer {
  padding: 10px 16px 12px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 8px;
}
.card-footer-left {
  display: flex;
  flex-direction: column;
  gap: 3px;
}
.card-location {
  font-size: 11px;
  color: var(--fog);
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 160px;
}
.btn-add-basket {
  display: flex;
  align-items: center;
  gap: 5px;
  font-family: var(--font);
  font-size: 12px;
  font-weight: 600;
  padding: 7px 12px;
  border-radius: var(--radius);
  border: 1.5px solid var(--navy2);
  background: var(--white);
  color: var(--navy2);
  cursor: pointer;
  transition: all var(--transition);
  white-space: nowrap;
  flex-shrink: 0;
}
.btn-add-basket:hover { background: var(--navy2); color: var(--white); }
.btn-add-basket.in-basket {
  background: var(--navy2);
  color: var(--white);
  border-color: var(--navy2);
}
.btn-add-basket:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}
.btn-add-basket svg { width: 13px; height: 13px; }

/* â”€â”€ List/table view â”€â”€ */
.fund-table {
  width: 100%;
  border-collapse: collapse;
  background: var(--white);
  border-radius: var(--radius-lg);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
  font-size: 13px;
}
.fund-table thead {
  background: var(--navy);
  color: var(--white);
}
.fund-table th {
  padding: 10px 14px;
  text-align: left;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  white-space: nowrap;
  cursor: pointer;
  user-select: none;
  transition: background var(--transition);
}
.fund-table th:hover { background: var(--navy2); }
.fund-table th.sorted { background: var(--navy2); }
.sort-arrow { margin-left: 4px; opacity: 0.6; }
.fund-table tbody tr {
  border-bottom: 1px solid var(--mist);
  cursor: pointer;
  transition: background var(--transition);
}
.fund-table tbody tr:last-child { border-bottom: none; }
.fund-table tbody tr:hover { background: var(--surface); }
.fund-table tbody tr.in-basket { background: var(--blue-lt); }
.fund-table td {
  padding: 11px 14px;
  vertical-align: middle;
}
.td-name { font-weight: 600; color: var(--navy); }
.td-sponsor { color: var(--fog); font-size: 11px; }
.td-mono {
  font-family: 'DM Mono', monospace;
  font-size: 12px;
  font-weight: 500;
}
.td-green { color: var(--green); font-weight: 600; }
.td-actions {
  display: flex;
  gap: 6px;
  align-items: center;
  justify-content: flex-end;
}
.btn-sm {
  font-family: var(--font);
  font-size: 11px;
  font-weight: 600;
  padding: 5px 9px;
  border-radius: 6px;
  border: 1.5px solid var(--mist);
  background: var(--white);
  color: var(--slate);
  cursor: pointer;
  transition: all var(--transition);
  white-space: nowrap;
}
.btn-sm:hover { border-color: var(--navy2); color: var(--navy2); }
.btn-sm.primary { background: var(--navy2); border-color: var(--navy2); color: var(--white); }
.btn-sm.primary:hover { background: var(--navy3); }

/* â”€â”€ Empty/loading states â”€â”€ */
.state-msg {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 20px;
  text-align: center;
  color: var(--fog);
}
.state-msg .icon {
  font-size: 40px;
  margin-bottom: 16px;
  opacity: 0.5;
}
.state-msg h3 {
  font-size: 16px;
  font-weight: 700;
  color: var(--slate2);
  margin-bottom: 6px;
}
.state-msg p { font-size: 14px; max-width: 320px; }

/* skeleton loader */
.skeleton-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px;
}
.skeleton-card {
  background: var(--white);
  border-radius: var(--radius-lg);
  border: 1.5px solid var(--mist);
  padding: 16px;
  height: 260px;
  overflow: hidden;
  position: relative;
}
.skeleton-card::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.6) 50%, transparent 100%);
  animation: shimmer 1.4s infinite;
}
@keyframes shimmer { from { transform: translateX(-100%); } to { transform: translateX(100%); } }
.skel { background: var(--ice); border-radius: 4px; margin-bottom: 8px; }
.skel-h  { height: 14px; }
.skel-sm { height: 10px; width: 60%; }
.skel-lg { height: 22px; width: 75%; }
</style>
</head>
<body>

<div id="browse-root">

  <!-- Filter sidebar -->
  <aside id="filter-panel">
    <div class="filter-header">
      <span class="filter-header-title">Filters</span>
      <button class="filter-clear-btn" id="clear-filters-btn">Clear all</button>
    </div>
    <div class="filter-scroll" id="filter-scroll-area">

      <!-- Status -->
      <div class="filter-section">
        <div class="filter-section-label">Status</div>
        <div class="filter-chips" id="filter-status">
          <div class="filter-chip" data-group="status" data-val="Open">Open</div>
          <div class="filter-chip" data-group="status" data-val="Closing Soon">Closing Soon</div>
          <div class="filter-chip" data-group="status" data-val="Closed">Closed</div>
        </div>
      </div>

      <!-- Asset Class -->
      <div class="filter-section">
        <div class="filter-section-label">Asset Class</div>
        <div class="filter-chips" id="filter-asset-class">
          <!-- populated from data -->
        </div>
      </div>

      <!-- Sector -->
      <div class="filter-section">
        <div class="filter-section-label">Sector</div>
        <div class="filter-chips" id="filter-sector">
          <!-- populated from data -->
        </div>
      </div>

      <!-- States -->
      <div class="filter-section">
        <div class="filter-section-label">State</div>
        <div class="filter-state-grid" id="filter-states">
          <!-- populated from data -->
        </div>
      </div>

      <!-- LTV Range -->
      <div class="filter-section">
        <div class="filter-section-label">Max LTV</div>
        <div class="filter-range-row">
          <span class="filter-range-label">0%</span>
          <input type="range" class="filter-range-input" id="ltv-range" min="0" max="80" step="5" value="80">
          <span class="filter-range-val" id="ltv-range-val">Any</span>
        </div>
      </div>

      <!-- CoC Range -->
      <div class="filter-section">
        <div class="filter-section-label">Min Y1 CoC</div>
        <div class="filter-range-row">
          <span class="filter-range-label">0%</span>
          <input type="range" class="filter-range-input" id="coc-range" min="0" max="9" step="0.25" value="0">
          <span class="filter-range-val" id="coc-range-val">Any</span>
        </div>
      </div>

    </div><!-- /filter-scroll -->
  </aside><!-- /filter-panel -->

  <!-- Main -->
  <main id="browse-main">

    <!-- Action bar -->
    <div class="browse-action-bar">
      <button class="btn-filter-toggle" id="filter-toggle-btn" title="Toggle filters">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round">
          <path d="M2 4h12M5 8h6M7 12h2"/>
        </svg>
        Filters
        <span id="filter-count-badge" style="display:none;background:var(--navy2);color:#fff;font-size:10px;font-weight:700;padding:1px 6px;border-radius:100px;"></span>
      </button>

      <div class="search-wrap">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="7" cy="7" r="4.5"/><path d="M11 11l2.5 2.5"/>
        </svg>
        <input type="text" class="search-input" id="search-input" placeholder="Search offerings, sponsors, locationsâ€¦">
      </div>

      <select class="sort-select" id="sort-select">
        <option value="y1coc_desc">Y1 CoC â†“ High</option>
        <option value="y1coc_asc">Y1 CoC â†‘ Low</option>
        <option value="ltv_asc">LTV â†‘ Low</option>
        <option value="ltv_desc">LTV â†“ High</option>
        <option value="remaining_desc">% Remaining â†“</option>
        <option value="remaining_asc">% Remaining â†‘</option>
        <option value="name_asc">Name Aâ†’Z</option>
        <option value="newest">Newest First</option>
      </select>

      <span class="result-count" id="result-count"></span>
      <span class="spacer"></span>

      <div class="view-toggle">
        <button class="view-btn active" id="view-grid" title="Grid view">
          <svg viewBox="0 0 16 16" fill="currentColor">
            <rect x="1" y="1" width="6" height="6" rx="1.2"/>
            <rect x="9" y="1" width="6" height="6" rx="1.2"/>
            <rect x="1" y="9" width="6" height="6" rx="1.2"/>
            <rect x="9" y="9" width="6" height="6" rx="1.2"/>
          </svg>
        </button>
        <button class="view-btn" id="view-list" title="List view">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round">
            <path d="M4 4h9M4 8h9M4 12h9M1.5 4h.01M1.5 8h.01M1.5 12h.01"/>
          </svg>
        </button>
      </div>
    </div><!-- /action-bar -->

    <!-- Active filter pills row -->
    <div class="active-filters hidden" id="active-filters-bar">
      <span class="active-filter-label">Active:</span>
      <!-- pills injected here -->
    </div>

    <!-- Content area -->
    <div class="browse-content" id="browse-content">
      <!-- cards/table injected here -->
    </div>

  </main><!-- /browse-main -->
</div><!-- /browse-root -->

<script>
// ============================================================
//  AFL Browse Module
//  Exports: window.currentModule = { init(params) {} }
// ============================================================

(function () {
  'use strict';

  // â”€â”€ Internal state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let allFunds    = [];
  let filtered    = [];
  let viewMode    = 'grid';
  let filterPanel = true;
  let client      = null;

  const filters = {
    status:    new Set(),
    assetClass:new Set(),
    sector:    new Set(),
    states:    new Set(),
    maxLtv:    80,
    minCoc:    0,
    search:    ''
  };
  let sortKey = 'y1coc_desc';

  // â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const $ = id => document.getElementById(id);

  // â”€â”€ PCT fix: GViz returns percent fields as decimals â”€â”€â”€â”€â”€
  // e.g. 0.0525 for 5.25%. Multiply by 100 if value < 1.
  const PCT_FIELDS = new Set(['y1coc','ltv','occupancy','preferred','repComp',
    'capRate','salesLoad','sponsorAvgIrr','sponsorBestIrr','sponsorWorstIrr']);

  function fixPct(val, field) {
    if (val == null || isNaN(Number(val))) return val;
    if (!PCT_FIELDS.has(field)) return val;
    const n = Number(val);
    // If absolute value < 1, it's a decimal fraction â€” convert to percentage
    if (Math.abs(n) < 1 && n !== 0) return n * 100;
    return n;
  }

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function fmt(n, decimals=2, suffix='%') {
    if (n == null || isNaN(Number(n))) return 'â€”';
    return Number(n).toFixed(decimals) + suffix;
  }

  // Format money in the style "$29.56 M"
  function fmtMoney(n) {
    if (n == null || isNaN(Number(n))) return 'â€”';
    n = Number(n);
    if (n >= 1e9) return '$' + (n/1e9).toFixed(2).replace(/\.?0+$/,'') + ' B';
    if (n >= 1e6) return '$' + (n/1e6).toFixed(2).replace(/\.?0+$/,'') + ' M';
    if (n >= 1e3) return '$' + (n/1e3).toFixed(2).replace(/\.?0+$/,'') + ' K';
    return '$' + n.toFixed(0);
  }

  function initials(str) {
    if (!str) return '??';
    return str.split(/\s+/).slice(0,2).map(w=>w[0]).join('').toUpperCase();
  }
  function esc(s) {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
  function statusOf(fund) {
    if (fund.status) return fund.status;
    if (!fund.offeringClose) return 'Open';
    const close = new Date(fund.offeringClose);
    if (isNaN(close)) return 'Open';
    const now = new Date();
    const daysLeft = (close - now) / (1000*60*60*24);
    if (daysLeft < 0)  return 'Closed';
    if (daysLeft < 30) return 'Closing Soon';
    return 'Open';
  }
  function pctRemaining(fund) {
    if (!fund.filedRaise || !fund.equityRemaining) return null;
    const pct = (fund.equityRemaining / fund.filedRaise) * 100;
    return Math.min(100, Math.max(0, pct));
  }

  // â”€â”€ Suitability chip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function suitChip(fund) {
    if (!window.AFL || !window.AFL.suitScore) return '';
    if (!client || !client.exchangeAmount) return '';
    const score = window.AFL.suitScore(fund, client);
    if (score == null || isNaN(score)) return '';
    const scoreNum = parseInt(score, 10);
    let cls, label;
    if (scoreNum >= 70) { cls='high'; label='â˜… ' + scoreNum + '% match'; }
    else if (scoreNum >= 45) { cls='mid'; label='â—† ' + scoreNum + '% match'; }
    else { cls='low'; label='â–¼ ' + scoreNum + '% match'; }
    return `<span class="suit-chip ${cls}">${label}</span>`;
  }

  // â”€â”€ Status badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function statusBadge(status) {
    const cls = status === 'Open' ? 'open' : status === 'Closing Soon' ? 'closing' : 'closed';
    return `<span class="status-badge ${cls}">${esc(status)}</span>`;
  }

  // â”€â”€ LTV color class â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function ltvClass(ltv) {
    if (ltv == null || isNaN(ltv)) return 'muted';
    if (ltv <= 55) return 'highlight';
    if (ltv > 65)  return 'warn';
    return '';
  }

  // â”€â”€ Basket check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function inBasket(id) {
    if (window.AFL && window.AFL.basket) return window.AFL.basket.has(id);
    try {
      const b = JSON.parse(localStorage.getItem('afl_basket')||'[]');
      return b.includes(id);
    } catch(e){ return false; }
  }
  function basketFull() {
    if (window.AFL && window.AFL.basket) return window.AFL.basket.get().length >= 3;
    try {
      const b = JSON.parse(localStorage.getItem('afl_basket')||'[]');
      return b.length >= 3;
    } catch(e){ return false; }
  }

  // â”€â”€ Build a fund card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildCard(fund) {
    const status  = statusOf(fund);
    const pctRem  = pctRemaining(fund);
    const isIn    = inBasket(fund.id);
    const full    = !isIn && basketFull();

    // Apply percent fix for display values
    const coc = fixPct(fund.y1coc, 'y1coc');
    const ltv = fixPct(fund.ltv, 'ltv');
    const occ = fixPct(fund.occupancy, 'occupancy');

    const chip = suitChip(fund);

    const logoHtml = fund.sponsorLogoUrl
      ? `<img src="${esc(fund.sponsorLogoUrl)}" alt="${esc(fund.sponsor)}" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">`
      + `<span class="card-logo-initials" style="display:none">${esc(initials(fund.sponsor))}</span>`
      : `<span class="card-logo-initials">${esc(initials(fund.sponsor))}</span>`;

    // â”€â”€ Raise progress bar â”€â”€
    // Bar fill = pctRemaining (e.g. 89% remaining â†’ bar is 89% filled)
    let raiseHtml = '';
    if (pctRem != null) {
      const barW = pctRem.toFixed(1);
      let barCls = '';
      if (pctRem < 10)      barCls = ' nearly-done';
      else if (pctRem < 25) barCls = ' closing-soon';

      // Dollar amounts
      const filed     = fund.filedRaise     ? fmtMoney(fund.filedRaise)     : 'â€”';
      const current   = fund.currentRaise   ? fmtMoney(fund.currentRaise)   : 'â€”';
      const remaining = fund.equityRemaining ? fmtMoney(fund.equityRemaining) : 'â€”';

      raiseHtml = `
        <div class="card-raise-row">
          <div class="raise-label-row">
            <span class="raise-label">Raise Progress</span>
            <span class="raise-pct">${pctRem.toFixed(0)}% remaining</span>
          </div>
          <div class="raise-bar-track">
            <div class="raise-bar-fill${barCls}" style="width:${barW}%"></div>
          </div>
          <div class="raise-amounts">
            <div class="raise-amount-cell">
              <span class="raise-amount-label">Filed Raise</span>
              <span class="raise-amount-val filed">${esc(filed)}</span>
            </div>
            <div class="raise-amount-cell">
              <span class="raise-amount-label">Current Raise</span>
              <span class="raise-amount-val current">${esc(current)}</span>
            </div>
            <div class="raise-amount-cell">
              <span class="raise-amount-label">Remaining</span>
              <span class="raise-amount-val remaining">${esc(remaining)}</span>
            </div>
          </div>
        </div>`;
    }

    const basketLabel  = isIn ? 'In Basket âœ“' : '+ Basket';
    const basketCls    = isIn ? ' in-basket' : '';
    const disabledAttr = full ? ' disabled' : '';

    return `
    <div class="fund-card${isIn ? ' in-basket':''}" data-id="${fund.id}">
      <div class="card-top">
        <div class="card-logo-wrap">${logoHtml}</div>
        <div class="card-title-area">
          <div class="card-sponsor">${esc(fund.sponsor||'â€”')}</div>
          <div class="card-name">${esc(fund.name||'Unnamed Offering')}</div>
        </div>
        <div class="card-badges">
          ${statusBadge(status)}
          ${isIn ? '<span class="basket-badge">In Basket</span>' : ''}
        </div>
      </div>
      <div class="card-meta-row">
        ${fund.assetClass ? `<span class="card-tag asset">${esc(fund.assetClass)}</span>` : ''}
        ${fund.sector     ? `<span class="card-tag">${esc(fund.sector)}</span>` : ''}
        ${fund.focus      ? `<span class="card-tag">${esc(fund.focus)}</span>` : ''}
      </div>
      <div class="card-kpi-row">
        <div class="kpi-cell">
          <span class="kpi-label">Y1 CoC</span>
          <span class="kpi-val ${coc != null && coc >= 4 ? 'highlight':''}">${fmt(coc)}</span>
        </div>
        <div class="kpi-cell">
          <span class="kpi-label">LTV</span>
          <span class="kpi-val ${ltvClass(ltv)}">${fmt(ltv)}</span>
        </div>
        <div class="kpi-cell">
          <span class="kpi-label">Occupancy</span>
          <span class="kpi-val ${occ != null && occ >= 90 ? 'highlight':''}">${fmt(occ)}</span>
        </div>
      </div>
      ${raiseHtml}
      <div class="card-footer">
        <div class="card-footer-left">
          ${chip ? chip : `<span class="card-location">ğŸ“ ${esc(fund.location||'â€”')}</span>`}
          ${chip ? `<span class="card-location">ğŸ“ ${esc(fund.location||'â€”')}</span>` : ''}
        </div>
        <button class="btn-add-basket${basketCls}" data-id="${fund.id}"${disabledAttr}
          title="${full?'Basket full (max 3)':isIn?'Remove from basket':'Add to basket'}">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            ${isIn
              ? '<path d="M3 8l3.5 3.5L13 4.5"/>'
              : '<path d="M8 3v10M3 8h10"/>'}
          </svg>
          ${basketLabel}
        </button>
      </div>
    </div>`;
  }

  // â”€â”€ Build table row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildRow(fund) {
    const status = statusOf(fund);
    const isIn   = inBasket(fund.id);
    const full   = !isIn && basketFull();
    const chip   = suitChip(fund);
    const coc    = fixPct(fund.y1coc, 'y1coc');
    const ltv    = fixPct(fund.ltv, 'ltv');
    const occ    = fixPct(fund.occupancy, 'occupancy');
    return `
    <tr data-id="${fund.id}" class="${isIn?'in-basket':''}">
      <td>
        <div class="td-name">${esc(fund.name||'Unnamed')}</div>
        <div class="td-sponsor">${esc(fund.sponsor||'â€”')}</div>
      </td>
      <td><span class="card-tag asset" style="white-space:nowrap">${esc(fund.assetClass||'â€”')}</span></td>
      <td><span class="card-tag" style="white-space:nowrap">${esc(fund.sector||'â€”')}</span></td>
      <td>${statusBadge(status)}</td>
      <td class="td-mono td-green">${fmt(coc)}</td>
      <td class="td-mono ${ltvClass(ltv)==='highlight'?'td-green':''}">${fmt(ltv)}</td>
      <td class="td-mono">${fmt(occ)}</td>
      <td class="td-mono">${fmtMoney(fund.minInvest)}</td>
      <td>${fund.holdPeriod!=null ? fund.holdPeriod+'yr':''}</td>
      <td>${chip||'â€”'}</td>
      <td>
        <div class="td-actions">
          <button class="btn-sm" data-id="${fund.id}" title="View offering">View</button>
          <button class="btn-sm primary btn-add-basket${isIn?' in-basket':''}" data-id="${fund.id}" ${full?'disabled':''}>
            ${isIn ? 'âœ“ In Basket' : '+ Basket'}
          </button>
        </div>
      </td>
    </tr>`;
  }

  // â”€â”€ Sort funds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function sortFunds(arr) {
    const sorted = [...arr];
    // Helper to get fixed pct for sorting
    const getY1 = f => fixPct(f.y1coc, 'y1coc') || 0;
    const getLtv = f => fixPct(f.ltv, 'ltv') || 0;
    switch(sortKey) {
      case 'y1coc_desc':    sorted.sort((a,b)=>getY1(b)-getY1(a)); break;
      case 'y1coc_asc':     sorted.sort((a,b)=>getY1(a)-getY1(b)); break;
      case 'ltv_asc':       sorted.sort((a,b)=>(getLtv(a)||99)-(getLtv(b)||99)); break;
      case 'ltv_desc':      sorted.sort((a,b)=>getLtv(b)-getLtv(a)); break;
      case 'remaining_desc':sorted.sort((a,b)=>(pctRemaining(b)||0)-(pctRemaining(a)||0)); break;
      case 'remaining_asc': sorted.sort((a,b)=>(pctRemaining(a)||0)-(pctRemaining(b)||0)); break;
      case 'name_asc':      sorted.sort((a,b)=>(a.name||'').localeCompare(b.name||'')); break;
      case 'newest':
        sorted.sort((a,b)=>{
          const da = a.offeringOpen ? new Date(a.offeringOpen) : new Date(0);
          const db = b.offeringOpen ? new Date(b.offeringOpen) : new Date(0);
          return db-da;
        }); break;
    }
    return sorted;
  }

  // â”€â”€ Apply filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function applyFilters() {
    const q = filters.search.toLowerCase().trim();
    filtered = allFunds.filter(f => {
      if (q) {
        const haystack = [f.name,f.sponsor,f.location,f.sector,f.assetClass,f.focus]
          .join(' ').toLowerCase();
        if (!haystack.includes(q)) return false;
      }
      if (filters.status.size && !filters.status.has(statusOf(f))) return false;
      if (filters.assetClass.size && !filters.assetClass.has(f.assetClass)) return false;
      if (filters.sector.size && !filters.sector.has(f.sector)) return false;
      if (filters.states.size) {
        const fundStates = extractStates(f.location);
        if (!fundStates.some(s => filters.states.has(s))) return false;
      }
      const ltvVal = fixPct(f.ltv, 'ltv');
      const cocVal = fixPct(f.y1coc, 'y1coc');
      if (filters.maxLtv < 80 && ltvVal != null && !isNaN(ltvVal) && ltvVal > filters.maxLtv) return false;
      if (filters.minCoc > 0  && cocVal != null && !isNaN(cocVal) && cocVal < filters.minCoc)  return false;
      return true;
    });
    filtered = sortFunds(filtered);
  }

  function extractStates(str) {
    if (window.AFL && window.AFL.extractStates) return window.AFL.extractStates(str);
    if (!str) return [];
    return str.split(/[\s,]+/).map(s=>s.trim().toUpperCase()).filter(s=>s.length===2);
  }

  // â”€â”€ Count active filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function countActiveFilters() {
    return filters.status.size + filters.assetClass.size + filters.sector.size
      + filters.states.size
      + (filters.maxLtv < 80 ? 1 : 0)
      + (filters.minCoc > 0  ? 1 : 0)
      + (filters.search.trim() ? 1 : 0);
  }

  // â”€â”€ Update active filter pills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderActivePills() {
    const bar = $('active-filters-bar');
    const pills = [];
    filters.status.forEach(v    => pills.push({label:`Status: ${v}`,    group:'status',    val:v}));
    filters.assetClass.forEach(v=> pills.push({label:`Class: ${v}`,     group:'assetClass',val:v}));
    filters.sector.forEach(v    => pills.push({label:`Sector: ${v}`,    group:'sector',    val:v}));
    filters.states.forEach(v    => pills.push({label:`State: ${v}`,     group:'states',    val:v}));
    if (filters.maxLtv < 80) pills.push({label:`LTV â‰¤ ${filters.maxLtv}%`, group:'ltv', val:null});
    if (filters.minCoc > 0)  pills.push({label:`CoC â‰¥ ${filters.minCoc}%`, group:'coc', val:null});

    if (!pills.length) { bar.classList.add('hidden'); return; }
    bar.classList.remove('hidden');
    bar.innerHTML = '<span class="active-filter-label">Active:</span>'
      + pills.map(p=>`
        <span class="active-filter-pill">
          ${esc(p.label)}
          <button data-group="${esc(p.group)}" data-val="${esc(p.val||'')}" title="Remove filter">âœ•</button>
        </span>`).join('');
    bar.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        removeSingleFilter(btn.dataset.group, btn.dataset.val);
        fullRender();
      });
    });
  }

  function removeSingleFilter(group, val) {
    if (group === 'ltv') { filters.maxLtv = 80; $('ltv-range').value = 80; $('ltv-range-val').textContent = 'Any'; }
    else if (group === 'coc') { filters.minCoc = 0; $('coc-range').value = 0; $('coc-range-val').textContent = 'Any'; }
    else if (filters[group]) { filters[group].delete(val); }
    document.querySelectorAll(`.filter-chip[data-group="${group}"][data-val="${val}"]`)
      .forEach(c => c.classList.remove('active'));
    document.querySelectorAll(`.filter-state-btn[data-val="${val}"]`)
      .forEach(c => c.classList.remove('active'));
  }

  // â”€â”€ Main render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderContent() {
    const content = $('browse-content');
    $('result-count').textContent = `${filtered.length} offering${filtered.length!==1?'s':''}`;
    updateFilterBadge();
    renderActivePills();

    if (!filtered.length) {
      content.innerHTML = `
        <div class="state-msg">
          <div class="icon">ğŸ”</div>
          <h3>No offerings found</h3>
          <p>Try adjusting your filters or search term.</p>
        </div>`;
      return;
    }

    if (viewMode === 'grid') {
      content.innerHTML = `<div class="card-grid">${filtered.map(buildCard).join('')}</div>`;
    } else {
      content.innerHTML = `
        <table class="fund-table">
          <thead>
            <tr>
              <th data-sort="name_asc">Offering <span class="sort-arrow">â†•</span></th>
              <th>Class</th>
              <th>Sector</th>
              <th>Status</th>
              <th data-sort="y1coc_desc">Y1 CoC <span class="sort-arrow">â†•</span></th>
              <th data-sort="ltv_asc">LTV <span class="sort-arrow">â†•</span></th>
              <th>Occupancy</th>
              <th>Min Invest</th>
              <th>Hold</th>
              <th>Suitability</th>
              <th></th>
            </tr>
          </thead>
          <tbody>${filtered.map(buildRow).join('')}</tbody>
        </table>`;
      content.querySelectorAll('th[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
          sortKey = th.dataset.sort;
          $('sort-select').value = sortKey;
          applyFilters();
          renderContent();
        });
      });
    }

    // Card/row click â†’ navigate
    content.querySelectorAll('[data-id]').forEach(el => {
      if (el.classList.contains('fund-card') || el.tagName === 'TR') {
        el.addEventListener('click', e => {
          if (e.target.closest('.btn-add-basket')) return;
          const id = parseInt(el.dataset.id);
          if (window.AFL && window.AFL.navigate) {
            window.AFL.navigate('offering', { id: id, ids: [id] });
          }
        });
      }
    });

    // Basket buttons
    content.querySelectorAll('.btn-add-basket').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        handleBasketClick(parseInt(btn.dataset.id));
      });
    });

    // List view "View" buttons
    content.querySelectorAll('.btn-sm:not(.btn-add-basket)').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        const id = parseInt(btn.closest('tr').dataset.id);
        if (window.AFL && window.AFL.navigate) {
          window.AFL.navigate('offering', { id: id, ids: [id] });
        }
      });
    });
  }

  function fullRender() {
    applyFilters();
    renderContent();
  }

  // â”€â”€ Basket click â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function handleBasketClick(id) {
    if (window.AFL && window.AFL.basket) {
      if (window.AFL.basket.has(id)) {
        window.AFL.basket.remove(id);
      } else {
        if (window.AFL.basket.get().length >= 3) {
          alert('Basket is full â€” max 3 offerings. Remove one first.');
          return;
        }
        window.AFL.basket.add(id);
      }
      if (window.AFL.updateHeader) window.AFL.updateHeader();
    } else {
      try {
        let basket = JSON.parse(localStorage.getItem('afl_basket')||'[]');
        if (basket.includes(id)) { basket = basket.filter(x=>x!==id); }
        else { if (basket.length >= 3) { alert('Basket full (max 3).'); return; } basket.push(id); }
        localStorage.setItem('afl_basket', JSON.stringify(basket));
      } catch(e){}
    }
    fullRender();
  }

  // â”€â”€ Filter badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateFilterBadge() {
    const n = countActiveFilters();
    const badge = $('filter-count-badge');
    if (n > 0) { badge.style.display=''; badge.textContent=n; }
    else { badge.style.display='none'; }
  }

  // â”€â”€ Populate dynamic filter options â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildFilterOptions() {
    const classes = [...new Set(allFunds.map(f=>f.assetClass).filter(Boolean))].sort();
    $('filter-asset-class').innerHTML = classes.map(c =>
      `<div class="filter-chip" data-group="assetClass" data-val="${esc(c)}">${esc(c)}</div>`
    ).join('');

    const sectors = [...new Set(allFunds.map(f=>f.sector).filter(Boolean))].sort();
    $('filter-sector').innerHTML = sectors.map(s =>
      `<div class="filter-chip" data-group="sector" data-val="${esc(s)}">${esc(s)}</div>`
    ).join('');

    const stateSet = new Set();
    allFunds.forEach(f => extractStates(f.location).forEach(s => stateSet.add(s)));
    $('filter-states').innerHTML = [...stateSet].sort().map(s =>
      `<div class="filter-state-btn" data-val="${esc(s)}">${esc(s)}</div>`
    ).join('');

    document.querySelectorAll('.filter-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const g = chip.dataset.group, v = chip.dataset.val;
        if (!filters[g]) return;
        if (filters[g].has(v)) filters[g].delete(v);
        else filters[g].add(v);
        chip.classList.toggle('active', filters[g].has(v));
        fullRender();
      });
    });

    document.querySelectorAll('.filter-state-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const v = btn.dataset.val;
        if (filters.states.has(v)) filters.states.delete(v);
        else filters.states.add(v);
        btn.classList.toggle('active', filters.states.has(v));
        fullRender();
      });
    });
  }

  // â”€â”€ Wire up controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function wireControls() {
    $('filter-toggle-btn').addEventListener('click', () => {
      filterPanel = !filterPanel;
      $('filter-panel').classList.toggle('collapsed', !filterPanel);
    });

    let searchTimer;
    $('search-input').addEventListener('input', e => {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => { filters.search = e.target.value; fullRender(); }, 200);
    });

    $('sort-select').addEventListener('change', e => { sortKey = e.target.value; fullRender(); });

    $('view-grid').addEventListener('click', () => {
      viewMode = 'grid';
      $('view-grid').classList.add('active');
      $('view-list').classList.remove('active');
      fullRender();
    });
    $('view-list').addEventListener('click', () => {
      viewMode = 'list';
      $('view-list').classList.add('active');
      $('view-grid').classList.remove('active');
      fullRender();
    });

    $('ltv-range').addEventListener('input', e => {
      filters.maxLtv = parseInt(e.target.value);
      $('ltv-range-val').textContent = filters.maxLtv < 80 ? filters.maxLtv + '%' : 'Any';
      fullRender();
    });

    $('coc-range').addEventListener('input', e => {
      filters.minCoc = parseFloat(e.target.value);
      $('coc-range-val').textContent = filters.minCoc > 0 ? filters.minCoc.toFixed(2) + '%' : 'Any';
      fullRender();
    });

    $('clear-filters-btn').addEventListener('click', clearAllFilters);
  }

  function clearAllFilters() {
    filters.status.clear(); filters.assetClass.clear();
    filters.sector.clear(); filters.states.clear();
    filters.maxLtv = 80; filters.minCoc = 0; filters.search = '';
    $('search-input').value = '';
    $('ltv-range').value = 80; $('ltv-range-val').textContent = 'Any';
    $('coc-range').value = 0;  $('coc-range-val').textContent = 'Any';
    document.querySelectorAll('.filter-chip.active, .filter-state-btn.active')
      .forEach(el => el.classList.remove('active'));
    fullRender();
  }

  // â”€â”€ Loading skeleton â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showSkeleton() {
    $('browse-content').innerHTML = `
      <div class="skeleton-grid">
        ${Array(6).fill().map(()=>`
          <div class="skeleton-card">
            <div class="skel skel-h" style="width:50px;height:44px;border-radius:10px"></div>
            <div class="skel skel-sm" style="margin-top:12px"></div>
            <div class="skel skel-lg"></div>
            <div class="skel skel-h" style="margin-top:16px"></div>
            <div class="skel skel-h"></div>
            <div class="skel skel-sm"></div>
          </div>`).join('')}
      </div>`;
  }

  function showError(msg) {
    $('browse-content').innerHTML = `
      <div class="state-msg">
        <div class="icon">âš ï¸</div>
        <h3>Could not load offerings</h3>
        <p>${esc(msg)}</p>
      </div>`;
  }

  // â”€â”€ PCT fix for fallback-fetched raw data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // When shared.js is absent, the fallback fetcher pulls raw GViz values.
  // We apply the decimalâ†’percent fix across all funds after loading.
  function applyPctFixToFunds(funds) {
    return funds.map(f => {
      const fixed = Object.assign({}, f);
      PCT_FIELDS.forEach(field => {
        if (fixed[field] != null && !isNaN(Number(fixed[field]))) {
          fixed[field] = fixPct(fixed[field], field);
        }
      });
      return fixed;
    });
  }

  // â”€â”€ Module init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init(params = {}) {
    client = (params && params.client) || null;
    if (!client && window.AFL && window.AFL.state) {
      client = window.AFL.state.client || null;
    }

    wireControls();
    showSkeleton();

    try {
      let funds;
      if (window.AFL && typeof window.AFL.loadFunds === 'function') {
        await window.AFL.loadFunds();
        funds = window.AFL.state.funds || [];
        // shared.js v1.1.0+ applies the fix internally; if older version, apply here too
        if (!window.AFL.version || window.AFL.version < '1.1.0') {
          funds = applyPctFixToFunds(funds);
        }
      } else {
        funds = await fetchFundsFallback();
        funds = applyPctFixToFunds(funds);
      }

      allFunds = funds;
      buildFilterOptions();
      fullRender();

    } catch (err) {
      console.error('[Browse] Failed to load funds:', err);
      showError('Please check your network connection and Google Sheets access.');
    }
  }

  // â”€â”€ Fallback fetcher (no shared.js) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function fetchFundsFallback() {
    const SHEET_ID   = '1xVFw8pFrJzcxD8CH7ainimPKD6GW9tn1bb8ggHYUfRs';
    const SHEET_NAME = 'Sheet1';
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;
    const res  = await fetch(url);
    const text = await res.text();
    const json = JSON.parse(text.replace(/^[^(]+\(|\);?$/g,''));
    const cols = json.table.cols.map(c => c.label);

    // Column â†’ field name map (matches shared.js COL_MAP)
    const COL_MAP = {
      'Sponsor':'sponsor','Offering Name':'name','Asset Class':'assetClass',
      'Sector':'sector','Focus':'focus','Filed Raise':'filedRaise',
      'Current Raise':'currentRaise','Remaining Raise':'equityRemaining',
      'Offering Open':'offeringOpen','Offering Close':'offeringClose',
      'Year 1 Cash on Cash Distribution':'y1coc','Year 1 Cash on Cash':'y1coc',
      'Loan to Value':'ltv','(Avg)% Leased':'occupancy','% Leased':'occupancy',
      'Preferred':'preferred','Hold Period':'holdPeriod','Minimum - DST':'minInvest',
      '# Assets':'numAssets','Property Location(s)':'location',
      'Acquisition Cap Rate':'capRate','Rep Comp':'repComp',
      'Sponsor AUM':'sponsorAum','Sponsor Average IRR':'sponsorAvgIrr',
      'Sponsor Logo URL':'sponsorLogoUrl',
    };

    return json.table.rows
      .filter(row => row.c && row.c.some(cell => cell && cell.v != null))
      .map((row, i) => {
        const obj = { id: i+1 };
        cols.forEach((col, ci) => {
          const cell  = row.c[ci];
          const field = COL_MAP[col] || col;
          // Prefer formatted string (cell.f) for percent fields so we get "5.25%" not 0.0525
          let val = null;
          if (cell) {
            val = (cell.v !== undefined && cell.v !== null) ? cell.v : null;
            // If this is a pct field and cell.f exists (e.g. "5.25%"), parse the formatted value
            if (PCT_FIELDS.has(field) && cell.f && typeof cell.f === 'string' && cell.f.includes('%')) {
              const parsed = parseFloat(cell.f.replace('%','').trim());
              if (!isNaN(parsed)) val = parsed;
            }
          }
          obj[field] = val;
        });
        return obj;
      });
  }

  // â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.currentModule = { init };

  // Auto-init when standalone
  if (!window._aflShellActive) {
    function tryInit() {
      if (window.AFL) { init({}); }
      else { setTimeout(tryInit, 50); }
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', tryInit);
    } else {
      tryInit();
    }
  }

})();
</script>
</body>
</html>
