<style>
/* ═══════════════════════════════════════════
   CRM MODULE STYLES
═══════════════════════════════════════════ */
.crm-toolbar {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 20px; gap: 12px; flex-wrap: wrap;
}
.crm-toolbar-left { display: flex; align-items: center; gap: 12px; flex: 1; min-width: 240px; }
.crm-toolbar-right { display: flex; align-items: center; gap: 8px; }
.crm-search {
  flex: 1; max-width: 340px; height: 36px; padding: 0 12px 0 34px;
  border: 1.5px solid var(--mist); border-radius: 20px; font-size: 13px;
  color: var(--navy); background: var(--white); outline: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%235C7A99' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: 11px center;
  transition: border-color var(--transition);
}
.crm-search:focus { border-color: var(--navy2); }
.crm-search::placeholder { color: var(--fog); }
.crm-count { font-size: 12px; color: var(--slate2); white-space: nowrap; }

/* KPI Row */
.crm-kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(155px, 1fr)); gap: 12px; margin-bottom: 22px; }
.crm-kpi {
  background: var(--white); border: 1px solid var(--mist); border-radius: var(--radius);
  padding: 14px 16px; text-align: center;
}
.crm-kpi-val { font-size: 24px; font-weight: 800; color: var(--navy); letter-spacing: -0.03em; line-height: 1; }
.crm-kpi-label { font-size: 10.5px; color: var(--slate2); font-weight: 600; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.06em; }
.crm-kpi-sub { font-size: 11px; color: var(--fog); margin-top: 2px; }

/* Table */
.crm-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.crm-table thead th {
  text-align: left; padding: 10px 14px; font-size: 10.5px; font-weight: 700;
  color: var(--fog); text-transform: uppercase; letter-spacing: 0.07em;
  border-bottom: 1.5px solid var(--mist); white-space: nowrap;
  cursor: pointer; user-select: none; transition: color var(--transition);
}
.crm-table thead th:hover { color: var(--slate); }
.crm-table thead th.sorted { color: var(--navy); }
.crm-sort-arrow { font-size: 9px; margin-left: 3px; }
.crm-table tbody tr {
  border-bottom: 1px solid var(--surface2); cursor: pointer;
  transition: background var(--transition);
}
.crm-table tbody tr:hover { background: var(--surface); }
.crm-table tbody td { padding: 11px 14px; white-space: nowrap; color: var(--slate); }
.crm-table tbody td:first-child { color: var(--navy); font-weight: 600; }

/* Detail slide-out */
.crm-detail-overlay {
  position: fixed; inset: 0; background: rgba(11,31,59,0.5); backdrop-filter: blur(3px);
  z-index: 900; display: none; align-items: flex-start; justify-content: flex-end;
}
.crm-detail-overlay.active { display: flex; }
.crm-detail-panel {
  width: 500px; max-width: 92vw; height: 100vh; background: var(--white);
  border-left: 1.5px solid var(--mist); overflow-y: auto;
  animation: crmSlideIn 0.25s cubic-bezier(0.4,0,0.2,1);
  box-shadow: -8px 0 32px rgba(11,31,59,0.12);
}
@keyframes crmSlideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
.crm-detail-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 20px 24px; border-bottom: 1px solid var(--mist);
  position: sticky; top: 0; background: var(--white); z-index: 10;
}
.crm-detail-header h2 { font-size: 17px; font-weight: 700; color: var(--navy); }
.crm-detail-actions { display: flex; gap: 8px; }
.crm-detail-body { padding: 24px; }
.crm-detail-section { margin-bottom: 22px; }
.crm-detail-section-title {
  font-size: 10.5px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase;
  color: var(--fog); margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid var(--surface2);
}
.crm-detail-row {
  display: flex; justify-content: space-between; padding: 7px 0;
  border-bottom: 1px solid var(--surface2); font-size: 13px;
}
.crm-detail-row:last-child { border-bottom: none; }
.crm-detail-key { color: var(--slate2); font-weight: 500; }
.crm-detail-val { color: var(--navy); font-weight: 600; text-align: right; max-width: 55%; }

/* Form sections */
.crm-form-section {
  grid-column: 1 / -1; font-size: 11px; font-weight: 700; letter-spacing: 0.1em;
  text-transform: uppercase; color: var(--fog); margin-top: 8px; padding-top: 12px;
  padding-bottom: 6px; border-top: 1px solid var(--mist);
}
.crm-form-section:first-child { border-top: none; margin-top: 0; padding-top: 0; }

/* Chip toggles */
.crm-chips { display: flex; flex-wrap: wrap; gap: 6px; }
.crm-chip {
  padding: 5px 12px; font-size: 12px; font-weight: 500; border-radius: 20px;
  border: 1.5px solid var(--mist); background: var(--white); color: var(--slate);
  cursor: pointer; transition: all var(--transition); user-select: none;
}
.crm-chip:hover { border-color: var(--slate2); color: var(--navy); }
.crm-chip.active { border-color: var(--navy); background: var(--ice); color: var(--navy); font-weight: 600; }

/* Import */
.crm-dropzone {
  border: 2px dashed var(--mist); border-radius: var(--radius-lg); padding: 36px;
  text-align: center; cursor: pointer; transition: all var(--transition);
}
.crm-dropzone:hover, .crm-dropzone.dragover { border-color: var(--navy2); background: var(--blue-lt); }
.crm-dropzone-icon { font-size: 32px; margin-bottom: 8px; }
.crm-dropzone-text { font-size: 13px; color: var(--slate); }
.crm-dropzone-sub { font-size: 11.5px; color: var(--fog); margin-top: 4px; }
.crm-mapping-row { display: flex; align-items: center; gap: 12px; padding: 9px 0; border-bottom: 1px solid var(--surface2); }
.crm-mapping-label { flex: 0 0 160px; font-size: 12px; font-weight: 600; color: var(--slate); }
.crm-mapping-label .req { color: var(--red); }
.crm-mapping-select {
  flex: 1; height: 34px; padding: 0 10px; font-size: 12px; color: var(--navy);
  background: var(--white); border: 1.5px solid var(--mist); border-radius: var(--radius);
  outline: none; cursor: pointer;
}
.crm-preview-table { width: 100%; border-collapse: collapse; font-size: 11.5px; margin-top: 10px; }
.crm-preview-table th { text-align: left; padding: 5px 10px; font-weight: 700; color: var(--fog); border-bottom: 1px solid var(--mist); font-size: 10px; text-transform: uppercase; }
.crm-preview-table td { padding: 5px 10px; color: var(--slate); border-bottom: 1px solid var(--surface2); }
.crm-preview-table .row-err { background: var(--red-lt); }
.crm-import-stats { display: flex; gap: 16px; padding: 10px 0; font-size: 12px; font-weight: 600; }
</style>

<!-- CRM Content — rendered inside #main by shell module loader -->
<div id="crm-root">
  <div class="page-header">
    <div>
      <h1 class="page-title">Client Management</h1>
      <p class="page-subtitle">Manage client profiles, import from other CRMs, and track suitability</p>
    </div>
  </div>

  <div class="crm-kpis" id="crm-kpis"></div>

  <div class="crm-toolbar">
    <div class="crm-toolbar-left">
      <input type="text" class="crm-search" id="crm-search" placeholder="Search clients by name, email, entity...">
      <span class="crm-count" id="crm-count">0 clients</span>
    </div>
    <div class="crm-toolbar-right">
      <button class="btn btn-secondary btn-sm" id="crm-btn-import">&#8593; Import CSV</button>
      <button class="btn btn-secondary btn-sm" id="crm-btn-export">&#8595; Export CSV</button>
      <button class="btn btn-secondary btn-sm" id="crm-btn-template">Template</button>
      <button class="btn btn-primary btn-sm" id="crm-btn-add">+ Add Client</button>
    </div>
  </div>

  <div id="crm-table-container"></div>
</div>

<!-- Detail Slide-out (appended outside #main flow) -->
<div class="crm-detail-overlay" id="crm-detail-overlay">
  <div style="flex:1;" id="crm-detail-backdrop"></div>
  <div class="crm-detail-panel" id="crm-detail-panel"></div>
</div>

<script>
/* ═══════════════════════════════════════════════
   CRM MODULE
   Exports window.currentModule = { init(ctx) {} }
   Receives Firebase refs from shell via ctx
═══════════════════════════════════════════════ */
(function() {
  'use strict';

  let db = null, currentUser = null, AFL = null;
  let clients = [];
  let editingClientId = null;
  let sortCol = 'lastName', sortDir = 'asc', searchTerm = '';
  let csvHeaders = [], csvRawData = [], columnMapping = {};

  // ── Field Definitions ──
  const FIELDS = [
    { key:'firstName',        label:'First Name',            required:true },
    { key:'lastName',         label:'Last Name',             required:true },
    { key:'email',            label:'Email'                                },
    { key:'phone',            label:'Phone'                                },
    { key:'entity',           label:'Entity / Trust Name'                  },
    { key:'state',            label:'State'                                },
    { key:'netWorth',         label:'Net Worth',             type:'number' },
    { key:'liquidNetWorth',   label:'Liquid Net Worth',      type:'number' },
    { key:'annualIncome',     label:'Annual Income',         type:'number' },
    { key:'investableAssets', label:'Investable Assets',     type:'number' },
    { key:'accreditation',    label:'Accreditation Status'                 },
    { key:'taxStatus',        label:'Tax Filing Status'                    },
    { key:'taxBracket',       label:'Tax Bracket'                          },
    { key:'riskTolerance',    label:'Risk Tolerance'                       },
    { key:'investmentHorizon',label:'Investment Horizon'                   },
    { key:'minInvestment',    label:'Min Investment',        type:'number' },
    { key:'maxInvestment',    label:'Max Investment',        type:'number' },
    { key:'objectives',       label:'Investment Objectives'                },
    { key:'propTypes',        label:'Property Preferences'                 },
    { key:'is1031',           label:'1031 Exchange'                        },
    { key:'exchangeAmount',   label:'Exchange Amount',       type:'number' },
    { key:'idDeadline',       label:'45-Day ID Deadline'                   },
    { key:'closeDeadline',    label:'180-Day Close Deadline'               },
    { key:'notes',            label:'Notes'                                },
  ];

  const OBJECTIVES = ['Income','Growth','Capital Preservation','Tax Deferral','Diversification','Estate Planning'];
  const PROP_TYPES = ['Multifamily','Industrial','Retail','Office','Medical','Self-Storage','Hospitality','NNN'];

  // ── Helpers ──
  function esc(s) { return AFL ? AFL.escapeHTML(s) : String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function fmtMoney(v) {
    if (v == null || v === '') return '—';
    const n = Number(v); if (isNaN(n)) return '—';
    if (n >= 1e6) return '$'+(n/1e6).toFixed(1)+'M';
    if (n >= 1e3) return '$'+(n/1e3).toFixed(0)+'K';
    return '$'+n.toLocaleString();
  }
  function fmtDate(d) {
    if (!d) return '—';
    try { return new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}); } catch(e) { return d; }
  }
  function toast(msg, type) {
    if (AFL && AFL.toast) AFL.toast(msg, type||'');
    else if (window.showToast) window.showToast(msg, type||'');
  }

  // ── Firestore CRUD ──
  function clientsRef() { return db.collection('users').doc(currentUser.uid).collection('clients'); }

  async function loadClients() {
    try {
      const snap = await clientsRef().get();
      clients = [];
      snap.forEach(doc => clients.push({ id: doc.id, ...doc.data() }));
      renderAll();
    } catch(err) {
      console.error('[CRM] Load error:', err);
      toast('Failed to load clients', 'error');
    }
  }

  async function saveClient(data, docId) {
    try {
      const ts = firebase.firestore.FieldValue.serverTimestamp();
      if (docId) {
        await clientsRef().doc(docId).update({ ...data, updatedAt: ts });
      } else {
        await clientsRef().add({ ...data, createdAt: ts, updatedAt: ts });
      }
      await loadClients();
      return true;
    } catch(err) {
      console.error('[CRM] Save error:', err);
      toast('Failed to save client', 'error');
      return false;
    }
  }

  async function deleteClient(docId) {
    if (!confirm('Delete this client? This cannot be undone.')) return;
    try {
      await clientsRef().doc(docId).delete();
      closeDetail();
      await loadClients();
      toast('Client deleted', '');
    } catch(err) {
      console.error('[CRM] Delete error:', err);
      toast('Failed to delete client', 'error');
    }
  }

  // ── KPIs ──
  function renderKPIs() {
    const total = clients.length;
    const accredited = clients.filter(c => c.accreditation === 'Accredited' || c.accreditation === 'Qualified Purchaser').length;
    const totalNW = clients.reduce((s,c) => s + (Number(c.netWorth)||0), 0);
    const avgNW = total > 0 ? totalNW / total : 0;
    const has1031 = clients.filter(c => c.is1031 === 'Yes').length;

    document.getElementById('crm-kpis').innerHTML = `
      <div class="crm-kpi"><div class="crm-kpi-val">${total}</div><div class="crm-kpi-label">Total Clients</div></div>
      <div class="crm-kpi"><div class="crm-kpi-val">${accredited}</div><div class="crm-kpi-label">Accredited</div><div class="crm-kpi-sub">${total?Math.round(accredited/total*100):0}%</div></div>
      <div class="crm-kpi"><div class="crm-kpi-val">${fmtMoney(totalNW)}</div><div class="crm-kpi-label">Total AUM</div></div>
      <div class="crm-kpi"><div class="crm-kpi-val">${fmtMoney(avgNW)}</div><div class="crm-kpi-label">Avg Net Worth</div></div>
      <div class="crm-kpi"><div class="crm-kpi-val">${has1031}</div><div class="crm-kpi-label">1031 Eligible</div></div>
    `;
  }

  // ── Table ──
  function getFiltered() {
    let list = [...clients];
    if (searchTerm) {
      const q = searchTerm.toLowerCase();
      list = list.filter(c =>
        (c.firstName||'').toLowerCase().includes(q) ||
        (c.lastName||'').toLowerCase().includes(q) ||
        (c.email||'').toLowerCase().includes(q) ||
        (c.entity||'').toLowerCase().includes(q)
      );
    }
    list.sort((a,b) => {
      let va = a[sortCol] ?? '', vb = b[sortCol] ?? '';
      const fd = FIELDS.find(f=>f.key===sortCol);
      if (fd && fd.type==='number') { va=Number(va)||0; vb=Number(vb)||0; }
      else { va=String(va).toLowerCase(); vb=String(vb).toLowerCase(); }
      return va < vb ? (sortDir==='asc'?-1:1) : va > vb ? (sortDir==='asc'?1:-1) : 0;
    });
    return list;
  }

  function renderTable() {
    const filtered = getFiltered();
    document.getElementById('crm-count').textContent = `${filtered.length} client${filtered.length!==1?'s':''}`;

    if (!filtered.length) {
      document.getElementById('crm-table-container').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">${clients.length ? '&#128269;' : '&#128101;'}</div>
          <h3>${clients.length ? 'No matching clients' : 'No clients yet'}</h3>
          <p>${clients.length ? 'Try adjusting your search.' : 'Add your first client or import from CSV to get started.'}</p>
          ${!clients.length ? '<button class="btn btn-primary" onclick="window._crmAdd()">+ Add Client</button>' : ''}
        </div>`;
      return;
    }

    const cols = [
      {key:'lastName',label:'Name'}, {key:'email',label:'Email'}, {key:'state',label:'State'},
      {key:'accreditation',label:'Status'}, {key:'netWorth',label:'Net Worth'},
      {key:'riskTolerance',label:'Risk'}, {key:'is1031',label:'1031'}, {key:'investableAssets',label:'Investable'}
    ];

    let h = '<table class="crm-table"><thead><tr>';
    cols.forEach(c => {
      const s = sortCol===c.key;
      h += `<th class="${s?'sorted':''}" data-sort="${c.key}">${c.label}<span class="crm-sort-arrow">${s?(sortDir==='asc'?' &#9650;':' &#9660;'):''}</span></th>`;
    });
    h += '</tr></thead><tbody>';

    filtered.forEach(cl => {
      const name = esc(((cl.firstName||'')+' '+(cl.lastName||'')).trim()) || '—';
      const badge = cl.accreditation==='Accredited' ? '<span class="badge badge-green">Accredited</span>'
        : cl.accreditation==='Qualified Purchaser' ? '<span class="badge badge-blue">QP</span>'
        : cl.accreditation==='Non-Accredited' ? '<span class="badge badge-amber">Non-Accred</span>' : '—';
      const x1031 = cl.is1031==='Yes' ? '<span style="color:var(--green);font-weight:600;">Yes</span>' : (cl.is1031==='No'?'No':'—');

      h += `<tr data-id="${cl.id}">
        <td>${name}</td><td>${esc(cl.email)||'—'}</td><td>${esc(cl.state)||'—'}</td>
        <td>${badge}</td><td>${fmtMoney(cl.netWorth)}</td><td>${esc(cl.riskTolerance)||'—'}</td>
        <td>${x1031}</td><td>${fmtMoney(cl.investableAssets)}</td>
      </tr>`;
    });
    h += '</tbody></table>';
    document.getElementById('crm-table-container').innerHTML = h;

    // Wire row clicks + header sorts
    document.querySelectorAll('.crm-table tbody tr').forEach(tr =>
      tr.addEventListener('click', () => openDetail(tr.dataset.id))
    );
    document.querySelectorAll('.crm-table thead th[data-sort]').forEach(th =>
      th.addEventListener('click', () => {
        const col = th.dataset.sort;
        if (sortCol===col) sortDir = sortDir==='asc'?'desc':'asc';
        else { sortCol=col; sortDir='asc'; }
        renderTable();
      })
    );
  }

  function renderAll() { renderKPIs(); renderTable(); }

  // ── Add / Edit Client Modal ──
  function openClientModal(clientId) {
    editingClientId = clientId || null;
    const c = clientId ? clients.find(x=>x.id===clientId) : null;
    const title = c ? 'Edit Client' : 'Add Client';

    function fv(key) { return c && c[key] !== undefined ? c[key] : ''; }
    function selOpts(key, options) {
      const val = fv(key);
      return options.map(o => `<option value="${o}" ${val===o?'selected':''}>${o}</option>`).join('');
    }

    const activeObjs = c && c.objectives ? (Array.isArray(c.objectives) ? c.objectives : String(c.objectives).split(',').map(s=>s.trim())) : [];
    const activePTs  = c && c.propTypes  ? (Array.isArray(c.propTypes)  ? c.propTypes  : String(c.propTypes).split(',').map(s=>s.trim()))  : [];

    document.getElementById('modal-container').innerHTML = `
      <div class="modal-overlay" id="crm-modal-overlay" style="z-index:1100;">
        <div class="modal" style="max-width:660px;">
          <div class="modal-header">
            <div><div class="modal-title">${title}</div></div>
            <button class="modal-close" id="crm-modal-close">&#10005;</button>
          </div>
          <div class="modal-body">
            <div class="form-grid">
              <div class="crm-form-section">Personal Information</div>
              <div class="form-group"><label class="form-label">First Name *</label><input class="form-input" id="cf-firstName" value="${esc(fv('firstName'))}"></div>
              <div class="form-group"><label class="form-label">Last Name *</label><input class="form-input" id="cf-lastName" value="${esc(fv('lastName'))}"></div>
              <div class="form-group"><label class="form-label">Email</label><input class="form-input" type="email" id="cf-email" value="${esc(fv('email'))}"></div>
              <div class="form-group"><label class="form-label">Phone</label><input class="form-input" type="tel" id="cf-phone" value="${esc(fv('phone'))}"></div>
              <div class="form-group"><label class="form-label">Entity / Trust</label><input class="form-input" id="cf-entity" value="${esc(fv('entity'))}"></div>
              <div class="form-group"><label class="form-label">State</label><input class="form-input" id="cf-state" value="${esc(fv('state'))}"></div>

              <div class="crm-form-section">Financial Profile</div>
              <div class="form-group"><label class="form-label">Net Worth ($)</label><input class="form-input" type="number" id="cf-netWorth" value="${fv('netWorth')}"></div>
              <div class="form-group"><label class="form-label">Liquid Net Worth ($)</label><input class="form-input" type="number" id="cf-liquidNetWorth" value="${fv('liquidNetWorth')}"></div>
              <div class="form-group"><label class="form-label">Annual Income ($)</label><input class="form-input" type="number" id="cf-annualIncome" value="${fv('annualIncome')}"></div>
              <div class="form-group"><label class="form-label">Investable Assets ($)</label><input class="form-input" type="number" id="cf-investableAssets" value="${fv('investableAssets')}"></div>
              <div class="form-group"><label class="form-label">Accreditation</label><select class="form-select" id="cf-accreditation"><option value="">Select...</option>${selOpts('accreditation',['Accredited','Qualified Purchaser','Non-Accredited'])}</select></div>
              <div class="form-group"><label class="form-label">Tax Filing</label><select class="form-select" id="cf-taxStatus"><option value="">Select...</option>${selOpts('taxStatus',['Single','Married Filing Jointly','Married Filing Separately','Head of Household','Trust / Entity'])}</select></div>
              <div class="form-group"><label class="form-label">Tax Bracket</label><select class="form-select" id="cf-taxBracket"><option value="">Select...</option>${selOpts('taxBracket',['10%','12%','22%','24%','32%','35%','37%'])}</select></div>

              <div class="crm-form-section">Investment Profile</div>
              <div class="form-group"><label class="form-label">Risk Tolerance</label><select class="form-select" id="cf-riskTolerance"><option value="">Select...</option>${selOpts('riskTolerance',['Conservative','Moderate','Aggressive'])}</select></div>
              <div class="form-group"><label class="form-label">Investment Horizon</label><select class="form-select" id="cf-investmentHorizon"><option value="">Select...</option>${selOpts('investmentHorizon',['1-3 years','3-5 years','5-7 years','7-10 years','10+ years'])}</select></div>
              <div class="form-group"><label class="form-label">Min Investment ($)</label><input class="form-input" type="number" id="cf-minInvestment" value="${fv('minInvestment')}"></div>
              <div class="form-group"><label class="form-label">Max Investment ($)</label><input class="form-input" type="number" id="cf-maxInvestment" value="${fv('maxInvestment')}"></div>

              <div class="form-group form-grid-full"><label class="form-label">Investment Objectives</label>
                <div class="crm-chips" id="cf-objectives">${OBJECTIVES.map(o=>`<span class="crm-chip${activeObjs.includes(o)?' active':''}" data-val="${o}">${o}</span>`).join('')}</div>
              </div>
              <div class="form-group form-grid-full"><label class="form-label">Property Preferences</label>
                <div class="crm-chips" id="cf-propTypes">${PROP_TYPES.map(o=>`<span class="crm-chip${activePTs.includes(o)?' active':''}" data-val="${o}">${o}</span>`).join('')}</div>
              </div>

              <div class="crm-form-section">1031 Exchange</div>
              <div class="form-group"><label class="form-label">1031 Exchange?</label><select class="form-select" id="cf-is1031"><option value="">Select...</option>${selOpts('is1031',['Yes','No'])}</select></div>
              <div class="form-group"><label class="form-label">Exchange Amount ($)</label><input class="form-input" type="number" id="cf-exchangeAmount" value="${fv('exchangeAmount')}"></div>
              <div class="form-group"><label class="form-label">45-Day ID Deadline</label><input class="form-input" type="date" id="cf-idDeadline" value="${fv('idDeadline')}"></div>
              <div class="form-group"><label class="form-label">180-Day Close Deadline</label><input class="form-input" type="date" id="cf-closeDeadline" value="${fv('closeDeadline')}"></div>

              <div class="crm-form-section">Notes</div>
              <div class="form-group form-grid-full"><textarea class="form-input" id="cf-notes" rows="3" style="resize:vertical;height:auto;">${esc(fv('notes'))}</textarea></div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" id="crm-modal-cancel">Cancel</button>
            <button class="btn btn-primary" id="crm-modal-save">Save Client</button>
          </div>
        </div>
      </div>`;

    document.getElementById('crm-modal-close').onclick = closeModal;
    document.getElementById('crm-modal-cancel').onclick = closeModal;
    document.getElementById('crm-modal-overlay').onclick = e => { if (e.target.id==='crm-modal-overlay') closeModal(); };
    document.querySelectorAll('#cf-objectives .crm-chip').forEach(ch => ch.onclick = () => ch.classList.toggle('active'));
    document.querySelectorAll('#cf-propTypes .crm-chip').forEach(ch => ch.onclick = () => ch.classList.toggle('active'));
    document.getElementById('crm-modal-save').onclick = handleSave;
  }

  function closeModal() { document.getElementById('modal-container').innerHTML = ''; editingClientId = null; }

  async function handleSave() {
    const v = id => { const el = document.getElementById(id); return el ? el.value.trim() : ''; };
    const data = {};
    FIELDS.forEach(f => {
      if (f.key==='objectives'||f.key==='propTypes') return;
      const val = v('cf-'+f.key);
      if (val !== '') data[f.key] = f.type==='number' ? Number(val) : val;
    });
    const objs = []; document.querySelectorAll('#cf-objectives .crm-chip.active').forEach(c => objs.push(c.dataset.val));
    if (objs.length) data.objectives = objs;
    const pts = []; document.querySelectorAll('#cf-propTypes .crm-chip.active').forEach(c => pts.push(c.dataset.val));
    if (pts.length) data.propTypes = pts;

    if (!data.firstName || !data.lastName) { toast('First Name and Last Name are required','error'); return; }

    const btn = document.getElementById('crm-modal-save');
    btn.disabled = true; btn.textContent = 'Saving...';
    const ok = await saveClient(data, editingClientId);
    btn.disabled = false; btn.textContent = 'Save Client';
    if (ok) { closeModal(); toast(editingClientId ? 'Client updated' : 'Client added', 'success'); }
  }

  // ── Detail Panel ──
  function openDetail(clientId) {
    const c = clients.find(x => x.id === clientId);
    if (!c) return;
    const name = ((c.firstName||'')+' '+(c.lastName||'')).trim();
    const badge = c.accreditation==='Accredited' ? '<span class="badge badge-green">Accredited</span>'
      : c.accreditation==='Qualified Purchaser' ? '<span class="badge badge-blue">QP</span>'
      : c.accreditation==='Non-Accredited' ? '<span class="badge badge-amber">Non-Accred</span>' : '—';
    const objectives = Array.isArray(c.objectives) ? c.objectives.join(', ') : (c.objectives||'—');
    const propTypes  = Array.isArray(c.propTypes) ? c.propTypes.join(', ') : (c.propTypes||'—');

    document.getElementById('crm-detail-panel').innerHTML = `
      <div class="crm-detail-header">
        <h2>${esc(name)}</h2>
        <div class="crm-detail-actions">
          <button class="btn btn-secondary btn-sm" id="crm-d-edit">Edit</button>
          <button class="btn btn-sm" style="background:var(--red-lt);color:var(--red);border:1px solid rgba(153,27,27,.15);" id="crm-d-delete">Delete</button>
          <button class="modal-close" id="crm-d-close">&#10005;</button>
        </div>
      </div>
      <div class="crm-detail-body">
        <div class="crm-detail-section"><div class="crm-detail-section-title">Personal</div>
          <div class="crm-detail-row"><span class="crm-detail-key">Name</span><span class="crm-detail-val">${esc(name)}</span></div>
          <div class="crm-detail-row"><span class="crm-detail-key">Email</span><span class="crm-detail-val">${esc(c.email)||'—'}</span></div>
          <div class="crm-detail-row"><span class="crm-detail-key">Phone</span><span class="crm-detail-val">${esc(c.phone)||'—'}</span></div>
          <div class="crm-detail-row"><span class="crm-detail-key">Entity / Trust</span><span class="crm-detail-val">${esc(c.entity)||'—'}</span></div>
          <div class="crm-detail-row"><span class="crm-detail-key">State</span><span class="crm-detail-val">${esc(c.state)||'—'}</span></div>
        </div>
        <div class="crm-detail-section"><div class="crm-detail-section-title">Financial</div>
          <div class="crm-detail-row"><span class="crm-detail-key">Net Worth</span><span class="crm-detail-val">${fmtMoney(c.netWorth)}</span></div>
          <div class="crm-detail-row"><span class="crm-detail-key">Liquid NW</span><span class="crm-detail-val">${fmtMoney(c.liquidNetWorth)}</span></div>
          <div class="crm-detail-row"><span class="crm-detail-key">Annual Income</span><span class="crm-detail-val">${fmtMoney(c.annualIncome)}</span></div>
          <div class="crm-detail-row"><span class="crm-detail-key">Investable</span><span class="crm-detail-val">${fmtMoney(c.investableAssets)}</span></div>
          <div class="crm-detail-row"><span class="crm-detail-key">Accreditation</span><span class="crm-detail-val">${badge}</span></div>
          <div class="crm-detail-row"><span class="crm-detail-key">Tax Filing</span><span class="crm-detail-val">${esc(c.taxStatus)||'—'}</span></div>
          <div class="crm-detail-row"><span class="crm-detail-key">Tax Bracket</span><span class="crm-detail-val">${esc(c.taxBracket)||'—'}</span></div>
        </div>
        <div class="crm-detail-section"><div class="crm-detail-section-title">Investment</div>
          <div class="crm-detail-row"><span class="crm-detail-key">Risk</span><span class="crm-detail-val">${esc(c.riskTolerance)||'—'}</span></div>
          <div class="crm-detail-row"><span class="crm-detail-key">Horizon</span><span class="crm-detail-val">${esc(c.investmentHorizon)||'—'}</span></div>
          <div class="crm-detail-row"><span class="crm-detail-key">Min Invest</span><span class="crm-detail-val">${fmtMoney(c.minInvestment)}</span></div>
          <div class="crm-detail-row"><span class="crm-detail-key">Max Invest</span><span class="crm-detail-val">${fmtMoney(c.maxInvestment)}</span></div>
          <div class="crm-detail-row"><span class="crm-detail-key">Objectives</span><span class="crm-detail-val">${esc(objectives)}</span></div>
          <div class="crm-detail-row"><span class="crm-detail-key">Property Prefs</span><span class="crm-detail-val">${esc(propTypes)}</span></div>
        </div>
        <div class="crm-detail-section"><div class="crm-detail-section-title">1031 Exchange</div>
          <div class="crm-detail-row"><span class="crm-detail-key">1031?</span><span class="crm-detail-val">${c.is1031==='Yes'?'<span style="color:var(--green);font-weight:700">Yes</span>':(c.is1031||'—')}</span></div>
          <div class="crm-detail-row"><span class="crm-detail-key">Amount</span><span class="crm-detail-val">${fmtMoney(c.exchangeAmount)}</span></div>
          <div class="crm-detail-row"><span class="crm-detail-key">45-Day</span><span class="crm-detail-val">${fmtDate(c.idDeadline)}</span></div>
          <div class="crm-detail-row"><span class="crm-detail-key">180-Day</span><span class="crm-detail-val">${fmtDate(c.closeDeadline)}</span></div>
        </div>
        ${c.notes ? `<div class="crm-detail-section"><div class="crm-detail-section-title">Notes</div><p style="font-size:13px;color:var(--slate);white-space:pre-wrap;">${esc(c.notes)}</p></div>` : ''}
      </div>`;

    document.getElementById('crm-detail-overlay').classList.add('active');
    document.getElementById('crm-d-close').onclick = closeDetail;
    document.getElementById('crm-detail-backdrop').onclick = closeDetail;
    document.getElementById('crm-d-edit').onclick = () => { closeDetail(); openClientModal(c.id); };
    document.getElementById('crm-d-delete').onclick = () => deleteClient(c.id);
  }

  function closeDetail() { document.getElementById('crm-detail-overlay').classList.remove('active'); }

  // ── CSV Parser ──
  function parseCSV(text) {
    csvHeaders=[]; csvRawData=[];
    const fields=[]; let cur='', inQ=false;
    for (let i=0; i<text.length; i++) {
      const ch = text[i];
      if (ch==='"') { if (inQ && text[i+1]==='"') { cur+='"'; i++; } else inQ=!inQ; }
      else if ((ch===','||ch==='\t') && !inQ) { fields.push(cur); cur=''; }
      else if ((ch==='\n'||ch==='\r') && !inQ) {
        if (cur || fields.length) { fields.push(cur); cur=''; }
        if (fields.length) {
          if (!csvHeaders.length) csvHeaders = fields.splice(0);
          else csvRawData.push(fields.splice(0));
        }
        fields.length = 0;
        if (ch==='\r' && text[i+1]==='\n') i++;
      } else cur += ch;
    }
    if (cur || fields.length) { fields.push(cur);
      if (!csvHeaders.length) csvHeaders=fields.splice(0);
      else csvRawData.push(fields.splice(0));
    }
  }

  // ── Import Modal ──
  function openImportModal() {
    csvHeaders=[]; csvRawData=[]; columnMapping={};
    document.getElementById('modal-container').innerHTML = `
      <div class="modal-overlay" id="crm-imp-overlay" style="z-index:1100;">
        <div class="modal" style="max-width:760px;">
          <div class="modal-header"><div><div class="modal-title">Import Clients from CSV</div></div><button class="modal-close" id="crm-imp-close">&#10005;</button></div>
          <div class="modal-body">
            <div id="crm-imp-s1">
              <div class="crm-dropzone" id="crm-dz">
                <div class="crm-dropzone-icon">&#128196;</div>
                <div class="crm-dropzone-text">Drag & drop a CSV file, or click to browse</div>
                <div class="crm-dropzone-sub">Works with Redtail, Wealthbox, Salesforce, SmartOffice exports</div>
                <input type="file" id="crm-csv-fi" accept=".csv,.txt" style="display:none;">
              </div>
              <div style="text-align:center;margin-top:12px;"><button class="btn btn-secondary btn-sm" id="crm-imp-tmpl">Download AFL Template</button></div>
            </div>
            <div id="crm-imp-s2" style="display:none;"><p style="font-size:13px;color:var(--slate);margin-bottom:14px;">Map your CSV columns to AFL fields. Required: <span style="color:var(--red);">*</span></p><div id="crm-map-rows"></div></div>
            <div id="crm-imp-s3" style="display:none;"><div class="crm-import-stats" id="crm-imp-stats"></div><div style="max-height:300px;overflow-y:auto;"><table class="crm-preview-table" id="crm-imp-prev"></table></div></div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" id="crm-imp-cancel">Cancel</button>
            <button class="btn btn-primary" id="crm-imp-map-btn" style="display:none;">Next: Preview</button>
            <button class="btn btn-primary" id="crm-imp-go" style="display:none;background:var(--green);">Import Clients</button>
          </div>
        </div>
      </div>`;

    const dz = document.getElementById('crm-dz');
    const fi = document.getElementById('crm-csv-fi');
    dz.onclick = () => fi.click();
    dz.ondragover = e => { e.preventDefault(); dz.classList.add('dragover'); };
    dz.ondragleave = () => dz.classList.remove('dragover');
    dz.ondrop = e => { e.preventDefault(); dz.classList.remove('dragover'); if(e.dataTransfer.files.length) readFile(e.dataTransfer.files[0]); };
    fi.onchange = e => { if(e.target.files.length) readFile(e.target.files[0]); };
    document.getElementById('crm-imp-close').onclick = closeImport;
    document.getElementById('crm-imp-cancel').onclick = closeImport;
    document.getElementById('crm-imp-overlay').onclick = e => { if(e.target.id==='crm-imp-overlay') closeImport(); };
    document.getElementById('crm-imp-tmpl').onclick = downloadTemplate;
    document.getElementById('crm-imp-map-btn').onclick = importStep3;
    document.getElementById('crm-imp-go').onclick = confirmImport;
  }

  function closeImport() { document.getElementById('modal-container').innerHTML = ''; }

  function readFile(file) {
    const r = new FileReader();
    r.onload = e => { parseCSV(e.target.result); if(!csvHeaders.length){toast('Cannot parse CSV','error');return;} importStep2(); };
    r.readAsText(file);
  }

  function importStep2() {
    document.getElementById('crm-imp-s1').style.display='none';
    document.getElementById('crm-imp-s2').style.display='block';
    document.getElementById('crm-imp-map-btn').style.display='inline-flex';
    const cont = document.getElementById('crm-map-rows'); cont.innerHTML='';
    FIELDS.forEach(f => {
      const auto = csvHeaders.findIndex(h => {
        const a=h.toLowerCase().replace(/[^a-z0-9]/g,''), b=f.label.toLowerCase().replace(/[^a-z0-9]/g,''), k=f.key.toLowerCase();
        return a===b||a===k||a.includes(k)||k.includes(a);
      });
      let opts = '<option value="">— Skip —</option>';
      csvHeaders.forEach((h,i) => opts += `<option value="${i}" ${i===auto?'selected':''}>${esc(h)}</option>`);
      cont.innerHTML += `<div class="crm-mapping-row"><span class="crm-mapping-label">${f.label}${f.required?' <span class="req">*</span>':''}</span><select class="crm-mapping-select" data-field="${f.key}">${opts}</select></div>`;
    });
  }

  function importStep3() {
    columnMapping = {};
    document.querySelectorAll('.crm-mapping-select').forEach(s => { if(s.value!=='') columnMapping[s.dataset.field]=parseInt(s.value); });
    const miss = FIELDS.filter(f=>f.required && columnMapping[f.key]===undefined);
    if (miss.length) { toast('Map required: '+miss.map(f=>f.label).join(', '),'error'); return; }

    document.getElementById('crm-imp-s2').style.display='none';
    document.getElementById('crm-imp-s3').style.display='block';
    document.getElementById('crm-imp-map-btn').style.display='none';
    document.getElementById('crm-imp-go').style.display='inline-flex';

    let ok=0, warn=0, err=0; const rows=[];
    csvRawData.forEach((row,idx) => {
      const rec={}; let bad=false;
      FIELDS.forEach(f => {
        const ci=columnMapping[f.key]; if(ci===undefined||!row[ci]) return;
        let val=(row[ci]||'').trim();
        if(f.type==='number'&&val){val=val.replace(/[$,]/g,'');if(isNaN(Number(val))){bad=true;val='';}else val=Number(val);}
        if(val!=='') rec[f.key]=val;
      });
      if(!rec.firstName&&!rec.lastName){err++;bad=true;} else if(!rec.firstName||!rec.lastName) warn++; else ok++;
      rows.push({rec,bad,n:idx+1});
    });

    document.getElementById('crm-imp-stats').innerHTML = `<span style="color:var(--green)">&#10003; ${ok} valid</span><span style="color:var(--amber)">&#9888; ${warn} warnings</span><span style="color:var(--red)">&#10007; ${err} errors (skipped)</span>`;
    const lim=Math.min(rows.length,50);
    let t='<thead><tr><th>#</th><th>Name</th><th>Email</th><th>Net Worth</th><th>Status</th></tr></thead><tbody>';
    for(let i=0;i<lim;i++){const p=rows[i],r=p.rec,nm=((r.firstName||'')+' '+(r.lastName||'')).trim()||'<missing>';t+=`<tr class="${p.bad?'row-err':''}"><td>${p.n}</td><td>${esc(nm)}</td><td>${esc(r.email)||'—'}</td><td>${fmtMoney(r.netWorth)}</td><td>${p.bad?'<span style="color:var(--red)">Error</span>':'<span style="color:var(--green)">OK</span>'}</td></tr>`;}
    if(rows.length>lim) t+=`<tr><td colspan="5" style="text-align:center;color:var(--fog)">...and ${rows.length-lim} more</td></tr>`;
    t+='</tbody>';
    document.getElementById('crm-imp-prev').innerHTML=t;
    window._crmImportRecs = rows.filter(p=>!p.bad).map(p=>p.rec);
  }

  async function confirmImport() {
    const recs = window._crmImportRecs || [];
    if(!recs.length){toast('No valid records','error');return;}
    const btn=document.getElementById('crm-imp-go');
    btn.disabled=true; btn.textContent=`Importing ${recs.length}...`;
    try {
      const ref = clientsRef();
      for(let i=0; i<recs.length; i+=400){
        const chunk=recs.slice(i,i+400), batch=db.batch();
        chunk.forEach(rec => batch.set(ref.doc(),{...rec, createdAt:firebase.firestore.FieldValue.serverTimestamp(), updatedAt:firebase.firestore.FieldValue.serverTimestamp(), importedVia:'csv'}));
        await batch.commit();
      }
      await loadClients();
      closeImport();
      toast(`Imported ${recs.length} clients`,'success');
    } catch(e) {
      console.error('[CRM] Import error:',e);
      toast('Import failed: '+e.message,'error');
    }
    btn.disabled=false; btn.textContent='Import Clients';
  }

  // ── Export & Template ──
  function exportCSV() {
    if(!clients.length){toast('No clients to export','error');return;}
    const hdr=FIELDS.map(f=>f.label);
    const rows=clients.map(c=>FIELDS.map(f=>{let v=c[f.key];if(Array.isArray(v))v=v.join('; ');if(v==null)v='';v=String(v);if(v.includes(',')||v.includes('"')||v.includes('\n'))v='"'+v.replace(/"/g,'""')+'"';return v;}));
    dlFile([hdr.join(','),...rows.map(r=>r.join(','))].join('\n'), `AFL_Clients_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
  }

  function downloadTemplate() {
    const h=FIELDS.map(f=>f.label).join(',');
    const ex='John,Smith,john@example.com,(555) 123-4567,Smith Family Trust,CA,1500000,500000,250000,750000,Accredited,Married Filing Jointly,37%,Moderate,5-7 years,25000,250000,"Income, Growth","Multifamily, Industrial",Yes,500000,2026-04-15,2026-08-15,Great client';
    dlFile(h+'\n'+ex, 'AFL_Client_Import_Template.csv', 'text/csv');
  }

  function dlFile(content, name, type) {
    const b=new Blob([content],{type}), u=URL.createObjectURL(b), a=document.createElement('a');
    a.href=u; a.download=name; a.click(); URL.revokeObjectURL(u);
  }

  // ── Wire Events ──
  function wireEvents() {
    document.getElementById('crm-search').addEventListener('input', e => { searchTerm=e.target.value.trim(); renderTable(); });
    document.getElementById('crm-btn-add').addEventListener('click', () => openClientModal());
    document.getElementById('crm-btn-import').addEventListener('click', openImportModal);
    document.getElementById('crm-btn-export').addEventListener('click', exportCSV);
    document.getElementById('crm-btn-template').addEventListener('click', downloadTemplate);
    window._crmAdd = () => openClientModal();
  }

  // ══════════════════════════════════════════════
  //  MODULE EXPORT — called by shell's loadModule()
  // ══════════════════════════════════════════════
  window.currentModule = {
    async init(ctx) {
      AFL         = ctx.AFL  || window.AFL;
      db          = ctx.db   || (AFL && AFL.db)   || firebase.firestore();
      currentUser = ctx.user || (AFL && AFL.currentUser) || firebase.auth().currentUser;

      if (!currentUser) { toast('Not authenticated — please log in','error'); return; }
      if (!db)          { toast('Firebase not available','error'); return; }

      wireEvents();
      await loadClients();
      console.log('[CRM] Initialized —', clients.length, 'clients');
    }
  };

})();
</script>
