<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Browse Offerings â€” AFL</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700;9..40,800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script>
if (!window.AFL) {
  document.write('<script src="shared.js"><\/script>');
}
</script>
<style>
:root {
  --navy:    #0D1B2E;
  --navy2:   #162844;
  --navy3:   #1E3557;
  --slate:   #2D4159;
  --slate2:  #526880;
  --fog:     #8096AE;
  --mist:    #D0DCE8;
  --ice:     #EEF3F8;
  --white:   #FFFFFF;
  --surface: #F5F7FA;
  --surface2:#ECF0F5;
  --green:   #0D6B3B;
  --green-lt:#E6F4EE;
  --amber:   #92400E;
  --amber-lt:#FEF3C7;
  --red:     #881515;
  --red-lt:  #FEE2E2;
  --blue:    #1749B8;
  --blue-lt: #EBF2FF;
  --gold:    #B8892A;
  --gold-lt: #FDF6E8;
  --radius:  8px;
  --radius-lg: 14px;
  --shadow-sm: 0 1px 4px rgba(13,27,46,0.07), 0 1px 2px rgba(13,27,46,0.05);
  --shadow:    0 4px 16px rgba(13,27,46,0.10);
  --shadow-hover: 0 8px 28px rgba(13,27,46,0.15);
  --shadow-lg: 0 16px 40px rgba(13,27,46,0.14);
  --font: 'DM Sans', sans-serif;
  --transition: 0.18s cubic-bezier(0.4,0,0.2,1);
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: var(--font); background: var(--surface); color: var(--slate); }

/* â”€â”€ Browse root layout â€” no sidebar â”€â”€ */
#browse-root {
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow: hidden;
  font-family: var(--font);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACTION BAR (Row 1): Search + Sort + View
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.browse-action-bar {
  background: var(--white);
  border-bottom: 1px solid var(--mist);
  padding: 10px 20px;
  display: flex;
  align-items: center;
  gap: 8px;
  flex-shrink: 0;
}

.search-wrap {
  flex: 1;
  min-width: 180px;
  max-width: 340px;
  position: relative;
}
.search-wrap svg {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  width: 14px; height: 14px;
  color: var(--fog);
  pointer-events: none;
}
.search-input {
  width: 100%;
  padding: 8px 12px 8px 30px;
  font-family: var(--font);
  font-size: 13px;
  background: var(--surface);
  border: 1.5px solid var(--mist);
  border-radius: var(--radius);
  outline: none;
  color: var(--slate);
  transition: border-color var(--transition);
}
.search-input::placeholder { color: var(--fog); }
.search-input:focus { border-color: var(--navy2); background: var(--white); }

.sort-select {
  font-family: var(--font);
  font-size: 13px;
  font-weight: 500;
  color: var(--slate);
  background: var(--surface);
  border: 1.5px solid var(--mist);
  border-radius: var(--radius);
  padding: 7px 28px 7px 11px;
  outline: none;
  cursor: pointer;
  -webkit-appearance: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' fill='none'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%238FA3BA' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 9px center;
}

.result-count {
  font-size: 12px;
  color: var(--fog);
  font-weight: 500;
  white-space: nowrap;
}
.spacer { flex: 1; }
.view-toggle {
  display: flex;
  border: 1.5px solid var(--mist);
  border-radius: var(--radius);
  overflow: hidden;
  background: var(--surface);
}
.view-btn {
  padding: 6px 10px;
  border: none;
  background: transparent;
  cursor: pointer;
  color: var(--fog);
  display: flex;
  align-items: center;
  transition: all var(--transition);
}
.view-btn.active { background: var(--navy2); color: var(--white); }
.view-btn:hover:not(.active) { background: var(--ice); color: var(--slate); }
.view-btn svg { width: 15px; height: 15px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FILTER BAR (Row 2): Dropdown buttons
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.filter-bar {
  background: var(--surface);
  border-bottom: 1px solid var(--mist);
  padding: 8px 20px;
  display: flex;
  align-items: center;
  gap: 6px;
  flex-shrink: 0;
  flex-wrap: wrap;
}

/* â”€â”€ Dropdown wrapper â”€â”€ */
.filter-dropdown {
  position: relative;
}

/* The button that triggers the dropdown */
.filter-btn {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-family: var(--font);
  font-size: 12.5px;
  font-weight: 600;
  color: var(--slate);
  background: var(--white);
  border: 1.5px solid var(--mist);
  border-radius: 20px;
  padding: 5px 11px;
  cursor: pointer;
  transition: all var(--transition);
  white-space: nowrap;
  user-select: none;
}
.filter-btn:hover { border-color: var(--navy2); color: var(--navy); }
.filter-btn.has-selection {
  background: var(--navy2);
  border-color: var(--navy2);
  color: var(--white);
}
.filter-btn svg {
  width: 10px; height: 10px;
  transition: transform var(--transition);
  flex-shrink: 0;
}
.filter-btn.open svg { transform: rotate(180deg); }
.filter-count {
  background: rgba(255,255,255,0.25);
  color: inherit;
  font-size: 10px;
  font-weight: 700;
  padding: 1px 5px;
  border-radius: 10px;
  margin-left: 2px;
}
.filter-btn:not(.has-selection) .filter-count {
  background: var(--navy2);
  color: var(--white);
}

/* The dropdown panel */
.filter-panel {
  position: absolute;
  top: calc(100% + 6px);
  left: 0;
  min-width: 200px;
  background: var(--white);
  border: 1.5px solid var(--mist);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  z-index: 200;
  padding: 10px;
  display: none;
  animation: dropIn 0.14s cubic-bezier(0.4,0,0.2,1);
}
.filter-panel.open { display: block; }
@keyframes dropIn {
  from { opacity: 0; transform: translateY(-6px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Chip options inside panel */
.fp-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
}
.fp-chip {
  font-size: 12px;
  font-weight: 500;
  padding: 4px 10px;
  border-radius: 100px;
  border: 1.5px solid var(--mist);
  background: var(--white);
  color: var(--slate2);
  cursor: pointer;
  transition: all var(--transition);
  white-space: nowrap;
  user-select: none;
}
.fp-chip:hover { border-color: var(--navy2); color: var(--navy2); }
.fp-chip.active { background: var(--navy2); border-color: var(--navy2); color: var(--white); }

/* Range inputs inside panel */
.fp-range-wrap { padding: 4px 2px; }
.fp-range-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--fog);
  letter-spacing: 0.05em;
  text-transform: uppercase;
  margin-bottom: 10px;
  display: block;
}
.fp-range-row {
  display: flex;
  align-items: center;
  gap: 8px;
}
.fp-range-input {
  flex: 1;
  height: 4px;
  -webkit-appearance: none;
  background: var(--mist);
  border-radius: 2px;
  outline: none;
  cursor: pointer;
}
.fp-range-input::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px; height: 16px;
  border-radius: 50%;
  background: var(--navy2);
  cursor: pointer;
  box-shadow: var(--shadow-sm);
}
.fp-range-val {
  font-size: 12px;
  font-weight: 700;
  color: var(--navy);
  min-width: 40px;
  text-align: right;
  font-family: 'DM Mono', monospace;
}
.fp-range-limits {
  display: flex;
  justify-content: space-between;
  font-size: 10px;
  color: var(--fog);
  margin-top: 4px;
}

/* Panel header row with clear */
.fp-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--surface2);
}
.fp-title {
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.07em;
  text-transform: uppercase;
  color: var(--fog);
}
.fp-clear {
  font-size: 11px;
  font-weight: 600;
  color: var(--blue);
  background: none;
  border: none;
  cursor: pointer;
  padding: 2px 5px;
  border-radius: 4px;
}
.fp-clear:hover { background: var(--blue-lt); }

/* State grid inside dropdown */
.fp-state-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 4px;
}
.fp-state-btn {
  font-size: 10px;
  font-weight: 600;
  padding: 4px 2px;
  border-radius: 4px;
  border: 1.5px solid var(--mist);
  background: var(--white);
  color: var(--slate2);
  cursor: pointer;
  text-align: center;
  transition: all var(--transition);
  user-select: none;
}
.fp-state-btn:hover { border-color: var(--navy2); color: var(--navy2); }
.fp-state-btn.active { background: var(--navy2); border-color: var(--navy2); color: var(--white); }

/* Clear all button */
.filter-clear-all {
  font-size: 12px;
  font-weight: 600;
  color: var(--slate2);
  background: none;
  border: none;
  cursor: pointer;
  padding: 5px 8px;
  border-radius: 20px;
  transition: all var(--transition);
  white-space: nowrap;
}
.filter-clear-all:hover { color: var(--red); background: var(--red-lt); }
.filter-clear-all.hidden { display: none; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACTIVE FILTER PILLS (Row 3)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.active-filters {
  background: var(--surface2);
  border-bottom: 1px solid var(--mist);
  padding: 5px 20px;
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
  flex-shrink: 0;
}
.active-filters.hidden { display: none; }
.active-filter-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--fog);
  letter-spacing: 0.05em;
  text-transform: uppercase;
}
.active-filter-pill {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  font-weight: 500;
  color: var(--navy2);
  background: var(--ice);
  border: 1px solid var(--mist);
  border-radius: 100px;
  padding: 2px 8px 2px 10px;
}
.active-filter-pill button {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--fog);
  font-size: 14px;
  line-height: 1;
  padding: 0 0 0 2px;
  display: flex;
  align-items: center;
  transition: color var(--transition);
}
.active-filter-pill button:hover { color: var(--red); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONTENT AREA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.browse-content {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}
.browse-content::-webkit-scrollbar { width: 6px; }
.browse-content::-webkit-scrollbar-thumb { background: var(--mist); border-radius: 3px; }

/* â”€â”€ Card grid â”€â”€ */
.card-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px;
}

/* â”€â”€ Fund Card â”€â”€ */
.fund-card {
  background: var(--white);
  border-radius: var(--radius-lg);
  border: 1.5px solid var(--mist);
  overflow: hidden;
  cursor: pointer;
  transition: all var(--transition);
  display: flex;
  flex-direction: column;
  position: relative;
}
.fund-card:hover {
  box-shadow: var(--shadow-hover);
}
.fund-card.in-basket {
  border-color: var(--navy2);
  background: linear-gradient(180deg, var(--blue-lt) 0%, var(--white) 60px);
}
.card-top {
  padding: 14px 16px 10px;
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 10px;
}
.card-logo-wrap {
  width: 44px; height: 44px;
  border-radius: 10px;
  background: var(--ice);
  border: 1px solid var(--mist);
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; overflow: hidden;
}
.card-logo-wrap img { width:100%; height:100%; object-fit:contain; padding:4px; }
.card-logo-initials { font-size:13px; font-weight:800; color:var(--navy2); letter-spacing:-0.02em; }
.card-title-area { flex: 1; min-width: 0; }
.card-sponsor {
  font-size: 10px; font-weight: 600; color: var(--fog);
  text-transform: uppercase; letter-spacing: 0.08em;
  margin-bottom: 2px; white-space: nowrap;
  overflow: hidden; text-overflow: ellipsis;
}
.card-name {
  font-size: 14px; font-weight: 700; color: var(--navy);
  line-height: 1.25;
  display: -webkit-box; -webkit-line-clamp: 2;
  -webkit-box-orient: vertical; overflow: hidden;
}
.card-badges { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; flex-shrink: 0; }
.status-badge {
  font-size: 10px; font-weight: 700; padding: 3px 8px;
  border-radius: 100px; letter-spacing: 0.04em; white-space: nowrap;
}
.status-badge.open    { background: var(--green-lt); color: var(--green); }
.status-badge.closing { background: var(--amber-lt); color: var(--amber); }
.status-badge.closed  { background: var(--red-lt);   color: var(--red);   }
.basket-badge {
  font-size: 10px; font-weight: 700; padding: 2px 7px;
  border-radius: 100px; background: var(--blue-lt); color: var(--blue);
}
.card-meta-row { padding: 0 16px 10px; display: flex; gap: 5px; flex-wrap: wrap; }
.card-tag {
  font-size: 11px; font-weight: 500; padding: 2px 8px;
  border-radius: 4px; background: var(--surface);
  border: 1px solid var(--mist); color: var(--slate2);
}
.card-tag.asset { background: var(--ice); border-color: var(--navy3); color: var(--navy3); }
.card-kpi-row {
  padding: 12px 16px;
  background: var(--surface);
  border-top: 1px solid var(--mist);
  border-bottom: 1px solid var(--mist);
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 4px;
}
.kpi-cell { display: flex; flex-direction: column; align-items: center; padding: 4px 2px; }
.kpi-label {
  font-size: 9px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.09em;
  color: var(--fog);
  margin-bottom: 3px;
}
.kpi-val {
  font-size: 16px;
  font-weight: 500;
  color: var(--slate);
  font-family: 'DM Mono', monospace;
  line-height: 1.1;
}
.kpi-val.highlight { color: var(--green); font-weight: 600; }
.kpi-val.warn      { color: var(--amber); }
.kpi-val.muted     { color: var(--fog); font-size: 12px; font-weight: 400; }
/* Raise progress â€” thicker, more refined */
.card-raise-row { padding: 11px 16px 9px; display: flex; flex-direction: column; gap: 6px; }
.raise-label-row { display: flex; justify-content: space-between; align-items: baseline; }
.raise-label { font-size: 10px; font-weight: 600; color: var(--fog); text-transform: uppercase; letter-spacing: 0.07em; }
.raise-pct { font-size: 11px; font-weight: 700; color: var(--slate2); font-family: 'DM Mono', monospace; }
.raise-amounts {
  display: flex;
  justify-content: space-between;
  font-size: 10px;
  color: var(--fog);
  font-family: 'DM Mono', monospace;
  margin-top: -2px;
}
.raise-amounts .remaining-amt { color: var(--slate); font-weight: 600; }
.raise-bar-track {
  height: 8px;
  background: var(--ice);
  border-radius: 4px;
  overflow: hidden;
  box-shadow: inset 0 1px 2px rgba(13,27,46,0.08);
}
.raise-bar-fill {
  height: 100%;
  border-radius: 4px;
  background: linear-gradient(90deg, var(--navy2), #2A5298);
  transition: width 0.5s ease;
  position: relative;
}
.raise-bar-fill::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 40%;
  background: rgba(255,255,255,0.2);
  border-radius: 4px 4px 0 0;
}
.raise-bar-fill.nearly-full { background: linear-gradient(90deg, var(--amber), #D97706); }
.suit-chip { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 100px; }
.suit-chip.high { background: var(--green-lt); color: var(--green); }
.suit-chip.mid  { background: var(--amber-lt); color: var(--amber); }
.suit-chip.low  { background: var(--red-lt);   color: var(--red);   }
.suit-chip.none { background: var(--ice);       color: var(--fog);   }
.card-footer { padding: 10px 16px 12px; display: flex; align-items: center; justify-content: space-between; gap: 8px; }
.card-footer-left { display: flex; flex-direction: column; gap: 3px; }
.card-location { font-size: 11px; color: var(--fog); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px; }
.btn-add-basket {
  display: flex; align-items: center; gap: 5px;
  font-family: var(--font); font-size: 12px; font-weight: 600;
  padding: 7px 12px; border-radius: var(--radius);
  border: 1.5px solid var(--navy2);
  background: var(--white); color: var(--navy2);
  cursor: pointer; transition: all var(--transition);
  white-space: nowrap; flex-shrink: 0;
}
.btn-add-basket:hover { background: var(--navy2); color: var(--white); }
.btn-add-basket.in-basket { background: var(--navy2); color: var(--white); border-color: var(--navy2); }
.btn-add-basket:disabled { opacity: 0.4; cursor: not-allowed; }
.btn-add-basket svg { width: 13px; height: 13px; }

/* â”€â”€ List/table view â”€â”€ */
.fund-table { width: 100%; border-collapse: collapse; background: var(--white); border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-sm); font-size: 13px; }
.fund-table thead { background: var(--navy); color: var(--white); }
.fund-table th { padding: 10px 14px; text-align: left; font-size: 11px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; white-space: nowrap; cursor: pointer; user-select: none; transition: background var(--transition); }
.fund-table th:hover { background: var(--navy2); }
.fund-table tbody tr { border-bottom: 1px solid var(--mist); cursor: pointer; transition: background var(--transition); }
.fund-table tbody tr:last-child { border-bottom: none; }
.fund-table tbody tr:hover { background: var(--surface); }
.fund-table tbody tr.in-basket { background: var(--blue-lt); }
.fund-table td { padding: 11px 14px; vertical-align: middle; }
.td-name { font-weight: 600; color: var(--navy); }
.td-sponsor { color: var(--fog); font-size: 11px; }
.td-mono { font-family: 'DM Mono', monospace; font-size: 12px; font-weight: 500; }
.td-green { color: var(--green); font-weight: 600; }
.td-actions { display: flex; gap: 6px; align-items: center; justify-content: flex-end; }
.btn-sm { font-family: var(--font); font-size: 11px; font-weight: 600; padding: 5px 9px; border-radius: 6px; border: 1.5px solid var(--mist); background: var(--white); color: var(--slate); cursor: pointer; transition: all var(--transition); white-space: nowrap; }
.btn-sm:hover { border-color: var(--navy2); color: var(--navy2); }
.btn-sm.primary { background: var(--navy2); border-color: var(--navy2); color: var(--white); }

/* â”€â”€ Empty/loading states â”€â”€ */
.state-msg { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 80px 20px; text-align: center; color: var(--fog); }
.state-msg .icon { font-size: 40px; margin-bottom: 16px; opacity: 0.5; }
.state-msg h3 { font-size: 16px; font-weight: 700; color: var(--slate2); margin-bottom: 6px; }
.state-msg p { font-size: 14px; max-width: 320px; }
.skeleton-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
.skeleton-card { background: var(--white); border-radius: var(--radius-lg); border: 1.5px solid var(--mist); padding: 16px; height: 260px; overflow: hidden; position: relative; }
.skeleton-card::after { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.6) 50%, transparent 100%); animation: shimmer 1.4s infinite; }
@keyframes shimmer { from { transform: translateX(-100%); } to { transform: translateX(100%); } }
.skel { background: var(--ice); border-radius: 4px; margin-bottom: 8px; }
.skel-h  { height: 14px; }
.skel-sm { height: 10px; width: 60%; }
.skel-lg { height: 22px; width: 75%; }
</style>
</head>
<body>

<div id="browse-root">

  <!-- Row 1: Search + Sort + View Toggle -->
  <div class="browse-action-bar">
    <div class="search-wrap">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="7" cy="7" r="4.5"/><path d="M11 11l2.5 2.5"/>
      </svg>
      <input type="text" class="search-input" id="search-input" placeholder="Search offerings, sponsors, locationsâ€¦">
    </div>

    <select class="sort-select" id="sort-select">
      <option value="y1coc_desc">Y1 CoC â†“ High</option>
      <option value="y1coc_asc">Y1 CoC â†‘ Low</option>
      <option value="ltv_asc">LTV â†‘ Low</option>
      <option value="ltv_desc">LTV â†“ High</option>
      <option value="remaining_desc">% Remaining â†“</option>
      <option value="remaining_asc">% Remaining â†‘</option>
      <option value="name_asc">Name Aâ†’Z</option>
      <option value="newest">Newest First</option>
    </select>

    <span class="result-count" id="result-count"></span>
    <span class="spacer"></span>

    <div class="view-toggle">
      <button class="view-btn active" id="view-grid" title="Grid view">
        <svg viewBox="0 0 16 16" fill="currentColor">
          <rect x="1" y="1" width="6" height="6" rx="1.2"/>
          <rect x="9" y="1" width="6" height="6" rx="1.2"/>
          <rect x="1" y="9" width="6" height="6" rx="1.2"/>
          <rect x="9" y="9" width="6" height="6" rx="1.2"/>
        </svg>
      </button>
      <button class="view-btn" id="view-list" title="List view">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round">
          <path d="M4 4h9M4 8h9M4 12h9M1.5 4h.01M1.5 8h.01M1.5 12h.01"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Row 2: Filter Dropdown Buttons -->
  <div class="filter-bar" id="filter-bar">

    <!-- Status dropdown -->
    <div class="filter-dropdown" id="dd-status">
      <button class="filter-btn" id="btn-status" onclick="toggleDropdown('status')">
        Status
        <svg viewBox="0 0 10 6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 1l4 4 4-4"/></svg>
      </button>
      <div class="filter-panel" id="panel-status">
        <div class="fp-header">
          <span class="fp-title">Status</span>
          <button class="fp-clear" onclick="clearDropdown('status')">Clear</button>
        </div>
        <div class="fp-chips" id="chips-status">
          <div class="fp-chip" data-group="status" data-val="Open">Open</div>
          <div class="fp-chip" data-group="status" data-val="Closing Soon">Closing Soon</div>
          <div class="fp-chip" data-group="status" data-val="Closed">Closed</div>
        </div>
      </div>
    </div>

    <!-- Asset Class dropdown -->
    <div class="filter-dropdown" id="dd-asset">
      <button class="filter-btn" id="btn-asset" onclick="toggleDropdown('asset')">
        Asset Class
        <svg viewBox="0 0 10 6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 1l4 4 4-4"/></svg>
      </button>
      <div class="filter-panel" id="panel-asset">
        <div class="fp-header">
          <span class="fp-title">Asset Class</span>
          <button class="fp-clear" onclick="clearDropdown('asset')">Clear</button>
        </div>
        <div class="fp-chips" id="chips-asset">
          <!-- populated from data -->
        </div>
      </div>
    </div>

    <!-- Sector dropdown -->
    <div class="filter-dropdown" id="dd-sector">
      <button class="filter-btn" id="btn-sector" onclick="toggleDropdown('sector')">
        Sector
        <svg viewBox="0 0 10 6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 1l4 4 4-4"/></svg>
      </button>
      <div class="filter-panel" id="panel-sector">
        <div class="fp-header">
          <span class="fp-title">Sector</span>
          <button class="fp-clear" onclick="clearDropdown('sector')">Clear</button>
        </div>
        <div class="fp-chips" id="chips-sector">
          <!-- populated from data -->
        </div>
      </div>
    </div>

    <!-- Sponsor dropdown -->
    <div class="filter-dropdown" id="dd-sponsor">
      <button class="filter-btn" id="btn-sponsor" onclick="toggleDropdown('sponsor')">
        Sponsor
        <svg viewBox="0 0 10 6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 1l4 4 4-4"/></svg>
      </button>
      <div class="filter-panel" id="panel-sponsor" style="min-width:240px">
        <div class="fp-header">
          <span class="fp-title">Sponsor</span>
          <button class="fp-clear" onclick="clearDropdown('sponsor')">Clear</button>
        </div>
        <div class="fp-chips" id="chips-sponsor">
          <!-- populated from data -->
        </div>
      </div>
    </div>

    <!-- LTV dropdown -->
    <div class="filter-dropdown" id="dd-ltv">
      <button class="filter-btn" id="btn-ltv" onclick="toggleDropdown('ltv')">
        Max LTV
        <svg viewBox="0 0 10 6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 1l4 4 4-4"/></svg>
      </button>
      <div class="filter-panel" id="panel-ltv" style="min-width:220px">
        <div class="fp-header">
          <span class="fp-title">Max LTV</span>
          <button class="fp-clear" onclick="clearDropdown('ltv')">Reset</button>
        </div>
        <div class="fp-range-wrap">
          <div class="fp-range-row">
            <input type="range" class="fp-range-input" id="ltv-range" min="0" max="80" step="5" value="80">
            <span class="fp-range-val" id="ltv-range-val">Any</span>
          </div>
          <div class="fp-range-limits"><span>0%</span><span>80%</span></div>
        </div>
      </div>
    </div>

    <!-- Min CoC dropdown -->
    <div class="filter-dropdown" id="dd-coc">
      <button class="filter-btn" id="btn-coc" onclick="toggleDropdown('coc')">
        Min CoC
        <svg viewBox="0 0 10 6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 1l4 4 4-4"/></svg>
      </button>
      <div class="filter-panel" id="panel-coc" style="min-width:220px">
        <div class="fp-header">
          <span class="fp-title">Min Y1 CoC</span>
          <button class="fp-clear" onclick="clearDropdown('coc')">Reset</button>
        </div>
        <div class="fp-range-wrap">
          <div class="fp-range-row">
            <input type="range" class="fp-range-input" id="coc-range" min="0" max="9" step="0.25" value="0">
            <span class="fp-range-val" id="coc-range-val">Any</span>
          </div>
          <div class="fp-range-limits"><span>0%</span><span>9%</span></div>
        </div>
      </div>
    </div>

    <!-- State dropdown -->
    <div class="filter-dropdown" id="dd-state">
      <button class="filter-btn" id="btn-state" onclick="toggleDropdown('state')">
        State
        <svg viewBox="0 0 10 6" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M1 1l4 4 4-4"/></svg>
      </button>
      <div class="filter-panel" id="panel-state" style="min-width:260px">
        <div class="fp-header">
          <span class="fp-title">State</span>
          <button class="fp-clear" onclick="clearDropdown('state')">Clear</button>
        </div>
        <div class="fp-state-grid" id="chips-state">
          <!-- populated from data -->
        </div>
      </div>
    </div>

    <button class="filter-clear-all hidden" id="clear-all-btn" onclick="clearAllFilters()">âœ• Clear all</button>
  </div>

  <!-- Row 3: Active filter pills -->
  <div class="active-filters hidden" id="active-filters-bar">
    <span class="active-filter-label">Active:</span>
  </div>

  <!-- Content area -->
  <div class="browse-content" id="browse-content"></div>

</div><!-- /browse-root -->

<script>
(function () {
  'use strict';

  let allFunds = [];
  let filtered = [];
  let viewMode = 'grid';
  let client   = null;

  const filters = {
    status:    new Set(),
    assetClass:new Set(),
    sector:    new Set(),
    sponsor:   new Set(),
    states:    new Set(),
    maxLtv:    80,
    minCoc:    0,
    search:    ''
  };
  let sortKey = 'y1coc_desc';

  // Open dropdown id
  let openDd = null;

  // â”€â”€ Helpers â”€â”€
  function $(id) { return document.getElementById(id); }
  function fmt(n, d=2, s='%') { if (n==null||isNaN(n)) return 'â€”'; return n.toFixed(d)+s; }
  function fmtMoney(n) {
    if (n==null||isNaN(n)) return 'â€”';
    if (n>=1e9) return '$'+(n/1e9).toFixed(1)+'B';
    if (n>=1e6) return '$'+(n/1e6).toFixed(1)+'M';
    if (n>=1e3) return '$'+Math.round(n/1000)+'K';
    return '$'+n;
  }
  function initials(s) { if(!s) return '??'; return s.split(/\s+/).slice(0,2).map(w=>w[0]).join('').toUpperCase(); }
  function esc(s) { if(!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
  function statusOf(f) {
    if (f.status) return f.status;
    if (!f.offeringClose) return 'Open';
    const d = new Date(f.offeringClose), now = new Date();
    if (isNaN(d)) return 'Open';
    const days = (d - now)/(1000*86400);
    if (days < 0) return 'Closed';
    if (days < 30) return 'Closing Soon';
    return 'Open';
  }
  function pctRemaining(f) {
    const total = f.filedRaise;
    const rem   = f.equityRemaining;
    if (!total || rem == null) return null;
    return (rem / total) * 100;
  }
  function inBasket(id) {
    if (window.AFL && window.AFL.basket) return window.AFL.basket.has(id);
    try { return JSON.parse(localStorage.getItem('afl_basket')||'[]').includes(id); } catch(e){ return false; }
  }
  function basketFull() {
    if (window.AFL && window.AFL.basket) return window.AFL.basket.get().length >= 3;
    try { return JSON.parse(localStorage.getItem('afl_basket')||'[]').length >= 3; } catch(e){ return false; }
  }
  function ltvClass(ltv) {
    if (ltv==null||isNaN(ltv)) return 'muted';
    if (ltv <= 55) return 'highlight';
    if (ltv > 65)  return 'warn';
    return '';
  }
  function suitChip(fund) {
    if (!window.AFL || !window.AFL.suitScore) return '';
    if (!client || !client.exchangeAmount) return '';
    const score = window.AFL.suitScore(fund, client);
    if (score == null) return '';
    let cls, label;
    if (score >= 70)      { cls='high'; label='â˜… '+score+'% match'; }
    else if (score >= 45) { cls='mid';  label='â—† '+score+'% match'; }
    else                  { cls='low';  label='â–¼ '+score+'% match'; }
    return `<span class="suit-chip ${cls}">${label}</span>`;
  }
  function statusBadge(s) {
    const cls = s==='Open'?'open':s==='Closing Soon'?'closing':'closed';
    return `<span class="status-badge ${cls}">${esc(s)}</span>`;
  }

  // â”€â”€ Dropdown logic â”€â”€
  window.toggleDropdown = function(id) {
    if (openDd && openDd !== id) closeDropdown(openDd);
    const panel = $('panel-'+id);
    const btn   = $('btn-'+id);
    if (!panel) return;
    const isOpen = panel.classList.contains('open');
    if (isOpen) { closeDropdown(id); }
    else {
      panel.classList.add('open');
      btn.classList.add('open');
      openDd = id;
    }
  };
  function closeDropdown(id) {
    const panel = $('panel-'+id);
    const btn   = $('btn-'+id);
    if (panel) panel.classList.remove('open');
    if (btn)   btn.classList.remove('open');
    if (openDd === id) openDd = null;
  }
  // Close on outside click
  document.addEventListener('click', e => {
    if (!openDd) return;
    const dd = document.getElementById('dd-'+openDd);
    if (dd && !dd.contains(e.target)) closeDropdown(openDd);
  });

  window.clearDropdown = function(id) {
    if (id === 'ltv') { filters.maxLtv = 80; $('ltv-range').value = 80; $('ltv-range-val').textContent = 'Any'; }
    else if (id === 'coc') { filters.minCoc = 0; $('coc-range').value = 0; $('coc-range-val').textContent = 'Any'; }
    else {
      const groupMap = {status:'status', asset:'assetClass', sector:'sector', sponsor:'sponsor', state:'states'};
      const g = groupMap[id];
      if (g) {
        filters[g].clear();
        document.querySelectorAll(`#chips-${id} .fp-chip.active, #chips-${id} .fp-state-btn.active`)
          .forEach(c => c.classList.remove('active'));
      }
    }
    updateFilterBtnState(id);
    fullRender();
  };

  window.clearAllFilters = function() {
    filters.status.clear(); filters.assetClass.clear(); filters.sector.clear();
    filters.sponsor.clear(); filters.states.clear();
    filters.maxLtv = 80; filters.minCoc = 0; filters.search = '';
    $('ltv-range').value = 80; $('ltv-range-val').textContent = 'Any';
    $('coc-range').value = 0; $('coc-range-val').textContent = 'Any';
    $('search-input').value = '';
    document.querySelectorAll('.fp-chip.active, .fp-state-btn.active')
      .forEach(c => c.classList.remove('active'));
    ['status','asset','sector','sponsor','ltv','coc','state'].forEach(updateFilterBtnState);
    fullRender();
  };

  function updateFilterBtnState(id) {
    const btn = $('btn-'+id);
    if (!btn) return;
    let hasSelection = false;
    if (id === 'ltv') hasSelection = filters.maxLtv < 80;
    else if (id === 'coc') hasSelection = filters.minCoc > 0;
    else {
      const groupMap = {status:'status', asset:'assetClass', sector:'sector', sponsor:'sponsor', state:'states'};
      const g = groupMap[id];
      if (g) hasSelection = filters[g].size > 0;
    }
    btn.classList.toggle('has-selection', hasSelection);
    // Update count badge
    let existing = btn.querySelector('.filter-count');
    if (hasSelection) {
      let count = 0;
      if (id === 'ltv' || id === 'coc') count = 1;
      else {
        const groupMap = {status:'status', asset:'assetClass', sector:'sector', sponsor:'sponsor', state:'states'};
        const g = groupMap[id];
        if (g) count = filters[g].size;
      }
      if (!existing) {
        existing = document.createElement('span');
        existing.className = 'filter-count';
        btn.insertBefore(existing, btn.querySelector('svg'));
      }
      existing.textContent = count;
    } else if (existing) {
      existing.remove();
    }
  }

  // â”€â”€ Populate dynamic filter options â”€â”€
  function populateFilterOptions(funds) {
    const assetClasses = [...new Set(funds.map(f=>f.assetClass).filter(Boolean))].sort();
    const sectors      = [...new Set(funds.map(f=>f.sector).filter(Boolean))].sort();
    const sponsors     = [...new Set(funds.map(f=>f.sponsor).filter(Boolean))].sort();
    const allStates    = [...new Set(funds.flatMap(f=>extractStates(f.location)))].sort();

    function makeChips(containerId, items, group) {
      const el = $(containerId);
      if (!el) return;
      el.innerHTML = items.map(v =>
        `<div class="fp-chip" data-group="${group}" data-val="${esc(v)}">${esc(v)}</div>`
      ).join('');
      el.querySelectorAll('.fp-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          const val = chip.dataset.val;
          const filterKey = {status:'status', assetClass:'assetClass', sector:'sector', sponsor:'sponsor'}[group] || group;
          chip.classList.toggle('active');
          if (chip.classList.contains('active')) filters[filterKey].add(val);
          else filters[filterKey].delete(val);
          const ddMap = {status:'status', assetClass:'asset', sector:'sector', sponsor:'sponsor'};
          updateFilterBtnState(ddMap[group] || group);
          fullRender();
        });
      });
    }

    makeChips('chips-asset', assetClasses, 'assetClass');
    makeChips('chips-sector', sectors, 'sector');
    makeChips('chips-sponsor', sponsors, 'sponsor');

    // State grid (special styling)
    const stateEl = $('chips-state');
    if (stateEl) {
      stateEl.innerHTML = allStates.map(s =>
        `<button class="fp-state-btn" data-val="${s}">${s}</button>`
      ).join('');
      stateEl.querySelectorAll('.fp-state-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          btn.classList.toggle('active');
          if (btn.classList.contains('active')) filters.states.add(btn.dataset.val);
          else filters.states.delete(btn.dataset.val);
          updateFilterBtnState('state');
          fullRender();
        });
      });
    }

    // Status chips (static but need handlers)
    document.querySelectorAll('#chips-status .fp-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const val = chip.dataset.val;
        chip.classList.toggle('active');
        if (chip.classList.contains('active')) filters.status.add(val);
        else filters.status.delete(val);
        updateFilterBtnState('status');
        fullRender();
      });
    });
  }

  function extractStates(str) {
    if (window.AFL && window.AFL.extractStates) return window.AFL.extractStates(str);
    if (!str) return [];
    return str.match(/\b([A-Z]{2})\b/g) || [];
  }

  // â”€â”€ Count & show active filter pills â”€â”€
  function renderActivePills() {
    const bar = $('active-filters-bar');
    const clearAll = $('clear-all-btn');
    const pills = [];
    filters.status.forEach(v    => pills.push({label:`Status: ${v}`,    group:'status',    val:v}));
    filters.assetClass.forEach(v=> pills.push({label:`Class: ${v}`,     group:'assetClass',val:v}));
    filters.sector.forEach(v    => pills.push({label:`Sector: ${v}`,    group:'sector',    val:v}));
    filters.sponsor.forEach(v   => pills.push({label:`Sponsor: ${v}`,   group:'sponsor',   val:v}));
    filters.states.forEach(v    => pills.push({label:`State: ${v}`,     group:'states',    val:v}));
    if (filters.maxLtv < 80) pills.push({label:`LTV â‰¤ ${filters.maxLtv}%`, group:'ltv',  val:null});
    if (filters.minCoc > 0)  pills.push({label:`CoC â‰¥ ${filters.minCoc}%`, group:'coc',  val:null});

    if (!pills.length) {
      bar.classList.add('hidden');
      clearAll.classList.add('hidden');
      return;
    }
    bar.classList.remove('hidden');
    clearAll.classList.remove('hidden');
    bar.innerHTML = '<span class="active-filter-label">Active:</span>'
      + pills.map(p=>`
        <span class="active-filter-pill">${esc(p.label)}
          <button data-group="${esc(p.group)}" data-val="${esc(p.val||'')}">âœ•</button>
        </span>`).join('');
    bar.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        removeSingleFilter(btn.dataset.group, btn.dataset.val);
        fullRender();
      });
    });
  }

  function removeSingleFilter(group, val) {
    if (group === 'ltv') { filters.maxLtv = 80; $('ltv-range').value = 80; $('ltv-range-val').textContent = 'Any'; updateFilterBtnState('ltv'); }
    else if (group === 'coc') { filters.minCoc = 0; $('coc-range').value = 0; $('coc-range-val').textContent = 'Any'; updateFilterBtnState('coc'); }
    else {
      if (filters[group]) filters[group].delete(val);
      const ddMap = {status:'status', assetClass:'asset', sector:'sector', sponsor:'sponsor', states:'state'};
      const chipGroup = group === 'states' ? 'state' : ddMap[group] || group;
      document.querySelectorAll(`#chips-${chipGroup} [data-val="${val}"]`)
        .forEach(c => c.classList.remove('active'));
      updateFilterBtnState(ddMap[group] || group);
    }
  }

  // â”€â”€ Sort & Filter â”€â”€
  function sortFunds(arr) {
    const s = [...arr];
    switch(sortKey) {
      case 'y1coc_desc':    s.sort((a,b)=>(b.y1coc||0)-(a.y1coc||0)); break;
      case 'y1coc_asc':     s.sort((a,b)=>(a.y1coc||0)-(b.y1coc||0)); break;
      case 'ltv_asc':       s.sort((a,b)=>(a.ltv||99)-(b.ltv||99)); break;
      case 'ltv_desc':      s.sort((a,b)=>(b.ltv||0)-(a.ltv||0)); break;
      case 'remaining_desc':s.sort((a,b)=>(pctRemaining(b)||0)-(pctRemaining(a)||0)); break;
      case 'remaining_asc': s.sort((a,b)=>(pctRemaining(a)||0)-(pctRemaining(b)||0)); break;
      case 'name_asc':      s.sort((a,b)=>(a.name||'').localeCompare(b.name||'')); break;
      case 'newest':        s.sort((a,b)=>{ const da=a.offeringOpen?new Date(a.offeringOpen):new Date(0); const db=b.offeringOpen?new Date(b.offeringOpen):new Date(0); return db-da; }); break;
    }
    return s;
  }

  function applyFilters() {
    const q = filters.search.toLowerCase().trim();
    filtered = allFunds.filter(f => {
      if (q) {
        const hay = [f.name,f.sponsor,f.location,f.sector,f.assetClass].join(' ').toLowerCase();
        if (!hay.includes(q)) return false;
      }
      if (filters.status.size && !filters.status.has(statusOf(f))) return false;
      if (filters.assetClass.size && !filters.assetClass.has(f.assetClass)) return false;
      if (filters.sector.size && !filters.sector.has(f.sector)) return false;
      if (filters.sponsor.size && !filters.sponsor.has(f.sponsor)) return false;
      if (filters.states.size) {
        const fs = extractStates(f.location);
        if (!fs.some(s => filters.states.has(s))) return false;
      }
      if (filters.maxLtv < 80 && f.ltv != null && !isNaN(f.ltv) && f.ltv > filters.maxLtv) return false;
      if (filters.minCoc > 0  && f.y1coc != null && !isNaN(f.y1coc) && f.y1coc < filters.minCoc) return false;
      return true;
    });
    filtered = sortFunds(filtered);
  }

  // â”€â”€ Build Card â”€â”€
  function buildCard(fund) {
    const status = statusOf(fund);
    const pctRem = pctRemaining(fund);
    const isIn   = inBasket(fund.id);
    const full   = !isIn && basketFull();
    const chip   = suitChip(fund);

    const logoHtml = fund.sponsorLogoUrl
      ? `<img src="${esc(fund.sponsorLogoUrl)}" alt="${esc(fund.sponsor)}" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><span class="card-logo-initials" style="display:none">${esc(initials(fund.sponsor))}</span>`
      : `<span class="card-logo-initials">${esc(initials(fund.sponsor))}</span>`;

    let raiseHtml = '';
    if (pctRem != null) {
      const barW = Math.min(100, Math.max(0, 100 - pctRem)).toFixed(1);
      const nf = pctRem < 20 ? ' nearly-full' : '';
      const filed   = fund.filedRaise ? fmtMoney(fund.filedRaise) : null;
      const current = fund.currentRaise ? fmtMoney(fund.currentRaise) : null;
      const remAmt  = fund.equityRemaining ? fmtMoney(fund.equityRemaining) : null;
      raiseHtml = `<div class="card-raise-row">
        <div class="raise-label-row">
          <span class="raise-label">Raise Status</span>
          <span class="raise-pct">${pctRem.toFixed(0)}% remaining</span>
        </div>
        <div class="raise-bar-track"><div class="raise-bar-fill${nf}" style="width:${barW}%"></div></div>
        <div class="raise-amounts">
          <span>Filed: ${filed||'â€”'}</span>
          ${current ? `<span>Raised: ${current}</span>` : ''}
          ${remAmt  ? `<span class="remaining-amt">Avail: ${remAmt}</span>` : ''}
        </div>
      </div>`;
    }

    return `
    <div class="fund-card${isIn?' in-basket':''}" data-id="${fund.id}">
      <div class="card-top">
        <div class="card-logo-wrap">${logoHtml}</div>
        <div class="card-title-area">
          <div class="card-sponsor">${esc(fund.sponsor||'â€”')}</div>
          <div class="card-name">${esc(fund.name||'Unnamed Offering')}</div>
        </div>
        <div class="card-badges">
          ${statusBadge(status)}
          ${isIn ? '<span class="basket-badge">In Basket</span>' : ''}
        </div>
      </div>
      <div class="card-meta-row">
        ${fund.assetClass ? `<span class="card-tag asset">${esc(fund.assetClass)}</span>` : ''}
        ${fund.sector     ? `<span class="card-tag">${esc(fund.sector)}</span>` : ''}
        ${fund.focus      ? `<span class="card-tag">${esc(fund.focus)}</span>` : ''}
      </div>
      <div class="card-kpi-row">
        <div class="kpi-cell">
          <span class="kpi-label">Year 1 Cash on Cash</span>
          <span class="kpi-val ${(fund.y1coc||0)>=4?'highlight':''}">${fmt(fund.y1coc)}</span>
        </div>
        <div class="kpi-cell">
          <span class="kpi-label">LTV</span>
          <span class="kpi-val ${ltvClass(fund.ltv)}">${fmt(fund.ltv)}</span>
        </div>
        <div class="kpi-cell">
          <span class="kpi-label">Occupancy</span>
          <span class="kpi-val ${(fund.occupancy||0)>=90?'highlight':''}">${fmt(fund.occupancy)}</span>
        </div>
      </div>
      ${raiseHtml}
      <div class="card-footer">
        <div class="card-footer-left">
          ${chip || `<span class="card-location">ğŸ“ ${esc(fund.location||'â€”')}</span>`}
          ${chip ? `<span class="card-location">ğŸ“ ${esc(fund.location||'â€”')}</span>` : ''}
        </div>
        <button class="btn-add-basket${isIn?' in-basket':''}" data-id="${fund.id}"${full?' disabled':''}
          title="${full?'Basket full (max 3)':isIn?'Remove from basket':'Add to basket'}">
          <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
            ${isIn ? '<path d="M3 8l3.5 3.5L13 4.5"/>' : '<path d="M8 3v10M3 8h10"/>'}
          </svg>
          ${isIn ? 'In Basket âœ“' : '+ Basket'}
        </button>
      </div>
    </div>`;
  }

  // â”€â”€ Build Table Row â”€â”€
  function buildRow(fund) {
    const status = statusOf(fund);
    const isIn   = inBasket(fund.id);
    const full   = !isIn && basketFull();
    const chip   = suitChip(fund);
    return `
    <tr data-id="${fund.id}" class="${isIn?'in-basket':''}">
      <td><div class="td-name">${esc(fund.name||'Unnamed')}</div><div class="td-sponsor">${esc(fund.sponsor||'â€”')}</div></td>
      <td><span class="card-tag asset" style="white-space:nowrap">${esc(fund.assetClass||'â€”')}</span></td>
      <td><span class="card-tag" style="white-space:nowrap">${esc(fund.sector||'â€”')}</span></td>
      <td>${statusBadge(status)}</td>
      <td class="td-mono td-green">${fmt(fund.y1coc)}</td>
      <td class="td-mono ${ltvClass(fund.ltv)==='highlight'?'td-green':''}">${fmt(fund.ltv)}</td>
      <td class="td-mono">${fmt(fund.occupancy)}</td>
      <td class="td-mono">${fmtMoney(fund.minInvest)}</td>
      <td>${fund.holdPeriod!=null?fund.holdPeriod+'yr':''}</td>
      <td>${chip||'â€”'}</td>
      <td><div class="td-actions">
        <button class="btn-sm" data-id="${fund.id}">View</button>
        <button class="btn-sm primary btn-add-basket${isIn?' in-basket':''}" data-id="${fund.id}"${full?' disabled':''}>
          ${isIn ? 'âœ“ In Basket' : '+ Basket'}
        </button>
      </div></td>
    </tr>`;
  }

  // â”€â”€ Render content â”€â”€
  function renderContent() {
    const content = $('browse-content');
    $('result-count').textContent = `${filtered.length} offering${filtered.length!==1?'s':''}`;
    renderActivePills();

    if (!filtered.length) {
      content.innerHTML = `<div class="state-msg"><div class="icon">ğŸ”</div><h3>No offerings found</h3><p>Try adjusting your filters or search term.</p></div>`;
      return;
    }

    if (viewMode === 'grid') {
      content.innerHTML = `<div class="card-grid">${filtered.map(buildCard).join('')}</div>`;
    } else {
      content.innerHTML = `
        <table class="fund-table">
          <thead><tr>
            <th data-sort="name_asc">Offering</th><th>Class</th><th>Sector</th><th>Status</th>
            <th data-sort="y1coc_desc">Y1 CoC</th><th data-sort="ltv_asc">LTV</th>
            <th>Occupancy</th><th>Min Invest</th><th>Hold</th><th>Suitability</th><th></th>
          </tr></thead>
          <tbody>${filtered.map(buildRow).join('')}</tbody>
        </table>`;
      content.querySelectorAll('th[data-sort]').forEach(th => {
        th.addEventListener('click', () => { sortKey = th.dataset.sort; $('sort-select').value = sortKey; applyFilters(); renderContent(); });
      });
    }

    // Click: card/row â†’ navigate
    content.querySelectorAll('.fund-card, tr[data-id]').forEach(el => {
      el.addEventListener('click', e => {
        if (e.target.closest('.btn-add-basket')) return;
        const id = parseInt(el.dataset.id);
        if (window.AFL && window.AFL.navigate) window.AFL.navigate('offering', { id: id, ids: [id] });
      });
    });
    // Click: basket buttons
    content.querySelectorAll('.btn-add-basket').forEach(btn => {
      btn.addEventListener('click', e => { e.stopPropagation(); handleBasketClick(parseInt(btn.dataset.id)); });
    });
    // Click: list View buttons
    content.querySelectorAll('tr .btn-sm:not(.btn-add-basket)').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        const id = parseInt(btn.closest('tr').dataset.id);
        if (window.AFL && window.AFL.navigate) window.AFL.navigate('offering', { id: id, ids: [id] });
      });
    });
  }

  function fullRender() { applyFilters(); renderContent(); }

  // â”€â”€ Basket click â”€â”€
  function handleBasketClick(id) {
    if (window.AFL && window.AFL.basket) {
      if (window.AFL.basket.has(id)) window.AFL.basket.remove(id);
      else {
        if (window.AFL.basket.get().length >= 3) { alert('Basket is full â€” max 3 offerings. Remove one first.'); return; }
        window.AFL.basket.add(id);
      }
      if (window.AFL.updateHeader) window.AFL.updateHeader();
    } else {
      try {
        let basket = JSON.parse(localStorage.getItem('afl_basket')||'[]');
        if (basket.includes(id)) basket = basket.filter(x=>x!==id);
        else { if (basket.length>=3) { alert('Basket full.'); return; } basket.push(id); }
        localStorage.setItem('afl_basket', JSON.stringify(basket));
      } catch(e){}
    }
    fullRender();
  }

  // â”€â”€ Range inputs â”€â”€
  $('ltv-range').addEventListener('input', function() {
    const v = parseInt(this.value);
    filters.maxLtv = v;
    $('ltv-range-val').textContent = v >= 80 ? 'Any' : v+'%';
    updateFilterBtnState('ltv');
    fullRender();
  });
  $('coc-range').addEventListener('input', function() {
    const v = parseFloat(this.value);
    filters.minCoc = v;
    $('coc-range-val').textContent = v <= 0 ? 'Any' : v.toFixed(2)+'%';
    updateFilterBtnState('coc');
    fullRender();
  });

  // â”€â”€ Search â”€â”€
  let searchTimer;
  $('search-input').addEventListener('input', function() {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => { filters.search = this.value; fullRender(); }, 200);
  });

  // â”€â”€ Sort â”€â”€
  $('sort-select').addEventListener('change', function() { sortKey = this.value; fullRender(); });

  // â”€â”€ View toggle â”€â”€
  $('view-grid').addEventListener('click', () => {
    viewMode = 'grid';
    $('view-grid').classList.add('active'); $('view-list').classList.remove('active');
    fullRender();
  });
  $('view-list').addEventListener('click', () => {
    viewMode = 'list';
    $('view-list').classList.add('active'); $('view-grid').classList.remove('active');
    fullRender();
  });

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  MODULE INIT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  window.currentModule = {
    async init(shellParams) {
      // Support both wrapped and unwrapped params
      const navParams = (shellParams && shellParams.params) ? shellParams.params : (shellParams || {});
      client = (shellParams && shellParams.client) ? shellParams.client : 
               (window.AFL && window.AFL.state ? window.AFL.state.client : null);

      // Wait for AFL data to be ready
      const waitForData = () => new Promise((resolve) => {
        const getFunds = () => window.AFL && window.AFL.state && window.AFL.state.funds && window.AFL.state.funds.length > 0
          ? window.AFL.state.funds : null;
        if (getFunds()) { resolve(getFunds()); return; }
        let attempts = 0;
        const check = setInterval(() => {
          attempts++;
          const f = getFunds();
          if (f) { clearInterval(check); resolve(f); }
          else if (attempts > 80) { clearInterval(check); resolve([]); }
        }, 100);
      });

      // Show skeleton while loading
      $('browse-content').innerHTML = `
        <div class="skeleton-grid">
          ${Array(6).fill(`<div class="skeleton-card">
            <div class="skel skel-lg"></div>
            <div class="skel skel-sm"></div>
            <div class="skel skel-h" style="width:80%"></div>
            <div class="skel skel-h" style="width:50%"></div>
          </div>`).join('')}
        </div>`;

      allFunds = await waitForData();

      // Apply initial sort/filter from navParams
      if (navParams.sort) { sortKey = navParams.sort; $('sort-select').value = sortKey; }

      // Populate dynamic filter options
      populateFilterOptions(allFunds);

      // Restore filter state from AFL state if available
      if (window.AFL && window.AFL.state && window.AFL.state.ui && window.AFL.state.ui.browse) {
        const bs = window.AFL.state.ui.browse;
        if (bs.search) { filters.search = bs.search; $('search-input').value = bs.search; }
      }

      fullRender();
    }
  };

})();
</script>
</body>
</html>
