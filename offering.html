<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Offering Detail â€” AFL</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700;9..40,800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root {
  --navy:    #0B1F3B;
  --navy2:   #1C3A63;
  --navy3:   #2A4D7A;
  --slate:   #3A5270;
  --slate2:  #5C7A99;
  --fog:     #8FA3BA;
  --mist:    #C8D8E8;
  --ice:     #E8F0F8;
  --white:   #FFFFFF;
  --surface: #F4F7FB;
  --surface2:#EEF3FA;
  --green:   #1A7A4A;
  --green-lt:#E8F7EF;
  --amber:   #B45309;
  --amber-lt:#FEF3C7;
  --red:     #991B1B;
  --red-lt:  #FEE2E2;
  --blue:    #1D4ED8;
  --blue-lt: #EFF6FF;
  --radius:  8px;
  --radius-lg: 14px;
  --shadow-sm: 0 1px 3px rgba(11,31,59,0.08);
  --shadow:    0 4px 12px rgba(11,31,59,0.10);
  --shadow-lg: 0 12px 32px rgba(11,31,59,0.14);
  --font: 'DM Sans', sans-serif;
  --mono: 'DM Mono', monospace;
  --transition: 0.18s cubic-bezier(0.4,0,0.2,1);
  /* Portfolio offering colors */
  --c0: #1D4ED8;
  --c1: #7C3AED;
  --c2: #B45309;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: var(--font); background: var(--surface); color: var(--slate); }

/* â”€â”€ Root layout â”€â”€ */
#offering-root {
  height: 100%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  font-family: var(--font);
}

/* â”€â”€ Mode bar â”€â”€ */
.mode-bar {
  background: var(--white);
  border-bottom: 1px solid var(--mist);
  padding: 0 24px;
  display: flex;
  align-items: center;
  gap: 0;
  flex-shrink: 0;
  height: 44px;
}
.mode-tab {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 13px;
  font-weight: 600;
  color: var(--fog);
  padding: 0 16px;
  height: 100%;
  border-bottom: 2px solid transparent;
  cursor: pointer;
  transition: all var(--transition);
  white-space: nowrap;
  border-top: none; border-left: none; border-right: none;
  background: none;
  font-family: var(--font);
}
.mode-tab:hover { color: var(--slate); }
.mode-tab.active { color: var(--navy2); border-bottom-color: var(--navy2); }
.mode-tab svg { width: 14px; height: 14px; }
.mode-bar-spacer { flex: 1; }
.breadcrumb {
  font-size: 12px;
  color: var(--fog);
  display: flex;
  align-items: center;
  gap: 6px;
}
.breadcrumb a {
  color: var(--blue);
  cursor: pointer;
  text-decoration: none;
  font-weight: 500;
}
.breadcrumb a:hover { text-decoration: underline; }

/* â”€â”€ Scrollable body â”€â”€ */
.offering-body {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
}
.offering-body::-webkit-scrollbar { width: 6px; }
.offering-body::-webkit-scrollbar-thumb { background: var(--mist); border-radius: 3px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HERO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hero {
  background: linear-gradient(135deg, var(--navy) 0%, var(--navy2) 60%, var(--navy3) 100%);
  padding: 28px 32px 24px;
  color: var(--white);
  position: relative;
  overflow: hidden;
}
.hero::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse at 80% 50%, rgba(42,77,122,0.5) 0%, transparent 60%);
  pointer-events: none;
}
.hero-inner { position: relative; z-index: 1; }

.hero-top {
  display: flex;
  align-items: flex-start;
  gap: 20px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}
.hero-logos {
  display: flex;
  gap: -6px;
  flex-shrink: 0;
}
.hero-logo {
  width: 52px;
  height: 52px;
  border-radius: 12px;
  background: rgba(255,255,255,0.12);
  border: 2px solid rgba(255,255,255,0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: 800;
  color: var(--white);
  overflow: hidden;
  flex-shrink: 0;
}
.hero-logo img { width: 100%; height: 100%; object-fit: contain; padding: 6px; }
.hero-logo + .hero-logo { margin-left: -8px; }

.hero-title-area { flex: 1; min-width: 0; }
.hero-sponsor {
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: rgba(255,255,255,0.55);
  margin-bottom: 4px;
}
.hero-name {
  font-size: 22px;
  font-weight: 800;
  color: var(--white);
  line-height: 1.2;
  margin-bottom: 8px;
}
.hero-badges {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.hero-badge {
  font-size: 11px;
  font-weight: 600;
  padding: 3px 10px;
  border-radius: 100px;
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.18);
  color: rgba(255,255,255,0.85);
}
.hero-badge.status-open     { background: rgba(26,122,74,0.3);  border-color: rgba(26,122,74,0.5);  color: #6ee7b7; }
.hero-badge.status-closing  { background: rgba(180,83,9,0.3);   border-color: rgba(180,83,9,0.5);   color: #fcd34d; }
.hero-badge.status-closed   { background: rgba(153,27,27,0.3);  border-color: rgba(153,27,27,0.5);  color: #fca5a5; }

/* KPI strip */
.hero-kpis {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  gap: 1px;
  background: rgba(255,255,255,0.08);
  border-radius: var(--radius);
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.08);
  margin-top: 20px;
}
.hero-kpi {
  padding: 12px 16px;
  background: rgba(255,255,255,0.04);
  display: flex;
  flex-direction: column;
  gap: 3px;
}
.hero-kpi-label {
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: rgba(255,255,255,0.4);
}
.hero-kpi-val {
  font-size: 20px;
  font-weight: 800;
  color: var(--white);
  font-family: var(--mono);
  line-height: 1;
}
.hero-kpi-val.green { color: #6ee7b7; }
.hero-kpi-val.amber { color: #fcd34d; }
.hero-kpi-val.muted { color: rgba(255,255,255,0.4); font-size: 14px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DD ICON ROW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dd-row {
  background: var(--white);
  border-bottom: 1px solid var(--mist);
  padding: 12px 32px;
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  align-items: center;
  flex-shrink: 0;
}
.dd-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  font-family: var(--font);
  font-size: 12px;
  font-weight: 600;
  color: var(--slate2);
  background: var(--surface);
  border: 1.5px solid var(--mist);
  border-radius: var(--radius);
  padding: 6px 12px;
  cursor: pointer;
  transition: all var(--transition);
  text-decoration: none;
  white-space: nowrap;
}
.dd-btn:hover { background: var(--ice); border-color: var(--navy2); color: var(--navy2); }
.dd-btn.disabled { opacity: 0.35; cursor: not-allowed; pointer-events: none; }
.dd-btn svg { width: 13px; height: 13px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACTION BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.action-bar {
  background: var(--navy);
  padding: 12px 32px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}
.action-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  font-family: var(--font);
  font-size: 13px;
  font-weight: 600;
  padding: 8px 16px;
  border-radius: var(--radius);
  border: 1.5px solid rgba(255,255,255,0.2);
  background: rgba(255,255,255,0.08);
  color: rgba(255,255,255,0.85);
  cursor: pointer;
  transition: all var(--transition);
  white-space: nowrap;
}
.action-btn:hover { background: rgba(255,255,255,0.16); color: var(--white); }
.action-btn.primary {
  background: #2A6FDB;
  border-color: #2A6FDB;
  color: var(--white);
}
.action-btn.primary:hover { background: #1D5BBF; }
.action-btn.in-basket {
  background: rgba(26,122,74,0.3);
  border-color: rgba(26,122,74,0.5);
  color: #6ee7b7;
}
.action-btn svg { width: 14px; height: 14px; }
.action-bar-spacer { flex: 1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANALYST ZONE  (main content)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.analyst-zone {
  padding: 24px 32px 40px;
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: 20px;
  max-width: 1400px;
}
@media (max-width: 1000px) {
  .analyst-zone { grid-template-columns: 1fr; }
}

/* â”€â”€ Cards / panels â”€â”€ */
.panel {
  background: var(--white);
  border-radius: var(--radius-lg);
  border: 1.5px solid var(--mist);
  overflow: hidden;
}
.panel-header {
  padding: 14px 20px 12px;
  border-bottom: 1px solid var(--mist);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.panel-title {
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0.07em;
  text-transform: uppercase;
  color: var(--fog);
}
.panel-body { padding: 20px; }
.panel-body.tight { padding: 12px 20px; }

/* â”€â”€ KPI grid inside panels â”€â”€ */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 12px;
}
.kpi-item {
  display: flex;
  flex-direction: column;
  gap: 3px;
  padding: 12px;
  background: var(--surface);
  border-radius: var(--radius);
  border: 1px solid var(--mist);
}
.kpi-item-label {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.07em;
  color: var(--fog);
}
.kpi-item-val {
  font-size: 18px;
  font-weight: 700;
  color: var(--navy);
  font-family: var(--mono);
  line-height: 1.1;
}
.kpi-item-val.green { color: var(--green); }
.kpi-item-val.amber { color: var(--amber); }
.kpi-item-val.red   { color: var(--red);   }
.kpi-item-sub {
  font-size: 11px;
  color: var(--fog);
  font-weight: 500;
}

/* â”€â”€ Data rows â”€â”€ */
.data-rows { display: flex; flex-direction: column; }
.data-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  padding: 9px 0;
  border-bottom: 1px solid var(--surface2);
  gap: 12px;
}
.data-row:last-child { border-bottom: none; }
.data-row-label {
  font-size: 12px;
  font-weight: 500;
  color: var(--fog);
  flex-shrink: 0;
}
.data-row-val {
  font-size: 13px;
  font-weight: 600;
  color: var(--slate);
  text-align: right;
  font-family: var(--mono);
}
.data-row-val.green { color: var(--green); }
.data-row-val.amber { color: var(--amber); }

/* â”€â”€ Distribution chart â”€â”€ */
.chart-wrap {
  position: relative;
  height: 160px;
  margin: 4px 0;
}

/* â”€â”€ Projection table â”€â”€ */
.proj-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}
.proj-table th {
  padding: 6px 10px;
  text-align: center;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--fog);
  background: var(--surface);
  border-bottom: 1px solid var(--mist);
}
.proj-table td {
  padding: 7px 10px;
  text-align: center;
  border-bottom: 1px solid var(--surface2);
  font-family: var(--mono);
  font-weight: 500;
  color: var(--slate);
}
.proj-table tr:last-child td { border-bottom: none; }
.proj-table td.highlight { color: var(--green); font-weight: 700; }

/* â”€â”€ Raise progress â”€â”€ */
.raise-progress-wrap { padding: 16px 20px; }
.raise-stats {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 10px;
  margin-bottom: 14px;
}
.raise-stat { display: flex; flex-direction: column; gap: 2px; }
.raise-stat-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--fog); }
.raise-stat-val { font-size: 15px; font-weight: 700; color: var(--navy); font-family: var(--mono); }
.raise-bar-track { height: 8px; background: var(--ice); border-radius: 4px; overflow: hidden; }
.raise-bar-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, var(--navy2), #2A6FDB); transition: width 0.6s ease; }
.raise-bar-fill.amber { background: linear-gradient(90deg, var(--amber), #d97706); }

/* â”€â”€ Suitability panel â”€â”€ */
.suit-panel-score {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px 20px;
  border-bottom: 1px solid var(--mist);
}
.suit-score-circle {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  font-weight: 800;
  font-family: var(--mono);
  flex-shrink: 0;
  border: 3px solid;
}
.suit-score-circle.high { border-color: var(--green); color: var(--green); background: var(--green-lt); }
.suit-score-circle.mid  { border-color: var(--amber); color: var(--amber); background: var(--amber-lt); }
.suit-score-circle.low  { border-color: var(--red);   color: var(--red);   background: var(--red-lt);   }
.suit-score-circle.none { border-color: var(--mist);  color: var(--fog);   background: var(--surface);  }
.suit-score-text { flex: 1; }
.suit-score-title { font-size: 14px; font-weight: 700; color: var(--navy); margin-bottom: 2px; }
.suit-score-sub { font-size: 12px; color: var(--fog); }

.suit-factors { padding: 12px 20px; display: flex; flex-direction: column; gap: 8px; }
.suit-factor {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: var(--slate2);
}
.suit-factor-dot {
  width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
}
.suit-factor-dot.pass { background: var(--green); }
.suit-factor-dot.fail { background: var(--red); }
.suit-factor-dot.neutral { background: var(--fog); }

/* â”€â”€ Sponsor section â”€â”€ */
.sponsor-header {
  display: flex;
  align-items: center;
  gap: 14px;
  padding: 16px 20px;
  border-bottom: 1px solid var(--mist);
  cursor: pointer;
  transition: background var(--transition);
}
.sponsor-header:hover { background: var(--surface); }
.sponsor-logo-sm {
  width: 40px; height: 40px;
  border-radius: 10px;
  background: var(--ice);
  border: 1px solid var(--mist);
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 800; color: var(--navy2);
  overflow: hidden; flex-shrink: 0;
}
.sponsor-logo-sm img { width: 100%; height: 100%; object-fit: contain; padding: 4px; }
.sponsor-info { flex: 1; }
.sponsor-name-sm { font-size: 14px; font-weight: 700; color: var(--navy); }
.sponsor-exp { font-size: 11px; color: var(--fog); font-weight: 500; }
.sponsor-arrow { color: var(--fog); font-size: 16px; }

.sponsor-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1px;
  background: var(--mist);
  border-top: 1px solid var(--mist);
}
.sponsor-stat {
  padding: 12px 16px;
  background: var(--white);
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.sponsor-stat-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; color: var(--fog); }
.sponsor-stat-val { font-size: 16px; font-weight: 700; color: var(--navy); font-family: var(--mono); }

/* â”€â”€ Tag chips â”€â”€ */
.tag { font-size: 11px; font-weight: 500; padding: 3px 9px; border-radius: 4px; background: var(--surface); border: 1px solid var(--mist); color: var(--slate2); display: inline-block; margin: 2px; }
.tag.blue { background: var(--blue-lt); border-color: rgba(29,78,216,0.2); color: var(--blue); }

/* â”€â”€ AI narrative â”€â”€ */
.ai-narrative {
  font-size: 13px;
  line-height: 1.65;
  color: var(--slate);
  padding: 16px 20px;
}
.ai-narrative p { margin-bottom: 10px; }
.ai-narrative p:last-child { margin-bottom: 0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PORTFOLIO COMPARISON VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.portfolio-view { padding: 24px 32px 40px; }
.portfolio-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 12px;
}
.portfolio-title { font-size: 18px; font-weight: 800; color: var(--navy); }
.portfolio-subtitle { font-size: 13px; color: var(--fog); margin-top: 2px; }

/* Blended KPI strip */
.blended-strip {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 12px;
  margin-bottom: 24px;
}
.blended-kpi {
  background: var(--white);
  border: 1.5px solid var(--mist);
  border-radius: var(--radius-lg);
  padding: 14px 16px;
  display: flex;
  flex-direction: column;
  gap: 3px;
}
.blended-kpi-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--fog); }
.blended-kpi-val { font-size: 22px; font-weight: 800; color: var(--navy); font-family: var(--mono); }
.blended-kpi-val.green { color: var(--green); }
.blended-kpi-sub { font-size: 11px; color: var(--fog); }

/* Comparison table */
.comp-table {
  width: 100%;
  border-collapse: collapse;
  background: var(--white);
  border-radius: var(--radius-lg);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
  margin-bottom: 24px;
}
.comp-table th {
  padding: 12px 16px;
  text-align: left;
  font-size: 11px;
  font-weight: 700;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--fog);
  background: var(--surface);
  border-bottom: 1px solid var(--mist);
}
.comp-table th.offering-col {
  color: var(--white);
  font-size: 12px;
  font-weight: 700;
  letter-spacing: 0;
  text-transform: none;
}
.comp-table td {
  padding: 10px 16px;
  border-bottom: 1px solid var(--surface2);
  font-size: 13px;
  vertical-align: middle;
}
.comp-table tr:last-child td { border-bottom: none; }
.comp-table .row-label { font-weight: 600; color: var(--slate2); font-size: 12px; }
.comp-table .mono-val { font-family: var(--mono); font-weight: 600; color: var(--slate); }
.comp-table .best-val { color: var(--green); font-weight: 700; }

/* Color band for offering columns */
.col-c0 { background: rgba(29,78,216,0.07); }
.col-c1 { background: rgba(124,58,237,0.07); }
.col-c2 { background: rgba(180,83,9,0.07); }
.th-c0  { background: rgba(29,78,216,0.85) !important; }
.th-c1  { background: rgba(124,58,237,0.85) !important; }
.th-c2  { background: rgba(180,83,9,0.85) !important; }

/* Allocation sliders */
.alloc-section { margin-bottom: 24px; }
.alloc-title { font-size: 14px; font-weight: 700; color: var(--navy); margin-bottom: 12px; }
.alloc-rows { display: flex; flex-direction: column; gap: 10px; }
.alloc-row { display: flex; align-items: center; gap: 12px; }
.alloc-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.alloc-name { font-size: 13px; font-weight: 600; color: var(--slate); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.alloc-slider { flex: 1; max-width: 200px; height: 4px; -webkit-appearance: none; background: var(--mist); border-radius: 2px; outline: none; cursor: pointer; }
.alloc-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%; cursor: pointer; box-shadow: var(--shadow-sm); }
.alloc-pct { font-size: 13px; font-weight: 700; color: var(--navy); font-family: var(--mono); min-width: 38px; text-align: right; }

/* Empty/loading states */
.state-msg {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; padding: 80px 20px;
  text-align: center; color: var(--fog);
}
.state-msg .icon { font-size: 40px; margin-bottom: 16px; opacity: 0.5; }
.state-msg h3 { font-size: 16px; font-weight: 700; color: var(--slate2); margin-bottom: 6px; }
.state-msg p { font-size: 14px; max-width: 320px; }
.btn-primary {
  font-family: var(--font); font-size: 13px; font-weight: 600;
  padding: 9px 20px; background: var(--navy2); color: var(--white);
  border: none; border-radius: var(--radius); cursor: pointer;
  transition: background var(--transition); margin-top: 16px;
  display: inline-block;
}
.btn-primary:hover { background: var(--navy3); }
</style>
</head>
<body>

<div id="offering-root">
  <!-- Mode bar -->
  <div class="mode-bar">
    <button class="mode-tab active" id="tab-single">
      <svg viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round">
        <rect x="2" y="2" width="10" height="10" rx="1.5"/>
      </svg>
      Single Offering
    </button>
    <button class="mode-tab" id="tab-portfolio">
      <svg viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round">
        <rect x="1" y="4" width="4" height="8" rx="1"/><rect x="5" y="2" width="4" height="10" rx="1"/><rect x="9" y="5" width="4" height="7" rx="1"/>
      </svg>
      Portfolio View
      <span id="portfolio-tab-count" style="background:var(--ice);color:var(--slate2);font-size:10px;font-weight:700;padding:1px 6px;border-radius:100px;margin-left:2px;"></span>
    </button>
    <div class="mode-bar-spacer"></div>
    <div class="breadcrumb">
      <a onclick="AFL.navigate('browse')">â† Browse</a>
    </div>
  </div>

  <!-- Scrollable body -->
  <div class="offering-body" id="offering-body">
    <!-- Content injected by JS -->
  </div>
</div>

<script>
(function () {
  'use strict';

  let funds      = [];  // all funds
  let activeFund = null; // single view fund
  let basketFunds= []; // portfolio view funds
  let activeMode = 'single'; // 'single' | 'portfolio'
  let client     = null;
  let allocPcts  = []; // portfolio allocation percentages

  const $body = document.getElementById('offering-body');

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function esc(s) { if (!s) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

  function fmt(v, d=2, suffix='%') {
    if (v == null || isNaN(v)) return 'â€”';
    return Number(v).toFixed(d) + suffix;
  }
  function fmtMoney(v) {
    if (v == null || isNaN(v)) return 'â€”';
    const n = Number(v);
    if (n >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
    if (n >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M';
    if (n >= 1e3) return '$' + Math.round(n/1e3) + 'K';
    return '$' + n;
  }
  function statusOf(f) {
    if (f.status) return f.status;
    if (!f.offeringClose) return 'Open';
    const d = new Date(f.offeringClose);
    if (isNaN(d)) return 'Open';
    const ms = d - new Date();
    if (ms < 0) return 'Closed';
    if (ms < 30*24*60*60*1000) return 'Closing Soon';
    return 'Open';
  }
  function initials(s) { if (!s) return '??'; return s.split(/\s+/).slice(0,2).map(w=>w[0]).join('').toUpperCase(); }
  function ltvClass(v) { if (!v) return ''; if (v<=55) return 'green'; if (v>65) return 'amber'; return ''; }
  function suitClass(s) { if (s==null) return 'none'; if (s>=70) return 'high'; if (s>=45) return 'mid'; return 'low'; }
  function suitLabel(s, cls) {
    if (s==null || !client) return 'No client set';
    const map = {high:'Strong Match', mid:'Moderate Match', low:'Weak Match'};
    return (map[cls]||'Match') + ' â€” ' + s + '/100';
  }

  function logoHtml(fund, size=52) {
    const ini = initials(fund.sponsor||fund.name);
    if (fund.sponsorLogoUrl) {
      return `<div class="hero-logo" style="width:${size}px;height:${size}px">
        <img src="${esc(fund.sponsorLogoUrl)}" alt="${esc(fund.sponsor)}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
        <span style="display:none;width:100%;height:100%;align-items:center;justify-content:center;font-size:${Math.round(size*0.28)}px;font-weight:800;color:white">${esc(ini)}</span>
      </div>`;
    }
    return `<div class="hero-logo" style="width:${size}px;height:${size}px"><span>${esc(ini)}</span></div>`;
  }

  // â”€â”€ Suitability factors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function suitFactors(fund) {
    if (!client || !client.exchangeAmount) return [];
    const factors = [];
    if (fund.ltv != null) {
      if (fund.ltv <= 60) factors.push({pass:true,  text:`Low leverage (LTV ${fmt(fund.ltv)})`});
      else if (fund.ltv > 75) factors.push({pass:false, text:`High leverage (LTV ${fmt(fund.ltv)})`});
      else factors.push({pass:null, text:`Moderate leverage (LTV ${fmt(fund.ltv)})`});
    }
    if (fund.minInvest) {
      const ok = fund.minInvest <= client.exchangeAmount;
      factors.push({pass:ok, text:`Min invest ${fmtMoney(fund.minInvest)} vs ${fmtMoney(client.exchangeAmount)} available`});
    }
    if (fund.y1coc) factors.push({pass: fund.y1coc>=4, text:`Y1 CoC ${fmt(fund.y1coc)} (${fund.y1coc>=4?'meets':'below'} 4% threshold)`});
    if (fund.occupancy) factors.push({pass: fund.occupancy>=90, text:`Occupancy ${fmt(fund.occupancy)} (${fund.occupancy>=90?'strong':'below 90%'})`});
    if (client.propTypes && client.propTypes.length) {
      const match = client.propTypes.includes(fund.sector);
      factors.push({pass:match, text:`Sector ${fund.sector||'â€”'} ${match?'matches':'outside'} client preferences`});
    }
    return factors;
  }

  // â”€â”€ DD buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function ddButtons(fund) {
    const items = [
      { label:'Brochure',    url: fund.brochureUrl,        icon:'ğŸ“„' },
      { label:'PPM',         url: fund.ppmUrl,             icon:'ğŸ“‹' },
      { label:'Track Record',url: fund.trackRecordUrl,     icon:'ğŸ“Š' },
      { label:'Sales Team',  url: fund.salesTeamUrl,       icon:'ğŸ‘¥' },
      { label:'Video',       url: fund.videoUrl,           icon:'â–¶ï¸' },
      { label:'Sponsor News',url: fund.sponsorNewsUrl,     icon:'ğŸ“°' },
      { label:'AI Chat',     url: fund.aiChatUrl,          icon:'ğŸ¤–' },
      { label:'Qtly Update', url: fund.quarterlyUpdateUrl, icon:'ğŸ“…' },
    ];
    return items.map(item => {
      const cls = item.url ? '' : ' disabled';
      const attrs = item.url ? `href="${esc(item.url)}" target="_blank" rel="noopener"` : '';
      return `<a class="dd-btn${cls}" ${attrs}>${item.icon} ${item.label}</a>`;
    }).join('');
  }

  // â”€â”€ Distribution chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let chartInstance = null;
  function renderChart(fund, canvasId, color='#1D4ED8') {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const labels = ['Y1','Y2','Y3','Y4','Y5','Y6','Y7','Y8','Y9','Y10'];
    const data   = (fund.income||[]).map((v,i) => v != null ? v : null);
    if (chartInstance) { try { chartInstance.destroy(); } catch(e){} }
    chartInstance = new Chart(canvas, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          data,
          backgroundColor: color + 'CC',
          borderColor: color,
          borderWidth: 1.5,
          borderRadius: 4,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: {
          callbacks: { label: ctx => ctx.parsed.y != null ? ctx.parsed.y.toFixed(2)+'%' : 'â€”' }
        }},
        scales: {
          x: { grid: { display: false }, ticks: { font: { size: 10 } } },
          y: { grid: { color: 'rgba(0,0,0,0.05)' }, ticks: {
            font: { size: 10 }, callback: v => v+'%'
          }}
        }
      }
    });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  SINGLE OFFERING VIEW
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function renderSingle(fund) {
    activeFund = fund;
    const status    = statusOf(fund);
    const statusCls = status==='Open' ? 'status-open' : status==='Closing Soon' ? 'status-closing' : 'status-closed';
    const score     = (window.AFL && AFL.suitScore) ? AFL.suitScore(fund, client) : null;
    const sCls      = suitClass(score);
    const isIn      = window.AFL ? AFL.basket.has(fund.id) : false;
    const pctRem    = fund.pctRemaining;

    // Build income table rows
    const incomeRows = (fund.income||[]).map((v,i) => {
      if (v == null) return '';
      return `<tr><td>Yr ${i+1}</td><td class="${v>=5?'highlight':''}">${fmt(v)}</td></tr>`;
    }).filter(Boolean);

    $body.innerHTML = `
    <!-- HERO -->
    <div class="hero">
      <div class="hero-inner">
        <div class="hero-top">
          <div class="hero-logos">${logoHtml(fund)}</div>
          <div class="hero-title-area">
            <div class="hero-sponsor">${esc(fund.sponsor||'â€”')}</div>
            <div class="hero-name">${esc(fund.name||'Unnamed Offering')}</div>
            <div class="hero-badges">
              <span class="hero-badge ${statusCls}">${esc(status)}</span>
              ${fund.assetClass ? `<span class="hero-badge">${esc(fund.assetClass)}</span>` : ''}
              ${fund.sector     ? `<span class="hero-badge">${esc(fund.sector)}</span>` : ''}
              ${fund.offeringStructure ? `<span class="hero-badge">${esc(fund.offeringStructure)}</span>` : ''}
            </div>
          </div>
        </div>
        <div class="hero-kpis">
          <div class="hero-kpi">
            <span class="hero-kpi-label">Y1 Cash-on-Cash</span>
            <span class="hero-kpi-val ${fund.y1coc>=4?'green':''}">${fmt(fund.y1coc)}</span>
          </div>
          <div class="hero-kpi">
            <span class="hero-kpi-label">Loan to Value</span>
            <span class="hero-kpi-val ${ltvClass(fund.ltv)==='green'?'green':ltvClass(fund.ltv)==='amber'?'amber':''}">${fmt(fund.ltv)}</span>
          </div>
          <div class="hero-kpi">
            <span class="hero-kpi-label">Occupancy</span>
            <span class="hero-kpi-val ${fund.occupancy>=90?'green':''}">${fmt(fund.occupancy)}</span>
          </div>
          <div class="hero-kpi">
            <span class="hero-kpi-label">Hold Period</span>
            <span class="hero-kpi-val ${!fund.holdPeriod?'muted':''}">${fund.holdPeriod ? fund.holdPeriod+'yr' : 'â€”'}</span>
          </div>
          <div class="hero-kpi">
            <span class="hero-kpi-label">Min Investment</span>
            <span class="hero-kpi-val">${fmtMoney(fund.minInvest)}</span>
          </div>
          <div class="hero-kpi">
            <span class="hero-kpi-label">Cap Rate</span>
            <span class="hero-kpi-val">${fmt(fund.capRate)}</span>
          </div>
          <div class="hero-kpi">
            <span class="hero-kpi-label">DSCR</span>
            <span class="hero-kpi-val">${fund.dscr ? Number(fund.dscr).toFixed(2)+'x' : 'â€”'}</span>
          </div>
          <div class="hero-kpi">
            <span class="hero-kpi-label">Distribution</span>
            <span class="hero-kpi-val ${!fund.distFrequency?'muted':''}">${esc(fund.distFrequency||'â€”')}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- DD ROW -->
    <div class="dd-row">${ddButtons(fund)}</div>

    <!-- ACTION BAR -->
    <div class="action-bar">
      <button class="action-btn primary ${isIn?'in-basket':''}" id="action-basket-btn">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          ${isIn ? '<path d="M3 8l3.5 3.5L13 4.5"/>' : '<path d="M8 3v10M3 8h10"/>'}
        </svg>
        ${isIn ? 'In Basket âœ“' : 'Add to Basket'}
      </button>
      <button class="action-btn" id="action-portfolio-btn">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round">
          <rect x="1" y="9" width="4" height="6" rx="1"/><rect x="6" y="5" width="4" height="10" rx="1"/><rect x="11" y="1" width="4" height="14" rx="1"/>
        </svg>
        Portfolio View
      </button>
      <div class="action-bar-spacer"></div>
      ${score != null ? `<span style="font-size:13px;font-weight:600;color:${sCls==='high'?'#6ee7b7':sCls==='mid'?'#fcd34d':'#fca5a5'}">${suitLabel(score,sCls)}</span>` : ''}
    </div>

    <!-- ANALYST ZONE -->
    <div class="analyst-zone">
      <!-- Left column -->
      <div style="display:flex;flex-direction:column;gap:16px;">

        <!-- Key Details -->
        <div class="panel">
          <div class="panel-header"><span class="panel-title">Offering Details</span></div>
          <div class="panel-body tight">
            <div class="data-rows">
              <div class="data-row"><span class="data-row-label">Asset Class</span><span class="data-row-val">${esc(fund.assetClass||'â€”')}</span></div>
              <div class="data-row"><span class="data-row-label">Sector</span><span class="data-row-val">${esc(fund.sector||'â€”')}</span></div>
              <div class="data-row"><span class="data-row-label">Focus</span><span class="data-row-val">${esc(fund.focus||'â€”')}</span></div>
              <div class="data-row"><span class="data-row-label">Location(s)</span><span class="data-row-val">${esc(fund.location||'â€”')}</span></div>
              <div class="data-row"><span class="data-row-label">Structure</span><span class="data-row-val">${esc(fund.offeringStructure||'â€”')}</span></div>
              <div class="data-row"><span class="data-row-label">Exemption</span><span class="data-row-val">${esc(fund.exemption||'â€”')}</span></div>
              <div class="data-row"><span class="data-row-label">Tax Reporting</span><span class="data-row-val">${esc(fund.taxReporting||'â€”')}</span></div>
              <div class="data-row"><span class="data-row-label">721 UpREIT</span><span class="data-row-val">${esc(fund.upReit||'â€”')}</span></div>
              <div class="data-row"><span class="data-row-label">Hold Period</span><span class="data-row-val">${fund.holdPeriod ? fund.holdPeriod+' years' : 'â€”'}</span></div>
              <div class="data-row"><span class="data-row-label">Distribution Freq.</span><span class="data-row-val">${esc(fund.distFrequency||'â€”')}</span></div>
              <div class="data-row"><span class="data-row-label">Rep Comp</span><span class="data-row-val">${fmt(fund.repComp)}</span></div>
              <div class="data-row"><span class="data-row-label">Sales Load</span><span class="data-row-val">${fmt(fund.salesLoad)}</span></div>
            </div>
          </div>
        </div>

        <!-- Debt & Property -->
        <div class="panel">
          <div class="panel-header"><span class="panel-title">Property & Debt</span></div>
          <div class="panel-body tight">
            <div class="data-rows">
              <div class="data-row"><span class="data-row-label"># Assets</span><span class="data-row-val">${fund.numAssets||'â€”'}</span></div>
              <div class="data-row"><span class="data-row-label">Building Age</span><span class="data-row-val">${esc(fund.buildingAge||'â€”')}</span></div>
              <div class="data-row"><span class="data-row-label">Total Sq Ft</span><span class="data-row-val">${fund.sqft ? Number(fund.sqft).toLocaleString() : 'â€”'}</span></div>
              <div class="data-row"><span class="data-row-label">Tenant Credit</span><span class="data-row-val">${esc(fund.tenantCredit||'â€”')}</span></div>
              <div class="data-row"><span class="data-row-label">Avg Lease Remaining</span><span class="data-row-val">${fund.avgLeaseTerm ? fund.avgLeaseTerm+'yr' : 'â€”'}</span></div>
              <div class="data-row"><span class="data-row-label">Rent Escalations</span><span class="data-row-val">${esc(fund.rentEscalations||'â€”')}</span></div>
              <div class="data-row"><span class="data-row-label">Debt Terms</span><span class="data-row-val">${esc(fund.debtTerms||'â€”')}</span></div>
              <div class="data-row"><span class="data-row-label">DSCR</span><span class="data-row-val">${fund.dscr ? Number(fund.dscr).toFixed(2)+'x' : 'â€”'}</span></div>
              <div class="data-row"><span class="data-row-label">Purchase Price</span><span class="data-row-val">${fmtMoney(fund.purchasePrice)}</span></div>
              <div class="data-row"><span class="data-row-label">Appraised Value</span><span class="data-row-val">${fmtMoney(fund.appraisedValue)}</span></div>
              <div class="data-row"><span class="data-row-label">Loaded Price</span><span class="data-row-val">${fmtMoney(fund.loadedPrice)}</span></div>
              <div class="data-row"><span class="data-row-label">GP Commit</span><span class="data-row-val">${esc(fund.gpCommit||'â€”')}</span></div>
              <div class="data-row"><span class="data-row-label">Reserve</span><span class="data-row-val">${esc(fund.reserve||'â€”')}</span></div>
            </div>
          </div>
        </div>

        <!-- Distribution Chart -->
        ${fund.income && fund.income.some(v=>v!=null) ? `
        <div class="panel">
          <div class="panel-header"><span class="panel-title">Projected Cash-on-Cash Distributions</span></div>
          <div class="panel-body">
            <div class="chart-wrap"><canvas id="dist-chart"></canvas></div>
          </div>
        </div>` : ''}

        <!-- Projection Table -->
        ${incomeRows.length ? `
        <div class="panel">
          <div class="panel-header"><span class="panel-title">Distribution Projections</span></div>
          <div class="panel-body tight">
            <table class="proj-table">
              <thead><tr><th>Year</th><th>CoC %</th></tr></thead>
              <tbody>${incomeRows.join('')}</tbody>
            </table>
          </div>
        </div>` : ''}

      </div><!-- /left col -->

      <!-- Right column -->
      <div style="display:flex;flex-direction:column;gap:16px;">

        <!-- Suitability Panel -->
        <div class="panel">
          <div class="panel-header"><span class="panel-title">Suitability</span></div>
          <div class="suit-panel-score">
            <div class="suit-score-circle ${sCls}">${score != null ? score : 'â€”'}</div>
            <div class="suit-score-text">
              <div class="suit-score-title">${suitLabel(score, sCls)}</div>
              <div class="suit-score-sub">${!client || !client.exchangeAmount ? 'Set a client profile to score' : (client.name||'Client') + ' Â· ' + fmtMoney(client.exchangeAmount)}</div>
            </div>
          </div>
          <div class="suit-factors">
            ${suitFactors(fund).map(f => `
              <div class="suit-factor">
                <div class="suit-factor-dot ${f.pass===true?'pass':f.pass===false?'fail':'neutral'}"></div>
                <span>${esc(f.text)}</span>
              </div>`).join('')}
            ${(!client||!client.exchangeAmount) ? `<button class="btn-primary" style="width:100%;margin-top:8px;" onclick="AFL.navigate('client')">Set Client Profile</button>` : ''}
          </div>
        </div>

        <!-- Raise Status -->
        ${fund.filedRaise ? `
        <div class="panel">
          <div class="panel-header"><span class="panel-title">Raise Status</span></div>
          <div class="raise-progress-wrap">
            <div class="raise-stats">
              <div class="raise-stat">
                <span class="raise-stat-label">Filed Raise</span>
                <span class="raise-stat-val">${fmtMoney(fund.filedRaise)}</span>
              </div>
              <div class="raise-stat">
                <span class="raise-stat-label">Raised</span>
                <span class="raise-stat-val">${fmtMoney(fund.currentRaise)}</span>
              </div>
              <div class="raise-stat">
                <span class="raise-stat-label">Remaining</span>
                <span class="raise-stat-val">${fmtMoney(fund.equityRemaining)}</span>
              </div>
            </div>
            ${fund.pctRemaining != null ? `
            <div class="raise-bar-track">
              <div class="raise-bar-fill ${fund.pctRemaining<20?'amber':''}" style="width:${Math.min(100,100-fund.pctRemaining).toFixed(1)}%"></div>
            </div>
            <div style="font-size:11px;color:var(--fog);margin-top:6px;text-align:right;">${fund.pctRemaining.toFixed(0)}% remaining</div>` : ''}
          </div>
        </div>` : ''}

        <!-- Sponsor Section -->
        <div class="panel">
          <div class="panel-header"><span class="panel-title">Sponsor</span></div>
          <div class="sponsor-header" onclick="AFL.navigate('sponsor',{name:'${esc(fund.sponsor)}'})">
            <div class="sponsor-logo-sm">
              ${fund.sponsorLogoUrl
                ? `<img src="${esc(fund.sponsorLogoUrl)}" alt="${esc(fund.sponsor)}" onerror="this.style.display='none'">`
                : esc(initials(fund.sponsor))}
            </div>
            <div class="sponsor-info">
              <div class="sponsor-name-sm">${esc(fund.sponsor||'â€”')}</div>
              <div class="sponsor-exp">${esc(fund.sponsorExperience||'')}</div>
            </div>
            <span class="sponsor-arrow">â€º</span>
          </div>
          <div class="sponsor-stats">
            <div class="sponsor-stat">
              <span class="sponsor-stat-label">AUM</span>
              <span class="sponsor-stat-val">${esc(fund.sponsorAum||'â€”')}</span>
            </div>
            <div class="sponsor-stat">
              <span class="sponsor-stat-label">Offerings</span>
              <span class="sponsor-stat-val">${fund.sponsorOfferings||'â€”'}</span>
            </div>
            <div class="sponsor-stat">
              <span class="sponsor-stat-label">Full Cycle Exits</span>
              <span class="sponsor-stat-val">${fund.sponsorExits||'â€”'}</span>
            </div>
            <div class="sponsor-stat">
              <span class="sponsor-stat-label">Avg IRR</span>
              <span class="sponsor-stat-val">${fmt(fund.sponsorAvgIrr)}</span>
            </div>
          </div>
          <div class="panel-body tight" style="padding-top:10px;">
            <div class="data-rows">
              <div class="data-row"><span class="data-row-label">Best IRR</span><span class="data-row-val green">${fmt(fund.sponsorBestIrr)}</span></div>
              <div class="data-row"><span class="data-row-label">Worst IRR</span><span class="data-row-val">${fmt(fund.sponsorWorstIrr)}</span></div>
            </div>
          </div>
        </div>

      </div><!-- /right col -->
    </div><!-- /analyst-zone -->
    `;

    // Render chart after DOM update
    if (fund.income && fund.income.some(v=>v!=null)) {
      setTimeout(() => renderChart(fund, 'dist-chart'), 50);
    }

    // Basket button
    document.getElementById('action-basket-btn').addEventListener('click', () => {
      if (window.AFL) {
        if (AFL.basket.has(fund.id)) {
          AFL.basket.remove(fund.id);
          if (AFL.toast) AFL.toast('Removed from basket', 'info');
        } else {
          const ok = AFL.basket.add(fund.id);
          if (!ok) { if (AFL.toast) AFL.toast('Basket full â€” max 3 offerings', 'error'); return; }
          if (AFL.toast) AFL.toast('Added to basket âœ“', 'success');
        }
        AFL.updateHeader && AFL.updateHeader();
        renderSingle(fund); // re-render to update button state
      }
    });

    // Portfolio view button
    document.getElementById('action-portfolio-btn').addEventListener('click', () => {
      switchMode('portfolio');
    });
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  PORTFOLIO VIEW
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  function renderPortfolio() {
    basketFunds = window.AFL ? AFL.basket.get() : [];

    if (!basketFunds.length) {
      $body.innerHTML = `
        <div class="state-msg">
          <div class="icon">ğŸ§º</div>
          <h3>Basket is empty</h3>
          <p>Add 2â€“3 offerings to your basket from Browse to compare them here.</p>
          <button class="btn-primary" onclick="AFL.navigate('browse')">Browse Offerings</button>
        </div>`;
      return;
    }

    const n = basketFunds.length;
    allocPcts = basketFunds.map((_,i) => Math.round(100/n));
    // Fix rounding
    const rem = 100 - allocPcts.reduce((a,b)=>a+b,0);
    if (rem !== 0) allocPcts[0] += rem;

    const colors = ['var(--c0)','var(--c1)','var(--c2)'];
    const hexColors = ['#1D4ED8','#7C3AED','#B45309'];
    const colClasses = ['col-c0','col-c1','col-c2'];
    const thClasses  = ['th-c0','th-c1','th-c2'];

    function blended(field) {
      let total = 0, count = 0;
      basketFunds.forEach((f,i) => {
        const v = f[field];
        if (v != null && !isNaN(v)) { total += v * (allocPcts[i]/100); count++; }
      });
      return count ? total : null;
    }

    const blendedCoc = blended('y1coc');
    const blendedLtv = blended('ltv');
    const blendedOcc = blended('occupancy');
    const totalMin   = basketFunds.reduce((a,f) => a + (f.minInvest||0), 0);

    // Comparison rows definition
    const compRows = [
      { label:'Y1 CoC', field:'y1coc', fmt: v=>fmt(v), bestFn: vals=>Math.max(...vals.filter(v=>v!=null)) },
      { label:'LTV', field:'ltv', fmt: v=>fmt(v), bestFn: vals=>Math.min(...vals.filter(v=>v!=null)) },
      { label:'Occupancy', field:'occupancy', fmt: v=>fmt(v), bestFn: vals=>Math.max(...vals.filter(v=>v!=null)) },
      { label:'Hold Period', field:'holdPeriod', fmt: v=>v?v+'yr':'â€”', bestFn: null },
      { label:'Min Invest', field:'minInvest', fmt: fmtMoney, bestFn: vals=>Math.min(...vals.filter(v=>v!=null)) },
      { label:'Cap Rate', field:'capRate', fmt: v=>fmt(v), bestFn: vals=>Math.max(...vals.filter(v=>v!=null)) },
      { label:'DSCR', field:'dscr', fmt: v=>v?Number(v).toFixed(2)+'x':'â€”', bestFn: vals=>Math.max(...vals.filter(v=>v!=null)) },
      { label:'Avg Lease Remaining', field:'avgLeaseTerm', fmt: v=>v?v+'yr':'â€”', bestFn: vals=>Math.max(...vals.filter(v=>v!=null)) },
      { label:'Rep Comp', field:'repComp', fmt: v=>fmt(v), bestFn: null },
      { label:'Status', field:'status', fmt: (v,f)=>statusOf(f), bestFn: null },
      { label:'Sector', field:'sector', fmt: v=>v||'â€”', bestFn: null },
      { label:'Location', field:'location', fmt: v=>v||'â€”', bestFn: null },
      { label:'Exemption', field:'exemption', fmt: v=>v||'â€”', bestFn: null },
    ];

    $body.innerHTML = `
    <div class="portfolio-view">
      <div class="portfolio-header">
        <div>
          <div class="portfolio-title">Portfolio Comparison</div>
          <div class="portfolio-subtitle">${n} offering${n>1?'s':''} Â· Blended analysis</div>
        </div>
      </div>

      <!-- Blended KPIs -->
      <div class="blended-strip">
        <div class="blended-kpi">
          <span class="blended-kpi-label">Blended Y1 CoC</span>
          <span class="blended-kpi-val ${blendedCoc>=4?'green':''}">${fmt(blendedCoc)}</span>
          <span class="blended-kpi-sub">Weighted average</span>
        </div>
        <div class="blended-kpi">
          <span class="blended-kpi-label">Blended LTV</span>
          <span class="blended-kpi-val">${fmt(blendedLtv)}</span>
          <span class="blended-kpi-sub">Weighted average</span>
        </div>
        <div class="blended-kpi">
          <span class="blended-kpi-label">Blended Occupancy</span>
          <span class="blended-kpi-val ${blendedOcc>=90?'green':''}">${fmt(blendedOcc)}</span>
          <span class="blended-kpi-sub">Weighted average</span>
        </div>
        <div class="blended-kpi">
          <span class="blended-kpi-label">Total Min Invest</span>
          <span class="blended-kpi-val">${fmtMoney(totalMin)}</span>
          <span class="blended-kpi-sub">Combined minimum</span>
        </div>
      </div>

      <!-- Allocation sliders -->
      <div class="alloc-section">
        <div class="alloc-title">Portfolio Allocation</div>
        <div class="alloc-rows" id="alloc-rows">
          ${basketFunds.map((f,i) => `
            <div class="alloc-row">
              <div class="alloc-dot" style="background:${hexColors[i]}"></div>
              <div class="alloc-name">${esc(f.name||f.sponsor||'Offering '+(i+1))}</div>
              <input type="range" class="alloc-slider" id="alloc-${i}" min="0" max="100" step="5" value="${allocPcts[i]}"
                style="--thumb-color:${hexColors[i]}"
                oninput="window._allocChange(${i}, this.value)">
              <span class="alloc-pct" id="alloc-pct-${i}">${allocPcts[i]}%</span>
            </div>`).join('')}
        </div>
      </div>

      <!-- Comparison Table -->
      <table class="comp-table">
        <thead>
          <tr>
            <th>Metric</th>
            ${basketFunds.map((f,i) => `<th class="offering-col ${thClasses[i]}">${esc(f.name||'Offering '+(i+1))}</th>`).join('')}
          </tr>
        </thead>
        <tbody>
          ${compRows.map(row => {
            const vals = basketFunds.map(f => row.field==='status' ? statusOf(f) : f[row.field]);
            const numVals = vals.map(v => typeof v === 'number' ? v : null);
            const best = row.bestFn ? row.bestFn(numVals) : null;
            return `<tr>
              <td class="row-label">${row.label}</td>
              ${basketFunds.map((f,i) => {
                const raw = row.field==='status' ? statusOf(f) : f[row.field];
                const isBest = best != null && raw === best;
                return `<td class="mono-val ${colClasses[i]} ${isBest?'best-val':''}">${row.fmt(raw,f)}</td>`;
              }).join('')}
            </tr>`;
          }).join('')}
        </tbody>
      </table>

      <!-- Individual cards row -->
      <div style="display:grid;grid-template-columns:repeat(${n},1fr);gap:16px;">
        ${basketFunds.map((f,i) => {
          const score = (window.AFL && AFL.suitScore) ? AFL.suitScore(f, client) : null;
          const sCls  = suitClass(score);
          return `
          <div class="panel">
            <div style="height:5px;background:${hexColors[i]}"></div>
            <div class="panel-body tight">
              <div style="font-size:12px;font-weight:700;letter-spacing:0.05em;text-transform:uppercase;color:var(--fog);margin-bottom:4px">${esc(f.sponsor||'â€”')}</div>
              <div style="font-size:14px;font-weight:700;color:var(--navy);margin-bottom:10px">${esc(f.name||'â€”')}</div>
              <div class="data-rows">
                <div class="data-row"><span class="data-row-label">Y1 CoC</span><span class="data-row-val green">${fmt(f.y1coc)}</span></div>
                <div class="data-row"><span class="data-row-label">LTV</span><span class="data-row-val">${fmt(f.ltv)}</span></div>
                <div class="data-row"><span class="data-row-label">Occupancy</span><span class="data-row-val">${fmt(f.occupancy)}</span></div>
              </div>
              ${score != null ? `<div style="margin-top:10px"><span class="suit-score-title" style="font-size:12px">Suitability: </span><span style="font-weight:700;color:${sCls==='high'?'var(--green)':sCls==='mid'?'var(--amber)':'var(--red)'}">${score}/100</span></div>` : ''}
              <button class="btn-primary" style="width:100%;margin-top:10px;font-size:12px;padding:7px 12px;" onclick="window._viewFund(${f.id})">View Detail â†’</button>
            </div>
          </div>`;
        }).join('')}
      </div>

    </div><!-- /portfolio-view -->
    `;

    // Slider style injection for thumb colors
    const styleId = 'alloc-slider-style';
    document.getElementById(styleId)?.remove();
    const st = document.createElement('style');
    st.id = styleId;
    st.textContent = basketFunds.map((f,i) => `
      #alloc-${i}::-webkit-slider-thumb { background: ${hexColors[i]}; }
      #alloc-${i}::-moz-range-thumb { background: ${hexColors[i]}; width:14px;height:14px;border-radius:50%;border:none; }
    `).join('');
    document.head.appendChild(st);

    // Expose alloc change handler
    window._allocChange = function(idx, val) {
      allocPcts[idx] = parseInt(val);
      document.getElementById('alloc-pct-'+idx).textContent = val + '%';
      // Could re-compute blended KPIs here live â€” for now just update display
    };

    window._viewFund = function(id) {
      const f = funds.find(x => x.id === id);
      if (f) { activeFund = f; switchMode('single'); }
    };
  }

  // â”€â”€ Mode switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function switchMode(mode) {
    activeMode = mode;
    document.getElementById('tab-single').classList.toggle('active', mode==='single');
    document.getElementById('tab-portfolio').classList.toggle('active', mode==='portfolio');
    if (mode === 'single') {
      if (activeFund) renderSingle(activeFund);
      else if (funds.length) renderSingle(funds[0]);
    } else {
      renderPortfolio();
    }
  }

  // â”€â”€ Tab clicks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('tab-single').addEventListener('click', () => switchMode('single'));
  document.getElementById('tab-portfolio').addEventListener('click', () => switchMode('portfolio'));

  // â”€â”€ Update portfolio tab count â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updatePortfolioTabCount() {
    const n = window.AFL ? AFL.basket.count() : 0;
    const pill = document.getElementById('portfolio-tab-count');
    pill.textContent = n > 0 ? n : '';
    pill.style.display = n > 0 ? '' : 'none';
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  INIT
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  async function init(initParams = {}) {
    client = (initParams.client) || (window.AFL ? AFL.state.client : null);
    funds  = window.AFL ? (AFL.state.funds.length ? AFL.state.funds : await AFL.loadFunds()) : [];

    // Determine which fund(s) to show
    const params = initParams.params || {};

    updatePortfolioTabCount();

    if (params.fromBasket || activeMode === 'portfolio') {
      switchMode('portfolio');
      return;
    }

    // Single fund: from params.ids or basket or first fund
    let fundId = null;
    if (params.ids && params.ids.length) fundId = params.ids[0];
    else if (window.AFL && AFL.basket.count() > 0) fundId = AFL.basket._ids()[0];

    if (fundId) {
      activeFund = funds.find(f => f.id === fundId) || funds[0];
    } else {
      activeFund = funds[0];
    }

    if (!activeFund) {
      $body.innerHTML = `<div class="state-msg"><div class="icon">ğŸ“­</div><h3>No offering selected</h3><p>Go to Browse and click an offering.</p><button class="btn-primary" onclick="AFL.navigate('browse')">Browse Offerings</button></div>`;
      return;
    }

    switchMode('single');
  }

  window.currentModule = { init };

  // Auto-init when standalone
  if (!window._aflShellActive) {
    function tryInit() {
      if (window.AFL) init({});
      else setTimeout(tryInit, 50);
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', tryInit);
    else tryInit();
  }

})();
</script>
</body>
</html>
