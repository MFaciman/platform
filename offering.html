<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AFL â€” Offering Detail</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700;9..40,800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AFL OFFERING MODULE â€” Tokens match platform spec
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --navy:#0B1F3B;--navy2:#1C3A63;--navy3:#2A4D7A;--slate:#3A5270;--slate2:#5C7A99;
  --fog:#8FA3BA;--mist:#C8D8E8;--ice:#E8F0F8;--white:#FFFFFF;--surface:#F4F7FB;--surface2:#EEF3FA;
  --green:#1A7A4A;--green-lt:#E8F7EF;--amber:#B45309;--amber-lt:#FEF3C7;
  --red:#991B1B;--red-lt:#FEE2E2;--blue:#1D4ED8;--blue-lt:#EFF6FF;
  --o1:#3B82F6;--o1-lt:#EFF6FF;--o1-mid:#BFDBFE;
  --o2:#7C3AED;--o2-lt:#F5F3FF;--o2-mid:#DDD6FE;
  --o3:#D97706;--o3-lt:#FFFBEB;--o3-mid:#FDE68A;
  --radius:8px;--radius-lg:14px;
  --shadow-sm:0 1px 3px rgba(11,31,59,0.08),0 1px 2px rgba(11,31,59,0.05);
  --shadow:0 4px 12px rgba(11,31,59,0.10);
  --shadow-lg:0 12px 32px rgba(11,31,59,0.14);
  --font:'DM Sans',sans-serif;
  --mono:'DM Mono',monospace;
  --transition:0.18s cubic-bezier(0.4,0,0.2,1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--font);font-size:14px;background:var(--surface);color:var(--navy);-webkit-font-smoothing:antialiased}

/* â”€â”€â”€ Scrollbar â”€â”€â”€ */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-thumb{background:var(--mist);border-radius:3px}

/* â”€â”€â”€ Mode Toggle Bar â”€â”€â”€ */
.mode-bar{background:#fff;border-bottom:1px solid var(--mist);padding:0 24px;display:flex;align-items:center;gap:12px;height:44px;position:sticky;top:0;z-index:60;box-shadow:var(--shadow-sm)}
.mode-toggle{display:flex;background:var(--surface);border-radius:8px;padding:3px;gap:2px}
.mode-btn{padding:5px 14px;border-radius:6px;border:none;background:transparent;font-size:12px;font-weight:500;color:var(--slate2);font-family:var(--font);cursor:pointer;transition:all var(--transition);display:flex;align-items:center;gap:5px}
.mode-btn.active{background:#fff;color:var(--navy);font-weight:700;box-shadow:var(--shadow-sm)}
.mode-btn .dot{width:7px;height:7px;border-radius:50%}
.breadcrumb{font-size:12.5px;color:var(--slate2);display:flex;align-items:center;gap:7px}
.breadcrumb a{color:var(--blue);cursor:pointer;text-decoration:none}
.breadcrumb strong{color:var(--navy)}
.mode-right{margin-left:auto;display:flex;gap:6px}
.mode-right button{padding:4px 11px;font-size:11.5px;font-weight:500;border:1.5px solid var(--mist);border-radius:6px;background:#fff;color:var(--navy);font-family:var(--font);cursor:pointer;transition:all var(--transition)}
.mode-right button:hover{border-color:var(--slate2)}

/* â”€â”€â”€ HERO â”€â”€â”€ */
.hero{background:var(--navy);overflow:hidden}
.hero-inner{display:grid;grid-template-columns:1fr 420px}
.hero-left{padding:22px 28px;display:flex;flex-direction:column;justify-content:space-between;gap:14px}

/* Single mode hero-left */
.sponsor-row{display:flex;align-items:center;gap:11px}
.sponsor-logo{background:#fff;border-radius:9px;width:46px;height:46px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:var(--navy);text-align:center;line-height:1.3;padding:4px;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,0.3);overflow:hidden}
.sponsor-logo img{width:100%;height:100%;object-fit:contain;border-radius:7px}
.sponsor-name{font-size:11.5px;color:rgba(255,255,255,0.5);font-weight:500}
.offering-name{font-size:22px;font-weight:800;color:#fff;letter-spacing:-.03em;line-height:1.2}
.offering-location{font-size:12px;color:rgba(255,255,255,0.4);margin-top:2px}
.hero-badges{display:flex;gap:6px;flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700}
.badge-open{background:#16A34A;color:#fff}
.badge-closing{background:var(--amber);color:#fff}
.badge-closed{background:var(--slate);color:#fff}
.badge-prop{background:rgba(255,255,255,0.12);color:rgba(255,255,255,0.9);border:1px solid rgba(255,255,255,0.2)}
.badge-sector{background:rgba(59,130,246,0.2);color:#93C5FD;border:1px solid rgba(59,130,246,0.25)}

/* Portfolio mode hero-left */
.portfolio-logos{display:flex;gap:6px;align-items:center;margin-bottom:4px}
.sp-logo-sm{background:#fff;border-radius:8px;width:38px;height:38px;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:800;color:var(--navy);text-align:center;line-height:1.2;padding:3px;flex-shrink:0;box-shadow:0 2px 6px rgba(0,0,0,0.25);overflow:hidden}
.sp-logo-sm img{width:100%;height:100%;object-fit:contain;border-radius:6px}
.portfolio-title{font-size:21px;font-weight:800;color:#fff;letter-spacing:-.03em;line-height:1.2}
.portfolio-subtitle{font-size:12px;color:rgba(255,255,255,0.4);margin-top:2px}
.o-offerings-list{display:flex;flex-direction:column;gap:5px;margin-top:6px}
.o-row{display:flex;align-items:center;gap:8px}
.o-pill{display:inline-flex;align-items:center;gap:5px;padding:3px 10px 3px 4px;border-radius:20px;font-size:11px;font-weight:700;border:1px solid}
.o-pill-1{background:rgba(59,130,246,0.15);border-color:rgba(59,130,246,0.3);color:#93C5FD}
.o-pill-2{background:rgba(124,58,237,0.15);border-color:rgba(124,58,237,0.3);color:#C4B5FD}
.o-pill-3{background:rgba(217,119,6,0.15);border-color:rgba(217,119,6,0.3);color:#FCD34D}
.o-dot{width:14px;height:14px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:8px;font-weight:800;color:#fff;flex-shrink:0}
.o-dot-1{background:var(--o1)}.o-dot-2{background:var(--o2)}.o-dot-3{background:var(--o3)}
.o-alloc-pct{font-size:10px;color:rgba(255,255,255,0.3)}
.alloc-bar-wrap{margin-top:4px}
.alloc-bar-lbl{font-size:9px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:rgba(255,255,255,0.3);margin-bottom:5px}
.alloc-bar{height:10px;border-radius:5px;overflow:hidden;display:flex}
.alloc-seg{height:100%;transition:width .4s ease}
.alloc-labels{display:flex;justify-content:space-between;margin-top:5px;font-size:10px}

/* Hero right panels */
.hero-right{display:grid;grid-template-columns:1fr 1fr;gap:0;overflow:hidden;border-left:1px solid rgba(255,255,255,0.08)}
.hero-panel{display:flex;flex-direction:column;overflow:hidden}
.hero-panel+.hero-panel{border-left:1px solid rgba(255,255,255,0.06)}
.hero-panel-lbl{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:rgba(255,255,255,0.3);padding:8px 10px 4px;flex-shrink:0}
.hero-panel-body{flex:1;overflow:hidden;display:flex;align-items:center;justify-content:center;min-height:140px}

/* Map */
#us-map-single,#us-map-portfolio{width:100%;height:100%}
.state-base{fill:#1C3A63;stroke:#0d1e36;stroke-width:0.4;transition:fill .2s}
.state-o1{fill:var(--o1);stroke:#0d1e36;stroke-width:0.4;filter:drop-shadow(0 0 4px rgba(59,130,246,0.7))}
.state-o2{fill:var(--o2);stroke:#0d1e36;stroke-width:0.4;filter:drop-shadow(0 0 4px rgba(124,58,237,0.7))}
.state-o3{fill:var(--o3);stroke:#0d1e36;stroke-width:0.4;filter:drop-shadow(0 0 4px rgba(217,119,6,0.6))}
.state-multi{fill:#06B6D4;stroke:#0d1e36;stroke-width:0.4}
.map-legend{display:flex;flex-direction:column;gap:4px;padding:0 10px 8px;flex-shrink:0}
.map-leg-item{display:flex;align-items:center;gap:5px;font-size:9px;color:rgba(255,255,255,0.45)}
.map-leg-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

/* Video panel - single */
.video-single{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;color:rgba(255,255,255,0.25);padding:12px;background:#0a1628}
.video-play-btn{width:42px;height:42px;border-radius:50%;background:rgba(255,255,255,0.1);border:1.5px solid rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s}
.video-play-btn:hover{background:rgba(255,255,255,0.2);border-color:rgba(255,255,255,0.4)}
.video-play-btn svg{margin-left:3px}
.video-title{font-size:10px;text-align:center;line-height:1.4;color:rgba(255,255,255,0.35)}

/* Video panel - portfolio (3 rows) */
.video-portfolio{display:flex;flex-direction:column;gap:6px;width:100%;padding:8px;background:#0a1628;height:100%}
.video-row{flex:1;border:1px solid rgba(255,255,255,0.08);border-radius:8px;background:rgba(255,255,255,0.03);display:flex;align-items:center;gap:9px;padding:8px 10px;cursor:pointer;transition:background .15s;min-height:0}
.video-row:hover{background:rgba(255,255,255,0.07)}
.video-row.unavail{opacity:.4;pointer-events:none}
.video-row-play{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.video-row-name{font-size:10.5px;font-weight:600;color:rgba(255,255,255,0.65)}
.video-row-meta{font-size:9.5px;color:rgba(255,255,255,0.3)}
.video-row-play-lbl{margin-left:auto;font-size:9px;font-weight:600}

/* KPI Strip */
.kpi-strip{display:grid;background:var(--navy2);border-top:1px solid rgba(255,255,255,0.08)}
.kpi-strip-single{grid-template-columns:repeat(4,1fr)}
.kpi-strip-portfolio{grid-template-columns:repeat(4,1fr)}
.kpi{padding:12px 18px;border-right:1px solid rgba(255,255,255,0.07)}
.kpi:last-child{border-right:none}
.kpi-lbl{font-size:9.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:rgba(255,255,255,0.4);margin-bottom:3px}
.kpi-lbl span{font-size:8px;opacity:.6;font-weight:400}
.kpi-val{font-size:21px;font-weight:800;color:#fff;letter-spacing:-.025em;line-height:1;font-family:var(--mono)}
.kpi-sub{font-size:10.5px;color:rgba(255,255,255,0.38);margin-top:3px;display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.kpi-good{color:#34D399;font-weight:600}
.kpi-bad{color:#F87171;font-weight:600}
.kpi-bar{height:3px;background:rgba(255,255,255,0.1);border-radius:2px;margin-top:6px;overflow:hidden}
.kpi-fill{height:100%;border-radius:2px}
.kpi-breakdown{display:flex;gap:6px;margin-top:5px;flex-wrap:wrap}
.kpi-bd-item{font-size:9px;color:rgba(255,255,255,0.35);display:flex;align-items:center;gap:3px}
.kpi-bd-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}

/* â”€â”€â”€ DD Icon Row â”€â”€â”€ */
.dd-row{background:#fff;border-bottom:1px solid var(--mist);padding:0 24px;display:flex;align-items:stretch;overflow-x:auto}
.dd-grp{display:flex;flex-direction:column;padding:11px 0;flex:1;min-width:0}
.dd-grp-lbl{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--fog);margin-bottom:9px;white-space:nowrap}
.dd-icons{display:flex;gap:5px;flex-wrap:nowrap}
.dd-sep{width:1px;background:var(--mist);margin:10px 18px;flex-shrink:0}

/* DD button + hover dropdown */
.dd-wrap{position:relative}
.dd-btn{display:flex;flex-direction:column;align-items:center;gap:4px;padding:7px 9px;border:1.5px solid var(--mist);border-radius:9px;background:#fff;cursor:pointer;transition:all var(--transition);min-width:58px;font-family:var(--font)}
.dd-btn:hover{border-color:var(--navy2);background:var(--ice)}
.dd-btn.off{opacity:0.35;cursor:default;pointer-events:none}
.dd-ico{width:34px;height:34px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.dd-ico.ai{background:linear-gradient(135deg,#EFF6FF,#DBEAFE)}
.dd-ico.doc{background:linear-gradient(135deg,#F0FDF4,#DCFCE7)}
.dd-ico.news{background:linear-gradient(135deg,#FFF7ED,#FED7AA)}
.dd-ico.track{background:linear-gradient(135deg,#F5F3FF,#EDE9FE)}
.dd-ico.team{background:linear-gradient(135deg,#ECFEFF,#CFFAFE)}
.dd-ico.raise{background:linear-gradient(135deg,#FFF1F2,#FFE4E6)}
.dd-ico.upd{background:linear-gradient(135deg,#FEFCE8,#FEF9C3);font-size:11px;font-weight:700;color:var(--amber);line-height:1.2;text-align:center}
.dd-lbl{font-size:9.5px;font-weight:600;color:var(--slate);text-align:center;line-height:1.2}

/* Hover dropdown */
.dd-drop{position:absolute;top:calc(100% + 5px);left:50%;transform:translateX(-50%) translateY(-4px);background:#fff;border:1.5px solid var(--mist);border-radius:10px;box-shadow:var(--shadow-lg);min-width:185px;z-index:200;padding:5px;opacity:0;pointer-events:none;transition:opacity .15s,transform .15s}
.dd-wrap:hover .dd-drop{opacity:1;pointer-events:all;transform:translateX(-50%) translateY(0)}
.dd-drop::before{content:'';position:absolute;top:-7px;left:50%;transform:translateX(-50%) rotate(45deg);width:11px;height:11px;background:#fff;border-left:1.5px solid var(--mist);border-top:1.5px solid var(--mist)}
.dd-item{display:flex;align-items:center;gap:9px;padding:7px 10px;border-radius:7px;cursor:pointer;transition:background .12s;text-decoration:none;color:inherit}
.dd-item:hover{background:var(--ice)}
.dd-item.na{opacity:.4;cursor:default;pointer-events:none}
.dd-item-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.dd-item-name{font-size:11.5px;font-weight:600;color:var(--navy);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:130px}
.dd-item-meta{font-size:10px;color:var(--slate2)}
.dd-divider{height:1px;background:var(--mist);margin:3px 0}

/* â”€â”€â”€ Action Bar â”€â”€â”€ */
.action-bar{display:flex;align-items:center;gap:7px;padding:9px 24px;background:var(--surface2);border-bottom:1px solid var(--mist)}
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 14px;border-radius:var(--radius);border:none;font-size:12.5px;font-weight:600;cursor:pointer;transition:all var(--transition);font-family:var(--font);white-space:nowrap}
.btn-primary{background:var(--navy);color:#fff}.btn-primary:hover{background:var(--navy2)}
.btn-secondary{background:#fff;color:var(--navy);border:1.5px solid var(--mist)}.btn-secondary:hover{border-color:var(--slate2);background:var(--surface)}
.btn-danger{background:#fff;color:var(--red);border:1.5px solid #FECACA}.btn-danger:hover{background:var(--red-lt)}
.btn-added{background:var(--green-lt);color:var(--green);border:1.5px solid #BBF7D0}
.action-right{margin-left:auto;display:flex;align-items:center;gap:8px}
.suit-chip{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:8px;font-size:12px;font-weight:700}
.suit-chip.high{background:var(--green-lt);border:1.5px solid #BBF7D0;color:var(--green)}
.suit-chip.medium{background:var(--amber-lt);border:1.5px solid #FDE68A;color:var(--amber)}
.suit-chip.low{background:var(--red-lt);border:1.5px solid #FECACA;color:var(--red)}
.suit-chip.none{background:var(--surface);border:1.5px solid var(--mist);color:var(--slate2);cursor:pointer}.suit-chip.none:hover{border-color:var(--navy);color:var(--navy)}
.suit-mini{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:6px;font-size:11px;font-weight:700}
.suit-mini-1{background:var(--o1-lt);border:1px solid var(--o1-mid);color:var(--o1)}
.suit-mini-2{background:var(--o2-lt);border:1px solid var(--o2-mid);color:var(--o2)}
.suit-mini-3{background:var(--o3-lt);border:1px solid var(--o3-mid);color:var(--o3)}

/* â”€â”€â”€ Analyst Zone â”€â”€â”€ */
.analyst{padding:18px 24px;display:grid;gap:14px}
.panel{background:#fff;border:1px solid var(--mist);border-radius:var(--radius-lg);padding:18px 20px;box-shadow:var(--shadow-sm)}
.panel-title{font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--slate2);margin-bottom:13px;display:flex;align-items:center;gap:7px}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.three-col{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}

/* Metric tiles */
.mg{display:grid;gap:9px}
.mt{background:var(--surface);border:1px solid var(--mist);border-radius:var(--radius);padding:11px 13px}
.mt-lbl{font-size:10px;font-weight:600;letter-spacing:.04em;text-transform:uppercase;color:var(--slate2);margin-bottom:3px}
.mt-val{font-size:19px;font-weight:700;color:var(--navy);letter-spacing:-.02em;font-family:var(--mono)}
.mt-sub{font-size:10.5px;margin-top:3px}
.peer-chip{display:inline-flex;align-items:center;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:700}
.peer-chip.g{background:var(--green-lt);color:var(--green)}
.peer-chip.b{background:var(--red-lt);color:var(--red)}
.peer-chip.n{background:var(--ice);color:var(--slate2)}
.peer-chip.a{background:var(--amber-lt);color:var(--amber)}

/* Suitability panels */
.suit-panel-high{background:linear-gradient(135deg,var(--green-lt),#F0FDF4);border:1.5px solid #BBF7D0;border-radius:var(--radius-lg);padding:17px 20px}
.suit-panel-empty{background:var(--surface);border:1.5px dashed var(--mist);border-radius:var(--radius-lg);padding:17px 20px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:10px;min-height:160px}
.suit-panel-blend{background:linear-gradient(135deg,var(--green-lt),#F0FDF4);border:1.5px solid #BBF7D0;border-radius:var(--radius-lg);padding:17px 20px}
.suit-score-big{font-size:40px;font-weight:800;letter-spacing:-.04em;line-height:1;font-family:var(--mono)}
.suit-factors{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-top:12px}
.sf{display:flex;align-items:center;gap:6px;font-size:11.5px;color:var(--navy)}
.sf-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.suit-cards-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(0,0,0,0.06)}
.suit-card{border-radius:var(--radius);padding:10px 12px;border:1.5px solid}
.suit-card-1{background:var(--o1-lt);border-color:var(--o1-mid)}
.suit-card-2{background:var(--o2-lt);border-color:var(--o2-mid)}
.suit-card-3{background:var(--o3-lt);border-color:var(--o3-mid)}
.suit-card-score{font-size:22px;font-weight:800;letter-spacing:-.02em;font-family:var(--mono)}
.suit-card-name{font-size:10px;font-weight:600;color:var(--slate);margin-top:2px;line-height:1.3}

/* Progress bars */
.pbar{height:6px;background:var(--mist);border-radius:3px;overflow:hidden;margin-top:5px}
.pfill{height:100%;border-radius:3px;transition:width .4s ease}

/* Raise cards */
.raise-cards{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.raise-card{border:1.5px solid var(--mist);border-radius:var(--radius-lg);padding:14px 16px;background:var(--surface)}
.raise-card-header{display:flex;align-items:center;gap:7px;margin-bottom:10px}
.raise-card-title{font-size:12px;font-weight:700;color:var(--navy)}
.raise-card-sponsor{font-size:10.5px;color:var(--slate2)}

/* Comparison table */
.comp-table{width:100%;border-collapse:collapse;font-size:12.5px}
.comp-table th{padding:9px 12px;text-align:center;font-size:10px;font-weight:700;letter-spacing:.05em;text-transform:uppercase;border-bottom:2.5px solid}
.comp-table th:first-child{text-align:left;border-bottom-color:var(--mist);color:var(--slate2);width:140px}
.comp-table th.th1{color:var(--o1);border-bottom-color:var(--o1)}
.comp-table th.th2{color:var(--o2);border-bottom-color:var(--o2)}
.comp-table th.th3{color:var(--o3);border-bottom-color:var(--o3)}
.comp-table th.thb{color:var(--navy);border-bottom-color:var(--navy);background:var(--ice)}
.comp-table th.thp{color:var(--slate2);border-bottom-color:var(--mist)}
.comp-table td{padding:9px 12px;border-bottom:1px solid var(--mist);text-align:center;color:var(--navy)}
.comp-table td:first-child{text-align:left;font-weight:600;color:var(--slate);font-size:12px}
.comp-table td.tdb{background:var(--ice);font-weight:700}
.comp-table tr:last-child td{border-bottom:none}
.comp-table tr:hover td{background:var(--surface)}
.comp-table tr:hover td.tdb{background:#DCE8F5}
.best{font-weight:700;color:var(--green)}

/* Projection table */
.proj-table{width:100%;border-collapse:collapse;font-size:12.5px}
.proj-table th{padding:7px 11px;background:var(--navy);color:rgba(255,255,255,0.6);font-size:10px;font-weight:600;letter-spacing:.05em;text-transform:uppercase;text-align:center}
.proj-table th.hl{color:#fff;background:var(--navy2)}
.proj-table th:first-child{text-align:left;border-radius:8px 0 0 0}
.proj-table th:last-child{border-radius:0 8px 0 0}
.proj-table td{padding:8px 11px;border-bottom:1px solid var(--mist);text-align:center}
.proj-table td:first-child{text-align:left;font-weight:600;color:var(--slate)}
.proj-table td.hl{background:var(--ice);font-weight:700;color:var(--navy2)}
.proj-table tr:last-child td{border-bottom:none}
.proj-table tr.proj-total{background:var(--ice);font-weight:700}
.proj-table tr.proj-total td{color:var(--navy)}

/* Key drivers */
.kd-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:9px}
.kd{display:flex;align-items:flex-start;gap:8px;padding:11px 13px;border-radius:var(--radius);border:1.5px solid;font-size:12px;line-height:1.5}
.kd.pos{background:var(--green-lt);border-color:#BBF7D0;color:var(--green)}
.kd.neg{background:var(--red-lt);border-color:#FECACA;color:var(--red)}
.kd.neu{background:var(--ice);border-color:var(--mist);color:var(--slate)}
.kd-ico{font-size:15px;flex-shrink:0;margin-top:1px}

/* Valuation discount block */
.valuation-highlight{display:flex;align-items:center;gap:10px;margin-bottom:13px;padding:9px 13px;background:var(--green-lt);border:1.5px solid #BBF7D0;border-radius:var(--radius)}
.valuation-pct{font-size:22px;font-weight:800;color:var(--green)}

/* AI narrative */
.narr{font-size:13px;line-height:1.78;color:var(--navy)}

/* Chart */
.chart-wrap{height:170px;position:relative}

/* Sponsor banners */
.sp-banners{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.sp-banner{border:1px solid var(--mist);border-radius:var(--radius-lg);padding:14px}
.sp-banner-logo{width:46px;height:46px;background:#fff;border:1px solid var(--mist);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:var(--navy);text-align:center;padding:4px;line-height:1.3;flex-shrink:0;margin-bottom:9px;overflow:hidden}
.sp-banner-logo img{width:100%;height:100%;object-fit:contain;border-radius:6px}
.sp-chips{display:flex;flex-wrap:wrap;gap:4px;margin-top:7px}

/* Purchase price inline row */
.pp-inline{display:flex;gap:14px;margin-top:9px;font-size:12px;color:var(--slate)}
.pp-inline strong{color:var(--navy)}

/* Loading / Error states */
.loading-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 24px;gap:12px;color:var(--slate2)}
.spinner{width:32px;height:32px;border:3px solid var(--mist);border-top-color:var(--navy2);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.error-state{padding:32px 24px;text-align:center;color:var(--red)}
.empty-basket{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 24px;gap:12px;color:var(--slate2);text-align:center}
.empty-basket h3{font-size:16px;color:var(--navy)}

/* Data rows (for detail tables) */
.data-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--mist);font-size:13px}
.data-row:last-child{border-bottom:none}
.data-row-lbl{color:var(--slate2);font-weight:500}
.data-row-val{color:var(--navy);font-weight:600;text-align:right}
</style>
</head>
<body>

<div id="offering-module">
  <!-- Rendered by JS -->
  <div class="loading-state">
    <div class="spinner"></div>
    <div>Loading offering dataâ€¦</div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AFL OFFERING MODULE
//  Single file, wires to window.AFL from shared.js
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

(function() {
'use strict';

// â”€â”€ Module state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _mode     = 'single';   // 'single' | 'portfolio'
let _fundId   = null;       // active single fund id
let _funds    = [];         // basket funds (max 3)
let _allFunds = [];         // all platform funds
let _peers    = {};         // peer stats object
let _distChart= null;       // Chart.js instance
let _mapDrawn = false;      // D3 map already fetched

// Offering color palette
const O_COLORS = ['var(--o1)','var(--o2)','var(--o3)'];
const O_HEX    = ['#3B82F6','#7C3AED','#D97706'];
const O_CLASSES= ['o-pill-1','o-pill-2','o-pill-3'];
const O_DOT    = ['o-dot-1','o-dot-2','o-dot-3'];

// US State abbreviations by FIPS id
const STATE_BY_FIPS = {
  "01":"AL","02":"AK","04":"AZ","05":"AR","06":"CA","08":"CO","09":"CT",
  "10":"DE","12":"FL","13":"GA","15":"HI","16":"ID","17":"IL","18":"IN",
  "19":"IA","20":"KS","21":"KY","22":"LA","23":"ME","24":"MD","25":"MA",
  "26":"MI","27":"MN","28":"MS","29":"MO","30":"MT","31":"NE","32":"NV",
  "33":"NH","34":"NJ","35":"NM","36":"NY","37":"NC","38":"ND","39":"OH",
  "40":"OK","41":"OR","42":"PA","44":"RI","45":"SC","46":"SD","47":"TN",
  "48":"TX","49":"UT","50":"VT","51":"VA","53":"WA","54":"WV","55":"WI","56":"WY"
};

// â”€â”€ Entry point â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init(shellParams = {}) {
  const AFL = window.AFL;
  if (!AFL) { renderError('AFL shared library not loaded.'); return; }

  // Shell wraps navigation params inside shellParams.params
  // Direct navigate calls use shellParams directly
  const navParams = shellParams.params || shellParams || {};

  try {
    // Load funds if not yet loaded
    if (!AFL.state.funds || !AFL.state.funds.length) {
      await AFL.loadFunds();
    }
  } catch(e) {
    renderError('Could not load offering data. Check network connection.');
    return;
  }

  _allFunds = AFL.state.funds || [];
  if (!_allFunds.length) {
    renderError('No offering data found. Please refresh.');
    return;
  }

  _peers = AFL.peerStats(_allFunds);

  // basket.get() returns full fund objects for ids in basket
  const basketFunds = AFL.basket.get ? AFL.basket.get() : [];
  _funds = basketFunds.slice(0, 3);

  // Determine mode and active fund
  const reqId = navParams.id || navParams.fundId;
  const fromBasket = navParams.fromBasket;

  if (reqId) {
    _fundId = Number(reqId);
    _mode   = 'single';
  } else if (fromBasket && basketFunds.length > 1) {
    _mode   = 'portfolio';
  } else if (basketFunds.length > 1) {
    _mode   = 'portfolio';
  } else if (basketFunds.length === 1) {
    _fundId = basketFunds[0].id;
    _mode   = 'single';
  } else {
    // Default: first fund, single view
    _fundId = _allFunds[0].id;
    _mode   = 'single';
  }

  render();
}

// â”€â”€ Top-level render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render() {
  const AFL    = window.AFL;
  const basket = AFL.basket.get ? AFL.basket.get() : [];
  _funds       = basket.slice(0, 3);

  const root = document.getElementById('offering-module');
  if (_mode === 'portfolio') {
    root.innerHTML = renderPortfolioView();
    afterRenderPortfolio();
  } else {
    const fund = _allFunds.find(f => f.id === _fundId) || _allFunds[0];
    if (!fund) { renderError('Offering not found.'); return; }
    root.innerHTML = renderSingleView(fund);
    afterRenderSingle(fund);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SINGLE OFFERING VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderSingleView(f) {
  const AFL    = window.AFL;
  const client = AFL.state.client;
  const hasClient = !!(client && client.name);
  const basket = AFL.basket.get ? AFL.basket.get() : [];
  const inBasket = basket.some(b => b.id === f.id);
  const score  = hasClient ? AFL.suitScore(f, client) : null;
  const basketFunds = basket.slice(0,3);

  // Peer deltas
  const peerCoc = _peers.y1coc && _peers.y1coc.avg;
  const peerLtv = _peers.ltv && _peers.ltv.avg;
  const peerOcc = _peers.occupancy && _peers.occupancy.avg;

  const cocDelta = (f.y1coc != null && peerCoc) ? (f.y1coc - peerCoc) : null;
  const ltvDelta = (f.ltv  != null && peerLtv)  ? (f.ltv  - peerLtv)  : null;

  // Status badge
  const statusBadge = f.status === 'Closing Soon'
    ? `<span class="badge badge-closing">â— Closing Soon</span>`
    : f.status === 'Closed'
    ? `<span class="badge badge-closed">âœ• Closed</span>`
    : `<span class="badge badge-open">â— Open</span>`;

  // Valuation discount
  const discount = (f.purchasePrice && f.appraisedValue)
    ? ((f.purchasePrice - f.appraisedValue) / f.appraisedValue * 100).toFixed(1)
    : null;

  // Income years
  const incomeYears = (f.income || []).map((v,i) => ({yr: i+1, v})).filter(x => x.v != null && isFinite(x.v));
  const maxIncomeYr = incomeYears.length;

  // States
  const states = AFL.extractStates(f.location || '');

  // Basket button
  const basketBtn = inBasket
    ? `<button class="btn btn-added" onclick="window._afl_offering.removeBasket(${f.id})">âœ“ In Basket</button>`
    : `<button class="btn btn-primary" onclick="window._afl_offering.addBasket(${f.id})">ğŸ›’ Add to Basket</button>`;

  // Suit chip
  let suitChipHtml = '';
  if (hasClient && score !== null) {
    const cls = score >= 70 ? 'high' : score >= 45 ? 'medium' : 'low';
    suitChipHtml = `<div class="suit-chip ${cls}">â˜… ${score}% match â€” ${AFL.escapeHTML(client.name)}</div>`;
  } else {
    suitChipHtml = `<div class="suit-chip none" onclick="window._afl_offering.setClient()">+ Set up client for match score</div>`;
  }

  return `
<!-- â”€â”€ Mode Bar â”€â”€ -->
<div class="mode-bar">
  <div class="mode-toggle">
    <button class="mode-btn active" onclick="window._afl_offering.setMode('single')">
      <div class="dot" style="background:var(--o1)"></div>Single Offering
    </button>
    <button class="mode-btn ${basket.length > 1 ? '' : ''}" onclick="window._afl_offering.setMode('portfolio')">
      <div class="dot" style="background:var(--o2)"></div>Portfolio View
      ${basket.length > 0 ? `<span style="font-size:9px;background:var(--navy2);color:#fff;border-radius:10px;padding:1px 6px">${basket.length}</span>` : ''}
    </button>
  </div>
  <div class="breadcrumb">
    <a onclick="window.AFL.navigate('browse')">â† Browse</a> â€º
    <strong>${AFL.escapeHTML(f.name || 'Offering Detail')}</strong>
  </div>
  <div class="mode-right">
    <button onclick="window._afl_offering.shareTearSheet()">ğŸ“¤ Share Tear Sheet</button>
  </div>
</div>

<!-- â”€â”€ HERO â”€â”€ -->
<div class="hero">
  <div class="hero-inner">
    <!-- Left -->
    <div class="hero-left">
      <div>
        <div class="sponsor-row">
          <div class="sponsor-logo">${sponsorLogoHtml(f)}</div>
          <div>
            <div class="sponsor-name">${AFL.escapeHTML(f.sponsor || '')}</div>
            <div class="offering-name">${AFL.escapeHTML(f.name || 'Offering Detail')}</div>
            ${f.location ? `<div class="offering-location">ğŸ“ ${AFL.escapeHTML(f.location)}</div>` : ''}
          </div>
        </div>
      </div>
      <div class="hero-badges">
        ${statusBadge}
        ${f.assetClass ? `<span class="badge badge-prop">â—† ${AFL.escapeHTML(f.assetClass)}</span>` : ''}
        ${f.sector ? `<span class="badge badge-sector">â¬¡ ${AFL.escapeHTML(f.sector)}</span>` : ''}
        ${f.offeringStructure ? `<span class="badge badge-prop">${AFL.escapeHTML(f.offeringStructure)}</span>` : ''}
      </div>
    </div>
    <!-- Right: Map + Video -->
    <div class="hero-right">
      <div class="hero-panel" style="background:#0d1e36">
        <div class="hero-panel-lbl">ğŸ“ Property Location${states.length > 1 ? 's' : ''}</div>
        <div class="hero-panel-body" style="flex-direction:column">
          <svg id="us-map-single" viewBox="0 0 960 600" preserveAspectRatio="xMidYMid meet"></svg>
          ${states.length ? `<div class="map-legend">
            <div class="map-leg-item"><div class="map-leg-dot" style="background:var(--o1)"></div>${AFL.escapeHTML(f.location || '')}</div>
          </div>` : ''}
        </div>
      </div>
      <div class="hero-panel" style="background:#0a1628">
        <div class="hero-panel-lbl">ğŸ¬ Sponsor Video</div>
        <div class="hero-panel-body">
          ${f.videoUrl
            ? `<div class="video-single">
                <div class="video-play-btn" onclick="window.open('${f.videoUrl}','_blank')">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="rgba(255,255,255,0.7)"><polygon points="5,3 19,12 5,21"/></svg>
                </div>
                <div class="video-title">${AFL.escapeHTML(f.sponsor || '')}<br>Sponsor Overview<br><span style="font-size:9px;color:rgba(255,255,255,0.2)">Click to play</span></div>
              </div>`
            : `<div class="video-single">
                <div style="font-size:28px;opacity:.3">ğŸ¬</div>
                <div class="video-title" style="font-size:11px">No video available</div>
              </div>`
          }
        </div>
      </div>
    </div>
  </div>

  <!-- KPI Strip - Single -->
  <div class="kpi-strip kpi-strip-single">
    <div class="kpi">
      <div class="kpi-lbl">Loan to Value</div>
      <div class="kpi-val">${AFL.fmt.pct(f.ltv)}</div>
      <div class="kpi-sub">${ltvDelta !== null ? `<span class="${ltvDelta < 0 ? 'kpi-good' : 'kpi-bad'}">${ltvDelta < 0 ? 'â†“' : 'â†‘'} ${Math.abs(ltvDelta).toFixed(1)}% vs peers</span>` : '<span>vs platform avg</span>'}</div>
      ${f.ltv != null ? `<div class="kpi-bar"><div class="kpi-fill" style="width:${Math.min(100,f.ltv)}%;background:${f.ltv < 45 ? '#34D399' : '#FBBF24'}"></div></div>` : ''}
    </div>
    <div class="kpi">
      <div class="kpi-lbl">Y1 Cash on Cash</div>
      <div class="kpi-val">${AFL.fmt.pct(f.y1coc)}</div>
      <div class="kpi-sub">${cocDelta !== null ? `<span class="${cocDelta > 0 ? 'kpi-good' : 'kpi-bad'}">${cocDelta > 0 ? 'â†‘' : 'â†“'} ${Math.abs(cocDelta).toFixed(2)}% vs peers</span>` : '<span>vs platform avg</span>'}</div>
      ${f.y1coc != null ? `<div class="kpi-bar"><div class="kpi-fill" style="width:${Math.min(100,(f.y1coc/8)*100)}%;background:#3B82F6"></div></div>` : ''}
    </div>
    <div class="kpi">
      <div class="kpi-lbl">Occupancy</div>
      <div class="kpi-val">${AFL.fmt.pct(f.occupancy, 1)}</div>
      <div class="kpi-sub">${f.avgLeaseTerm ? `â—† ${AFL.fmt.num(f.avgLeaseTerm,1)} yr WALT` : '<span style="opacity:.5">â€”</span>'}</div>
    </div>
    <div class="kpi">
      <div class="kpi-lbl">Equity Remaining</div>
      <div class="kpi-val">${AFL.fmt.money(f.equityRemaining)}</div>
      <div class="kpi-sub">
        ${f.pctRemaining != null ? `<span class="${f.pctRemaining > 20 ? 'kpi-good' : 'kpi-bad'}">${f.pctRemaining.toFixed(0)}%</span>&nbsp;of ${AFL.fmt.money(f.filedRaise)} raise` : '<span>of total raise</span>'}
      </div>
      ${f.pctRemaining != null ? `<div class="kpi-bar"><div class="kpi-fill" style="width:${100-f.pctRemaining}%;background:${f.pctRemaining < 20 ? '#F87171' : '#FBBF24'}"></div></div>` : ''}
    </div>
  </div>
</div>

<!-- â”€â”€ DD Row â”€â”€ -->
${renderDDRow([f], false)}

<!-- â”€â”€ Action Bar â”€â”€ -->
<div class="action-bar">
  ${basketBtn}
  <button class="btn btn-secondary" onclick="window._afl_offering.setMode('portfolio')">ğŸ“ Portfolio View</button>
  <button class="btn btn-secondary" onclick="window._afl_offering.shareTearSheet()">ğŸ“¤ Share Tear Sheet</button>
  <button class="btn btn-secondary" onclick="window._afl_offering.modelForClient(${f.id})">ğŸ§® Model for Client</button>
  <div class="action-right">${suitChipHtml}</div>
</div>

<!-- â”€â”€ Analyst Zone â”€â”€ -->
<div class="analyst">

  <!-- Suitability + Raise Status -->
  <div style="display:grid;grid-template-columns:300px 1fr;gap:14px">
    ${renderSuitPanel(f, client, hasClient, score)}
    <!-- Raise Status -->
    <div class="panel">
      <div class="panel-title">ğŸ“Š Raise Status & Timeline</div>
      <div class="mg" style="grid-template-columns:repeat(4,1fr)">
        <div class="mt"><div class="mt-lbl">Total Raise</div><div class="mt-val" style="font-size:15px">${AFL.fmt.money(f.filedRaise)}</div></div>
        <div class="mt">
          <div class="mt-lbl">Equity Raised</div>
          <div class="mt-val" style="font-size:15px">${AFL.fmt.money(f.currentRaise)}</div>
          ${f.pctRemaining != null ? `<div class="mt-sub" style="color:var(--slate2)">${(100-f.pctRemaining).toFixed(0)}% of total</div>` : ''}
        </div>
        <div class="mt">
          <div class="mt-lbl">Remaining</div>
          <div class="mt-val" style="font-size:15px">${AFL.fmt.money(f.equityRemaining)}</div>
          ${f.pctRemaining != null ? `<div class="mt-sub"><span class="peer-chip ${f.pctRemaining > 20 ? 'g' : 'b'}">${f.pctRemaining.toFixed(0)}% open</span></div>` : ''}
        </div>
        <div class="mt">
          <div class="mt-lbl">Raise/Mo (est.)</div>
          <div class="mt-val" style="font-size:15px">${AFL.fmt.money(f.raiseVelocity)}</div>
        </div>
      </div>
      ${(f.offeringOpen || f.offeringClose) ? `
      <div style="margin-top:13px">
        <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:5px">
          <span style="font-weight:600;color:var(--navy)">${f.pctRemaining != null ? f.pctRemaining.toFixed(0)+'% Raise Term Remaining' : 'Raise Status'}</span>
          ${f.offeringClose ? `<span style="color:var(--slate2)">Closes ${AFL.fmt.date(f.offeringClose)}</span>` : ''}
        </div>
        <div class="pbar" style="height:9px;border-radius:5px">${f.pctRemaining != null ? `<div class="pfill" style="width:${(100-f.pctRemaining)}%;border-radius:5px;background:var(--amber)"></div>` : ''}</div>
        <div style="display:flex;justify-content:space-between;margin-top:7px;font-size:11px;color:var(--slate2)">
          ${f.offeringOpen ? `<span>Opened: <strong style="color:var(--navy)">${AFL.fmt.date(f.offeringOpen)}</strong></span>` : ''}
          ${f.offeringClose ? `<span>Est. Close: <strong style="color:var(--navy)">${AFL.fmt.date(f.offeringClose)}</strong></span>` : ''}
        </div>
      </div>` : ''}
    </div>
  </div>

  <!-- Valuation + Debt/Lease -->
  <div class="two-col">
    <div class="panel">
      <div class="panel-title">ğŸ·ï¸ Purchase Price & Valuation</div>
      ${discount !== null ? `
      <div class="valuation-highlight">
        <div class="valuation-pct">${Number(discount) < 0 ? discount+'%' : '+'+discount+'%'}</div>
        <div style="font-size:12px;color:${Number(discount) < 0 ? 'var(--green)' : 'var(--amber)'}">
          ${Number(discount) < 0 ? 'Purchased below appraised value â€” built-in equity at close' : 'Purchased above appraised value'}
        </div>
      </div>` : ''}
      <div class="mg" style="grid-template-columns:1fr 1fr 1fr;gap:9px">
        <div class="mt"><div class="mt-lbl">Purchase Price</div><div class="mt-val" style="font-size:15px">${AFL.fmt.money(f.purchasePrice)}</div></div>
        <div class="mt"><div class="mt-lbl">Appraised Value</div><div class="mt-val" style="font-size:15px">${AFL.fmt.money(f.appraisedValue)}</div></div>
        <div class="mt"><div class="mt-lbl">Loaded Price</div><div class="mt-val" style="font-size:15px">${AFL.fmt.money(f.loadedPrice)}</div></div>
      </div>
      <div class="pp-inline">
        ${f.sqft ? `<span>Total SF: <strong>${AFL.fmt.num(f.sqft)}</strong></span>` : ''}
        ${f.numAssets ? `<span>Properties: <strong>${f.numAssets}</strong></span>` : ''}
        ${f.capRate ? `<span>Cap Rate: <strong>${AFL.fmt.pct(f.capRate)}</strong></span>` : ''}
        ${f.gpCommit ? `<span>GP Commit: <strong>${AFL.fmt.pct(f.gpCommit)}</strong></span>` : ''}
      </div>
    </div>
    <div class="panel">
      <div class="panel-title">ğŸ¦ Debt & Lease Terms</div>
      <div class="mg" style="grid-template-columns:1fr 1fr;gap:9px">
        <div class="mt">
          <div class="mt-lbl">LTV</div>
          <div class="mt-val">${AFL.fmt.pct(f.ltv)}</div>
          ${ltvDelta !== null ? `<div class="mt-sub"><span class="peer-chip ${ltvDelta < 0 ? 'g' : 'b'}">${ltvDelta < 0 ? 'â†“' : 'â†‘'} ${Math.abs(ltvDelta).toFixed(1)}% vs avg</span></div>` : ''}
        </div>
        <div class="mt"><div class="mt-lbl">DSCR</div><div class="mt-val">${f.dscr != null ? AFL.fmt.num(f.dscr,1)+'x' : 'â€”'}</div></div>
        <div class="mt">
          <div class="mt-lbl">Avg Lease Term</div>
          <div class="mt-val">${f.avgLeaseTerm ? AFL.fmt.num(f.avgLeaseTerm,1)+' yr' : 'â€”'}</div>
        </div>
        <div class="mt">
          <div class="mt-lbl">Occupancy</div>
          <div class="mt-val">${AFL.fmt.pct(f.occupancy,1)}</div>
          ${f.occupancy >= 98 ? `<div class="mt-sub"><span class="peer-chip g">Fully leased</span></div>` : ''}
        </div>
        ${(f.tenantCredit || f.leaseTerms) ? `<div class="mt" style="grid-column:1/-1">
          <div class="mt-lbl">Lease Type Â· Tenant Credit</div>
          <div style="font-size:13px;font-weight:600;color:var(--navy);margin-top:3px">${[f.leaseTerms, f.tenantCredit].filter(Boolean).map(v=>AFL.escapeHTML(v)).join(' Â· ')}</div>
        </div>` : ''}
      </div>
    </div>
  </div>

  <!-- Key Drivers -->
  <div class="panel">
    <div class="panel-title">âš¡ Key Drivers</div>
    <div class="kd-grid" id="kd-grid-single">
      ${renderKeyDrivers(f)}
    </div>
  </div>

  <!-- Distribution Chart + Projection Table -->
  ${maxIncomeYr > 0 ? `
  <div class="panel">
    <div class="panel-title">ğŸ“ˆ Projected Annual Distributions</div>
    <div class="chart-wrap"><canvas id="distChart"></canvas></div>
  </div>
  <div class="panel">
    <div class="panel-title">ğŸ“Š Distribution Projections</div>
    <div style="overflow-x:auto">
      <table class="proj-table">
        <thead><tr>
          <th style="text-align:left">Metric</th>
          ${incomeYears.map((x,i) => `<th ${i===0?'class="hl"':''}>Year ${x.yr}</th>`).join('')}
        </tr></thead>
        <tbody>
          <tr>
            <td>CoC Return</td>
            ${incomeYears.map((x,i) => `<td ${i===0?'class="hl"':''}>${AFL.fmt.pct(x.v)}</td>`).join('')}
          </tr>
          ${hasClient && client.exchangeAmount ? `
          <tr>
            <td>Est. Distribution <span style="font-size:10px;color:var(--slate2)">(${AFL.fmt.money(client.exchangeAmount)} equity)</span></td>
            ${incomeYears.map((x,i) => `<td ${i===0?'class="hl"':''}>$${AFL.fmt.num(x.v/100*client.exchangeAmount)}</td>`).join('')}
          </tr>
          <tr>
            <td>Cumulative</td>
            ${incomeYears.map((x,i) => {
              const cum = incomeYears.slice(0,i+1).reduce((s,y)=>s+(y.v/100*client.exchangeAmount),0);
              return `<td ${i===0?'class="hl"':''}>$${AFL.fmt.num(cum)}</td>`;
            }).join('')}
          </tr>` : `
          <tr>
            <td colspan="${incomeYears.length+1}" style="text-align:center;color:var(--slate2);font-size:12px;padding:10px">
              <a href="#" style="color:var(--blue)" onclick="window._afl_offering.setClient();return false">Set up a client profile</a> to see estimated dollar distributions.
            </td>
          </tr>`}
        </tbody>
      </table>
    </div>
  </div>` : ''}

  <!-- AI Narrative -->
  ${renderAiNarrative(f)}

  <!-- Property & Market + Financial Structure -->
  <div class="two-col">
    <div class="panel">
      <div class="panel-title">ğŸ¢ Property & Market</div>
      <div class="narr">${renderPropertyNarrative(f)}</div>
    </div>
    <div class="panel">
      <div class="panel-title">ğŸ’° Financial Structure</div>
      <div class="narr">${renderFinanceNarrative(f)}</div>
    </div>
  </div>

  <!-- Offering Details + Property/Debt data rows -->
  <div class="two-col">
    <div class="panel">
      <div class="panel-title">ğŸ“‹ Offering Details</div>
      ${renderDataRows([
        ['Asset Class', AFL.fmt.str(f.assetClass)],
        ['Sector', AFL.fmt.str(f.sector)],
        ['Focus', AFL.fmt.str(f.focus)],
        ['Location', AFL.fmt.str(f.location)],
        ['Structure', AFL.fmt.str(f.offeringStructure)],
        ['Exemption', AFL.fmt.str(f.exemption)],
        ['Tax Reporting', AFL.fmt.str(f.taxReporting)],
        ['721 UpREIT', AFL.fmt.str(f.upReit)],
        ['Hold Period', f.holdPeriod ? AFL.fmt.num(f.holdPeriod)+' yr' : 'â€”'],
        ['Distribution Freq.', AFL.fmt.str(f.distFrequency)],
        ['Rep Comp', AFL.fmt.pct(f.repComp)],
        ['Sales Load', AFL.fmt.pct(f.salesLoad)],
        ['Min. Investment', AFL.fmt.money(f.minInvest)],
      ])}
    </div>
    <div class="panel">
      <div class="panel-title">ğŸ—ï¸ Property & Debt</div>
      ${renderDataRows([
        ['# Assets', AFL.fmt.str(f.numAssets)],
        ['Building Age', AFL.fmt.str(f.buildingAge)],
        ['Total Sq Ft', f.sqft ? AFL.fmt.num(f.sqft) : 'â€”'],
        ['Tenant Credit', AFL.fmt.str(f.tenantCredit)],
        ['Avg Lease Remaining', f.avgLeaseTerm ? AFL.fmt.num(f.avgLeaseTerm,1)+' yr' : 'â€”'],
        ['Rent Escalations', AFL.fmt.str(f.rentEscalations)],
        ['Debt Terms', AFL.fmt.str(f.debtTerms)],
        ['DSCR', f.dscr ? AFL.fmt.num(f.dscr,1)+'x' : 'â€”'],
        ['Purchase Price', AFL.fmt.money(f.purchasePrice)],
        ['Appraised Value', AFL.fmt.money(f.appraisedValue)],
        ['Loaded Price', AFL.fmt.money(f.loadedPrice)],
        ['GP Commit', AFL.fmt.pct(f.gpCommit)],
        ['Reserve', AFL.fmt.str(f.reserve)],
      ])}
    </div>
  </div>

  <!-- Sponsor Track Record -->
  <div class="panel">
    <div class="panel-title" style="cursor:pointer" onclick="window.AFL.navigate('sponsor',{name:'${AFL.escapeHTML(f.sponsor||'')}'})" title="View sponsor profile">
      ğŸ›ï¸ Sponsor Track Record â€” ${AFL.escapeHTML(f.sponsor || '')} <span style="font-size:10px;color:var(--blue);margin-left:4px">View â†’</span>
    </div>
    <div style="display:flex;align-items:flex-start;gap:14px">
      <div style="flex-shrink:0">
        <div class="sp-banner-logo">${sponsorLogoHtml(f)}</div>
      </div>
      <div style="flex:1">
        <div style="font-size:15px;font-weight:700;color:var(--navy);margin-bottom:2px">${AFL.escapeHTML(f.sponsor || '')}</div>
        ${f.sponsorExperience ? `<div style="font-size:12px;color:var(--slate2);margin-bottom:8px">${AFL.escapeHTML(f.sponsorExperience)}</div>` : ''}
        <div class="mg" style="grid-template-columns:repeat(4,1fr);gap:9px">
          <div class="mt"><div class="mt-lbl">AUM</div><div class="mt-val" style="font-size:15px">${AFL.fmt.money(f.sponsorAum)}</div></div>
          <div class="mt"><div class="mt-lbl">Offerings</div><div class="mt-val" style="font-size:15px">${f.sponsorOfferings != null ? AFL.fmt.num(f.sponsorOfferings) : 'â€”'}</div></div>
          <div class="mt"><div class="mt-lbl">Full Cycle Exits</div><div class="mt-val" style="font-size:15px">${f.sponsorExits != null ? AFL.fmt.num(f.sponsorExits) : 'â€”'}</div></div>
          <div class="mt"><div class="mt-lbl">Avg IRR</div><div class="mt-val" style="font-size:15px">${AFL.fmt.pct(f.sponsorAvgIrr)}</div></div>
        </div>
        ${(f.sponsorBestIrr || f.sponsorWorstIrr) ? `
        <div style="display:flex;gap:10px;margin-top:9px">
          ${f.sponsorBestIrr ? `<div style="flex:1;padding:8px 12px;background:var(--green-lt);border:1px solid #BBF7D0;border-radius:var(--radius);font-size:12px"><span style="color:var(--slate2)">Best IRR</span><br><strong style="color:var(--green);font-size:16px">${AFL.fmt.pct(f.sponsorBestIrr)}</strong></div>` : ''}
          ${f.sponsorWorstIrr ? `<div style="flex:1;padding:8px 12px;background:var(--surface);border:1px solid var(--mist);border-radius:var(--radius);font-size:12px"><span style="color:var(--slate2)">Worst IRR</span><br><strong style="color:var(--navy);font-size:16px">${AFL.fmt.pct(f.sponsorWorstIrr)}</strong></div>` : ''}
        </div>` : ''}
      </div>
    </div>
  </div>

</div><!-- /analyst -->
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PORTFOLIO VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderPortfolioView() {
  const AFL    = window.AFL;
  const client = AFL.state.client;
  const hasClient = !!(client && client.name);
  const basket = AFL.basket.get ? AFL.basket.get() : [];
  _funds = basket.slice(0,3);

  if (_funds.length === 0) {
    return `
${renderModeBar(true)}
<div class="empty-basket">
  <div style="font-size:36px">ğŸ›’</div>
  <h3>Your basket is empty</h3>
  <p style="font-size:13px;color:var(--slate2)">Add offerings to your basket to build a portfolio comparison.</p>
  <button class="btn btn-primary" onclick="window.AFL.navigate('browse')">Browse Offerings</button>
</div>`;
  }

  // Compute blended metrics (equal weight for now)
  const n = _funds.length;
  const blendedCoc = _funds.reduce((s,f) => s + (f.y1coc || 0), 0) / n;
  const blendedLtv = _funds.reduce((s,f) => s + (f.ltv || 0), 0) / n;
  const blendedOcc = _funds.reduce((s,f) => s + (f.occupancy || 0), 0) / n;
  const totalMin   = _funds.reduce((s,f) => s + (f.minInvest || 0), 0);
  const avgHold    = _funds.reduce((s,f) => s + (f.holdPeriod || 0), 0) / n;

  const peerCoc = _peers.y1coc && _peers.y1coc.avg;
  const peerLtv = _peers.ltv   && _peers.ltv.avg;

  // Suitability
  const scores = _funds.map(f => hasClient ? AFL.suitScore(f, client) : null);
  const avgScore = scores.every(s => s !== null) ? Math.round(scores.reduce((a,b)=>a+b,0)/scores.length) : null;

  // Suit chips for action bar
  const suitMinis = scores.map((s,i) => s !== null
    ? `<div class="suit-mini suit-mini-${i+1}">${'â‘ â‘¡â‘¢'[i]} ${s}%</div>` : '').join('');
  const mainSuitChip = avgScore !== null
    ? `<div class="suit-chip high">â˜… ${avgScore}% avg â€” ${AFL.escapeHTML(client.name)}</div>`
    : `<div class="suit-chip none" onclick="window._afl_offering.setClient()">+ Set up client</div>`;

  // Sponsor logos for hero
  const sponsorLogos = _funds.map((f,i) =>
    `<div class="sp-logo-sm" style="border:2px solid ${O_HEX[i]}">${sponsorLogoHtml(f)}</div>`
  ).join(`<div style="width:8px;height:2px;background:rgba(255,255,255,0.15);align-self:center"></div>`);

  // Offering pills
  const offeringPills = _funds.map((f,i) => `
    <div class="o-row">
      <span class="o-pill ${O_CLASSES[i]}"><span class="o-dot ${O_DOT[i]}">${i+1}</span>${AFL.escapeHTML(f.name||'Offering '+(i+1))}</span>
      <span class="o-alloc-pct">${Math.round(100/n)}%</span>
    </div>`).join('');

  // States for map
  const stateMap = {}; // state â†’ offering index
  _funds.forEach((f,i) => {
    AFL.extractStates(f.location || '').forEach(s => {
      stateMap[s] = i; // last wins for overlap
    });
  });

  // Map legend
  const mapLegend = _funds.map((f,i) => `
    <div class="map-leg-item">
      <div class="map-leg-dot" style="background:${O_HEX[i]}"></div>
      ${'â‘ â‘¡â‘¢'[i]} ${AFL.escapeHTML(f.name||'')} (${AFL.extractStates(f.location||'').join(', ')||'â€”'})
    </div>`).join('');

  // Video rows
  const videoRows = _funds.map((f,i) => f.videoUrl
    ? `<div class="video-row" onclick="window.open('${f.videoUrl}','_blank')">
        <div class="video-row-play" style="background:rgba(${i===0?'59,130,246':i===1?'124,58,237':'217,119,6'},.2);border:1.5px solid rgba(${i===0?'59,130,246':i===1?'124,58,237':'217,119,6'},.4)">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="${O_HEX[i]}"><polygon points="5,3 19,12 5,21"/></svg>
        </div>
        <div><div class="video-row-name">${AFL.escapeHTML(f.name||'')}</div><div class="video-row-meta">${AFL.escapeHTML(f.sponsor||'')} Â· Click to play</div></div>
        <div class="video-row-play-lbl" style="color:${O_HEX[i]}">PLAY</div>
      </div>`
    : `<div class="video-row unavail">
        <div class="video-row-play" style="background:rgba(255,255,255,0.05);border:1.5px solid rgba(255,255,255,0.1)">
          <svg width="10" height="10" viewBox="0 0 24 24" fill="rgba(255,255,255,0.3)"><polygon points="5,3 19,12 5,21"/></svg>
        </div>
        <div><div class="video-row-name" style="color:rgba(255,255,255,0.4)">${AFL.escapeHTML(f.name||'')}</div><div class="video-row-meta">No video available</div></div>
      </div>`
  ).join('');

  // Comparison table rows
  const metrics = [
    {lbl:'Y1 CoC',    vals: _funds.map(f=>AFL.fmt.pct(f.y1coc)),    blend: AFL.fmt.pct(blendedCoc),   peer: peerCoc ? AFL.fmt.pct(peerCoc) : 'â€”', best:'high'},
    {lbl:'LTV',       vals: _funds.map(f=>AFL.fmt.pct(f.ltv)),       blend: AFL.fmt.pct(blendedLtv),   peer: peerLtv ? AFL.fmt.pct(peerLtv) : 'â€”', best:'low'},
    {lbl:'Occupancy', vals: _funds.map(f=>AFL.fmt.pct(f.occupancy,1)),blend:AFL.fmt.pct(blendedOcc,1), peer:'â€”', best:'high'},
    {lbl:'DSCR',      vals: _funds.map(f=>f.dscr ? AFL.fmt.num(f.dscr,1)+'x':'â€”'), blend:'â€”', peer:'â€”', best:'high'},
    {lbl:'Avg Lease', vals: _funds.map(f=>f.avgLeaseTerm ? AFL.fmt.num(f.avgLeaseTerm,1)+' yr':'â€”'), blend:'â€”', peer:'â€”', best:'high'},
    {lbl:'Hold Period',vals: _funds.map(f=>f.holdPeriod ? AFL.fmt.num(f.holdPeriod)+' yr':'â€”'), blend:AFL.fmt.num(avgHold,1)+' yr', peer:'â€”', best:'low'},
    {lbl:'Min Invest', vals: _funds.map(f=>AFL.fmt.money(f.minInvest)), blend:AFL.fmt.money(totalMin)+' total', peer:'â€”', best:'low'},
    {lbl:'Property Type', vals:_funds.map(f=>`<span class="peer-chip n">${AFL.escapeHTML(f.sector||'â€”')}</span>`), blend:'<span style="font-size:11px">Diversified</span>', peer:'â€”', best:null},
    ...(avgScore !== null ? [{lbl:'Suitability', vals: scores.map((s,i) => s >= 70 ? `<span class="peer-chip g">â˜… ${s}%</span>` : s >= 45 ? `<span class="peer-chip a">â—† ${s}%</span>` : `<span class="peer-chip b">âœ• ${s}%</span>`), blend:`<span style="color:var(--green);font-weight:700">â˜… ${avgScore}% avg</span>`, peer:'â€”', best:null}] : []),
  ];

  // Raise cards
  const raiseCards = _funds.map((f,i) => `
    <div class="raise-card">
      <div class="raise-card-header">
        <div class="o-dot ${O_DOT[i]}" style="width:20px;height:20px;font-size:11px">${i+1}</div>
        <div><div class="raise-card-title">${AFL.escapeHTML(f.name||'')}</div><div class="raise-card-sponsor">${AFL.escapeHTML(f.sponsor||'')}</div></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px">
        <span style="color:var(--slate2)">${AFL.fmt.money(f.currentRaise)} raised of ${AFL.fmt.money(f.filedRaise)}</span>
        ${f.pctRemaining != null ? `<span style="font-weight:700;color:${O_HEX[i]}">${f.pctRemaining.toFixed(0)}% open</span>` : ''}
      </div>
      <div class="pbar"><div class="pfill" style="width:${f.pctRemaining != null ? (100-f.pctRemaining).toFixed(0) : 0}%;background:${O_HEX[i]}"></div></div>
      <div style="font-size:11px;color:var(--slate2);margin-top:5px">
        ${f.offeringClose ? `Closes ${AFL.fmt.date(f.offeringClose)}` : ''}
        ${f.raiseVelocity ? ` Â· ${AFL.fmt.money(f.raiseVelocity)}/mo` : ''}
      </div>
    </div>`).join('');

  // Sponsor banners
  const sponsorBanners = _funds.map((f,i) => `
    <div class="sp-banner" style="border-color:${i===0?'var(--o1-mid)':i===1?'var(--o2-mid)':'var(--o3-mid)'}">
      <div class="sp-banner-logo" style="border-color:${i===0?'var(--o1-mid)':i===1?'var(--o2-mid)':'var(--o3-mid)'}">${sponsorLogoHtml(f)}</div>
      <div style="font-size:13px;font-weight:700;color:var(--navy)">${AFL.escapeHTML(f.sponsor||'')}</div>
      <div style="font-size:11.5px;color:var(--slate2);margin-top:2px">
        ${f.sponsorOfferings ? f.sponsorOfferings+' offerings' : ''}
        ${f.sponsorAum ? ' Â· '+AFL.fmt.money(f.sponsorAum)+' AUM' : ''}
      </div>
      <div class="sp-chips">
        ${f.sponsorExits ? `<span class="peer-chip g">${f.sponsorExits} full-cycle exits</span>` : ''}
        ${f.sponsorAvgIrr ? `<span class="peer-chip n">${AFL.fmt.pct(f.sponsorAvgIrr)} avg IRR</span>` : ''}
      </div>
    </div>`).join('');

  return `
${renderModeBar(true)}

<!-- â”€â”€ HERO â”€â”€ -->
<div class="hero">
  <div class="hero-inner">
    <!-- Left -->
    <div class="hero-left">
      <div>
        <div class="portfolio-logos">
          ${sponsorLogos}
          <div style="margin-left:8px;font-size:10.5px;color:rgba(255,255,255,0.3)">${n} sponsor${n>1?'s':''} Â· ${n} offering${n>1?'s':''}</div>
        </div>
        <div class="portfolio-title">${n}-Offering Blended Portfolio</div>
        ${hasClient && client.name ? `<div class="portfolio-subtitle">${AFL.escapeHTML(client.name)}${client.exchangeAmount ? ' Â· '+AFL.fmt.money(client.exchangeAmount)+' exchange' : ''}</div>` : ''}
        <div class="o-offerings-list">${offeringPills}</div>
      </div>
      <div class="alloc-bar-wrap">
        <div class="alloc-bar-lbl">Portfolio Allocation${hasClient && client.exchangeAmount ? ' â€” '+AFL.fmt.money(client.exchangeAmount) : ''}</div>
        <div class="alloc-bar">
          ${_funds.map((f,i) => `<div class="alloc-seg" style="width:${(100/n).toFixed(1)}%;background:${O_HEX[i]}"></div>`).join('')}
        </div>
        <div class="alloc-labels">
          ${_funds.map((f,i) => `<span style="color:${O_HEX[i]};font-size:10px">${AFL.fmt.money(hasClient && client.exchangeAmount ? client.exchangeAmount/n : f.minInvest)} Â· ${AFL.escapeHTML(f.sector||'')}</span>`).join('')}
        </div>
      </div>
      <div class="hero-badges">
        ${_funds.every(f=>f.status==='Open') ? `<span class="badge badge-open">â— All Open</span>` : ''}
        ${[...new Set(_funds.map(f=>f.sector).filter(Boolean))].map(s=>`<span class="badge badge-prop">â—† ${AFL.escapeHTML(s)}</span>`).join('')}
      </div>
    </div>
    <!-- Right: Map + Videos -->
    <div class="hero-right">
      <div class="hero-panel" style="background:#0d1e36">
        <div class="hero-panel-lbl">ğŸ“ Combined Property Locations</div>
        <div class="hero-panel-body" style="flex-direction:column">
          <svg id="us-map-portfolio" viewBox="0 0 960 600" preserveAspectRatio="xMidYMid meet"></svg>
          <div class="map-legend">${mapLegend}</div>
        </div>
      </div>
      <div class="hero-panel">
        <div class="hero-panel-lbl">ğŸ¬ Sponsor Videos</div>
        <div class="hero-panel-body" style="align-items:stretch">
          <div class="video-portfolio">${videoRows}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- KPI Strip - Portfolio blended -->
  <div class="kpi-strip kpi-strip-portfolio">
    <div class="kpi">
      <div class="kpi-lbl">Blended LTV <span>wtd avg</span></div>
      <div class="kpi-val">${AFL.fmt.pct(blendedLtv)}</div>
      <div class="kpi-sub">${peerLtv ? `<span class="${blendedLtv < peerLtv ? 'kpi-good':'kpi-bad'}">${blendedLtv < peerLtv ? 'â†“':'â†‘'} ${Math.abs(blendedLtv-peerLtv).toFixed(1)}% vs peers</span>` : ''}</div>
      <div class="kpi-breakdown">${_funds.map((f,i)=>`<div class="kpi-bd-item"><div class="kpi-bd-dot" style="background:${O_HEX[i]}"></div>${AFL.fmt.pct(f.ltv)}</div>`).join('')}</div>
      <div class="kpi-bar"><div class="kpi-fill" style="width:${Math.min(100,blendedLtv)}%;background:#34D399"></div></div>
    </div>
    <div class="kpi">
      <div class="kpi-lbl">Blended Y1 CoC <span>wtd avg</span></div>
      <div class="kpi-val">${AFL.fmt.pct(blendedCoc)}</div>
      <div class="kpi-sub">${peerCoc ? `<span class="${blendedCoc > peerCoc ? 'kpi-good':'kpi-bad'}">${blendedCoc > peerCoc ? 'â†‘':'â†“'} ${Math.abs(blendedCoc-peerCoc).toFixed(2)}% vs peers</span>` : ''}</div>
      <div class="kpi-breakdown">${_funds.map((f,i)=>`<div class="kpi-bd-item"><div class="kpi-bd-dot" style="background:${O_HEX[i]}"></div>${AFL.fmt.pct(f.y1coc)}</div>`).join('')}</div>
      <div class="kpi-bar"><div class="kpi-fill" style="width:${Math.min(100,(blendedCoc/8)*100)}%;background:#3B82F6"></div></div>
    </div>
    <div class="kpi">
      <div class="kpi-lbl">Combined Min. Invest</div>
      <div class="kpi-val">${AFL.fmt.money(totalMin)}</div>
      <div class="kpi-sub">${hasClient && client.exchangeAmount ? `<span style="color:rgba(255,255,255,.4)">of ${AFL.fmt.money(client.exchangeAmount)} â€”</span> <span class="kpi-good">${((totalMin/client.exchangeAmount)*100).toFixed(0)}%</span>` : ''}</div>
      <div class="kpi-breakdown">${_funds.map((f,i)=>`<div class="kpi-bd-item"><div class="kpi-bd-dot" style="background:${O_HEX[i]}"></div>${AFL.fmt.money(f.minInvest)}</div>`).join('')}</div>
    </div>
    <div class="kpi">
      <div class="kpi-lbl">Blended Hold Period</div>
      <div class="kpi-val">${AFL.fmt.num(avgHold,1)} yr</div>
      <div class="kpi-sub">${hasClient && client.horizon ? `vs client horizon: ${client.horizon}yr` : ''}</div>
      <div class="kpi-breakdown">${_funds.map((f,i)=>`<div class="kpi-bd-item"><div class="kpi-bd-dot" style="background:${O_HEX[i]}"></div>${f.holdPeriod ? f.holdPeriod+'yr' : 'â€”'}</div>`).join('')}</div>
    </div>
  </div>
</div>

<!-- â”€â”€ DD Row â”€â”€ -->
${renderDDRow(_funds, true)}

<!-- â”€â”€ Action Bar â”€â”€ -->
<div class="action-bar">
  <button class="btn btn-primary" onclick="window.AFL.navigate('builder')">ğŸ“ Build Portfolio</button>
  <button class="btn btn-secondary" onclick="window._afl_offering.sharePortfolio()">ğŸ“¤ Share Portfolio Tear Sheet</button>
  <button class="btn btn-secondary" onclick="window.AFL.navigate('model')">ğŸ§® Model All for Client</button>
  <button class="btn btn-danger" onclick="window._afl_offering.clearBasket()">âœ• Clear Portfolio</button>
  <div class="action-right">
    <span style="font-size:11.5px;color:var(--slate2)">Blended match:</span>
    ${mainSuitChip}
    ${suitMinis}
  </div>
</div>

<!-- â”€â”€ Analyst Zone â”€â”€ -->
<div class="analyst">

  <!-- Blended Suitability -->
  <div class="panel suit-panel-blend">
    ${renderPortfolioSuitPanel(_funds, client, hasClient, scores, avgScore)}
  </div>

  <!-- Side-by-Side Comparison + Peers -->
  <div class="panel">
    <div class="panel-title">ğŸ“Š Side-by-Side Metrics + Peer Comparison</div>
    <div style="overflow-x:auto">
      <table class="comp-table">
        <thead><tr>
          <th>Metric</th>
          ${_funds.map((f,i) => `<th class="th${i+1}">${'â‘ â‘¡â‘¢'[i]} ${AFL.escapeHTML(f.name ? (f.name.length>22?f.name.slice(0,20)+'â€¦':f.name) : '')}</th>`).join('')}
          <th class="thb">âŠ• Blended</th>
          <th class="thp">Peer Avg</th>
        </tr></thead>
        <tbody>
          ${metrics.map(row => `
          <tr>
            <td>${row.lbl}</td>
            ${row.vals.map((v,i) => `<td${row.best ? ` class="${isBest(row.vals, i, row.best) ? 'best' : ''}"` : ''}>${v}</td>`).join('')}
            <td class="tdb">${row.blend}</td>
            <td>${row.peer}</td>
          </tr>`).join('')}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Individual Raise Status -->
  <div class="panel">
    <div class="panel-title">ğŸ“Š Raise Status â€” All ${n} Offerings</div>
    <div class="raise-cards">${raiseCards}</div>
  </div>

  <!-- Blended Distribution Chart -->
  <div class="panel">
    <div class="panel-title">ğŸ“ˆ Blended Projected Annual Distributions</div>
    <div class="chart-wrap"><canvas id="distChart"></canvas></div>
  </div>

  <!-- Blended Projection Table -->
  ${hasClient && client.exchangeAmount ? renderPortfolioProjectionTable(_funds, client.exchangeAmount) : ''}

  <!-- Portfolio Key Drivers -->
  <div class="panel">
    <div class="panel-title">âš¡ Portfolio Key Drivers</div>
    <div class="kd-grid">${renderPortfolioKeyDrivers(_funds, blendedCoc, blendedLtv, peerCoc, hasClient, client)}</div>
  </div>

  <!-- Sponsor Track Records -->
  <div class="panel">
    <div class="panel-title">ğŸ›ï¸ Sponsor Track Records</div>
    <div class="sp-banners">${sponsorBanners}</div>
  </div>

</div><!-- /analyst -->
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHARED RENDER HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderModeBar(isPortfolio) {
  const AFL = window.AFL;
  const basket = AFL.basket.get ? AFL.basket.get() : [];
  const breadcrumb = isPortfolio
    ? `<a onclick="window.AFL.navigate('browse')">Browse</a> â€º <strong>${basket.length}-Offering Blended Portfolio</strong>`
    : `<a onclick="window.AFL.navigate('browse')">â† Browse</a>`;
  return `
<div class="mode-bar">
  <div class="mode-toggle">
    <button class="mode-btn ${!isPortfolio ? 'active' : ''}" onclick="window._afl_offering.setMode('single')">
      <div class="dot" style="background:var(--o1)"></div>Single Offering
    </button>
    <button class="mode-btn ${isPortfolio ? 'active' : ''}" onclick="window._afl_offering.setMode('portfolio')">
      <div class="dot" style="background:var(--o2)"></div>Portfolio View
      ${basket.length > 0 ? `<span style="font-size:9px;background:var(--navy2);color:#fff;border-radius:10px;padding:1px 6px;margin-left:2px">${basket.length}</span>` : ''}
    </button>
  </div>
  <div class="breadcrumb">${breadcrumb}
    ${isPortfolio && AFL.state.client && AFL.state.client.name ? `<span style="color:var(--slate2);font-size:11px">Â· ${AFL.escapeHTML(AFL.state.client.name)}${AFL.state.client.exchangeAmount?' Â· '+AFL.fmt.money(AFL.state.client.exchangeAmount)+' exchange':''}</span>` : ''}
  </div>
  <div class="mode-right">
    <button onclick="window._afl_offering.setMode(${isPortfolio ? "'single'" : "'portfolio'"})">
      ${isPortfolio ? 'â† Back to Single' : 'ğŸ“Š Portfolio View'}
    </button>
    <button onclick="window._afl_offering.${isPortfolio ? 'sharePortfolio' : 'shareTearSheet'}()">
      ğŸ“¤ ${isPortfolio ? 'Share Portfolio' : 'Share Tear Sheet'}
    </button>
  </div>
</div>`;
}

function renderDDRow(funds, isPortfolio) {
  const AFL = window.AFL;
  const F = funds; // array

  function ddBtn(icon, iconClass, label1, label2, items, hasAny) {
    const disabled = !hasAny && !isPortfolio;
    const dropItems = isPortfolio ? items.map((item,i) => {
      if (!item.url) return `<div class="dd-item na"><div class="dd-item-dot" style="background:var(--fog)"></div><div><div class="dd-item-name">${AFL.escapeHTML(item.name)}</div><div class="dd-item-meta">Not available</div></div></div>`;
      return `<div class="dd-divider" style="${i===0?'display:none':''}"></div><a class="dd-item" href="${item.url}" target="_blank" rel="noopener"><div class="dd-item-dot" style="background:${O_HEX[i]}"></div><div><div class="dd-item-name">${AFL.escapeHTML(item.name)}</div><div class="dd-item-meta">${AFL.escapeHTML(item.meta||'')}</div></div></a>`;
    }).join('') : '';

    const singleUrl = !isPortfolio && items[0] && items[0].url;

    return `
    <div class="dd-wrap">
      <div class="dd-btn${disabled ? ' off' : ''}" ${singleUrl ? `onclick="window.open('${singleUrl}','_blank')"` : ''}>
        <div class="dd-ico ${iconClass}">${icon}</div>
        <div class="dd-lbl">${label1}${label2 ? '<br>'+label2 : ''}</div>
      </div>
      ${isPortfolio ? `<div class="dd-drop">${dropItems}</div>` : ''}
    </div>`;
  }

  const execItems  = F.map((f,i) => ({name:f.name||'',meta:f.sponsor||'',url:f.brochureUrl}));
  const aiItems    = F.map((f,i) => ({name:f.name||'',meta:'Ask about structure & risks',url:f.aiChatUrl}));
  const ppmItems   = F.map((f,i) => ({name:f.name||'',meta:'Private Placement Memo',url:f.ppmUrl}));
  const raiseItems = F.map((f,i) => ({name:f.name||'',meta:f.raiseVelocity?AFL.fmt.money(f.raiseVelocity)+'/mo':'',url:'#'}));
  const newsItems  = F.map((f,i) => ({name:f.sponsor||'',meta:'',url:f.sponsorNewsUrl}));
  const trackItems = F.map((f,i) => ({name:f.sponsor||'',meta:f.sponsorOfferings?f.sponsorOfferings+' offerings'+(f.sponsorExits?' Â· '+f.sponsorExits+' exits':''):'',url:f.trackRecordUrl}));
  const teamItems  = F.map((f,i) => ({name:f.sponsor||'',meta:'Contact info & directory',url:f.salesTeamUrl}));
  const videoItems = F.map((f,i) => ({name:f.name||'',meta:f.videoUrl?'Sponsor overview':'No video available',url:f.videoUrl}));
  const updateItems= F.map((f,i) => ({name:f.name||'',meta:'Quarterly update',url:f.quarterlyUpdateUrl}));

  return `
<div class="dd-row">
  <div class="dd-grp">
    <div class="dd-grp-lbl">Offering Due Diligence</div>
    <div class="dd-icons">
      ${ddBtn('ğŸ“„','doc','Executive','Summary',execItems,F.some(f=>f.brochureUrl))}
      ${ddBtn('ğŸ¤–','ai','Offering','AI Chat',aiItems,F.some(f=>f.aiChatUrl))}
      ${ddBtn('ğŸ“ˆ','raise','Monthly','Raise',raiseItems,true)}
      ${ddBtn('ğŸ“‹','doc','PPM','',ppmItems,F.some(f=>f.ppmUrl))}
      <div class="dd-wrap"><div class="dd-btn off"><div class="dd-ico doc">ğŸ“</div><div class="dd-lbl">DD<br>Folder</div></div></div>
    </div>
  </div>
  <div class="dd-sep"></div>
  <div class="dd-grp">
    <div class="dd-grp-lbl">Sponsor Due Diligence</div>
    <div class="dd-icons">
      ${ddBtn('ğŸ“°','news','Sponsor','News',newsItems,F.some(f=>f.sponsorNewsUrl))}
      ${ddBtn('ğŸ“Š','track','Track','Record',trackItems,F.some(f=>f.trackRecordUrl))}
      ${ddBtn('ğŸ‘¥','team','Sales','Team',teamItems,F.some(f=>f.salesTeamUrl))}
      ${ddBtn('ğŸ¬','ai','Sponsor','Video',videoItems,F.some(f=>f.videoUrl))}
    </div>
  </div>
  <div class="dd-sep"></div>
  <div class="dd-grp" style="flex:0 0 auto">
    <div class="dd-grp-lbl">Latest Updates</div>
    <div class="dd-icons">
      ${ddBtn('Q4<br>2025','upd','Q4 Update','',updateItems,F.some(f=>f.quarterlyUpdateUrl))}
    </div>
  </div>
</div>`;
}

function renderSuitPanel(f, client, hasClient, score) {
  const AFL = window.AFL;
  if (!hasClient) {
    return `<div class="suit-panel-empty">
      <div style="font-size:28px">ğŸ‘¤</div>
      <div style="font-size:13px;font-weight:600;color:var(--slate)">No Client Profile Set</div>
      <div style="font-size:12px;color:var(--slate2);line-height:1.5;max-width:220px">Add a client to see a personalized suitability score and distribution projections.</div>
      <button class="btn btn-secondary" style="font-size:12px;padding:6px 14px" onclick="window._afl_offering.setClient()">+ Set Up Client Profile</button>
    </div>`;
  }
  const cls = score >= 70 ? 'var(--green)' : score >= 45 ? 'var(--amber)' : 'var(--red)';
  const lbl = score >= 70 ? 'Strong Match' : score >= 45 ? 'Moderate Match' : 'Poor Match';
  const factors = getSuitFactors(f, client);
  return `<div class="suit-panel-high">
    <div style="font-size:9.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--green);margin-bottom:7px">Suitability â€” ${AFL.escapeHTML(client.name)}</div>
    <div style="display:flex;align-items:flex-end;gap:10px">
      <div class="suit-score-big" style="color:${cls}">${score}%</div>
      <div style="font-size:12px;color:${cls};font-weight:600;padding-bottom:5px">${lbl}</div>
    </div>
    <div style="font-size:11px;color:var(--slate2);margin:5px 0 11px">
      ${client.exchangeAmount ? AFL.fmt.money(client.exchangeAmount)+' exchange' : ''}
      ${client.riskTolerance ? ' Â· '+client.riskTolerance : ''}
      ${client.horizon ? ' Â· '+client.horizon+'yr horizon' : ''}
    </div>
    <div class="suit-factors">
      ${factors.map(fc => `<div class="sf"><div class="sf-dot" style="background:${fc.pass ? 'var(--green)' : fc.warn ? 'var(--amber)' : 'var(--fog)'}"></div>${AFL.escapeHTML(fc.label)}</div>`).join('')}
    </div>
  </div>`;
}

function renderPortfolioSuitPanel(funds, client, hasClient, scores, avgScore) {
  const AFL = window.AFL;
  if (!hasClient || avgScore === null) {
    return `<div style="text-align:center;padding:16px;color:var(--slate2)">
      <button class="btn btn-secondary" onclick="window._afl_offering.setClient()">+ Set Up Client Profile for Suitability</button>
    </div>`;
  }
  const cls = avgScore >= 70 ? 'var(--green)' : avgScore >= 45 ? 'var(--amber)' : 'var(--red)';
  const lbl = avgScore >= 70 ? 'Good Match â€” Well Diversified' : avgScore >= 45 ? 'Moderate Match' : 'Review Carefully';
  const blendedLtv = funds.reduce((s,f)=>s+(f.ltv||0),0)/funds.length;
  const blendedCoc = funds.reduce((s,f)=>s+(f.y1coc||0),0)/funds.length;
  const totalMin   = funds.reduce((s,f)=>s+(f.minInvest||0),0);
  const avgHold    = funds.reduce((s,f)=>s+(f.holdPeriod||0),0)/funds.length;
  const sectors    = [...new Set(funds.map(f=>f.sector).filter(Boolean))];

  return `
    <div style="font-size:9.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--green);margin-bottom:7px">Blended Portfolio Suitability â€” ${AFL.escapeHTML(client.name)}</div>
    <div style="display:flex;align-items:flex-end;gap:12px;margin-bottom:4px">
      <div class="suit-score-big" style="color:${cls}">${avgScore}%</div>
      <div style="font-size:12px;color:${cls};font-weight:600;padding-bottom:5px">${lbl}</div>
    </div>
    <div style="font-size:11px;color:var(--slate2);margin-bottom:12px">
      ${client.exchangeAmount?AFL.fmt.money(client.exchangeAmount)+' exchange Â· ':''}${AFL.escapeHTML(sectors.join(' + '))}
      ${client.riskTolerance?' Â· '+client.riskTolerance:''}${client.horizon?' Â· '+client.horizon+'yr horizon':''}
    </div>
    <div class="suit-factors">
      <div class="sf"><div class="sf-dot" style="background:${blendedLtv<50?'var(--green)':'var(--amber)'}"></div>Blended LTV ${AFL.fmt.pct(blendedLtv)} â€” ${blendedLtv<50?'within conservative range':'slightly elevated'}</div>
      <div class="sf"><div class="sf-dot" style="background:${(!client.exchangeAmount||totalMin<=client.exchangeAmount)?'var(--green)':'var(--red)'}"></div>${AFL.fmt.money(totalMin)} combined min ${client.exchangeAmount?(totalMin<=client.exchangeAmount?'fits':'exceeds')+' exchange':''}</div>
      <div class="sf"><div class="sf-dot" style="background:${sectors.length>1?'var(--green)':'var(--slate2)'}"></div>${sectors.join(' + ')||'Diversified'} exposure</div>
      <div class="sf"><div class="sf-dot" style="background:${blendedCoc>=4?'var(--green)':'var(--amber)'}"></div>Blended Y1 CoC ${AFL.fmt.pct(blendedCoc)} ${blendedCoc>=4?'exceeds':'below'} 4% target</div>
      <div class="sf"><div class="sf-dot" style="background:${funds.some(f=>f.ltv>=55)?'var(--amber)':'var(--green)'}"></div>${funds.some(f=>f.ltv>=55)?'One offering LTV above 55% â€” watch':'All offering LTVs within range'}</div>
      <div class="sf"><div class="sf-dot" style="background:${(!client.horizon||avgHold<=client.horizon)?'var(--green)':'var(--amber)'}"></div>Avg hold ${AFL.fmt.num(avgHold,1)}yr ${client.horizon?'vs '+client.horizon+'yr horizon':''}</div>
    </div>
    <div class="suit-cards-row">
      ${funds.map((f,i) => {
        const s = scores[i];
        const c = s>=70?O_HEX[i]:s>=45?'var(--amber)':'var(--red)';
        const l = s>=70?'Strong match':s>=45?'Good match':'Moderate';
        return `<div class="suit-card suit-card-${i+1}">
          <div class="suit-card-score" style="color:${c}">${s}%</div>
          <div class="suit-card-name">${'â‘ â‘¡â‘¢'[i]} ${AFL.escapeHTML(f.name?(f.name.length>25?f.name.slice(0,23)+'â€¦':f.name):'')}<br><span style="color:var(--slate2)">${l}</span></div>
        </div>`;
      }).join('')}
    </div>`;
}

function renderPortfolioProjectionTable(funds, exchangeAmt) {
  const AFL = window.AFL;
  const holdYrs = Math.max(...funds.map(f=>f.holdPeriod||7));
  const years = Array.from({length:Math.min(holdYrs,10)},(_,i)=>i+1);
  const perFund = exchangeAmt / funds.length;
  let cum = 0;
  return `
  <div class="panel">
    <div class="panel-title">ğŸ“Š Blended Distribution Projections â€” ${AFL.fmt.money(exchangeAmt)} Exchange (equal weight)</div>
    <div style="overflow-x:auto">
      <table class="proj-table">
        <thead><tr>
          <th style="text-align:left">Metric</th>
          ${years.map((y,i) => `<th ${i===0?'class="hl"':''}>Year ${y}</th>`).join('')}
        </tr></thead>
        <tbody>
          ${funds.map((f,fi) => {
            const coc = f.income ? f.income[0] : f.y1coc;
            return `<tr>
              <td>${'â‘ â‘¡â‘¢'[fi]} ${AFL.escapeHTML(f.name?(f.name.length>22?f.name.slice(0,20)+'â€¦':f.name):'')} (${AFL.fmt.pct(coc)})</td>
              ${years.map((y,i) => {
                const active = !f.holdPeriod || y <= f.holdPeriod;
                const dist = active && coc ? perFund * coc / 100 : 0;
                return `<td ${i===0?'class="hl"':''}>${active && dist ? '$'+AFL.fmt.num(dist) : 'â€”'}</td>`;
              }).join('')}
            </tr>`;
          }).join('')}
          <tr class="proj-total">
            <td>Total Distribution</td>
            ${years.map((y,i) => {
              const total = funds.reduce((s,f) => {
                const coc = f.income ? f.income[0] : f.y1coc;
                const active = !f.holdPeriod || y <= f.holdPeriod;
                return s + (active && coc ? perFund * coc/100 : 0);
              }, 0);
              return `<td ${i===0?'class="hl"':''}>${total>0?'$'+AFL.fmt.num(total):'â€”'}</td>`;
            }).join('')}
          </tr>
          <tr>
            <td>Cumulative Total</td>
            ${years.map((y,i) => {
              cum = 0;
              for (let yr=1;yr<=y;yr++) {
                const t = funds.reduce((s,f) => {
                  const coc = f.income ? f.income[0] : f.y1coc;
                  const active = !f.holdPeriod || yr <= f.holdPeriod;
                  return s + (active && coc ? perFund * coc/100 : 0);
                },0);
                cum += t;
              }
              return `<td ${i===0?'class="hl"':''}>$${AFL.fmt.num(cum)}</td>`;
            }).join('')}
          </tr>
        </tbody>
      </table>
    </div>
    <div style="font-size:11px;color:var(--slate2);margin-top:8px">* Distributions end per each offering's hold period. Staggered exits create a natural liquidity ladder.</div>
  </div>`;
}

function renderKeyDrivers(f) {
  const AFL = window.AFL;
  const peerCoc = _peers.y1coc && _peers.y1coc.avg;
  const peerLtv = _peers.ltv   && _peers.ltv.avg;
  const drivers = [];

  if (f.ltv != null && peerLtv) {
    const diff = (peerLtv - f.ltv).toFixed(1);
    drivers.push({type: f.ltv < peerLtv ? 'pos' : 'neg', ico: f.ltv < peerLtv ? 'âœ…' : 'âš ï¸',
      text: `LTV of ${AFL.fmt.pct(f.ltv)} is ${f.ltv<peerLtv?'well below':'above'} the peer average of ${AFL.fmt.pct(peerLtv)}, ${f.ltv<peerLtv?'providing strong downside protection':'indicating higher leverage risk'}.`});
  }
  if (f.occupancy >= 95) {
    drivers.push({type:'pos',ico:'âœ…',text:`${AFL.fmt.pct(f.occupancy,1)} occupancy${f.avgLeaseTerm ? ' with '+AFL.fmt.num(f.avgLeaseTerm,1)+'-year WALT' : ''}${f.tenantCredit?' from '+f.tenantCredit:''}. Strong lease quality reduces vacancy risk.`});
  }
  if (f.y1coc != null && peerCoc) {
    const basis = Math.round((f.y1coc - peerCoc)*100);
    drivers.push({type: f.y1coc >= peerCoc ? 'pos' : 'neu', ico: f.y1coc >= peerCoc ? 'âœ…' : 'â„¹ï¸',
      text: `Y1 CoC of ${AFL.fmt.pct(f.y1coc)} ${f.y1coc>=peerCoc?'exceeds':'is below'} peer average of ${AFL.fmt.pct(peerCoc)} by ${Math.abs(basis)} basis points â€” ${f.y1coc>=peerCoc?'top quartile income yield.':'consider peer context.'}`});
  }
  if (f.dscr != null && f.dscr > 0) {
    drivers.push({type: f.dscr >= 2 ? 'pos' : f.dscr >= 1.25 ? 'neu' : 'neg', ico: f.dscr >= 2 ? 'âœ…' : 'â„¹ï¸',
      text: `DSCR of ${AFL.fmt.num(f.dscr,1)}x indicates debt service is covered ${AFL.fmt.num(f.dscr,1)}x by operating income â€” ${f.dscr>=2?'exceptional coverage ratio.':'adequate coverage.'}`});
  }
  if (f.purchasePrice && f.appraisedValue) {
    const disc = ((f.purchasePrice - f.appraisedValue)/f.appraisedValue*100).toFixed(1);
    drivers.push({type: Number(disc)<0?'neu':'neu', ico: 'â„¹ï¸',
      text: `Purchase price of ${AFL.fmt.money(f.purchasePrice)} is ${Math.abs(disc)}% ${Number(disc)<0?'below':'above'} the appraised value of ${AFL.fmt.money(f.appraisedValue)}.`});
  }
  if (f.pctRemaining != null) {
    drivers.push({type:'neu', ico:'â„¹ï¸',
      text: `${f.pctRemaining.toFixed(0)}% of raise term remaining${f.offeringClose?' before '+AFL.fmt.date(f.offeringClose):''}.`});
  }

  // Fill to 6
  while (drivers.length < 3) drivers.push({type:'neu',ico:'â„¹ï¸',text:'Review full PPM for complete risk disclosures.'});

  return drivers.slice(0,6).map(d =>
    `<div class="kd ${d.type}"><div class="kd-ico">${d.ico}</div><div>${AFL.escapeHTML(d.text)}</div></div>`
  ).join('');
}

function renderPortfolioKeyDrivers(funds, blendedCoc, blendedLtv, peerCoc, hasClient, client) {
  const AFL = window.AFL;
  const drivers = [];
  const n = funds.length;
  const totalMin = funds.reduce((s,f)=>s+(f.minInvest||0),0);
  const bestCoc = funds.reduce((best,f) => (f.y1coc||0)>(best.y1coc||0) ? f : best, funds[0]);
  const sectors = [...new Set(funds.map(f=>f.sector).filter(Boolean))];

  if (bestCoc) {
    drivers.push({type:'pos',ico:'âœ…',text:`${AFL.escapeHTML(bestCoc.name||'')} anchors the portfolio with ${AFL.fmt.pct(bestCoc.ltv)} LTV and ${AFL.fmt.pct(bestCoc.y1coc)} CoC â€” the strongest performer across key metrics.`});
  }
  if (sectors.length > 1) {
    drivers.push({type:'pos',ico:'âœ…',text:`Property type diversification across ${sectors.join(' and ')} reduces single-sector exposure and provides different correlation to rate cycles.`});
  }
  if (peerCoc && blendedCoc > peerCoc) {
    const basis = Math.round((blendedCoc - peerCoc)*100);
    drivers.push({type:'pos',ico:'âœ…',text:`Blended Y1 CoC of ${AFL.fmt.pct(blendedCoc)} exceeds the peer average of ${AFL.fmt.pct(peerCoc)} by ${basis} basis points â€” strong income yield across the combined portfolio.`});
  }
  if (hasClient && client.exchangeAmount && totalMin < client.exchangeAmount) {
    const remaining = client.exchangeAmount - totalMin;
    drivers.push({type:'pos',ico:'âœ…',text:`Combined minimum of ${AFL.fmt.money(totalMin)} uses only ${((totalMin/client.exchangeAmount)*100).toFixed(0)}% of the ${AFL.fmt.money(client.exchangeAmount)} exchange, leaving ${AFL.fmt.money(remaining)} for additional DSTs.`});
  }
  const highLtv = funds.find(f => f.ltv >= 50);
  if (highLtv) {
    drivers.push({type:'neu',ico:'âš ï¸',text:`${AFL.escapeHTML(highLtv.name||'')} LTV of ${AFL.fmt.pct(highLtv.ltv)} is above the conservative 50% threshold. Consider weighting lower if client has elevated risk sensitivity.`});
  }
  const holdPeriods = funds.map(f=>f.holdPeriod).filter(Boolean).sort();
  if (holdPeriods.length > 1 && holdPeriods[0] !== holdPeriods[holdPeriods.length-1]) {
    drivers.push({type:'neu',ico:'â„¹ï¸',text:`Staggered hold periods (${holdPeriods.join('yr, ')}yr) create a natural liquidity ladder, freeing capital at different intervals.`});
  }

  while (drivers.length < 3) drivers.push({type:'neu',ico:'â„¹ï¸',text:'Review individual PPMs for complete risk disclosures on each offering.'});

  return drivers.slice(0,6).map(d =>
    `<div class="kd ${d.type}"><div class="kd-ico">${d.ico}</div><div>${AFL.escapeHTML(d.text)}</div></div>`
  ).join('');
}

function renderAiNarrative(f) {
  const AFL = window.AFL;
  const parts = [];
  if (f.name) parts.push(`The ${AFL.escapeHTML(f.name)}`);
  if (f.sponsor) parts.push(`is a ${AFL.escapeHTML(f.sector||'DST')} offering sponsored by ${AFL.escapeHTML(f.sponsor)}`);
  if (f.numAssets && f.location) parts.push(`, providing exposure to ${f.numAssets} ${AFL.escapeHTML(f.sector||'commercial real estate')} asset${f.numAssets>1?'s':''} in ${AFL.escapeHTML(f.location)}`);
  if (f.ltv) parts.push(`. The offering features a ${AFL.fmt.pct(f.ltv)} LTV${_peers.ltv&&_peers.ltv.avg?' compared to the platform average of '+AFL.fmt.pct(_peers.ltv.avg):''}`);
  if (f.dscr) parts.push(` with a DSCR of ${AFL.fmt.num(f.dscr,1)}x`);
  if (f.occupancy) parts.push(`. The portfolio is ${AFL.fmt.pct(f.occupancy,1)} occupied${f.tenantCredit?' by '+AFL.escapeHTML(f.tenantCredit):''}${f.avgLeaseTerm?' with '+AFL.fmt.num(f.avgLeaseTerm,1)+' years of average lease term remaining':''}`);
  if (f.y1coc) parts.push(`. At a Y1 cash-on-cash distribution of ${AFL.fmt.pct(f.y1coc)}, this offering ${_peers.y1coc&&f.y1coc>_peers.y1coc.avg?'ranks above the platform average of '+AFL.fmt.pct(_peers.y1coc.avg):''}`);
  parts.push('.');

  if (parts.length < 3) return '';
  return `<div class="panel">
    <div class="panel-title">ğŸ¤– AI Overview</div>
    <div class="narr">${parts.join('')}</div>
  </div>`;
}

function renderPropertyNarrative(f) {
  const AFL = window.AFL;
  const bits = [];
  if (f.sector && f.location) bits.push(`${AFL.escapeHTML(f.sector)} properties in ${AFL.escapeHTML(f.location)}`);
  if (f.numAssets) bits.push(`${f.numAssets} asset${f.numAssets>1?'s':''}`);
  if (f.sqft) bits.push(`${AFL.fmt.num(f.sqft)} total square feet`);
  if (f.buildingAge) bits.push(`building age: ${AFL.escapeHTML(String(f.buildingAge))}`);
  if (bits.length === 0) return `Review the offering brochure for full property and market details.`;
  return bits.join('. ')+(bits.length?'.':'');
}

function renderFinanceNarrative(f) {
  const AFL = window.AFL;
  const bits = [];
  if (f.offeringStructure) bits.push(`${AFL.escapeHTML(f.offeringStructure)} structure`);
  if (f.holdPeriod) bits.push(`${AFL.fmt.num(f.holdPeriod)}-year projected hold`);
  if (f.ltv && f.dscr) bits.push(`fixed-rate debt at ${AFL.fmt.pct(f.ltv)} LTV with DSCR of ${AFL.fmt.num(f.dscr,1)}x`);
  if (f.minInvest) bits.push(`minimum investment of ${AFL.fmt.money(f.minInvest)}`);
  if (f.y1coc) bits.push(`annual distributions of ${AFL.fmt.pct(f.y1coc)}`);
  if (f.rentEscalations) bits.push(`rent escalations of ${AFL.escapeHTML(String(f.rentEscalations))}`);
  if (bits.length === 0) return 'Review the PPM for full financial structure and risk disclosures.';
  return bits.join('. ')+(bits.length?'.':'');
}

function renderDataRows(pairs) {
  return pairs.map(([lbl,val]) =>
    val && val !== 'â€”'
      ? `<div class="data-row"><span class="data-row-lbl">${lbl}</span><span class="data-row-val">${val}</span></div>`
      : ''
  ).join('');
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function sponsorLogoHtml(f) {
  if (f.sponsorLogoUrl) return `<img src="${f.sponsorLogoUrl}" alt="${window.AFL.escapeHTML(f.sponsor||'')}" onerror="this.parentElement.textContent='${initials(f.sponsor)}'"/>`;
  return initials(f.sponsor);
}

function initials(name) {
  if (!name) return 'AFL';
  return name.split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();
}

function getSuitFactors(f, client) {
  const AFL = window.AFL;
  const factors = [];
  if (f.ltv != null) factors.push({pass: f.ltv <= 60, warn: f.ltv > 60 && f.ltv <= 70, label: `LTV ${AFL.fmt.pct(f.ltv)} vs 60% threshold`});
  if (client.exchangeAmount && f.minInvest != null) factors.push({pass: f.minInvest <= client.exchangeAmount, label: `Min invest ${AFL.fmt.money(f.minInvest)} fits exchange`});
  if (f.y1coc != null) factors.push({pass: f.y1coc >= 4.0, label: `Y1 CoC ${AFL.fmt.pct(f.y1coc)} vs 4% target`});
  if (f.occupancy != null) factors.push({pass: f.occupancy >= 90, label: `Occupancy ${AFL.fmt.pct(f.occupancy,1)}`});
  if (client.propTypes && client.propTypes.length && f.sector) factors.push({pass: client.propTypes.includes(f.sector), label: `${AFL.escapeHTML(f.sector)} preference match`});
  if (client.horizon && f.holdPeriod) factors.push({pass: f.holdPeriod <= client.horizon, warn: f.holdPeriod > client.horizon, label: `Hold ${f.holdPeriod}yr vs ${client.horizon}yr horizon`});
  return factors;
}

function isBest(vals, idx, dir) {
  // dir = 'high' (bigger=better) or 'low' (smaller=better)
  const nums = vals.map(v => parseFloat(String(v).replace(/[^0-9.-]/g,''))).filter(n => !isNaN(n));
  if (!nums.length) return false;
  const mine = parseFloat(String(vals[idx]).replace(/[^0-9.-]/g,''));
  if (isNaN(mine)) return false;
  return dir === 'high' ? mine === Math.max(...nums) : mine === Math.min(...nums);
}

// â”€â”€ After-render hooks (charts, maps) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function afterRenderSingle(f) {
  drawMap('us-map-single', [{fund:f, colorIdx:0}]);
  drawSingleChart(f);
}

function afterRenderPortfolio() {
  const stateAssignments = {};
  _funds.forEach((f,i) => {
    window.AFL.extractStates(f.location||'').forEach(s => stateAssignments[s] = i);
  });
  drawMapPortfolio('us-map-portfolio', stateAssignments);
  drawPortfolioChart(_funds);
}

// D3 map drawing
let _topoCache = null;

function fetchTopo() {
  if (_topoCache) return Promise.resolve(_topoCache);
  return fetch('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json')
    .then(r => r.json())
    .then(data => { _topoCache = data; return data; })
    .catch(() => null);
}

function drawMap(svgId, entries) {
  fetchTopo().then(us => {
    if (!us) return;
    const el = document.getElementById(svgId);
    if (!el) return;
    const stateSet = {};
    entries.forEach(({fund, colorIdx}) => {
      window.AFL.extractStates(fund.location||'').forEach(s => stateSet[s] = colorIdx);
    });
    _renderD3Map(el, us, stateSet);
  });
}

function drawMapPortfolio(svgId, stateAssignments) {
  fetchTopo().then(us => {
    if (!us) return;
    const el = document.getElementById(svgId);
    if (!el) return;
    _renderD3Map(el, us, stateAssignments);
  });
}

function _renderD3Map(svgEl, us, stateAssignments) {
  // Clear
  while (svgEl.firstChild) svgEl.removeChild(svgEl.firstChild);

  const w = 960, h = 600;
  const svg = d3.select(svgEl);
  const proj = d3.geoAlbersUsa().scale(1200).translate([w/2, h/2]);
  const path = d3.geoPath().projection(proj);
  const states = topojson.feature(us, us.objects.states);
  const STATE_CLASSES = ['state-o1','state-o2','state-o3'];

  svg.selectAll('path.state')
    .data(states.features)
    .enter().append('path')
    .attr('class', d => {
      const fips = String(d.id).padStart(2,'0');
      const abbr = STATE_BY_FIPS[fips];
      const idx  = stateAssignments[abbr];
      return idx !== undefined ? STATE_CLASSES[idx] : 'state-base';
    })
    .attr('d', path)
    .append('title')
    .text(d => {
      const fips = String(d.id).padStart(2,'0');
      const abbr = STATE_BY_FIPS[fips]||'';
      const idx  = stateAssignments[abbr];
      if (idx !== undefined) return abbr + ' â€” ' + 'â‘ â‘¡â‘¢'[idx];
      return abbr;
    });

  svg.append('path')
    .datum(topojson.mesh(us, us.objects.states, (a,b) => a!==b))
    .attr('d', path)
    .attr('fill','none')
    .attr('stroke','#0d1e36')
    .attr('stroke-width','0.5');
}

function drawSingleChart(f) {
  const canvas = document.getElementById('distChart');
  if (!canvas || !f.income) return;
  const AFL = window.AFL;
  const years = (f.income||[]).map((v,i)=>({yr:i+1,v})).filter(x=>x.v!=null&&isFinite(x.v));
  if (!years.length) return;
  if (_distChart) { _distChart.destroy(); _distChart = null; }
  _distChart = new Chart(canvas.getContext('2d'), {
    type: 'bar',
    data: {
      labels: years.map(x => 'Yr '+x.yr),
      datasets: [{
        label: 'CoC %',
        data: years.map(x => x.v),
        backgroundColor: (ctx) => ctx.dataIndex === 0 ? '#1C3A63' : '#C8D8E8',
        borderRadius: 5,
        borderSkipped: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend:{display:false}, tooltip:{callbacks:{label:c=>` ${c.parsed.y.toFixed(2)}%`}} },
      scales: {
        y: { min: Math.max(0,(Math.min(...years.map(x=>x.v))-0.5)).toFixed(1)*1, ticks:{callback:v=>v.toFixed(1)+'%',font:{family:'DM Sans',size:11}}, grid:{color:'#E8F0F8'} },
        x: { ticks:{font:{family:'DM Sans',size:11}}, grid:{display:false} }
      }
    }
  });
}

function drawPortfolioChart(funds) {
  const canvas = document.getElementById('distChart');
  if (!canvas || !funds.length) return;
  const AFL = window.AFL;
  const client = AFL.state.client;
  const perFund = (client && client.exchangeAmount) ? client.exchangeAmount / funds.length : null;
  const maxHold = Math.max(...funds.map(f=>f.holdPeriod||7));
  const years   = Array.from({length:Math.min(maxHold,10)},(_,i)=>'Yr '+(i+1));

  const datasets = funds.map((f,i) => {
    const coc = f.income ? f.income[0] : f.y1coc;
    return {
      label: ''+('â‘ â‘¡â‘¢'[i])+' '+((f.name||'').slice(0,22))+' ('+AFL.fmt.pct(coc)+')',
      data: years.map((_,yi) => {
        const active = !f.holdPeriod || (yi+1) <= f.holdPeriod;
        if (!active || !coc) return 0;
        return perFund ? perFund * coc/100 : coc;
      }),
      backgroundColor: O_HEX[i],
      borderRadius: 4,
      borderSkipped: false,
      stack: 'a'
    };
  });

  if (_distChart) { _distChart.destroy(); _distChart = null; }
  _distChart = new Chart(canvas.getContext('2d'), {
    type: 'bar',
    data: { labels: years, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display:true, position:'bottom', labels:{font:{family:'DM Sans',size:11},boxWidth:10,padding:12} },
        tooltip: { callbacks: { label: c => ` ${c.dataset.label}: ${perFund ? '$'+window.AFL.fmt.num(c.parsed.y) : c.parsed.y.toFixed(2)+'%'}` } }
      },
      scales: {
        y: { stacked:true, ticks:{callback:v=>perFund?'$'+(v/1000).toFixed(0)+'K':v.toFixed(1)+'%',font:{family:'DM Sans',size:11}}, grid:{color:'#E8F0F8'} },
        x: { stacked:true, ticks:{font:{family:'DM Sans',size:11}}, grid:{display:false} }
      }
    }
  });
}

// â”€â”€ Error state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderError(msg) {
  const root = document.getElementById('offering-module');
  if (root) root.innerHTML = `<div class="error-state"><p>${msg}</p></div>`;
}

// â”€â”€ fmt.str helper (not in shared.js) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Patch AFL.fmt.str if missing
window.AFL && (window.AFL.fmt.str = function(v) {
  if (v == null || v === '') return 'â€”';
  return String(v);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PUBLIC API â€” called by onclick handlers + shell
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

window._afl_offering = {
  setMode(m) {
    _mode = m;
    render();
  },
  addBasket(id) {
    const AFL = window.AFL;
    id = Number(id);
    const result = AFL.basket.add(id);
    if (!result) {
      alert('Basket is full (max 3 offerings)');
      return;
    }
    AFL.updateHeader();
    _fundId = id;
    render();
  },
  removeBasket(id) {
    const AFL = window.AFL;
    AFL.basket.remove(id);
    AFL.updateHeader();
    render();
  },
  clearBasket() {
    if (!confirm('Remove all offerings from portfolio?')) return;
    const AFL = window.AFL;
    AFL.basket.clear ? AFL.basket.clear() : AFL.basket.get().forEach(f => AFL.basket.remove(f.id));
    AFL.updateHeader();
    _mode = 'single';
    render();
  },
  setClient() {
    window.AFL.navigate('client');
  },
  shareTearSheet() {
    window.AFL && window.AFL.toast && window.AFL.toast('Tear sheet sharing coming in Phase 2', 'info');
  },
  sharePortfolio() {
    window.AFL && window.AFL.toast && window.AFL.toast('Portfolio sharing coming in Phase 2', 'info');
  },
  modelForClient(id) {
    window.AFL.navigate('model', {id});
  },
  navigateFund(id) {
    _fundId = id;
    _mode   = 'single';
    render();
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODULE EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

window.currentModule = {
  async init(shellParams = {}) {
    // Patch fmt.str (not in shared.js)
    if (window.AFL) {
      window.AFL.fmt.str = function(v) {
        if (v == null || v === '') return 'â€”';
        return String(v);
      };
    }
    await init(shellParams);
  }
};

// Standalone mode (direct file open without shell)
if (!window._aflShellActive) {
  function _tryOfferingInit() {
    if (window.AFL) {
      window.currentModule.init({});
    } else {
      setTimeout(_tryOfferingInit, 50);
    }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', _tryOfferingInit);
  } else {
    _tryOfferingInit();
  }
}

})();
</script>
</body>
</html>
