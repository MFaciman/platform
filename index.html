<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Alts Fund Link — Platform</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
<script src="shared.js"></script>
<style>
/* ═══════════════════════════════════════════════
   DESIGN TOKENS
═══════════════════════════════════════════════ */
:root {
  --navy:       #0B1F3B;
  --navy2:      #1C3A63;
  --navy3:      #2A4D7A;
  --slate:      #3A5270;
  --slate2:     #5C7A99;
  --fog:        #8FA3BA;
  --mist:       #C8D8E8;
  --ice:        #E8F0F8;
  --white:      #FFFFFF;
  --surface:    #F4F7FB;
  --surface2:   #EEF3FA;

  --green:      #1A7A4A;
  --green-lt:   #E8F7EF;
  --amber:      #B45309;
  --amber-lt:   #FEF3C7;
  --red:        #991B1B;
  --red-lt:     #FEE2E2;
  --blue:       #1D4ED8;
  --blue-lt:    #EFF6FF;

  --comp-accent:#7C3AED;
  --comp-lt:    #F5F3FF;
  --report-accent:#0D7490;
  --report-lt:  #ECFEFF;

  --radius:     8px;
  --radius-lg:  14px;
  --radius-xl:  20px;
  --shadow-sm:  0 1px 3px rgba(11,31,59,0.08), 0 1px 2px rgba(11,31,59,0.06);
  --shadow:     0 4px 12px rgba(11,31,59,0.10), 0 2px 4px rgba(11,31,59,0.06);
  --shadow-lg:  0 12px 32px rgba(11,31,59,0.14), 0 4px 8px rgba(11,31,59,0.08);
  --shadow-xl:  0 24px 64px rgba(11,31,59,0.18);

  --font: 'DM Sans', sans-serif;
  --mono: 'DM Mono', monospace;

  --header-h:   60px;
  --nav-w:      220px;
  --transition: 0.18s cubic-bezier(0.4,0,0.2,1);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; }
body {
  font-family: var(--font);
  font-size: 14px;
  line-height: 1.5;
  background: var(--surface);
  color: var(--navy);
  -webkit-font-smoothing: antialiased;
}
a { color: inherit; text-decoration: none; }
button { cursor: pointer; font-family: var(--font); }
input, select, textarea { font-family: var(--font); }

/* ═══════════════════════════════════════════════
   LAYOUT SHELL
═══════════════════════════════════════════════ */
#app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

/* ─── HEADER ─── */
#header {
  height: var(--header-h);
  background: var(--navy);
  display: flex;
  align-items: center;
  padding: 0 20px;
  gap: 16px;
  flex-shrink: 0;
  position: relative;
  z-index: 100;
  box-shadow: 0 2px 8px rgba(0,0,0,0.25);
}

#logo { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
#logo-mark {
  width: 32px; height: 32px;
  background: linear-gradient(135deg, #3B82F6, #1D4ED8);
  border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 15px; font-weight: 700; color: #fff; letter-spacing: -0.5px;
}
#logo-text { font-size: 14px; font-weight: 600; color: #fff; letter-spacing: 0.02em; line-height: 1.2; }
#logo-sub { font-size: 10px; color: var(--fog); font-weight: 400; letter-spacing: 0.08em; text-transform: uppercase; }

/* View Toggle */
#view-toggle {
  display: flex; align-items: center;
  background: rgba(255,255,255,0.08);
  border-radius: 8px; padding: 3px; gap: 2px; margin-left: 12px;
}
.view-btn {
  display: flex; align-items: center; gap: 6px;
  padding: 5px 12px; border-radius: 6px; border: none;
  background: transparent; color: var(--fog);
  font-size: 12.5px; font-weight: 500; letter-spacing: 0.01em;
  transition: all var(--transition); white-space: nowrap;
}
.view-btn:hover { color: var(--white); background: rgba(255,255,255,0.10); }
.view-btn.active { background: var(--white); color: var(--navy); font-weight: 600; }
.view-btn.active.compliance { background: #DDD6FE; color: #4C1D95; }
.view-btn.active.client-report { background: #CFFAFE; color: #164E63; }
.view-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; opacity: 0.5; }
.view-btn.active .view-dot { opacity: 1; }

/* Client badge */
#client-badge {
  margin-left: auto;
  display: flex; align-items: center; gap: 8px;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 8px; padding: 5px 12px;
  cursor: pointer; transition: background var(--transition); flex-shrink: 0;
}
#client-badge:hover { background: rgba(255,255,255,0.14); }
#client-badge-icon {
  width: 24px; height: 24px; border-radius: 50%;
  background: linear-gradient(135deg, var(--navy3), var(--blue));
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 700; color: #fff;
}
#client-badge-text { font-size: 12px; color: var(--white); font-weight: 500; }
#client-badge-text small { display: block; font-size: 10px; color: var(--fog); font-weight: 400; }

/* Loading indicator */
#data-status { font-size: 11px; color: var(--fog); display: flex; align-items: center; gap: 6px; flex-shrink: 0; }
.pulse-dot { width: 6px; height: 6px; border-radius: 50%; background: #34D399; animation: pulse 2s ease-in-out infinite; }
@keyframes pulse { 0%,100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(0.8); } }
.pulse-dot.loading { background: #F59E0B; animation: spin-dot 0.8s linear infinite; }
.pulse-dot.error { background: #F87171; animation: none; }
@keyframes spin-dot { 0% { transform: scale(0.6); opacity: 0.5; } 50% { transform: scale(1); opacity: 1; } 100% { transform: scale(0.6); opacity: 0.5; } }

/* ─── BODY AREA ─── */
#body-area { display: flex; flex: 1; overflow: hidden; }

/* ─── SIDEBAR NAV ─── */
#sidebar {
  width: var(--nav-w);
  background: var(--white);
  border-right: 1px solid var(--mist);
  display: flex; flex-direction: column;
  overflow-y: auto; flex-shrink: 0;
  transition: background var(--transition);
}
#sidebar.compliance-mode { background: #FDFBFF; border-right-color: #DDD6FE; }
#sidebar.report-mode { background: #FDFFFE; border-right-color: #A5F3FC; }

.nav-section { padding: 8px 0; border-bottom: 1px solid var(--surface2); }
.nav-section:last-child { border-bottom: none; flex: 1; }
.nav-label { font-size: 10px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--fog); padding: 8px 16px 4px; }
.nav-item {
  display: flex; align-items: center; gap: 9px;
  padding: 8px 16px; font-size: 13px; font-weight: 500; color: var(--slate);
  cursor: pointer; border-radius: 0; border: none; background: transparent;
  width: 100%; text-align: left; transition: all var(--transition); position: relative;
}
.nav-item:hover { background: var(--surface); color: var(--navy); }
.nav-item.active { background: var(--ice); color: var(--navy); font-weight: 600; }
.nav-item.active::before {
  content: ''; position: absolute; left: 0; top: 4px; bottom: 4px;
  width: 3px; background: var(--navy2); border-radius: 0 2px 2px 0;
}
#sidebar.compliance-mode .nav-item.active { background: var(--comp-lt); color: #4C1D95; }
#sidebar.compliance-mode .nav-item.active::before { background: var(--comp-accent); }
#sidebar.report-mode .nav-item.active { background: var(--report-lt); color: var(--report-accent); }
#sidebar.report-mode .nav-item.active::before { background: var(--report-accent); }
.nav-icon { font-size: 14px; width: 18px; text-align: center; flex-shrink: 0; }
.nav-sub { padding: 0; }
.nav-sub .nav-item { padding-left: 36px; font-size: 12.5px; }

/* ─── MAIN CONTENT ─── */
#main { flex: 1; overflow-y: auto; padding: 28px 32px; }

/* ═══════════════════════════════════════════════
   COMMON COMPONENTS
═══════════════════════════════════════════════ */
.page-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 24px; gap: 16px; }
.page-title { font-size: 22px; font-weight: 700; color: var(--navy); letter-spacing: -0.02em; line-height: 1.2; }
.page-subtitle { font-size: 13px; color: var(--slate2); margin-top: 3px; }

.panel { background: var(--white); border: 1px solid var(--mist); border-radius: var(--radius-lg); padding: 20px 24px; box-shadow: var(--shadow-sm); }
.panel-title { font-size: 13px; font-weight: 700; letter-spacing: 0.04em; text-transform: uppercase; color: var(--slate); margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }

.btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: var(--radius); border: none; font-size: 13px; font-weight: 600; cursor: pointer; transition: all var(--transition); white-space: nowrap; }
.btn-primary { background: var(--navy); color: var(--white); }
.btn-primary:hover { background: var(--navy2); }
.btn-secondary { background: var(--white); color: var(--navy); border: 1.5px solid var(--mist); }
.btn-secondary:hover { border-color: var(--slate2); background: var(--surface); }
.btn-ghost { background: transparent; color: var(--slate2); border: 1.5px solid transparent; }
.btn-ghost:hover { color: var(--navy); background: var(--surface); }
.btn-sm { padding: 5px 10px; font-size: 12px; }
.btn-icon { padding: 7px; border-radius: var(--radius); background: var(--surface); border: 1px solid var(--mist); color: var(--slate); display: inline-flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; transition: all var(--transition); }
.btn-icon:hover { background: var(--ice); color: var(--navy); border-color: var(--slate2); }

.badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; letter-spacing: 0.02em; }
.badge-green { background: var(--green-lt); color: var(--green); }
.badge-amber { background: var(--amber-lt); color: var(--amber); }
.badge-red { background: var(--red-lt); color: var(--red); }
.badge-blue { background: var(--blue-lt); color: var(--blue); }
.badge-navy { background: var(--ice); color: var(--navy2); }
.badge-purple { background: #EDE9FE; color: #5B21B6; }

.suit-score { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 700; padding: 3px 8px; border-radius: 20px; }
.suit-score.high { background: var(--green-lt); color: var(--green); }
.suit-score.medium { background: var(--amber-lt); color: var(--amber); }
.suit-score.low { background: var(--red-lt); color: var(--red); }

.metric-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; }
.metric-tile { background: var(--surface); border: 1px solid var(--mist); border-radius: var(--radius); padding: 14px 16px; }
.metric-label { font-size: 11px; font-weight: 600; color: var(--fog); text-transform: uppercase; letter-spacing: 0.07em; margin-bottom: 4px; }
.metric-value { font-size: 22px; font-weight: 700; color: var(--navy); letter-spacing: -0.02em; line-height: 1; }
.metric-sub { font-size: 11px; color: var(--slate2); margin-top: 3px; }

.pill { display: inline-flex; align-items: center; padding: 3px 8px; border-radius: 20px; font-size: 11.5px; font-weight: 500; background: var(--surface2); color: var(--slate); border: 1px solid var(--mist); }
.divider { height: 1px; background: var(--mist); margin: 16px 0; }

.empty-state { text-align: center; padding: 48px 24px; color: var(--slate2); }
.empty-state-icon { font-size: 40px; margin-bottom: 12px; }
.empty-state h3 { font-size: 16px; font-weight: 600; color: var(--navy); margin-bottom: 6px; }
.empty-state p { font-size: 13px; line-height: 1.6; max-width: 360px; margin: 0 auto 20px; }

/* ═══════════════════════════════════════════════
   OFFERING CARD
═══════════════════════════════════════════════ */
.offering-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(290px, 1fr)); gap: 16px; }
.offering-card {
  background: var(--white); border: 1.5px solid var(--mist); border-radius: var(--radius-lg);
  padding: 18px; cursor: pointer; transition: all var(--transition); position: relative; overflow: hidden;
}
.offering-card:hover { border-color: var(--slate2); box-shadow: var(--shadow); transform: translateY(-1px); }
.offering-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; gap: 8px; }
.offering-name { font-size: 14px; font-weight: 700; color: var(--navy); line-height: 1.3; flex: 1; }
.offering-sponsor { font-size: 11.5px; color: var(--slate2); margin-top: 2px; }
.offering-badges { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 12px; }
.offering-metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
.offering-metric-item { background: var(--surface); border-radius: var(--radius); padding: 8px 10px; }
.offering-metric-item .label { font-size: 10px; font-weight: 600; color: var(--fog); text-transform: uppercase; letter-spacing: 0.07em; }
.offering-metric-item .value { font-size: 16px; font-weight: 700; color: var(--navy); letter-spacing: -0.02em; }
.offering-location { font-size: 12px; color: var(--slate2); display: flex; align-items: center; gap: 4px; margin-bottom: 10px; }
.offering-card-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 1px solid var(--surface2); }
.raise-bar { height: 4px; background: var(--surface2); border-radius: 2px; overflow: hidden; margin-top: 3px; }
.raise-fill { height: 100%; background: linear-gradient(90deg, var(--navy2), #3B82F6); border-radius: 2px; transition: width 0.6s ease; }

/* ═══════════════════════════════════════════════
   MODAL
═══════════════════════════════════════════════ */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(11,31,59,0.55);
  backdrop-filter: blur(4px); z-index: 1000;
  display: flex; align-items: center; justify-content: center; padding: 20px;
  animation: fadeIn 0.2s ease;
}
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.modal { background: var(--white); border-radius: var(--radius-xl); width: 100%; max-width: 620px; max-height: 88vh; overflow-y: auto; box-shadow: var(--shadow-xl); animation: slideUp 0.22s cubic-bezier(0.34,1.56,0.64,1); }
@keyframes slideUp { from { transform: translateY(24px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.modal-header { padding: 24px 28px 18px; border-bottom: 1px solid var(--mist); display: flex; justify-content: space-between; align-items: flex-start; }
.modal-title { font-size: 18px; font-weight: 700; color: var(--navy); letter-spacing: -0.02em; }
.modal-subtitle { font-size: 13px; color: var(--slate2); margin-top: 3px; }
.modal-close { width: 30px; height: 30px; border-radius: 50%; background: var(--surface); border: none; font-size: 16px; color: var(--slate); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: -2px; transition: all var(--transition); }
.modal-close:hover { background: var(--ice); color: var(--navy); }
.modal-body { padding: 24px 28px; }
.modal-footer { padding: 16px 28px 24px; display: flex; justify-content: flex-end; gap: 10px; }

/* Form fields */
.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.form-grid-full { grid-column: 1 / -1; }
.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-label { font-size: 12px; font-weight: 600; color: var(--slate); letter-spacing: 0.02em; }
.form-label span { color: var(--fog); font-weight: 400; }
.form-input { height: 38px; padding: 0 12px; border: 1.5px solid var(--mist); border-radius: var(--radius); font-size: 13.5px; color: var(--navy); background: var(--white); transition: border-color var(--transition); outline: none; width: 100%; }
.form-input:focus { border-color: var(--navy2); box-shadow: 0 0 0 3px rgba(28,58,99,0.08); }
.form-input::placeholder { color: var(--fog); }
.form-select { height: 38px; padding: 0 12px; border: 1.5px solid var(--mist); border-radius: var(--radius); font-size: 13.5px; color: var(--navy); background: var(--white); cursor: pointer; outline: none; width: 100%; transition: border-color var(--transition); -webkit-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235C7A99' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 32px; }
.form-select:focus { border-color: var(--navy2); box-shadow: 0 0 0 3px rgba(28,58,99,0.08); }
.checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; }
.checkbox-pill { display: flex; align-items: center; gap: 6px; padding: 6px 12px; border: 1.5px solid var(--mist); border-radius: 20px; cursor: pointer; font-size: 12.5px; font-weight: 500; color: var(--slate); transition: all var(--transition); background: var(--white); user-select: none; }
.checkbox-pill:hover { border-color: var(--slate2); color: var(--navy); background: var(--surface); }
.checkbox-pill input { width: 0; height: 0; opacity: 0; position: absolute; }
.checkbox-pill.checked { border-color: var(--navy2); background: var(--ice); color: var(--navy); font-weight: 600; }
.form-section-label { font-size: 11px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--fog); margin-bottom: 10px; margin-top: 4px; padding-bottom: 6px; border-bottom: 1px solid var(--mist); }

/* ═══════════════════════════════════════════════
   DASHBOARD
═══════════════════════════════════════════════ */
.dashboard-grid { display: grid; grid-template-columns: 340px 1fr; gap: 20px; align-items: start; }
.profile-card { background: var(--white); border: 1.5px solid var(--mist); border-radius: var(--radius-lg); overflow: hidden; }
.profile-card-header { background: linear-gradient(135deg, var(--navy) 0%, var(--navy2) 100%); padding: 20px 22px; position: relative; overflow: hidden; }
.profile-card-header::after { content: ''; position: absolute; right: -30px; top: -30px; width: 120px; height: 120px; border-radius: 50%; background: rgba(255,255,255,0.04); }
.profile-card-header h3 { font-size: 13px; font-weight: 700; color: rgba(255,255,255,0.5); letter-spacing: 0.06em; text-transform: uppercase; margin-bottom: 6px; }
.profile-card-name { font-size: 20px; font-weight: 700; color: var(--white); letter-spacing: -0.02em; }
.profile-card-firm { font-size: 12.5px; color: rgba(255,255,255,0.55); margin-top: 2px; }
.profile-card-body { padding: 18px 22px; }
.profile-row { display: flex; justify-content: space-between; align-items: center; padding: 7px 0; border-bottom: 1px solid var(--surface2); }
.profile-row:last-child { border-bottom: none; }
.profile-key { font-size: 12px; color: var(--slate2); font-weight: 500; }
.profile-val { font-size: 13px; color: var(--navy); font-weight: 600; text-align: right; }
.profile-card-footer { padding: 12px 22px 18px; display: flex; gap: 8px; }
.suggested-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
.suggested-title { font-size: 15px; font-weight: 700; color: var(--navy); }
.suggested-sub { font-size: 12px; color: var(--slate2); margin-top: 1px; }
.quick-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
.stat-card { background: var(--white); border: 1px solid var(--mist); border-radius: var(--radius); padding: 14px 16px; text-align: center; }
.stat-val { font-size: 26px; font-weight: 800; color: var(--navy); letter-spacing: -0.03em; line-height: 1; }
.stat-label { font-size: 11px; color: var(--slate2); font-weight: 500; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.06em; }
.start-here-card { background: linear-gradient(135deg, #EFF6FF 0%, #E0F2FE 100%); border: 1.5px dashed #93C5FD; border-radius: var(--radius-lg); padding: 28px 24px; text-align: center; }
.start-here-icon { font-size: 36px; margin-bottom: 12px; }
.start-here-title { font-size: 16px; font-weight: 700; color: var(--navy); margin-bottom: 6px; }
.start-here-text { font-size: 13px; color: var(--slate); line-height: 1.6; margin-bottom: 18px; }

/* ═══════════════════════════════════════════════
   FILTER BAR
═══════════════════════════════════════════════ */
.filter-bar { display: flex; align-items: center; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
.filter-tag { display: flex; align-items: center; gap: 5px; padding: 5px 12px; border: 1.5px solid var(--mist); border-radius: 20px; font-size: 12.5px; font-weight: 500; color: var(--slate); cursor: pointer; background: var(--white); transition: all var(--transition); user-select: none; }
.filter-tag:hover { border-color: var(--slate2); color: var(--navy); }
.filter-tag.active { border-color: var(--navy); background: var(--navy); color: var(--white); }
.filter-select { height: 34px; padding: 0 28px 0 10px; border: 1.5px solid var(--mist); border-radius: 20px; font-size: 12.5px; color: var(--slate); background: var(--white); cursor: pointer; outline: none; -webkit-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%235C7A99' d='M5 7L1 2h8z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; transition: border-color var(--transition); }
.filter-select:focus { border-color: var(--navy2); }
.search-input { flex: 1; max-width: 280px; height: 34px; padding: 0 12px 0 34px; border: 1.5px solid var(--mist); border-radius: 20px; font-size: 13px; color: var(--navy); background: var(--white); outline: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%235C7A99' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: 11px center; transition: border-color var(--transition); }
.search-input:focus { border-color: var(--navy2); }
.search-input::placeholder { color: var(--fog); }

/* ═══════════════════════════════════════════════
   LOADING / SKELETON
═══════════════════════════════════════════════ */
.skeleton { background: linear-gradient(90deg, var(--surface2) 25%, var(--mist) 50%, var(--surface2) 75%); background-size: 200% 100%; animation: shimmer 1.4s ease-in-out infinite; border-radius: 4px; }
@keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
.skeleton-card { background: var(--white); border: 1px solid var(--mist); border-radius: var(--radius-lg); padding: 18px; height: 200px; }

/* Compliance */
#main.compliance-mode .page-title { color: #4C1D95; }
#main.compliance-mode .panel { border-color: #DDD6FE; }

/* Animations */
.fade-in { animation: fadeIn 0.3s ease; }
.slide-in { animation: slideIn 0.25s cubic-bezier(0.4,0,0.2,1); }
@keyframes slideIn { from { transform: translateX(-12px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
.card-enter { animation: cardEnter 0.3s cubic-bezier(0.34,1.2,0.64,1) both; }
@keyframes cardEnter { from { transform: translateY(12px) scale(0.97); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }

/* Toast */
#toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
.toast { background: var(--navy); color: var(--white); padding: 11px 18px; border-radius: 10px; font-size: 13px; font-weight: 500; box-shadow: var(--shadow-lg); animation: toastIn 0.3s cubic-bezier(0.34,1.56,0.64,1); display: flex; align-items: center; gap: 8px; }
@keyframes toastIn { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
.toast-success { border-left: 4px solid #34D399; }
.toast-error { border-left: 4px solid #F87171; }

/* Module loading spinner */
.module-loading {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  height: 100%; min-height: 300px; gap: 16px; color: var(--slate2);
}
.module-spinner {
  width: 36px; height: 36px; border: 3px solid var(--mist);
  border-top-color: var(--navy2); border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Scrollbar */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--mist); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--fog); }

@media (max-width: 900px) {
  :root { --nav-w: 0px; }
  #sidebar { display: none; }
  #main { padding: 18px; }
  .dashboard-grid { grid-template-columns: 1fr; }
  .quick-stats { grid-template-columns: repeat(2, 1fr); }
  .offering-grid { grid-template-columns: 1fr; }
  #view-toggle .view-btn span.label-text { display: none; }
}
</style>
</head>
<body>

<div id="app">

  <!-- HEADER -->
  <header id="header">
    <div id="logo">
      <a href="./" style="display:flex;align-items:center">
        <img src="AFL LOGO.jpg"
             alt="Alts Fund Link" style="height:38px;width:auto;object-fit:contain" />
      </a>
    </div>

    <div id="view-toggle">
      <button class="view-btn active" data-view="advisor" onclick="switchMode('advisor')">
        <span class="view-dot"></span>
        <span class="label-text">Advisor View</span>
      </button>
      <button class="view-btn client-report" data-view="client_report" onclick="switchMode('client_report')">
        <span class="view-dot"></span>
        <span class="label-text">Client Report</span>
      </button>
      <button class="view-btn compliance" data-view="compliance" onclick="switchMode('compliance')">
        <span class="view-dot"></span>
        <span class="label-text">Compliance</span>
      </button>
    </div>

    <div id="data-status">
      <span class="pulse-dot loading" id="status-dot"></span>
      <span id="status-text">Loading data…</span>
    </div>

    <div id="client-badge" onclick="openProfileModal()">
      <div id="client-badge-icon">?</div>
      <div id="client-badge-text">
        <span id="badge-name">No Client</span>
        <small id="badge-equity">Set up client profile</small>
      </div>
    </div>
  </header>

  <!-- BODY -->
  <div id="body-area">
    <nav id="sidebar">
      <div id="nav-advisor" class="nav-content"></div>
      <div id="nav-client_report" class="nav-content" style="display:none"></div>
      <div id="nav-compliance" class="nav-content" style="display:none"></div>
    </nav>

    <main id="main">
      <div id="view-content" class="fade-in"></div>
    </main>
  </div>
</div>

<div id="modal-container"></div>
<div id="toast-container"></div>

<script src="shared.js"></script>   
<script src="https://www.gstatic.com/charts/loader.js"></script>

<script>
/* ═══════════════════════════════════════════
   CONFIGURATION
═══════════════════════════════════════════ */
const CONFIG = {
  SHEET_ID: '1xVFw8pFrJzcxD8CH7ainimPKD6GW9tn1bb8ggHYUfRs',
  SHEET_TAB: 'Sheet1',
  GVIZ_URL: function() {
    return `https://docs.google.com/spreadsheets/d/${this.SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(this.SHEET_TAB)}`;
  },
  // Module HTML files hosted alongside index.html on GitHub Pages
  MODULE_BASE: './'
};

/* ═══════════════════════════════════════════
   STATE
═══════════════════════════════════════════ */
const STATE = {
  loading: true,
  loadError: null,
  headers: [],
  colMap: {},
  funds: [],
  peer: {},

  activeMode: 'advisor',
  activeView: 'dashboard',
  viewHistory: [],
  selectedOfferingId: null,

  client: {
    clientName: '',
    advisorFirmName: '',
    exchangeEquity: null,
    debtReplacementTarget: null,
    incomeNeeded: null,
    riskTolerance: null,
    age: null,
    taxBracket: null,
    accredited: null,
    investmentHorizon: '',
    existingHoldings: [],
    structurePreference: { dstOnly: false, noDebt: false, upreit: false },
    assetClassPreference: '',
    geographicPreference: '',
    minInvestmentPreference: null
  },

  ui: {
    browse: { search: '', filterStructure: '', filterAssetClass: '', filterSponsor: '', dstOnly: false, noDebt: false, upreit: false },
    basketBuilder: { selectedIds: new Set() },
    portfolioBuilder: { portfolios: [], activePortfolioName: 'My Portfolio' },
  }
};

/* ═══════════════════════════════════════════
   MODULE LOADER
   Fetches an external .html module, injects it
   into #main, bridges STATE → window.AFL so
   modules that call getAFL() find what they need.
═══════════════════════════════════════════ */
async function loadModule(name) {
  const main = document.getElementById('main');
  const el   = document.getElementById('view-content');

  // Full-screen modules get extra room
  main.style.padding  = '0';
  main.style.overflow = 'hidden';
  el.style.height     = '100%';
  el.style.overflow   = 'auto';

  el.innerHTML = `
    <div class="module-loading">
      <div class="module-spinner"></div>
      <div style="font-size:13px;color:var(--slate2)">Loading ${name}…</div>
    </div>`;

  try {
    const url = `${CONFIG.MODULE_BASE}${name}.html?v=${Date.now()}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status} — could not load ${name}.html`);
    const html = await res.text();

    // ── Bridge shell helpers INTO existing AFL namespace from shared.js ──
    // shared.js creates window.AFL with data/client/basket.
    // We only ADD shell-specific helpers (navigate, toast, suitability).
    // ── Translate shell STATE.client → shared.js format ──
    // Uses getClientForScoring() defined below in SUITABILITY SCORING section.
    // This ensures modules, scoring, and the shell all use the same translation.
    function clientForModules() {
      return (typeof getClientForScoring === 'function') ? getClientForScoring() : null;
    }

    if (window.AFL) {
      // Save original shared.js navigate if it exists
      const _origNavigate = window.AFL.navigate;
      // Override navigation to route through shell
      window.AFL.navigate = (view, opts) => {
        if (opts && opts.id != null) STATE.selectedOfferingId = opts.id;
        // Write to sessionStorage so modules can read via getNavParams()
        try {
          sessionStorage.setItem('afl_nav_params', JSON.stringify({ module: view, params: opts || {} }));
        } catch(e) {}
        navigateTo(view === 'offering' ? 'offering_detail' : view, opts && opts.id);
      };
      // Add shell toast
      window.AFL.toast = (msg, type) => showToast(msg, type || '');
      // Add shell suitability scoring (uses shell's STATE.client)
      window.AFL.suitLabel = window.AFL.suitLabel || ((score) => suitLabel(score));
      // Sync shell's selected offering
      Object.defineProperty(window.AFL, 'selectedId', {
        get() { return STATE.selectedOfferingId; },
        set(id) { STATE.selectedOfferingId = id; },
        configurable: true
      });

      // ── CRITICAL: Override AFL.state.client and AFL.client to return
      //    shell's client data translated to shared.js format.
      //    Without this, modules read shared.js's empty defaults. ──
      Object.defineProperty(window.AFL.state, 'client', {
        get() { return clientForModules(); },
        set(v) { /* ignore — shell owns client state */ },
        configurable: true
      });
      Object.defineProperty(window.AFL, 'client', {
        get() { return clientForModules(); },
        set(v) { /* ignore — shell owns client state */ },
        configurable: true
      });
       // Expose shell peer stats so modules get the same peer data as dashboard
      Object.defineProperty(window.AFL, 'peer', {
        get() { return STATE.peer; },
        configurable: true
      });
    } else {
      // Fallback: shared.js didn't load — build full bridge from shell data
      console.warn('[AFL Shell] shared.js not loaded — using shell bridge');

      // clientForModules() defined above (shared by both branches)

      window.AFL = {
        funds:     STATE.funds,
        peer:      STATE.peer,
        state:     { funds: STATE.funds, get client() { return clientForModules(); } },
        get client() { return clientForModules(); },
        set client(v) { STATE.client = v; updateClientBadge(); },
        basket: {
          ids:    STATE.ui.basketBuilder.selectedIds,
          add(id)    { STATE.ui.basketBuilder.selectedIds.add(id); showToast('Added to basket ✓', 'success'); },
          remove(id) { STATE.ui.basketBuilder.selectedIds.delete(id); },
          get()      { return STATE.funds.filter(f => STATE.ui.basketBuilder.selectedIds.has(f.id)); },
          has(id)    { return STATE.ui.basketBuilder.selectedIds.has(id); },
          count()    { return STATE.ui.basketBuilder.selectedIds.size; }
        },
        navigate(view, opts) {
          if (opts && opts.id != null) STATE.selectedOfferingId = opts.id;
          navigateTo(view === 'offering' ? 'offering_detail' : view, opts && opts.id);
        },
        fmt: {
          pct(n, dec=2)  { return n == null ? '—' : n.toFixed(dec) + '%'; },
          money(n)       { return n == null ? '—' : '$' + Number(n).toLocaleString('en-US'); },
          short(n)       { return shortNum(n); },
          num(n, dec)    { return n == null ? '—' : (dec != null ? Number(n).toFixed(dec) : Number(n).toLocaleString('en-US')); },
          date(d)        { return d ? new Date(d).toLocaleDateString() : '—'; },
          str(v)         { return (v == null || v === '') ? '—' : String(v); }
        },
        suitScore(fund, client)  { return null; }, // shared.js not loaded — no scoring available
        suitLabel(score) { return suitLabel(score); },
        toast(msg, type) { showToast(msg, type || ''); },
        get selectedId()   { return STATE.selectedOfferingId; },
        set selectedId(id) { STATE.selectedOfferingId = id; },
        extractStates(str) {
          if (!str) return [];
          const abbrs = ['AL','AK','AZ','AR','CA','CO','CT','DE','FL','GA','HI','ID','IL','IN','IA','KS','KY','LA','ME','MD','MA','MI','MN','MS','MO','MT','NE','NV','NH','NJ','NM','NY','NC','ND','OH','OK','OR','PA','RI','SC','SD','TN','TX','UT','VT','VA','WA','WV','WI','WY'];
          return str.split(/[\s,()]+/).map(s=>s.trim().toUpperCase()).filter(s=>abbrs.includes(s));
        },
        escapeHTML(s) { return esc(s); },
        peerStats(funds) {
          const f = funds || STATE.funds;
          const avgOf = (arr, key) => {
            const vals = arr.map(x=>x[key]).filter(v=>v!=null&&!isNaN(v));
            return vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : null;
          };
          return {
            y1coc:     { avg: avgOf(f,'y1coc'),     min: Math.min(...f.map(x=>x.y1coc).filter(v=>v!=null)),     max: Math.max(...f.map(x=>x.y1coc).filter(v=>v!=null)) },
            ltv:       { avg: avgOf(f,'ltv'),        min: Math.min(...f.map(x=>x.ltv).filter(v=>v!=null)),       max: Math.max(...f.map(x=>x.ltv).filter(v=>v!=null)) },
            occupancy: { avg: avgOf(f,'occupancy'),  min: Math.min(...f.map(x=>x.occupancy).filter(v=>v!=null)), max: Math.max(...f.map(x=>x.occupancy).filter(v=>v!=null)) },
          };
        },
        async loadFunds() { /* shell already loaded funds via loadSheet */ },
        updateHeader() { updateClientBadge(); }
      };
    }

    // ── Parse the fetched HTML and extract body content + scripts ─────────
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');

    // Inject any <style> tags from the module's <head>
    doc.querySelectorAll('head style').forEach(s => {
      const style = document.createElement('style');
      style.textContent = s.textContent;
      document.head.appendChild(style);
    });

    // Mount the body HTML (scripts won't execute via innerHTML)
    el.innerHTML = doc.body.innerHTML;

    // Re-execute scripts in order so they actually run
    const scripts = doc.querySelectorAll('body script');
    for (const orig of scripts) {
      await new Promise((resolve, reject) => {
        const s = document.createElement('script');
        if (orig.src) {
          s.src = orig.src;
          s.onload  = resolve;
          s.onerror = reject;
        } else {
          s.textContent = orig.textContent;
          resolve();
        }
        document.body.appendChild(s);
      });
    }

    // Give the scripts one tick to finish synchronous setup, then call init
    await new Promise(r => setTimeout(r, 0));

    if (window.currentModule && typeof window.currentModule.init === 'function') {
      // Prefer shared.js state (correct field names) over shell STATE
      const aflState = window.AFL && window.AFL.state;
      // Read nav params so modules know which offering/context was requested
      let navParams = {};
      try {
        const raw = sessionStorage.getItem('afl_nav_params');
        if (raw) navParams = JSON.parse(raw).params || {};
      } catch(e) {}
      await window.currentModule.init({
        funds:   aflState ? aflState.funds  : STATE.funds,
        client:  clientForModules(),
        peer:    aflState ? window.AFL.peerStats() : STATE.peer,
        AFL:     window.AFL,
        params:  navParams
      });
    } else {
      throw new Error(`Module "${name}" did not export window.currentModule.init`);
    }

  } catch (err) {
    // Restore padding on error so the error message is readable
    main.style.padding  = '28px 32px';
    main.style.overflow = 'auto';
    el.style.height     = '';
    el.style.overflow   = '';
    el.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">⚠️</div>
        <h3>Failed to load ${name}</h3>
        <p>${err.message}</p>
        <button class="btn btn-secondary" onclick="navigateTo('dashboard')">← Back to Dashboard</button>
      </div>`;
    console.error('Module load error:', err);
  }
}

/* ═══════════════════════════════════════════
   COLUMN MAP
═══════════════════════════════════════════ */
function normalizeHeader(h) {
  if (!h) return '';
  return h.toString().toLowerCase().replace(/[^a-z0-9\s]/g,'').replace(/\s+/g,'_').trim();
}

function buildColumnMap(headers) {
  const map = {};
  const aliases = {
    offering_name:    ['offering_name','name','fund_name','offering','title'],
    sponsor:          ['sponsor','sponsor_name','sponsor_company'],
    structure:        ['structure','fund_structure','offering_structure'],
    asset_class:      ['asset_class','assetclass','property_type','class'],
    sector:           ['sector'],
    y1_coc:           ['y1_coc','year_1_coc','year1_coc','y1_cashoncash','cash_on_cash_year_1','coc_y1','year_1_cashoncash','year_1_cash_on_cash','year_1_cash_on_cash_distribution','y1_cash_on_cash','y1_cash_on_cash_distribution'],
    ltv:              ['ltv','loan_to_value','loantovalue'],
    minimum:          ['minimum','min_investment','minimum_investment','min','minimum_dst','minimum__dst'],
    equity_offered:   ['equity_offered','equity','total_equity','filed_raise'],
    remaining_raise:  ['remaining_raise','remaining','current_availability','remaining_raise_2'],
    current_raise:    ['current_raise','amount_raised'],
    hold_period:      ['hold_period','estimated_hold_period','hold'],
    preferred_return: ['preferred','preferred_return'],
    rep_comp:         ['rep_comp','compensation','broker_dealer_comp'],
    income_y1:        ['income_y1','y1_income','year1_income','distributions_y1','year_1'],
    income_y2:        ['income_y2','y2_income','year2_income','year_2'],
    income_y3:        ['income_y3','y3_income','year3_income','year_3','ear_3'],
    income_y4:        ['income_y4','y4_income','year4_income','year_4'],
    income_y5:        ['income_y5','y5_income','year5_income','year_5'],
    income_y6:        ['income_y6','y6_income','year6_income','year_6'],
    income_y7:        ['income_y7','y7_income','year7_income','year_7'],
    income_y8:        ['income_y8','y8_income','year8_income','year_8'],
    income_y9:        ['income_y9','y9_income','year9_income','year_9'],
    income_y10:       ['income_y10','y10_income','year10_income','year_10'],
    pct_leased:       ['pct_leased','percent_leased','occupancy','leased','_leased','avg_leased'],
    location:         ['location','property_location','city_state','property_locations'],
    num_assets:       ['num_assets','number_of_assets','num_properties','_assets'],
    avg_lease_term:   ['avg_lease_term','avg_lease_term_remaining','lease_term','average_lease_term_remaining'],
    tenant_credit:    ['tenant_credit','tenant_guarantor_credit','tenant_credit_quality'],
    purchase_price:   ['purchase_price','purchase_price_unloaded'],
    appraised_val:    ['appraised_val','appraised_valuation','appraisal'],
    loaded_price:     ['loaded_price'],
    unit_price:       ['unit_price'],
    open_date:        ['open','open_date','offering_open'],
    close_date:       ['close','close_date','offering_close'],
    months_on_market: ['months_on_market'],
    distribution_freq:['distribution_freq','distribution_frequency','frequency'],
    brochure_url:     ['brochure_url','brochure','brochure_link'],
    ppm_url:          ['ppm_url','ppm','ppm_link'],
    track_record_url: ['track_record_url','track_record'],
    sponsor_news_url: ['sponsor_news_url','sponsor_news'],
    sales_team_url:   ['sales_team_url','sales_team','sales_team_map'],
    is_dst:           ['is_dst','dst','dst_eligible','1031_dst'],
    has_debt:         ['has_debt','debt'],
    upreit:           ['upreit','721_upreit','721upreit'],
    sponsor_years:    ['sponsor_years','years_in_business'],
    sponsor_aum:      ['sponsor_aum','aum'],
    sponsor_exits:    ['sponsor_exits','full_cycle_exits','realized_deals','sponsor_full_cycle_exits'],
    sponsor_avg_irr:  ['sponsor_avg_irr','avg_net_irr','sponsor_average_irr'],
    gp_commit:        ['gp_commit'],
    dscr_base:        ['dscr_base','dscr'],
    dscr_stress:      ['dscr_stress'],
    irr_base:         ['irr_base','projected_irr'],
    irr_stress:       ['irr_stress'],
  };

  headers.forEach((h, idx) => {
    const norm = normalizeHeader(h);
    map[norm] = idx;
    Object.entries(aliases).forEach(([key, alts]) => {
      if (alts.includes(norm) && !(key in map)) map[key] = idx;
    });
  });
  return map;
}

function parsePercent(v) {
  if (v == null || v === '') return null;
  const s = v.toString().replace('%','').trim();
  const n = parseFloat(s);
  if (isNaN(n)) return null;
  return Math.abs(n) < 1 ? n * 100 : n;
}
function parseMoney(v) {
  if (v == null || v === '') return null;
  const s = v.toString().replace(/[$,\s]/g,'').trim().toUpperCase();
  const n = parseFloat(s);
  if (isNaN(n)) return null;
  if (s.endsWith('B')) return n * 1e9;
  if (s.endsWith('M')) return n * 1e6;
  if (s.endsWith('K')) return n * 1e3;
  return n;
}
function parseDate(v) {
  if (!v) return null;
  const d = new Date(v);
  return isNaN(d) ? null : d;
}

/* ═══════════════════════════════════════════
   DATA LAYER
═══════════════════════════════════════════ */
async function loadSheet() {
  try {
    setStatus('loading', 'Loading data…');
    const url = CONFIG.GVIZ_URL();
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();

    const jsonStr = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\)/)?.[1];
    if (!jsonStr) throw new Error('Invalid GViz response');
    const data = JSON.parse(jsonStr);
    if (data.status === 'error') throw new Error(data.errors?.[0]?.message || 'Sheet error');

    const table = data.table;
    STATE.headers = table.cols.map(c => c.label || c.id || '');
    STATE.colMap  = buildColumnMap(STATE.headers);

    STATE.funds = table.rows.map((row, idx) => {
      const r  = row.c || [];
      const cm = STATE.colMap;
      const gv = (key) => {
        const i = cm[key];
        if (i === undefined) return null;
        const cell = r[i];
        if (!cell) return null;
        return cell.v !== undefined ? cell.v : cell;
      };
      // Return formatted string (cell.f) — useful for money fields with M/B/K suffix
      const gvf = (key) => {
        const i = cm[key];
        if (i === undefined) return null;
        const cell = r[i];
        if (!cell) return null;
        return cell.f || (cell.v !== undefined ? cell.v : null);
      };

      const name = gv('offering_name') || gv('name') || `Offering ${idx+1}`;
      if (!name || name.toString().trim() === '') return null;

      return {
        id: idx + 1,
        name: name.toString().trim(),
        sponsor:   (gv('sponsor')    || '').toString().trim(),
        structure: (gv('structure')  || '').toString().trim(),
        assetClass:(gv('asset_class')|| '').toString().trim(),
        sector:    (gv('sector')     || '').toString().trim(),
        location:  (gv('location')   || '').toString().trim(),
        y1CoC:     parsePercent(gv('y1_coc')) ?? parsePercent(gv('income_y1')),
        ltv:       parsePercent(gv('ltv')),
        minimum:   gvf('minimum'),
        equityOffered:  gvf('equity_offered'),
        remainingRaise: gvf('remaining_raise'),
        currentRaise:   gvf('current_raise'),
        holdPeriod:  gv('hold_period'),
        preferred:   parsePercent(gv('preferred_return')),
        repComp:     parsePercent(gv('rep_comp')),
        pctLeased:   parsePercent(gv('pct_leased')),
        numAssets:   gv('num_assets'),
        avgLeaseTerm:gv('avg_lease_term'),
        tenantCredit:(gv('tenant_credit') || '').toString().trim(),
        purchasePrice:gvf('purchase_price'),
        appraisedVal: gvf('appraised_val'),
        loadedPrice:  gvf('loaded_price'),
        unitPrice:    gvf('unit_price'),
        openDate:    parseDate(gv('open_date')),
        closeDate:   parseDate(gv('close_date')),
        monthsOnMarket: gv('months_on_market'),
        distributionFreq:(gv('distribution_freq')||'').toString().trim(),
        isDST:    !!(gv('is_dst')),
        hasDebt:  !!(gv('has_debt')),
        hasUPREIT:!!(gv('upreit')),
        brochureUrl:   (gv('brochure_url')    ||'').toString().trim(),
        ppmUrl:        (gv('ppm_url')         ||'').toString().trim(),
        trackRecordUrl:(gv('track_record_url')||'').toString().trim(),
        sponsorNewsUrl:(gv('sponsor_news_url')||'').toString().trim(),
        salesTeamUrl:  (gv('sales_team_url')  ||'').toString().trim(),
        sponsorYears:  gv('sponsor_years'),
        sponsorAUM:    gvf('sponsor_aum'),
        sponsorExits:  gv('sponsor_exits'),
        sponsorAvgIRR: parsePercent(gv('sponsor_avg_irr')),
        gpCommit:      gv('gp_commit'),
        dscrBase:      gv('dscr_base'),
        dscrStress:    gv('dscr_stress'),
        irrBase:       parsePercent(gv('irr_base')),
        irrStress:     parsePercent(gv('irr_stress')),
        gp_commit_pct: parsePercent(gv('gp_commit')),
        income: [1,2,3,4,5,6,7,8,9,10].map(y => parsePercent(gv(`income_y${y}`) || gv(`y${y}_coc`))),
      };
    }).filter(Boolean);

    computePeerStats();
    STATE.loading   = false;
    STATE.loadError = null;
    setStatus('ok', `${STATE.funds.length} offerings loaded`);
    showToast(`✓ ${STATE.funds.length} offerings loaded from Google Sheets`, 'success');
    render();

  } catch (err) {
    console.error('Sheet load error:', err);
    STATE.loading   = false;
    STATE.loadError = err.message;
    setStatus('error', `Load failed: ${err.message}`);
    render();
  }
}

function computePeerStats() {
  const funds = STATE.funds;
  const avg = arr => { const v = arr.map(x => typeof x === 'string' ? parseMoney(x) : x).filter(x=>x!=null && isFinite(x)); return v.length ? v.reduce((a,b)=>a+b,0)/v.length : null; };
  STATE.peer = {
    avgY1CoC:  avg(funds.map(f=>f.y1CoC)),
    avgLTV:    avg(funds.map(f=>f.ltv)),
    avgMin:    avg(funds.map(f=>f.minimum)),
    avgLeased: avg(funds.map(f=>f.pctLeased)),
    totalOfferings: funds.length,
    sponsors:    [...new Set(funds.map(f=>f.sponsor).filter(Boolean))],
    assetClasses:[...new Set(funds.map(f=>f.assetClass).filter(Boolean))],
    structures:  [...new Set(funds.map(f=>f.structure).filter(Boolean))],
  };
}

/* ═══════════════════════════════════════════
   SUITABILITY SCORING — delegates to shared.js
   AFL.suitScore() is the single source of truth.
   This wrapper translates shell STATE.client → shared.js format.
═══════════════════════════════════════════ */
function getClientForScoring() {
  const c = STATE.client;
  if (!c || !c.clientName) return null;
  return {
    name:            c.clientName,
    exchangeAmount:  c.exchangeEquity || null,
    riskTolerance:   c.riskTolerance || '',
    propTypes:       c.assetClassPreference ? [c.assetClassPreference] : [],
    horizon:         c.investmentHorizon || null,
    age:             c.age || null,
    accredited:      c.accredited !== null ? c.accredited : true,
    _shell: {
      structurePreference:    c.structurePreference || {},
      debtReplacementTarget:  c.debtReplacementTarget,
      incomeNeeded:           c.incomeNeeded,
      taxBracket:             c.taxBracket,
      geographicPreference:   c.geographicPreference,
      advisorFirmName:        c.advisorFirmName,
      investmentHorizon:      c.investmentHorizon,
    }
  };
}

function calcSuitabilityScore(fund) {
  if (!window.AFL || !window.AFL.suitScore) return null;
  const client = getClientForScoring();
  if (!client) return null;
  const r = window.AFL.suitScore(fund, client, STATE.peer);
  return r;
}

function suitLabel(score) {
  if (score == null) return null;
  if (score >= 75) return { cls: 'high',   label: `${score}% Match` };
  if (score >= 50) return { cls: 'medium', label: `${score}% Match` };
  return { cls: 'low', label: `${score}% Match` };
}

/* ═══════════════════════════════════════════
   STATUS & TOAST
═══════════════════════════════════════════ */
function setStatus(state, text) {
  document.getElementById('status-dot').className = 'pulse-dot ' + state;
  document.getElementById('status-text').textContent = text;
}

function showToast(msg, type = '') {
  const c = document.getElementById('toast-container');
  const t = document.createElement('div');
  t.className = `toast toast-${type}`;
  t.textContent = msg;
  c.appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateX(20px)'; t.style.transition = '0.3s'; }, 2800);
  setTimeout(() => t.remove(), 3100);
}

/* ═══════════════════════════════════════════
   MODE & NAVIGATION
═══════════════════════════════════════════ */
const NAV_ADVISOR = [
  { id: 'dashboard',      icon: '⌂', label: 'Dashboard' },
  { id: 'browse',         icon: '⊞', label: 'Browse Offerings' },
  { id: 'offering_detail',icon: '◉', label: 'Offering Detail', hidden: true },
  { id: 'basket',         icon: '◧', label: 'Basket Builder' },
  { id: 'portfolio',      icon: '⬡', label: 'Portfolio Builder' },
  { id: 'intelligence',   icon: '✦', label: 'Offering Intel' },
   'divider',
  { section: 'Compliance & Training' },
  { id: 'testing',        icon: '✎', label: 'Certifications' },
  'divider',
  { section: 'Calculators' },
  { id: 'calc_dst',       icon: '∑', label: '1031 DST Calculator' },
  { id: 'calc_fund',      icon: '⧖', label: 'Private Fund Comparison' },
  { id: 'calc_optimizer', icon: '◎', label: 'Allocation Optimizer' },
  { id: 'calc_irr',       icon: '↗', label: 'IRR & MOIC Calculator' },
];

const NAV_CLIENT_REPORT = [
  { id: 'report_comparison', icon: '≡', label: 'Comparison Report' },
  { id: 'report_offering',   icon: '□', label: 'Offering Report' },
  { id: 'report_portfolio',  icon: '◈', label: 'Portfolio Summary' },
];

const NAV_COMPLIANCE = [
  { id: 'diligence',        icon: '⚑', label: 'Offering Diligence' },
  { id: 'bd_analytics',     icon: '⊞', label: 'BD Analytics' },
  { id: 'platform_overview',icon: '◉', label: 'Platform Overview' },
];

const NAV_MAP = { advisor: NAV_ADVISOR, client_report: NAV_CLIENT_REPORT, compliance: NAV_COMPLIANCE };

// Views that load external .html modules
const MODULE_VIEWS = {
  browse:          'browse',
  offering_detail: 'offering',
  portfolio:       'builder',
  calc_dst:        'model',
    testing:         'testing',
  // basket not yet migrated to separate file
  // Add more as you migrate: basket: 'basket', intelligence: 'intelligence', etc.
};

function switchMode(mode) {
  STATE.activeMode = mode;
  const defaults  = { advisor: 'dashboard', client_report: 'report_comparison', compliance: 'diligence' };
  STATE.activeView = defaults[mode];
  renderNav();
  renderViewContent();
  document.querySelectorAll('.view-btn').forEach(b => b.classList.toggle('active', b.dataset.view === mode));
  const sidebar = document.getElementById('sidebar');
  const main    = document.getElementById('main');
  sidebar.className = mode === 'compliance' ? 'compliance-mode' : mode === 'client_report' ? 'report-mode' : '';
  main.className    = mode === 'compliance' ? 'compliance-mode' : '';
}

function navigateTo(view, offeringId) {
  // Restore #main padding/overflow if leaving a full-screen module
  if (MODULE_VIEWS[STATE.activeView]) {
    const main = document.getElementById('main');
    main.style.padding  = '';
    main.style.overflow = '';
  }

  STATE.viewHistory.push(STATE.activeView);
  STATE.activeView = view;
  if (offeringId != null) {
    STATE.selectedOfferingId = offeringId;
    // Write to sessionStorage so modules read the correct offering
    try {
      sessionStorage.setItem('afl_nav_params', JSON.stringify({
        module: view === 'offering_detail' ? 'offering' : view,
        params: { id: offeringId, ids: [offeringId] }
      }));
    } catch(e) {}
  }
  renderNav();

  // If this view is a loadable module, delegate to loadModule
  if (MODULE_VIEWS[view]) {
    loadModule(MODULE_VIEWS[view]);
    return;
  }

  renderViewContent();
}

/* ═══════════════════════════════════════════
   NAV RENDERING
═══════════════════════════════════════════ */
function renderNav() {
  const navItems  = NAV_MAP[STATE.activeMode];
  const container = document.getElementById('nav-' + STATE.activeMode);

  ['advisor','client_report','compliance'].forEach(m => {
    const el = document.getElementById('nav-' + m);
    if (el) el.style.display = m === STATE.activeMode ? '' : 'none';
  });

  if (!container) return;
  container.innerHTML = '';

  let section = document.createElement('div');
  section.className = 'nav-section';
  container.appendChild(section);

  navItems.forEach(item => {
    if (item === 'divider') {
      section = document.createElement('div');
      section.className = 'nav-section';
      container.appendChild(section);
      return;
    }
    if (item.section) {
      const label = document.createElement('div');
      label.className  = 'nav-label';
      label.textContent = item.section;
      section.appendChild(label);
      return;
    }
    if (item.hidden && STATE.activeView !== item.id) return;

    const btn = document.createElement('button');
    btn.className = 'nav-item' + (STATE.activeView === item.id ? ' active' : '');
    btn.innerHTML = `<span class="nav-icon">${item.icon}</span><span>${item.label}</span>`;
    btn.onclick   = () => navigateTo(item.id);
    section.appendChild(btn);
  });
}

/* ═══════════════════════════════════════════
   MASTER RENDER ENGINE
═══════════════════════════════════════════ */
function render() {
  renderNav();
  renderViewContent();
  updateClientBadge();
}

function renderViewContent() {
  const el = document.getElementById('view-content');
  const main = document.getElementById('main');
  el.className = 'fade-in';
  void el.offsetWidth;

  // Reset module styles when rendering a shell view
  if (!MODULE_VIEWS[STATE.activeView]) {
    main.style.padding  = '';
    main.style.overflow = '';
    el.style.height     = '';
    el.style.overflow   = '';
  }

  if (STATE.loading)   { el.innerHTML = renderLoading(); return; }
  if (STATE.loadError) { el.innerHTML = renderError();   return; }

  const view = STATE.activeView;

  // If it's a module view, loadModule handles it (called from navigateTo)
  // But if we get here directly (e.g. on reload), trigger it
  if (MODULE_VIEWS[view]) { loadModule(MODULE_VIEWS[view]); return; }

  if (view === 'dashboard')         el.innerHTML = renderDashboard();
  else if (view === 'browse')       el.innerHTML = renderBrowse();
  else if (view === 'offering_detail') el.innerHTML = renderOfferingDetail();
  else if (view === 'basket')       el.innerHTML = renderComingSoon('Basket Builder',         '◧', 'Migrating existing Basket Builder tool (Step 6)');
  else if (view === 'intelligence') el.innerHTML = renderComingSoon('Offering Intelligence',  '✦', 'AI narrative due diligence summaries (Step 9)');
  else if (view === 'calc_dst')     el.innerHTML = renderComingSoon('1031 DST Calculator',   '∑', 'Calculator migration coming in Step 12');
  else if (view === 'calc_fund')    el.innerHTML = renderComingSoon('Private Fund Comparison','⧖', 'Calculator migration coming in Step 12');
  else if (view === 'calc_optimizer') el.innerHTML = renderComingSoon('Allocation Optimizer','◎', 'Efficient Frontier Optimizer — migration Step 12');
  else if (view === 'calc_irr')     el.innerHTML = renderComingSoon('IRR & MOIC Calculator', '↗', 'Calculator migration coming in Step 12');
  else if (view === 'testing')      el.innerHTML = renderComingSoon('Certifications', '✎', 'Knowledge Assessment & Certification Testing');   
  else if (view === 'report_comparison') el.innerHTML = renderComingSoon('Comparison Report', '≡', 'Fund Comparison Reports migration (Step 8)');
  else if (view === 'report_offering')   el.innerHTML = renderComingSoon('Offering Report',   '□', 'Single-offering client presentation (Step 10)');
  else if (view === 'report_portfolio')  el.innerHTML = renderComingSoon('Portfolio Summary', '◈', 'Clean blended portfolio output (Step 7)');
  else if (view === 'diligence')         el.innerHTML = renderComingSoon('Offering Diligence','⚑', 'Full compliance report migration (Step 10)', true);
  else if (view === 'bd_analytics')      el.innerHTML = renderComingSoon('BD Analytics',      '⊞', 'Big Data Analytics tool migration (Step 11)', true);
  else if (view === 'platform_overview') el.innerHTML = renderComingSoon('Platform Overview', '◉', 'Cross-offering metrics dashboard (Step 13)', true);
  else el.innerHTML = `<div class="empty-state"><div class="empty-state-icon">🚧</div><h3>Coming Soon</h3><p>View <code>${view}</code> is in progress.</p></div>`;

  attachViewHandlers(view);
}

/* ═══════════════════════════════════════════
   LOADING / ERROR / COMING SOON
═══════════════════════════════════════════ */
function renderLoading() {
  return `
    <div class="page-header">
      <div>
        <div class="skeleton" style="width:200px;height:26px;margin-bottom:6px"></div>
        <div class="skeleton" style="width:280px;height:14px"></div>
      </div>
    </div>
    <div class="quick-stats">
      ${[0,1,2,3].map(()=>`<div class="skeleton" style="height:72px;border-radius:8px"></div>`).join('')}
    </div>
    <div class="offering-grid">
      ${[0,1,2,3,4,5].map(()=>`<div class="skeleton-card skeleton"></div>`).join('')}
    </div>`;
}

function renderError() {
  return `
    <div class="empty-state">
      <div class="empty-state-icon">⚠️</div>
      <h3>Could not load offering data</h3>
      <p>${STATE.loadError}</p>
      <p style="font-size:12px;color:var(--fog);margin-top:8px">Make sure the Google Sheet is publicly accessible (View access).</p>
      <button class="btn btn-primary" onclick="location.reload()">Retry</button>
    </div>`;
}

function renderComingSoon(title, icon, note, compliance = false) {
  return `
    <div class="page-header">
      <div>
        <div class="page-title">${icon} ${title}</div>
        <div class="page-subtitle">Phase 1 build in progress</div>
      </div>
    </div>
    <div class="panel" style="text-align:center;padding:48px;border-style:dashed">
      <div style="font-size:42px;margin-bottom:16px">${icon}</div>
      <div style="font-size:18px;font-weight:700;color:var(--navy);margin-bottom:8px">${title}</div>
      <div style="font-size:13px;color:var(--slate2);max-width:400px;margin:0 auto 20px;line-height:1.6">${note}</div>
      <div class="badge badge-navy" style="margin:0 auto">🏗 Migration Pending</div>
    </div>`;
}

/* ═══════════════════════════════════════════
   DASHBOARD VIEW
═══════════════════════════════════════════ */
function renderDashboard() {
  const funds = STATE.funds;
  const c = STATE.client;
  const hasProfile = !!c.clientName;

  const scored   = funds.map(f => ({ ...f, suitScore: calcSuitabilityScore(f) }));
  const topFunds = hasProfile
    ? [...scored].sort((a,b) => (b.suitScore||0) - (a.suitScore||0)).slice(0,5)
    : scored.slice(0,5);

  const totalEquity = funds.reduce((s,f) => {
    const n = parseMoney(f.remainingRaise);
    return s + (n || 0);
  }, 0);
  const avgCoC      = STATE.peer.avgY1CoC;
  const sponsors    = STATE.peer.sponsors?.length || 0;

  return `
    <div class="page-header">
      <div>
        <div class="page-title">Dashboard</div>
        <div class="page-subtitle">
          ${hasProfile
            ? `Client workflow — ${c.clientName} · ${c.advisorFirmName || 'Advisor'}`
            : 'Set up a client profile to unlock suitability rankings'}
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-secondary btn-sm" onclick="navigateTo('browse')">⊞ Browse All</button>
        ${!hasProfile ? `<button class="btn btn-primary btn-sm" onclick="openProfileModal()">＋ Set Up Client</button>` : ''}
      </div>
    </div>

    <div class="quick-stats">
      <div class="stat-card"><div class="stat-val">${funds.length}</div><div class="stat-label">Live Offerings</div></div>
      <div class="stat-card"><div class="stat-val">${sponsors}</div><div class="stat-label">Sponsors</div></div>
      <div class="stat-card"><div class="stat-val">${avgCoC != null ? avgCoC.toFixed(1)+'%' : '—'}</div><div class="stat-label">Avg Y1 CoC</div></div>
      <div class="stat-card"><div class="stat-val">${totalEquity > 0 ? '$'+shortNum(totalEquity) : '—'}</div><div class="stat-label">Total Equity</div></div>
    </div>

    <div class="dashboard-grid">
      <div>${hasProfile ? renderProfileCard(c) : renderStartHereCard()}</div>
      <div>
        <div class="suggested-header">
          <div>
            <div class="suggested-title">${hasProfile ? '★ Suggested for ' + c.clientName : 'Top Offerings'}</div>
            <div class="suggested-sub">${hasProfile ? 'Ranked by suitability score' : 'Set up a client profile for personalized rankings'}</div>
          </div>
          <button class="btn btn-ghost btn-sm" onclick="navigateTo('browse')">View all →</button>
        </div>
        <div style="display:flex;flex-direction:column;gap:10px">
          ${topFunds.length === 0
            ? `<div class="empty-state"><div class="empty-state-icon">📋</div><h3>No offerings loaded</h3><p>Check sheet connection above.</p></div>`
            : topFunds.map(f => renderDashboardOfferingRow(f)).join('')}
        </div>
      </div>
    </div>`;
}

function renderProfileCard(c) {
  return `
    <div class="profile-card">
      <div class="profile-card-header">
        <h3>Client Profile</h3>
        <div class="profile-card-name">${esc(c.clientName)}</div>
        ${c.advisorFirmName ? `<div class="profile-card-firm">${esc(c.advisorFirmName)}</div>` : ''}
      </div>
      <div class="profile-card-body">
        ${c.exchangeEquity          ? profileRow('Exchange Equity',     fmtMoney(c.exchangeEquity))      : ''}
        ${c.debtReplacementTarget   ? profileRow('Debt Replacement',    fmtMoney(c.debtReplacementTarget)): ''}
        ${c.incomeNeeded            ? profileRow('Annual Income Needed',fmtMoney(c.incomeNeeded))         : ''}
        ${c.riskTolerance           ? profileRow('Risk Tolerance',      c.riskTolerance.charAt(0).toUpperCase()+c.riskTolerance.slice(1)) : ''}
        ${c.age                     ? profileRow('Age / Timeline',      `${c.age} yrs`)                  : ''}
        ${c.taxBracket              ? profileRow('Tax Bracket',         c.taxBracket)                    : ''}
        ${c.assetClassPreference    ? profileRow('Asset Class Pref.',   c.assetClassPreference)          : ''}
        ${c.geographicPreference    ? profileRow('Geographic Pref.',    c.geographicPreference)          : ''}
        ${Object.values(c.structurePreference).some(Boolean)
          ? profileRow('Structure Prefs.', Object.entries(c.structurePreference).filter(([,v])=>v).map(([k])=>k.replace(/([A-Z])/g,' $1')).join(', '))
          : ''}
      </div>
      <div class="profile-card-footer">
        <button class="btn btn-secondary btn-sm" onclick="openProfileModal()" style="flex:1">✎ Edit Profile</button>
        <button class="btn btn-ghost btn-sm" onclick="clearProfile()">Clear</button>
      </div>
    </div>`;
}

function profileRow(k, v) {
  return `<div class="profile-row"><span class="profile-key">${k}</span><span class="profile-val">${v}</span></div>`;
}

function renderStartHereCard() {
  return `
    <div class="start-here-card">
      <div class="start-here-icon">👤</div>
      <div class="start-here-title">Start Here: Client Profile</div>
      <div class="start-here-text">Enter your client's exchange equity, income needs, and preferences to unlock suitability scoring across all ${STATE.funds.length} offerings.</div>
      <button class="btn btn-primary" onclick="openProfileModal()" style="width:100%">＋ Set Up Client Profile</button>
    </div>`;
}

function renderDashboardOfferingRow(fund) {
  const suit = suitLabel(fund.suitScore);
  const _eq = parseMoney(fund.equityOffered), _cr = parseMoney(fund.currentRaise);
  const raiseProgress = _eq && _cr
    ? Math.min(100, Math.round((_cr / _eq) * 100)) : null;

  return `
    <div class="panel" style="padding:14px 18px;cursor:pointer;transition:all 0.18s"
         onclick="navigateTo('offering_detail', ${fund.id})"
         onmouseenter="this.style.borderColor='var(--slate2)';this.style.boxShadow='var(--shadow)'"
         onmouseleave="this.style.borderColor='';this.style.boxShadow=''">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
        <div style="flex:1;min-width:0">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:3px;flex-wrap:wrap">
            <span style="font-size:14px;font-weight:700;color:var(--navy)">${esc(fund.name)}</span>
            ${suit ? `<span class="suit-score ${suit.cls}">${suit.label}</span>` : ''}
          </div>
          <div style="font-size:12px;color:var(--slate2);margin-bottom:6px">
            ${fund.sponsor   ? `<b style="color:var(--slate)">${esc(fund.sponsor)}</b>` : ''}
            ${fund.assetClass? ` · ${esc(fund.assetClass)}` : ''}
            ${fund.structure ? ` · ${esc(fund.structure)}`  : ''}
          </div>
          ${raiseProgress != null ? `
            <div style="display:flex;align-items:center;gap:6px">
              <div class="raise-bar" style="flex:1;max-width:120px"><div class="raise-fill" style="width:${raiseProgress}%"></div></div>
              <span style="font-size:11px;color:var(--fog)">${raiseProgress}% raised</span>
            </div>` : ''}
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;flex-shrink:0">
          ${miniMetric('Y1 CoC', fund.y1CoC != null ? fund.y1CoC.toFixed(2)+'%' : '—')}
          ${miniMetric('LTV',    fund.ltv    != null ? fund.ltv.toFixed(0)+'%'  : '—')}
          ${miniMetric('Min',    fund.minimum!= null ? '$'+shortNum(fund.minimum): '—')}
        </div>
      </div>
    </div>`;
}

function miniMetric(label, value) {
  return `
    <div style="background:var(--surface);border-radius:6px;padding:6px 8px;text-align:center;min-width:54px">
      <div style="font-size:10px;font-weight:600;color:var(--fog);text-transform:uppercase;letter-spacing:0.06em">${label}</div>
      <div style="font-size:14px;font-weight:700;color:var(--navy)">${value}</div>
    </div>`;
}

/* ═══════════════════════════════════════════
   BROWSE VIEW
═══════════════════════════════════════════ */
function renderBrowse() {
  const ui = STATE.ui.browse;
  const allFunds = STATE.funds;
  const sponsors    = [...new Set(allFunds.map(f=>f.sponsor).filter(Boolean))].sort();
  const assetClasses= [...new Set(allFunds.map(f=>f.assetClass).filter(Boolean))].sort();
  const structures  = [...new Set(allFunds.map(f=>f.structure).filter(Boolean))].sort();

  let funds = allFunds.filter(f => {
    if (ui.dstOnly && !f.isDST && !f.structure?.toLowerCase().includes('dst')) return false;
    if (ui.noDebt  && f.ltv > 0)  return false;
    if (ui.upreit  && !f.hasUPREIT) return false;
    if (ui.filterSponsor    && f.sponsor    !== ui.filterSponsor)    return false;
    if (ui.filterAssetClass && f.assetClass !== ui.filterAssetClass) return false;
    if (ui.filterStructure  && f.structure  !== ui.filterStructure)  return false;
    if (ui.search) {
      const q = ui.search.toLowerCase();
      if (!f.name.toLowerCase().includes(q) && !f.sponsor?.toLowerCase().includes(q) && !f.assetClass?.toLowerCase().includes(q)) return false;
    }
    return true;
  });

  const hasProfile = !!STATE.client.clientName;
  if (hasProfile) {
    funds = funds.map(f => ({...f, suitScore: calcSuitabilityScore(f)})).sort((a,b)=>(b.suitScore||0)-(a.suitScore||0));
  }

  return `
    <div class="page-header">
      <div>
        <div class="page-title">⊞ Browse Offerings</div>
        <div class="page-subtitle">${funds.length} of ${allFunds.length} offerings${hasProfile ? ' · Sorted by suitability' : ''}</div>
      </div>
    </div>

    <div class="filter-bar">
      <input class="search-input" type="text" placeholder="Search offerings, sponsors…"
             value="${esc(ui.search)}" oninput="STATE.ui.browse.search=this.value;renderViewContent()" />
      <span class="filter-tag ${ui.dstOnly?'active':''}" onclick="STATE.ui.browse.dstOnly=!STATE.ui.browse.dstOnly;renderViewContent()">DST Only</span>
      <span class="filter-tag ${ui.noDebt ?'active':''}" onclick="STATE.ui.browse.noDebt=!STATE.ui.browse.noDebt;renderViewContent()">No Debt</span>
      <span class="filter-tag ${ui.upreit ?'active':''}" onclick="STATE.ui.browse.upreit=!STATE.ui.browse.upreit;renderViewContent()">721 UpREIT</span>
      <select class="filter-select" onchange="STATE.ui.browse.filterSponsor=this.value;renderViewContent()">
        <option value="">All Sponsors</option>
        ${sponsors.map(s=>`<option value="${esc(s)}" ${ui.filterSponsor===s?'selected':''}>${esc(s)}</option>`).join('')}
      </select>
      <select class="filter-select" onchange="STATE.ui.browse.filterAssetClass=this.value;renderViewContent()">
        <option value="">All Asset Classes</option>
        ${assetClasses.map(a=>`<option value="${esc(a)}" ${ui.filterAssetClass===a?'selected':''}>${esc(a)}</option>`).join('')}
      </select>
      <select class="filter-select" onchange="STATE.ui.browse.filterStructure=this.value;renderViewContent()">
        <option value="">All Structures</option>
        ${structures.map(s=>`<option value="${esc(s)}" ${ui.filterStructure===s?'selected':''}>${esc(s)}</option>`).join('')}
      </select>
      ${(ui.dstOnly||ui.noDebt||ui.upreit||ui.filterSponsor||ui.filterAssetClass||ui.filterStructure||ui.search)
        ? `<button class="btn btn-ghost btn-sm" onclick="STATE.ui.browse={search:'',filterStructure:'',filterAssetClass:'',filterSponsor:'',dstOnly:false,noDebt:false,upreit:false};renderViewContent()">✕ Clear</button>`
        : ''}
    </div>

    ${funds.length === 0
      ? `<div class="empty-state"><div class="empty-state-icon">🔍</div><h3>No results</h3><p>Adjust your filters to find offerings.</p></div>`
      : `<div class="offering-grid">${funds.map((f,i) => renderOfferingCard(f,i)).join('')}</div>`}`;
}

function renderOfferingCard(fund, idx) {
  const suit = suitLabel(fund.suitScore);
  const raiseProgress = (() => {
    const eq = parseMoney(fund.equityOffered), cr = parseMoney(fund.currentRaise);
    return eq && cr ? Math.min(100, Math.round((cr / eq)*100)) : null;
  })();

  const badges = [
    fund.structure && `<span class="badge badge-navy">${esc(fund.structure)}</span>`,
    fund.assetClass && `<span class="pill">${esc(fund.assetClass)}</span>`,
    fund.isDST    && `<span class="badge badge-blue">DST</span>`,
    fund.hasUPREIT && `<span class="badge badge-purple">721 UpREIT</span>`,
  ].filter(Boolean).join('');

  return `
    <div class="offering-card card-enter" style="animation-delay:${idx*0.04}s"
         onclick="navigateTo('offering_detail', ${fund.id})">
      <div class="offering-card-header">
        <div>
          <div class="offering-name">${esc(fund.name)}</div>
          <div class="offering-sponsor">${esc(fund.sponsor || '—')}</div>
        </div>
        ${suit ? `<span class="suit-score ${suit.cls}" style="flex-shrink:0">${suit.label}</span>` : ''}
      </div>
      <div class="offering-badges">${badges}</div>
      <div class="offering-metrics">
        <div class="offering-metric-item"><div class="label">Y1 CoC</div><div class="value">${fund.y1CoC != null ? fund.y1CoC.toFixed(2)+'%' : '—'}</div></div>
        <div class="offering-metric-item"><div class="label">LTV</div><div class="value">${fund.ltv != null ? fund.ltv.toFixed(0)+'%' : '—'}</div></div>
        <div class="offering-metric-item"><div class="label">Minimum</div><div class="value" style="font-size:13px">${fund.minimum != null ? '$'+shortNum(fund.minimum) : '—'}</div></div>
        <div class="offering-metric-item"><div class="label">Hold</div><div class="value" style="font-size:13px">${fund.holdPeriod || '—'}</div></div>
      </div>
      ${fund.location ? `<div class="offering-location">📍 ${esc(fund.location)}</div>` : ''}
      ${raiseProgress != null ? `
        <div style="margin-bottom:10px">
          <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--fog);margin-bottom:4px">
            <span>Raise Progress</span><span>${raiseProgress}%</span>
          </div>
          <div class="raise-bar"><div class="raise-fill" style="width:${raiseProgress}%"></div></div>
        </div>` : ''}
      <div class="offering-card-footer">
        <span style="font-size:11px;color:var(--fog)">${fund.pctLeased != null ? `${fund.pctLeased.toFixed(0)}% leased` : ''}</span>
        <div style="display:flex;gap:6px">
          <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation();addToBasket(${fund.id})">+ Basket</button>
          <button class="btn btn-primary btn-sm"   onclick="event.stopPropagation();navigateTo('offering_detail',${fund.id})">Detail →</button>
        </div>
      </div>
    </div>`;
}

/* ═══════════════════════════════════════════
   OFFERING DETAIL VIEW
═══════════════════════════════════════════ */
function renderOfferingDetail() {
  const fund = STATE.funds.find(f => f.id === STATE.selectedOfferingId);
  if (!fund) {
    return `<div class="empty-state">
      <div class="empty-state-icon">🔍</div>
      <h3>No Offering Selected</h3>
      <p>Select an offering from Browse or Dashboard.</p>
      <button class="btn btn-primary" onclick="navigateTo('browse')">Browse Offerings</button>
    </div>`;
  }

  const suit      = suitLabel(calcSuitabilityScore(fund));
  const delta_coc = STATE.peer.avgY1CoC && fund.y1CoC != null ? fund.y1CoC - STATE.peer.avgY1CoC : null;

  const docBtns = [
    { label: 'Brochure',    url: fund.brochureUrl },
    { label: 'PPM',         url: fund.ppmUrl },
    { label: 'Track Record',url: fund.trackRecordUrl },
    { label: 'Sponsor News',url: fund.sponsorNewsUrl },
    { label: 'Sales Team',  url: fund.salesTeamUrl },
  ].filter(d => d.url);

  return `
    <div style="max-width:1000px">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:20px">
        <button class="btn btn-ghost btn-sm" onclick="navigateTo('browse')">← Back</button>
        <span style="color:var(--fog);font-size:12px">Browse ›</span>
        <span style="font-size:12px;color:var(--slate)">${esc(fund.name)}</span>
      </div>

      <!-- Hero -->
      <div class="panel" style="background:linear-gradient(135deg,var(--navy) 0%,var(--navy2) 60%,#2A5298 100%);border:none;margin-bottom:16px;padding:24px 28px;position:relative;overflow:hidden">
        <div style="position:absolute;right:0;top:0;width:300px;height:100%;background:rgba(255,255,255,0.02);clip-path:polygon(30% 0%,100% 0%,100% 100%,0% 100%)"></div>
        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px;position:relative">
          <div>
            <div style="font-size:10px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:rgba(255,255,255,0.4);margin-bottom:6px">${esc(fund.sponsor||'')}</div>
            <div style="font-size:24px;font-weight:800;color:#fff;letter-spacing:-0.02em;margin-bottom:8px">${esc(fund.name)}</div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
              ${fund.structure ? `<span class="badge" style="background:rgba(255,255,255,0.15);color:rgba(255,255,255,0.9)">${esc(fund.structure)}</span>` : ''}
              ${fund.assetClass? `<span class="badge" style="background:rgba(255,255,255,0.10);color:rgba(255,255,255,0.7)">${esc(fund.assetClass)}</span>` : ''}
              ${fund.isDST     ? `<span class="badge badge-blue" style="background:#1D4ED8">1031 DST</span>` : ''}
              ${suit           ? `<span class="suit-score ${suit.cls}">${suit.label}</span>` : ''}
            </div>
          </div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;flex-shrink:0">
            ${heroMetric('Y1 CoC', fund.y1CoC   != null ? fund.y1CoC.toFixed(2)+'%' : '—')}
            ${heroMetric('LTV',    fund.ltv      != null ? fund.ltv.toFixed(0)+'%'   : '—')}
            ${heroMetric('Min',    fund.minimum  != null ? '$'+shortNum(fund.minimum) : '—')}
            ${heroMetric('Hold',   fund.holdPeriod || '—')}
          </div>
        </div>
      </div>

      ${docBtns.length > 0 ? `
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px">
          <span style="font-size:12px;font-weight:600;color:var(--fog);align-self:center;text-transform:uppercase;letter-spacing:0.06em">Documents:</span>
          ${docBtns.map(d=>`<a href="${esc(d.url)}" target="_blank" class="btn btn-secondary btn-sm">↗ ${d.label}</a>`).join('')}
        </div>` : ''}

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:24px">
        <button class="btn btn-primary"   onclick="addToBasket(${fund.id});showToast('Added to basket ✓','success')">◧ Add to Basket</button>
        <button class="btn btn-secondary" onclick="navigateTo('portfolio')">⬡ Build Portfolio</button>
        <button class="btn btn-secondary" onclick="navigateTo('calc_dst')">∑ Model for This Client</button>
        <button class="btn btn-ghost"     onclick="switchMode('compliance');STATE.activeView='diligence';renderNav();renderViewContent()">⚑ Compliance Report</button>
      </div>

      <!-- Key Metrics -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-title">Key Metrics</div>
        <div class="metric-grid">
          ${fund.y1CoC    != null ? metricTile('Y1 Cash-on-Cash',       fund.y1CoC.toFixed(2)+'%',  delta_coc != null ? `${delta_coc>0?'+':''}${delta_coc.toFixed(2)}% vs peer avg` : null, delta_coc != null ? (delta_coc>=0?'green':'red') : '') : ''}
          ${fund.ltv      != null ? metricTile('Loan-to-Value',          fund.ltv.toFixed(0)+'%')   : ''}
          ${fund.minimum  != null ? metricTile('Minimum Investment',     '$'+fmtNum(fund.minimum))   : ''}
          ${fund.equityOffered!=null? metricTile('Total Equity Offered', '$'+shortNum(fund.equityOffered)): ''}
          ${fund.pctLeased!= null ? metricTile('% Leased / Occupied',   fund.pctLeased.toFixed(1)+'%', fund.pctLeased>=95?'Strong occupancy':null, fund.pctLeased>=95?'green':fund.pctLeased>=85?'':'amber') : ''}
          ${fund.holdPeriod       ? metricTile('Est. Hold Period',       fund.holdPeriod)            : ''}
          ${fund.preferred!= null ? metricTile('Preferred Return',       fund.preferred.toFixed(2)+'%'): ''}
          ${fund.repComp  != null ? metricTile('Rep Compensation',       fund.repComp.toFixed(2)+'%'): ''}
          ${fund.avgLeaseTerm     ? metricTile('Avg Lease Term Rem.',    fund.avgLeaseTerm)          : ''}
          ${fund.numAssets        ? metricTile('# Properties',           fund.numAssets)             : ''}
          ${fund.distributionFreq ? metricTile('Distribution Freq.',     fund.distributionFreq)      : ''}
          ${fund.tenantCredit     ? metricTile('Tenant Credit',          fund.tenantCredit)          : ''}
        </div>
      </div>

      <!-- Narratives -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-title">✦ Investment Opportunity Overview <span style="font-size:10px;font-weight:400;color:var(--fog);letter-spacing:0;text-transform:none">(AI narrative — Phase 1 template)</span></div>
        <div style="font-size:13.5px;line-height:1.75;color:var(--navy)">${generateNarrativeOverview(fund)}</div>
      </div>

      <div class="panel" style="margin-bottom:16px">
        <div class="panel-title">🏢 Property & Market Fundamentals</div>
        <div style="font-size:13.5px;line-height:1.75;color:var(--navy)">${generateNarrativeProperty(fund)}</div>
      </div>

      <div class="panel" style="margin-bottom:16px">
        <div class="panel-title">💰 Financial Structure & Returns</div>
        <div style="font-size:13.5px;line-height:1.75;color:var(--navy)">${generateNarrativeFinancial(fund)}</div>
      </div>

      <!-- Q&A placeholder -->
      <div class="panel" style="margin-bottom:16px">
        <div class="panel-title">💬 Ask Questions</div>
        <div style="font-size:12.5px;color:var(--slate2);margin-bottom:12px">Phase 2: Live Claude API. Common due diligence questions:</div>
        <div style="display:flex;flex-wrap:wrap;gap:8px">
          ${['What is the debt structure?','How does the 721 UpREIT option work?','What are the exit assumptions?','Who is the tenant?','How is cash flow supported?','What is the fee structure?']
            .map(q=>`<button class="btn btn-secondary btn-sm" onclick="showToast('Live Q&A coming in Phase 2 — AI proxy required','')">🔒 ${q}</button>`).join('')}
        </div>
      </div>

      <!-- Sponsor -->
      ${(fund.sponsor || fund.sponsorYears || fund.sponsorAvgIRR) ? `
        <div class="panel" style="margin-bottom:16px">
          <div class="panel-title">🏛 Sponsor Track Record</div>
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px">
            ${fund.sponsor       ? metricTile('Sponsor',          fund.sponsor)                          : ''}
            ${fund.sponsorYears  ? metricTile('Years in Business',fund.sponsorYears)                     : ''}
            ${fund.sponsorAUM    ? metricTile('AUM',              '$'+shortNum(fund.sponsorAUM))          : ''}
            ${fund.sponsorExits  ? metricTile('Realized Exits',   fund.sponsorExits)                     : ''}
            ${fund.sponsorAvgIRR!= null ? metricTile('Avg Net IRR', fund.sponsorAvgIRR.toFixed(1)+'%')  : ''}
          </div>
        </div>` : ''}
    </div>`;
}

function heroMetric(label, value) {
  return `
    <div style="background:rgba(255,255,255,0.10);border-radius:8px;padding:10px 12px;text-align:center;min-width:72px">
      <div style="font-size:10px;font-weight:600;color:rgba(255,255,255,0.45);text-transform:uppercase;letter-spacing:0.07em;margin-bottom:2px">${label}</div>
      <div style="font-size:19px;font-weight:800;color:#fff">${value}</div>
    </div>`;
}

function metricTile(label, value, sub, color) {
  const colors = { green: 'border-color:var(--green);background:var(--green-lt)', amber: 'border-color:var(--amber);background:var(--amber-lt)', red: 'border-color:var(--red);background:var(--red-lt)', '': '' };
  const style = color && colors[color] ? colors[color] : '';
  return `
    <div class="metric-tile" style="${style}">
      <div class="metric-label">${label}</div>
      <div class="metric-value" style="font-size:18px">${value}</div>
      ${sub ? `<div class="metric-sub" style="${color==='green'?'color:var(--green)':color==='red'?'color:var(--red)':''}">${sub}</div>` : ''}
    </div>`;
}

/* ═══════════════════════════════════════════
   AI NARRATIVE TEMPLATES
═══════════════════════════════════════════ */
function generateNarrativeOverview(f) {
  const parts = [];
  if (f.name && f.sponsor) parts.push(`${esc(f.name)} is ${f.structure?'a <strong>'+esc(f.structure)+'</strong>':'an offering'} sponsored by <strong>${esc(f.sponsor)}</strong>.`);
  if (f.assetClass || f.sector) parts.push(`The investment is focused on <strong>${esc(f.assetClass||f.sector)}</strong>${f.sector&&f.assetClass?' within the '+esc(f.sector)+' sector':''}.`);
  if (f.location) parts.push(`Properties are located in <strong>${esc(f.location)}</strong>.`);
  if (f.numAssets) parts.push(`The portfolio comprises <strong>${f.numAssets} ${parseInt(f.numAssets)===1?'asset':'assets'}</strong>.`);
  if (f.equityOffered) parts.push(`Total equity offered is <strong>$${fmtNum(f.equityOffered)}</strong>${f.minimum?', with a minimum investment of <strong>$'+fmtNum(f.minimum)+'</strong>':''}.`);
  if (f.holdPeriod) parts.push(`The estimated hold period is <strong>${esc(f.holdPeriod.toString())}</strong>.`);
  return parts.length ? parts.join(' ') : '<em style="color:var(--fog)">Narrative data pending — complete offering data entry in Google Sheet.</em>';
}

function generateNarrativeProperty(f) {
  const parts = [];
  if (f.pctLeased != null) { const occ = f.pctLeased>=95?'near-full':f.pctLeased>=85?'strong':'partial'; parts.push(`The portfolio maintains <strong>${f.pctLeased.toFixed(1)}% occupancy</strong> — ${occ} occupancy relative to typical stabilized assets.`); }
  if (f.avgLeaseTerm) parts.push(`Average remaining lease term is <strong>${esc(f.avgLeaseTerm.toString())}</strong>.`);
  if (f.tenantCredit) parts.push(`Tenant guarantor credit is rated <strong>${esc(f.tenantCredit)}</strong>.`);
  if (f.purchasePrice && f.appraisedVal) { const pp=parseMoney(f.purchasePrice),av=parseMoney(f.appraisedVal); if(pp&&av){ const disc = ((av-pp)/av*100).toFixed(1); const pos = parseFloat(disc)>=0; parts.push(`The purchase price of <strong>${fmtMoney(f.purchasePrice)}</strong> represents a <strong>${Math.abs(parseFloat(disc))}% ${pos?'discount':'premium'}</strong> to the appraised value of <strong>${fmtMoney(f.appraisedVal)}</strong>.`); }}
  return parts.length ? parts.join(' ') : '<em style="color:var(--fog)">Property data pending — complete offering data entry in Google Sheet.</em>';
}

function generateNarrativeFinancial(f) {
  const parts = [];
  if (f.y1CoC != null) { const vs = STATE.peer.avgY1CoC?(f.y1CoC>STATE.peer.avgY1CoC?' above':' at or below')+' the platform average of '+STATE.peer.avgY1CoC.toFixed(2)+'%':''; parts.push(`Year 1 cash-on-cash return is projected at <strong>${f.y1CoC.toFixed(2)}%</strong>${vs}.`); }
  if (f.ltv  != null) { const lvl = f.ltv>60?'higher-leverage':f.ltv>35?'moderate':f.ltv===0?'all-equity (debt-free)':'conservative'; parts.push(`The offering employs <strong>${lvl} financing</strong> at <strong>${f.ltv.toFixed(0)}% LTV</strong>.`); }
  if (f.preferred != null) parts.push(`A preferred return of <strong>${f.preferred.toFixed(2)}%</strong> is offered to investors.`);
  if (f.dscrBase) parts.push(`Base case DSCR is <strong>${f.dscrBase}</strong>${f.dscrStress?', with stressed DSCR of <strong>'+f.dscrStress+'</strong>':''}.`);
  if (f.repComp  != null) parts.push(`Broker-dealer compensation is <strong>${f.repComp.toFixed(2)}%</strong>.`);
  return parts.length ? parts.join(' ') : '<em style="color:var(--fog)">Financial data pending — complete offering data entry in Google Sheet.</em>';
}

/* ═══════════════════════════════════════════
   BASKET HELPER
═══════════════════════════════════════════ */
function addToBasket(id) {
  STATE.ui.basketBuilder.selectedIds.add(id);
  showToast('Added to basket', 'success');
}

/* ═══════════════════════════════════════════
   CLIENT PROFILE MODAL
═══════════════════════════════════════════ */
function openProfileModal() {
  const c  = STATE.client;
  const sp = c.structurePreference;

  document.getElementById('modal-container').innerHTML = `
    <div class="modal-overlay" id="profile-modal-overlay" onclick="if(event.target===this)closeProfileModal()">
      <div class="modal">
        <div class="modal-header">
          <div>
            <div class="modal-title">👤 Client Profile</div>
            <div class="modal-subtitle">Entered once — flows through all tools automatically</div>
          </div>
          <button class="modal-close" onclick="closeProfileModal()">✕</button>
        </div>
        <div class="modal-body">
          <div class="form-section-label">Client & Advisor</div>
          <div class="form-grid" style="margin-bottom:16px">
            <div class="form-group">
              <label class="form-label">Client Name <span>(required)</span></label>
              <input class="form-input" id="f-clientName" type="text" placeholder="Jane Smith" value="${esc(c.clientName)}" required />
            </div>
            <div class="form-group">
              <label class="form-label">Advisor Firm <span>(optional)</span></label>
              <input class="form-input" id="f-advisorFirm" type="text" placeholder="XYZ Capital" value="${esc(c.advisorFirmName)}" />
            </div>
          </div>

          <div class="form-section-label">Exchange / Investment</div>
          <div class="form-grid" style="margin-bottom:16px">
            <div class="form-group">
              <label class="form-label">Exchange Equity</label>
              <input class="form-input" id="f-equity" type="text" placeholder="$500,000" value="${c.exchangeEquity ? '$'+fmtNum(c.exchangeEquity) : ''}" />
            </div>
            <div class="form-group">
              <label class="form-label">Debt Replacement Target</label>
              <input class="form-input" id="f-debt" type="text" placeholder="$300,000" value="${c.debtReplacementTarget ? '$'+fmtNum(c.debtReplacementTarget) : ''}" />
            </div>
            <div class="form-group">
              <label class="form-label">Annual Income Needed</label>
              <input class="form-input" id="f-income" type="text" placeholder="$30,000" value="${c.incomeNeeded ? '$'+fmtNum(c.incomeNeeded) : ''}" />
            </div>
            <div class="form-group">
              <label class="form-label">Min Investment Preference</label>
              <input class="form-input" id="f-minPref" type="text" placeholder="$25,000" value="${c.minInvestmentPreference ? '$'+fmtNum(c.minInvestmentPreference) : ''}" />
            </div>
          </div>

          <div class="form-section-label">Client Parameters</div>
          <div class="form-grid" style="margin-bottom:16px">
            <div class="form-group">
              <label class="form-label">Risk Tolerance</label>
              <select class="form-select" id="f-risk">
                <option value="">Select…</option>
                <option value="low"    ${c.riskTolerance==='low'   ?'selected':''}>Low</option>
                <option value="medium" ${c.riskTolerance==='medium'?'selected':''}>Medium</option>
                <option value="high"   ${c.riskTolerance==='high'  ?'selected':''}>High</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Age</label>
              <input class="form-input" id="f-age" type="number" placeholder="65" min="18" max="99" value="${c.age||''}" />
            </div>
            <div class="form-group">
              <label class="form-label">Tax Bracket</label>
              <select class="form-select" id="f-tax">
                <option value="">Select…</option>
                ${['10%','12%','22%','24%','32%','35%','37%'].map(t=>`<option value="${t}" ${c.taxBracket===t?'selected':''}>${t}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Accredited Investor</label>
              <select class="form-select" id="f-accredited">
                <option value="">Select…</option>
                <option value="yes" ${c.accredited===true?'selected':''}>Yes</option>
                <option value="no" ${c.accredited===false?'selected':''}>No</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Investment Horizon</label>
              <select class="form-select" id="f-horizon">
                <option value="">Select…</option>
                <option value="3-5" ${c.investmentHorizon==='3-5'?'selected':''}>3–5 years</option>
                <option value="5-7" ${c.investmentHorizon==='5-7'?'selected':''}>5–7 years</option>
                <option value="7-10" ${c.investmentHorizon==='7-10'?'selected':''}>7–10 years</option>
                <option value="10+" ${c.investmentHorizon==='10+'?'selected':''}>10+ years</option>
              </select>
            </div>
          </div>

          <div class="form-section-label">Preferences</div>
          <div style="margin-bottom:14px">
            <div class="form-label" style="margin-bottom:8px">Structure Preferences</div>
            <div class="checkbox-group">
              <label class="checkbox-pill ${sp.dstOnly?'checked':''}" id="pill-dst"    onclick="togglePill('pill-dst','f-dstOnly')">
                <input type="checkbox" id="f-dstOnly" ${sp.dstOnly?'checked':''} /> DST Only
              </label>
              <label class="checkbox-pill ${sp.noDebt?'checked':''}"  id="pill-nodebt" onclick="togglePill('pill-nodebt','f-noDebt')">
                <input type="checkbox" id="f-noDebt"  ${sp.noDebt?'checked':''} /> No Debt
              </label>
              <label class="checkbox-pill ${sp.upreit?'checked':''}"  id="pill-upreit" onclick="togglePill('pill-upreit','f-upreit')">
                <input type="checkbox" id="f-upreit"  ${sp.upreit?'checked':''} /> 721 UpREIT
              </label>
            </div>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Asset Class Preference</label>
              <select class="form-select" id="f-assetClass">
                <option value="">No preference</option>
                ${(STATE.peer.assetClasses||[]).map(a=>`<option value="${esc(a)}" ${c.assetClassPreference===a?'selected':''}>${esc(a)}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Geographic Preference</label>
              <input class="form-input" id="f-geo" type="text" placeholder="e.g. Southeast, Texas" value="${esc(c.geographicPreference)}" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ghost" onclick="closeProfileModal()">Cancel</button>
          <button class="btn btn-primary" onclick="saveProfile()" style="min-width:120px">Save Profile →</button>
        </div>
      </div>
    </div>`;
}

function togglePill(pillId, inputId) {
  const pill  = document.getElementById(pillId);
  const input = document.getElementById(inputId);
  if (!pill || !input) return;
  setTimeout(() => { pill.classList.toggle('checked', input.checked); }, 0);
}

function saveProfile() {
  const v   = id => { const el = document.getElementById(id); return el ? el.value.trim() : ''; };
  const chk = id => { const el = document.getElementById(id); return el ? el.checked : false; };
  const name = v('f-clientName');
  if (!name) { showToast('Client name is required', 'error'); return; }

  STATE.client = {
    ...STATE.client,
    clientName:           name,
    advisorFirmName:      v('f-advisorFirm'),
    exchangeEquity:       parseMoney(v('f-equity')),
    debtReplacementTarget:parseMoney(v('f-debt')),
    incomeNeeded:         parseMoney(v('f-income')),
    minInvestmentPreference: parseMoney(v('f-minPref')),
    riskTolerance:        v('f-risk') || null,
    age:                  v('f-age') ? parseInt(v('f-age')) : null,
    taxBracket:           v('f-tax') || null,
    accredited:           v('f-accredited') === 'yes' ? true : v('f-accredited') === 'no' ? false : null,
    investmentHorizon:    v('f-horizon') || '',
    assetClassPreference: v('f-assetClass'),
    geographicPreference: v('f-geo'),
    structurePreference:  { dstOnly: chk('f-dstOnly'), noDebt: chk('f-noDebt'), upreit: chk('f-upreit') }
  };

  // ── SYNC TO shared.js so offering/browse/builder modules see the client ──
  syncClientToShared();

  closeProfileModal();
  updateClientBadge();
  showToast(`Client profile saved — ${name}`, 'success');

  // Notify modules to re-render with new client data
  window.dispatchEvent(new CustomEvent('afl:header-update', {
    detail: { clientName: name }
  }));

  renderViewContent();
}

function closeProfileModal() {
  document.getElementById('modal-container').innerHTML = '';
}

function clearProfile() {
  if (!confirm('Clear the current client profile?')) return;
  STATE.client = {
    clientName: '', advisorFirmName: '',
    exchangeEquity: null, debtReplacementTarget: null,
    incomeNeeded: null, riskTolerance: null, age: null, taxBracket: null,
    accredited: null, investmentHorizon: '',
    existingHoldings: [], structurePreference: { dstOnly: false, noDebt: false, upreit: false },
    assetClassPreference: '', geographicPreference: '', minInvestmentPreference: null
  };
  // ── SYNC CLEAR TO shared.js ──
  if (window.AFL && window.AFL.client && window.AFL.client.clear) {
    window.AFL.client.clear();
  } else {
    try { localStorage.removeItem('afl_client'); } catch(e) {}
  }

  updateClientBadge();
  window.dispatchEvent(new CustomEvent('afl:header-update', { detail: { clientName: '' } }));
  renderViewContent();
  showToast('Client profile cleared');
}

function updateClientBadge() {
  const c    = STATE.client;
  const icon = document.getElementById('client-badge-icon');
  const name = document.getElementById('badge-name');
  const eq   = document.getElementById('badge-equity');

  if (c.clientName) {
    const initials = c.clientName.split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
    icon.textContent = initials;
    icon.style.background = 'linear-gradient(135deg,#059669,#10B981)';
    name.textContent = c.clientName;
    eq.textContent   = c.exchangeEquity ? '$'+shortNum(c.exchangeEquity)+' equity' : 'Profile set';
  } else {
    icon.textContent  = '?';
    icon.style.background = '';
    name.textContent  = 'No Client';
    eq.textContent    = 'Set up client profile';
  }
}

function attachViewHandlers(view) {}

/* ═══════════════════════════════════════════
   FORMATTING UTILITIES
═══════════════════════════════════════════ */
function esc(s) {
  if (!s) return '';
  return s.toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function fmtNum(n)   {
  if (n == null) return '—';
  if (typeof n === 'string' && /\$/.test(n)) return n.replace(/^\$\s*/,'');
  return Number(n).toLocaleString('en-US');
}
function fmtMoney(n) {
  if (n == null) return '—';
  if (typeof n === 'string' && /\$/.test(n)) return n;
  return '$' + Number(n).toLocaleString('en-US');
}
function shortNum(n) {
  if (n == null) return '—';
  if (typeof n === 'string' && /\$/.test(n)) return n.replace(/^\$\s*/,'');
  if (n >= 1e9) return (n/1e9).toFixed(1)+'B';
  if (n >= 1e6) return (n/1e6).toFixed(1)+'M';
  if (n >= 1e3) return (n/1e3).toFixed(0)+'K';
  return n.toLocaleString();
}

/* ═══════════════════════════════════════════
   CLIENT PROFILE SYNC (shell ↔ shared.js)
═══════════════════════════════════════════ */
function syncClientToShared() {
  const c = STATE.client;
  const sharedData = {
    name:            c.clientName,
    exchangeAmount:  c.exchangeEquity,
    riskTolerance:   c.riskTolerance || '',
    propTypes:       c.assetClassPreference ? [c.assetClassPreference] : [],
    horizon:         c.investmentHorizon || null,
    age:             c.age,
    accredited:      c.accredited !== null ? c.accredited : true,
    notes:           c.advisorFirmName || '',
    _shell: {
      debtReplacementTarget:  c.debtReplacementTarget,
      incomeNeeded:           c.incomeNeeded,
      taxBracket:             c.taxBracket,
      geographicPreference:   c.geographicPreference,
      minInvestmentPreference: c.minInvestmentPreference,
      structurePreference:    c.structurePreference,
      advisorFirmName:        c.advisorFirmName,
      investmentHorizon:      c.investmentHorizon,
    }
  };
  if (window.AFL && window.AFL.client && window.AFL.client.set) {
    window.AFL.client.set(sharedData);
  } else {
    try { localStorage.setItem('afl_client', JSON.stringify(sharedData)); } catch(e) {}
  }
}

function hydrateClientFromStorage() {
  try {
    const raw = localStorage.getItem('afl_client');
    if (!raw) return;
    const saved = JSON.parse(raw);
    if (!saved || !saved.name) return;
    const shell = saved._shell || {};
    STATE.client = {
      clientName:              saved.name || '',
      advisorFirmName:         shell.advisorFirmName || saved.notes || '',
      exchangeEquity:          saved.exchangeAmount || null,
      debtReplacementTarget:   shell.debtReplacementTarget || null,
      incomeNeeded:            shell.incomeNeeded || null,
      riskTolerance:           saved.riskTolerance || null,
      age:                     saved.age || null,
      taxBracket:              shell.taxBracket || null,
      accredited:              saved.accredited !== undefined ? saved.accredited : null,
      investmentHorizon:       saved.horizon || shell.investmentHorizon || '',
      existingHoldings:        [],
      structurePreference:     shell.structurePreference || { dstOnly: false, noDebt: false, upreit: false },
      assetClassPreference:    (Array.isArray(saved.propTypes) && saved.propTypes[0]) || '',
      geographicPreference:    shell.geographicPreference || '',
      minInvestmentPreference: shell.minInvestmentPreference || null,
    };
    console.log('[AFL Shell] Hydrated client from localStorage:', STATE.client.clientName);
  } catch(e) {
    console.warn('[AFL Shell] Could not hydrate client:', e);
  }
}

/* ═══════════════════════════════════════════
   INIT
═══════════════════════════════════════════ */
document.addEventListener('DOMContentLoaded', () => {
  window._aflShellActive = true;  // tells modules not to self-init
  hydrateClientFromStorage();
  // Sync client to shared.js so modules see the profile
  if (STATE.client.clientName) syncClientToShared();
  renderNav();
  renderViewContent();
  updateClientBadge();
  loadSheet();
});
</script>
</body>
</html>
