<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Alts Fund Link — Platform</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=DM+Mono:wght@400;500&family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --navy:#0B1F3B;--navy2:#1C3A63;--navy3:#2A4D7A;--slate:#3A5270;--slate2:#5C7A99;
  --fog:#8FA3BA;--mist:#C8D8E8;--ice:#E8F0F8;--white:#FFFFFF;--surface:#F4F7FB;--surface2:#EEF3FA;
  --green:#1A7A4A;--green-lt:#E8F7EF;--amber:#B45309;--amber-lt:#FEF3C7;
  --red:#991B1B;--red-lt:#FEE2E2;--blue:#1D4ED8;--blue-lt:#EFF6FF;
  --comp-accent:#7C3AED;--comp-lt:#F5F3FF;--report-accent:#0D7490;--report-lt:#ECFEFF;
  --radius:8px;--radius-lg:14px;--radius-xl:20px;
  --shadow-sm:0 1px 3px rgba(11,31,59,0.08),0 1px 2px rgba(11,31,59,0.06);
  --shadow:0 4px 12px rgba(11,31,59,0.10),0 2px 4px rgba(11,31,59,0.06);
  --shadow-lg:0 12px 32px rgba(11,31,59,0.14),0 4px 8px rgba(11,31,59,0.08);
  --shadow-xl:0 24px 64px rgba(11,31,59,0.18);
  --font:'DM Sans',sans-serif;--mono:'DM Mono',monospace;
  --header-h:60px;--nav-w:220px;--transition:0.18s cubic-bezier(0.4,0,0.2,1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{font-family:var(--font);font-size:14px;line-height:1.5;background:var(--surface);color:var(--navy);-webkit-font-smoothing:antialiased}
a{color:inherit;text-decoration:none}button{cursor:pointer;font-family:var(--font)}input,select,textarea{font-family:var(--font)}
#app{display:flex;flex-direction:column;height:100vh;overflow:hidden}
#header{height:var(--header-h);background:var(--navy);display:flex;align-items:center;padding:0 20px;gap:16px;flex-shrink:0;position:relative;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,0.25)}
#logo{display:flex;align-items:center;gap:10px;flex-shrink:0}
#logo-mark{width:32px;height:32px;background:linear-gradient(135deg,#3B82F6,#1D4ED8);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:#fff;letter-spacing:-0.5px}
#logo-text{font-size:14px;font-weight:600;color:#fff;letter-spacing:0.02em;line-height:1.2}
#logo-sub{font-size:10px;color:var(--fog);font-weight:400;letter-spacing:0.08em;text-transform:uppercase}
#view-toggle{display:flex;align-items:center;background:rgba(255,255,255,0.08);border-radius:8px;padding:3px;gap:2px;margin-left:12px}
.view-btn{display:flex;align-items:center;gap:6px;padding:5px 12px;border-radius:6px;border:none;background:transparent;color:var(--fog);font-size:12.5px;font-weight:500;letter-spacing:0.01em;transition:all var(--transition);white-space:nowrap}
.view-btn:hover{color:var(--white);background:rgba(255,255,255,0.10)}
.view-btn.active{background:var(--white);color:var(--navy);font-weight:600}
.view-btn.active.compliance{background:#DDD6FE;color:#4C1D95}
.view-btn.active.client-report{background:#CFFAFE;color:#164E63}
.view-dot{width:6px;height:6px;border-radius:50%;background:currentColor;opacity:0.5}
.view-btn.active .view-dot{opacity:1}
#client-badge{margin-left:auto;display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:5px 12px;cursor:pointer;transition:background var(--transition);flex-shrink:0}
#client-badge:hover{background:rgba(255,255,255,0.14)}
#client-badge-icon{width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,var(--navy3),var(--blue));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff}
#client-badge-text{font-size:12px;color:var(--white);font-weight:500}
#client-badge-text small{display:block;font-size:10px;color:var(--fog);font-weight:400}
#data-status{font-size:11px;color:var(--fog);display:flex;align-items:center;gap:6px;flex-shrink:0}
.pulse-dot{width:6px;height:6px;border-radius:50%;background:#34D399;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.4;transform:scale(0.8)}}
.pulse-dot.loading{background:#F59E0B;animation:spin-dot 0.8s linear infinite}
.pulse-dot.error{background:#F87171;animation:none}
@keyframes spin-dot{0%{transform:scale(0.6);opacity:0.5}50%{transform:scale(1);opacity:1}100%{transform:scale(0.6);opacity:0.5}}
#body-area{display:flex;flex:1;overflow:hidden}
#sidebar{width:var(--nav-w);background:var(--white);border-right:1px solid var(--mist);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0;transition:background var(--transition)}
#sidebar.compliance-mode{background:#FDFBFF;border-right-color:#DDD6FE}
#sidebar.report-mode{background:#FDFFFE;border-right-color:#A5F3FC}
.nav-section{padding:8px 0;border-bottom:1px solid var(--surface2)}
.nav-section:last-child{border-bottom:none;flex:1}
.nav-label{font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--fog);padding:8px 16px 4px}
.nav-item{display:flex;align-items:center;gap:9px;padding:8px 16px;font-size:13px;font-weight:500;color:var(--slate);cursor:pointer;border-radius:0;border:none;background:transparent;width:100%;text-align:left;transition:all var(--transition);position:relative}
.nav-item:hover{background:var(--surface);color:var(--navy)}
.nav-item.active{background:var(--ice);color:var(--navy);font-weight:600}
.nav-item.active::before{content:'';position:absolute;left:0;top:4px;bottom:4px;width:3px;background:var(--navy2);border-radius:0 2px 2px 0}
#sidebar.compliance-mode .nav-item.active{background:var(--comp-lt);color:#4C1D95}
#sidebar.compliance-mode .nav-item.active::before{background:var(--comp-accent)}
#sidebar.report-mode .nav-item.active{background:var(--report-lt);color:var(--report-accent)}
#sidebar.report-mode .nav-item.active::before{background:var(--report-accent)}
.nav-icon{font-size:14px;width:18px;text-align:center;flex-shrink:0}
.nav-badge{margin-left:auto;min-width:18px;height:18px;background:var(--navy2);color:#fff;border-radius:9px;font-size:10px;font-weight:700;display:inline-flex;align-items:center;justify-content:center;padding:0 5px}
#main{flex:1;overflow-y:auto;padding:28px 32px}
.page-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:16px;gap:16px}
.page-title{font-size:22px;font-weight:700;color:var(--navy);letter-spacing:-0.02em;line-height:1.2}
.page-subtitle{font-size:13px;color:var(--slate2);margin-top:3px}
.panel{background:var(--white);border:1px solid var(--mist);border-radius:var(--radius-lg);padding:20px 24px;box-shadow:var(--shadow-sm)}
.panel-title{font-size:13px;font-weight:700;letter-spacing:0.04em;text-transform:uppercase;color:var(--slate);margin-bottom:14px;display:flex;align-items:center;gap:8px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--radius);border:none;font-size:13px;font-weight:600;cursor:pointer;transition:all var(--transition);white-space:nowrap}
.btn-primary{background:var(--navy);color:var(--white)}.btn-primary:hover{background:var(--navy2)}
.btn-secondary{background:var(--white);color:var(--navy);border:1.5px solid var(--mist)}.btn-secondary:hover{border-color:var(--slate2);background:var(--surface)}
.btn-ghost{background:transparent;color:var(--slate2);border:1.5px solid transparent}.btn-ghost:hover{color:var(--navy);background:var(--surface)}
.btn-sm{padding:5px 10px;font-size:12px}
.btn-icon{padding:7px;border-radius:var(--radius);background:var(--surface);border:1px solid var(--mist);color:var(--slate);display:inline-flex;align-items:center;justify-content:center;font-size:14px;cursor:pointer;transition:all var(--transition)}
.btn-icon:hover{background:var(--ice);color:var(--navy);border-color:var(--slate2)}
.btn-icon.active{background:var(--navy);color:var(--white);border-color:var(--navy)}
.badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:20px;font-size:11px;font-weight:600;letter-spacing:0.02em}
.badge-green{background:var(--green-lt);color:var(--green)}.badge-amber{background:var(--amber-lt);color:var(--amber)}
.badge-red{background:var(--red-lt);color:var(--red)}.badge-blue{background:var(--blue-lt);color:var(--blue)}
.badge-navy{background:var(--ice);color:var(--navy2)}.badge-purple{background:#EDE9FE;color:#5B21B6}
.suit-score{display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:700;padding:3px 8px;border-radius:20px}
.suit-score.high{background:var(--green-lt);color:var(--green)}.suit-score.medium{background:var(--amber-lt);color:var(--amber)}.suit-score.low{background:var(--red-lt);color:var(--red)}
.metric-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
.metric-tile{background:var(--surface);border:1px solid var(--mist);border-radius:var(--radius);padding:14px 16px}
.metric-label{font-size:11px;font-weight:600;color:var(--fog);text-transform:uppercase;letter-spacing:0.07em;margin-bottom:4px}
.metric-value{font-size:22px;font-weight:700;color:var(--navy);letter-spacing:-0.02em;line-height:1}
.metric-sub{font-size:11px;color:var(--slate2);margin-top:3px}
.pill{display:inline-flex;align-items:center;padding:3px 8px;border-radius:20px;font-size:11.5px;font-weight:500;background:var(--surface2);color:var(--slate);border:1px solid var(--mist)}
.divider{height:1px;background:var(--mist);margin:16px 0}
.empty-state{text-align:center;padding:48px 24px;color:var(--slate2)}
.empty-state-icon{font-size:40px;margin-bottom:12px}
.empty-state h3{font-size:16px;font-weight:600;color:var(--navy);margin-bottom:6px}
.empty-state p{font-size:13px;line-height:1.6;max-width:360px;margin:0 auto 20px}
.offering-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:16px}
.offering-card{background:var(--white);border:1.5px solid var(--mist);border-radius:var(--radius-lg);padding:18px;cursor:pointer;transition:all var(--transition);position:relative;overflow:hidden}
.offering-card:hover{border-color:var(--slate2);box-shadow:var(--shadow);transform:translateY(-1px)}
.offering-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;gap:8px}
.offering-name{font-size:14px;font-weight:700;color:var(--navy);line-height:1.3;flex:1}
.offering-sponsor{font-size:11.5px;color:var(--slate2);margin-top:2px}
.offering-badges{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:12px}
.offering-metrics{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.offering-metric-item{background:var(--surface);border-radius:var(--radius);padding:8px 10px}
.offering-metric-item .label{font-size:10px;font-weight:600;color:var(--fog);text-transform:uppercase;letter-spacing:0.07em}
.offering-metric-item .value{font-size:16px;font-weight:700;color:var(--navy);letter-spacing:-0.02em}
.offering-location{font-size:12px;color:var(--slate2);display:flex;align-items:center;gap:4px;margin-bottom:10px}
.offering-card-footer{display:flex;justify-content:space-between;align-items:center;padding-top:10px;border-top:1px solid var(--surface2)}
.raise-bar{height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;margin-top:3px}
.raise-fill{height:100%;background:linear-gradient(90deg,var(--navy2),#3B82F6);border-radius:4px;animation:barFillIn 1.2s cubic-bezier(0.4,0,0.2,1) forwards}
.timeline-bar{height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;margin-top:3px}
.timeline-fill{height:100%;background:linear-gradient(90deg,#059669,#34D399);border-radius:4px;animation:barFillIn 1.2s cubic-bezier(0.4,0,0.2,1) 0.3s forwards}
@keyframes barFillIn{from{max-width:0}to{max-width:100%}}
.peer-delta{font-size:10px;font-weight:600;margin-top:2px}.peer-delta.up{color:var(--green)}.peer-delta.down{color:var(--red)}.peer-delta.neutral{color:var(--fog)}
.card-status-strip{position:absolute;top:0;left:0;right:0;height:5px}
.card-status-strip.open{background:var(--green)}.card-status-strip.closing{background:var(--amber)}.card-status-strip.coming{background:var(--blue)}
.offering-table{width:100%;border-collapse:collapse;font-size:13px}
.offering-table thead th{background:var(--surface2);padding:9px 12px;text-align:left;font-size:11px;font-weight:700;color:var(--slate2);text-transform:uppercase;letter-spacing:0.07em;border-bottom:1px solid var(--mist);white-space:nowrap;cursor:pointer;user-select:none;position:sticky;top:0;z-index:10}
.offering-table thead th:hover{color:var(--navy);background:var(--ice)}
.offering-table thead th.sorted{color:var(--navy)}.offering-table thead th.sorted .sort-arrow{opacity:1}
.sort-arrow{margin-left:4px;opacity:0.3;font-size:10px}
.offering-table tbody tr{border-bottom:1px solid var(--surface2);cursor:pointer;transition:background var(--transition)}
.offering-table tbody tr:hover{background:var(--surface)}.offering-table tbody tr:last-child{border-bottom:none}
.offering-table td{padding:10px 12px;vertical-align:middle}
.offering-table td.name-cell{font-weight:600;color:var(--navy)}
.offering-table td.num-cell{font-weight:400;font-family:var(--mono);font-size:12.5px}
.offering-table td.num-cell.highlight-green{color:var(--green)}.offering-table td.num-cell.highlight-red{color:var(--red)}
.table-wrapper{border:1px solid var(--mist);border-radius:var(--radius-lg);overflow:hidden;background:var(--white)}
.filter-bar{display:flex;align-items:center;gap:6px;margin-bottom:6px;flex-wrap:wrap}
.quick-filter-bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.quick-filter-label{font-size:11px;font-weight:700;color:var(--slate2);text-transform:uppercase;letter-spacing:.5px}
.quick-filter-btn{padding:5px 12px;border-radius:999px;border:1px solid var(--mist);background:var(--white);font-size:11px;font-weight:600;color:var(--navy);cursor:pointer;transition:all var(--transition);user-select:none}
.quick-filter-btn:hover{border-color:var(--navy3);background:var(--ice)}
.quick-filter-btn.active{background:var(--navy);color:var(--white);border-color:var(--navy);box-shadow:0 4px 12px rgba(11,31,59,0.2)}
.filter-divider{width:1px;height:22px;background:var(--mist);flex-shrink:0}
.filter-row-2{display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap}
.filter-tag{display:flex;align-items:center;gap:5px;padding:5px 12px;border:1.5px solid var(--mist);border-radius:20px;font-size:12.5px;font-weight:500;color:var(--slate);cursor:pointer;background:var(--white);transition:all var(--transition);user-select:none}
.filter-tag:hover{border-color:var(--slate2);color:var(--navy)}.filter-tag.active{border-color:var(--navy);background:var(--navy);color:var(--white)}
.filter-select{height:30px;padding:0 28px 0 10px;border:1.5px solid var(--mist);border-radius:20px;font-size:12px;color:var(--slate);background:var(--white);cursor:pointer;outline:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%235C7A99' d='M5 7L1 2h8z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;transition:border-color var(--transition)}
.filter-select:focus{border-color:var(--navy2)}
.search-input{flex:1;max-width:260px;height:30px;padding:0 12px 0 34px;border:1.5px solid var(--mist);border-radius:20px;font-size:12px;color:var(--navy);background:var(--white);outline:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%235C7A99' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:11px center;transition:border-color var(--transition)}
.search-input:focus{border-color:var(--navy2)}.search-input::placeholder{color:var(--fog)}
.view-toggle-group{display:flex;border:1.5px solid var(--mist);border-radius:8px;overflow:hidden}
.view-toggle-btn{padding:5px 10px;border:none;background:var(--white);color:var(--slate2);font-size:13px;cursor:pointer;transition:all var(--transition)}
.view-toggle-btn:hover{background:var(--surface);color:var(--navy)}.view-toggle-btn.active{background:var(--navy);color:var(--white)}
.sort-select{height:34px;padding:0 28px 0 10px;border:1.5px solid var(--mist);border-radius:8px;font-size:12.5px;color:var(--slate);background:var(--white);cursor:pointer;outline:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%235C7A99' d='M5 7L1 2h8z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;transition:border-color var(--transition)}
.sort-select:focus{border-color:var(--navy2)}
.result-bar{display:flex;align-items:center;gap:10px;margin-bottom:16px;font-size:12.5px;color:var(--slate2)}
.result-count{font-weight:700;color:var(--navy)}
.active-filter-chips{display:flex;gap:5px;flex-wrap:wrap}
.filter-chip{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;background:var(--ice);color:var(--navy2);border-radius:20px;font-size:11px;font-weight:600;border:1px solid var(--mist)}
.filter-chip button{background:none;border:none;color:var(--slate2);font-size:11px;padding:0;line-height:1;cursor:pointer;display:flex;align-items:center}
.filter-chip button:hover{color:var(--red)}
.range-filter{display:flex;align-items:center;gap:5px;height:30px;padding:0 10px;border:1.5px solid var(--mist);border-radius:20px;background:var(--white);font-size:11px;color:var(--slate)}
.range-filter input{width:40px;border:none;outline:none;font-size:11px;color:var(--navy);font-family:var(--mono);background:transparent;text-align:center;padding:0}
.range-filter span{color:var(--fog);font-size:11px;white-space:nowrap}
.equity-filter{display:flex;align-items:center;gap:5px;height:34px;padding:0 12px;border:1.5px solid var(--mist);border-radius:20px;background:var(--white);font-size:12.5px;color:var(--slate);cursor:pointer;transition:all var(--transition);user-select:none}
.equity-filter.active{border-color:var(--navy);background:var(--ice);color:var(--navy)}.equity-filter:hover{border-color:var(--slate2)}
.modal-overlay{position:fixed;inset:0;background:rgba(11,31,59,0.55);backdrop-filter:blur(4px);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn 0.2s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{background:var(--white);border-radius:var(--radius-xl);width:100%;max-width:620px;max-height:88vh;overflow-y:auto;box-shadow:var(--shadow-xl);animation:slideUp 0.22s cubic-bezier(0.34,1.56,0.64,1)}
@keyframes slideUp{from{transform:translateY(24px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-header{padding:24px 28px 18px;border-bottom:1px solid var(--mist);display:flex;justify-content:space-between;align-items:flex-start}
.modal-title{font-size:18px;font-weight:700;color:var(--navy);letter-spacing:-0.02em}
.modal-subtitle{font-size:13px;color:var(--slate2);margin-top:3px}
.modal-close{width:30px;height:30px;border-radius:50%;background:var(--surface);border:none;font-size:16px;color:var(--slate);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:-2px;transition:all var(--transition)}
.modal-close:hover{background:var(--ice);color:var(--navy)}
.modal-body{padding:24px 28px}.modal-footer{padding:16px 28px 24px;display:flex;justify-content:flex-end;gap:10px}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}.form-grid-full{grid-column:1/-1}
.form-group{display:flex;flex-direction:column;gap:5px}
.form-label{font-size:12px;font-weight:600;color:var(--slate);letter-spacing:0.02em}.form-label span{color:var(--fog);font-weight:400}
.form-input{height:38px;padding:0 12px;border:1.5px solid var(--mist);border-radius:var(--radius);font-size:13.5px;color:var(--navy);background:var(--white);transition:border-color var(--transition);outline:none;width:100%}
.form-input:focus{border-color:var(--navy2);box-shadow:0 0 0 3px rgba(28,58,99,0.08)}.form-input::placeholder{color:var(--fog)}
.form-select{height:38px;padding:0 32px 0 12px;border:1.5px solid var(--mist);border-radius:var(--radius);font-size:13.5px;color:var(--navy);background:var(--white);cursor:pointer;outline:none;width:100%;transition:border-color var(--transition);-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235C7A99' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
.form-select:focus{border-color:var(--navy2);box-shadow:0 0 0 3px rgba(28,58,99,0.08)}
.checkbox-group{display:flex;flex-wrap:wrap;gap:8px}
.checkbox-pill{display:flex;align-items:center;gap:6px;padding:6px 12px;border:1.5px solid var(--mist);border-radius:20px;cursor:pointer;font-size:12.5px;font-weight:500;color:var(--slate);transition:all var(--transition);background:var(--white);user-select:none;-webkit-user-select:none}
.checkbox-pill:hover{border-color:var(--slate2);color:var(--navy);background:var(--surface)}
.checkbox-pill input{width:0;height:0;opacity:0;position:absolute;pointer-events:none}
.checkbox-pill.checked{border-color:var(--navy2);background:var(--ice);color:var(--navy);font-weight:600}
.form-section-label{font-size:11px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--fog);margin-bottom:10px;margin-top:4px;padding-bottom:6px;border-bottom:1px solid var(--mist)}
.dashboard-grid{display:grid;grid-template-columns:340px 1fr;gap:20px;align-items:start}
.profile-card{background:var(--white);border:1.5px solid var(--mist);border-radius:var(--radius-lg);overflow:hidden}
.profile-card-header{background:linear-gradient(135deg,var(--navy) 0%,var(--navy2) 100%);padding:20px 22px;position:relative;overflow:hidden}
.profile-card-header::after{content:'';position:absolute;right:-30px;top:-30px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,0.04)}
.profile-card-header h3{font-size:13px;font-weight:700;color:rgba(255,255,255,0.5);letter-spacing:0.06em;text-transform:uppercase;margin-bottom:6px}
.profile-card-name{font-size:20px;font-weight:700;color:var(--white);letter-spacing:-0.02em}
.profile-card-firm{font-size:12.5px;color:rgba(255,255,255,0.55);margin-top:2px}
.profile-card-body{padding:18px 22px}
.profile-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--surface2)}.profile-row:last-child{border-bottom:none}
.profile-key{font-size:12px;color:var(--slate2);font-weight:500}.profile-val{font-size:13px;color:var(--navy);font-weight:600;text-align:right}
.profile-card-footer{padding:12px 22px 18px;display:flex;gap:8px}
.suggested-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.suggested-title{font-size:15px;font-weight:700;color:var(--navy)}.suggested-sub{font-size:12px;color:var(--slate2);margin-top:1px}
.quick-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.stat-card{background:var(--white);border:1px solid var(--mist);border-radius:var(--radius);padding:14px 16px;text-align:center}
.stat-val{font-size:26px;font-weight:800;color:var(--navy);letter-spacing:-0.03em;line-height:1}
.stat-label{font-size:11px;color:var(--slate2);font-weight:500;margin-top:4px;text-transform:uppercase;letter-spacing:0.06em}
.start-here-card{background:linear-gradient(135deg,#EFF6FF 0%,#E0F2FE 100%);border:1.5px dashed #93C5FD;border-radius:var(--radius-lg);padding:28px 24px;text-align:center}
.start-here-icon{font-size:36px;margin-bottom:12px}.start-here-title{font-size:16px;font-weight:700;color:var(--navy);margin-bottom:6px}
.start-here-text{font-size:13px;color:var(--slate);line-height:1.6;margin-bottom:18px}
/* STEP 5: Detail-specific */
.detail-section{margin-bottom:16px}
.detail-two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.detail-chart-wrap{position:relative;height:260px}
.detail-nav-strip{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;gap:8px}
.detail-nav-strip .breadcrumb{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--fog);flex:1;min-width:0}
.detail-nav-strip .breadcrumb .crumb-name{color:var(--slate);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px}
.detail-prev-next{display:flex;gap:4px;flex-shrink:0}
.detail-prev-next button{padding:5px 10px;border-radius:6px;border:1.5px solid var(--mist);background:var(--white);color:var(--slate);font-size:12px;font-weight:600;cursor:pointer;transition:all var(--transition);display:flex;align-items:center;gap:4px;max-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.detail-prev-next button:hover:not(:disabled){border-color:var(--navy2);color:var(--navy);background:var(--ice)}
.detail-prev-next button:disabled{opacity:0.35;cursor:default}
.kd-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.kd-item{display:flex;align-items:flex-start;gap:8px;padding:10px 12px;border-radius:var(--radius);background:var(--surface);border:1px solid var(--mist);font-size:12.5px;line-height:1.5;color:var(--navy)}
.kd-icon{font-size:14px;flex-shrink:0;margin-top:1px}
.kd-item.positive{background:var(--green-lt);border-color:#BBF7D0}
.kd-item.caution{background:var(--amber-lt);border-color:#FDE68A}
.kd-item.risk{background:var(--red-lt);border-color:#FECACA}
.kd-item.info{background:var(--blue-lt);border-color:#BFDBFE}
.val-callout{display:flex;align-items:center;gap:14px;padding:14px 18px;border-radius:var(--radius);font-size:13px;font-weight:600}
.val-callout.discount{background:var(--green-lt);border:1px solid #BBF7D0;color:var(--green)}
.val-callout.premium{background:var(--amber-lt);border:1px solid #FDE68A;color:var(--amber)}
.val-callout .val-pct{font-size:24px;font-weight:800;letter-spacing:-0.03em}
.proj-table{width:100%;border-collapse:collapse;font-size:12.5px}
.proj-table th{background:var(--surface2);padding:8px 10px;text-align:center;font-size:10px;font-weight:700;color:var(--slate2);text-transform:uppercase;letter-spacing:0.06em;border-bottom:1px solid var(--mist)}
.proj-table th:first-child{text-align:left}
.proj-table td{padding:8px 10px;text-align:center;border-bottom:1px solid var(--surface2);font-family:var(--mono);font-weight:500;color:var(--navy)}
.proj-table td:first-child{text-align:left;font-family:var(--font);font-weight:600;color:var(--slate);font-size:12px}
.proj-table tr:last-child td{border-bottom:none}.proj-table .highlight{background:var(--ice);font-weight:700}
.doc-btn-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px;padding:12px 16px;background:var(--surface);border-radius:var(--radius);border:1px solid var(--mist);align-items:center}
.doc-btn-row .doc-label{font-size:11px;font-weight:700;color:var(--fog);text-transform:uppercase;letter-spacing:0.06em;margin-right:4px;white-space:nowrap}
.action-bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid var(--mist)}
/* Basket / Comparison */
.comp-grid{display:grid;gap:0;border:1px solid var(--mist);border-radius:var(--radius-lg);overflow:hidden;background:var(--white)}
.comp-row{display:grid;border-bottom:1px solid var(--surface2)}
.comp-row:last-child{border-bottom:none}
.comp-row.header{background:var(--surface2);position:sticky;top:0;z-index:5}
.comp-row.section-header{background:var(--ice)}
.comp-cell{padding:10px 14px;font-size:12.5px;color:var(--navy);display:flex;align-items:center;border-right:1px solid var(--surface2)}
.comp-cell:last-child{border-right:none}
.comp-cell.label{font-weight:600;color:var(--slate);font-size:12px;background:var(--surface)}
.comp-cell.header-cell{font-weight:700;font-size:11px;color:var(--slate2);text-transform:uppercase;letter-spacing:0.06em}
.comp-cell.section-label{font-weight:700;font-size:11px;color:var(--navy2);text-transform:uppercase;letter-spacing:0.06em;grid-column:1/-1;padding:8px 14px}
.comp-cell .val{font-family:var(--mono);font-weight:600}
.comp-cell .best{color:var(--green);font-weight:700}
.comp-cell .worst{color:var(--red)}
.basket-offering-header{padding:16px;text-align:center;border-right:1px solid var(--surface2);position:relative}
.basket-offering-header:last-child{border-right:none}
.basket-remove{position:absolute;top:6px;right:6px;width:22px;height:22px;border-radius:50%;border:none;background:var(--surface);color:var(--slate2);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--transition)}
.basket-remove:hover{background:var(--red-lt);color:var(--red)}
.takeaway-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.takeaway-card{padding:14px;border-radius:var(--radius);font-size:12.5px;line-height:1.6}
.takeaway-card.positive{background:var(--green-lt);border:1px solid #BBF7D0;color:var(--navy)}
.takeaway-card.caution{background:var(--amber-lt);border:1px solid #FDE68A;color:var(--navy)}
.takeaway-card.info{background:var(--blue-lt);border:1px solid #BFDBFE;color:var(--navy)}
.takeaway-card .takeaway-icon{font-size:14px;margin-right:6px}
.basket-chart-wrap{height:280px;position:relative}
.skeleton{background:linear-gradient(90deg,var(--surface2) 25%,var(--mist) 50%,var(--surface2) 75%);background-size:200% 100%;animation:shimmer 1.4s ease-in-out infinite;border-radius:4px}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.skeleton-card{background:var(--white);border:1px solid var(--mist);border-radius:var(--radius-lg);padding:18px;height:200px}
#main.compliance-mode .page-title{color:#4C1D95}#main.compliance-mode .panel{border-color:#DDD6FE}
.fade-in{animation:fadeIn 0.3s ease}.slide-in{animation:slideIn 0.25s cubic-bezier(0.4,0,0.2,1)}
@keyframes slideIn{from{transform:translateX(-12px);opacity:0}to{transform:translateX(0);opacity:1}}
.card-enter{animation:cardEnter 0.3s cubic-bezier(0.34,1.2,0.64,1) both}
@keyframes cardEnter{from{transform:translateY(12px) scale(0.97);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
#toast-container{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--navy);color:var(--white);padding:11px 18px;border-radius:10px;font-size:13px;font-weight:500;box-shadow:var(--shadow-lg);animation:toastIn 0.3s cubic-bezier(0.34,1.56,0.64,1);display:flex;align-items:center;gap:8px}
@keyframes toastIn{from{transform:translateX(20px);opacity:0}to{transform:translateX(0);opacity:1}}
.toast-success{border-left:4px solid #34D399}.toast-error{border-left:4px solid #F87171}
::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--mist);border-radius:3px}::-webkit-scrollbar-thumb:hover{background:var(--fog)}
@media(max-width:900px){:root{--nav-w:0px}#sidebar{display:none}#main{padding:18px}.dashboard-grid{grid-template-columns:1fr}.quick-stats{grid-template-columns:repeat(2,1fr)}.offering-grid{grid-template-columns:1fr}#view-toggle .view-btn span.label-text{display:none}.offering-table{font-size:12px}.offering-table td,.offering-table th{padding:7px 8px}.detail-two-col{grid-template-columns:1fr}.kd-grid{grid-template-columns:1fr}.detail-prev-next button{max-width:80px}}
/* ═══════════════════════════════════════════
   DST PORTFOLIO BUILDER
═══════════════════════════════════════════ */
.pb-layout{display:grid;grid-template-columns:1.05fr 0.95fr;gap:16px;align-items:start}
@media(max-width:980px){.pb-layout{grid-template-columns:1fr}}
.pb-panel{background:var(--white);border:1.5px solid var(--mist);border-radius:var(--radius-lg);overflow:hidden}
.pb-panel-hdr{padding:14px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--mist);background:linear-gradient(180deg,var(--white),var(--surface));gap:10px;flex-wrap:wrap}
.pb-panel-hdr h3{margin:0;font-size:14px;font-weight:700;color:var(--navy);letter-spacing:-0.01em}
.pb-panel-body{padding:16px 18px}
.pb-client-bar{background:linear-gradient(135deg,var(--navy) 0%,var(--navy2) 100%);border-radius:var(--radius-lg);padding:18px 22px;margin-bottom:14px;color:var(--white);position:relative;overflow:hidden}
.pb-client-bar::after{content:'';position:absolute;right:-30px;top:-30px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,0.04)}
.pb-client-bar-title{font-size:11px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:rgba(255,255,255,0.5);margin-bottom:10px}
.pb-client-bar-name{font-size:16px;font-weight:700;color:var(--white);margin-bottom:12px}
.pb-client-bar-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.pb-client-input-wrap label{font-size:11px;font-weight:600;color:rgba(255,255,255,0.7);display:block;margin-bottom:4px}
.pb-client-input{height:38px;padding:0 12px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.18);background:rgba(255,255,255,0.10);color:#fff;font-size:14px;font-weight:700;font-family:var(--mono);outline:none;width:100%;transition:all var(--transition)}
.pb-client-input:focus{border-color:rgba(255,255,255,0.4);background:rgba(255,255,255,0.16);box-shadow:0 0 0 3px rgba(255,255,255,0.08)}
.pb-client-input::placeholder{color:rgba(255,255,255,0.35)}
.pb-client-hint{font-size:10px;color:rgba(255,255,255,0.45);margin-top:3px}
.pb-kpi-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.pb-kpi{background:var(--surface);border:1px solid var(--mist);border-radius:var(--radius);padding:12px 14px}
.pb-kpi-label{font-size:10px;font-weight:700;color:var(--fog);text-transform:uppercase;letter-spacing:0.07em}
.pb-kpi-val{font-size:20px;font-weight:800;color:var(--navy);letter-spacing:-0.02em;margin-top:4px;line-height:1;font-family:var(--mono)}
.pb-kpi-sub{font-size:11px;color:var(--slate2);margin-top:6px;font-weight:500}
.pb-progress{height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;margin-top:8px;border:1px solid var(--mist)}
.pb-progress-fill{height:100%;border-radius:3px;transition:width 0.5s cubic-bezier(0.4,0,0.2,1)}
.pb-progress-fill.equity{background:linear-gradient(90deg,var(--navy2),#3B82F6)}
.pb-progress-fill.debt{background:linear-gradient(90deg,#7C3AED,#3B82F6)}
.pb-progress-fill.over{background:linear-gradient(90deg,var(--red),#F87171)}
.pb-table-wrap{border:1px solid var(--mist);border-radius:var(--radius);overflow-x:auto;background:var(--white);margin-top:14px}
.pb-table{width:100%;border-collapse:collapse;font-size:12.5px}
.pb-table thead th{background:var(--surface2);padding:9px 10px;text-align:left;font-size:10px;font-weight:700;color:var(--slate2);text-transform:uppercase;letter-spacing:0.06em;border-bottom:1px solid var(--mist);white-space:nowrap;position:sticky;top:0;z-index:5}
.pb-table thead th.r{text-align:right}
.pb-table tbody tr{border-bottom:1px solid var(--surface2);transition:background var(--transition)}
.pb-table tbody tr:hover{background:var(--surface)}
.pb-table tbody tr:last-child{border-bottom:none}
.pb-table td{padding:8px 10px;vertical-align:middle;white-space:nowrap}
.pb-table td.r{text-align:right;font-family:var(--mono);font-size:12px;font-weight:600;color:var(--navy)}
.pb-table .deal-name{font-weight:700;color:var(--navy);font-size:12px;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pb-table .deal-sub{font-size:10.5px;color:var(--slate2);margin-top:1px}
.pb-alloc-input{width:100px;height:30px;padding:0 8px;border:1.5px solid var(--mist);border-radius:6px;font-family:var(--mono);font-size:12px;font-weight:600;color:var(--navy);background:var(--white);outline:none;transition:all var(--transition)}
.pb-alloc-input:focus{border-color:var(--navy2);box-shadow:0 0 0 3px rgba(28,58,99,0.08)}
.pb-alloc-input.needs-input{border-color:var(--amber);background:var(--amber-lt);animation:pbPulse 2s ease-in-out 2}
@keyframes pbPulse{0%,100%{box-shadow:none}50%{box-shadow:0 0 0 4px rgba(180,83,9,0.12)}}
.pb-pct-bar{width:50px;height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;display:inline-block;vertical-align:middle;margin-left:4px}
.pb-pct-fill{height:100%;background:var(--navy2);border-radius:3px;transition:width 0.3s ease}
.pb-totals-row td{background:var(--ice);font-weight:700;border-top:2px solid var(--navy2)}
.pb-remove-btn{width:24px;height:24px;border-radius:50%;border:1px solid var(--mist);background:var(--white);color:var(--slate2);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--transition);line-height:1}
.pb-remove-btn:hover{background:var(--red-lt);color:var(--red);border-color:var(--red)}
.pb-analytics{margin-top:16px}
.pb-analytics-title{font-size:13px;font-weight:700;color:var(--navy);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.pb-blended-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
@media(max-width:980px){.pb-blended-grid{grid-template-columns:repeat(2,1fr)}}
.pb-blended-tile{background:var(--surface);border:1px solid var(--mist);border-radius:var(--radius);padding:12px}
.pb-blended-tile .label{font-size:10px;font-weight:700;color:var(--fog);text-transform:uppercase;letter-spacing:0.06em}
.pb-blended-tile .val{font-size:18px;font-weight:800;color:var(--navy);margin-top:4px;font-family:var(--mono);letter-spacing:-0.02em}
.pb-blended-tile .sub{font-size:11px;color:var(--slate2);margin-top:3px}
.pb-charts-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px}
@media(max-width:980px){.pb-charts-row{grid-template-columns:1fr}}
.pb-chart-card{background:var(--white);border:1px solid var(--mist);border-radius:var(--radius);padding:14px}
.pb-chart-card-title{font-size:11px;font-weight:700;color:var(--slate2);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:10px}
.pb-chart-box{height:200px;position:relative}
.pb-diversification{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
@media(max-width:980px){.pb-diversification{grid-template-columns:1fr}}
.pb-div-item{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--surface);border:1px solid var(--mist);border-radius:var(--radius)}
.pb-div-check{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;flex-shrink:0}
.pb-div-check.pass{background:var(--green-lt);color:var(--green);border:1px solid #BBF7D0}
.pb-div-check.warn{background:var(--amber-lt);color:var(--amber);border:1px solid #FDE68A}
.pb-div-check.fail{background:var(--red-lt);color:var(--red);border:1px solid #FECACA}
.pb-div-text{font-size:12px;color:var(--navy);font-weight:600}
.pb-div-sub{font-size:11px;color:var(--slate2);font-weight:400;margin-top:1px}
.pb-income-table{width:100%;border-collapse:collapse;font-size:12px;border:1px solid var(--mist);border-radius:var(--radius);overflow:hidden}
.pb-income-table th{background:var(--surface2);padding:7px 10px;text-align:center;font-size:10px;font-weight:700;color:var(--slate2);text-transform:uppercase;letter-spacing:0.06em;border-bottom:1px solid var(--mist)}
.pb-income-table th:first-child{text-align:left}
.pb-income-table td{padding:7px 10px;text-align:center;border-bottom:1px solid var(--surface2);font-family:var(--mono);font-weight:500;color:var(--navy)}
.pb-income-table td:first-child{text-align:left;font-family:var(--font);font-weight:600;color:var(--slate)}
.pb-income-table .total-row td{background:var(--ice);font-weight:700;border-top:2px solid var(--navy2)}
.pb-mkt-card{background:var(--white);border:1.5px solid var(--mist);border-radius:var(--radius);padding:14px;transition:all var(--transition)}
.pb-mkt-card:hover{border-color:var(--slate2);box-shadow:0 4px 16px rgba(0,0,0,0.06)}
.pb-mkt-card.in-portfolio{border-color:var(--navy2);background:var(--ice)}
.pb-mkt-card-name{font-size:13px;font-weight:700;color:var(--navy);line-height:1.25}
.pb-mkt-card-sponsor{font-size:11px;color:var(--slate2);margin-top:1px}
.pb-mkt-metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin:8px 0}
.pb-mkt-metrics .m{background:var(--surface);border-radius:6px;padding:6px 8px}
.pb-mkt-metrics .m .l{font-size:9px;font-weight:700;color:var(--fog);text-transform:uppercase;letter-spacing:0.06em}
.pb-mkt-metrics .m .v{font-size:13px;font-weight:700;color:var(--navy);margin-top:2px;font-family:var(--mono)}
.pb-mkt-badges{display:flex;gap:4px;flex-wrap:wrap;margin:6px 0}
.pb-mkt-badge{font-size:10px;padding:2px 8px;border-radius:20px;border:1px solid var(--mist);background:var(--surface);color:var(--slate);font-weight:600}
.pb-mkt-badge.dst{border-color:rgba(59,130,246,0.3);background:rgba(59,130,246,0.06);color:#1D4ED8}
.pb-mkt-card-actions{display:flex;align-items:center;gap:6px;padding-top:8px;border-top:1px solid var(--surface2)}
.pb-mkt-add-btn{padding:5px 12px;border-radius:6px;border:1.5px solid var(--navy2);background:var(--white);color:var(--navy);font-size:11px;font-weight:700;cursor:pointer;transition:all var(--transition)}
.pb-mkt-add-btn:hover{background:var(--navy);color:var(--white)}
.pb-mkt-add-btn.added{background:var(--navy);color:var(--white);border-color:var(--navy)}
.pb-mkt-alloc-inline{display:flex;align-items:center;gap:6px}
.pb-mkt-alloc-inline input{width:90px;height:28px;padding:0 8px;border:1.5px solid var(--mist);border-radius:6px;font-family:var(--mono);font-size:11px;font-weight:600;color:var(--navy);outline:none}
.pb-mkt-alloc-inline input:focus{border-color:var(--navy2)}
.pb-portfolio-tabs{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.pb-portfolio-tab{padding:5px 12px;border-radius:20px;border:1.5px solid var(--mist);background:var(--white);font-size:12px;font-weight:600;color:var(--slate);cursor:pointer;transition:all var(--transition)}
.pb-portfolio-tab:hover{border-color:var(--slate2);color:var(--navy)}
.pb-portfolio-tab.active{background:var(--navy);color:var(--white);border-color:var(--navy)}
.pb-actions-bar{display:flex;gap:8px;flex-wrap:wrap;margin-top:16px;padding-top:14px;border-top:1px solid var(--mist)}
.pb-disclaimer{font-size:10.5px;color:var(--slate2);line-height:1.5;margin-top:14px;padding:12px 14px;background:var(--surface);border-radius:var(--radius);border:1px solid var(--mist)}
.pb-search-input{width:100%;height:34px;padding:0 12px;border:1.5px solid var(--mist);border-radius:var(--radius);font-size:12.5px;color:var(--navy);background:var(--white);outline:none;transition:border-color var(--transition)}
.pb-search-input:focus{border-color:var(--navy2);box-shadow:0 0 0 3px rgba(28,58,99,0.08)}
.pb-search-input::placeholder{color:var(--fog)}
.pb-filter-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center}
.pb-filter-select{height:30px;padding:0 24px 0 8px;border:1.5px solid var(--mist);border-radius:6px;font-size:11px;font-weight:600;color:var(--slate);background:var(--white);cursor:pointer;outline:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%235C7A99' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center}
.pb-filter-select:focus{border-color:var(--navy2)}
.pb-quick-toggle{display:flex;align-items:center;gap:5px;padding:4px 10px;border:1.5px solid var(--mist);border-radius:20px;font-size:11px;font-weight:600;color:var(--slate);cursor:pointer;background:var(--white);user-select:none;transition:all var(--transition)}
.pb-quick-toggle:hover{border-color:var(--slate2)}
.pb-quick-toggle.active{border-color:var(--navy2);background:var(--ice);color:var(--navy)}
.pb-quick-toggle input{display:none}
.pb-mkt-list{display:grid;gap:10px;margin-top:12px;max-height:calc(100vh - 340px);overflow-y:auto;padding-right:4px}
.pb-mkt-list::-webkit-scrollbar{width:5px}
.pb-mkt-list::-webkit-scrollbar-track{background:transparent}
.pb-mkt-list::-webkit-scrollbar-thumb{background:var(--mist);border-radius:3px}
.pb-empty{padding:32px 20px;text-align:center}
.pb-empty-icon{font-size:36px;margin-bottom:12px}
.pb-empty h4{font-size:14px;color:var(--navy);margin:0 0 6px}
.pb-empty p{font-size:12px;color:var(--slate2);margin:0;line-height:1.6}
.pb-suitability{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:10px;font-size:10px;font-weight:700}
.pb-suitability.high{background:var(--green-lt);color:var(--green);border:1px solid #BBF7D0}
.pb-suitability.medium{background:var(--amber-lt);color:var(--amber);border:1px solid #FDE68A}
.pb-suitability.low{background:var(--surface);color:var(--slate2);border:1px solid var(--mist)}

/* ═══════════════════════════════════════════
   BASKET VIEW — Imported from Tear Sheet
═══════════════════════════════════════════ */
.bv{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:rgba(9,14,25,0.92);direction:ltr!important}
.bv .report{border:1px solid rgba(15,23,42,0.12);background:rgba(255,255,255,0.64);border-radius:16px;overflow:hidden;box-shadow:0 18px 60px rgba(15,23,42,0.12)}
.bv .r-hero{padding:16px 16px 14px;border-bottom:1px solid rgba(255,255,255,0.14);background:radial-gradient(900px 380px at 10% 0%,rgba(11,31,59,0.56),transparent 62%),radial-gradient(700px 360px at 95% 10%,rgba(28,58,99,0.38),transparent 58%),linear-gradient(180deg,rgba(6,18,34,0.86),rgba(16,35,60,0.72))}
.bv .topline{display:grid;grid-template-columns:1.2fr auto auto;gap:12px;align-items:start}
@media(max-width:980px){.bv .topline{grid-template-columns:1fr}}
.bv .r-title h2{margin:0;font-size:18px;font-weight:950;letter-spacing:.2px;line-height:1.2;color:rgba(255,255,255,0.98);text-shadow:0 6px 20px rgba(0,0,0,0.25)}
.bv .r-title .subline{margin-top:6px;font-size:12px;color:rgba(255,255,255,0.92);font-weight:850;text-shadow:0 6px 20px rgba(0,0,0,0.22)}
.bv .metaRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center}
.bv .r-badge{display:inline-flex;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.22);background:rgba(255,255,255,0.12);color:rgba(255,255,255,0.86);font-size:11px;font-weight:850;backdrop-filter:blur(4px)}
.bv .r-badge strong{font-weight:950;color:rgba(255,255,255,0.96)}
.bv .hdrStatusWrap{border:1px solid rgba(255,255,255,0.20);background:rgba(255,255,255,0.12);border-radius:14px;padding:10px;min-height:92px;display:flex;align-items:stretch;gap:12px;min-width:280px;box-shadow:0 18px 44px rgba(0,0,0,0.14);backdrop-filter:blur(6px)}
@media(max-width:980px){.bv .hdrStatusWrap{height:auto;min-width:0}}
.bv .vStat{display:flex;gap:10px;align-items:stretch;min-width:0;flex:1 1 0}
.bv .vTrack{width:12px;border-radius:999px;border:1px solid rgba(255,255,255,0.22);background:rgba(255,255,255,0.10);overflow:hidden;position:relative;flex:0 0 12px}
.bv .vFill{position:absolute;left:0;right:0;bottom:0;height:0%;background:linear-gradient(180deg,rgba(52,211,153,0.96),rgba(16,185,129,0.98))}
.bv .vInfo{display:grid;grid-template-rows:auto 1fr;gap:6px;min-width:0;width:100%}
.bv .vHdr{display:flex;align-items:baseline;justify-content:space-between;gap:8px;min-width:0;white-space:nowrap}
.bv .vHdr .k{font-size:10px;font-weight:950;text-transform:uppercase;letter-spacing:.25px;color:rgba(255,255,255,0.92)}
.bv .vList{display:grid;gap:3px;align-content:start;min-width:0}
.bv .vLine{font-size:10px;font-weight:850;color:rgba(255,255,255,0.82);line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.bv .vLine b{font-weight:950;color:rgba(255,255,255,0.96)}
.bv .docsBox{display:grid;gap:8px;text-align:left;align-content:start;justify-items:start;position:relative}
.bv .docPopover{position:absolute;right:0;top:calc(100% + 10px);z-index:9999}
@media(max-width:980px){.bv .docPopover{right:auto;left:0}}
.bv .modal{max-width:540px;margin:0;border-radius:16px;border:1px solid rgba(15,23,42,0.14);background:radial-gradient(900px 420px at 20% 0%,rgba(11,31,59,0.12),transparent 65%),linear-gradient(180deg,rgba(255,255,255,0.94),rgba(238,242,246,0.90));box-shadow:0 24px 80px rgba(15,23,42,0.18);overflow:hidden;text-align:left}
.bv .modalHdr{padding:12px;border-bottom:1px solid rgba(15,23,42,0.10);display:flex;align-items:center;justify-content:space-between;gap:10px}
.bv .modalHdr .t{font-size:12px;font-weight:950;letter-spacing:.25px;text-transform:uppercase;color:rgba(9,14,25,0.84)}
.bv .modalBody{padding:12px;display:grid;gap:10px;max-height:55vh;overflow:auto}
.bv .docRow{border:1px solid rgba(15,23,42,0.12);background:rgba(255,255,255,0.74);border-radius:14px;padding:10px;display:flex;align-items:center;justify-content:space-between;gap:10px;box-shadow:0 10px 24px rgba(15,23,42,0.06)}
.bv .docRow .name{font-size:11px;font-weight:900;color:rgba(9,14,25,0.86);min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bv .docRow .right{display:flex;gap:8px;flex:0 0 auto}
.bv .docRow .na{font-size:11px;font-weight:850;color:rgba(9,14,25,0.52)}
.bv .kv-grid{padding:14px 16px;display:grid;grid-template-columns:1.1fr 0.9fr;gap:12px;border-bottom:1px solid rgba(15,23,42,0.10);background:rgba(255,255,255,0.54)}
@media(max-width:980px){.bv .kv-grid{grid-template-columns:1fr}}
.bv .callouts{display:grid;gap:10px}
.bv .callout{border:1px solid rgba(15,23,42,0.12);background:rgba(255,255,255,0.64);border-radius:14px;padding:12px;box-shadow:0 12px 26px rgba(15,23,42,0.06)}
.bv .callout h3{margin:0 0 8px 0;font-size:12px;text-transform:uppercase;letter-spacing:.25px;color:rgba(9,14,25,0.78);font-weight:950}
.bv .callout ul{margin:0;padding-left:18px;color:rgba(9,14,25,0.78);font-size:12px;line-height:1.55;font-weight:700}
.bv .callout li{margin:6px 0}
.bv .mapWrap{border:1px solid rgba(15,23,42,0.12);background:rgba(255,255,255,0.60);border-radius:14px;padding:12px;box-shadow:0 12px 28px rgba(15,23,42,0.06)}
.bv .mapHdr{display:flex;align-items:baseline;justify-content:space-between;gap:10px;margin-bottom:10px}
.bv .mapHdr .t{font-size:12px;font-weight:950;letter-spacing:.2px;color:rgba(9,14,25,0.88)}
.bv .mapHdr .s{font-size:11px;color:rgba(9,14,25,0.60);font-weight:800}
.bv .mapBox{height:270px;border-radius:14px;border:1px solid rgba(15,23,42,0.10);background:#EEF2F6;overflow:hidden}
.bv .legend{display:flex;align-items:center;gap:10px;margin-top:10px;color:rgba(9,14,25,0.62);font-size:11px;font-weight:800}
.bv .swatch{width:16px;height:10px;border-radius:999px;background:rgba(11,31,59,0.82);border:1px solid rgba(28,58,99,0.70)}
.bv .sections{padding:14px 16px 16px;display:grid;gap:14px}
.bv .sec{border:1px solid rgba(15,23,42,0.12);border-radius:14px;background:rgba(255,255,255,0.60);overflow:hidden;box-shadow:0 12px 30px rgba(15,23,42,0.06)}
.bv .secHdr{padding:12px;border-bottom:1px solid rgba(15,23,42,0.10);display:flex;align-items:baseline;justify-content:space-between;gap:10px;background:linear-gradient(135deg,rgba(11,31,59,0.08),rgba(255,255,255,0.74));flex-wrap:wrap;box-shadow:inset 0 2px 0 rgba(11,31,59,0.18)}
.bv .secHdr .h{font-size:12px;font-weight:950;letter-spacing:.25px;text-transform:uppercase;color:rgba(9,14,25,0.84)}
.bv .secHdr .hint{font-size:11px;color:rgba(9,14,25,0.58);font-weight:800}
.bv .secBody{padding:12px}
.bv .metricsGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media(max-width:980px){.bv .metricsGrid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:520px){.bv .metricsGrid{grid-template-columns:1fr}}
.bv .mBox{border:1px solid rgba(15,23,42,0.12);border-radius:14px;padding:10px;background:linear-gradient(180deg,rgba(255,255,255,0.78),rgba(238,242,246,0.78));min-width:0;position:relative;box-shadow:0 10px 24px rgba(15,23,42,0.06)}
.bv .mBox .k{font-size:10px;color:rgba(9,14,25,0.58);font-weight:950;text-transform:uppercase;letter-spacing:.25px;padding-right:56px}
.bv .mBox .v{margin-top:6px;font-size:14px;font-weight:950;letter-spacing:.15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:rgba(9,14,25,0.92)}
.bv .mBox .vs{margin-top:6px;font-size:11px;color:rgba(9,14,25,0.66);font-weight:800}
.bv .mCov{position:absolute;top:8px;right:8px;font-size:10px;font-weight:900;color:rgba(9,14,25,0.52);background:rgba(238,242,246,0.90);padding:2px 6px;border-radius:6px}
.bv .mCov.warn{color:rgba(198,137,42,0.92);background:rgba(198,137,42,0.12)}
.bv .delta{font-weight:900}.bv .delta.pos{color:rgba(31,157,107,0.96)}.bv .delta.neg{color:rgba(214,69,69,0.90)}
.bv .pctl{color:rgba(9,14,25,0.54);font-weight:850}
.bv .textBlock{font-size:12px;color:rgba(9,14,25,0.62);font-weight:700;line-height:1.6}
.bv .chartWrap{border:1px solid rgba(15,23,42,0.12);border-radius:14px;padding:12px;background:rgba(255,255,255,0.80);box-shadow:0 10px 24px rgba(15,23,42,0.06)}
.bv .chartHdr{display:flex;align-items:baseline;justify-content:space-between;gap:10px;margin-bottom:10px}
.bv .chartHdr .t{font-size:12px;font-weight:950;letter-spacing:.2px;color:rgba(9,14,25,0.86)}
.bv .chartHdr .s{font-size:11px;color:rgba(9,14,25,0.58);font-weight:800}
.bv .chartBox{height:320px;position:relative}
.bv .valHero{display:grid;gap:10px}
.bv .calloutRow{display:grid;grid-template-columns:1fr auto;gap:10px}
@media(max-width:700px){.bv .calloutRow{grid-template-columns:1fr}}
.bv .heroCall{border:1px solid rgba(15,23,42,0.14);border-radius:14px;padding:12px;background:linear-gradient(135deg,rgba(238,242,246,0.92),rgba(255,255,255,0.92));box-shadow:0 16px 36px rgba(15,23,42,0.08)}
.bv .heroCall.good{border-color:rgba(31,157,107,0.26);background:linear-gradient(135deg,rgba(31,157,107,0.08),rgba(255,255,255,0.92))}
.bv .heroCall.bad{border-color:rgba(214,69,69,0.22);background:linear-gradient(135deg,rgba(214,69,69,0.06),rgba(255,255,255,0.92))}
.bv .heroTop{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.bv .heroK{font-size:11px;font-weight:950;text-transform:uppercase;letter-spacing:.25px;color:rgba(9,14,25,0.68)}
.bv .heroMain{font-size:16px;font-weight:950;color:rgba(9,14,25,0.92);letter-spacing:.15px}
.bv .heroSub{font-size:12px;font-weight:850;color:rgba(9,14,25,0.72);margin-top:4px}
.bv .heroMeta{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
.bv .kv{font-size:11px;font-weight:800;color:rgba(9,14,25,0.66)}.bv .kv b{font-weight:950;color:rgba(9,14,25,0.82)}
.bv .miniCall{border:1px solid rgba(15,23,42,0.12);border-radius:14px;padding:12px;min-width:180px;background:rgba(255,255,255,0.74);box-shadow:0 10px 24px rgba(15,23,42,0.06)}
.bv .miniCall .k{font-size:11px;font-weight:950;text-transform:uppercase;letter-spacing:.25px;color:rgba(9,14,25,0.62);margin-bottom:6px}
.bv .miniCall .v{font-size:14px;font-weight:950;color:rgba(9,14,25,0.92)}
.bv .miniCall .s{margin-top:6px;font-size:11px;color:rgba(9,14,25,0.58);font-weight:750;line-height:1.5}
.bv .r-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(15,23,42,0.12);background:rgba(255,255,255,0.62);color:rgba(9,14,25,0.64);font-size:11px;font-weight:850}
.bv .vcompWrap{border:1px solid rgba(15,23,42,0.12);background:rgba(255,255,255,0.64);border-radius:14px;overflow:hidden;box-shadow:0 12px 30px rgba(15,23,42,0.06)}
.bv .vcompTop{padding:12px;border-bottom:1px solid rgba(15,23,42,0.10);background:linear-gradient(135deg,rgba(11,31,59,0.08),rgba(255,255,255,0.74));display:flex;align-items:baseline;justify-content:space-between;gap:10px;flex-wrap:wrap;box-shadow:inset 0 2px 0 rgba(11,31,59,0.18)}
.bv .vcompTop .t{font-size:12px;font-weight:950;letter-spacing:.25px;text-transform:uppercase;color:rgba(9,14,25,0.84)}
.bv .vcompTop .s{font-size:11px;color:rgba(9,14,25,0.58);font-weight:800}
.bv .vcompScroller{overflow:auto;background:rgba(255,255,255,0.60)}
.bv .vcompTable{width:100%;border-collapse:separate;border-spacing:0;min-width:760px}
.bv .vcompTable th,.bv .vcompTable td{border-bottom:1px solid rgba(15,23,42,0.08);padding:10px;vertical-align:top;font-size:12px;color:rgba(9,14,25,0.82);font-weight:750}
.bv .vcompTable thead th{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid rgba(15,23,42,0.14);box-shadow:0 6px 14px rgba(15,23,42,0.06)}
.bv .vcompTable thead th:first-child{z-index:6}
.bv .vcompField{width:260px;min-width:240px;max-width:340px;color:rgba(9,14,25,0.68);font-weight:900}
.bv .vcompOfferHdr{font-size:11px;font-weight:950;color:rgba(9,14,25,0.88);letter-spacing:.2px;text-transform:uppercase;line-height:1.15}
.bv .vcompOfferSub{margin-top:4px;font-size:10px;font-weight:850;color:rgba(9,14,25,0.58);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.bv .vcompGroupRow td{background:rgba(238,242,246,0.94);border-top:1px solid rgba(15,23,42,0.10);border-bottom:1px solid rgba(15,23,42,0.10);padding:10px;font-size:11px;font-weight:950;text-transform:uppercase;letter-spacing:.25px;color:rgba(9,14,25,0.74)}
.bv .vcompVal{white-space:pre-wrap;word-break:break-word;line-height:1.55}
.bv .vcompNA{color:rgba(9,14,25,0.48);font-weight:850}
.bv .bv-btn{border:1px solid rgba(15,23,42,0.14);background:rgba(255,255,255,0.74);color:rgba(9,14,25,0.90);padding:4px 10px;border-radius:12px;font-size:11px;font-weight:900;cursor:pointer;transition:transform .08s ease,background .15s ease;user-select:none;white-space:nowrap;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 8px 22px rgba(15,23,42,0.06)}
.bv .bv-btn:hover{background:rgba(255,255,255,0.88)}
.bv .bv-btn:active{transform:translateY(1px)}
.bv .bv-btn.doc{border-color:rgba(255,255,255,0.20);color:rgba(255,255,255,0.98);background:linear-gradient(135deg,rgba(64,156,255,0.96),rgba(120,207,255,0.92));box-shadow:0 16px 44px rgba(30,136,229,0.20)}
.bv .bv-btn.doc:hover{filter:brightness(1.05)}
.bv .bv-btn:disabled{opacity:.55;cursor:not-allowed;pointer-events:none}
.bv .ico{width:14px;height:14px;display:inline-flex;align-items:center;justify-content:center;flex:0 0 14px;opacity:.98}
.bv .ico svg{width:14px;height:14px;display:block}
.bv .ftr{padding:10px 18px;border-top:1px solid rgba(15,23,42,0.10);display:flex;align-items:center;justify-content:space-between;gap:10px;font-size:10px;color:rgba(9,14,25,0.50);font-weight:800;background:rgba(255,255,255,0.60)}
.bv-dropdown-wrap{position:relative;display:inline-block}
.bv-dropdown{display:none;position:absolute;top:calc(100% + 6px);right:0;z-index:999;background:#fff;border:1px solid rgba(11,31,59,0.14);border-radius:12px;box-shadow:0 12px 40px rgba(11,31,59,0.18);padding:8px;min-width:340px;max-height:400px;overflow-y:auto}
.bv-dropdown.open{display:block}
.bv-dropdown::-webkit-scrollbar{width:8px}.bv-dropdown::-webkit-scrollbar-thumb{background:rgba(11,31,59,0.12);border-radius:8px}
.bv-select-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;color:var(--navy);transition:background .12s}
.bv-select-item:hover{background:var(--ice)}
.bv-select-item.checked{background:rgba(11,31,59,0.06);font-weight:700}
.bv-select-item.disabled{opacity:.45;cursor:not-allowed}
.bv-select-item input[type="checkbox"]{accent-color:var(--navy);width:16px;height:16px;flex-shrink:0;cursor:pointer}
.bv-select-item.disabled input{cursor:not-allowed}
.bv-select-name{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bv-select-x{flex-shrink:0;width:20px;height:20px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:rgba(153,27,27,0.08);color:var(--red);font-size:11px;font-weight:800;cursor:pointer;transition:background .12s}
.bv-select-x:hover{background:rgba(153,27,27,0.16)}
/* ═══════════════════════════════════════════
   OFFERING DETAIL VIEW v2 — Premium Single + Multi
═══════════════════════════════════════════ */
.od-wrap{background:var(--surface);min-height:100%}
.od-mode-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:0;padding:0 0 16px;gap:12px;flex-wrap:wrap}
.od-mode-toggle{display:flex;background:var(--white);border:1.5px solid var(--mist);border-radius:10px;padding:3px;gap:2px}
.od-mode-btn{padding:6px 16px;border-radius:8px;border:none;background:transparent;font-size:12px;font-weight:600;color:var(--slate2);cursor:pointer;transition:all var(--transition);white-space:nowrap}
.od-mode-btn.active{background:var(--navy);color:var(--white)}
.od-offering-tag{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;border:1.5px solid}
.od-tag-1{background:rgba(29,78,216,0.08);border-color:rgba(29,78,216,0.25);color:#1D4ED8}
.od-tag-2{background:rgba(124,58,237,0.08);border-color:rgba(124,58,237,0.25);color:#7C3AED}
.od-tag-3{background:rgba(180,83,9,0.08);border-color:rgba(180,83,9,0.25);color:#B45309}
/* Hero */
.od-hero{background:linear-gradient(160deg,#0B1F3B 0%,#1C3A63 60%,#2A4D7A 100%);border-radius:var(--radius-xl);overflow:hidden;margin-bottom:16px;position:relative}
.od-hero::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 700px 400px at 85% 50%,rgba(59,130,246,0.15),transparent 60%)}
.od-hero-inner{padding:24px 28px;position:relative;z-index:1}
.od-hero-top{display:grid;grid-template-columns:1fr auto;gap:20px;align-items:start}
@media(max-width:900px){.od-hero-top{grid-template-columns:1fr}}
.od-hero-left{}
.od-sponsor-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.od-sponsor-logo{width:38px;height:38px;border-radius:8px;background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.18);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:rgba(255,255,255,0.9);flex-shrink:0;overflow:hidden}
.od-sponsor-logo img{width:100%;height:100%;object-fit:contain}
.od-sponsor-meta{line-height:1.3}
.od-sponsor-name{font-size:12px;font-weight:700;color:rgba(255,255,255,0.7);letter-spacing:0.02em}
.od-sponsor-exp{font-size:10.5px;color:rgba(255,255,255,0.45)}
.od-hero-name{font-size:22px;font-weight:800;color:#fff;letter-spacing:-0.02em;line-height:1.2;margin-bottom:8px}
.od-hero-badges{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.od-hero-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:20px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.88);font-size:11px;font-weight:700;backdrop-filter:blur(4px)}
.od-hero-badge.status-open{border-color:rgba(52,211,153,0.4);background:rgba(52,211,153,0.12);color:#34D399}
.od-hero-badge.status-closing{border-color:rgba(251,191,36,0.4);background:rgba(251,191,36,0.12);color:#FBF024}
.od-hero-badge.status-coming{border-color:rgba(96,165,250,0.4);background:rgba(96,165,250,0.12);color:#60A5FA}
.od-hero-badge.status-closed{border-color:rgba(248,113,113,0.4);background:rgba(248,113,113,0.1);color:#F87171}
.od-hero-location{font-size:12px;color:rgba(255,255,255,0.55);display:flex;align-items:center;gap:5px}
/* KPI Strip */
.od-kpi-strip{display:grid;grid-template-columns:repeat(4,1fr);gap:0;background:var(--white);border:1.5px solid var(--mist);border-radius:var(--radius-lg);overflow:hidden;margin-bottom:16px;box-shadow:var(--shadow-sm)}
@media(max-width:700px){.od-kpi-strip{grid-template-columns:repeat(2,1fr)}}
.od-kpi-cell{padding:14px 18px;border-right:1px solid var(--mist);position:relative}
.od-kpi-cell:last-child{border-right:none}
.od-kpi-label{font-size:10px;font-weight:700;color:var(--fog);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:3px}
.od-kpi-value{font-size:22px;font-weight:800;color:var(--navy);letter-spacing:-0.03em;line-height:1;font-family:var(--mono)}
.od-kpi-peer{font-size:10.5px;color:var(--slate2);margin-top:4px}
.od-kpi-peer .up{color:var(--green);font-weight:700}
.od-kpi-peer .down{color:var(--red);font-weight:700}
.od-kpi-peer .neutral{color:var(--fog);font-weight:600}
/* DD Icons Row */
.od-dd-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px;padding:12px 16px;background:var(--white);border:1.5px solid var(--mist);border-radius:var(--radius-lg);align-items:center;box-shadow:var(--shadow-sm)}
.od-dd-group{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.od-dd-group-label{font-size:10px;font-weight:700;color:var(--fog);text-transform:uppercase;letter-spacing:0.08em;white-space:nowrap;margin-right:2px}
.od-dd-divider{width:1px;height:28px;background:var(--mist);margin:0 6px;flex-shrink:0}
.od-doc-btn{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border-radius:6px;border:1.5px solid var(--mist);background:var(--white);color:var(--navy);font-size:11px;font-weight:700;cursor:pointer;transition:all var(--transition);text-decoration:none;white-space:nowrap;position:relative}
.od-doc-btn:hover:not(:disabled){border-color:var(--navy2);background:var(--ice);color:var(--navy)}
.od-doc-btn:disabled,.od-doc-btn.unavailable{opacity:0.38;cursor:not-allowed;pointer-events:none}
.od-doc-btn.has-dropdown{padding-right:24px}
.od-doc-btn.has-dropdown::after{content:'▾';position:absolute;right:8px;font-size:9px;opacity:0.6}
/* Action Bar */
.od-action-bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;align-items:center}
.od-suit-chip{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:8px;font-size:12px;font-weight:700;margin-left:auto}
.od-suit-chip.high{background:var(--green-lt);color:var(--green);border:1.5px solid #BBF7D0}
.od-suit-chip.medium{background:var(--amber-lt);color:var(--amber);border:1.5px solid #FDE68A}
.od-suit-chip.low{background:var(--red-lt);color:var(--red);border:1.5px solid #FECACA}
.od-suit-chip.none{background:var(--surface2);color:var(--slate2);border:1.5px solid var(--mist)}
/* Body Grid */
.od-body{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
@media(max-width:900px){.od-body{grid-template-columns:1fr}}
.od-body-full{grid-column:1/-1}
/* Analyst panels */
.od-panel{background:var(--white);border:1.5px solid var(--mist);border-radius:var(--radius-lg);overflow:hidden;box-shadow:var(--shadow-sm)}
.od-panel-hdr{padding:12px 18px;border-bottom:1px solid var(--mist);background:linear-gradient(180deg,var(--white),var(--surface));display:flex;align-items:center;justify-content:space-between;gap:8px}
.od-panel-title{font-size:11px;font-weight:700;color:var(--slate);text-transform:uppercase;letter-spacing:0.07em}
.od-panel-hint{font-size:10.5px;color:var(--fog)}
.od-panel-body{padding:16px 18px}
/* Suitability panel */
.od-suit-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--surface2);font-size:12.5px}
.od-suit-row:last-child{border-bottom:none}
.od-suit-key{color:var(--slate2);font-weight:500}
.od-suit-val{font-weight:700;color:var(--navy);text-align:right}
.od-suit-score-ring{width:68px;height:68px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:800;flex-shrink:0;margin-right:12px;border:3px solid}
.od-suit-score-ring.high{background:var(--green-lt);color:var(--green);border-color:#BBF7D0}
.od-suit-score-ring.medium{background:var(--amber-lt);color:var(--amber);border-color:#FDE68A}
.od-suit-score-ring.low{background:var(--red-lt);color:var(--red);border-color:#FECACA}
/* Raise Status */
.od-raise-bar{height:10px;background:var(--surface2);border-radius:5px;overflow:hidden;margin:8px 0 4px}
.od-raise-fill{height:100%;background:linear-gradient(90deg,var(--navy2),#3B82F6);border-radius:5px;transition:width 1s cubic-bezier(.4,0,.2,1)}
.od-raise-stat-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:10px}
.od-raise-stat{background:var(--surface);border-radius:var(--radius);padding:10px 12px;text-align:center}
.od-raise-stat-val{font-size:15px;font-weight:800;color:var(--navy);font-family:var(--mono)}
.od-raise-stat-label{font-size:10px;font-weight:700;color:var(--fog);text-transform:uppercase;letter-spacing:0.06em;margin-top:2px}
/* Valuation */
.od-val-hero{display:flex;align-items:center;gap:12px;padding:14px;border-radius:var(--radius);margin-bottom:12px}
.od-val-hero.discount{background:var(--green-lt);border:1.5px solid #BBF7D0}
.od-val-hero.premium{background:var(--amber-lt);border:1.5px solid #FDE68A}
.od-val-hero.neutral{background:var(--surface2);border:1.5px solid var(--mist)}
.od-val-pct{font-size:26px;font-weight:800;letter-spacing:-0.03em;line-height:1}
.od-val-pct.discount{color:var(--green)}
.od-val-pct.premium{color:var(--amber)}
.od-val-label{font-size:13px;font-weight:700;color:var(--navy)}
.od-val-sub{font-size:11px;color:var(--slate2);margin-top:2px}
.od-val-kv{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
.od-val-kv-item{background:var(--surface);border-radius:var(--radius);padding:10px 12px}
.od-val-kv-label{font-size:10px;font-weight:700;color:var(--fog);text-transform:uppercase;letter-spacing:0.06em}
.od-val-kv-value{font-size:14px;font-weight:700;color:var(--navy);font-family:var(--mono);margin-top:2px}
/* Key Drivers */
.od-kd-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media(max-width:700px){.od-kd-grid{grid-template-columns:1fr}}
.od-kd-item{display:flex;align-items:flex-start;gap:8px;padding:10px 12px;border-radius:var(--radius);border:1px solid;font-size:12px;line-height:1.5;color:var(--navy)}
.od-kd-icon{font-size:13px;flex-shrink:0;margin-top:1px}
.od-kd-item.positive{background:var(--green-lt);border-color:#BBF7D0}
.od-kd-item.caution{background:var(--amber-lt);border-color:#FDE68A}
.od-kd-item.info{background:var(--blue-lt);border-color:#BFDBFE}
.od-kd-item.neutral{background:var(--surface);border-color:var(--mist)}
/* Multi-offering comparison table */
.od-comp-wrap{background:var(--white);border:1.5px solid var(--mist);border-radius:var(--radius-lg);overflow:hidden;margin-bottom:16px;box-shadow:var(--shadow-sm)}
.od-comp-sticky-header{display:grid;background:var(--surface2);border-bottom:2px solid var(--mist);position:sticky;top:0;z-index:10}
.od-comp-row{display:grid;border-bottom:1px solid var(--surface2)}
.od-comp-row:last-child{border-bottom:none}
.od-comp-row.section-head{background:var(--ice);border-top:1.5px solid var(--mist)}
.od-comp-cell{padding:9px 14px;font-size:12.5px;display:flex;align-items:center;border-right:1px solid var(--surface2)}
.od-comp-cell:last-child{border-right:none}
.od-comp-cell.field{font-weight:600;color:var(--slate);font-size:11.5px;background:var(--surface);flex-shrink:0}
.od-comp-cell.sec-label{font-weight:700;font-size:11px;color:var(--navy2);text-transform:uppercase;letter-spacing:0.07em;grid-column:1/-1;background:var(--ice)}
.od-comp-cell.val{font-family:var(--mono);font-weight:600}
.od-comp-cell.best .val{color:var(--green);font-weight:800}
.od-comp-cell.worst .val{color:var(--red)}
/* Map area in hero right */
.od-hero-right{display:flex;flex-direction:column;gap:10px;min-width:260px;max-width:320px}
@media(max-width:900px){.od-hero-right{max-width:100%}}
.od-map-card{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.14);border-radius:12px;padding:12px;backdrop-filter:blur(4px)}
.od-map-title{font-size:10px;font-weight:700;color:rgba(255,255,255,0.6);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:6px}
.od-map-box{height:140px;border-radius:8px;overflow:hidden;background:rgba(11,31,59,0.4)}
.od-map-legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.od-map-leg-item{display:flex;align-items:center;gap:4px;font-size:10px;font-weight:700;color:rgba(255,255,255,0.6)}
.od-map-leg-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.od-map-leg-dot-1{background:#3B82F6}
.od-map-leg-dot-2{background:#9333EA}
.od-map-leg-dot-3{background:#D97706}
/* Sponsor panel */
.od-sponsor-stat-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.od-sponsor-stat{background:var(--surface);border-radius:var(--radius);padding:10px 14px;flex:1;min-width:90px;text-align:center}
.od-sponsor-stat-val{font-size:16px;font-weight:800;color:var(--navy);font-family:var(--mono);letter-spacing:-0.02em}
.od-sponsor-stat-label{font-size:10px;font-weight:700;color:var(--fog);text-transform:uppercase;letter-spacing:0.06em;margin-top:2px}
/* Distribution chart */
.od-chart-box{height:200px;position:relative;margin-top:8px}
/* Projection table */
.od-proj-table{width:100%;border-collapse:collapse;font-size:12px}
.od-proj-table th{background:var(--surface2);padding:7px 10px;text-align:center;font-size:10px;font-weight:700;color:var(--slate2);text-transform:uppercase;letter-spacing:0.06em;border-bottom:1px solid var(--mist)}
.od-proj-table th:first-child{text-align:left}
.od-proj-table td{padding:7px 10px;text-align:center;border-bottom:1px solid var(--surface2);font-family:var(--mono);color:var(--navy);font-weight:500}
.od-proj-table td:first-child{text-align:left;font-family:var(--font);font-weight:600;color:var(--slate);font-size:11.5px}
.od-proj-table tr:last-child td{border-bottom:none}
.od-proj-table .highlight-row td{background:var(--ice);font-weight:700}
/* Offering tags in multi mode */
.od-offering-tags{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
/* Blended badge */
.od-blended-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:10.5px;font-weight:700;background:rgba(124,58,237,0.1);color:#7C3AED;border:1px solid rgba(124,58,237,0.25)}

/* ── DST Calculator ── */
.dst-offerings-bar{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px}
.dst-offering-pill{display:inline-flex;align-items:center;padding:4px 12px;border-radius:999px;background:var(--ice);border:1px solid var(--mist);font-size:11px;font-weight:600;color:var(--navy)}
.dst-primary-inputs{background:var(--surface);border:1px solid var(--mist);border-radius:12px;padding:14px 16px;margin-bottom:14px}
.dst-pi-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
@media(max-width:900px){.dst-pi-grid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:600px){.dst-pi-grid{grid-template-columns:repeat(2,1fr)}}
.dst-pi{display:flex;flex-direction:column;gap:2px}
.dst-pi-label{font-size:10px;font-weight:700;color:var(--slate2);text-transform:uppercase;letter-spacing:.5px}
.dst-pi-value{font-size:15px;font-weight:700;color:var(--navy);font-family:var(--mono)}
.dst-advanced-wrap{margin-bottom:14px}
.dst-advanced{display:none;margin-top:8px;background:var(--surface);border:1px solid var(--mist);border-radius:12px;padding:14px 16px}
.dst-advanced.open{display:block}
.dst-adv-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px 12px}
@media(max-width:900px){.dst-adv-grid{grid-template-columns:repeat(2,1fr)}}
.dst-adv-field{display:flex;flex-direction:column;gap:3px;font-size:12px}
.dst-adv-field label{font-weight:600;color:var(--slate);font-size:11px}
.dst-adv-field input,.dst-adv-field select{padding:5px 8px;border:1px solid var(--mist);border-radius:8px;font-size:12px;color:var(--navy);outline:none;font-family:var(--mono);transition:border-color var(--transition)}
.dst-adv-field input:focus{border-color:var(--navy2)}
.dst-results-card{background:var(--white);border:1px solid var(--mist);border-radius:12px;padding:16px;margin-bottom:14px}
.dst-results-label{font-size:14px;font-weight:700;color:var(--navy);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--surface2)}
.dst-section-hdr{font-size:11px;font-weight:700;color:var(--slate2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.dst-tbl{width:100%;border-collapse:collapse;font-size:12px}
.dst-tbl td{padding:4px 0;border-bottom:1px dashed rgba(0,0,0,0.06);color:var(--navy)}
.dst-tbl td:first-child{font-weight:500;color:var(--slate)}
.dst-tbl td.r{text-align:right;font-family:var(--mono);font-size:12px}
.dst-tbl td.b{font-weight:700}
.dst-tbl td.hint{font-weight:400;color:var(--slate2);font-style:italic}
.dst-tbl td.warn{color:var(--red);font-weight:600}
.dst-tbl tr:last-child td{border-bottom:none}
.dst-stress{width:100%;border-collapse:collapse;font-size:11px}
.dst-stress th,.dst-stress td{border:1px solid var(--surface2);padding:5px 8px;text-align:right}
.dst-stress th:first-child,.dst-stress td:first-child{text-align:left}
.dst-stress th{background:var(--surface);font-weight:700;color:var(--slate2);text-transform:uppercase;letter-spacing:.3px;font-size:10px}
.dst-stress td{color:var(--navy);font-family:var(--mono)}
.dst-badge{display:inline-flex;align-items:center;padding:3px 8px;border-radius:999px;font-size:10px;font-weight:600;background:var(--ice);color:var(--navy)}
.dst-badge.safe{background:rgba(22,163,74,0.1);color:#166534}
.dst-badge.danger{background:rgba(185,28,28,0.08);color:#b91c1c}
.dst-chart-area{margin-top:14px;height:180px;position:relative}
.dst-chart-area canvas{width:100%!important;height:100%!important}
.dst-per-offering-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:14px}
.dst-view-toggle{display:flex;gap:6px;align-items:center}
.dst-disclaimer{margin-top:16px;font-size:10px;color:var(--slate2);line-height:1.5;padding:10px;background:var(--surface);border-radius:8px}
.dst-boot-inputs{margin-top:8px}
@media print{.bv .report{border:1px solid #ddd!important;background:#fff!important}.bv .r-hero .r-badge{color:#333!important;border-color:#ccc!important;background:#f0f0f0!important}.bv .sec,.bv .callout,.bv .mapWrap,.bv .valHero,.bv .chartWrap,.bv .vcompWrap{break-inside:avoid;page-break-inside:avoid}.bv .vcompScroller{overflow:visible!important}.bv .vcompTable thead th{position:static!important;box-shadow:none!important}*{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}}

</style>
</head>
<body>
<div id="app">
  <header id="header">
    <div id="logo"><div id="logo-mark">A</div><div><div id="logo-text">Alts Fund Link</div><div id="logo-sub">Intelligence Platform</div></div></div>
    <div id="view-toggle">
      <button class="view-btn active" data-view="advisor" onclick="switchMode('advisor')"><span class="view-dot"></span><span class="label-text">Advisor View</span></button>
      <button class="view-btn client-report" data-view="client_report" onclick="switchMode('client_report')"><span class="view-dot"></span><span class="label-text">Client Report</span></button>
      <button class="view-btn compliance" data-view="compliance" onclick="switchMode('compliance')"><span class="view-dot"></span><span class="label-text">Compliance</span></button>
    </div>
    <div id="data-status"><span class="pulse-dot loading" id="status-dot"></span><span id="status-text">Loading data…</span></div>
    <div id="client-badge" onclick="openProfileModal()"><div id="client-badge-icon">?</div><div id="client-badge-text"><span id="badge-name">No Client</span><small id="badge-equity">Set up client profile</small></div></div>
  </header>
  <div id="body-area">
    <nav id="sidebar"><div id="nav-advisor" class="nav-content"></div><div id="nav-client_report" class="nav-content" style="display:none"></div><div id="nav-compliance" class="nav-content" style="display:none"></div></nav>
    <main id="main"><div id="view-content" class="fade-in"></div></main>
  </div>
</div>
<div id="modal-container"></div>
<div id="toast-container"></div>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
/* ═══════════════════════════════════════════
   STATE & CONFIG
═══════════════════════════════════════════ */
const SHEET_ID = '1xVFw8pFrJzcxD8CH7ainimPKD6GW9tn1bb8ggHYUfRs';
const STATE = {
  mode: 'advisor',
  view: 'dashboard',
  funds: [],
  peer: {},
  client: loadClient(),
  selectedOfferingId: null,
  basket: JSON.parse(localStorage.getItem('afl_basket') || '[]'),
  browseLayout: 'card',
  browseSort: 'y1coc_desc',
  browseFilters: { status: 'all', propType: 'all', sponsor: 'all', sector: 'all', focus: 'all', cocMin: '', cocMax: '', ltvMin: '', ltvMax: '', search: '', clientEquity: false, quickDst: false, quickNoDebt: false, quickUpreit: false },
  incomeChart: null,
  dstCalcView: 'blended',
  dstOverrides: null,
  headers: [],
  pb: loadPortfolioBuilder(),
  pbSearch: '',
  pbFilters: { propType: 'all', sponsor: 'all', sector: 'all', quickDst: false },
  pbCharts: {}
};

function loadClient() {
  try { return JSON.parse(localStorage.getItem('afl_client')) || {}; } catch { return {}; }
}
function saveClient() { localStorage.setItem('afl_client', JSON.stringify(STATE.client)); }
function saveBasket() { localStorage.setItem('afl_basket', JSON.stringify(STATE.basket)); }
function loadPortfolioBuilder() {
  try { const r = localStorage.getItem('afl_pb_v2'); if (r) { const d = JSON.parse(r); if (d && Array.isArray(d.portfolios) && d.portfolios.length) return d; } } catch(e) {}
  return { portfolios: [{ id: 'p_default', name: 'My Portfolio', allocations: {} }], activeId: 'p_default' };
}
function savePB() { localStorage.setItem('afl_pb_v2', JSON.stringify(STATE.pb)); }
function activePB() { return STATE.pb.portfolios.find(p => p.id === STATE.pb.activeId) || STATE.pb.portfolios[0]; }
function fmtPct(v) { return v != null && !isNaN(v) ? v.toFixed(2) + '%' : '—'; }
function fmtMoney(v) { if (v == null || isNaN(v)) return '—'; if (v >= 1e6) return '$' + (v / 1e6).toFixed(1) + 'M'; if (v >= 1e3) return '$' + (v / 1e3).toFixed(0) + 'K'; return '$' + v.toLocaleString(); }
function fmtMoneyFull(v) { return v != null && !isNaN(v) ? '$' + v.toLocaleString() : '—'; }
function fmtNum(v, d = 2) { return v != null && !isNaN(v) ? v.toFixed(d) : '—'; }
function parsePct(s) { if (s == null || s === '') return null; let str = String(s).trim(); let hadPct = str.includes('%'); let n = parseFloat(str.replace(/[%,]/g, '')); if (isNaN(n)) return null; if (!hadPct && Math.abs(n) <= 1 && n !== 0) n = n * 100; return n; }
function parseMoney(s) { if (s == null || s === '') return null; let str = String(s).trim().replace(/[$,]/g, ''); let n = parseFloat(str); if (isNaN(n)) return null; return n; }
function parseMoneyM(s) { if (s == null || s === '') return null; let str = String(s).trim().replace(/[$,]/g, ''); let n = parseFloat(str); if (isNaN(n)) return null; if (n > 0 && n < 999) n = n * 1000000; return n; }
function parseDate(s) { if (!s) return null; if (typeof s === 'string' && s.startsWith('Date(')) { let parts = s.replace('Date(','').replace(')','').split(',').map(Number); return new Date(parts[0], parts[1], parts[2]); } let d = new Date(s); return isNaN(d) ? null : d; }
function peerDelta(val, avg, unit) { if (val == null || avg == null) return ''; let d = val - avg; let u = unit || '%'; let arrow = d > 0.1 ? '↑' : d < -0.1 ? '↓' : '~'; let cls = d > 0.1 ? 'up' : d < -0.1 ? 'down' : 'neutral'; return `<span class="peer-delta ${cls}">${arrow} ${Math.abs(d).toFixed(1)}${u} vs avg</span>`; }
function toast(msg, type = 'success') { let t = document.createElement('div'); t.className = 'toast toast-' + type; t.innerHTML = (type === 'success' ? '✓' : '⚠') + ' ' + msg; document.getElementById('toast-container').appendChild(t); setTimeout(() => t.remove(), 3200); }

/* ═══════════════════════════════════════════
   DATA LAYER — Google Sheets via GViz
═══════════════════════════════════════════ */
function fetchSheetData() {
  const dot = document.getElementById('status-dot');
  const txt = document.getElementById('status-text');
  dot.className = 'pulse-dot loading'; txt.textContent = 'Loading data…';
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
  fetch(url)
    .then(r => r.text())
    .then(raw => {
      const json = JSON.parse(raw.substring(raw.indexOf('{'), raw.lastIndexOf('}') + 1));
      const cols = json.table.cols.map(c => c.label || '');
      STATE.headers = cols;
      const rows = json.table.rows;
      STATE.funds = rows.map((row, idx) => {
        const g = (label) => { let ci = cols.findIndex(c => c.trim() === label.trim()); return ci >= 0 && row.c[ci] ? (row.c[ci].v ?? null) : null; };
        const gf = (label) => { let ci = cols.findIndex(c => c.trim() === label.trim()); return ci >= 0 && row.c[ci] ? (row.c[ci].f || row.c[ci].v || null) : null; };
        const income = [];
        for (let y = 1; y <= 10; y++) { income.push(parsePct(g('Year ' + y))); }
        if (income[0] == null) income[0] = parsePct(g('Year 1 Cash on Cash'));

        // Status: derive from dates + structure
        let status = 'Open';
        const oClose = parseDate(gf('Offering Close'));
        const oOpen = parseDate(gf('Offering Open'));
        const struct = g('Offering Structure') || '';
        const now = new Date();
        if (oOpen && oOpen > now) status = 'Coming Soon';
        else if (oClose && oClose < now) status = 'Closed';
        else if (oClose) { const daysLeft = (oClose - now) / 86400000; if (daysLeft < 60) status = 'Closing'; }

        // Compute pctRaised from Filed vs Remaining
        const filedRaise = parseMoneyM(g('Filed Raise'));
        const currentRaise = parseMoneyM(g('Current Raise'));
        const remainingRaise = parseMoneyM(g('Remaining Raise'));
        const totalRaise = currentRaise || filedRaise;
        let pctRaised = null;
        let pctRemaining = null;
        if (filedRaise && remainingRaise != null) {
          pctRemaining = Math.round((remainingRaise / filedRaise) * 100);
          pctRaised = 100 - pctRemaining;
          if (pctRemaining < 0) pctRemaining = 0;
          if (pctRemaining > 100) pctRemaining = 100;
          if (pctRaised < 0) pctRaised = 0;
          if (pctRaised > 100) pctRaised = 100;
        }

        // Compute months on market
        let monthsOnMarket = null;
        if (oOpen) { monthsOnMarket = Math.round((now - oOpen) / (30.44 * 86400000)); if (monthsOnMarket < 0) monthsOnMarket = null; }

        const obj = {
          id: idx,
          name: g('Offering Name') || 'Unnamed',
          sponsor: g('Sponsor') || '',
          status: status,
          propType: g('Asset Class') || '',
          sector: g('Sector') || '',
          focus: g('Focus') || '',
          location: g('Property Location(s)') || '',
          y1coc: parsePct(g('Year 1 Cash on Cash')),
          avgCoc: null,
          minInvest: parseMoney(g('Minimum - DST')),
          totalRaise: totalRaise,
          filedRaise: filedRaise,
          currentRaise: currentRaise,
          equityRemaining: remainingRaise,
          pctRaised: pctRaised,
          pctRemaining: pctRemaining,
          ltv: parsePct(g('Loan to Value')),
          dscr: parsePct(g('DSCR')),
          dscrStress: null,
          holdPeriod: parseInt(g('Hold Period')) || null,
          occupancy: parsePct(g('% Leased')),
          purchasePrice: parseMoneyM(g('Purchase Price (Unloaded)')),
          appraisedValue: parseMoneyM(g('Appraised Valuation')),
          loadedPrice: parseMoneyM(g('Loaded Price')),
          units: parseInt(g('# Assets')) || null,
          sqft: parseFloat(String(g('Total Square Footage') || '').replace(/[,\s]/g, '')) || null,
          pricePerUnit: null,
          pricePerSqFt: null, // computed below
          acqCapRate: parsePct(g('Acquisition Cap Rate')),
          avgLeaseTerm: parseFloat(g('Average Lease Term Remaining')) || null,
          tenantCredit: g('Tenant Credit Quality') || '',
          sponsorLogoUrl: g('Sponsor Logo URL') || '',
          quarterlyUpdateUrl: g('Quarterly Update URL') || '',
          leaseTerms: g('Lease Terms') || '',
          debtTerms: g('Debt Terms') || '',
          rentEscalations: g('Rent Escalations') || '',
          distFrequency: g('Distribution Frequency') || '',
          preferred: g('Preferred') || '',
          promote: g('Promote') || '',
          upReit: g('721 UpREIT') || '',
          exemption: g('Exemption') || '',
          taxReporting: g('Tax Reporting') || '',
          repComp: g('Rep Comp') || '',
          salesLoad: g('Sales Load') || '',
          reserve: g('Reserve') || '',
          gpCommit: g('GP Commit') || '',
          buildingAge: g('Building Age (Avg)') || '',
          brochureUrl: g('Brochure'),
          ppmUrl: g('PPM'),
          trackRecordUrl: g('Track Record'),
          salesTeamUrl: g('Sales Team Map'),
          videoUrl: g('Video'),
          sponsorNewsUrl: g('Sponsor News'),
          aiChatUrl: g('AI Offering Chat'),
          sponsorAum: g('Sponsor AUM') || '',
          sponsorOfferings: g('Number of Sponsor Offerings') || '',
          sponsorExits: g('Sponsor Full Cycle Exits') || '',
          sponsorAvgIrr: parsePct(g('Sponsor Average IRR')),
          sponsorBestIrr: parsePct(g('Sponsor Best IRR')),
          sponsorWorstIrr: parsePct(g('Sponsor Worst IRR')),
          sponsorExperience: g('Sponsor Experience') || '',
          openDate: oOpen,
          closeDate: oClose,
          monthsOnMarket: monthsOnMarket,
          income: income,
          raiseVelocity: null,
          _raw: row.c
        };
        // Computed: Price per SF
        if (obj.purchasePrice && obj.sqft && obj.sqft > 0) obj.pricePerSqFt = obj.purchasePrice / obj.sqft;
        // Computed: Raise velocity per month
        if (obj.filedRaise && obj.equityRemaining != null && obj.monthsOnMarket && obj.monthsOnMarket > 0) {
          const raised = obj.filedRaise - obj.equityRemaining;
          if (raised > 0) obj.raiseVelocity = raised / obj.monthsOnMarket;
        }
        return obj;
      }).filter(f => f.name !== 'Unnamed');
      computePeerStats();
      dot.className = 'pulse-dot'; txt.textContent = STATE.funds.length + ' offerings live';
      renderApp();
    })
    .catch(err => {
      console.error('Fetch error:', err);
      dot.className = 'pulse-dot error'; txt.textContent = 'Data error';
    });
}

function computePeerStats() {
  const fs = STATE.funds;
  const vals = (fn) => fs.map(fn).filter(v => v != null);
  const avg = (arr) => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : null;
  STATE.peer = {
    avgY1CoC: avg(vals(f => f.y1coc)),
    avgLTV: avg(vals(f => f.ltv)),
    avgOccupancy: avg(vals(f => f.occupancy)),
    avgMinInvest: avg(vals(f => f.minInvest)),
    avgDSCR: avg(vals(f => f.dscr)),
    avgHold: avg(vals(f => f.holdPeriod)),
    avgLeaseTerm: avg(vals(f => f.avgLeaseTerm)),
    count: fs.length
  };
}

/* ═══════════════════════════════════════════
   NAVIGATION & RENDER ENGINE
═══════════════════════════════════════════ */
function switchMode(mode) {
  STATE.mode = mode;
  document.querySelectorAll('.view-btn').forEach(b => b.classList.toggle('active', b.dataset.view === mode));
  const sb = document.getElementById('sidebar');
  sb.className = mode === 'compliance' ? 'compliance-mode' : mode === 'client_report' ? 'report-mode' : '';
  document.querySelectorAll('.nav-content').forEach(n => n.style.display = 'none');
  document.getElementById('nav-' + mode).style.display = '';
  STATE.view = mode === 'advisor' ? 'dashboard' : mode === 'client_report' ? 'report_summary' : 'comp_dashboard';
  renderApp();
}

function navigateTo(view, offeringId) {
  // Route offering_detail clicks to basket view with that offering selected
  if (view === 'offering_detail' && offeringId !== undefined) {
    if (!STATE.basket.includes(offeringId)) {
      // Clear basket and set to just this offering for single-view
      STATE.basket = [offeringId];
      saveBasket();
    }
    STATE.view = 'basket';
    renderApp();
    return;
  }
  STATE.view = view;
  if (offeringId !== undefined) STATE.selectedOfferingId = offeringId;
  renderApp();
}

function renderApp() {
  buildNav();
  const container = document.getElementById('view-content');
  container.className = 'fade-in' + (STATE.mode === 'compliance' ? ' compliance-mode' : '');
  let html = '';
  switch (STATE.view) {
    case 'dashboard': html = renderDashboard(); break;
    case 'browse': html = renderBrowse(); break;
    case 'basket': html = renderBasket(); break;
    case 'portfolio_builder': html = renderPortfolioBuilder(); break;
    case 'model': html = renderModel(); break;
    default: html = renderPlaceholder(STATE.view);
  }
  container.innerHTML = html;
  attachViewHandlers();
}

function renderPlaceholder(view) {
  const labels = {
    portfolio_builder: 'DST Portfolio Builder', model: 'Model for Client', comp_dashboard: 'Compliance Dashboard',
    comp_review: 'Offering Review Queue', comp_reports: 'Compliance Reports', comp_audit: 'Audit Trail',
    report_summary: 'Client Report Summary', report_builder: 'Report Builder', report_templates: 'Report Templates'
  };
  return `<div class="empty-state"><div class="empty-state-icon">🚧</div><h3>${labels[view] || view}</h3><p>Coming in Phase 2. This module will be built out in the next development sprint.</p></div>`;
}

function buildNav() {
  const advisorNav = [
    { icon: '📊', label: 'Dashboard', view: 'dashboard' },
    { icon: '🔍', label: 'Browse Offerings', view: 'browse', badge: STATE.funds.length },
    { icon: '🛒', label: 'Basket', view: 'basket', badge: STATE.basket.length || null },
    { icon: '📐', label: 'DST Portfolio Builder', view: 'portfolio_builder', badge: Object.keys(activePB().allocations).length || null },
    { icon: '🧮', label: 'Model for Client', view: 'model' }
  ];
  const compNav = [
    { icon: '🛡️', label: 'Dashboard', view: 'comp_dashboard' },
    { icon: '📋', label: 'Offering Review', view: 'comp_review' },
    { icon: '📊', label: 'Reports', view: 'comp_reports' },
    { icon: '📜', label: 'Audit Trail', view: 'comp_audit' }
  ];
  const reportNav = [
    { icon: '📄', label: 'Summary', view: 'report_summary' },
    { icon: '🛠️', label: 'Builder', view: 'report_builder' },
    { icon: '📋', label: 'Templates', view: 'report_templates' }
  ];
  const renderNavItems = (items) => items.map(i => `<button class="nav-item ${STATE.view === i.view ? 'active' : ''}" onclick="navigateTo('${i.view}')"><span class="nav-icon">${i.icon}</span>${i.label}${i.badge ? `<span class="nav-badge">${i.badge}</span>` : ''}</button>`).join('');
  document.getElementById('nav-advisor').innerHTML = `<div class="nav-section"><div class="nav-label">Platform</div>${renderNavItems(advisorNav)}</div>`;
  document.getElementById('nav-compliance').innerHTML = `<div class="nav-section"><div class="nav-label">Compliance</div>${renderNavItems(compNav)}</div>`;
  document.getElementById('nav-client_report').innerHTML = `<div class="nav-section"><div class="nav-label">Client Reports</div>${renderNavItems(reportNav)}</div>`;
}

function updateClientBadge() {
  const c = STATE.client;
  const icon = document.getElementById('client-badge-icon');
  const name = document.getElementById('badge-name');
  const eq = document.getElementById('badge-equity');
  if (c.name) {
    icon.textContent = c.name.split(' ').map(w => w[0]).join('').substring(0, 2);
    name.textContent = c.name;
    eq.textContent = c.exchangeAmount ? fmtMoney(c.exchangeAmount) + ' exchange' : c.firm || 'Client active';
  } else {
    icon.textContent = '?'; name.textContent = 'No Client'; eq.textContent = 'Set up client profile';
  }
}

/* ═══════════════════════════════════════════
   CLIENT PROFILE MODAL
═══════════════════════════════════════════ */
function openProfileModal() {
  const c = STATE.client;
  document.getElementById('modal-container').innerHTML = `
    <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
      <div class="modal">
        <div class="modal-header"><div><div class="modal-title">Client Profile</div><div class="modal-subtitle">Configure client parameters for suitability matching</div></div><button class="modal-close" onclick="closeModal()">✕</button></div>
        <div class="modal-body">
          <div class="form-grid">

            <div class="form-group form-grid-full" style="border-bottom:1px solid var(--mist);padding-bottom:14px;margin-bottom:4px">
              <div style="font-size:10px;font-weight:700;letter-spacing:.08em;color:var(--slate2);text-transform:uppercase;margin-bottom:10px">Advisor Info</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px">
                <div><label class="form-label">Financial Advisor Name</label><input class="form-input" id="cp-fa-name" value="${c.faName || ''}" placeholder="Jane Smith, CFP"></div>
                <div><label class="form-label">Firm / Broker-Dealer</label><input class="form-input" id="cp-firm" value="${c.firm || ''}" placeholder="Broker-dealer"></div>
              </div>
              <div>
                <label class="form-label">Firm Logo</label>
                <div style="display:flex;align-items:center;gap:12px">
                  ${c.firmLogo ? `<img id="cp-logo-preview" src="${c.firmLogo}" style="height:36px;max-width:140px;object-fit:contain;border:1px solid var(--mist);border-radius:6px;padding:4px;background:#fff">` : `<div id="cp-logo-preview" style="height:36px;width:100px;border:1.5px dashed var(--mist);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--slate2)">No logo</div>`}
                  <label style="cursor:pointer;display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border:1.5px solid var(--mist);border-radius:8px;font-size:12px;font-weight:500;color:var(--slate);background:var(--white);transition:all var(--transition)" onmouseover="this.style.borderColor='var(--navy)'" onmouseout="this.style.borderColor='var(--mist)'">
                    📁 Upload Logo
                    <input type="file" accept="image/*" style="display:none" onchange="cpHandleLogoUpload(this)">
                  </label>
                  ${c.firmLogo ? `<button onclick="cpClearLogo()" style="font-size:11px;color:var(--slate2);background:none;border:none;cursor:pointer;padding:0">✕ Remove</button>` : ''}
                </div>
                <div style="font-size:10.5px;color:var(--slate2);margin-top:5px">PNG or SVG recommended. Appears on client-facing reports.</div>
              </div>
            </div>

            <div class="form-group form-grid-full" style="margin-bottom:4px">
              <div style="font-size:10px;font-weight:700;letter-spacing:.08em;color:var(--slate2);text-transform:uppercase;margin-bottom:10px">Client Info</div>
            </div>

            <div class="form-group"><label class="form-label">Client Name</label><input class="form-input" id="cp-name" value="${c.name || ''}" placeholder="Full name"></div>
            <div class="form-group"><label class="form-label">Age</label><input class="form-input" type="number" id="cp-age" value="${c.age || ''}" placeholder="65"></div>
            <div class="form-group"><label class="form-label">Filing Status</label><select class="form-select" id="cp-filing"><option value="">Select</option><option value="single" ${c.filing === 'single' ? 'selected' : ''}>Single</option><option value="married" ${c.filing === 'married' ? 'selected' : ''}>Married Filing Jointly</option><option value="trust" ${c.filing === 'trust' ? 'selected' : ''}>Trust</option></select></div>
            <div class="form-group"><label class="form-label">1031 Exchange Amount</label><input class="form-input" id="cp-exchange" value="${c.exchangeAmount || ''}" placeholder="$500,000"></div>
            <div class="form-group"><label class="form-label">Annual Income</label><input class="form-input" id="cp-income" value="${c.annualIncome || ''}" placeholder="$200,000"></div>
            <div class="form-group"><label class="form-label">Net Worth</label><input class="form-input" id="cp-networth" value="${c.netWorth || ''}" placeholder="$2,000,000"></div>
            <div class="form-group"><label class="form-label">Risk Tolerance</label><select class="form-select" id="cp-risk"><option value="">Select</option><option value="conservative" ${c.riskTolerance === 'conservative' ? 'selected' : ''}>Conservative</option><option value="moderate" ${c.riskTolerance === 'moderate' ? 'selected' : ''}>Moderate</option><option value="growth" ${c.riskTolerance === 'growth' ? 'selected' : ''}>Growth</option></select></div>
            <div class="form-group"><label class="form-label">Investment Horizon</label><select class="form-select" id="cp-horizon"><option value="">Select</option><option value="short" ${c.horizon === 'short' ? 'selected' : ''}>Short (3-5 yr)</option><option value="medium" ${c.horizon === 'medium' ? 'selected' : ''}>Medium (5-10 yr)</option><option value="long" ${c.horizon === 'long' ? 'selected' : ''}>Long (10+ yr)</option></select></div>
            <div class="form-group"><label class="form-label">State</label><input class="form-input" id="cp-state" value="${c.state || ''}" placeholder="CA, TX, FL..."></div>

            <div class="form-group form-grid-full">
              <label class="form-label">Investment Objective <span style="font-size:10.5px;font-weight:400;color:var(--slate2)">(select one)</span></label>
              <div class="checkbox-group" id="cp-objectives">
                ${['Income', 'Preservation', 'Growth', 'Tax Deferral', 'Diversification', 'Estate Planning'].map(o => `<div class="checkbox-pill ${(c.objectives || []).includes(o) ? 'checked' : ''}" data-val="${o}" onclick="cpObjectiveClick(this)">${o}</div>`).join('')}
              </div>
            </div>

            <div class="form-group form-grid-full">
              <label class="form-label">Property Type Preferences <span style="font-size:10.5px;font-weight:400;color:var(--slate2)">(select all that apply)</span></label>
              <div class="checkbox-group" id="cp-proptypes">
                ${['Multifamily', 'Industrial', 'NNN Retail', 'Medical', 'Office', 'Self-Storage', 'Hospitality', 'Senior Living', 'Student Housing'].map(p => `<div class="checkbox-pill ${(c.propTypes || []).includes(p) ? 'checked' : ''}" data-val="${p}" onclick="cpPropTypeClick(this)">${p}</div>`).join('')}
              </div>
            </div>

            <div class="form-group form-grid-full"><label class="form-label">Notes</label><textarea class="form-input" id="cp-notes" style="height:60px;padding:10px;resize:vertical" placeholder="Additional notes...">${c.notes || ''}</textarea></div>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveProfile()">💾 Save Profile</button></div>
      </div>
    </div>`;
}

function saveProfile() {
  STATE.client = {
    name: document.getElementById('cp-name').value.trim(),
    faName: document.getElementById('cp-fa-name').value.trim(),
    firm: document.getElementById('cp-firm').value.trim(),
    firmLogo: STATE._pendingLogo !== undefined ? STATE._pendingLogo : (STATE.client.firmLogo || null),
    age: parseInt(document.getElementById('cp-age').value) || null,
    filing: document.getElementById('cp-filing').value,
    exchangeAmount: parseMoney(document.getElementById('cp-exchange').value),
    annualIncome: parseMoney(document.getElementById('cp-income').value),
    netWorth: parseMoney(document.getElementById('cp-networth').value),
    riskTolerance: document.getElementById('cp-risk').value,
    horizon: document.getElementById('cp-horizon').value,
    state: document.getElementById('cp-state').value.trim(),
    objectives: [...document.querySelectorAll('#cp-objectives .checked')].map(el => el.dataset.val),
    propTypes: [...document.querySelectorAll('#cp-proptypes .checked')].map(el => el.dataset.val),
    notes: document.getElementById('cp-notes').value.trim()
  };
  STATE._pendingLogo = undefined;
  saveClient();
  updateClientBadge();
  closeModal();
  toast('Client profile saved');
  if (STATE.view === 'dashboard') renderApp();
}

function closeModal() { document.getElementById('modal-container').innerHTML = ''; }

/* ═══════════════════════════════════════════
   DASHBOARD VIEW
═══════════════════════════════════════════ */
function renderDashboard() {
  const c = STATE.client;
  const fs = STATE.funds;
  const hasClient = !!(c.name && (c.riskTolerance || c.exchangeAmount || c.age || (c.objectives && c.objectives.length) || (c.propTypes && c.propTypes.length) || c.horizon));
  const profileCard = `
    <div class="profile-card">
      ${c.firmLogo ? `<div style="padding:12px 16px 0;display:flex;align-items:center;gap:10px"><img src="${c.firmLogo}" style="height:28px;max-width:110px;object-fit:contain"></div>` : ''}
      <div class="profile-card-header"><h3>Active Client</h3>
        <div class="profile-card-name">${c.name || 'No Client Set'}</div>
        <div class="profile-card-firm">${c.faName ? `${c.faName}${c.firm ? ' · ' + c.firm : ''}` : (c.firm || 'Configure client profile to begin')}</div>
      </div>
      <div class="profile-card-body">
        ${hasClient ? `
          ${c.exchangeAmount ? `<div class="profile-row"><span class="profile-key">1031 Exchange</span><span class="profile-val">${fmtMoney(c.exchangeAmount)}</span></div>` : ''}
          ${c.age ? `<div class="profile-row"><span class="profile-key">Age</span><span class="profile-val">${c.age}</span></div>` : ''}
          ${c.riskTolerance ? `<div class="profile-row"><span class="profile-key">Risk Tolerance</span><span class="profile-val" style="text-transform:capitalize">${c.riskTolerance}</span></div>` : ''}
          ${c.horizon ? `<div class="profile-row"><span class="profile-key">Horizon</span><span class="profile-val" style="text-transform:capitalize">${c.horizon}</span></div>` : ''}
          ${c.objectives && c.objectives.length ? `<div class="profile-row"><span class="profile-key">Objective</span><span class="profile-val" style="font-size:11px">${c.objectives.join(', ')}</span></div>` : ''}
          ${c.propTypes && c.propTypes.length ? `<div class="profile-row"><span class="profile-key">Prop Types</span><span class="profile-val" style="font-size:11px">${c.propTypes.join(', ')}</span></div>` : ''}
          ${c.state ? `<div class="profile-row"><span class="profile-key">State</span><span class="profile-val">${c.state}</span></div>` : ''}
        ` : '<div style="text-align:center;padding:12px 0;color:var(--slate2);font-size:13px">Click to set up client profile</div>'}
      </div>
      <div class="profile-card-footer">
        <button class="btn btn-secondary btn-sm" onclick="openProfileModal()" style="flex:1">✏️ ${hasClient ? 'Edit' : 'Set Up'} Profile</button>
        ${hasClient ? `<button class="btn btn-ghost btn-sm" onclick="clearClient()">Clear</button>` : ''}
      </div>
    </div>`;

  const suitScores = hasClient ? fs.map(f => {
    const score = computeDashboardSuitScore(f, c);
    return { ...f, suitScore: score };
  }).filter(f => f.suitScore !== null).sort((a, b) => b.suitScore - a.suitScore) : [];

  const topPicks = hasClient ? suitScores.slice(0, 3).map((f, i) => `
    <div class="offering-card card-enter" style="animation-delay:${i * 0.08}s" onclick="navigateTo('offering_detail',${f.id})">
      <div class="offering-card-header">
        <div><div class="offering-name">${f.name}</div><div class="offering-sponsor">${f.sponsor}</div></div>
        <span class="suit-score ${f.suitScore >= 70 ? 'high' : f.suitScore >= 45 ? 'medium' : 'low'}">${f.suitScore}% match</span>
      </div>
      <div class="offering-metrics">
        <div class="offering-metric-item"><div class="label">Y1 CoC</div><div class="value">${fmtPct(f.y1coc)}</div></div>
        <div class="offering-metric-item"><div class="label">LTV</div><div class="value">${fmtPct(f.ltv)}</div></div>
      </div>
      <div class="offering-badges"><span class="badge badge-navy">${f.propType || 'DST'}</span><span class="badge badge-green">${f.status}</span></div>
    </div>
  `).join('') : '';

  const statsHtml = `
    <div class="quick-stats">
      <div class="stat-card card-enter" style="animation-delay:0s"><div class="stat-val">${fs.length}</div><div class="stat-label">Active Offerings</div></div>
      <div class="stat-card card-enter" style="animation-delay:0.06s"><div class="stat-val">${fmtPct(STATE.peer.avgY1CoC)}</div><div class="stat-label">Avg Y1 CoC</div></div>
      <div class="stat-card card-enter" style="animation-delay:0.12s"><div class="stat-val">${STATE.basket.length}</div><div class="stat-label">In Basket</div></div>
      <div class="stat-card card-enter" style="animation-delay:0.18s"><div class="stat-val">${fs.filter(f => f.status === 'Open').length}</div><div class="stat-label">Open Now</div></div>
    </div>`;

  return `
    <div class="page-header"><div><div class="page-title">Dashboard</div><div class="page-subtitle">${hasClient ? 'Personalized for ' + c.name : 'Set up a client profile to enable matching'}</div></div></div>
    ${statsHtml}
    <div class="dashboard-grid">
      ${profileCard}
      <div>
        ${hasClient ? `
          <div class="suggested-header"><div><div class="suggested-title">Top Matches</div><div class="suggested-sub">Based on client profile suitability</div></div>
            <button class="btn btn-secondary btn-sm" onclick="navigateTo('browse')">View All →</button>
          </div>
          <div class="offering-grid" style="grid-template-columns:repeat(auto-fill,minmax(240px,1fr))">${topPicks}</div>
        ` : `
          <div class="start-here-card"><div class="start-here-icon">🎯</div><div class="start-here-title">Start by Setting Up a Client</div>
            <div class="start-here-text">Configure your client's profile — age, exchange amount, risk tolerance, and property preferences — to unlock personalized DST matching and suitability scores across all ${fs.length} offerings.</div>
            <button class="btn btn-primary" onclick="openProfileModal()">⚙️ Set Up Client Profile</button>
          </div>
        `}
      </div>
    </div>`;
}

function clearClient() { STATE.client = {}; saveClient(); updateClientBadge(); renderApp(); toast('Client cleared'); }

/* ═══════════════════════════════════════════
   BROWSE VIEW
═══════════════════════════════════════════ */
function getFilteredFunds() {
  const f = STATE.browseFilters;
  let funds = [...STATE.funds];
  if (f.status !== 'all') funds = funds.filter(x => x.status === f.status);
  if (f.propType !== 'all') funds = funds.filter(x => x.propType.toLowerCase().includes(f.propType.toLowerCase()));
  if (f.sponsor !== 'all') funds = funds.filter(x => x.sponsor === f.sponsor);
  if (f.sector !== 'all') funds = funds.filter(x => x.sector === f.sector);
  if (f.focus !== 'all') funds = funds.filter(x => x.focus === f.focus);
  if (f.cocMin) funds = funds.filter(x => x.y1coc != null && x.y1coc >= parseFloat(f.cocMin));
  if (f.cocMax) funds = funds.filter(x => x.y1coc != null && x.y1coc <= parseFloat(f.cocMax));
  if (f.ltvMin) funds = funds.filter(x => x.ltv != null && x.ltv >= parseFloat(f.ltvMin));
  if (f.ltvMax) funds = funds.filter(x => x.ltv != null && x.ltv <= parseFloat(f.ltvMax));
  if (f.clientEquity && STATE.client.exchangeAmount) funds = funds.filter(x => x.minInvest && x.minInvest <= STATE.client.exchangeAmount);
  if (f.quickDst) funds = funds.filter(x => (x.propType || '').toLowerCase().includes('dst') || (x._raw && STATE.headers && (() => { const ci = STATE.headers.findIndex(h => h.trim() === 'Offering Structure'); return ci >= 0 && x._raw[ci] && String(x._raw[ci].v || x._raw[ci].f || '').toLowerCase().includes('dst'); })()));
  if (f.quickNoDebt) funds = funds.filter(x => { const ltv = x.ltv; const raw = String(x.debtTerms || '').toLowerCase(); return (ltv != null && Math.abs(ltv) < 0.01) || raw.includes('no debt') || raw.includes('all cash') || raw.includes('all-cash'); });
  if (f.quickUpreit) funds = funds.filter(x => String(x.upReit || '').toLowerCase().includes('721 only'));
  if (f.search) { let s = f.search.toLowerCase(); funds = funds.filter(x => x.name.toLowerCase().includes(s) || x.sponsor.toLowerCase().includes(s) || x.propType.toLowerCase().includes(s) || x.location.toLowerCase().includes(s)); }
  const sortMap = {
    y1coc_desc: (a, b) => (b.y1coc || 0) - (a.y1coc || 0),
    y1coc_asc: (a, b) => (a.y1coc || 0) - (b.y1coc || 0),
    ltv_asc: (a, b) => (a.ltv || 999) - (b.ltv || 999),
    ltv_desc: (a, b) => (b.ltv || 0) - (a.ltv || 0),
    min_asc: (a, b) => (a.minInvest || 999999) - (b.minInvest || 999999),
    name_asc: (a, b) => a.name.localeCompare(b.name),
    status: (a, b) => { const o = { 'Open': 0, 'Closing': 1, 'Coming Soon': 2 }; return (o[a.status] || 9) - (o[b.status] || 9); }
  };
  funds.sort(sortMap[STATE.browseSort] || sortMap.y1coc_desc);
  return funds;
}

function renderBrowse() {
  const funds = getFilteredFunds();
  const sponsors = [...new Set(STATE.funds.map(f => f.sponsor).filter(Boolean))].sort();
  const propTypes = [...new Set(STATE.funds.map(f => f.propType).filter(Boolean))].sort();
  const sectors = [...new Set(STATE.funds.map(f => f.sector).filter(Boolean))].sort();
  const focuses = [...new Set(STATE.funds.map(f => f.focus).filter(Boolean))].sort();
  const f = STATE.browseFilters;
  const activeFilters = [];
  if (f.status !== 'all') activeFilters.push({ label: f.status, key: 'status' });
  if (f.propType !== 'all') activeFilters.push({ label: f.propType, key: 'propType' });
  if (f.sponsor !== 'all') activeFilters.push({ label: f.sponsor, key: 'sponsor' });
  if (f.sector !== 'all') activeFilters.push({ label: f.sector, key: 'sector' });
  if (f.focus !== 'all') activeFilters.push({ label: f.focus, key: 'focus' });
  if (f.cocMin || f.cocMax) activeFilters.push({ label: `CoC ${f.cocMin || '0'}–${f.cocMax || '∞'}%`, key: 'coc' });
  if (f.ltvMin || f.ltvMax) activeFilters.push({ label: `LTV ${f.ltvMin || '0'}–${f.ltvMax || '∞'}%`, key: 'ltv' });
  if (f.clientEquity) activeFilters.push({ label: 'Fits Exchange', key: 'clientEquity' });
  if (f.quickDst) activeFilters.push({ label: 'DST Only', key: 'quickDst' });
  if (f.quickNoDebt) activeFilters.push({ label: 'No Debt', key: 'quickNoDebt' });
  if (f.quickUpreit) activeFilters.push({ label: '721 UpREIT Only', key: 'quickUpreit' });

  const filterHtml = `
    <div class="filter-bar">
      <input class="search-input" placeholder="Search offerings..." value="${f.search}" oninput="STATE.browseFilters.search=this.value;renderApp()">
      <select class="filter-select" onchange="STATE.browseFilters.status=this.value;renderApp()">
        <option value="all" ${f.status === 'all' ? 'selected' : ''}>All Status</option>
        <option value="Open" ${f.status === 'Open' ? 'selected' : ''}>Open</option>
        <option value="Closing" ${f.status === 'Closing' ? 'selected' : ''}>Closing</option>
        <option value="Coming Soon" ${f.status === 'Coming Soon' ? 'selected' : ''}>Coming Soon</option>
      </select>
      <select class="filter-select" onchange="STATE.browseFilters.propType=this.value;renderApp()">
        <option value="all" ${f.propType === 'all' ? 'selected' : ''}>All Types</option>
        ${propTypes.map(p => `<option value="${p}" ${f.propType === p ? 'selected' : ''}>${p}</option>`).join('')}
      </select>
      <select class="filter-select" onchange="STATE.browseFilters.sponsor=this.value;renderApp()">
        <option value="all" ${f.sponsor === 'all' ? 'selected' : ''}>All Sponsors</option>
        ${sponsors.map(s => `<option value="${s}" ${f.sponsor === s ? 'selected' : ''}>${s}</option>`).join('')}
      </select>
      <select class="filter-select" onchange="STATE.browseFilters.sector=this.value;renderApp()">
        <option value="all" ${f.sector === 'all' ? 'selected' : ''}>All Sectors</option>
        ${sectors.map(s => `<option value="${s}" ${f.sector === s ? 'selected' : ''}>${s}</option>`).join('')}
      </select>
      <select class="filter-select" onchange="STATE.browseFilters.focus=this.value;renderApp()">
        <option value="all" ${f.focus === 'all' ? 'selected' : ''}>All Focus</option>
        ${focuses.map(s => `<option value="${s}" ${f.focus === s ? 'selected' : ''}>${s}</option>`).join('')}
      </select>
    </div>
    <div class="filter-row-2">
      <button class="quick-filter-btn ${f.quickDst ? 'active' : ''}" onclick="STATE.browseFilters.quickDst=!STATE.browseFilters.quickDst;renderApp()">DST Only</button>
      <button class="quick-filter-btn ${f.quickNoDebt ? 'active' : ''}" onclick="STATE.browseFilters.quickNoDebt=!STATE.browseFilters.quickNoDebt;renderApp()">No Debt</button>
      <button class="quick-filter-btn ${f.quickUpreit ? 'active' : ''}" onclick="STATE.browseFilters.quickUpreit=!STATE.browseFilters.quickUpreit;renderApp()">721 UpREIT Only</button>
      <span class="filter-divider"></span>
      <div class="range-filter"><span>Cash on Cash</span><input placeholder="min" value="${f.cocMin}" oninput="STATE.browseFilters.cocMin=this.value;renderApp()"><span>–</span><input placeholder="max" value="${f.cocMax}" oninput="STATE.browseFilters.cocMax=this.value;renderApp()"><span>%</span></div>
      <div class="range-filter"><span>Loan to Value</span><input placeholder="min" value="${f.ltvMin}" oninput="STATE.browseFilters.ltvMin=this.value;renderApp()"><span>–</span><input placeholder="max" value="${f.ltvMax}" oninput="STATE.browseFilters.ltvMax=this.value;renderApp()"><span>%</span></div>
      ${STATE.client.exchangeAmount ? `<div class="equity-filter ${f.clientEquity ? 'active' : ''}" onclick="STATE.browseFilters.clientEquity=!STATE.browseFilters.clientEquity;renderApp()">💰 Fits ${fmtMoney(STATE.client.exchangeAmount)}</div>` : ''}
      <div style="flex:1"></div>
      <select class="sort-select" onchange="STATE.browseSort=this.value;renderApp()">
        <option value="y1coc_desc" ${STATE.browseSort === 'y1coc_desc' ? 'selected' : ''}>CoC: High → Low</option>
        <option value="y1coc_asc" ${STATE.browseSort === 'y1coc_asc' ? 'selected' : ''}>CoC: Low → High</option>
        <option value="ltv_asc" ${STATE.browseSort === 'ltv_asc' ? 'selected' : ''}>LTV: Low → High</option>
        <option value="ltv_desc" ${STATE.browseSort === 'ltv_desc' ? 'selected' : ''}>LTV: High → Low</option>
        <option value="min_asc" ${STATE.browseSort === 'min_asc' ? 'selected' : ''}>Min Invest: Low → High</option>
        <option value="name_asc" ${STATE.browseSort === 'name_asc' ? 'selected' : ''}>Name: A → Z</option>
        <option value="status" ${STATE.browseSort === 'status' ? 'selected' : ''}>Status</option>
      </select>
      <div class="view-toggle-group">
        <button class="view-toggle-btn ${STATE.browseLayout === 'card' ? 'active' : ''}" onclick="STATE.browseLayout='card';renderApp()">▦</button>
        <button class="view-toggle-btn ${STATE.browseLayout === 'table' ? 'active' : ''}" onclick="STATE.browseLayout='table';renderApp()">☰</button>
      </div>
    </div>`;

  const resultBar = `<div class="result-bar"><span class="result-count">${funds.length}</span> offerings${activeFilters.length ? ' · <span class="active-filter-chips">' + activeFilters.map(a => `<span class="filter-chip">${a.label}<button onclick="clearFilter('${a.key}')">✕</button></span>`).join('') + '</span>' : ''}</div>`;

  let listHtml = '';
  if (STATE.browseLayout === 'card') {
    listHtml = `<div class="offering-grid">${funds.map((fund, i) => renderOfferingCard(fund, i)).join('')}</div>`;
  } else {
    listHtml = renderOfferingTable(funds);
  }

  return `<div class="page-header"><div><div class="page-title">Browse Offerings</div><div class="page-subtitle">All active DST offerings from approved sponsors</div></div></div>${filterHtml}${resultBar}${listHtml}`;
}

function clearFilter(key) {
  if (key === 'coc') { STATE.browseFilters.cocMin = ''; STATE.browseFilters.cocMax = ''; }
  else if (key === 'ltv') { STATE.browseFilters.ltvMin = ''; STATE.browseFilters.ltvMax = ''; }
  else if (key === 'clientEquity') STATE.browseFilters.clientEquity = false;
  else if (key === 'quickDst') STATE.browseFilters.quickDst = false;
  else if (key === 'quickNoDebt') STATE.browseFilters.quickNoDebt = false;
  else if (key === 'quickUpreit') STATE.browseFilters.quickUpreit = false;
  else STATE.browseFilters[key] = 'all';
  renderApp();
}

function renderOfferingCard(fund, i) {
  const inBasket = STATE.basket.includes(fund.id);
  const statusCls = fund.status === 'Open' ? 'open' : fund.status === 'Closing' ? 'closing' : 'coming';
  const pctRaised = fund.pctRaised; const pctRemaining = fund.pctRemaining;
  return `
    <div class="offering-card card-enter" style="animation-delay:${Math.min(i * 0.04, 0.5)}s" onclick="navigateTo('offering_detail',${fund.id})">
      <div class="card-status-strip ${statusCls}"></div>
      <div class="offering-card-header">
        <div><div class="offering-name">${fund.name}</div><div class="offering-sponsor">${fund.sponsor}</div></div>
        <span class="badge badge-${statusCls === 'open' ? 'green' : statusCls === 'closing' ? 'amber' : 'blue'}">${fund.status}</span>
      </div>
      ${fund.location ? `<div class="offering-location">📍 ${fund.location}</div>` : ''}
      <div class="offering-metrics">
        <div class="offering-metric-item"><div class="label">Y1 CoC</div><div class="value">${fmtPct(fund.y1coc)}</div>${peerDelta(fund.y1coc, STATE.peer.avgY1CoC)}</div>
        <div class="offering-metric-item"><div class="label">LTV</div><div class="value">${fmtPct(fund.ltv)}</div>${peerDelta(fund.ltv, STATE.peer.avgLTV)}</div>
        <div class="offering-metric-item"><div class="label">Min Invest</div><div class="value">${fmtMoney(fund.minInvest)}</div></div>
        <div class="offering-metric-item"><div class="label">Hold</div><div class="value">${fund.holdPeriod ? fund.holdPeriod + ' yr' : '—'}</div></div>
      </div>
      <div class="offering-badges"><span class="badge badge-navy">${fund.propType || 'DST'}</span>${fund.occupancy ? `<span class="badge badge-green">${fmtPct(fund.occupancy)} Occupied</span>` : ''}</div>
      <div class="offering-card-footer">
        ${pctRemaining != null ? `<div style="flex:1"><div style="font-size:11px;color:var(--slate2)">${pctRemaining}% remaining${fund.equityRemaining ? ' · ' + fmtMoney(fund.equityRemaining) : ''}</div><div class="raise-bar"><div class="raise-fill" style="width:${Math.min(100 - pctRemaining, 100)}%"></div></div></div>` : '<div style="flex:1"></div>'}
        <button class="btn btn-sm ${inBasket ? 'btn-primary' : 'btn-secondary'}" onclick="event.stopPropagation();toggleBasket(${fund.id})">${inBasket ? '✓ In Basket' : '+ Basket'}</button>
      </div>
    </div>`;
}

function renderOfferingTable(funds) {
  const rows = funds.map(f => `
    <tr onclick="navigateTo('offering_detail',${f.id})">
      <td class="name-cell"><div>${f.name}</div><div style="font-size:11px;font-weight:400;color:var(--slate2)">${f.sponsor}</div></td>
      <td><span class="badge badge-${f.status === 'Open' ? 'green' : f.status === 'Closing' ? 'amber' : 'blue'}">${f.status}</span></td>
      <td>${f.propType}</td>
      <td class="num-cell ${f.y1coc && STATE.peer.avgY1CoC && f.y1coc > STATE.peer.avgY1CoC ? 'highlight-green' : ''}">${fmtPct(f.y1coc)}</td>
      <td class="num-cell ${f.ltv && f.ltv > 65 ? 'highlight-red' : ''}">${fmtPct(f.ltv)}</td>
      <td class="num-cell">${fmtMoney(f.minInvest)}</td>
      <td class="num-cell">${f.holdPeriod ? f.holdPeriod + 'yr' : '—'}</td>
      <td class="num-cell">${fmtPct(f.occupancy)}</td>
      <td><button class="btn btn-sm ${STATE.basket.includes(f.id) ? 'btn-primary' : 'btn-secondary'}" onclick="event.stopPropagation();toggleBasket(${f.id})">${STATE.basket.includes(f.id) ? '✓' : '+'}</button></td>
    </tr>`).join('');
  return `<div class="table-wrapper"><table class="offering-table"><thead><tr><th>Offering</th><th>Status</th><th>Type</th><th>Y1 CoC</th><th>LTV</th><th>Min</th><th>Hold</th><th>Occ</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

function toggleBasket(id) {
  const idx = STATE.basket.indexOf(id);
  if (idx >= 0) { STATE.basket.splice(idx, 1); }
  else { if (STATE.basket.length >= 3) { toast('Maximum 3 offerings. Remove one first.', 'error'); return; } STATE.basket.push(id); }
  saveBasket(); renderApp();
  toast(idx >= 0 ? 'Removed from basket' : 'Added to basket');
}

/* ═══════════════════════════════════════════
   STEP 5: OFFERING DETAIL VIEW (ENHANCED)
═══════════════════════════════════════════ */
function renderOfferingDetail() {
  const fund = STATE.funds.find(f => f.id === STATE.selectedOfferingId);
  if (!fund) return `<div class="empty-state"><div class="empty-state-icon">🔍</div><h3>No Offering Selected</h3><p>Select an offering from Browse or Dashboard.</p><button class="btn btn-primary" onclick="navigateTo('browse')">Browse Offerings</button></div>`;

  const inBasket = STATE.basket.includes(fund.id);
  const p = STATE.peer;
  const curIdx = STATE.funds.findIndex(f => f.id === fund.id);
  const prevFund = curIdx > 0 ? STATE.funds[curIdx - 1] : null;
  const nextFund = curIdx < STATE.funds.length - 1 ? STATE.funds[curIdx + 1] : null;

  // ── Navigation strip ──
  const navStrip = `
    <div class="detail-nav-strip">
      <div class="breadcrumb">
        <span style="cursor:pointer;text-decoration:underline" onclick="navigateTo('browse')">Browse</span>
        <span>›</span>
        <span class="crumb-name">${fund.name}</span>
      </div>
      <div class="detail-prev-next">
        <button ${prevFund ? `onclick="navigateTo('offering_detail',${prevFund.id})"` : 'disabled'}>← ${prevFund ? prevFund.name.substring(0, 18) : 'Prev'}</button>
        <button ${nextFund ? `onclick="navigateTo('offering_detail',${nextFund.id})"` : 'disabled'}>${nextFund ? nextFund.name.substring(0, 18) : 'Next'} →</button>
      </div>
    </div>`;

  // ── Hero Header ──
  const statusCls = fund.status === 'Open' ? 'green' : fund.status === 'Closing' ? 'amber' : 'blue';
  const heroTiles = [
    { label: 'Y1 Cash on Cash', value: fmtPct(fund.y1coc), delta: peerDelta(fund.y1coc, p.avgY1CoC) },
    { label: 'Loan to Value', value: fmtPct(fund.ltv), delta: peerDelta(fund.ltv, p.avgLTV) },
    { label: 'Min Investment', value: fmtMoney(fund.minInvest), delta: '' },
    { label: 'Hold Period', value: fund.holdPeriod ? fund.holdPeriod + ' yr' : '—', delta: '' }
  ];
  const hero = `
    <div class="panel detail-section" style="background:linear-gradient(135deg,var(--navy) 0%,var(--navy2) 100%);color:var(--white);border:none">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px;flex-wrap:wrap;gap:10px">
        <div><div style="font-size:22px;font-weight:800;letter-spacing:-0.02em">${fund.name}</div>
          <div style="font-size:13px;color:rgba(255,255,255,0.55);margin-top:3px">${fund.sponsor}${fund.location ? ' · ' + fund.location : ''}</div></div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <span class="badge badge-${statusCls}">${fund.status}</span>
          <span class="badge badge-navy">${fund.propType || 'DST'}</span>
        </div>
      </div>
      <div class="metric-grid" style="grid-template-columns:repeat(4,1fr)">
        ${heroTiles.map(t => `<div class="metric-tile" style="background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.12)"><div class="metric-label" style="color:rgba(255,255,255,0.5)">${t.label}</div><div class="metric-value" style="color:#fff">${t.value}</div>${t.delta ? `<div style="margin-top:3px">${t.delta}</div>` : ''}</div>`).join('')}
      </div>
    </div>`;

  // ── Document Buttons & Action Bar ──
  const docBtns = [
    { label: 'Brochure', url: fund.brochureUrl, icon: '📄' },
    { label: 'PPM', url: fund.ppmUrl, icon: '📋' },
    { label: 'Track Record', url: fund.trackRecordUrl, icon: '📊' },
    { label: 'Sales Team', url: fund.salesTeamUrl, icon: '👥' },
    { label: 'Video', url: fund.videoUrl, icon: '🎬' },
    { label: 'Sponsor News', url: fund.sponsorNewsUrl, icon: '📰' },
    { label: 'AI Chat', url: fund.aiChatUrl, icon: '🤖' }
  ];
  const docRow = `<div class="doc-btn-row"><span class="doc-label">Documents</span>${docBtns.map(d => `<button class="btn btn-sm btn-secondary" ${d.url ? `onclick="window.open('${d.url}','_blank')"` : 'disabled style="opacity:0.4"'}>${d.icon} ${d.label}</button>`).join('')}</div>`;
  const actionBar = `<div class="action-bar">
    <button class="btn ${inBasket ? 'btn-primary' : 'btn-secondary'}" onclick="toggleBasket(${fund.id})">${inBasket ? '✓ In Basket' : '🛒 Add to Basket'}</button>
    <button class="btn btn-secondary" onclick="pbAddFromDetail(${fund.id})">📐 Build Portfolio</button>
    <button class="btn btn-secondary" onclick="toast('Model coming Phase 2','error')">🧮 Model for Client</button>
    <button class="btn btn-ghost" onclick="toast('Compliance Report coming Phase 2','error')">🛡️ Compliance Report</button>
  </div>`;

  // ── Raise Progress & Timeline ──
  const pctRaised = fund.pctRaised; const pctRemaining = fund.pctRemaining;
  const daysRemaining = fund.closeDate ? Math.max(0, Math.round((fund.closeDate - new Date()) / 86400000)) : null;
  const totalDays = (fund.openDate && fund.closeDate) ? Math.max(1, Math.round((fund.closeDate - fund.openDate) / 86400000)) : null;
  const pctTimeElapsed = (totalDays && daysRemaining != null) ? Math.round(((totalDays - daysRemaining) / totalDays) * 100) : null;
  const pctTimeRemaining = pctTimeElapsed != null ? (100 - pctTimeElapsed) : null;
  const raiseSection = `
    <div class="panel detail-section">
      <div class="panel-title">\u{1F4CA} Raise Progress & Timeline</div>
      <div style="display:grid;gap:24px">
        <div>
          <div style="font-size:12px;font-weight:700;color:var(--slate);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:10px">Capital Raise</div>
          ${pctRemaining != null ? `
            <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px">
              <span style="font-weight:700;color:var(--navy)">${pctRemaining}% Remaining</span>
              <span style="color:var(--slate2)">${100 - pctRemaining}% Raised</span>
            </div>
            <div class="raise-bar" style="height:14px;border-radius:7px"><div class="raise-fill" style="width:${Math.min(100 - pctRemaining, 100)}%;border-radius:7px"></div></div>
            <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:12px;color:var(--slate)">
              <div style="display:flex;gap:14px;flex-wrap:wrap">
                ${fund.equityRemaining ? `<span>Remaining: <strong style="color:var(--navy)">${fmtMoney(fund.equityRemaining)}</strong></span>` : ''}
                ${fund.currentRaise ? `<span>Current Raise: <strong>${fmtMoney(fund.currentRaise)}</strong></span>` : ''}
              </div>
              <div>Filed Raise: <strong>${fmtMoney(fund.filedRaise)}</strong></div>
            </div>
          ` : '<div style="font-size:13px;color:var(--slate2)">Raise data not available</div>'}
        </div>
        <div>
          <div style="font-size:12px;font-weight:700;color:var(--slate);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:10px">Offering Timeline</div>
          ${pctTimeRemaining != null ? `
            <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px">
              <span style="font-weight:700;color:var(--navy)">${daysRemaining} Days Remaining</span>
              <span style="color:var(--slate2)">${fund.monthsOnMarket ? fund.monthsOnMarket + ' months on market' : pctTimeElapsed + '% elapsed'}</span>
            </div>
            <div class="timeline-bar" style="height:14px;border-radius:7px"><div class="timeline-fill" style="width:${Math.min(pctTimeElapsed, 100)}%;border-radius:7px"></div></div>
            <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:12px;color:var(--slate)">
              <span>Opened: <strong>${fund.openDate ? fund.openDate.toLocaleDateString() : '\u2014'}</strong></span>
              ${fund.monthsOnMarket ? `<span>On Market: <strong>${fund.monthsOnMarket} mo</strong></span>` : ''}
              <span>Est. Close: <strong>${fund.closeDate ? fund.closeDate.toLocaleDateString() : '\u2014'}</strong></span>
            </div>
          ` : `
            <div style="font-size:13px;color:var(--slate2)">
              ${fund.openDate ? 'Opened: <strong>' + fund.openDate.toLocaleDateString() + '</strong>' : ''}
              ${fund.monthsOnMarket ? ' \u00B7 On Market: <strong>' + fund.monthsOnMarket + ' mo</strong>' : ''}
              ${fund.closeDate ? ' \u00B7 Est. Close: <strong>' + fund.closeDate.toLocaleDateString() + '</strong>' : 'Timeline data not available'}
            </div>
          `}
        </div>
      </div>
    </div>`;




  // ── Purchase Price & Valuation ──
  const valDiscount = (fund.appraisedValue && fund.purchasePrice) ? ((fund.appraisedValue - fund.purchasePrice) / fund.appraisedValue * 100) : null;
  const valSection = `
    <div class="panel detail-section">
      <div class="panel-title">🏷️ Purchase Price & Valuation</div>
      ${valDiscount != null ? `
        <div class="val-callout ${valDiscount > 0 ? 'discount' : 'premium'}" style="margin-bottom:14px">
          <div class="val-pct">${valDiscount > 0 ? '-' : '+'}${Math.abs(valDiscount).toFixed(1)}%</div>
          <div>${valDiscount > 0 ? 'Purchased below appraised value — built-in equity' : 'Purchased above appraised value — loaded pricing'}</div>
        </div>` : ''}
      <div class="metric-grid" style="grid-template-columns:repeat(3,1fr)">
        <div class="metric-tile"><div class="metric-label">Purchase Price</div><div class="metric-value" style="font-size:18px">${fmtMoney(fund.purchasePrice)}</div></div>
        <div class="metric-tile"><div class="metric-label">Appraised Value</div><div class="metric-value" style="font-size:18px">${fmtMoney(fund.appraisedValue)}</div></div>
        <div class="metric-tile"><div class="metric-label">Loaded Price</div><div class="metric-value" style="font-size:18px">${fmtMoney(fund.loadedPrice)}</div></div>
      </div>
      ${fund.pricePerUnit || fund.pricePerSqFt ? `
        <div style="display:flex;gap:16px;margin-top:12px">
          ${fund.pricePerUnit ? `<div style="font-size:12.5px;color:var(--slate)">Price/Unit: <strong>${fmtMoney(fund.pricePerUnit)}</strong></div>` : ''}
          ${fund.pricePerSqFt ? `<div style="font-size:12.5px;color:var(--slate)">Price/SF: <strong>${fmtMoney(fund.pricePerSqFt)}</strong></div>` : ''}
          ${fund.units ? `<div style="font-size:12.5px;color:var(--slate)">Units: <strong>${fund.units}</strong></div>` : ''}
        </div>` : ''}
    </div>`;

  // ── Debt & Lease Terms ──
  const debtSection = `
    <div class="panel detail-section">
      <div class="panel-title">🏦 Debt & Lease Terms</div>
      <div class="detail-two-col">
        <div>
          <div class="metric-grid" style="grid-template-columns:1fr 1fr;gap:10px">
            <div class="metric-tile"><div class="metric-label">LTV</div><div class="metric-value" style="font-size:18px">${fmtPct(fund.ltv)}</div>${peerDelta(fund.ltv, p.avgLTV)}</div>
            <div class="metric-tile"><div class="metric-label">DSCR (Base)</div><div class="metric-value" style="font-size:18px">${fund.dscr ? fmtNum(fund.dscr, 2) + 'x' : '—'}</div></div>
            <div class="metric-tile"><div class="metric-label">DSCR (Stress)</div><div class="metric-value" style="font-size:18px">${fund.dscrStress ? fmtNum(fund.dscrStress, 2) + 'x' : '—'}</div></div>
            <div class="metric-tile"><div class="metric-label">Hold Period</div><div class="metric-value" style="font-size:18px">${fund.holdPeriod ? fund.holdPeriod + ' yr' : '—'}</div></div>
          </div>
        </div>
        <div>
          <div class="metric-grid" style="grid-template-columns:1fr 1fr;gap:10px">
            <div class="metric-tile"><div class="metric-label">Avg Lease Term</div><div class="metric-value" style="font-size:18px">${fund.avgLeaseTerm ? fmtNum(fund.avgLeaseTerm, 1) + ' yr' : '—'}</div>${peerDelta(fund.avgLeaseTerm, p.avgLeaseTerm, ' yr')}</div>
            <div class="metric-tile"><div class="metric-label">Occupancy</div><div class="metric-value" style="font-size:18px">${fmtPct(fund.occupancy)}</div>${peerDelta(fund.occupancy, p.avgOccupancy)}</div>
            <div class="metric-tile" style="grid-column:1/-1"><div class="metric-label">Tenant Credit</div><div class="metric-value" style="font-size:14px">${fund.tenantCredit || '—'}</div></div>
          </div>
        </div>
      </div>
    </div>`;

  // ── Key Drivers ──
  const drivers = generateKeyDrivers(fund);
  const keyDriversSection = drivers.length ? `
    <div class="panel detail-section">
      <div class="panel-title">⚡ Key Drivers</div>
      <div class="kd-grid">${drivers.map(d => `<div class="kd-item ${d.cls}"><span class="kd-icon">${d.icon}</span><div>${d.text}</div></div>`).join('')}</div>
    </div>` : '';

  // ── Projected Annual Distributions (Chart.js) ──
  const hasIncome = fund.income.some(v => v != null);
  const chartSection = hasIncome ? `
    <div class="panel detail-section">
      <div class="panel-title">📈 Projected Annual Distributions</div>
      <div class="detail-chart-wrap"><canvas id="income-chart"></canvas></div>
    </div>` : '';

  // ── 8-Year Projections Table ──
  const projYears = fund.income.map((v, i) => v != null ? i : -1).filter(i => i >= 0);
  const maxProj = Math.min(projYears.length, 8);
  const projSection = maxProj > 1 ? `
    <div class="panel detail-section">
      <div class="panel-title">📊 Distribution Projections</div>
      <table class="proj-table">
        <thead><tr><th></th>${projYears.slice(0, maxProj).map((yi, idx) => `<th class="${idx === 0 ? 'highlight' : ''}">Year ${yi + 1}</th>`).join('')}</tr></thead>
        <tbody>
          <tr><td>CoC Return</td>${projYears.slice(0, maxProj).map((yi, idx) => `<td class="${idx === 0 ? 'highlight' : ''}">${fmtPct(fund.income[yi])}</td>`).join('')}</tr>
          ${STATE.client.exchangeAmount ? `<tr><td>Est. Distribution</td>${projYears.slice(0, maxProj).map((yi, idx) => `<td class="${idx === 0 ? 'highlight' : ''}">${fund.income[yi] != null ? fmtMoney(STATE.client.exchangeAmount * fund.income[yi] / 100) : '—'}</td>`).join('')}</tr>
          <tr><td>Cumulative</td>${projYears.slice(0, maxProj).map((yi, idx) => { let cum = 0; for (let j = 0; j <= idx; j++) { let yj = projYears[j]; if (fund.income[yj] != null) cum += STATE.client.exchangeAmount * fund.income[yj] / 100; } return `<td class="${idx === 0 ? 'highlight' : ''}">${fmtMoney(cum)}</td>`; }).join('')}</tr>` : ''}
        </tbody>
      </table>
    </div>` : '';

  // ── Key Takeaways ──
  const takeaways = generateTakeaways(fund);
  const takeawaySection = takeaways.length ? `
    <div class="panel detail-section">
      <div class="panel-title">🎯 Key Takeaways</div>
      <div style="display:grid;gap:8px">${takeaways.map(t => `<div style="display:flex;align-items:flex-start;gap:8px;font-size:13px;line-height:1.6;color:var(--navy)"><span style="flex-shrink:0;color:var(--blue)">▸</span><span>${t}</span></div>`).join('')}</div>
    </div>` : '';

  // ── AI Narrative Sections ──
  const narrativeOverview = generateNarrativeOverview(fund);
  const narrativeProperty = generateNarrativeProperty(fund);
  const narrativeFinancial = generateNarrativeFinancial(fund);

  const narrativeSections = `
    <div class="panel detail-section"><div class="panel-title">🤖 AI Overview</div><div style="font-size:13px;line-height:1.75;color:var(--navy)">${narrativeOverview}</div></div>
    <div class="detail-two-col detail-section">
      <div class="panel"><div class="panel-title">🏢 Property & Market</div><div style="font-size:13px;line-height:1.75;color:var(--navy)">${narrativeProperty}</div></div>
      <div class="panel"><div class="panel-title">💰 Financial Structure</div><div style="font-size:13px;line-height:1.75;color:var(--navy)">${narrativeFinancial}</div></div>
    </div>`;

  // ── Q&A (Phase 2 locked) ──
  const qaSection = `
    <div class="panel detail-section" style="opacity:0.5">
      <div class="panel-title">💬 Q&A — Coming Phase 2</div>
      <div style="text-align:center;padding:20px;font-size:13px;color:var(--slate2)">AI-powered Q&A will be available in the next release. Ask any question about this offering's structure, risks, or suitability.</div>
    </div>`;

  // ── Sponsor Track Record ──
  const sponsorSection = `
    <div class="panel detail-section">
      <div class="panel-title">🏛️ Sponsor Track Record — ${fund.sponsor}</div>
      <div style="font-size:13px;line-height:1.75;color:var(--navy)">${generateSponsorNarrative(fund)}</div>
    </div>`;

  return navStrip + hero + docRow + actionBar + raiseSection + valSection + debtSection + keyDriversSection + chartSection + projSection + takeawaySection + narrativeSections + qaSection + sponsorSection;
}

/* ═══════════════════════════════════════════
   KEY DRIVERS & TAKEAWAYS GENERATORS
═══════════════════════════════════════════ */
function generateKeyDrivers(fund) {
  const d = [];
  const p = STATE.peer;

  // Income signal
  if (fund.y1coc != null && p.avgY1CoC != null) {
    if (fund.y1coc >= p.avgY1CoC + 1) d.push({ cls: 'positive', icon: '📈', text: `Y1 CoC of ${fmtPct(fund.y1coc)} exceeds peer average (${fmtPct(p.avgY1CoC)}) — above-market yield` });
    else if (fund.y1coc >= p.avgY1CoC - 0.5) d.push({ cls: 'info', icon: '📊', text: `Y1 CoC of ${fmtPct(fund.y1coc)} is in-line with peer average (${fmtPct(p.avgY1CoC)})` });
    else d.push({ cls: 'caution', icon: '📉', text: `Y1 CoC of ${fmtPct(fund.y1coc)} trails peer average (${fmtPct(p.avgY1CoC)}) — below-market entry yield` });
  }

  // Leverage
  if (fund.ltv != null) {
    if (fund.ltv > 70) d.push({ cls: 'risk', icon: '⚠️', text: `LTV of ${fmtPct(fund.ltv)} indicates high leverage — reduced debt cushion in a downturn` });
    else if (fund.ltv > 60) d.push({ cls: 'caution', icon: '🔶', text: `Moderate leverage at ${fmtPct(fund.ltv)} LTV — within typical DST range` });
    else d.push({ cls: 'positive', icon: '🛡️', text: `Conservative leverage at ${fmtPct(fund.ltv)} LTV — strong downside protection` });
  }

  // DSCR
  if (fund.dscr != null) {
    if (fund.dscr < 1.15) d.push({ cls: 'risk', icon: '🚨', text: `DSCR of ${fmtNum(fund.dscr, 2)}x is thin — limited margin to cover debt service` });
    else if (fund.dscr < 1.30) d.push({ cls: 'caution', icon: '📐', text: `DSCR of ${fmtNum(fund.dscr, 2)}x provides adequate but not generous debt coverage` });
    else d.push({ cls: 'positive', icon: '✅', text: `Strong DSCR of ${fmtNum(fund.dscr, 2)}x — healthy margin above debt service requirements` });
  }

  // Occupancy
  if (fund.occupancy != null) {
    if (fund.occupancy >= 95) d.push({ cls: 'positive', icon: '🏢', text: `${fmtPct(fund.occupancy)} occupied — stabilized income stream with minimal vacancy risk` });
    else if (fund.occupancy >= 85) d.push({ cls: 'info', icon: '🔵', text: `${fmtPct(fund.occupancy)} occupancy — healthy but with some lease-up potential` });
    else d.push({ cls: 'caution', icon: '⚡', text: `${fmtPct(fund.occupancy)} occupancy — elevated vacancy risk, requires lease-up execution` });
  }

  // Valuation
  if (fund.appraisedValue && fund.purchasePrice) {
    const disc = ((fund.appraisedValue - fund.purchasePrice) / fund.appraisedValue * 100);
    if (disc > 2) d.push({ cls: 'positive', icon: '🏷️', text: `Purchased at ${disc.toFixed(1)}% below appraised value — built-in equity cushion` });
    else if (disc < -2) d.push({ cls: 'caution', icon: '💲', text: `Purchase price exceeds appraisal by ${Math.abs(disc).toFixed(1)}% — loaded pricing above market value` });
  }

  // Hold period vs client age
  if (fund.holdPeriod && STATE.client.age) {
    const endAge = STATE.client.age + fund.holdPeriod;
    if (endAge > 85) d.push({ cls: 'caution', icon: '⏳', text: `${fund.holdPeriod}-year hold extends to client age ${endAge} — consider liquidity needs` });
    else if (endAge > 75) d.push({ cls: 'info', icon: '📅', text: `${fund.holdPeriod}-year hold period ends at client age ${endAge}` });
    else d.push({ cls: 'positive', icon: '⏱️', text: `${fund.holdPeriod}-year hold is well within client's investment horizon (age ${endAge} at exit)` });
  }

  // Raise momentum
  const pctRaised = fund.pctRaised; const pctRemaining = fund.pctRemaining;
  if (pctRaised != null) {
    if (pctRaised >= 85) d.push({ cls: 'caution', icon: '🔥', text: `${pctRaised}% raised — limited equity remaining, act promptly if interested` });
    else if (pctRaised >= 50) d.push({ cls: 'info', icon: '📊', text: `${pctRaised}% raised — moderate market adoption, equity still available` });
  }

  return d;
}

function generateTakeaways(fund) {
  const t = [];
  const p = STATE.peer;

  if (fund.y1coc != null && p.avgY1CoC != null) {
    const diff = fund.y1coc - p.avgY1CoC;
    t.push(`Year 1 cash-on-cash of ${fmtPct(fund.y1coc)} is ${Math.abs(diff).toFixed(1)}% ${diff >= 0 ? 'above' : 'below'} the current peer average of ${fmtPct(p.avgY1CoC)} across ${p.count} active DST offerings.`);
  }

  if (fund.ltv != null && p.avgLTV != null) {
    t.push(`Leverage of ${fmtPct(fund.ltv)} LTV ${fund.ltv < p.avgLTV ? 'is below' : 'exceeds'} the peer average of ${fmtPct(p.avgLTV)}, ${fund.ltv <= 55 ? 'reflecting a conservative capital structure.' : fund.ltv <= 65 ? 'within the typical DST range.' : 'indicating an above-average debt load.'}`);
  }

  if (fund.occupancy != null) {
    t.push(`Occupancy of ${fmtPct(fund.occupancy)} ${fund.occupancy >= 95 ? 'suggests a fully stabilized asset with predictable cash flows.' : fund.occupancy >= 85 ? 'is healthy with minor upside from lease-up.' : 'presents elevated vacancy risk but potential upside as leasing improves.'}`);
  }

  if (fund.dscr != null) {
    t.push(`Debt service coverage ratio of ${fmtNum(fund.dscr, 2)}x ${fund.dscr >= 1.3 ? 'provides a strong buffer against income disruption.' : fund.dscr >= 1.15 ? 'offers adequate protection.' : 'is slim — income disruptions could stress debt service.'}`);
  }

  if (STATE.client.exchangeAmount && fund.minInvest) {
    const pctOfExchange = (fund.minInvest / STATE.client.exchangeAmount * 100).toFixed(0);
    t.push(`Minimum investment of ${fmtMoney(fund.minInvest)} represents ${pctOfExchange}% of the client's ${fmtMoney(STATE.client.exchangeAmount)} 1031 exchange — ${parseInt(pctOfExchange) <= 25 ? 'allowing significant diversification across multiple DSTs.' : parseInt(pctOfExchange) <= 50 ? 'allowing room for one or two additional positions.' : 'consuming a large share of available equity.'}`);
  }

  return t;
}

/* ═══════════════════════════════════════════
   AI NARRATIVE GENERATORS (Template-based)
═══════════════════════════════════════════ */
function generateNarrativeOverview(fund) {
  const statusText = fund.status === 'Open' ? 'currently open for investment' : fund.status === 'Closing' ? 'in its final closing phase' : 'coming soon to market';
  return `<strong>${fund.name}</strong> is a ${fund.propType || 'real estate'} Delaware Statutory Trust offering sponsored by <strong>${fund.sponsor}</strong>, ${statusText}. ${fund.location ? `The property is located in <strong>${fund.location}</strong>, ` : ''}${fund.totalRaise ? `with a total equity raise of <strong>${fmtMoney(fund.totalRaise)}</strong>` : ''}${fund.minInvest ? ` and a minimum investment of <strong>${fmtMoney(fund.minInvest)}</strong>` : ''}.
  ${fund.y1coc ? `<br><br>The offering targets a Year 1 cash-on-cash return of <strong>${fmtPct(fund.y1coc)}</strong>` : ''}${fund.holdPeriod ? ` over a projected <strong>${fund.holdPeriod}-year</strong> hold period` : ''}${fund.avgCoc ? `, with an average projected CoC of <strong>${fmtPct(fund.avgCoc)}</strong> across the hold` : ''}.
  ${fund.ltv ? ` The capital structure incorporates <strong>${fmtPct(fund.ltv)}</strong> loan-to-value leverage` : ''}${fund.dscr ? ` with a debt service coverage ratio of <strong>${fmtNum(fund.dscr, 2)}x</strong>` : ''}.`;
}

function generateNarrativeProperty(fund) {
  let text = '';
  if (fund.propType) text += `This is a <strong>${fund.propType}</strong> asset`;
  if (fund.location) text += ` situated in <strong>${fund.location}</strong>`;
  if (fund.units) text += `, comprising <strong>${fund.units} units</strong>`;
  if (fund.sqft) text += `${fund.units ? ' totaling' : ', encompassing'} approximately <strong>${fmtMoney(fund.sqft)} square feet</strong>`;
  text += '. ';
  if (fund.occupancy) text += `The property is currently <strong>${fmtPct(fund.occupancy)} occupied</strong>, ${fund.occupancy >= 95 ? 'reflecting a fully stabilized income stream.' : fund.occupancy >= 85 ? 'indicating healthy tenant demand with minor vacancy.' : 'suggesting lease-up potential that could drive income growth.'}`;
  if (fund.avgLeaseTerm) text += ` Average remaining lease term is <strong>${fmtNum(fund.avgLeaseTerm, 1)} years</strong>, ${fund.avgLeaseTerm >= 7 ? 'providing excellent cash flow visibility.' : fund.avgLeaseTerm >= 4 ? 'offering moderate income predictability.' : 'which introduces near-term rollover risk.'}`;
  if (fund.tenantCredit) text += ` Tenant credit profile: <strong>${fund.tenantCredit}</strong>.`;
  return text || 'Property and market details will be available when data is complete.';
}

function generateNarrativeFinancial(fund) {
  let text = '';
  if (fund.purchasePrice) text += `The property was acquired for <strong>${fmtMoney(fund.purchasePrice)}</strong>`;
  if (fund.appraisedValue) {
    const disc = ((fund.appraisedValue - fund.purchasePrice) / fund.appraisedValue * 100);
    text += ` against an appraised value of <strong>${fmtMoney(fund.appraisedValue)}</strong>, representing a <strong>${disc > 0 ? disc.toFixed(1) + '% discount' : Math.abs(disc).toFixed(1) + '% premium'}</strong> to appraised value`;
  }
  text += '. ';
  if (fund.ltv) text += `Leverage is set at <strong>${fmtPct(fund.ltv)} LTV</strong>`;
  if (fund.dscr) text += `, generating a base DSCR of <strong>${fmtNum(fund.dscr, 2)}x</strong>`;
  if (fund.dscrStress) text += ` (${fmtNum(fund.dscrStress, 2)}x under stress)`;
  text += '. ';
  const hasIncome = fund.income.some(v => v != null);
  if (hasIncome) {
    const yrs = fund.income.filter(v => v != null);
    const minY = Math.min(...yrs);
    const maxY = Math.max(...yrs);
    text += `Projected distributions range from <strong>${fmtPct(minY)}</strong> to <strong>${fmtPct(maxY)}</strong> across the hold period`;
    if (fund.income[0] && fund.income[yrs.length - 1]) {
      const trend = fund.income[yrs.length - 1] - fund.income[0];
      text += `, showing a <strong>${trend > 0 ? 'rising' : trend < 0 ? 'declining' : 'flat'} distribution trajectory</strong>`;
    }
    text += '.';
  }
  return text || 'Financial structure details will be available when data is complete.';
}

function generateSponsorNarrative(fund) {
  let text = `<strong>${fund.sponsor}</strong> is a DST program sponsor active on the Alts Fund Link platform.`;
  if (fund.sponsorAum) text += ` The firm manages approximately <strong>${fund.sponsorAum}</strong> in assets under management.`;
  if (fund.sponsorOfferings) text += ` They have launched <strong>${fund.sponsorOfferings}</strong> offerings`;
  if (fund.sponsorExits) text += ` with <strong>${fund.sponsorExits}</strong> full-cycle exits to date.`;
  else text += '.';
  if (fund.sponsorAvgIrr) text += ` Historical average IRR is <strong>${fmtPct(fund.sponsorAvgIrr)}</strong>`;
  if (fund.sponsorBestIrr) text += ` (best: ${fmtPct(fund.sponsorBestIrr)}`;
  if (fund.sponsorWorstIrr) text += `, worst: ${fmtPct(fund.sponsorWorstIrr)})`;
  else if (fund.sponsorBestIrr) text += ')';
  if (fund.sponsorAvgIrr) text += '.';
  if (fund.sponsorExperience) text += `<br><br><strong>Experience:</strong> ${fund.sponsorExperience}`;
  if (fund.trackRecordUrl) text += '<br><br>Detailed track record documentation is available via the document links above.';
  return text;
}

/* ═══════════════════════════════════════════
   INCOME CHART (Chart.js)
═══════════════════════════════════════════ */
function renderIncomeChart(fund) {
  const ctx = document.getElementById('income-chart');
  if (!ctx) return;

  // Destroy previous chart instance
  if (STATE.incomeChart) { STATE.incomeChart.destroy(); STATE.incomeChart = null; }

  const labels = [];
  const data = [];
  fund.income.forEach((v, i) => {
    if (v != null) { labels.push('Y' + (i + 1)); data.push(v); }
  });
  if (!data.length) return;

  const peerAvg = STATE.peer.avgY1CoC;

  STATE.incomeChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'CoC Return %',
          data: data,
          backgroundColor: data.map((v, i) => i === 0 ? '#1C3A63' : '#3B82F6'),
          borderRadius: 4,
          borderSkipped: false,
          barPercentage: 0.65
        },
        ...(peerAvg ? [{
          label: 'Peer Avg',
          data: data.map(() => peerAvg),
          type: 'line',
          borderColor: '#F59E0B',
          borderDash: [6, 3],
          borderWidth: 2,
          pointRadius: 0,
          fill: false,
          order: 0
        }] : [])
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { intersect: false, mode: 'index' },
      plugins: {
        legend: {
          display: !!peerAvg,
          position: 'top',
          align: 'end',
          labels: { boxWidth: 12, font: { family: "'DM Sans'", size: 11 }, color: '#5C7A99' }
        },
        tooltip: {
          backgroundColor: '#0B1F3B',
          titleFont: { family: "'DM Sans'", size: 12 },
          bodyFont: { family: "'DM Mono'", size: 12 },
          padding: 10,
          cornerRadius: 8,
          callbacks: {
            label: function(ctx) {
              if (ctx.dataset.label === 'Peer Avg') return 'Peer Avg: ' + ctx.raw.toFixed(2) + '%';
              let line = ctx.raw.toFixed(2) + '%';
              if (STATE.client.exchangeAmount) line += ' (' + fmtMoney(STATE.client.exchangeAmount * ctx.raw / 100) + '/yr)';
              return line;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: v => v + '%', font: { family: "'DM Mono'", size: 11 }, color: '#8FA3BA' },
          grid: { color: '#E8F0F8' },
          border: { display: false }
        },
        x: {
          ticks: { font: { family: "'DM Sans'", size: 11, weight: 600 }, color: '#3A5270' },
          grid: { display: false },
          border: { display: false }
        }
      }
    }
  });
}

/* ═══════════════════════════════════════════
   BASKET VIEW
═══════════════════════════════════════════ */
/* ═══════════════════════════════════════════
   BASKET VIEW — Tear Sheet Integration
   Ported from standalone Basket Builder
═══════════════════════════════════════════ */

// ── Basket utilities ──
const BV = {};
BV.escapeHTML = (s) => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
BV.isNum = (x) => typeof x === 'number' && isFinite(x);
BV.clamp = (n, a, b) => Math.max(a, Math.min(b, n));
BV.fmtDate = (d) => (d instanceof Date && !isNaN(d.getTime())) ? d.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'2-digit' }) : '—';
BV.fmtPct = (p, digits) => BV.isNum(p) ? p.toFixed(digits ?? 2) + '%' : '—';
BV.fmtMoney = (n) => { if (!BV.isNum(n)) return '—'; const a = Math.abs(n); if (a >= 1e9) return '$' + (n/1e9).toFixed(2) + 'B'; if (a >= 1e6) return '$' + (n/1e6).toFixed(3) + 'M'; if (a >= 1e3) return '$' + (n/1e3).toFixed(1) + 'K'; return '$' + n.toFixed(0); };
BV.fmtMoneyFull = (n) => { if (!BV.isNum(n)) return '—'; try { return new Intl.NumberFormat(undefined, { style:'currency', currency:'USD', maximumFractionDigits:0 }).format(n); } catch(e) { return '$' + Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ','); } };
BV.normalizeHeader = (s) => String(s ?? '').toLowerCase().replace(/\s+/g, ' ').replace(/[^a-z0-9%#()$\/\- ]+/g, '').trim();
BV.uniqSorted = (arr) => Array.from(new Set(arr.map(x => String(x||'').trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
BV.parseNumberLoose = (v) => { if (v == null) return null; if (typeof v === 'number') return isFinite(v) ? v : null; const s = String(v).trim(); if (!s || /^na$/i.test(s)) return null; const m = s.replace(/,/g,'').match(/-?\d+(\.\d+)?/); return m ? parseFloat(m[0]) : null; };
BV.parsePercent = (v) => { if (v == null) return null; if (typeof v === 'number') { if (!isFinite(v)) return null; if (Math.abs(v) <= 1) return v * 100; return v; } const s0 = String(v).trim(); if (!s0 || /^na$/i.test(s0)) return null; const s = s0.replace(/,/g, ''); if (/%/.test(s)) { const m = s.match(/-?\d+(\.\d+)?/); if (!m) return null; const num = parseFloat(m[0]); if (!isFinite(num)) return null; return num; } const m = s.match(/-?\d+(\.\d+)?/); if (!m) return null; const num = parseFloat(m[0]); if (!isFinite(num)) return null; if (Math.abs(num) <= 1) return num * 100; return num; };
BV.parseMoney = (v) => { if (v == null) return null; if (typeof v === 'number') return isFinite(v) ? v : null; const s0 = String(v).trim(); if (!s0 || /^na$/i.test(s0)) return null; const s = s0.replace(/,/g, ''); const m = s.match(/-?\$?\s*(\d+(\.\d+)?)(\s*[kKmMbB])?/); if (!m) return null; let num = parseFloat(m[1]); const suf = (m[3]||'').trim().toUpperCase(); if (suf === 'K') num *= 1e3; if (suf === 'M') num *= 1e6; if (suf === 'B') num *= 1e9; return isFinite(num) ? num : null; };
BV.parseDate = (v) => { if (v == null) return null; if (v instanceof Date) return isNaN(v.getTime()) ? null : v; if (typeof v === 'number' && isFinite(v)) { if (v > 1e11) { const d = new Date(v); return isNaN(d.getTime()) ? null : d; } const base = new Date(Date.UTC(1899,11,30)); const d = new Date(base.getTime() + v * 86400000); return isNaN(d.getTime()) ? null : d; } const s = String(v).trim(); if (!s || /^na$/i.test(s)) return null; const m = s.match(/(?:Date|Datetime)\(\s*([^)]+)\s*\)/i); if (m) { const parts = m[1].split(',').map(x=>parseInt(x.trim(),10)).filter(x=>!isNaN(x)); if (parts.length >= 3) { const d = new Date(parts[0], parts[1], parts[2]); return isNaN(d.getTime()) ? null : d; } } const d = new Date(s); return isNaN(d.getTime()) ? null : d; };
BV.parseHoldPeriodYears = (v) => { if (v == null) return null; const s = String(v).trim().toLowerCase(); if (!s || s === 'na') return null; const range = s.match(/(\d+(\.\d+)?)\s*(to|\-)\s*(\d+(\.\d+)?)/); if (range) return (parseFloat(range[1]) + parseFloat(range[4])) / 2; const single = s.match(/(\d+(\.\d+)?)/); return single ? parseFloat(single[1]) : null; };
BV.normalizeDocUrl = (u) => { u = String(u || '').trim(); if (!u || /^na$/i.test(u)) return ''; const openId = u.match(/drive\.google\.com\/open\?id=([^&]+)/i); if (openId) return 'https://drive.google.com/file/d/' + openId[1] + '/view'; const fileId = u.match(/drive\.google\.com\/file\/d\/([^\/]+)/i); if (fileId) return 'https://drive.google.com/file/d/' + fileId[1] + '/view'; if (/^www\./i.test(u)) return 'https://' + u; if (!/^https?:\/\//i.test(u) && /\./.test(u)) return 'https://' + u; return u; };

// ── State extraction helpers ──
BV.STATE_ABBR = new Set(["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY","DC"]);
BV.STATE_NAME_TO_ABBR = {"ALABAMA":"AL","ALASKA":"AK","ARIZONA":"AZ","ARKANSAS":"AR","CALIFORNIA":"CA","COLORADO":"CO","CONNECTICUT":"CT","DELAWARE":"DE","FLORIDA":"FL","GEORGIA":"GA","HAWAII":"HI","IDAHO":"ID","ILLINOIS":"IL","INDIANA":"IN","IOWA":"IA","KANSAS":"KS","KENTUCKY":"KY","LOUISIANA":"LA","MASSACHUSETTS":"MA","MARYLAND":"MD","MAINE":"ME","MICHIGAN":"MI","MINNESOTA":"MN","MISSISSIPPI":"MS","MISSOURI":"MO","MONTANA":"MT","NEBRASKA":"NE","NEVADA":"NV","NEW HAMPSHIRE":"NH","NEW JERSEY":"NJ","NEW MEXICO":"NM","NEW YORK":"NY","NORTH CAROLINA":"NC","NORTH DAKOTA":"ND","OHIO":"OH","OKLAHOMA":"OK","OREGON":"OR","PENNSYLVANIA":"PA","RHODE ISLAND":"RI","SOUTH CAROLINA":"SC","SOUTH DAKOTA":"SD","TENNESSEE":"TN","TEXAS":"TX","UTAH":"UT","VERMONT":"VT","VIRGINIA":"VA","WASHINGTON":"WA","WEST VIRGINIA":"WV","WISCONSIN":"WI","WYOMING":"WY","DISTRICT OF COLUMBIA":"DC"};
BV.extractStates = (locationText) => { const s = String(locationText ?? '').toUpperCase(); if (!s || s === 'NA') return []; const found = new Set(); const abbrMatches = s.match(/\b[A-Z]{2}\b/g) || []; for (const ab of abbrMatches) { if (BV.STATE_ABBR.has(ab)) found.add(ab); } for (const [name, ab] of Object.entries(BV.STATE_NAME_TO_ABBR)) { if (s.includes(name)) found.add(ab); } return Array.from(found).filter(x => x !== 'AK' && x !== 'HI').sort(); };
BV.summarizeStates = (states, max) => { max = max || 6; const arr = BV.uniqSorted(states); if (!arr.length) return '—'; if (arr.length <= max) return arr.join(', '); return arr.slice(0, max).join(', ') + '…'; };
BV.pctDelta = (a, b) => { if (!BV.isNum(a) || !BV.isNum(b) || b === 0) return null; return (a - b) / b * 100; };
BV.moneyDelta = (a, b) => { if (!BV.isNum(a) || !BV.isNum(b)) return null; return a - b; };

BV.iconSvg = (type) => { const common = 'width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"'; const wrap = (inner) => '<span class="ico"><svg ' + common + '>' + inner + '</svg></span>'; const icons = { brochure: wrap('<path d="M14 2H7a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7z"/><path d="M14 2v5h5"/><path d="M9 13h6"/><path d="M9 17h6"/>'), ppm: wrap('<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/><path d="M8 6h8"/><path d="M8 10h8"/>'), video: wrap('<path d="M15 10l4.5-2.5v9L15 14"/><rect x="3" y="7" width="12" height="10" rx="2" ry="2"/>'), ai_offering_chat: wrap('<path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/><path d="M8 9h8"/><path d="M8 13h6"/>'), track_record: wrap('<path d="M3 3v18h18"/><path d="M7 14l3-3 3 2 5-6"/>'), sponsor_news: wrap('<rect x="3" y="4" width="18" height="16" rx="2"/><path d="M7 8h10"/><path d="M7 12h6"/><path d="M7 16h8"/>'), sales_team_map: wrap('<path d="M21 10c0 6-9 12-9 12S3 16 3 10a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>'), quarterly_update: wrap('<rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/><path d="M8 14h8"/><path d="M8 18h5"/>') }; return icons[type] || wrap('<circle cx="12" cy="12" r="9"/>'); };

// ── Percentile rank ──
BV.lowerBound = (arr, x) => { let lo = 0, hi = arr.length; while (lo < hi) { const mid = (lo + hi) >> 1; if (arr[mid] < x) lo = mid + 1; else hi = mid; } return lo; };
BV.upperBound = (arr, x) => { let lo = 0, hi = arr.length; while (lo < hi) { const mid = (lo + hi) >> 1; if (arr[mid] <= x) lo = mid + 1; else hi = mid; } return lo; };
BV.percentileRank = (sorted, x) => { if (!sorted || !sorted.length || !BV.isNum(x)) return null; const n = sorted.length; const lo = BV.lowerBound(sorted, x); const hi = BV.upperBound(sorted, x); return BV.clamp((lo + 0.5 * (hi - lo)) / n * 100, 0, 100); };
BV.ordinal = (n) => { n = Math.round(n); const v = n % 100; const s = ['th','st','nd','rd']; return n + (s[(v-20)%10] || s[v] || s[0]); };
BV.pctileText = (p) => p == null ? '' : BV.ordinal(p) + ' pctile';

// ── Adapter: convert platform fund → basket fund format ──
BV.adaptFund = (f) => {
  if (!f) return null;
  const parseCellValue = (cell) => { if (!cell) return ''; if (cell.p && typeof cell.p === 'object') { for (const k of ['link','url','href','hyperlink']) { if (typeof cell.p[k] === 'string' && cell.p[k].trim()) return cell.p[k].trim(); } } const v = cell.v; const fmt = cell.f; if (typeof v === 'number' && isFinite(v)) return v; if (v instanceof Date && !isNaN(v.getTime())) return v; if (typeof v === 'string' && v.trim()) return v.trim(); if (typeof fmt === 'string' && fmt.trim() !== '') return fmt.trim(); if (v == null) return ''; return v; };

  // Build raw row array from _raw cells
  const rawRow = f._raw ? f._raw.map(parseCellValue) : [];

  const m = {};
  m.year1_coc = f.y1coc;
  m.ltv = f.ltv;
  m.dscr = f.dscr;
  m.cap_rate = f.acqCapRate;
  m.hold_period_years = f.holdPeriod;
  m.minimum_investment = f.minInvest;
  m.pct_leased = f.occupancy;
  m.num_assets = f.units;
  m.total_sqft = f.sqft;
  m.price_per_sqft = f.pricePerSqFt;
  m.rent_escalations = BV.parseNumberLoose(f.rentEscalations);
  m.avg_lease_term_remaining = f.avgLeaseTerm;
  m.purchase_price_unloaded = f.purchasePrice;
  m.appraised_valuation = f.appraisedValue;
  m.loaded_price = f.loadedPrice;
  m.filed_raise = f.filedRaise;
  m.current_raise = f.currentRaise;
  m.remaining_raise = f.equityRemaining;
  m.pct_raise_remaining = f.pctRemaining;
  m.raise_velocity = f.raiseVelocity;
  m.months_on_market = f.monthsOnMarket;
  m.offering_open = f.openDate;
  m.offering_close = f.closeDate;
  m.states = BV.extractStates(f.location);
  for (let i = 1; i <= 10; i++) m['income_y' + i] = f.income[i - 1];

  return {
    id: f.id,
    sponsor: f.sponsor,
    offering_name: f.name,
    displayLabel: f.sponsor + ' — ' + f.name,
    asset_class: f.propType,
    sector_focus: f.sector || f.focus || '',
    focus: f.focus || '',
    offering_structure: f.propType,
    distribution_frequency: f.distFrequency,
    debt_terms: f.debtTerms,
    lease_terms: f.leaseTerms,
    tenant_credit: f.tenantCredit || '',
    sponsor_experience: f.sponsorExperience || '',
    sponsor_logo_url: f.sponsorLogoUrl || '',
    quarterly_update_url: f.quarterlyUpdateUrl || '',
    preferred: f.preferred,
    promote: f.promote,
    upreit_721: f.upReit,
    gp_commit: f.gpCommit,
    property_locations: f.location,
    year_built_avg: f.buildingAge,
    status: f.status,
    months_on_market: f.monthsOnMarket,
    metrics: m,
    docs: {
      brochure: BV.normalizeDocUrl(f.brochureUrl),
      ppm: BV.normalizeDocUrl(f.ppmUrl),
      video: BV.normalizeDocUrl(f.videoUrl),
      ai_offering_chat: BV.normalizeDocUrl(f.aiChatUrl),
      track_record: BV.normalizeDocUrl(f.trackRecordUrl),
      sponsor_news: BV.normalizeDocUrl(f.sponsorNewsUrl),
      sales_team_map: BV.normalizeDocUrl(f.salesTeamUrl),
      quarterly_update: BV.normalizeDocUrl(f.quarterlyUpdateUrl)
    },
    __rawRow: rawRow
  };
};

// ── Peer stats for basket ──
BV.PEER_KEYS = ['year1_coc','ltv','dscr','hold_period_years','minimum_investment','pct_leased','rent_escalations','avg_lease_term_remaining','num_assets','purchase_price_unloaded','appraised_valuation','loaded_price','cap_rate','price_per_sqft'];
BV.SNAPSHOT_KEYS = ['year1_coc','ltv','dscr','hold_period_years','minimum_investment','pct_leased','rent_escalations','avg_lease_term_remaining','num_assets'];
BV.INCOME_KEYS = Array.from({length:10}, (_,i) => 'income_y' + (i+1));
BV.DISCLOSURES = 'For informational purposes only. This material does not constitute investment advice, an offer to sell, or a solicitation of an offer to buy any security or interest. Figures are shown as provided in the underlying data source and may be incomplete, unaudited, or subject to change. Verify all information with official offering documents and your firm\'s compliance requirements. Peer averages shown are simple averages of the currently listed offerings in the data set (excluding blanks/NA). For Broker Dealer and Investment Advisor home office due diligence use only. Always validate data with official offering documents and compliance requirements. Alts Fund LINK, LLC is not responsible for data errors or omissions.';

BV.computePeerStats = (allFunds) => {
  const stats = {}; const dist = {};
  for (const key of BV.PEER_KEYS) {
    const vals = allFunds.map(f => f.metrics?.[key]).filter(BV.isNum);
    if (!vals.length) continue;
    stats[key] = { avg: vals.reduce((a,b)=>a+b,0)/vals.length, min: Math.min(...vals), max: Math.max(...vals), n: vals.length };
    dist[key] = vals.slice().sort((a,b)=>a-b);
  }
  return { stats, dist };
};

BV.metricLabel = (key) => {
  const labels = { year1_coc:'Year 1 Cash-on-Cash', ltv:'Loan-to-Value (LTV)', dscr:'DSCR', hold_period_years:'Hold Period', minimum_investment:'Minimum Investment (Sum)', pct_leased:'Occupancy (% Leased)', rent_escalations:'Rent Escalations', avg_lease_term_remaining:'Avg Lease Term Remaining', num_assets:'# Assets', purchase_price_unloaded:'Purchase Price (Unloaded)', appraised_valuation:'Appraised Valuation', loaded_price:'Loaded Price', cap_rate:'Acquisition Cap Rate', price_per_sqft:'Price Per SF' };
  if (/^income_y\d+$/.test(key)) return 'Client Income (%) — Year ' + key.match(/\d+/)[0];
  return labels[key] || key;
};

BV.metricFormatter = (key, val) => {
  if (!BV.isNum(val)) return '—';
  if (key === 'dscr') return val.toFixed(2) + 'x';
  if (key === 'minimum_investment') return BV.fmtMoney(val);
  if (key === 'hold_period_years' || key === 'avg_lease_term_remaining') return val.toFixed(1) + ' yrs';
  if (key === 'num_assets') return Math.round(val) + '';
  if (key === 'purchase_price_unloaded' || key === 'appraised_valuation' || key === 'loaded_price') return BV.fmtMoney(val);
  if (key === 'price_per_sqft') return '$' + Math.round(val).toLocaleString() + '/SF';
  return BV.fmtPct(val, 2);
};

BV.coverageForKey = (funds, key) => { const total = funds.length; const present = funds.map(f => f.metrics?.[key]).filter(BV.isNum).length; return { total, present, missing: Math.max(0, total - present) }; };
BV.covText = (cov) => (!cov || !cov.total) ? '' : cov.present + '/' + cov.total;
BV.covBadgeHtml = (cov) => { if (!cov || !cov.total) return ''; const warn = cov.missing > 0 ? ' warn' : ''; const title = cov.missing > 0 ? 'Missing ' + cov.missing + ' of ' + cov.total + ' data points' : 'All ' + cov.total + ' selected have data'; return '<span class="mCov' + warn + '" title="' + BV.escapeHTML(title) + '">Data ' + BV.escapeHTML(BV.covText(cov)) + '</span>'; };

BV.peerVsLine = (key, val, peer, cov) => {
  const p = peer.stats[key];
  const covPart = (cov && cov.total) ? ' • <span class="pctl">Data ' + BV.escapeHTML(BV.covText(cov)) + '</span>' : '';
  if (!p || !BV.isNum(val) || !BV.isNum(p.avg)) return 'Peer avg: —' + covPart;
  const d = val - p.avg;
  const cls = d >= 0 ? 'pos' : 'neg';
  let deltaStr = '';
  if (key === 'minimum_investment' || key === 'purchase_price_unloaded' || key === 'appraised_valuation' || key === 'loaded_price') deltaStr = (d>=0?'+':'−') + BV.fmtMoney(Math.abs(d));
  else if (key === 'hold_period_years' || key === 'avg_lease_term_remaining') deltaStr = (d>=0?'+':'−') + Math.abs(d).toFixed(2) + ' yrs';
  else if (key === 'num_assets') deltaStr = (d>=0?'+':'−') + Math.abs(d).toFixed(0);
  else deltaStr = (d>=0?'+':'−') + Math.abs(d).toFixed(2) + ' pts';
  const pctl = BV.percentileRank(peer.dist[key], val);
  const pctlHtml = pctl == null ? '' : ' • <span class="pctl">' + BV.escapeHTML(BV.pctileText(pctl)) + '</span>';
  return 'Peer avg: ' + BV.escapeHTML(BV.metricFormatter(key, p.avg)) + ' • <span class="delta ' + cls + '">' + BV.escapeHTML(deltaStr) + '</span>' + pctlHtml + covPart;
};

// ── Aggregation ──
BV.aggregate = (selectedFunds) => {
  const n = selectedFunds.length;
  const agg = { __isAggregate: n > 1, selectedCount: n, displayLabel: n === 1 ? selectedFunds[0].displayLabel : 'Selected Offerings (' + n + ')', sponsor: n === 1 ? selectedFunds[0].sponsor : '', offering_name: n === 1 ? selectedFunds[0].offering_name : '', asset_class: n === 1 ? selectedFunds[0].asset_class : '', sector_focus: n === 1 ? selectedFunds[0].sector_focus : '', offering_structure: n === 1 ? selectedFunds[0].offering_structure : '', distribution_frequency: n === 1 ? selectedFunds[0].distribution_frequency : '', debt_lease_list: selectedFunds.map(f => ({ label: f.displayLabel, debt_terms: f.debt_terms, lease_terms: f.lease_terms })), docs_list: selectedFunds.map(f => ({ label: f.displayLabel, docs: f.docs })), property_states: BV.uniqSorted(selectedFunds.flatMap(f => (f.metrics?.states || []))), property_locations_summary: BV.summarizeStates(selectedFunds.flatMap(f => (f.metrics?.states || []))), metrics: {}, coverage: {} };

  const allKeys = [...new Set([...BV.PEER_KEYS, ...BV.SNAPSHOT_KEYS, 'filed_raise', 'current_raise', 'remaining_raise', 'cap_rate', ...BV.INCOME_KEYS])];
  for (const key of allKeys) {
    const cov = BV.coverageForKey(selectedFunds, key);
    agg.coverage[key] = cov;
    const vals = selectedFunds.map(f => f.metrics?.[key]).filter(BV.isNum);
    agg.metrics[key] = key === 'minimum_investment' ? (vals.length ? vals.reduce((a,b)=>a+b,0) : null) : (vals.length ? vals.reduce((a,b)=>a+b,0) / vals.length : null);
  }
  if (n === 1) { agg.metrics.offering_open = selectedFunds[0].metrics.offering_open; agg.metrics.offering_close = selectedFunds[0].metrics.offering_close; agg.metrics.filed_raise = selectedFunds[0].metrics.filed_raise; agg.metrics.current_raise = selectedFunds[0].metrics.current_raise; agg.metrics.remaining_raise = selectedFunds[0].metrics.remaining_raise; } else { agg.metrics.offering_open = null; agg.metrics.offering_close = null; }
  return agg;
};

// ── Insights ──
BV.buildInsights = (agg, selectedFunds, peer) => {
  const takeaways = [], considerations = [];
  const m = agg.metrics; const n = selectedFunds.length;
  const cov = (key) => agg.coverage?.[key] || { total:n, present:0, missing:n };
  const covMark = (key) => { const c = cov(key); return c.missing > 0 ? ' (Data ' + c.present + '/' + c.total + ')' : ''; };

  if (BV.isNum(m.ltv)) { const p = peer.stats.ltv; if (p && BV.isNum(p.avg)) { const delta = m.ltv - p.avg; takeaways.push('Loan-to-value (LTV) is ' + (delta <= 0 ? 'below' : 'above') + ' the current peer average (' + BV.fmtPct(m.ltv,2) + ' vs ' + BV.fmtPct(p.avg,2) + ').' + covMark('ltv')); } }

  const addVsPeer = (key, dir, friendly) => {
    const p = peer.stats[key]; const v = m[key]; const c = cov(key);
    if (!p || !BV.isNum(v) || !BV.isNum(p.avg)) { if (c.missing > 0) considerations.push(friendly + ' has missing data (Data ' + c.present + '/' + c.total + ').'); return; }
    const delta = v - p.avg;
    const th = { year1_coc:0.50, ltv:5.0, hold_period_years:1.0, minimum_investment:25000, pct_leased:5.0, rent_escalations:0.25, avg_lease_term_remaining:0.5, num_assets:1 }[key] ?? 0;
    if (Math.abs(delta) < th) return;
    const up = delta > 0; const suffix = c.missing > 0 ? ' (Data ' + c.present + '/' + c.total + ')' : '';
    if (dir === 'higher_is_better' && up) takeaways.push(friendly + ' is above the current peer average (' + BV.metricFormatter(key, v) + ' vs ' + BV.metricFormatter(key, p.avg) + ').' + suffix);
    else if (dir === 'higher_is_better' && !up) considerations.push(friendly + ' is below the current peer average (' + BV.metricFormatter(key, v) + ' vs ' + BV.metricFormatter(key, p.avg) + ').' + suffix);
    else if (dir === 'lower_is_better' && !up) takeaways.push(friendly + ' is below the current peer average (' + BV.metricFormatter(key, v) + ' vs ' + BV.metricFormatter(key, p.avg) + ').' + suffix);
    else if (dir === 'lower_is_better' && up) considerations.push(friendly + ' is above the current peer average (' + BV.metricFormatter(key, v) + ' vs ' + BV.metricFormatter(key, p.avg) + ').' + suffix);
  };
  addVsPeer('year1_coc','higher_is_better','Year 1 cash-on-cash');
  addVsPeer('minimum_investment','lower_is_better','Minimum investment (sum)');
  addVsPeer('pct_leased','higher_is_better','Occupancy (% leased)');
  addVsPeer('rent_escalations','higher_is_better','Rent escalations');
  addVsPeer('avg_lease_term_remaining','higher_is_better','Avg lease term remaining');
  if (!agg.__isAggregate) { const close = selectedFunds[0].metrics.offering_close; if (close instanceof Date && !isNaN(close.getTime())) { const days = (close.getTime() - Date.now()) / (1000*60*60*24); if (days <= 45 && days >= -365) considerations.push('Offering close date is near (' + BV.fmtDate(close) + '). Confirm allocation availability.'); } }
  const st = agg.property_states || [];
  if (st.length) takeaways.push('Property footprint includes ' + st.length + ' state' + (st.length===1?'':'s') + ' (' + st.join(', ') + ').');
  return { takeaways: takeaways.slice(0,6), considerations: considerations.slice(0,6) };
};

// ── Render: Status Module ──
BV.renderStatusModule = (singleFund) => {
  const m = singleFund.metrics;
  const filed = m.filed_raise; const current = m.current_raise; const remaining = m.remaining_raise;
  const filledRatio = (BV.isNum(filed) && filed > 0 && BV.isNum(current)) ? BV.clamp(current/filed, 0, 1) : null;
  const filledPct = BV.isNum(filledRatio) ? (filledRatio*100).toFixed(1) + '%' : '—';
  const filledLine = filledPct === '—' ? '—' : filledPct + ' raised';
  const openD = m.offering_open; const closeD = m.offering_close; const now = new Date();
  let timeRemRatio = null;
  if (openD instanceof Date && closeD instanceof Date && !isNaN(openD.getTime()) && !isNaN(closeD.getTime()) && closeD > openD) { timeRemRatio = BV.clamp((closeD - now) / (closeD - openD), 0, 1); }
  const timePct = BV.isNum(timeRemRatio) ? (timeRemRatio*100).toFixed(1) + '%' : '—';
  const timeLine = timePct === '—' ? '—' : timePct + ' left';
  let daysLeftText = '—';
  if (openD instanceof Date && closeD instanceof Date && closeD > openD) { const days = Math.max(0, Math.ceil((closeD - now) / 86400000)); daysLeftText = days + ' day' + (days===1?'':'s'); }
  const raiseH = BV.isNum(filledRatio) ? Math.round(filledRatio*100) : 0;
  const winH = BV.isNum(timeRemRatio) ? Math.round(timeRemRatio*100) : 0;
  const e = BV.escapeHTML;
  return '<div class="hdrStatusWrap"><div class="vStat" title="Raise Progress"><div class="vTrack"><div class="vFill" style="height:'+raiseH+'%"></div></div><div class="vInfo"><div class="vHdr"><div class="k">Raise</div></div><div class="vList"><div class="vLine"><b>'+e(filledLine)+'</b></div><div class="vLine"><b>Filed:</b> '+e(BV.fmtMoney(filed))+'</div><div class="vLine"><b>Curr:</b> '+e(BV.fmtMoney(current))+'</div><div class="vLine"><b>Rem:</b> '+e(BV.fmtMoney(remaining))+'</div></div></div></div><div class="vStat" title="Raise Window"><div class="vTrack"><div class="vFill" style="height:'+winH+'%"></div></div><div class="vInfo"><div class="vHdr"><div class="k">Raise Window</div></div><div class="vList"><div class="vLine"><b>'+e(timeLine)+'</b></div><div class="vLine"><b>Open:</b> '+e(BV.fmtDate(openD))+'</div><div class="vLine"><b>Close:</b> '+e(BV.fmtDate(closeD))+'</div><div class="vLine"><b>Days left:</b> '+e(daysLeftText)+'</div></div></div></div></div>';
};

// ── Render: Purchase Valuation ──
BV.renderPurchaseValuation = (agg) => {
  const m = agg.metrics; const e = BV.escapeHTML;
  const unloaded = m.purchase_price_unloaded; const loaded = m.loaded_price; const appraised = m.appraised_valuation;
  const primaryPct = BV.pctDelta(unloaded, appraised); const primary$ = BV.moneyDelta(unloaded, appraised);
  const loadComp$ = BV.moneyDelta(loaded, unloaded); const loadCompPct = (BV.isNum(loadComp$) && BV.isNum(unloaded) && unloaded !== 0) ? (loadComp$ / unloaded * 100) : null;
  const isDiscount = BV.isNum(primaryPct) ? (primaryPct <= 0) : null;
  const heroClass = isDiscount == null ? '' : (isDiscount ? ' good' : ' bad');
  const heroWord = isDiscount == null ? '—' : (isDiscount ? 'Discount to Appraisal' : 'Premium to Appraisal');
  const heroPctStr = BV.isNum(primaryPct) ? (primaryPct<=0?'−':'+')+Math.abs(primaryPct).toFixed(1)+'%' : '—';
  const hero$Str = BV.isNum(primary$) ? (primary$<=0?'−':'+')+BV.fmtMoney(Math.abs(primary$)) : '—';
  const secPctStr = BV.isNum(loadCompPct) ? (loadCompPct>=0?'+':'−')+Math.abs(loadCompPct).toFixed(1)+'%' : '—';
  const sec$Str = BV.isNum(loadComp$) ? (loadComp$>=0?'+':'−')+BV.fmtMoney(Math.abs(loadComp$)) : '—';
  const explain = isDiscount == null ? 'Provide Purchase Price and Appraised Valuation to compute premium/discount.' : (isDiscount ? 'Purchase price is below the reported appraisal (favorable entry point).' : 'Purchase price is above the reported appraisal (confirm underwriting assumptions).');
  return '<div class="sec"><div class="secHdr"><div class="h">Purchase Price & Valuation</div><div class="hint">Advisor headline: purchase discount/premium vs appraisal</div></div><div class="secBody"><div class="valHero"><div class="calloutRow"><div class="heroCall'+heroClass+'"><div class="heroTop"><div class="heroK">Purchase Price (Unloaded) vs Appraised Valuation</div><span class="r-pill">Primary client message</span></div><div class="heroMain">'+e(heroWord)+'</div><div class="heroSub"><b>'+e(heroPctStr)+'</b> ('+e(hero$Str)+') vs appraisal</div><div class="heroMeta"><span class="kv"><b>Appraised:</b> '+e(BV.fmtMoney(appraised))+'</span><span class="kv"><b>Purchase:</b> '+e(BV.fmtMoney(unloaded))+'</span></div><div class="textBlock" style="font-size:11px;color:rgba(9,14,25,0.62)">'+e(explain)+'</div></div><div class="miniCall"><div class="k">Client Load</div><div class="v">'+e(sec$Str)+' <span style="font-size:12px;color:rgba(9,14,25,0.62);font-weight:850">('+e(secPctStr)+')</span></div><div class="s"><b>Loaded Price:</b> '+e(BV.fmtMoney(loaded))+'<br>Loaded minus Unloaded purchase price.</div></div></div><div class="textBlock" style="font-size:11px;color:rgba(9,14,25,0.58)">Tip: Advisors can say: "We\'re buying at a <b>'+e(heroPctStr)+'</b> ('+e(hero$Str)+') discount/premium to the reported appraisal."</div></div></div></div>';
};

// ── Render: Doc buttons ──
BV.DOC_TYPES = ['brochure','ppm','video','ai_offering_chat','track_record','sponsor_news','sales_team_map','quarterly_update'];
BV.docAvailability = (funds) => { const avail = {}; for (const t of BV.DOC_TYPES) avail[t] = funds.some(f => f.docs && f.docs[t]); return avail; };

BV.renderDocButtons = (selectedFunds) => {
  const avail = BV.docAvailability(selectedFunds);
  const mkBtn = (en, type, label) => en ? '<button class="bv-btn doc" data-bv-docbtn="'+BV.escapeHTML(type)+'">'+BV.iconSvg(type)+BV.escapeHTML(label)+'</button>' : '<button class="bv-btn" disabled>'+BV.escapeHTML(label)+' (NA)</button>';
  return '<div style="display:grid;gap:8px;justify-items:start;align-items:start"><div style="display:grid;gap:6px;justify-items:start"><div style="font-size:10px;font-weight:950;text-transform:uppercase;letter-spacing:.25px;color:rgba(255,255,255,0.92)">Offering Diligence</div><div style="display:flex;gap:10px;flex-wrap:wrap">'+mkBtn(avail.brochure,'brochure','Brochure')+mkBtn(avail.ppm,'ppm','PPM')+mkBtn(avail.video,'video','Video')+mkBtn(avail.ai_offering_chat,'ai_offering_chat','AI Chat')+'</div></div><div style="display:grid;gap:6px;justify-items:start"><div style="font-size:10px;font-weight:950;text-transform:uppercase;letter-spacing:.25px;color:rgba(255,255,255,0.92)">Sponsor Diligence</div><div style="display:flex;gap:10px;flex-wrap:wrap">'+mkBtn(avail.track_record,'track_record','Track Record')+mkBtn(avail.sponsor_news,'sponsor_news','Sponsor News')+mkBtn(avail.sales_team_map,'sales_team_map','Sales Team Map')+'</div></div><div id="bv-doc-modal"></div></div>';
};

BV.renderDocModal = (selectedFunds, type) => {
  const titleMap = { brochure:'Brochure', ppm:'PPM', video:'Video', ai_offering_chat:'AI Offering Chat', track_record:'Track Record', sponsor_news:'Sponsor News', sales_team_map:'Sales Team Map' };
  const tLabel = titleMap[type] || 'Document'; const e = BV.escapeHTML;
  const rows = selectedFunds.map(f => { const url = f.docs?.[type] || ''; return '<div class="docRow"><div class="name" title="'+e(f.displayLabel)+'">'+e(f.displayLabel)+'</div><div class="right">'+(url ? '<a class="bv-btn doc" href="'+e(url)+'" target="_blank" rel="noopener noreferrer">'+BV.iconSvg(type)+'Open</a>' : '<span class="na">NA</span>')+'</div></div>'; }).join('');
  return '<div class="docPopover"><div class="modal"><div class="modalHdr"><div class="t">'+e(tLabel)+' Picker</div><button class="bv-btn" onclick="document.getElementById(\'bv-doc-modal\').innerHTML=\'\'">Close</button></div><div class="modalBody">'+rows+'</div></div></div>';
};

// ── Vertical Comparison Table ──
BV.isExcludedHeader = (hNorm) => { if (!hNorm) return true; if (/^year\s*(10|[1-9])$/.test(hNorm)) return true; if (hNorm === 'brochure' || hNorm.includes('brochure')) return true; if (hNorm === 'ppm' || hNorm.includes('private placement') || (hNorm.includes('ppm') && !hNorm.includes('gp'))) return true; if (hNorm === 'video' || hNorm.includes('video url') || (hNorm.includes('video') && hNorm.includes('url'))) return true; if (hNorm.includes('ai offering chat')) return true; if (hNorm.includes('track record')) return true; if (hNorm.includes('sponsor news')) return true; if (hNorm.includes('sales team map') || (hNorm.includes('sales') && hNorm.includes('map'))) return true; if (hNorm.includes('property image')) return true; return false; };

BV.groupForHeader = (hNorm) => { const has = (s) => hNorm.includes(s); if (hNorm === 'sponsor' || has('offering name') || hNorm === 'name') return 'Identity'; if (has('asset class') || has('sector') || has('offering structure') || has('distribution frequency')) return 'Identity'; if (has('focus')) return 'Identity'; if (has('rep comp') || (has('rep') && has('comp'))) return 'Identity'; if ((has('minimum') && has('dst')) || has('minimum - dst')) return 'Identity'; if (has('filed raise') || has('current raise') || has('remaining raise') || (has('remains') && has('%'))) return 'Raise & Timeline'; if (has('offering open') || has('offering close') || has('term') || has('close date') || has('open date')) return 'Raise & Timeline'; if (has('cash on cash') || has('cap rate') || hNorm === 'ltv' || has('loan to value') || has('hold period')) return 'Economics & Returns'; if (has('purchase price') || has('loaded price') || has('appraised') || has('valuation')) return 'Economics & Returns'; if (has('minimum investment') || has('min investment')) return 'Economics & Returns'; if (has('% leased') || has('occupancy') || has('rent escalations') || has('lease term')) return 'Economics & Returns'; if (has('debt terms') || has('lease terms')) return 'Economics & Returns'; if (has('reserve')) return 'Economics & Returns'; if (has('sales load')) return 'Economics & Returns'; if (has('# assets') || has('number assets') || has('num assets')) return 'Property & Operations'; if (has('property location') || has('year built') || has('building age') || has('location')) return 'Property & Operations'; if (has('preferred') || has('promote') || has('gp commit') || has('gp')) return 'Structure, Fees & Tax'; if (has('upreit') || has('721') || has('exemption') || has('tax reporting')) return 'Structure, Fees & Tax'; return 'Sponsor'; };

BV.VCOMP_GROUP_ORDERS = { 'Identity': [(h)=>h==='sponsor', (h)=>h.includes('offering name')||h==='name', (h)=>h.includes('asset class'), (h)=>h.includes('offering structure'), (h)=>h.includes('sector'), (h)=>h.includes('focus'), (h)=>h.includes('distribution'), (h)=>(h.includes('minimum')&&h.includes('dst')), (h)=>h.includes('rep comp')], 'Raise & Timeline': [(h)=>h.includes('offering open'), (h)=>h.includes('offering close'), (h)=>h.includes('filed raise'), (h)=>h.includes('current raise'), (h)=>h.includes('remaining raise')], 'Economics & Returns': [(h)=>h.includes('year 1')&&h.includes('cash'), (h)=>hNorm==='ltv'||h.includes('loan to value'), (h)=>h.includes('hold period'), (h)=>h.includes('% leased')||h.includes('occupancy'), (h)=>h.includes('rent escalations'), (h)=>h.includes('lease term'), (h)=>h.includes('debt terms'), (h)=>h.includes('minimum investment'), (h)=>h.includes('cap rate'), (h)=>h.includes('reserve'), (h)=>h.includes('purchase price'), (h)=>h.includes('appraised'), (h)=>h.includes('loaded price'), (h)=>h.includes('sales load')], 'Property & Operations': [(h)=>h.includes('# assets'), (h)=>h.includes('property location'), (h)=>h.includes('building age')||h.includes('year built')], 'Sponsor': [(h)=>h.includes('sponsor aum'), (h)=>h.includes('sponsor experience'), (h)=>h.includes('number of sponsor offerings'), (h)=>h.includes('sponsor full cycle exits'), (h)=>h.includes('sponsor average irr'), (h)=>h.includes('sponsor best irr'), (h)=>h.includes('sponsor worst irr')] };

BV.GROUP_ORDER = ['Identity','Raise & Timeline','Economics & Returns','Property & Operations','Structure, Fees & Tax','Sponsor'];

BV.vcompIsPercentField = (hNorm) => (hNorm.includes('year 1')&&hNorm.includes('cash'))||hNorm==='ltv'||hNorm.includes('loan to value')||hNorm.includes('% leased')||hNorm.includes('occupancy')||hNorm.includes('rent escalations')||hNorm.includes('cap rate')||hNorm.includes('sales load')||hNorm.includes('rep comp')||hNorm.includes('sponsor average irr')||hNorm.includes('sponsor best irr')||hNorm.includes('sponsor worst irr');
BV.vcompIsMoneyField = (hNorm) => hNorm.includes('reserve')||(hNorm.includes('purchase price'))||hNorm.includes('appraised')||hNorm.includes('valuation')||hNorm.includes('loaded price')||((hNorm.includes('minimum')&&hNorm.includes('dst')));
BV.valueToDisplay = (v) => { if (v == null) return '—'; if (v instanceof Date && !isNaN(v.getTime())) return BV.fmtDate(v); if (typeof v === 'number' && isFinite(v)) return String(v); const s = String(v).trim(); if (!s || /^na$/i.test(s)) return '—'; if (/^(Date|Datetime)\(/i.test(s)) { const d = BV.parseDate(s); return d ? BV.fmtDate(d) : s; } return s; };
BV.vcompFormatValue = (hNorm, raw) => { if (raw instanceof Date) return BV.fmtDate(raw); if (typeof raw === 'string' && /^(Date|Datetime)\(/i.test(raw.trim())) { const d = BV.parseDate(raw); return d ? BV.fmtDate(d) : raw; } if (BV.vcompIsPercentField(hNorm)) { let num = typeof raw === 'number' ? raw : BV.parseNumberLoose(raw); if (num == null) return BV.valueToDisplay(raw); if (Math.abs(num) <= 1) num *= 100; return BV.fmtPct(num, 2); } if (BV.vcompIsMoneyField(hNorm)) { let num = typeof raw === 'number' ? raw : BV.parseMoney(raw); if (num == null) return BV.valueToDisplay(raw); return BV.fmtMoneyFull(num); } return BV.valueToDisplay(raw); };

BV.renderVerticalCompTable = (selectedFunds, headers) => {
  if (!selectedFunds || !selectedFunds.length || !headers || !headers.length) return '';
  const e = BV.escapeHTML;
  const cols = headers.map((h, idx) => ({ idx, h, norm: BV.normalizeHeader(h) })).filter(c => c.h && c.norm && !BV.isExcludedHeader(c.norm));
  const grouped = new Map();
  for (const c of cols) { const g = BV.groupForHeader(c.norm); if (!grouped.has(g)) grouped.set(g, []); grouped.get(g).push(c); }
  for (const [g, arr] of grouped.entries()) {
    const rules = BV.VCOMP_GROUP_ORDERS[g];
    arr.sort((a,b) => { if (!rules) return a.h.localeCompare(b.h); let ai = null, bi = null; for (let i=0; i<rules.length; i++) { try { if (rules[i](a.norm)) ai = i; } catch(e){} try { if (rules[i](b.norm)) bi = i; } catch(e){} } if (ai!=null && bi!=null) return ai-bi; if (ai!=null) return -1; if (bi!=null) return 1; return a.h.localeCompare(b.h); });
    if (g === 'Identity') { let kept = false; grouped.set(g, arr.filter(c => { if (c.norm.includes('offering name') || c.norm === 'name') { if (kept) return false; kept = true; } return true; })); }
  }
  const groupsOut = [];
  for (const g of BV.GROUP_ORDER) { const arr = grouped.get(g); if (arr && arr.length) groupsOut.push({ group: g, cols: arr }); }
  for (const [g, arr] of grouped.entries()) { if (!BV.GROUP_ORDER.includes(g) && arr.length) groupsOut.push({ group: g, cols: arr }); }
  if (!groupsOut.length) return '<div class="sec"><div class="secHdr"><div class="h">Vertical Comparison Table</div></div><div class="secBody"><div style="padding:12px;color:rgba(9,14,25,0.58)">No comparable columns found.</div></div></div>';

  const offerHdrs = selectedFunds.map(f => ({ title: f.offering_name || '(Unnamed)', sub: f.sponsor || '—', full: f.displayLabel }));
  const thead = '<thead><tr><th class="vcompField">Field</th>' + offerHdrs.map(o => '<th><div class="vcompOfferHdr" title="'+e(o.full)+'">'+e(o.title)+'</div><div class="vcompOfferSub" title="'+e(o.sub)+'">'+e(o.sub)+'</div></th>').join('') + '</tr></thead>';

  const bodyRows = groupsOut.map(g => {
    let html = '<tr class="vcompGroupRow"><td colspan="'+(1+selectedFunds.length)+'">'+e(g.group)+'</td></tr>';
    html += g.cols.map(c => {
      const fieldLabel = c.h || '—';
      const vals = selectedFunds.map(f => {
        const raw = (f.__rawRow && Array.isArray(f.__rawRow)) ? f.__rawRow[c.idx] : '';
        const shouldFormat = (g.group === 'Economics & Returns') || (g.group === 'Identity' && ((c.norm.includes('minimum') && c.norm.includes('dst')) || c.norm.includes('rep comp'))) || (g.group === 'Sponsor' && (c.norm.includes('sponsor average irr') || c.norm.includes('sponsor best irr') || c.norm.includes('sponsor worst irr')));
        const disp = shouldFormat ? BV.vcompFormatValue(c.norm, raw) : BV.valueToDisplay(raw);
        return disp === '—' ? '<td><div class="vcompNA">—</div></td>' : '<td><div class="vcompVal">'+e(disp)+'</div></td>';
      }).join('');
      return '<tr><td class="vcompField">'+e(fieldLabel)+'</td>'+vals+'</tr>';
    }).join('');
    return html;
  }).join('');

  return '<div class="sec"><div class="secHdr"><div class="h">Vertical Side-by-Side Comparison</div><div class="hint">All columns except Year 1–10 and doc URLs • Sticky headers</div></div><div class="secBody"><div class="vcompWrap"><div class="vcompTop"><div class="t">Comparison Table</div><div class="s">Scroll down — headers stay pinned</div></div><div class="vcompScroller"><table class="vcompTable">' + thead + '<tbody>' + bodyRows + '</tbody></table></div></div></div></div>';
};

// ── Main renderBasket() — Premium Single + Multi Offering View ──
function renderBasket() {
  try {
  return _renderBasketInner();
  } catch(err) {
    console.error('renderBasket crash:', err);
    return '<div class="page-header"><div><div class="page-title">Offering Detail</div></div></div><div class="empty-state"><div class="empty-state-icon">⚠️</div><h3>View Error</h3><p style="font-family:monospace;font-size:11px;color:red">' + String(err) + '</p><p style="font-size:11px;color:var(--slate2)">Check browser console for full stack trace.</p></div>';
  }
}
function _renderBasketInner() {
  const basketIds = STATE.basket;
  const platformFunds = basketIds.map(id => STATE.funds.find(f => f.id === id)).filter(Boolean);
  if (!platformFunds.length) {
    return '<div class="page-header"><div><div class="page-title">Offering Detail</div><div class="page-subtitle">Add offerings from Browse to view full tear sheet analysis</div></div></div><div class="empty-state"><div class="empty-state-icon">📋</div><h3>No Offering Selected</h3><p>Add up to 3 offerings from Browse to unlock the full tear sheet — KPI strip, raise status, valuation analysis, income projections, and side-by-side comparison.</p><button class="btn btn-primary" onclick="navigateTo(\'browse\')">Browse Offerings</button></div>';
  }

  const selectedFunds = platformFunds.map(BV.adaptFund).filter(Boolean);
  const allAdapted = STATE.funds.map(BV.adaptFund).filter(Boolean);
  const peer = BV.computePeerStats(allAdapted);
  const n = selectedFunds.length;
  const isMulti = n > 1;
  const e = BV.escapeHTML;
  const c = STATE.client;
  const hasClient = !!(c && c.name && (c.riskTolerance || c.exchangeAmount));

  // Offering color tags
  const TAG_COLORS = ['od-tag-1','od-tag-2','od-tag-3'];
  const TAG_LABELS = ['①','②','③'];
  const MAP_COLORS = ['#3B82F6','#9333EA','#D97706'];

  // ── Nav Header ──
  const offeringOpts = STATE.funds.map(f => {
    const checked = STATE.basket.includes(f.id);
    const disabled = !checked && STATE.basket.length >= 3;
    return '<label class="bv-select-item' + (checked?' checked':'') + (disabled?' disabled':'') + '" onclick="event.stopPropagation()"><input type="checkbox" value="' + f.id + '"' + (checked?' checked':'') + (disabled?' disabled':'') + ' onchange="bvToggleOffering(' + f.id + ')"><span class="bv-select-name">' + e(f.sponsor + ' — ' + f.name) + '</span>' + (checked ? '<span class="bv-select-x" onclick="event.preventDefault();bvToggleOffering(' + f.id + ')">✕</span>' : '') + '</label>';
  }).join('');

  const navHeader = '<div class="page-header"><div><div class="page-title">Offering Detail</div><div class="page-subtitle">' + n + ' offering' + (n>1?'s':'') + ' selected' + (isMulti ? ' — portfolio view' : '') + '</div></div><div style="display:flex;gap:8px;align-items:center"><div class="bv-dropdown-wrap"><button class="btn btn-secondary" onclick="document.getElementById(\'bv-offering-dropdown\').classList.toggle(\'open\')">Offerings (' + n + '/3) ▾</button><div class="bv-dropdown" id="bv-offering-dropdown">' + offeringOpts + '</div></div><button class="btn btn-secondary" onclick="navigateTo(\'browse\')">← Browse</button><button class="btn btn-ghost" onclick="STATE.basket=[];saveBasket();renderApp();toast(\'Basket cleared\')">Clear All</button></div></div>';

  // ── Build suitability scores ──
  const suitScores = selectedFunds.map(sf => {
    const pf = platformFunds.find(x => x.id === sf.id);
    return pf ? computeDashboardSuitScore(pf, STATE.client) : null;
  });
  const blendedSuit = suitScores.filter(x => x != null).length ? Math.round(suitScores.filter(x=>x!=null).reduce((a,b)=>a+b,0)/suitScores.filter(x=>x!=null).length) : null;
  const suitClass = (sc) => sc == null ? 'none' : sc >= 75 ? 'high' : sc >= 50 ? 'medium' : 'low';
  const suitLabel = (sc) => sc == null ? (hasClient ? 'Calculating...' : 'Set up client') : sc + '% match';

  // ── Offering tags (multi mode) ──
  const offeringTagsHtml = isMulti ? '<div class="od-offering-tags">' + selectedFunds.map((sf,i) => '<span class="od-offering-tag ' + TAG_COLORS[i] + '">' + TAG_LABELS[i] + ' ' + e(sf.offering_name) + '</span>').join('') + '</div>' : '';

  // ── Hero ──
  const heroHtml = renderODHero(selectedFunds, peer, e, isMulti, TAG_COLORS, TAG_LABELS, MAP_COLORS);

  // ── KPI Strip ──
  const kpiKeys = [
    { key:'ltv', label:'Loan-to-Value', higher:'lower_better' },
    { key:'year1_coc', label:'Yr 1 Cash-on-Cash', higher:'higher_better' },
    { key:'pct_leased', label:'Occupancy', higher:'higher_better' },
    { key:'dscr', label:'DSCR', higher:'higher_better', fmt:(v)=>BV.isNum(v)?v.toFixed(2)+'x':'—' }
  ];
  const kpiStripHtml = renderODKpiStrip(selectedFunds, peer, kpiKeys, e, isMulti);

  // ── DD Icon Row ──
  const ddRowHtml = renderODDdRow(selectedFunds, e, isMulti);

  // ── Action Bar ──
  const suitDisplay = isMulti ? blendedSuit : suitScores[0];
  const actionBarHtml = '<div class="od-action-bar">' +
    '<button class="btn btn-primary" onclick="toast(\'Added to basket\')">+ Add to Basket</button>' +
    '<button class="btn btn-secondary" onclick="navigateTo(\'portfolio_builder\')">📐 Build Portfolio</button>' +
    '<button class="btn btn-secondary" onclick="toast(\'Share link copied\')">🔗 Share Tear Sheet</button>' +
    '<button class="btn btn-secondary" onclick="navigateTo(\'model\')">🧮 Model for Client</button>' +
    '<span class="od-suit-chip ' + suitClass(suitDisplay) + '">' +
    (hasClient ? '🎯 ' + suitLabel(suitDisplay) : '👤 ' + (c.name ? suitLabel(suitDisplay) : 'Set up client profile')) +
    '</span>' +
    '</div>';

  // ── Body Panels ──
  const suitPanel = renderODSuitPanel(selectedFunds, suitScores, hasClient, c, e, isMulti);
  const raisePanel = renderODRaisePanel(selectedFunds, e, isMulti);
  const valPanel = renderODValPanel(selectedFunds, e, isMulti);
  const debtLeasePanel = renderODDebtLeasePanel(selectedFunds, e, isMulti);
  const kdPanel = renderODKeyDriversPanel(selectedFunds, peer, e, isMulti);
  const distPanel = renderODDistPanel(selectedFunds, e);
  const projPanel = renderODProjPanel(selectedFunds, c, e, isMulti);
  const sponsorPanel = renderODSponsorPanel(selectedFunds, e, isMulti);

  // ── Key Metrics Comparison (multi only) ──
  const keyMetricsComp = isMulti ? renderODKeyMetricsComp(selectedFunds, peer, e, TAG_COLORS, TAG_LABELS) : '';

  // ── Full Vertical Comparison ──
  const vcompHtml = BV.renderVerticalCompTable(selectedFunds, STATE.headers || []);

  // ── Disclosures ──
  const discHtml = '<div class="od-panel od-body-full"><div class="od-panel-hdr"><div class="od-panel-title">Important Disclosures</div></div><div class="od-panel-body"><div style="font-size:11px;color:var(--slate2);line-height:1.7">' + e(BV.DISCLOSURES) + '</div></div></div>';

  // ── Assemble ──
  const bodyGrid = '<div class="od-body">' +
    suitPanel + raisePanel + valPanel + debtLeasePanel +
    '<div class="od-body-full">' + kdPanel + '</div>' +
    distPanel + sponsorPanel +
    '<div class="od-body-full">' + projPanel + '</div>' +
    '</div>';

  return navHeader + '<div class="od-wrap">' + offeringTagsHtml + heroHtml + kpiStripHtml + ddRowHtml + actionBarHtml + bodyGrid + (isMulti ? keyMetricsComp : '') + '<div class="bv"><div class="sections">' + vcompHtml + '</div></div>' + discHtml + '</div>';
}

// ── Hero ──
function renderODHero(funds, peer, e, isMulti, TAG_COLORS, TAG_LABELS, MAP_COLORS) {
  const f0 = funds[0];
  // Sponsor logo/initials
  const logoHtml = (f0.sponsor_logo_url)
    ? '<div class="od-sponsor-logo"><img src="' + e(f0.sponsor_logo_url) + '" alt="' + e(f0.sponsor) + '"></div>'
    : '<div class="od-sponsor-logo">' + e((f0.sponsor||'?').substring(0,2).toUpperCase()) + '</div>';

  // Badges
  const statusBadgeClass = { 'Open':'status-open','Closing':'status-closing','Coming Soon':'status-coming','Closed':'status-closed' }[f0.status] || 'status-open';
  const statusDot = { 'Open':'🟢','Closing':'🟡','Coming Soon':'🔵','Closed':'🔴' }[f0.status] || '🟢';

  let titleHtml, badgesHtml, locationHtml, sponsorMetaHtml;

  if (!isMulti) {
    titleHtml = '<div class="od-hero-name">' + e(f0.offering_name) + '</div>';
    badgesHtml = '<div class="od-hero-badges">' +
      '<span class="od-hero-badge ' + statusBadgeClass + '">' + statusDot + ' ' + e(f0.status) + '</span>' +
      (f0.asset_class ? '<span class="od-hero-badge">' + e(f0.asset_class) + '</span>' : '') +
      (f0.sector_focus ? '<span class="od-hero-badge">' + e(f0.sector_focus) + '</span>' : '') +
      (f0.focus && f0.focus !== f0.sector_focus ? '<span class="od-hero-badge">' + e(f0.focus) + '</span>' : '') +
      '</div>';
    locationHtml = f0.property_locations ? '<div class="od-hero-location">📍 ' + e(f0.property_locations) + '</div>' : '';
    sponsorMetaHtml = '<div class="od-sponsor-meta"><div class="od-sponsor-name">' + e(f0.sponsor) + '</div>' +
      (f0.sponsor_experience ? '<div class="od-sponsor-exp">Est. ' + e(f0.sponsor_experience) + '</div>' : '') + '</div>';
  } else {
    const sponsors = [...new Set(funds.map(f=>f.sponsor))];
    titleHtml = '<div class="od-hero-name">' + funds.map((f,i) => '<span class="od-offering-tag ' + TAG_COLORS[i] + '" style="font-size:14px;padding:4px 12px;margin-right:6px">' + TAG_LABELS[i] + ' ' + e(f.offering_name) + '</span>').join('') + '</div>';
    badgesHtml = '<div class="od-hero-badges"><span class="od-blended-badge">⚖️ Portfolio View — Blended Metrics</span></div>';
    locationHtml = '<div class="od-hero-location">📍 ' + funds.map(f=>e(f.property_locations||'—')).join(' · ') + '</div>';
    sponsorMetaHtml = '<div class="od-sponsor-meta"><div class="od-sponsor-name">' + e(sponsors.join(', ')) + '</div><div class="od-sponsor-exp">' + funds.length + ' sponsors · blended view</div></div>';
  }

  // Map in hero right
  const allStates = isMulti
    ? funds.flatMap((f,i) => BV.extractStates(f.property_locations).map(s=>({s,i})))
    : BV.extractStates(f0.property_locations).map(s=>({s,i:0}));
  const mapHtml = '<div class="od-map-card"><div class="od-map-title">Property Footprint</div><div class="od-map-box" id="od-map"></div>' +
    (isMulti ? '<div class="od-map-legend">' + funds.map((f,i)=>'<span class="od-map-leg-item"><span class="od-map-leg-dot od-map-leg-dot-' + (i+1) + '"></span>' + e(f.offering_name) + '</span>').join('') + '</div>' : '') +
    '</div>';

  // Status module (single only)
  const statusModule = !isMulti ? '<div>' + BV.renderStatusModule(funds[0]) + '</div>' : renderODMultiRaiseStatus(funds, e);

  return '<div class="od-hero"><div class="od-hero-inner"><div class="od-hero-top"><div class="od-hero-left">' +
    '<div class="od-sponsor-row">' + logoHtml + sponsorMetaHtml + '</div>' +
    titleHtml + badgesHtml + locationHtml +
    '</div><div class="od-hero-right">' +
    statusModule +
    mapHtml +
    '</div></div></div></div>';
}

// Multi-offering raise status (compact)
function renderODMultiRaiseStatus(funds, e) {
  return '<div style="display:flex;flex-direction:column;gap:6px">' + funds.map((f,i) => {
    const m = f.metrics;
    const pctR = BV.isNum(m.pct_raise_remaining) ? Math.max(0,Math.min(100,m.pct_raise_remaining)) : null;
    const pctRaised = pctR != null ? (100-pctR).toFixed(0) + '% raised' : '—';
    return '<div style="background:rgba(255,255,255,0.09);border:1px solid rgba(255,255,255,0.14);border-radius:8px;padding:8px 12px">' +
      '<div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:4px">' +
      '<span style="font-size:10px;font-weight:700;color:rgba(255,255,255,0.7)">' + e(f.offering_name.length>28?f.offering_name.substring(0,26)+'…':f.offering_name) + '</span>' +
      '<span style="font-size:11px;font-weight:800;color:rgba(255,255,255,0.9);font-family:monospace">' + pctRaised + '</span>' +
      '</div>' +
      (pctR!=null ? '<div style="height:5px;background:rgba(255,255,255,0.12);border-radius:3px;overflow:hidden"><div style="height:100%;width:' + (100-pctR) + '%;background:linear-gradient(90deg,#34D399,#3B82F6);border-radius:3px"></div></div>' : '') +
      '</div>';
  }).join('') + '</div>';
}

// ── KPI Strip ──
function renderODKpiStrip(funds, peer, kpiKeys, e, isMulti) {
  return '<div class="od-kpi-strip">' + kpiKeys.map(kpi => {
    const vals = funds.map(f => f.metrics[kpi.key]).filter(BV.isNum);
    const val = vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : null;
    const p = peer.stats[kpi.key];
    let peerHtml = '';
    if (BV.isNum(val) && p && BV.isNum(p.avg)) {
      const d = val - p.avg;
      const better = kpi.higher === 'higher_better' ? d > 0.05 : d < -0.5;
      const worse = kpi.higher === 'higher_better' ? d < -0.05 : d > 0.5;
      const cls = better ? 'up' : worse ? 'down' : 'neutral';
      const arrow = better ? '↑' : worse ? '↓' : '~';
      const dStr = kpi.key === 'dscr' ? Math.abs(d).toFixed(2)+'x' : Math.abs(d).toFixed(2)+'%';
      peerHtml = '<div class="od-kpi-peer">Peer avg: ' + BV.metricFormatter(kpi.key, p.avg) + ' <span class="' + cls + '">' + arrow + ' ' + dStr + '</span></div>';
    } else {
      peerHtml = '<div class="od-kpi-peer" style="color:var(--mist)">Peer avg: —</div>';
    }
    const dispVal = kpi.fmt ? kpi.fmt(val) : BV.metricFormatter(kpi.key, val);
    return '<div class="od-kpi-cell"><div class="od-kpi-label">' + kpi.label + '</div><div class="od-kpi-value">' + dispVal + '</div>' + peerHtml + '</div>';
  }).join('') + '</div>';
}

// ── DD Icon Row ──
function renderODDdRow(funds, e, isMulti) {
  const groups = [
    { label: 'Offering DD', types: ['brochure','ppm','video','ai_offering_chat'] },
    { label: 'Sponsor DD', types: ['track_record','sponsor_news','sales_team_map'] },
    { label: 'Latest Updates', types: ['quarterly_update'] }
  ];
  const docLabels = { brochure:'Brochure', ppm:'PPM', video:'Video', ai_offering_chat:'AI Chat', track_record:'Track Record', sponsor_news:'Sponsor News', sales_team_map:'Sales Team', quarterly_update:'Q4 Update' };

  let html = '<div class="od-dd-row">';
  groups.forEach((group, gi) => {
    if (gi > 0) html += '<div class="od-dd-divider"></div>';
    html += '<div class="od-dd-group"><span class="od-dd-group-label">' + group.label + '</span>';
    group.types.forEach(type => {
      const available = funds.some(f => f.docs && f.docs[type]);
      if (!available) {
        html += '<button class="od-doc-btn unavailable">' + BV.iconSvg(type) + docLabels[type] + '</button>';
        return;
      }
      if (!isMulti) {
        const url = funds[0].docs[type];
        html += '<a class="od-doc-btn" href="' + e(url) + '" target="_blank" rel="noopener noreferrer">' + BV.iconSvg(type) + docLabels[type] + '</a>';
      } else {
        // Multi: dropdown showing per-offering options
        const dropId = 'od-doc-drop-' + type;
        html += '<div class="bv-dropdown-wrap">' +
          '<button class="od-doc-btn has-dropdown" onclick="document.getElementById(\'' + dropId + '\').classList.toggle(\'open\')">' + BV.iconSvg(type) + docLabels[type] + '</button>' +
          '<div class="bv-dropdown" id="' + dropId + '" style="min-width:280px">' +
          funds.map((f,i) => {
            const url = f.docs[type];
            return url
              ? '<a class="bv-select-item" href="' + e(url) + '" target="_blank" rel="noopener noreferrer" style="gap:10px"><span style="font-size:11px;font-weight:700;padding:1px 7px;border-radius:10px;background:' + (i===0?'rgba(59,130,246,0.1)':i===1?'rgba(147,51,234,0.1)':'rgba(217,119,6,0.1)') + '">' + ['①','②','③'][i] + '</span>' + BV.iconSvg(type) + '<span class="bv-select-name">' + e(f.offering_name) + '</span></a>'
              : '<div class="bv-select-item disabled"><span style="font-size:11px;font-weight:700;padding:1px 7px;border-radius:10px;background:rgba(0,0,0,0.05)">' + ['①','②','③'][i] + '</span><span class="bv-select-name" style="color:var(--fog)">' + e(f.offering_name) + ' — N/A</span></div>';
          }).join('') +
          '</div></div>';
      }
    });
    html += '</div>';
  });
  html += '</div>';
  return html;
}

// ── Suitability Panel ──
function renderODSuitPanel(funds, suitScores, hasClient, c, e, isMulti) {
  if (!hasClient) {
    return '<div class="od-panel"><div class="od-panel-hdr"><div class="od-panel-title">Suitability</div></div><div class="od-panel-body">' +
      '<div class="empty-state" style="padding:20px"><div class="empty-state-icon">👤</div><h3 style="font-size:14px">No Client Profile</h3><p style="font-size:12px">Set up a client profile to see suitability analysis, income projections, and personalized match scores.</p><button class="btn btn-primary btn-sm" onclick="openProfileModal()">Set Up Client</button></div>' +
      '</div></div>';
  }
  const sc = isMulti ? Math.round(suitScores.filter(x=>x!=null).reduce((a,b)=>a+b,0)/suitScores.filter(x=>x!=null).length) : suitScores[0];
  const cls = sc == null ? 'none' : sc >= 75 ? 'high' : sc >= 50 ? 'medium' : 'low';
  const ringHtml = sc != null ? '<div class="od-suit-score-ring ' + cls + '">' + sc + '%</div>' : '';

  const rows = [
    ['Client', c.name || '—'],
    ['Risk Tolerance', c.riskTolerance ? c.riskTolerance.charAt(0).toUpperCase()+c.riskTolerance.slice(1) : '—'],
    ['Horizon', c.horizon ? {short:'Short (3–5 yr)',medium:'Medium (5–10 yr)',long:'Long (10+ yr)'}[c.horizon] : '—'],
    ['1031 Exchange', c.exchangeAmount ? fmtMoney(c.exchangeAmount) : '—'],
    ['Filing Status', c.filing ? c.filing.charAt(0).toUpperCase()+c.filing.slice(1) : '—'],
  ];

  if (isMulti) {
    // Show per-offering scores
    const perOfferHtml = funds.map((f,i) => {
      const s = suitScores[i];
      const sc2 = s == null ? 'none' : s >= 75 ? 'high' : s >= 50 ? 'medium' : 'low';
      return '<div class="od-suit-row"><span class="od-suit-key">' + e(f.offering_name.length>22?f.offering_name.substring(0,20)+'…':f.offering_name) + '</span><span class="suit-score ' + sc2 + '">' + (s != null ? s + '%' : '—') + '</span></div>';
    }).join('');
    return '<div class="od-panel"><div class="od-panel-hdr"><div class="od-panel-title">Suitability</div><span class="od-blended-badge">Blended</span></div><div class="od-panel-body">' +
      '<div style="display:flex;align-items:center;margin-bottom:12px">' + ringHtml + '<div><div style="font-size:13px;font-weight:700;color:var(--navy)">' + (c.name || 'Client') + '</div><div style="font-size:11px;color:var(--slate2)">Blended match score</div></div></div>' +
      perOfferHtml +
      '<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--surface2)">' +
      rows.slice(0,3).map(([k,v]) => '<div class="od-suit-row"><span class="od-suit-key">' + k + '</span><span class="od-suit-val">' + v + '</span></div>').join('') +
      '</div></div></div>';
  }

  return '<div class="od-panel"><div class="od-panel-hdr"><div class="od-panel-title">Suitability</div></div><div class="od-panel-body">' +
    '<div style="display:flex;align-items:center;margin-bottom:14px">' + ringHtml +
    '<div><div style="font-size:15px;font-weight:700;color:var(--navy)">' + (sc != null ? (sc >= 75 ? 'Strong Match' : sc >= 50 ? 'Moderate Match' : 'Low Match') : '—') + '</div><div style="font-size:11px;color:var(--slate2)">' + (sc != null ? sc + '% suitability score' : '') + '</div></div></div>' +
    rows.map(([k,v]) => '<div class="od-suit-row"><span class="od-suit-key">' + k + '</span><span class="od-suit-val">' + v + '</span></div>').join('') +
    '</div></div>';
}

// ── Raise Status Panel ──
function renderODRaisePanel(funds, e, isMulti) {
  const renderSingle = (f) => {
    const m = f.metrics;
    const pctR = BV.isNum(m.pct_raise_remaining) ? Math.max(0,Math.min(100,m.pct_raise_remaining)) : 0;
    const pctRaised = 100 - pctR;
    return (isMulti ? '<div style="margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid var(--surface2)"><div style="font-size:11px;font-weight:700;color:var(--navy);margin-bottom:6px">' + e(f.offering_name) + '</div>' : '') +
      '<div style="display:flex;justify-content:space-between;font-size:11px;color:var(--slate2);margin-bottom:4px"><span>Raise Progress</span><span style="font-weight:700;color:var(--navy)">' + pctRaised.toFixed(0) + '% raised</span></div>' +
      '<div class="od-raise-bar"><div class="od-raise-fill" style="width:' + pctRaised + '%"></div></div>' +
      '<div class="od-raise-stat-row">' +
      '<div class="od-raise-stat"><div class="od-raise-stat-val">' + BV.fmtMoney(m.filed_raise) + '</div><div class="od-raise-stat-label">Filed</div></div>' +
      '<div class="od-raise-stat"><div class="od-raise-stat-val">' + BV.fmtMoney(m.remaining_raise) + '</div><div class="od-raise-stat-label">Remaining</div></div>' +
      '<div class="od-raise-stat"><div class="od-raise-stat-val">' + (BV.isNum(m.raise_velocity) ? fmtMoney(Math.round(m.raise_velocity)) + '/mo' : (BV.isNum(m.months_on_market) ? m.months_on_market + ' mos' : '—')) + '</div><div class="od-raise-stat-label">' + (BV.isNum(m.raise_velocity) ? 'Velocity' : 'On Market') + '</div></div>' +
      '</div>' +
      (isMulti ? '</div>' : '');
  };

  const closeDateInfo = !isMulti && funds[0].metrics.offering_close instanceof Date
    ? '<div style="margin-top:10px;padding:8px 12px;background:var(--surface);border-radius:6px;font-size:11.5px;color:var(--slate)"><b>Close Date:</b> ' + BV.fmtDate(funds[0].metrics.offering_close) + ' &nbsp;·&nbsp; <b>Open:</b> ' + BV.fmtDate(funds[0].metrics.offering_open) + '</div>'
    : '';

  return '<div class="od-panel"><div class="od-panel-hdr"><div class="od-panel-title">Raise Status</div>' +
    (!isMulti && BV.isNum(funds[0].metrics.months_on_market) ? '<div class="od-panel-hint">' + funds[0].metrics.months_on_market + ' months on market</div>' : '') +
    '</div><div class="od-panel-body">' +
    funds.map(renderSingle).join('') +
    closeDateInfo +
    '</div></div>';
}

// ── Valuation Panel ──
function renderODValPanel(funds, e, isMulti) {
  const renderSingle = (f, showTitle) => {
    const m = f.metrics;
    const unloaded = m.purchase_price_unloaded;
    const appraised = m.appraised_valuation;
    const loaded = m.loaded_price;
    const sqft = m.total_sqft;
    const ppsf = m.price_per_sqft;
    const delta = (BV.isNum(unloaded) && BV.isNum(appraised) && appraised > 0) ? ((unloaded - appraised) / appraised * 100) : null;
    const isDisc = BV.isNum(delta) ? delta <= 0 : null;
    const heroClass = isDisc == null ? 'neutral' : isDisc ? 'discount' : 'premium';
    const heroLabel = isDisc == null ? 'Valuation Data Unavailable' : isDisc ? 'Discount to Appraisal' : 'Premium to Appraisal';
    const pctStr = BV.isNum(delta) ? (delta<=0?'−':'+')+Math.abs(delta).toFixed(1)+'%' : '—';

    return (showTitle ? '<div style="font-size:11px;font-weight:700;color:var(--navy);margin-bottom:6px">' + e(f.offering_name) + '</div>' : '') +
      '<div class="od-val-hero ' + heroClass + '">' +
      '<div><div class="od-val-pct ' + heroClass + '">' + pctStr + '</div></div>' +
      '<div><div class="od-val-label">' + heroLabel + '</div><div class="od-val-sub">Purchase vs Appraised</div></div>' +
      '</div>' +
      '<div class="od-val-kv">' +
      '<div class="od-val-kv-item"><div class="od-val-kv-label">Purchase (Unloaded)</div><div class="od-val-kv-value">' + BV.fmtMoney(unloaded) + '</div></div>' +
      '<div class="od-val-kv-item"><div class="od-val-kv-label">Appraised Value</div><div class="od-val-kv-value">' + BV.fmtMoney(appraised) + '</div></div>' +
      '<div class="od-val-kv-item"><div class="od-val-kv-label">Loaded Price</div><div class="od-val-kv-value">' + BV.fmtMoney(loaded) + '</div></div>' +
      '<div class="od-val-kv-item"><div class="od-val-kv-label">Price / SF</div><div class="od-val-kv-value">' + (BV.isNum(ppsf) ? '$'+Math.round(ppsf).toLocaleString()+'/SF' : (BV.isNum(sqft) ? '$—' : 'N/A')) + '</div></div>' +
      '</div>';
  };

  return '<div class="od-panel"><div class="od-panel-hdr"><div class="od-panel-title">Valuation</div><div class="od-panel-hint">vs appraisal</div></div><div class="od-panel-body">' +
    (isMulti
      ? funds.map((f,i) => '<div style="' + (i>0?'margin-top:14px;padding-top:14px;border-top:1px solid var(--surface2)':'') + '">' + renderSingle(f, true) + '</div>').join('')
      : renderSingle(funds[0], false)) +
    '</div></div>';
}

// ── Debt & Lease Panel ──
function renderODDebtLeasePanel(funds, e, isMulti) {
  const renderSingle = (f, showTitle) => {
    const tenantCredit = f.tenant_credit || '';
    const propType = f.asset_class || '';
    let creditDisplay = tenantCredit;
    if (!tenantCredit || /^n\/?a$/i.test(tenantCredit.trim())) {
      if (/multifamily/i.test(propType)) creditDisplay = 'N/A — Residential (Multifamily)';
      else if (/self.?stor/i.test(propType)) creditDisplay = 'N/A — Self Storage';
      else if (/senior/i.test(propType)) creditDisplay = 'N/A — Senior Living';
      else creditDisplay = 'N/A';
    }
    return (showTitle ? '<div style="font-size:11px;font-weight:700;color:var(--navy);margin-bottom:6px">' + e(f.offering_name) + '</div>' : '') +
      '<div style="display:grid;gap:8px">' +
      '<div style="padding:10px 12px;background:var(--surface);border-radius:var(--radius);border:1px solid var(--mist)"><div style="font-size:10px;font-weight:700;color:var(--fog);text-transform:uppercase;letter-spacing:.07em;margin-bottom:4px">Debt Terms</div><div style="font-size:12px;color:var(--navy);line-height:1.5">' + e(f.debt_terms || '—') + '</div></div>' +
      '<div style="padding:10px 12px;background:var(--surface);border-radius:var(--radius);border:1px solid var(--mist)"><div style="font-size:10px;font-weight:700;color:var(--fog);text-transform:uppercase;letter-spacing:.07em;margin-bottom:4px">Lease Terms</div><div style="font-size:12px;color:var(--navy);line-height:1.5">' + e(f.lease_terms || '—') + '</div></div>' +
      '<div style="padding:10px 12px;background:var(--surface);border-radius:var(--radius);border:1px solid var(--mist)"><div style="font-size:10px;font-weight:700;color:var(--fog);text-transform:uppercase;letter-spacing:.07em;margin-bottom:4px">Tenant Credit Quality</div><div style="font-size:12px;color:var(--navy);line-height:1.5">' + e(creditDisplay) + '</div></div>' +
      '</div>';
  };

  return '<div class="od-panel"><div class="od-panel-hdr"><div class="od-panel-title">Debt & Lease</div></div><div class="od-panel-body">' +
    (isMulti
      ? funds.map((f,i) => '<div style="' + (i>0?'margin-top:14px;padding-top:14px;border-top:1px solid var(--surface2)':'') + '">' + renderSingle(f, true) + '</div>').join('')
      : renderSingle(funds[0], false)) +
    '</div></div>';
}

// ── Key Drivers Panel ──
function renderODKeyDriversPanel(funds, peer, e, isMulti) {
  const f = funds[0];
  const m = f.metrics;
  const p = peer.stats;
  const drivers = [];

  // LTV
  if (BV.isNum(m.ltv)) {
    const avg = p.ltv?.avg;
    const low = m.ltv < 60;
    drivers.push({ type: low ? 'positive' : m.ltv > 70 ? 'caution' : 'info', icon: low ? '✅' : m.ltv > 70 ? 'ℹ️' : '✅', text: 'LTV of ' + m.ltv.toFixed(1) + '% — ' + (avg ? (m.ltv < avg ? 'below' : 'above') + ' peer avg of ' + avg.toFixed(1) + '%' : (low ? 'conservative leverage' : 'moderate leverage')) });
  }
  // DSCR
  if (BV.isNum(m.dscr)) {
    drivers.push({ type: m.dscr >= 1.4 ? 'positive' : m.dscr >= 1.2 ? 'info' : 'caution', icon: m.dscr >= 1.4 ? '✅' : m.dscr >= 1.2 ? 'ℹ️' : '⚠️', text: 'DSCR of ' + m.dscr.toFixed(2) + 'x — ' + (m.dscr >= 1.4 ? 'strong debt service coverage' : m.dscr >= 1.2 ? 'adequate coverage' : 'thin coverage, monitor closely') });
  }
  // Occupancy
  if (BV.isNum(m.pct_leased)) {
    drivers.push({ type: m.pct_leased >= 95 ? 'positive' : m.pct_leased >= 85 ? 'info' : 'caution', icon: m.pct_leased >= 95 ? '✅' : m.pct_leased >= 85 ? 'ℹ️' : '⚠️', text: m.pct_leased.toFixed(1) + '% occupied' + (p.pct_leased?.avg ? ' vs peer avg ' + p.pct_leased.avg.toFixed(1) + '%' : '') });
  }
  // Lease term
  if (BV.isNum(m.avg_lease_term_remaining)) {
    drivers.push({ type: m.avg_lease_term_remaining >= 8 ? 'positive' : m.avg_lease_term_remaining >= 4 ? 'info' : 'caution', icon: m.avg_lease_term_remaining >= 8 ? '✅' : m.avg_lease_term_remaining >= 4 ? 'ℹ️' : '⚠️', text: m.avg_lease_term_remaining.toFixed(1) + ' yr avg lease term remaining — ' + (m.avg_lease_term_remaining >= 8 ? 'long-term income stability' : m.avg_lease_term_remaining >= 4 ? 'moderate term visibility' : 'near-term rollover risk') });
  }
  // CoC vs peer
  if (BV.isNum(m.year1_coc) && p.year1_coc?.avg) {
    const d = m.year1_coc - p.year1_coc.avg;
    drivers.push({ type: d > 0.3 ? 'positive' : d < -0.3 ? 'caution' : 'info', icon: d > 0.3 ? '✅' : d < -0.3 ? 'ℹ️' : 'ℹ️', text: 'Year 1 CoC of ' + m.year1_coc.toFixed(2) + '%' + (Math.abs(d) > 0.1 ? (d>0?' — above':' — below') + ' peer avg by ' + Math.abs(d).toFixed(2) + ' pts' : ' — in line with peers') });
  }
  // 721 UpREIT
  if (f.upreit_721 && !/^no$/i.test(f.upreit_721) && !/^n\/a$/i.test(f.upreit_721)) {
    drivers.push({ type: 'positive', icon: '✅', text: '721 UpREIT available — offers potential REIT liquidity pathway' });
  }

  // Fill to at least 4
  while (drivers.length < 4 && drivers.length > 0) {
    drivers.push({ type: 'neutral', icon: 'ℹ️', text: 'Confirm additional underwriting details with sponsor directly.' });
    break;
  }

  if (!drivers.length) {
    return '<div class="od-panel od-body-full"><div class="od-panel-hdr"><div class="od-panel-title">Key Drivers</div></div><div class="od-panel-body"><div style="color:var(--slate2);font-size:12px">Populate offering data to see key driver analysis.</div></div></div>';
  }

  return '<div class="od-panel od-body-full"><div class="od-panel-hdr"><div class="od-panel-title">Key Drivers</div><div class="od-panel-hint">' + (isMulti ? 'Based on first offering' : 'Underwriting signals') + '</div></div><div class="od-panel-body"><div class="od-kd-grid">' +
    drivers.slice(0,6).map(d => '<div class="od-kd-item ' + d.type + '"><span class="od-kd-icon">' + d.icon + '</span><span>' + e(d.text) + '</span></div>').join('') +
    '</div></div></div>';
}

// ── Distribution Chart Panel ──
function renderODDistPanel(funds, e) {
  return '<div class="od-panel"><div class="od-panel-hdr"><div class="od-panel-title">Income Distribution</div><div class="od-panel-hint">Years 1–10</div></div><div class="od-panel-body"><div class="od-chart-box"><canvas id="od-income-chart"></canvas></div></div></div>';
}

// ── Projection Table Panel ──
function renderODProjPanel(funds, c, e, isMulti) {
  const equity = c && c.exchangeAmount ? c.exchangeAmount : null;
  const f0 = funds[0];
  const income = f0.metrics;
  const years = Array.from({length:7},(_,i)=>i+1);

  const blendedIncome = (yr) => {
    const key = 'income_y' + yr;
    const vals = funds.map(f=>f.metrics[key]).filter(BV.isNum);
    return vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : null;
  };

  return '<div class="od-panel od-body-full"><div class="od-panel-hdr"><div class="od-panel-title">Income Projection</div><div class="od-panel-hint">' + (equity ? 'Based on $' + (equity/1000).toFixed(0) + 'K equity' : 'Set client equity for dollar projections') + '</div></div><div class="od-panel-body"><div style="overflow-x:auto"><table class="od-proj-table"><thead><tr><th>Year</th><th>Cash-on-Cash %</th>' + (equity ? '<th>Est. Annual Income</th><th>Cumulative Income</th>' : '') + '</tr></thead><tbody>' +
    years.map((yr, i) => {
      const coc = blendedIncome(yr);
      const annualIncome = (equity && BV.isNum(coc)) ? equity * (coc/100) : null;
      const cumulative = equity ? years.slice(0,i+1).reduce((s,y)=>{ const c2=blendedIncome(y); return s+(BV.isNum(c2)?equity*(c2/100):0); }, 0) : null;
      const isHighlight = yr === 1 || yr === 5;
      return '<tr' + (isHighlight?' class="highlight-row"':'') + '><td>Year ' + yr + '</td><td>' + (BV.isNum(coc)?coc.toFixed(2)+'%':'—') + '</td>' +
        (equity ? '<td>' + (annualIncome!=null?'$'+Math.round(annualIncome).toLocaleString():'—') + '</td><td>' + (cumulative?'$'+Math.round(cumulative).toLocaleString():'—') + '</td>' : '') +
        '</tr>';
    }).join('') +
    '</tbody></table></div></div></div>';
}

// ── Sponsor Panel ──
function renderODSponsorPanel(funds, e, isMulti) {
  const renderSponsor = (f, showTitle) => {
    const pf = STATE.funds.find(x => x.id === f.id);
    if (!pf) return '';
    return (showTitle ? '<div style="font-size:11px;font-weight:700;color:var(--navy);margin-bottom:8px">' + e(f.sponsor) + '</div>' : '') +
      '<div class="od-sponsor-stat-row">' +
      stat(pf.sponsorAum ? '$' + pf.sponsorAum : '—', 'AUM') +
      stat(pf.sponsorOfferings || '—', 'Offerings') +
      stat(pf.sponsorExits || '—', 'Full Exits') +
      stat(BV.isNum(pf.sponsorAvgIrr) ? pf.sponsorAvgIrr.toFixed(1) + '%' : '—', 'Avg IRR') +
      '</div>' +
      (pf.sponsorExperience ? '<div style="padding:8px 12px;background:var(--surface);border-radius:var(--radius);font-size:12px;color:var(--slate);border:1px solid var(--mist)"><b>Experience:</b> ' + e(pf.sponsorExperience) + '</div>' : '');
  };
  const stat = (v, l) => '<div class="od-sponsor-stat"><div class="od-sponsor-stat-val">' + v + '</div><div class="od-sponsor-stat-label">' + l + '</div></div>';

  return '<div class="od-panel"><div class="od-panel-hdr"><div class="od-panel-title">Sponsor Track Record</div></div><div class="od-panel-body">' +
    (isMulti
      ? funds.map((f,i) => '<div style="' + (i>0?'margin-top:12px;padding-top:12px;border-top:1px solid var(--surface2)':'') + '">' + renderSponsor(f, true) + '</div>').join('')
      : renderSponsor(funds[0], false)) +
    '</div></div>';
}

// ── Key Metrics Comparison (multi mode top table) ──
function renderODKeyMetricsComp(funds, peer, e, TAG_COLORS, TAG_LABELS) {
  const rows = [
    { label:'Year 1 CoC', key:'year1_coc', fmt:v=>BV.fmtPct(v,2), higher:'higher' },
    { label:'LTV', key:'ltv', fmt:v=>BV.fmtPct(v,2), higher:'lower' },
    { label:'DSCR', key:'dscr', fmt:v=>BV.isNum(v)?v.toFixed(2)+'x':'—', higher:'higher' },
    { label:'Occupancy', key:'pct_leased', fmt:v=>BV.fmtPct(v,2), higher:'higher' },
    { label:'Hold Period', key:'hold_period_years', fmt:v=>BV.isNum(v)?v.toFixed(0)+' yr':'—', higher:'neutral' },
    { label:'Avg Lease Term', key:'avg_lease_term_remaining', fmt:v=>BV.isNum(v)?v.toFixed(1)+' yr':'—', higher:'higher' },
    { label:'Min Investment', key:'minimum_investment', fmt:v=>BV.fmtMoney(v), higher:'lower' },
    { label:'Cap Rate', key:'cap_rate', fmt:v=>BV.fmtPct(v,2), higher:'higher' },
  ];

  const colWidth = Math.floor(100 / (1 + funds.length));
  const colStyles = 'grid-template-columns:200px ' + funds.map(()=>colWidth+'px').join(' ');

  const header = '<div class="od-comp-row" style="' + colStyles + ';display:grid;background:var(--surface2);border-bottom:2px solid var(--mist)">' +
    '<div class="od-comp-cell field" style="font-size:10px;font-weight:700;color:var(--slate2);text-transform:uppercase;letter-spacing:.07em">Metric</div>' +
    funds.map((f,i) => '<div class="od-comp-cell" style="flex-direction:column;align-items:flex-start;padding:10px 14px"><div style="font-size:11px;font-weight:700;color:var(--navy)">' + TAG_LABELS[i] + ' ' + e(f.offering_name.length>18?f.offering_name.substring(0,16)+'…':f.offering_name) + '</div><div style="font-size:10px;color:var(--slate2)">' + e(f.sponsor) + '</div></div>').join('') +
    '</div>';

  const dataRows = rows.map(row => {
    const vals = funds.map(f => f.metrics[row.key]);
    const numVals = vals.filter(BV.isNum);
    const bestVal = numVals.length ? (row.higher === 'higher' ? Math.max(...numVals) : row.higher === 'lower' ? Math.min(...numVals) : null) : null;
    const worstVal = numVals.length >= 2 ? (row.higher === 'higher' ? Math.min(...numVals) : row.higher === 'lower' ? Math.max(...numVals) : null) : null;

    return '<div class="od-comp-row" style="' + colStyles + ';display:grid">' +
      '<div class="od-comp-cell field">' + e(row.label) + '</div>' +
      vals.map(v => {
        const isBest = BV.isNum(v) && v === bestVal && numVals.length >= 2;
        const isWorst = BV.isNum(v) && v === worstVal && numVals.length >= 2;
        return '<div class="od-comp-cell' + (isBest?' best':isWorst?' worst':'') + '"><span class="val">' + row.fmt(v) + '</span></div>';
      }).join('') +
      '</div>';
  }).join('');

  return '<div class="od-comp-wrap" style="margin-bottom:16px"><div style="padding:12px 16px;border-bottom:1.5px solid var(--mist);background:linear-gradient(180deg,var(--white),var(--surface));display:flex;align-items:center;justify-content:space-between"><span style="font-size:11px;font-weight:700;color:var(--slate);text-transform:uppercase;letter-spacing:.07em">Key Metrics Comparison</span><span style="font-size:10.5px;color:var(--fog)">Green = best · Red = lowest</span></div>' +
    header + dataRows + '</div>';
}



// ── Basket offering toggle (from dropdown) ──
function bvToggleOffering(id) {
  const idx = STATE.basket.indexOf(id);
  if (idx >= 0) {
    STATE.basket.splice(idx, 1);
  } else {
    if (STATE.basket.length >= 3) { toast('Maximum 3 offerings. Remove one first.', 'error'); return; }
    STATE.basket.push(id);
  }
  saveBasket();
  renderApp();
}

// ── Basket post-render hooks ──
function basketPostRender() {
  // Close dropdowns on click outside
  document.addEventListener('click', function bvDropClose(e) {
    document.querySelectorAll('.bv-dropdown.open, [id^="od-doc-drop-"]').forEach(dd => {
      const wrap = dd.closest('.bv-dropdown-wrap');
      if (wrap && !wrap.contains(e.target)) dd.classList.remove('open');
    });
  }, { once: false, capture: true });

  // Draw US map (new view uses id="od-map")
  odDrawMap();

  // Draw income chart (new view uses id="od-income-chart")
  odDrawIncomeChart();
}

let bvChartsPromise = null;
function loadGoogleCharts() {
  if (bvChartsPromise) return bvChartsPromise;
  bvChartsPromise = new Promise((resolve, reject) => {
    if (window.google && google.charts && google.visualization) { resolve(); return; }
    const s = document.createElement('script');
    s.src = 'https://www.gstatic.com/charts/loader.js';
    s.async = true;
    s.onload = () => { try { google.charts.load('current', { packages: ['geochart'] }); google.charts.setOnLoadCallback(resolve); } catch(e) { reject(e); } };
    s.onerror = () => reject(new Error('Failed to load Google Charts'));
    document.head.appendChild(s);
  });
  return bvChartsPromise;
}

// ── New offering detail view: color-coded map ──
function odDrawMap() {
  const el = document.getElementById('od-map');
  if (!el) return;
  const platformFunds = STATE.basket.map(id => STATE.funds.find(f => f.id === id)).filter(Boolean);
  if (!platformFunds.length) return;
  const isMulti = platformFunds.length > 1;
  const MAP_COLORS = ['#3B82F6','#9333EA','#D97706'];

  // Build per-offering state sets
  const offeringStateMap = platformFunds.map(f => ({
    color: MAP_COLORS[platformFunds.indexOf(f)] || '#3B82F6',
    states: BV.extractStates(f.location)
  }));

  // Flatten: state → offering index (first one wins for color in single-color mode)
  const stateToOffering = {};
  offeringStateMap.forEach((o, i) => {
    o.states.forEach(s => { if (!(s in stateToOffering)) stateToOffering[s] = i; });
  });
  const allStates = Object.keys(stateToOffering);

  if (!allStates.length) {
    el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:rgba(255,255,255,0.4);font-size:11px;font-weight:700">No states detected</div>';
    return;
  }

  loadGoogleCharts().then(() => {
    if (!isMulti) {
      // Single: uniform navy
      const dataRows = [['State','Presence']];
      allStates.forEach(s => dataRows.push(['US-'+s, 1]));
      const data = google.visualization.arrayToDataTable(dataRows);
      el.innerHTML = '';
      const chart = new google.visualization.GeoChart(el);
      chart.draw(data, { region:'US', resolution:'provinces', legend:'none', backgroundColor:{fill:'transparent'}, datalessRegionColor:'rgba(255,255,255,0.06)', colorAxis:{colors:['#3B82F6','#3B82F6']}, keepAspectRatio:true });
    } else {
      // Multi: color-coded by offering (1=blue, 2=purple, 3=gold)
      const dataRows = [['State','Offering','tooltip']];
      allStates.forEach(s => {
        const i = stateToOffering[s];
        dataRows.push(['US-'+s, i+1, offeringStateMap[i] ? platformFunds[i].name : '']);
      });
      const data = google.visualization.arrayToDataTable(dataRows);
      el.innerHTML = '';
      const chart = new google.visualization.GeoChart(el);
      // Use a continuous scale that maps 1→blue, 2→purple, 3→gold
      chart.draw(data, { region:'US', resolution:'provinces', legend:'none', backgroundColor:{fill:'transparent'}, datalessRegionColor:'rgba(255,255,255,0.06)', colorAxis:{minValue:1, maxValue:3, colors:['#3B82F6','#9333EA','#D97706']}, keepAspectRatio:true });
    }
  }).catch(() => {
    el.innerHTML = '<div style="padding:12px;text-align:center;color:rgba(255,255,255,0.4);font-size:11px">Map unavailable</div>';
  });
}

// ── New offering detail view: income chart ──
function odDrawIncomeChart() {
  const canvas = document.getElementById('od-income-chart');
  if (!canvas || !window.Chart) return;
  if (STATE.incomeChart) { STATE.incomeChart.destroy(); STATE.incomeChart = null; }

  const platformFunds = STATE.basket.map(id => STATE.funds.find(f => f.id === id)).filter(Boolean);
  const selectedFunds = platformFunds.map(BV.adaptFund).filter(Boolean);
  if (!selectedFunds.length) return;

  const isMulti = selectedFunds.length > 1;
  const labels = Array.from({length:10}, (_,i) => 'Y'+(i+1));
  const CHART_COLORS = ['#3B82F6','#9333EA','#D97706'];

  const datasets = isMulti
    ? selectedFunds.map((f,i) => ({
        label: f.offering_name,
        data: BV.INCOME_KEYS.map(k => BV.isNum(f.metrics[k]) ? f.metrics[k] : null),
        borderWidth: 2.5,
        borderRadius: 4,
        backgroundColor: CHART_COLORS[i] + '55',
        borderColor: CHART_COLORS[i],
        type: 'bar'
      }))
    : [{
        label: 'Client Income (%)',
        data: BV.INCOME_KEYS.map(k => BV.isNum(selectedFunds[0].metrics[k]) ? selectedFunds[0].metrics[k] : null),
        borderWidth: 0,
        borderRadius: 8,
        backgroundColor: 'rgba(59,130,246,0.70)',
        hoverBackgroundColor: 'rgba(59,130,246,0.9)'
      }];

  STATE.incomeChart = new Chart(canvas, {
    type: 'bar',
    data: { labels, datasets },
    options: {
      responsive: true, maintainAspectRatio: false, animation: false,
      plugins: {
        legend: { display: isMulti, position: 'top', labels: { font: { family: 'Inter', size: 10, weight: '700' }, boxWidth: 10, padding: 10 } },
        tooltip: { callbacks: { label: (ctx) => ctx.dataset.label + ': ' + (ctx.raw != null ? ctx.raw.toFixed(2) + '%' : '—') } }
      },
      scales: {
        x: { stacked: false, ticks: { color: 'rgba(9,14,25,0.70)', font: { family: 'Inter', weight: '700', size: 10 } }, grid: { color: 'rgba(15,23,42,0.08)' } },
        y: { beginAtZero: true, ticks: { color: 'rgba(9,14,25,0.70)', callback: v => v+'%', font: { family: 'Inter', weight: '700', size: 10 } }, grid: { color: 'rgba(15,23,42,0.08)' } }
      }
    }
  });
}

function basketDrawMap() {
  const el = document.getElementById('bv-map');
  if (!el) return;
  const platformFunds = STATE.basket.map(id => STATE.funds.find(f => f.id === id)).filter(Boolean);
  const states = BV.uniqSorted(platformFunds.flatMap(f => BV.extractStates(f.location)));
  if (!states.length) { el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:rgba(9,14,25,0.52);font-size:12px;font-weight:800">No states detected from Property Location(s)</div>'; return; }
  loadGoogleCharts().then(() => {
    const dataRows = [['State', 'Presence']];
    states.forEach(s => dataRows.push(['US-' + s, 1]));
    const data = google.visualization.arrayToDataTable(dataRows);
    el.innerHTML = '';
    const chart = new google.visualization.GeoChart(el);
    chart.draw(data, { region: 'US', resolution: 'provinces', legend: 'none', backgroundColor: { fill: 'transparent' }, datalessRegionColor: 'rgba(15,23,42,0.06)', defaultColor: 'rgba(15,23,42,0.06)', colorAxis: { colors: ['#0B1F3B', '#0B1F3B'] }, keepAspectRatio: true });
  }).catch(() => { el.innerHTML = '<div style="padding:20px;text-align:center;color:rgba(9,14,25,0.52);font-size:11px">Map unavailable</div>'; });
}

function basketDrawIncomeChart() {
  const canvas = document.getElementById('bv-income-chart');
  if (!canvas || !window.Chart) return;
  if (STATE.incomeChart) { STATE.incomeChart.destroy(); STATE.incomeChart = null; }

  const platformFunds = STATE.basket.map(id => STATE.funds.find(f => f.id === id)).filter(Boolean);
  const selectedFunds = platformFunds.map(BV.adaptFund).filter(Boolean);
  if (!selectedFunds.length) return;

  const agg = BV.aggregate(selectedFunds);
  const labels = Array.from({length:10}, (_,i) => 'Year '+(i+1));
  const vals = BV.INCOME_KEYS.map(k => agg.metrics?.[k] ?? null);

  STATE.incomeChart = new Chart(canvas, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Client Income (%)', data: vals.map(v => BV.isNum(v) ? v : null), borderWidth: 0, borderRadius: 8, backgroundColor: 'rgba(11,31,59,0.70)', hoverBackgroundColor: 'rgba(28,58,99,0.78)' }] },
    options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => { const v = vals[ctx.dataIndex]; return 'Income: ' + (BV.isNum(v) ? v.toFixed(2) + '%' : '—'); } } } }, scales: { x: { ticks: { color: 'rgba(9,14,25,0.70)', font: { family: 'Inter', weight: '700' } }, grid: { color: 'rgba(15,23,42,0.08)' } }, y: { beginAtZero: true, ticks: { color: 'rgba(9,14,25,0.70)', callback: (v) => v + '%', font: { family: 'Inter', weight: '700' } }, grid: { color: 'rgba(15,23,42,0.08)' } } } }
  });
}


/* ═══════════════════════════════════════════
   DST PORTFOLIO BUILDER — Full Module
═══════════════════════════════════════════ */
const PB = {};
PB.e = (s) => String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
PB.fmtM = (v) => { if (v == null || isNaN(v) || v === 0) return '$0'; if (v >= 1e6) return '$' + (v/1e6).toFixed(1) + 'M'; if (v >= 1e3) return '$' + (v/1e3).toFixed(0) + 'K'; return '$' + Math.round(v).toLocaleString(); };
PB.fmtMFull = (v) => (v != null && !isNaN(v)) ? '$' + Math.round(v).toLocaleString() : '$0';
PB.fmtP = (v) => (v != null && !isNaN(v)) ? v.toFixed(2) + '%' : '—';
PB.parseCurrency = (s) => { if (typeof s === 'number') return s; let str = String(s||'').replace(/[$,\s]/g, ''); let n = parseFloat(str); return isFinite(n) ? n : 0; };
PB.clamp01 = (x) => Math.max(0, Math.min(1, x));

// Compute portfolio metrics from allocations + fund data
PB.compute = () => {
  const p = activePB();
  const equity = STATE.client.exchangeAmount || 0;
  const debtTarget = STATE.client.debtReplacement || 0;
  const entries = Object.entries(p.allocations || {});
  const selected = entries.map(([fid, alloc]) => {
    const fund = STATE.funds.find(f => String(f.id) === String(fid));
    return { fid, alloc: Number(alloc || 0), fund };
  }).filter(x => x.fund);

  let invested = 0, totalPurchase = 0, totalLoan = 0, wYieldNum = 0, wYieldDen = 0, wLtvNum = 0, wLtvDen = 0;
  const sponsors = new Set(), assetClasses = new Set(), locations = new Set();

  for (const x of selected) {
    const E = x.alloc > 0 ? x.alloc : 0;
    if (E <= 0) continue;
    invested += E;
    const ltv = (x.fund.ltv || 0) / 100; // platform stores as pct number
    const purchase = ltv < 1 ? E / (1 - ltv) : 0;
    const loan = purchase - E;
    totalPurchase += purchase;
    totalLoan += loan;
    x._purchase = purchase;
    x._loan = loan;
    const y1 = x.fund.y1coc || 0;
    wYieldNum += E * y1;
    wYieldDen += E;
    if (ltv > 0) { wLtvNum += purchase * ltv; wLtvDen += purchase; }
    if (x.fund.sponsor) sponsors.add(x.fund.sponsor);
    if (x.fund.propType) assetClasses.add(x.fund.propType);
    if (x.fund.location) locations.add(x.fund.location);
  }
  const wYield = wYieldDen > 0 ? wYieldNum / wYieldDen : 0;
  const wLtv = wLtvDen > 0 ? (wLtvNum / wLtvDen) * 100 : 0;
  const estAnnualIncome = equity > 0 ? invested * (wYield / 100) : 0;
  const avgHold = selected.filter(x => x.alloc > 0 && x.fund.holdPeriod).length > 0
    ? selected.filter(x => x.alloc > 0).reduce((s, x) => s + (x.fund.holdPeriod || 7) * x.alloc, 0) / invested : 0;

  return { selected, invested, equity, debtTarget, totalPurchase, totalLoan, wYield, wLtv, estAnnualIncome, avgHold, sponsors, assetClasses, locations };
};

// Diversification checks
PB.diversificationChecks = (m) => {
  const checks = [];
  const count = m.selected.filter(x => x.alloc > 0).length;
  checks.push({ pass: count >= 3, warn: count === 2, label: `${count} offering${count !== 1 ? 's' : ''} selected`, sub: count >= 3 ? 'Good diversification' : count === 2 ? 'Consider adding a 3rd' : 'Add more offerings' });
  checks.push({ pass: m.sponsors.size >= 2, warn: m.sponsors.size === 1 && count > 1, label: `${m.sponsors.size} sponsor${m.sponsors.size !== 1 ? 's' : ''}`, sub: m.sponsors.size >= 2 ? 'Multi-sponsor portfolio' : 'Single sponsor concentration' });
  checks.push({ pass: m.assetClasses.size >= 2, warn: m.assetClasses.size === 1 && count > 1, label: `${m.assetClasses.size} asset class${m.assetClasses.size !== 1 ? 'es' : ''}`, sub: m.assetClasses.size >= 2 ? 'Diversified by property type' : 'Consider varying asset classes' });
  // Concentration check
  const maxPct = m.invested > 0 ? Math.max(...m.selected.map(x => x.alloc > 0 ? x.alloc / m.invested : 0)) : 0;
  checks.push({ pass: maxPct <= 0.40, warn: maxPct > 0.40 && maxPct <= 0.60, label: `Max concentration ${(maxPct * 100).toFixed(0)}%`, sub: maxPct <= 0.40 ? 'Well-balanced allocations' : maxPct <= 0.60 ? 'Moderate concentration' : 'High concentration risk' });
  // Equity progress
  const eqPct = m.equity > 0 ? m.invested / m.equity : 0;
  checks.push({ pass: eqPct >= 0.95 && eqPct <= 1.05, warn: eqPct < 0.95, label: m.equity > 0 ? `${(eqPct * 100).toFixed(0)}% equity deployed` : 'No equity target set', sub: eqPct >= 0.95 && eqPct <= 1.05 ? 'Fully allocated' : eqPct > 1.05 ? 'Over-allocated!' : 'Equity remaining' });
  // Debt replacement
  if (m.debtTarget > 0) {
    const debtPct = m.totalLoan / m.debtTarget;
    checks.push({ pass: debtPct >= 0.95, warn: debtPct >= 0.5, label: `Debt replacement ${(debtPct * 100).toFixed(0)}%`, sub: debtPct >= 0.95 ? 'Target met' : `${PB.fmtM(m.debtTarget - m.totalLoan)} remaining` });
  }
  return checks;
};

// Suitability score (reuse platform logic)
PB.suitScore = (fund) => {
  const c = STATE.client;
  if (!c.riskTolerance && !c.exchangeAmount) return null;
  let score = 50;
  if (c.riskTolerance === 'conservative' && fund.ltv && fund.ltv < 60) score += 15;
  if (c.riskTolerance === 'conservative' && fund.ltv && fund.ltv > 70) score -= 20;
  if (c.riskTolerance === 'aggressive' && fund.y1coc && fund.y1coc > 6) score += 10;
  if (c.exchangeAmount && fund.minInvest && fund.minInvest <= c.exchangeAmount) score += 10;
  if (c.exchangeAmount && fund.minInvest && fund.minInvest > c.exchangeAmount) score -= 30;
  if (c.objectives && c.objectives.includes('Income') && fund.y1coc && fund.y1coc > (STATE.peer.avgY1CoC || 5)) score += 10;
  return Math.max(0, Math.min(100, score));
};

// Filter marketplace funds
PB.filteredFunds = () => {
  const f = STATE.pbFilters;
  const q = (STATE.pbSearch || '').toLowerCase().trim();
  let funds = [...STATE.funds];
  if (f.propType !== 'all') funds = funds.filter(x => x.propType === f.propType);
  if (f.sponsor !== 'all') funds = funds.filter(x => x.sponsor === f.sponsor);
  if (f.sector !== 'all') funds = funds.filter(x => x.sector === f.sector);
  if (f.quickDst) funds = funds.filter(x => (x.propType||'').toLowerCase().includes('dst') || (x._raw && STATE.headers && (() => { const ci = STATE.headers.findIndex(h => h.trim() === 'Offering Structure'); return ci >= 0 && x._raw[ci] && String(x._raw[ci].v||x._raw[ci].f||'').toLowerCase().includes('dst'); })()));
  if (q) funds = funds.filter(x => `${x.sponsor} ${x.name} ${x.location} ${x.propType} ${x.sector}`.toLowerCase().includes(q));
  return funds;
};

// Add offering from detail view
function pbAddFromDetail(fundId) {
  const p = activePB();
  if (!p.allocations[String(fundId)]) {
    p.allocations[String(fundId)] = 0;
    savePB();
  }
  navigateTo('portfolio_builder');
  setTimeout(() => {
    const el = document.querySelector(`input[data-pb-alloc="${fundId}"]`);
    if (el) { el.scrollIntoView({behavior:'smooth',block:'center'}); el.focus(); el.select(); }
  }, 120);
}

// Toggle offering in portfolio
function pbToggle(fundId) {
  const p = activePB();
  const fid = String(fundId);
  if (p.allocations[fid] != null) {
    delete p.allocations[fid];
    toast('Removed from portfolio');
  } else {
    p.allocations[fid] = 0;
    toast('Added — enter allocation amount');
  }
  savePB();
  renderApp();
  if (p.allocations[fid] != null) {
    setTimeout(() => {
      const el = document.querySelector(`input[data-pb-alloc="${fid}"]`);
      if (el) { el.classList.add('needs-input'); el.scrollIntoView({behavior:'smooth',block:'center'}); el.focus(); el.select(); }
    }, 100);
  }
}

// Update allocation from table input
function pbUpdateAlloc(fundId) {
  const inp = document.querySelector(`input[data-pb-alloc="${fundId}"]`);
  if (!inp) return;
  const p = activePB();
  const fund = STATE.funds.find(f => String(f.id) === String(fundId));
  let val = PB.parseCurrency(inp.value);
  const min = fund ? (fund.minInvest || 0) : 0;
  if (val > 0 && min > 0 && val < min) { val = min; toast(`Minimum enforced: ${PB.fmtMFull(min)}`); }
  p.allocations[String(fundId)] = val;
  inp.value = val > 0 ? PB.fmtMFull(val) : '';
  if (val > 0) inp.classList.remove('needs-input');
  else inp.classList.add('needs-input');
  savePB();
  pbRefreshKPIs();
}

// Update inline allocation from marketplace card
function pbInlineAlloc(fundId) {
  const inp = document.querySelector(`input[data-pb-mkt-alloc="${fundId}"]`);
  if (!inp) return;
  const p = activePB();
  const fund = STATE.funds.find(f => String(f.id) === String(fundId));
  let val = PB.parseCurrency(inp.value);
  const min = fund ? (fund.minInvest || 0) : 0;
  if (val > 0 && min > 0 && val < min) { val = min; toast(`Minimum enforced: ${PB.fmtMFull(min)}`); }
  if (!p.allocations.hasOwnProperty(String(fundId))) p.allocations[String(fundId)] = 0;
  p.allocations[String(fundId)] = val;
  inp.value = val > 0 ? PB.fmtMFull(val) : '';
  savePB();
  renderApp();
}

// Remove offering
function pbRemove(fundId) {
  const p = activePB();
  delete p.allocations[String(fundId)];
  savePB();
  renderApp();
}

// Portfolio management
function pbNewPortfolio() {
  const name = prompt('Portfolio name?', 'New Portfolio');
  if (!name) return;
  const id = 'p_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,6);
  STATE.pb.portfolios.unshift({ id, name: name.trim() || 'New Portfolio', allocations: {} });
  STATE.pb.activeId = id;
  savePB(); renderApp();
}
function pbRenamePortfolio() {
  const p = activePB();
  const name = prompt('Rename portfolio:', p.name);
  if (!name) return;
  p.name = name.trim() || p.name;
  savePB(); renderApp();
}
function pbDeletePortfolio() {
  if (STATE.pb.portfolios.length <= 1) { toast('Keep at least one portfolio', 'error'); return; }
  const p = activePB();
  if (!confirm(`Delete "${p.name}"? This cannot be undone.`)) return;
  STATE.pb.portfolios = STATE.pb.portfolios.filter(x => x.id !== p.id);
  STATE.pb.activeId = STATE.pb.portfolios[0].id;
  savePB(); renderApp();
}
function pbSwitchPortfolio(id) {
  STATE.pb.activeId = id;
  savePB(); renderApp();
}

// Client equity/debt inputs from the portfolio builder panel
function pbUpdateEquity() {
  const inp = document.getElementById('pb-equity-input');
  if (!inp) return;
  const val = PB.parseCurrency(inp.value);
  STATE.client.exchangeAmount = val;
  saveClient();
  inp.value = val > 0 ? PB.fmtMFull(val) : '';
  pbRefreshKPIs();
  updateClientBadge();
}
function pbUpdateDebt() {
  const inp = document.getElementById('pb-debt-input');
  if (!inp) return;
  const val = PB.parseCurrency(inp.value);
  STATE.client.debtReplacement = val;
  saveClient();
  inp.value = val > 0 ? PB.fmtMFull(val) : '';
  pbRefreshKPIs();
}

// Refresh KPI section without full re-render (smooth updates)
function pbRefreshKPIs() {
  const m = PB.compute();
  const eqPct = m.equity > 0 ? PB.clamp01(m.invested / m.equity) : 0;
  const debtPct = m.debtTarget > 0 ? PB.clamp01(m.totalLoan / m.debtTarget) : 0;
  const isOver = m.equity > 0 && m.invested > m.equity;

  const el = (id) => document.getElementById(id);
  if (el('pb-kpi-invested')) el('pb-kpi-invested').textContent = PB.fmtMFull(m.invested);
  if (el('pb-equity-bar')) { el('pb-equity-bar').style.width = (eqPct * 100).toFixed(1) + '%'; el('pb-equity-bar').className = 'pb-progress-fill ' + (isOver ? 'over' : 'equity'); }
  if (el('pb-equity-sub')) el('pb-equity-sub').textContent = m.equity > 0 ? `${PB.fmtM(m.invested)} of ${PB.fmtM(m.equity)}${isOver ? ' — OVER-ALLOCATED' : ` — ${PB.fmtM(Math.max(0, m.equity - m.invested))} remaining`}` : 'Set exchange equity to track progress';
  if (el('pb-kpi-debt')) el('pb-kpi-debt').textContent = PB.fmtMFull(m.totalLoan);
  if (el('pb-debt-bar')) el('pb-debt-bar').style.width = (debtPct * 100).toFixed(1) + '%';
  if (el('pb-debt-sub')) el('pb-debt-sub').textContent = m.debtTarget > 0 ? `${PB.fmtM(m.totalLoan)} of ${PB.fmtM(m.debtTarget)} — ${PB.fmtM(Math.max(0, m.debtTarget - m.totalLoan))} remaining` : 'Optional — set a target to track';
  if (el('pb-kpi-yield')) el('pb-kpi-yield').textContent = m.wYield > 0 ? PB.fmtP(m.wYield) : '—';
  if (el('pb-kpi-ltv')) el('pb-kpi-ltv').textContent = m.wLtv > 0 ? PB.fmtP(m.wLtv) : '—';

  // Update pct column in table
  m.selected.forEach(x => {
    const pctEl = document.querySelector(`[data-pb-pct="${x.fid}"]`);
    if (pctEl && m.invested > 0 && x.alloc > 0) {
      const pct = (x.alloc / m.invested * 100);
      pctEl.innerHTML = `${pct.toFixed(1)}%<div class="pb-pct-bar"><div class="pb-pct-fill" style="width:${pct}%"></div></div>`;
    }
    const purchEl = document.querySelector(`[data-pb-purchase="${x.fid}"]`);
    const loanEl = document.querySelector(`[data-pb-loan="${x.fid}"]`);
    if (purchEl) purchEl.textContent = x._purchase ? PB.fmtM(x._purchase) : '—';
    if (loanEl) loanEl.textContent = x._loan ? PB.fmtM(x._loan) : '—';
  });
}

// ── Main Render ──
function renderPortfolioBuilder() {
  const p = activePB();
  const m = PB.compute();
  const mktFunds = PB.filteredFunds();
  const e = PB.e;
  const clientName = STATE.client.clientName || '';
  const sponsors = [...new Set(STATE.funds.map(f => f.sponsor).filter(Boolean))].sort();
  const propTypes = [...new Set(STATE.funds.map(f => f.propType).filter(Boolean))].sort();
  const sectors = [...new Set(STATE.funds.map(f => f.sector).filter(Boolean))].sort();
  const f = STATE.pbFilters;

  // ── Page Header ──
  const header = `<div class="page-header">
    <div><div class="page-title">DST Portfolio Builder</div>
    <div class="page-subtitle">${clientName ? e(clientName) + ' — ' : ''}${p.name} — ${m.selected.filter(x=>x.alloc>0).length} offering${m.selected.filter(x=>x.alloc>0).length!==1?'s':''}</div></div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <div class="pb-portfolio-tabs">
        ${STATE.pb.portfolios.map(pt => `<button class="pb-portfolio-tab ${pt.id===STATE.pb.activeId?'active':''}" onclick="pbSwitchPortfolio('${e(pt.id)}')">${e(pt.name)}</button>`).join('')}
        <button class="btn btn-sm btn-ghost" onclick="pbNewPortfolio()">+ New</button>
        <button class="btn btn-sm btn-ghost" onclick="pbRenamePortfolio()">Rename</button>
        ${STATE.pb.portfolios.length > 1 ? `<button class="btn btn-sm btn-ghost" onclick="pbDeletePortfolio()" style="color:var(--red)">Delete</button>` : ''}
      </div>
    </div>
  </div>`;

  // ── LEFT: Marketplace ──
  const marketplaceHtml = `<div class="pb-panel">
    <div class="pb-panel-hdr">
      <h3>Marketplace</h3>
      <span class="badge">${mktFunds.length} offerings</span>
    </div>
    <div class="pb-panel-body">
      <input class="pb-search-input" placeholder="Search sponsor, name, location..." value="${e(STATE.pbSearch)}" oninput="STATE.pbSearch=this.value;renderApp()">
      <div class="pb-filter-row">
        <select class="pb-filter-select" onchange="STATE.pbFilters.propType=this.value;renderApp()">
          <option value="all">All Types</option>
          ${propTypes.map(t => `<option value="${e(t)}" ${f.propType===t?'selected':''}>${e(t)}</option>`).join('')}
        </select>
        <select class="pb-filter-select" onchange="STATE.pbFilters.sponsor=this.value;renderApp()">
          <option value="all">All Sponsors</option>
          ${sponsors.map(s => `<option value="${e(s)}" ${f.sponsor===s?'selected':''}>${e(s)}</option>`).join('')}
        </select>
        <select class="pb-filter-select" onchange="STATE.pbFilters.sector=this.value;renderApp()">
          <option value="all">All Sectors</option>
          ${sectors.map(s => `<option value="${e(s)}" ${f.sector===s?'selected':''}>${e(s)}</option>`).join('')}
        </select>
        <label class="pb-quick-toggle ${f.quickDst?'active':''}">
          <input type="checkbox" ${f.quickDst?'checked':''} onchange="STATE.pbFilters.quickDst=this.checked;renderApp()">
          <span>DST Only</span>
        </label>
      </div>
      <div class="pb-mkt-list">
        ${mktFunds.length === 0 ? '<div class="pb-empty"><div class="pb-empty-icon">🔍</div><h4>No matches</h4><p>Adjust your filters to see offerings.</p></div>' :
          mktFunds.map(fund => {
            const fid = String(fund.id);
            const inPf = p.allocations.hasOwnProperty(fid);
            const allocAmt = inPf ? Number(p.allocations[fid] || 0) : 0;
            const suit = PB.suitScore(fund);
            const suitHtml = suit != null ? `<span class="pb-suitability ${suit >= 70 ? 'high' : suit >= 50 ? 'medium' : 'low'}">${suit >= 70 ? '★' : suit >= 50 ? '◆' : '○'} ${suit}</span>` : '';
            const isDst = (fund.propType||'').toLowerCase().includes('dst') || (fund._raw && STATE.headers && (() => { const ci = STATE.headers.findIndex(h => h.trim() === 'Offering Structure'); return ci >= 0 && fund._raw[ci] && String(fund._raw[ci].v||fund._raw[ci].f||'').toLowerCase().includes('dst'); })());
            return `<div class="pb-mkt-card ${inPf ? 'in-portfolio' : ''}">
              <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
                <div>
                  <div class="pb-mkt-card-name">${e(fund.name)}</div>
                  <div class="pb-mkt-card-sponsor">${e(fund.sponsor)}</div>
                </div>
                ${suitHtml}
              </div>
              <div class="pb-mkt-badges">
                ${fund.propType ? `<span class="pb-mkt-badge">${e(fund.propType)}</span>` : ''}
                ${isDst ? '<span class="pb-mkt-badge dst">DST</span>' : ''}
                ${fund.location ? `<span class="pb-mkt-badge">${e(fund.location)}</span>` : ''}
              </div>
              <div class="pb-mkt-metrics">
                <div class="m"><div class="l">Min</div><div class="v">${fund.minInvest ? PB.fmtM(fund.minInvest) : '—'}</div></div>
                <div class="m"><div class="l">LTV</div><div class="v">${fund.ltv ? PB.fmtP(fund.ltv) : '—'}</div></div>
                <div class="m"><div class="l">Y1 CoC</div><div class="v">${fund.y1coc ? PB.fmtP(fund.y1coc) : '—'}</div></div>
                <div class="m"><div class="l">Remaining</div><div class="v">${fund.equityRemaining ? PB.fmtM(fund.equityRemaining) : '—'}</div></div>
              </div>
              <div class="pb-mkt-card-actions">
                <button class="pb-mkt-add-btn ${inPf ? 'added' : ''}" onclick="pbToggle(${fund.id})">${inPf ? '✓ In Portfolio' : '+ Add'}</button>
                ${inPf ? `<div class="pb-mkt-alloc-inline">
                  <input data-pb-mkt-alloc="${fund.id}" placeholder="$0" value="${allocAmt > 0 ? PB.fmtMFull(allocAmt) : ''}"
                    onblur="pbInlineAlloc(${fund.id})" onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur()}">
                </div>` : ''}
              </div>
            </div>`;
          }).join('')
        }
      </div>
    </div>
  </div>`;

  // ── RIGHT: Portfolio Panel ──
  const eqPct = m.equity > 0 ? PB.clamp01(m.invested / m.equity) : 0;
  const debtPct = m.debtTarget > 0 ? PB.clamp01(m.totalLoan / m.debtTarget) : 0;
  const isOver = m.equity > 0 && m.invested > m.equity;

  // Portfolio table rows
  const allocEntries = Object.entries(p.allocations).map(([fid, alloc]) => {
    const fund = STATE.funds.find(f => String(f.id) === fid);
    return { fid, alloc: Number(alloc || 0), fund };
  }).filter(x => x.fund);

  let tableRows = '';
  if (allocEntries.length === 0) {
    tableRows = `<tr><td colspan="8" style="padding:20px;text-align:center;color:var(--slate2);font-size:12px">Add deals from the marketplace to begin building.</td></tr>`;
  } else {
    tableRows = allocEntries.map(x => {
      const f = x.fund;
      const ltv = (f.ltv || 0) / 100;
      const purchase = (x.alloc > 0 && ltv < 1) ? x.alloc / (1 - ltv) : 0;
      const loan = purchase > 0 ? purchase - x.alloc : 0;
      const pct = m.invested > 0 && x.alloc > 0 ? (x.alloc / m.invested * 100) : 0;
      return `<tr>
        <td><div class="deal-name" title="${e(f.sponsor+' — '+f.name)}">${e(f.name)}</div><div class="deal-sub">${e(f.sponsor)}</div></td>
        <td class="r">${f.minInvest ? PB.fmtM(f.minInvest) : '—'}</td>
        <td><input class="pb-alloc-input ${x.alloc <= 0 ? 'needs-input' : ''}" data-pb-alloc="${x.fid}" value="${x.alloc > 0 ? PB.fmtMFull(x.alloc) : ''}" placeholder="$0"
          onblur="pbUpdateAlloc('${x.fid}')" onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur()}"></td>
        <td class="r" data-pb-pct="${x.fid}">${pct > 0 ? pct.toFixed(1) + '%<div class=pb-pct-bar><div class=pb-pct-fill style=width:' + pct + '%></div></div>' : '—'}</td>
        <td class="r">${f.ltv ? PB.fmtP(f.ltv) : '—'}</td>
        <td class="r" data-pb-purchase="${x.fid}">${purchase ? PB.fmtM(purchase) : '—'}</td>
        <td class="r" data-pb-loan="${x.fid}">${loan ? PB.fmtM(loan) : '—'}</td>
        <td><button class="pb-remove-btn" onclick="pbRemove('${x.fid}')" title="Remove">✕</button></td>
      </tr>`;
    }).join('');
    // Totals row
    tableRows += `<tr class="pb-totals-row">
      <td style="font-weight:700;color:var(--navy)">TOTALS</td>
      <td></td>
      <td class="r" style="font-weight:800;color:var(--navy)">${PB.fmtMFull(m.invested)}</td>
      <td class="r">${m.invested > 0 ? '100%' : '—'}</td>
      <td class="r">${m.wLtv > 0 ? PB.fmtP(m.wLtv) : '—'}</td>
      <td class="r">${m.totalPurchase ? PB.fmtM(m.totalPurchase) : '—'}</td>
      <td class="r">${m.totalLoan ? PB.fmtM(m.totalLoan) : '—'}</td>
      <td></td>
    </tr>`;
  }

  const portfolioHtml = `<div class="pb-panel">
    <div class="pb-panel-hdr">
      <div>
        <h3>Your Portfolio — ${e(p.name)}</h3>
        <div style="font-size:11px;color:var(--slate2)">Allocations with minimum enforcement</div>
      </div>
    </div>
    <div class="pb-panel-body">
      <div class="pb-client-bar">
        <div class="pb-client-bar-title">${clientName ? e(clientName) : 'Client'} — Exchange Parameters</div>
        <div class="pb-client-bar-grid">
          <div class="pb-client-input-wrap">
            <label>Exchange Equity (required)</label>
            <input class="pb-client-input" id="pb-equity-input" value="${m.equity > 0 ? PB.fmtMFull(m.equity) : ''}" placeholder="$0" inputmode="decimal"
              onblur="pbUpdateEquity()" onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur()}">
            <div class="pb-client-hint">Total equity to allocate across offerings</div>
          </div>
          <div class="pb-client-input-wrap">
            <label>Debt Replacement (optional)</label>
            <input class="pb-client-input" id="pb-debt-input" value="${m.debtTarget > 0 ? PB.fmtMFull(m.debtTarget) : ''}" placeholder="$0" inputmode="decimal"
              onblur="pbUpdateDebt()" onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur()}">
            <div class="pb-client-hint">Target for boot analysis tracking</div>
          </div>
        </div>
      </div>

      <div class="pb-kpi-row">
        <div class="pb-kpi">
          <div class="pb-kpi-label">Invested Equity</div>
          <div class="pb-kpi-val" id="pb-kpi-invested">${PB.fmtMFull(m.invested)}</div>
          <div class="pb-progress"><div class="pb-progress-fill ${isOver ? 'over' : 'equity'}" id="pb-equity-bar" style="width:${(eqPct*100).toFixed(1)}%"></div></div>
          <div class="pb-kpi-sub" id="pb-equity-sub">${m.equity > 0 ? `${PB.fmtM(m.invested)} of ${PB.fmtM(m.equity)}${isOver ? ' — OVER-ALLOCATED' : ` — ${PB.fmtM(Math.max(0, m.equity - m.invested))} remaining`}` : 'Set exchange equity to track progress'}</div>
        </div>
        <div class="pb-kpi">
          <div class="pb-kpi-label">Debt Replacement</div>
          <div class="pb-kpi-val" id="pb-kpi-debt">${PB.fmtMFull(m.totalLoan)}</div>
          <div class="pb-progress"><div class="pb-progress-fill debt" id="pb-debt-bar" style="width:${(debtPct*100).toFixed(1)}%"></div></div>
          <div class="pb-kpi-sub" id="pb-debt-sub">${m.debtTarget > 0 ? `${PB.fmtM(m.totalLoan)} of ${PB.fmtM(m.debtTarget)} — ${PB.fmtM(Math.max(0, m.debtTarget - m.totalLoan))} remaining` : 'Optional — set a target to track'}</div>
        </div>
      </div>
      <div class="pb-kpi-row">
        <div class="pb-kpi">
          <div class="pb-kpi-label">Weighted Year-1 Cash Yield</div>
          <div class="pb-kpi-val" id="pb-kpi-yield">${m.wYield > 0 ? PB.fmtP(m.wYield) : '—'}</div>
        </div>
        <div class="pb-kpi">
          <div class="pb-kpi-label">Weighted Avg LTV</div>
          <div class="pb-kpi-val" id="pb-kpi-ltv">${m.wLtv > 0 ? PB.fmtP(m.wLtv) : '—'}</div>
        </div>
      </div>

      <div class="pb-table-wrap" style="max-height:380px;overflow:auto">
        <table class="pb-table">
          <thead><tr>
            <th style="min-width:140px">Deal</th>
            <th class="r">Min</th>
            <th>Alloc ($)</th>
            <th class="r">%</th>
            <th class="r">LTV</th>
            <th class="r">Purch. Exp.</th>
            <th class="r">Loan Exp.</th>
            <th></th>
          </tr></thead>
          <tbody>${tableRows}</tbody>
        </table>
      </div>
      <div style="margin-top:8px;font-size:10.5px;color:var(--fog)">Exposure math: <span style="font-family:var(--mono)">purchase = E/(1−LTV)</span>, <span style="font-family:var(--mono)">loan = purchase − E</span></div>
    </div>
  </div>`;

  // ── ANALYTICS SECTION (below the two-panel layout) ──
  const activeSelected = m.selected.filter(x => x.alloc > 0);
  let analyticsHtml = '';

  if (activeSelected.length > 0) {
    // Blended metrics tiles
    const blendedTiles = `<div class="pb-blended-grid">
      <div class="pb-blended-tile"><div class="label">Total Purchase Exposure</div><div class="val">${PB.fmtM(m.totalPurchase)}</div></div>
      <div class="pb-blended-tile"><div class="label">Total Loan Exposure</div><div class="val">${PB.fmtM(m.totalLoan)}</div></div>
      <div class="pb-blended-tile"><div class="label">Est. Annual Income</div><div class="val">${PB.fmtM(m.estAnnualIncome)}</div><div class="sub">Based on weighted Y1 CoC</div></div>
      <div class="pb-blended-tile"><div class="label">Wtd Avg Hold Period</div><div class="val">${m.avgHold > 0 ? m.avgHold.toFixed(1) + ' yrs' : '—'}</div></div>
      <div class="pb-blended-tile"><div class="label">Sponsors</div><div class="val">${m.sponsors.size}</div><div class="sub">${[...m.sponsors].slice(0,3).join(', ')}${m.sponsors.size > 3 ? '…' : ''}</div></div>
      <div class="pb-blended-tile"><div class="label">Asset Classes</div><div class="val">${m.assetClasses.size}</div><div class="sub">${[...m.assetClasses].slice(0,3).join(', ')}${m.assetClasses.size > 3 ? '…' : ''}</div></div>
      <div class="pb-blended-tile"><div class="label">Locations</div><div class="val">${m.locations.size}</div></div>
      <div class="pb-blended-tile"><div class="label">Offerings</div><div class="val">${activeSelected.length}</div></div>
    </div>`;

    // Charts (rendered in postRender)
    const chartsHtml = `<div class="pb-charts-row">
      <div class="pb-chart-card">
        <div class="pb-chart-card-title">Allocation by Offering</div>
        <div class="pb-chart-box"><canvas id="pb-chart-alloc"></canvas></div>
      </div>
      <div class="pb-chart-card">
        <div class="pb-chart-card-title">Allocation by Asset Class</div>
        <div class="pb-chart-box"><canvas id="pb-chart-asset"></canvas></div>
      </div>
    </div>`;

    // Diversification scorecard
    const checks = PB.diversificationChecks(m);
    const divHtml = `<div class="pb-analytics-title">Diversification Scorecard</div>
    <div class="pb-diversification">
      ${checks.map(c => `<div class="pb-div-item">
        <div class="pb-div-check ${c.pass ? 'pass' : c.warn ? 'warn' : 'fail'}">${c.pass ? '✓' : c.warn ? '!' : '✕'}</div>
        <div><div class="pb-div-text">${e(c.label)}</div><div class="pb-div-sub">${e(c.sub)}</div></div>
      </div>`).join('')}
    </div>`;

    // Income projections table (Years 1-5)
    let incomeTableHtml = '';
    const maxYrs = 5;
    const hasIncomeData = activeSelected.some(x => x.fund.income && x.fund.income.some(v => v != null));
    if (hasIncomeData && m.invested > 0) {
      const yearHeaders = Array.from({length: maxYrs}, (_, i) => `<th>Year ${i + 1}</th>`).join('');
      const offeringRows = activeSelected.map(x => {
        const inc = x.fund.income || [];
        return `<tr>
          <td>${e(x.fund.name)}</td>
          ${Array.from({length: maxYrs}, (_, i) => {
            const rate = inc[i] != null ? inc[i] : null;
            const dist = rate != null ? x.alloc * rate / 100 : null;
            return `<td>${dist != null ? PB.fmtM(dist) : '—'}</td>`;
          }).join('')}
        </tr>`;
      }).join('');
      // Blended totals row
      const totalRow = `<tr class="total-row">
        <td>Portfolio Total</td>
        ${Array.from({length: maxYrs}, (_, i) => {
          let total = 0; let hasData = false;
          activeSelected.forEach(x => {
            const rate = (x.fund.income || [])[i];
            if (rate != null) { total += x.alloc * rate / 100; hasData = true; }
          });
          return `<td>${hasData ? PB.fmtM(total) : '—'}</td>`;
        }).join('')}
      </tr>`;
      incomeTableHtml = `<div class="pb-analytics-title" style="margin-top:16px">Projected Income Distributions</div>
      <div class="pb-table-wrap">
        <table class="pb-income-table">
          <thead><tr><th style="text-align:left">Offering</th>${yearHeaders}</tr></thead>
          <tbody>${offeringRows}${totalRow}</tbody>
        </table>
      </div>
      <div style="font-size:10px;color:var(--fog);margin-top:4px">Based on CoC rates from offering data × allocation amounts. Not guaranteed.</div>`;
    }

    analyticsHtml = `<div class="pb-analytics">
      <div class="pb-analytics-title">Portfolio Analytics</div>
      ${blendedTiles}${chartsHtml}${divHtml}${incomeTableHtml}
    </div>`;
  }

  // ── Action buttons ──
  const actionsHtml = activeSelected.length > 0 ? `<div class="pb-actions-bar">
    <button class="btn btn-primary" onclick="navigateTo('model')">🧮 Model for Client</button>
    <button class="btn btn-secondary" onclick="navigateTo('basket')">🛒 View in Basket</button>
    <button class="btn btn-ghost" onclick="toast('PDF export coming soon')">📄 Export PDF</button>
  </div>` : '';

  // ── Disclaimer ──
  const disclaimerHtml = `<div class="pb-disclaimer"><strong>Disclaimer:</strong> For Broker Dealer and Investment Advisor home office due diligence use only. Always validate data with official offering documents and compliance requirements. Alts Fund LINK, LLC is not responsible for data errors or omissions. Data is for informational purposes only.</div>`;

  return `${header}
    <div class="pb-layout">${marketplaceHtml}${portfolioHtml}</div>
    ${analyticsHtml}${actionsHtml}${disclaimerHtml}`;
}

// ── Post-render: draw charts ──
function pbPostRender() {
  // Destroy old charts
  Object.values(STATE.pbCharts).forEach(c => { try { c.destroy(); } catch(e){} });
  STATE.pbCharts = {};

  const m = PB.compute();
  const active = m.selected.filter(x => x.alloc > 0);
  if (!active.length || !window.Chart) return;

  const palette = ['#0B1F3B','#1C3A63','#3B82F6','#6366F1','#7C3AED','#14B8A6','#0EA5E9','#F59E0B','#EC4899','#10B981'];

  // Allocation by Offering donut
  const allocCanvas = document.getElementById('pb-chart-alloc');
  if (allocCanvas) {
    STATE.pbCharts.alloc = new Chart(allocCanvas, {
      type: 'doughnut',
      data: {
        labels: active.map(x => x.fund.name.length > 20 ? x.fund.name.slice(0,20)+'…' : x.fund.name),
        datasets: [{ data: active.map(x => x.alloc), backgroundColor: active.map((_, i) => palette[i % palette.length]), borderWidth: 2, borderColor: '#fff' }]
      },
      options: { responsive: true, maintainAspectRatio: false, animation: { duration: 600 }, plugins: { legend: { position: 'right', labels: { boxWidth: 10, padding: 8, font: { size: 10, family: 'DM Sans', weight: '600' }, color: '#5C7A99' } } } }
    });
  }

  // Allocation by Asset Class donut
  const assetCanvas = document.getElementById('pb-chart-asset');
  if (assetCanvas) {
    const byAsset = {};
    active.forEach(x => { const cls = x.fund.propType || 'Other'; byAsset[cls] = (byAsset[cls] || 0) + x.alloc; });
    const assetEntries = Object.entries(byAsset).sort((a,b) => b[1] - a[1]);
    STATE.pbCharts.asset = new Chart(assetCanvas, {
      type: 'doughnut',
      data: {
        labels: assetEntries.map(e => e[0]),
        datasets: [{ data: assetEntries.map(e => e[1]), backgroundColor: assetEntries.map((_, i) => palette[(i + 3) % palette.length]), borderWidth: 2, borderColor: '#fff' }]
      },
      options: { responsive: true, maintainAspectRatio: false, animation: { duration: 600 }, plugins: { legend: { position: 'right', labels: { boxWidth: 10, padding: 8, font: { size: 10, family: 'DM Sans', weight: '600' }, color: '#5C7A99' } } } }
    });
  }
}


/* ═══════════════════════════════════════════
   EVENT HANDLERS & INIT
═══════════════════════════════════════════ */
function attachViewHandlers() {
  if (STATE.view === 'basket') {
    requestAnimationFrame(() => basketPostRender());
  } else if (STATE.view === 'model') {
    requestAnimationFrame(() => dstPostRender());
  } else if (STATE.view === 'portfolio_builder') {
    requestAnimationFrame(() => pbPostRender());
  } else {
    if (STATE.incomeChart) { STATE.incomeChart.destroy(); STATE.incomeChart = null; }
  }
}

/* ═══════════════════════════════════════════
   DST CALCULATOR — Model for Client
═══════════════════════════════════════════ */
const DST = {};
DST.n = (v) => (typeof v === 'number' && isFinite(v)) ? v : 0;
DST.fmtC = (v) => DST.n(v) ? v.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0}) : '$0';
DST.fmtC2 = (v) => DST.n(v) ? v.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2}) : '$0.00';
DST.fmtP = (v) => (v!=null&&isFinite(v)) ? (v*100).toFixed(2)+'%' : 'N/A';

DST.computeIRR = (flows) => {
  if(!flows.some(c=>c>0)||!flows.some(c=>c<0)) return null;
  const npv=(r)=>flows.reduce((s,c,t)=>s+c/Math.pow(1+r,t),0);
  let lo=-0.99,hi=1.0;
  if(npv(lo)*npv(hi)>0) return null;
  for(let i=0;i<100;i++){const mid=(lo+hi)/2;const v=npv(mid);if(Math.abs(v)<1e-6||(hi-lo)<1e-8) return mid;if(npv(lo)*v<0) hi=mid; else lo=mid;}
  return (lo+hi)/2;
};

DST.runModel = (inp) => {
  const equity=DST.n(inp.equity)||Math.max(0,DST.n(inp.purchasePrice)-DST.n(inp.loanAmount));
  const own=DST.n(inp.ownershipPct)||(equity>0&&DST.n(inp.purchasePrice)>0?equity/(DST.n(inp.purchasePrice)-DST.n(inp.loanAmount)):0.10);
  const hold=Math.max(1,Math.round(DST.n(inp.holdYears)||7));
  const grossIncome=DST.n(inp.grossIncome);
  const opExpPct=grossIncome>0?DST.n(inp.opExpenses)/grossIncome:0;
  const vacancy=DST.n(inp.vacancyRate);
  const debtSvc=DST.n(inp.debtService);
  const depBasis=DST.n(inp.depBasis);
  const depLife=DST.n(inp.depLife)||27.5;
  const taxRate=DST.n(inp.taxRate);
  const exitPrice=DST.n(inp.exitPrice)||DST.n(inp.purchasePrice)*1.15;
  const loanExit=DST.n(inp.loanExit)||DST.n(inp.loanAmount);
  const dstLoad=DST.n(inp.dstLoadPct);
  const annualFee=DST.n(inp.sponsorFeePct)+DST.n(inp.advisorFeePct);
  const annualDep=depLife>0?(depBasis/depLife)*own:0;
  const cfSeries=[];let totalCF=0;
  for(let t=1;t<=hold;t++){const gross=grossIncome;const vac=gross*vacancy;const opex=gross*opExpPct;const noi=gross-vac-opex;const cfProp=noi-debtSvc;const cfInv=cfProp*own;cfSeries.push(cfInv);totalCF+=cfInv;}
  const netSale=Math.max(0,exitPrice-loanExit);const exitEquity=netSale*own;
  const totalReturn=totalCF+exitEquity;const avgCF=hold>0?totalCF/hold:0;const coc=equity>0?avgCF/equity:0;
  const flows=[-equity,...cfSeries.map((c,i)=>i===hold-1?c+exitEquity:c)];const irr=DST.computeIRR(flows);
  const upfront=equity*dstLoad;
  const flowsFee=[-(equity+upfront),...cfSeries.map((c,i)=>{const drag=equity*annualFee;const net=c-drag;return i===hold-1?net+exitEquity:net;})];
  const irrNet=DST.computeIRR(flowsFee);
  const cfY1=cfSeries[0]||0;const taxableIncome=cfY1-annualDep;const afterTaxCF=cfY1-taxableIncome*taxRate;
  const noiCalc=grossIncome-grossIncome*vacancy-grossIncome*opExpPct;
  return{equity,own,hold,cfSeries,totalCF,exitEquity,totalReturn,coc,irr,irrNet,cfY1,annualDep,taxableIncome,afterTaxCF,noi:noiCalc,cfPropY1:noiCalc-debtSvc};
};

DST.stressTest = (inp) => {
  const base=DST.runModel(inp);
  const mild=DST.runModel({...inp,vacancyRate:(inp.vacancyRate||0)+0.05,opExpenses:(inp.opExpenses||0)*1.05,exitPrice:(inp.exitPrice||inp.purchasePrice*1.15)*0.95});
  const severe=DST.runModel({...inp,vacancyRate:(inp.vacancyRate||0)+0.10,opExpenses:(inp.opExpenses||0)*1.10,exitPrice:(inp.exitPrice||inp.purchasePrice*1.15)*0.90});
  return{base,mild,severe};
};

DST.bootAnalysis = (inp, model) => {
  const rs=DST.n(inp.relinqSalePrice);const rd=DST.n(inp.relinqDebt);const re=Math.max(0,rs-rd);
  const cds=DST.n(inp.loanAmount)*model.own;const rv=model.equity+cds;
  const mb=Math.max(0,rd-cds);const eb=Math.max(0,rs-rv);
  return{relinqEquity:re,replacementVal:rv,mortBoot:mb,eqBoot:eb,clean:mb===0&&eb===0&&rs>0,hasData:rs>0};
};

DST.fromFund = (f, client, overrides) => {
  const pp=f.purchasePrice||0;const ltv=(f.ltv||0)/100;const loan=pp>0?pp*ltv:0;
  const minInv=f.minInvest||0;const equity=(client&&client.exchangeAmount)?client.exchangeAmount:minInv;
  const ownPct=(pp-loan)>0?equity/(pp-loan):0.10;
  const grossEst=pp>0?pp*0.10:200000;const opExpEst=grossEst*0.30;
  const debtSvcEst=loan>0?loan*0.06:0;
  const hold=f.holdPeriod||7;
  const o=overrides||{};
  return{
    label:f.sponsor+' — '+f.name, fundId:f.id,
    purchasePrice:pp, loanAmount:loan, equity:equity, ownershipPct:ownPct,
    grossIncome:grossEst, opExpenses:opExpEst,
    vacancyRate:o.vacancyRate!=null?o.vacancyRate:0.05,
    debtService:debtSvcEst,
    holdYears:o.holdOverride||hold,
    exitPrice:o.exitAppr!=null?pp*(1+o.exitAppr):pp*1.15,
    loanExit:loan,
    depBasis:pp*0.75, depLife:o.depLife||27.5,
    taxRate:o.taxRate!=null?o.taxRate:0.32,
    dstLoadPct:o.dstLoadPct!=null?o.dstLoadPct:0.15,
    sponsorFeePct:o.sponsorFeePct!=null?o.sponsorFeePct:0.0075,
    advisorFeePct:o.advisorFeePct!=null?o.advisorFeePct:0.005,
    relinqSalePrice:o.relinqSalePrice||0, relinqDebt:o.relinqDebt||0,
    y1cocFromSheet:f.y1coc
  };
};

DST.blendInputs = (funds, client, overrides) => {
  const inputs=funds.map(f=>DST.fromFund(f,client,overrides));const n=inputs.length;
  if(n===1) return inputs[0];
  const avg=(fn)=>inputs.reduce((s,i)=>s+fn(i),0)/n;
  const sum=(fn)=>inputs.reduce((s,i)=>s+fn(i),0);
  const o=overrides||{};
  return{
    label:'Blended ('+n+' offerings)', fundId:null,
    purchasePrice:sum(i=>i.purchasePrice), loanAmount:sum(i=>i.loanAmount),
    equity:(client&&client.exchangeAmount)?client.exchangeAmount:sum(i=>i.equity),
    ownershipPct:avg(i=>i.ownershipPct),
    grossIncome:sum(i=>i.grossIncome), opExpenses:sum(i=>i.opExpenses),
    vacancyRate:o.vacancyRate!=null?o.vacancyRate:avg(i=>i.vacancyRate),
    debtService:sum(i=>i.debtService),
    holdYears:o.holdOverride||Math.round(avg(i=>i.holdYears)),
    exitPrice:o.exitAppr!=null?sum(i=>i.purchasePrice)*(1+o.exitAppr):sum(i=>i.exitPrice),
    loanExit:sum(i=>i.loanExit),
    depBasis:sum(i=>i.depBasis), depLife:o.depLife||27.5,
    taxRate:o.taxRate!=null?o.taxRate:0.32,
    dstLoadPct:o.dstLoadPct!=null?o.dstLoadPct:avg(i=>i.dstLoadPct),
    sponsorFeePct:o.sponsorFeePct!=null?o.sponsorFeePct:avg(i=>i.sponsorFeePct),
    advisorFeePct:o.advisorFeePct!=null?o.advisorFeePct:avg(i=>i.advisorFeePct),
    relinqSalePrice:o.relinqSalePrice||0, relinqDebt:o.relinqDebt||0,
    y1cocFromSheet:null
  };
};

DST.renderResults = (inp, label) => {
  const{base,mild,severe}=DST.stressTest(inp);
  const boot=DST.bootAnalysis(inp,base);
  const e=BV.escapeHTML;const sheetCoC=inp.y1cocFromSheet;
  return '<div class="dst-results-card"><div class="dst-results-label">'+e(label)+'</div>'
    +'<div class="dst-section-hdr">Projected Metrics (Client Share)</div>'
    +'<table class="dst-tbl"><tbody>'
    +'<tr><td>Equity Invested</td><td class="r">'+e(DST.fmtC(base.equity))+'</td></tr>'
    +'<tr><td>Year 1 NOI (Property)</td><td class="r">'+e(DST.fmtC(base.noi))+'</td></tr>'
    +'<tr><td>Year 1 Cash Flow (pre-tax, client)</td><td class="r b">'+e(DST.fmtC(base.cfY1))+'</td></tr>'
    +(sheetCoC!=null?'<tr><td>Y1 CoC from Offering Data</td><td class="r hint">'+e(fmtPct(sheetCoC))+'</td></tr>':'')
    +'<tr><td>Depreciation / yr (client)</td><td class="r">'+e(DST.fmtC2(base.annualDep))+'</td></tr>'
    +'<tr><td>Taxable Income / yr (approx.)</td><td class="r">'+e(DST.fmtC2(base.taxableIncome))+'</td></tr>'
    +'<tr><td>After-Tax Cash Flow / yr</td><td class="r">'+e(DST.fmtC2(base.afterTaxCF))+'</td></tr>'
    +'<tr><td>Total Cash Flow (over hold)</td><td class="r">'+e(DST.fmtC(base.totalCF))+'</td></tr>'
    +'<tr><td>Equity From Exit (client)</td><td class="r">'+e(DST.fmtC(base.exitEquity))+'</td></tr>'
    +'<tr><td>Total Return (CF + Exit)</td><td class="r b">'+e(DST.fmtC(base.totalReturn))+'</td></tr>'
    +'<tr><td>Cash-on-Cash (avg annual)</td><td class="r">'+e(DST.fmtP(base.coc))+'</td></tr>'
    +'<tr><td>IRR (before fee load)</td><td class="r">'+e(DST.fmtP(base.irr))+'</td></tr>'
    +'<tr><td>Net IRR (after DST & advisory fees)</td><td class="r">'+e(DST.fmtP(base.irrNet))+'</td></tr>'
    +'</tbody></table>'
    +'<div class="dst-section-hdr" style="margin-top:16px">Stress Test</div>'
    +'<table class="dst-stress"><thead><tr><th>Scenario</th><th>CF / yr</th><th>Total Return</th><th>IRR</th></tr></thead><tbody>'
    +'<tr><td>Base Case</td><td class="r">'+e(DST.fmtC(base.cfY1))+'</td><td class="r">'+e(DST.fmtC(base.totalReturn))+'</td><td class="r">'+e(DST.fmtP(base.irr))+'</td></tr>'
    +'<tr><td>Mild (+5% vac/exp, −5% exit)</td><td class="r">'+e(DST.fmtC(mild.cfY1))+'</td><td class="r">'+e(DST.fmtC(mild.totalReturn))+'</td><td class="r">'+e(DST.fmtP(mild.irr))+'</td></tr>'
    +'<tr><td>Severe (+10%, −10% exit)</td><td class="r">'+e(DST.fmtC(severe.cfY1))+'</td><td class="r">'+e(DST.fmtC(severe.totalReturn))+'</td><td class="r">'+e(DST.fmtP(severe.irr))+'</td></tr>'
    +'</tbody></table>'
    +'<div class="dst-section-hdr" style="margin-top:16px">Boot Analysis (1031)</div>'
    +'<table class="dst-tbl"><tbody>'
    +'<tr><td>Relinquished Equity</td><td class="r">'+e(DST.fmtC(boot.relinqEquity))+'</td></tr>'
    +'<tr><td>DST Replacement Value</td><td class="r">'+e(DST.fmtC(boot.replacementVal))+'</td></tr>'
    +'<tr><td>Potential Mortgage Boot</td><td class="r '+(boot.mortBoot>0?'warn':'')+'">'+e(DST.fmtC(boot.mortBoot))+'</td></tr>'
    +'<tr><td>Potential Equity Boot</td><td class="r '+(boot.eqBoot>0?'warn':'')+'">'+e(DST.fmtC(boot.eqBoot))+'</td></tr>'
    +'<tr><td>Status</td><td class="r"><span class="dst-badge '+(boot.hasData?(boot.clean?'safe':'danger'):'')+'">'+(boot.hasData?(boot.clean?'No boot indicated':'Potential boot — review with CPA'):'Enter relinquished property data')+'</span></td></tr>'
    +'</tbody></table>'
    +'<div class="dst-chart-area"><canvas id="dst-cf-chart-'+(inp.fundId||'blend')+'"></canvas></div>'
    +'</div>';
};

function renderModel() {
  const basketIds=STATE.basket;
  const funds=basketIds.map(id=>STATE.funds.find(f=>f.id===id)).filter(Boolean);
  const client=STATE.client;
  if(!funds.length) return '<div class="page-header"><div><div class="page-title">Model for Client</div><div class="page-subtitle">1031 DST Calculator</div></div></div><div class="empty-state"><div class="empty-state-icon">🧮</div><h3>No Offerings Selected</h3><p>Add offerings to your basket from Browse, then run the DST calculator to project cash flow, IRR, stress test, and boot analysis.</p><button class="btn btn-primary" onclick="navigateTo(\'browse\')">Browse Offerings</button></div>';
  const isMulti=funds.length>1;
  const overrides=STATE.dstOverrides||{};
  const perInputs=funds.map(f=>DST.fromFund(f,client,overrides));
  const blendedInput=DST.blendInputs(funds,client,overrides);
  const viewMode=STATE.dstCalcView||'blended';
  const inp=viewMode==='blended'||!isMulti?blendedInput:perInputs[0];

  const toggleHtml=isMulti?'<div class="dst-view-toggle"><button class="btn btn-sm '+(viewMode==='blended'?'btn-primary':'btn-secondary')+'" onclick="STATE.dstCalcView=\'blended\';renderApp()">Blended View</button><button class="btn btn-sm '+(viewMode==='per_offering'?'btn-primary':'btn-secondary')+'" onclick="STATE.dstCalcView=\'per_offering\';renderApp()">Per Offering</button></div>':'';

  const pills=funds.map(f=>'<span class="dst-offering-pill">'+BV.escapeHTML(f.sponsor+' — '+f.name)+'</span>').join('');

  const ltvPct=inp.purchasePrice>0?inp.loanAmount/inp.purchasePrice*100:0;
  const primaryHtml='<div class="dst-primary-inputs"><div class="dst-pi-grid">'
    +'<div class="dst-pi"><span class="dst-pi-label">Client Equity</span><span class="dst-pi-value">'+fmtMoney(inp.equity)+'</span></div>'
    +'<div class="dst-pi"><span class="dst-pi-label">Purchase Price</span><span class="dst-pi-value">'+fmtMoney(inp.purchasePrice)+'</span></div>'
    +'<div class="dst-pi"><span class="dst-pi-label">Loan Amount</span><span class="dst-pi-value">'+fmtMoney(inp.loanAmount)+'</span></div>'
    +'<div class="dst-pi"><span class="dst-pi-label">LTV</span><span class="dst-pi-value">'+fmtPct(ltvPct)+'</span></div>'
    +'<div class="dst-pi"><span class="dst-pi-label">Hold Period</span><span class="dst-pi-value">'+(inp.holdYears||7)+' yrs</span></div>'
    +'<div class="dst-pi"><span class="dst-pi-label">Ownership %</span><span class="dst-pi-value">'+((inp.ownershipPct||0.10)*100).toFixed(2)+'%</span></div>'
    +'</div></div>';

  const advVac=((overrides.vacancyRate!=null?overrides.vacancyRate:0.05)*100).toFixed(1);
  const advDep=overrides.depLife||27.5;
  const advTax=((overrides.taxRate!=null?overrides.taxRate:0.32)*100).toFixed(0);
  const advLoad=((overrides.dstLoadPct!=null?overrides.dstLoadPct:0.15)*100).toFixed(1);
  const advSpon=((overrides.sponsorFeePct!=null?overrides.sponsorFeePct:0.0075)*100).toFixed(2);
  const advAdv=((overrides.advisorFeePct!=null?overrides.advisorFeePct:0.005)*100).toFixed(2);
  const advExit=overrides.exitAppr!=null?(overrides.exitAppr*100).toFixed(0):'15';
  const advHold=overrides.holdOverride||inp.holdYears||7;
  const advRS=Math.round(overrides.relinqSalePrice||0);
  const advRD=Math.round(overrides.relinqDebt||0);

  const advancedHtml='<div class="dst-advanced-wrap"><button class="btn btn-ghost btn-sm" onclick="document.getElementById(\'dst-advanced\').classList.toggle(\'open\')">⚙ Advanced Assumptions</button>'
    +'<div class="dst-advanced" id="dst-advanced">'
    +'<div class="dst-adv-grid">'
    +'<div class="dst-adv-field"><label>Vacancy & Reserves %</label><input type="number" id="dst-vacancy" value="'+advVac+'" step="0.5"></div>'
    +'<div class="dst-adv-field"><label>Depreciation Life (yrs)</label><input type="number" id="dst-dep-life" value="'+advDep+'" step="0.5"></div>'
    +'<div class="dst-adv-field"><label>Client Tax Rate %</label><input type="number" id="dst-tax-rate" value="'+advTax+'" step="1"></div>'
    +'<div class="dst-adv-field"><label>DST Load on Equity %</label><input type="number" id="dst-load" value="'+advLoad+'" step="0.5"></div>'
    +'<div class="dst-adv-field"><label>Sponsor Fee % / yr</label><input type="number" id="dst-sponsor-fee" value="'+advSpon+'" step="0.05"></div>'
    +'<div class="dst-adv-field"><label>Advisor Fee % / yr</label><input type="number" id="dst-advisor-fee" value="'+advAdv+'" step="0.05"></div>'
    +'<div class="dst-adv-field"><label>Exit Appreciation %</label><input type="number" id="dst-exit-appr" value="'+advExit+'" step="1"></div>'
    +'<div class="dst-adv-field"><label>Holding Period Override</label><input type="number" id="dst-hold-override" value="'+advHold+'" step="1"></div>'
    +'</div>'
    +'<div class="dst-boot-inputs"><div class="dst-section-hdr" style="margin-top:12px">Relinquished Property (for Boot Analysis)</div>'
    +'<div class="dst-adv-grid">'
    +'<div class="dst-adv-field"><label>Relinquished Sale Price ($)</label><input type="number" id="dst-relinq-sale" value="'+advRS+'" step="1000"></div>'
    +'<div class="dst-adv-field"><label>Relinquished Loan Payoff ($)</label><input type="number" id="dst-relinq-debt" value="'+advRD+'" step="1000"></div>'
    +'</div></div>'
    +'<button class="btn btn-primary btn-sm" style="margin-top:12px" onclick="dstRecalc()">Recalculate</button>'
    +'</div></div>';

  let resultsHtml='';
  if(viewMode==='blended'||!isMulti){
    resultsHtml=DST.renderResults(blendedInput,isMulti?'Blended Portfolio ('+funds.length+' offerings)':perInputs[0].label);
  } else {
    resultsHtml='<div class="dst-per-offering-grid">'+perInputs.map(inp=>DST.renderResults(inp,inp.label)).join('')+'</div>';
  }

  const disclaimer='<div class="dst-disclaimer">This tool is for educational and illustrative purposes only and does not constitute tax, legal, or investment advice. Projections are hypothetical, not guaranteed, and do not reflect all risks, fees, or tax nuances. DSTs are illiquid and involve the risk of loss, including loss of principal. Clients should consult their own tax, legal, and investment professionals before making decisions.</div>';

  return '<div class="page-header"><div><div class="page-title">Model for Client</div><div class="page-subtitle">1031 DST Calculator — '+(isMulti?funds.length+' offerings':BV.escapeHTML(funds[0].sponsor+' — '+funds[0].name))+'</div></div>'+toggleHtml+'</div>'
    +'<div class="dst-offerings-bar">'+pills+'</div>'
    +primaryHtml+advancedHtml+resultsHtml+disclaimer;
}

function dstRecalc() {
  const gv=(id)=>{const el=document.getElementById(id);return el?parseFloat(el.value):null;};
  STATE.dstOverrides={
    vacancyRate:(gv('dst-vacancy')||5)/100, depLife:gv('dst-dep-life')||27.5,
    taxRate:(gv('dst-tax-rate')||32)/100, dstLoadPct:(gv('dst-load')||15)/100,
    sponsorFeePct:(gv('dst-sponsor-fee')||0.75)/100, advisorFeePct:(gv('dst-advisor-fee')||0.5)/100,
    exitAppr:(gv('dst-exit-appr')||15)/100, holdOverride:gv('dst-hold-override')||null,
    relinqSalePrice:gv('dst-relinq-sale')||0, relinqDebt:gv('dst-relinq-debt')||0
  };
  renderApp();toast('Recalculated with updated assumptions');
}

function dstPostRender() {
  const funds=STATE.basket.map(id=>STATE.funds.find(f=>f.id===id)).filter(Boolean);
  if(!funds.length) return;
  const client=STATE.client;const isMulti=funds.length>1;const viewMode=STATE.dstCalcView||'blended';
  const overrides=STATE.dstOverrides||{};
  const drawChart=(inp)=>{
    const cid='dst-cf-chart-'+(inp.fundId||'blend');const canvas=document.getElementById(cid);
    if(!canvas||!window.Chart) return;
    const model=DST.runModel(inp);
    const labels=Array.from({length:model.hold},(_,i)=>'Yr '+(i+1));
    new Chart(canvas,{type:'bar',data:{labels,datasets:[{label:'Annual CF (Client)',data:model.cfSeries,backgroundColor:'rgba(11,31,59,0.65)',borderRadius:6,borderWidth:0}]},
      options:{responsive:true,maintainAspectRatio:false,animation:false,plugins:{legend:{display:false}},scales:{x:{ticks:{font:{size:10}}},y:{beginAtZero:true,ticks:{font:{size:10},callback:(v)=>'$'+(v/1000).toFixed(0)+'K'}}}}});
  };
  if(viewMode==='blended'||!isMulti){drawChart(DST.blendInputs(funds,client,overrides));}
  else{funds.forEach(f=>drawChart(DST.fromFund(f,client,overrides)));}
}

// ── Client Profile Pill Click Handlers ──────────────────────────────────────

// Investment Objective: single-select (deselects others when one is chosen)
function cpObjectiveClick(el) {
  const isChecked = el.classList.contains('checked');
  // Deselect all
  document.querySelectorAll('#cp-objectives .checkbox-pill').forEach(p => p.classList.remove('checked'));
  // If it wasn't checked before, select it; if it was checked, clicking again deselects (toggle off)
  if (!isChecked) el.classList.add('checked');
}

// Property Type Preferences: multi-select (toggle each independently)
function cpPropTypeClick(el) {
  el.classList.toggle('checked');
}

// Logo upload handler
function cpHandleLogoUpload(input) {
  const file = input.files[0];
  if (!file) return;
  if (file.size > 500000) { toast('Logo must be under 500KB'); return; }
  const reader = new FileReader();
  reader.onload = (e) => {
    STATE._pendingLogo = e.target.result;
    const preview = document.getElementById('cp-logo-preview');
    if (preview) {
      preview.src = e.target.result;
      preview.tagName === 'IMG'
        ? (preview.src = e.target.result)
        : (() => {
            const img = document.createElement('img');
            img.id = 'cp-logo-preview';
            img.src = e.target.result;
            img.style.cssText = 'height:36px;max-width:140px;object-fit:contain;border:1px solid var(--mist);border-radius:6px;padding:4px;background:#fff';
            preview.replaceWith(img);
          })();
    }
  };
  reader.readAsDataURL(file);
}

function cpClearLogo() {
  STATE._pendingLogo = null;
  const preview = document.getElementById('cp-logo-preview');
  if (preview) {
    const placeholder = document.createElement('div');
    placeholder.id = 'cp-logo-preview';
    placeholder.style.cssText = 'height:36px;width:100px;border:1.5px dashed var(--mist);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--slate2)';
    placeholder.textContent = 'No logo';
    preview.replaceWith(placeholder);
  }
}

// ── Fixed Dashboard Match Scoring ───────────────────────────────────────────
// Overrides the inline suitScore calculation — called in renderDashboard via
// computeDashboardSuitScore(f, c) instead of the old inline block.
function computeDashboardSuitScore(f, c) {
  // Count how many meaningful profile fields are actually filled in
  const filledFields = [
    c.riskTolerance, c.exchangeAmount, c.age, c.horizon,
    c.objectives && c.objectives.length,
    c.propTypes && c.propTypes.length
  ].filter(Boolean).length;

  // If fewer than 2 real fields are set, don't show a score
  if (filledFields < 2) return null;

  let score = 50; // baseline
  let factors = 0;

  // Risk tolerance vs LTV
  if (c.riskTolerance && f.ltv != null) {
    factors++;
    if (c.riskTolerance === 'conservative') {
      if (f.ltv < 50) score += 18;
      else if (f.ltv < 60) score += 10;
      else if (f.ltv > 70) score -= 20;
    } else if (c.riskTolerance === 'moderate') {
      if (f.ltv >= 45 && f.ltv <= 65) score += 12;
      else if (f.ltv > 75) score -= 10;
    } else if (c.riskTolerance === 'growth') {
      if (f.y1coc && f.y1coc > 6) score += 15;
    }
  }

  // Exchange amount vs minimum investment
  if (c.exchangeAmount && f.minInvest != null) {
    factors++;
    if (f.minInvest > c.exchangeAmount) score -= 40; // can't afford it
    else if (f.minInvest <= c.exchangeAmount * 0.25) score += 15; // good diversification room
    else if (f.minInvest <= c.exchangeAmount * 0.5) score += 8;
  }

  // Property type match
  if (c.propTypes && c.propTypes.length && f.propType) {
    factors++;
    const propMatch = c.propTypes.some(p => f.propType.toLowerCase().includes(p.toLowerCase()));
    if (propMatch) score += 18;
    else score -= 8;
  }

  // Investment objective match
  if (c.objectives && c.objectives.length) {
    factors++;
    const obj = c.objectives[0];
    if (obj === 'Income' && f.y1coc && f.y1coc > (STATE.peer.avgY1CoC || 5)) score += 12;
    if (obj === 'Preservation' && f.ltv && f.ltv < 55) score += 12;
    if (obj === 'Growth' && f.y1coc && f.y1coc > 6) score += 12;
    if (obj === 'Tax Deferral') score += 8; // DSTs inherently support this
  }

  // Horizon vs hold period
  if (c.horizon && f.holdPeriod) {
    factors++;
    const horizonYrs = c.horizon === 'short' ? 4 : c.horizon === 'medium' ? 7 : 12;
    const diff = Math.abs(f.holdPeriod - horizonYrs);
    if (diff <= 1) score += 12;
    else if (diff <= 3) score += 5;
    else score -= 8;
  }

  // Age + hold period (avoid funds that run past age 85)
  if (c.age && f.holdPeriod) {
    factors++;
    if ((c.age + f.holdPeriod) > 85) score -= 15;
    else score += 5;
  }

  // If we had very few scoring factors, compress toward middle (less confident)
  if (factors < 2) score = 50 + (score - 50) * 0.4;

  return Math.max(5, Math.min(98, Math.round(score)));
}

// ── Boot ──
updateClientBadge();
fetchSheetData();
</script>
</body>
</html>
