<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Alts Fund Link — Platform</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=DM+Mono:wght@400;500&family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --navy:#0B1F3B;--navy2:#1C3A63;--navy3:#2A4D7A;--slate:#3A5270;--slate2:#5C7A99;
  --fog:#8FA3BA;--mist:#C8D8E8;--ice:#E8F0F8;--white:#FFFFFF;--surface:#F4F7FB;--surface2:#EEF3FA;
  --green:#1A7A4A;--green-lt:#E8F7EF;--amber:#B45309;--amber-lt:#FEF3C7;
  --red:#991B1B;--red-lt:#FEE2E2;--blue:#1D4ED8;--blue-lt:#EFF6FF;
  --comp-accent:#7C3AED;--comp-lt:#F5F3FF;--report-accent:#0D7490;--report-lt:#ECFEFF;
  --radius:8px;--radius-lg:14px;--radius-xl:20px;
  --shadow-sm:0 1px 3px rgba(11,31,59,0.08),0 1px 2px rgba(11,31,59,0.06);
  --shadow:0 4px 12px rgba(11,31,59,0.10),0 2px 4px rgba(11,31,59,0.06);
  --shadow-lg:0 12px 32px rgba(11,31,59,0.14),0 4px 8px rgba(11,31,59,0.08);
  --shadow-xl:0 24px 64px rgba(11,31,59,0.18);
  --font:'DM Sans',sans-serif;--mono:'DM Mono',monospace;
  --header-h:60px;--nav-w:220px;--transition:0.18s cubic-bezier(0.4,0,0.2,1);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{font-family:var(--font);font-size:14px;line-height:1.5;background:var(--surface);color:var(--navy);-webkit-font-smoothing:antialiased}
a{color:inherit;text-decoration:none}button{cursor:pointer;font-family:var(--font)}input,select,textarea{font-family:var(--font)}
#app{display:flex;flex-direction:column;height:100vh;overflow:hidden}
#header{height:var(--header-h);background:var(--navy);display:flex;align-items:center;padding:0 20px;gap:16px;flex-shrink:0;position:relative;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,0.25)}
#logo{display:flex;align-items:center;gap:10px;flex-shrink:0}
#logo-mark{width:32px;height:32px;background:linear-gradient(135deg,#3B82F6,#1D4ED8);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:#fff;letter-spacing:-0.5px}
#logo-text{font-size:14px;font-weight:600;color:#fff;letter-spacing:0.02em;line-height:1.2}
#logo-sub{font-size:10px;color:var(--fog);font-weight:400;letter-spacing:0.08em;text-transform:uppercase}
#view-toggle{display:flex;align-items:center;background:rgba(255,255,255,0.08);border-radius:8px;padding:3px;gap:2px;margin-left:12px}
.view-btn{display:flex;align-items:center;gap:6px;padding:5px 12px;border-radius:6px;border:none;background:transparent;color:var(--fog);font-size:12.5px;font-weight:500;letter-spacing:0.01em;transition:all var(--transition);white-space:nowrap}
.view-btn:hover{color:var(--white);background:rgba(255,255,255,0.10)}
.view-btn.active{background:var(--white);color:var(--navy);font-weight:600}
.view-btn.active.compliance{background:#DDD6FE;color:#4C1D95}
.view-btn.active.client-report{background:#CFFAFE;color:#164E63}
.view-dot{width:6px;height:6px;border-radius:50%;background:currentColor;opacity:0.5}
.view-btn.active .view-dot{opacity:1}
#client-badge{margin-left:auto;display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:5px 12px;cursor:pointer;transition:background var(--transition);flex-shrink:0}
#client-badge:hover{background:rgba(255,255,255,0.14)}
#client-badge-icon{width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,var(--navy3),var(--blue));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff}
#client-badge-text{font-size:12px;color:var(--white);font-weight:500}
#client-badge-text small{display:block;font-size:10px;color:var(--fog);font-weight:400}
#data-status{font-size:11px;color:var(--fog);display:flex;align-items:center;gap:6px;flex-shrink:0}
.pulse-dot{width:6px;height:6px;border-radius:50%;background:#34D399;animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.4;transform:scale(0.8)}}
.pulse-dot.loading{background:#F59E0B;animation:spin-dot 0.8s linear infinite}
.pulse-dot.error{background:#F87171;animation:none}
@keyframes spin-dot{0%{transform:scale(0.6);opacity:0.5}50%{transform:scale(1);opacity:1}100%{transform:scale(0.6);opacity:0.5}}
#body-area{display:flex;flex:1;overflow:hidden}
#sidebar{width:var(--nav-w);background:var(--white);border-right:1px solid var(--mist);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0;transition:background var(--transition)}
#sidebar.compliance-mode{background:#FDFBFF;border-right-color:#DDD6FE}
#sidebar.report-mode{background:#FDFFFE;border-right-color:#A5F3FC}
.nav-section{padding:8px 0;border-bottom:1px solid var(--surface2)}
.nav-section:last-child{border-bottom:none;flex:1}
.nav-label{font-size:10px;font-weight:600;letter-spacing:0.1em;text-transform:uppercase;color:var(--fog);padding:8px 16px 4px}
.nav-item{display:flex;align-items:center;gap:9px;padding:8px 16px;font-size:13px;font-weight:500;color:var(--slate);cursor:pointer;border-radius:0;border:none;background:transparent;width:100%;text-align:left;transition:all var(--transition);position:relative}
.nav-item:hover{background:var(--surface);color:var(--navy)}
.nav-item.active{background:var(--ice);color:var(--navy);font-weight:600}
.nav-item.active::before{content:'';position:absolute;left:0;top:4px;bottom:4px;width:3px;background:var(--navy2);border-radius:0 2px 2px 0}
#sidebar.compliance-mode .nav-item.active{background:var(--comp-lt);color:#4C1D95}
#sidebar.compliance-mode .nav-item.active::before{background:var(--comp-accent)}
#sidebar.report-mode .nav-item.active{background:var(--report-lt);color:var(--report-accent)}
#sidebar.report-mode .nav-item.active::before{background:var(--report-accent)}
.nav-icon{font-size:14px;width:18px;text-align:center;flex-shrink:0}
.nav-badge{margin-left:auto;min-width:18px;height:18px;background:var(--navy2);color:#fff;border-radius:9px;font-size:10px;font-weight:700;display:inline-flex;align-items:center;justify-content:center;padding:0 5px}
#main{flex:1;overflow-y:auto;padding:28px 32px}
.page-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:24px;gap:16px}
.page-title{font-size:22px;font-weight:700;color:var(--navy);letter-spacing:-0.02em;line-height:1.2}
.page-subtitle{font-size:13px;color:var(--slate2);margin-top:3px}
.panel{background:var(--white);border:1px solid var(--mist);border-radius:var(--radius-lg);padding:20px 24px;box-shadow:var(--shadow-sm)}
.panel-title{font-size:13px;font-weight:700;letter-spacing:0.04em;text-transform:uppercase;color:var(--slate);margin-bottom:14px;display:flex;align-items:center;gap:8px}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:var(--radius);border:none;font-size:13px;font-weight:600;cursor:pointer;transition:all var(--transition);white-space:nowrap}
.btn-primary{background:var(--navy);color:var(--white)}.btn-primary:hover{background:var(--navy2)}
.btn-secondary{background:var(--white);color:var(--navy);border:1.5px solid var(--mist)}.btn-secondary:hover{border-color:var(--slate2);background:var(--surface)}
.btn-ghost{background:transparent;color:var(--slate2);border:1.5px solid transparent}.btn-ghost:hover{color:var(--navy);background:var(--surface)}
.btn-sm{padding:5px 10px;font-size:12px}
.btn-icon{padding:7px;border-radius:var(--radius);background:var(--surface);border:1px solid var(--mist);color:var(--slate);display:inline-flex;align-items:center;justify-content:center;font-size:14px;cursor:pointer;transition:all var(--transition)}
.btn-icon:hover{background:var(--ice);color:var(--navy);border-color:var(--slate2)}
.btn-icon.active{background:var(--navy);color:var(--white);border-color:var(--navy)}
.badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:20px;font-size:11px;font-weight:600;letter-spacing:0.02em}
.badge-green{background:var(--green-lt);color:var(--green)}.badge-amber{background:var(--amber-lt);color:var(--amber)}
.badge-red{background:var(--red-lt);color:var(--red)}.badge-blue{background:var(--blue-lt);color:var(--blue)}
.badge-navy{background:var(--ice);color:var(--navy2)}.badge-purple{background:#EDE9FE;color:#5B21B6}
.suit-score{display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:700;padding:3px 8px;border-radius:20px}
.suit-score.high{background:var(--green-lt);color:var(--green)}.suit-score.medium{background:var(--amber-lt);color:var(--amber)}.suit-score.low{background:var(--red-lt);color:var(--red)}
.metric-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
.metric-tile{background:var(--surface);border:1px solid var(--mist);border-radius:var(--radius);padding:14px 16px}
.metric-label{font-size:11px;font-weight:600;color:var(--fog);text-transform:uppercase;letter-spacing:0.07em;margin-bottom:4px}
.metric-value{font-size:22px;font-weight:700;color:var(--navy);letter-spacing:-0.02em;line-height:1}
.metric-sub{font-size:11px;color:var(--slate2);margin-top:3px}
.pill{display:inline-flex;align-items:center;padding:3px 8px;border-radius:20px;font-size:11.5px;font-weight:500;background:var(--surface2);color:var(--slate);border:1px solid var(--mist)}
.divider{height:1px;background:var(--mist);margin:16px 0}
.empty-state{text-align:center;padding:48px 24px;color:var(--slate2)}
.empty-state-icon{font-size:40px;margin-bottom:12px}
.empty-state h3{font-size:16px;font-weight:600;color:var(--navy);margin-bottom:6px}
.empty-state p{font-size:13px;line-height:1.6;max-width:360px;margin:0 auto 20px}
.offering-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:16px}
.offering-card{background:var(--white);border:1.5px solid var(--mist);border-radius:var(--radius-lg);padding:18px;cursor:pointer;transition:all var(--transition);position:relative;overflow:hidden}
.offering-card:hover{border-color:var(--slate2);box-shadow:var(--shadow);transform:translateY(-1px)}
.offering-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;gap:8px}
.offering-name{font-size:14px;font-weight:700;color:var(--navy);line-height:1.3;flex:1}
.offering-sponsor{font-size:11.5px;color:var(--slate2);margin-top:2px}
.offering-badges{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:12px}
.offering-metrics{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.offering-metric-item{background:var(--surface);border-radius:var(--radius);padding:8px 10px}
.offering-metric-item .label{font-size:10px;font-weight:600;color:var(--fog);text-transform:uppercase;letter-spacing:0.07em}
.offering-metric-item .value{font-size:16px;font-weight:700;color:var(--navy);letter-spacing:-0.02em}
.offering-location{font-size:12px;color:var(--slate2);display:flex;align-items:center;gap:4px;margin-bottom:10px}
.offering-card-footer{display:flex;justify-content:space-between;align-items:center;padding-top:10px;border-top:1px solid var(--surface2)}
.raise-bar{height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;margin-top:3px}
.raise-fill{height:100%;background:linear-gradient(90deg,var(--navy2),#3B82F6);border-radius:4px;animation:barFillIn 1.2s cubic-bezier(0.4,0,0.2,1) forwards}
.timeline-bar{height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;margin-top:3px}
.timeline-fill{height:100%;background:linear-gradient(90deg,#059669,#34D399);border-radius:4px;animation:barFillIn 1.2s cubic-bezier(0.4,0,0.2,1) 0.3s forwards}
@keyframes barFillIn{from{max-width:0}to{max-width:100%}}
.peer-delta{font-size:10px;font-weight:600;margin-top:2px}.peer-delta.up{color:var(--green)}.peer-delta.down{color:var(--red)}.peer-delta.neutral{color:var(--fog)}
.card-status-strip{position:absolute;top:0;left:0;right:0;height:5px}
.card-status-strip.open{background:var(--green)}.card-status-strip.closing{background:var(--amber)}.card-status-strip.coming{background:var(--blue)}
.offering-table{width:100%;border-collapse:collapse;font-size:13px}
.offering-table thead th{background:var(--surface2);padding:9px 12px;text-align:left;font-size:11px;font-weight:700;color:var(--slate2);text-transform:uppercase;letter-spacing:0.07em;border-bottom:1px solid var(--mist);white-space:nowrap;cursor:pointer;user-select:none;position:sticky;top:0;z-index:10}
.offering-table thead th:hover{color:var(--navy);background:var(--ice)}
.offering-table thead th.sorted{color:var(--navy)}.offering-table thead th.sorted .sort-arrow{opacity:1}
.sort-arrow{margin-left:4px;opacity:0.3;font-size:10px}
.offering-table tbody tr{border-bottom:1px solid var(--surface2);cursor:pointer;transition:background var(--transition)}
.offering-table tbody tr:hover{background:var(--surface)}.offering-table tbody tr:last-child{border-bottom:none}
.offering-table td{padding:10px 12px;vertical-align:middle}
.offering-table td.name-cell{font-weight:600;color:var(--navy)}
.offering-table td.num-cell{font-weight:600;font-family:var(--mono);font-size:12.5px}
.offering-table td.num-cell.highlight-green{color:var(--green)}.offering-table td.num-cell.highlight-red{color:var(--red)}
.table-wrapper{border:1px solid var(--mist);border-radius:var(--radius-lg);overflow:hidden;background:var(--white)}
.filter-bar{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.quick-filter-bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.quick-filter-label{font-size:11px;font-weight:700;color:var(--slate2);text-transform:uppercase;letter-spacing:.5px}
.quick-filter-btn{padding:6px 14px;border-radius:999px;border:1px solid var(--mist);background:var(--white);font-size:12px;font-weight:600;color:var(--navy);cursor:pointer;transition:all var(--transition);user-select:none}
.quick-filter-btn:hover{border-color:var(--navy3);background:var(--ice)}
.quick-filter-btn.active{background:var(--navy);color:var(--white);border-color:var(--navy);box-shadow:0 4px 12px rgba(11,31,59,0.2)}
.filter-row-2{display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.filter-tag{display:flex;align-items:center;gap:5px;padding:5px 12px;border:1.5px solid var(--mist);border-radius:20px;font-size:12.5px;font-weight:500;color:var(--slate);cursor:pointer;background:var(--white);transition:all var(--transition);user-select:none}
.filter-tag:hover{border-color:var(--slate2);color:var(--navy)}.filter-tag.active{border-color:var(--navy);background:var(--navy);color:var(--white)}
.filter-select{height:34px;padding:0 28px 0 10px;border:1.5px solid var(--mist);border-radius:20px;font-size:12.5px;color:var(--slate);background:var(--white);cursor:pointer;outline:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%235C7A99' d='M5 7L1 2h8z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;transition:border-color var(--transition)}
.filter-select:focus{border-color:var(--navy2)}
.search-input{flex:1;max-width:260px;height:34px;padding:0 12px 0 34px;border:1.5px solid var(--mist);border-radius:20px;font-size:13px;color:var(--navy);background:var(--white);outline:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%235C7A99' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:11px center;transition:border-color var(--transition)}
.search-input:focus{border-color:var(--navy2)}.search-input::placeholder{color:var(--fog)}
.view-toggle-group{display:flex;border:1.5px solid var(--mist);border-radius:8px;overflow:hidden}
.view-toggle-btn{padding:5px 10px;border:none;background:var(--white);color:var(--slate2);font-size:13px;cursor:pointer;transition:all var(--transition)}
.view-toggle-btn:hover{background:var(--surface);color:var(--navy)}.view-toggle-btn.active{background:var(--navy);color:var(--white)}
.sort-select{height:34px;padding:0 28px 0 10px;border:1.5px solid var(--mist);border-radius:8px;font-size:12.5px;color:var(--slate);background:var(--white);cursor:pointer;outline:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 10 10'%3E%3Cpath fill='%235C7A99' d='M5 7L1 2h8z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;transition:border-color var(--transition)}
.sort-select:focus{border-color:var(--navy2)}
.result-bar{display:flex;align-items:center;gap:10px;margin-bottom:16px;font-size:12.5px;color:var(--slate2)}
.result-count{font-weight:700;color:var(--navy)}
.active-filter-chips{display:flex;gap:5px;flex-wrap:wrap}
.filter-chip{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;background:var(--ice);color:var(--navy2);border-radius:20px;font-size:11px;font-weight:600;border:1px solid var(--mist)}
.filter-chip button{background:none;border:none;color:var(--slate2);font-size:11px;padding:0;line-height:1;cursor:pointer;display:flex;align-items:center}
.filter-chip button:hover{color:var(--red)}
.range-filter{display:flex;align-items:center;gap:6px;height:34px;padding:0 12px;border:1.5px solid var(--mist);border-radius:20px;background:var(--white);font-size:12.5px;color:var(--slate)}
.range-filter input{width:44px;border:none;outline:none;font-size:12.5px;color:var(--navy);font-family:var(--mono);background:transparent;text-align:center;padding:0}
.range-filter span{color:var(--fog);font-size:11px}
.equity-filter{display:flex;align-items:center;gap:5px;height:34px;padding:0 12px;border:1.5px solid var(--mist);border-radius:20px;background:var(--white);font-size:12.5px;color:var(--slate);cursor:pointer;transition:all var(--transition);user-select:none}
.equity-filter.active{border-color:var(--navy);background:var(--ice);color:var(--navy)}.equity-filter:hover{border-color:var(--slate2)}
.modal-overlay{position:fixed;inset:0;background:rgba(11,31,59,0.55);backdrop-filter:blur(4px);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;animation:fadeIn 0.2s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{background:var(--white);border-radius:var(--radius-xl);width:100%;max-width:620px;max-height:88vh;overflow-y:auto;box-shadow:var(--shadow-xl);animation:slideUp 0.22s cubic-bezier(0.34,1.56,0.64,1)}
@keyframes slideUp{from{transform:translateY(24px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-header{padding:24px 28px 18px;border-bottom:1px solid var(--mist);display:flex;justify-content:space-between;align-items:flex-start}
.modal-title{font-size:18px;font-weight:700;color:var(--navy);letter-spacing:-0.02em}
.modal-subtitle{font-size:13px;color:var(--slate2);margin-top:3px}
.modal-close{width:30px;height:30px;border-radius:50%;background:var(--surface);border:none;font-size:16px;color:var(--slate);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:-2px;transition:all var(--transition)}
.modal-close:hover{background:var(--ice);color:var(--navy)}
.modal-body{padding:24px 28px}.modal-footer{padding:16px 28px 24px;display:flex;justify-content:flex-end;gap:10px}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}.form-grid-full{grid-column:1/-1}
.form-group{display:flex;flex-direction:column;gap:5px}
.form-label{font-size:12px;font-weight:600;color:var(--slate);letter-spacing:0.02em}.form-label span{color:var(--fog);font-weight:400}
.form-input{height:38px;padding:0 12px;border:1.5px solid var(--mist);border-radius:var(--radius);font-size:13.5px;color:var(--navy);background:var(--white);transition:border-color var(--transition);outline:none;width:100%}
.form-input:focus{border-color:var(--navy2);box-shadow:0 0 0 3px rgba(28,58,99,0.08)}.form-input::placeholder{color:var(--fog)}
.form-select{height:38px;padding:0 32px 0 12px;border:1.5px solid var(--mist);border-radius:var(--radius);font-size:13.5px;color:var(--navy);background:var(--white);cursor:pointer;outline:none;width:100%;transition:border-color var(--transition);-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235C7A99' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
.form-select:focus{border-color:var(--navy2);box-shadow:0 0 0 3px rgba(28,58,99,0.08)}
.checkbox-group{display:flex;flex-wrap:wrap;gap:8px}
.checkbox-pill{display:flex;align-items:center;gap:6px;padding:6px 12px;border:1.5px solid var(--mist);border-radius:20px;cursor:pointer;font-size:12.5px;font-weight:500;color:var(--slate);transition:all var(--transition);background:var(--white);user-select:none}
.checkbox-pill:hover{border-color:var(--slate2);color:var(--navy);background:var(--surface)}
.checkbox-pill input{width:0;height:0;opacity:0;position:absolute}
.checkbox-pill.checked{border-color:var(--navy2);background:var(--ice);color:var(--navy);font-weight:600}
.form-section-label{font-size:11px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--fog);margin-bottom:10px;margin-top:4px;padding-bottom:6px;border-bottom:1px solid var(--mist)}
.dashboard-grid{display:grid;grid-template-columns:340px 1fr;gap:20px;align-items:start}
.profile-card{background:var(--white);border:1.5px solid var(--mist);border-radius:var(--radius-lg);overflow:hidden}
.profile-card-header{background:linear-gradient(135deg,var(--navy) 0%,var(--navy2) 100%);padding:20px 22px;position:relative;overflow:hidden}
.profile-card-header::after{content:'';position:absolute;right:-30px;top:-30px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,0.04)}
.profile-card-header h3{font-size:13px;font-weight:700;color:rgba(255,255,255,0.5);letter-spacing:0.06em;text-transform:uppercase;margin-bottom:6px}
.profile-card-name{font-size:20px;font-weight:700;color:var(--white);letter-spacing:-0.02em}
.profile-card-firm{font-size:12.5px;color:rgba(255,255,255,0.55);margin-top:2px}
.profile-card-body{padding:18px 22px}
.profile-row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--surface2)}.profile-row:last-child{border-bottom:none}
.profile-key{font-size:12px;color:var(--slate2);font-weight:500}.profile-val{font-size:13px;color:var(--navy);font-weight:600;text-align:right}
.profile-card-footer{padding:12px 22px 18px;display:flex;gap:8px}
.suggested-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.suggested-title{font-size:15px;font-weight:700;color:var(--navy)}.suggested-sub{font-size:12px;color:var(--slate2);margin-top:1px}
.quick-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.stat-card{background:var(--white);border:1px solid var(--mist);border-radius:var(--radius);padding:14px 16px;text-align:center}
.stat-val{font-size:26px;font-weight:800;color:var(--navy);letter-spacing:-0.03em;line-height:1}
.stat-label{font-size:11px;color:var(--slate2);font-weight:500;margin-top:4px;text-transform:uppercase;letter-spacing:0.06em}
.start-here-card{background:linear-gradient(135deg,#EFF6FF 0%,#E0F2FE 100%);border:1.5px dashed #93C5FD;border-radius:var(--radius-lg);padding:28px 24px;text-align:center}
.start-here-icon{font-size:36px;margin-bottom:12px}.start-here-title{font-size:16px;font-weight:700;color:var(--navy);margin-bottom:6px}
.start-here-text{font-size:13px;color:var(--slate);line-height:1.6;margin-bottom:18px}
/* STEP 5: Detail-specific */
.detail-section{margin-bottom:16px}
.detail-two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.detail-chart-wrap{position:relative;height:260px}
.detail-nav-strip{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;gap:8px}
.detail-nav-strip .breadcrumb{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--fog);flex:1;min-width:0}
.detail-nav-strip .breadcrumb .crumb-name{color:var(--slate);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:240px}
.detail-prev-next{display:flex;gap:4px;flex-shrink:0}
.detail-prev-next button{padding:5px 10px;border-radius:6px;border:1.5px solid var(--mist);background:var(--white);color:var(--slate);font-size:12px;font-weight:600;cursor:pointer;transition:all var(--transition);display:flex;align-items:center;gap:4px;max-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.detail-prev-next button:hover:not(:disabled){border-color:var(--navy2);color:var(--navy);background:var(--ice)}
.detail-prev-next button:disabled{opacity:0.35;cursor:default}
.kd-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.kd-item{display:flex;align-items:flex-start;gap:8px;padding:10px 12px;border-radius:var(--radius);background:var(--surface);border:1px solid var(--mist);font-size:12.5px;line-height:1.5;color:var(--navy)}
.kd-icon{font-size:14px;flex-shrink:0;margin-top:1px}
.kd-item.positive{background:var(--green-lt);border-color:#BBF7D0}
.kd-item.caution{background:var(--amber-lt);border-color:#FDE68A}
.kd-item.risk{background:var(--red-lt);border-color:#FECACA}
.kd-item.info{background:var(--blue-lt);border-color:#BFDBFE}
.val-callout{display:flex;align-items:center;gap:14px;padding:14px 18px;border-radius:var(--radius);font-size:13px;font-weight:600}
.val-callout.discount{background:var(--green-lt);border:1px solid #BBF7D0;color:var(--green)}
.val-callout.premium{background:var(--amber-lt);border:1px solid #FDE68A;color:var(--amber)}
.val-callout .val-pct{font-size:24px;font-weight:800;letter-spacing:-0.03em}
.proj-table{width:100%;border-collapse:collapse;font-size:12.5px}
.proj-table th{background:var(--surface2);padding:8px 10px;text-align:center;font-size:10px;font-weight:700;color:var(--slate2);text-transform:uppercase;letter-spacing:0.06em;border-bottom:1px solid var(--mist)}
.proj-table th:first-child{text-align:left}
.proj-table td{padding:8px 10px;text-align:center;border-bottom:1px solid var(--surface2);font-family:var(--mono);font-weight:500;color:var(--navy)}
.proj-table td:first-child{text-align:left;font-family:var(--font);font-weight:600;color:var(--slate);font-size:12px}
.proj-table tr:last-child td{border-bottom:none}.proj-table .highlight{background:var(--ice);font-weight:700}
.doc-btn-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px;padding:12px 16px;background:var(--surface);border-radius:var(--radius);border:1px solid var(--mist);align-items:center}
.doc-btn-row .doc-label{font-size:11px;font-weight:700;color:var(--fog);text-transform:uppercase;letter-spacing:0.06em;margin-right:4px;white-space:nowrap}
.action-bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid var(--mist)}
/* Basket / Comparison */
.comp-grid{display:grid;gap:0;border:1px solid var(--mist);border-radius:var(--radius-lg);overflow:hidden;background:var(--white)}
.comp-row{display:grid;border-bottom:1px solid var(--surface2)}
.comp-row:last-child{border-bottom:none}
.comp-row.header{background:var(--surface2);position:sticky;top:0;z-index:5}
.comp-row.section-header{background:var(--ice)}
.comp-cell{padding:10px 14px;font-size:12.5px;color:var(--navy);display:flex;align-items:center;border-right:1px solid var(--surface2)}
.comp-cell:last-child{border-right:none}
.comp-cell.label{font-weight:600;color:var(--slate);font-size:12px;background:var(--surface)}
.comp-cell.header-cell{font-weight:700;font-size:11px;color:var(--slate2);text-transform:uppercase;letter-spacing:0.06em}
.comp-cell.section-label{font-weight:700;font-size:11px;color:var(--navy2);text-transform:uppercase;letter-spacing:0.06em;grid-column:1/-1;padding:8px 14px}
.comp-cell .val{font-family:var(--mono);font-weight:600}
.comp-cell .best{color:var(--green);font-weight:700}
.comp-cell .worst{color:var(--red)}
.basket-offering-header{padding:16px;text-align:center;border-right:1px solid var(--surface2);position:relative}
.basket-offering-header:last-child{border-right:none}
.basket-remove{position:absolute;top:6px;right:6px;width:22px;height:22px;border-radius:50%;border:none;background:var(--surface);color:var(--slate2);font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all var(--transition)}
.basket-remove:hover{background:var(--red-lt);color:var(--red)}
.takeaway-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.takeaway-card{padding:14px;border-radius:var(--radius);font-size:12.5px;line-height:1.6}
.takeaway-card.positive{background:var(--green-lt);border:1px solid #BBF7D0;color:var(--navy)}
.takeaway-card.caution{background:var(--amber-lt);border:1px solid #FDE68A;color:var(--navy)}
.takeaway-card.info{background:var(--blue-lt);border:1px solid #BFDBFE;color:var(--navy)}
.takeaway-card .takeaway-icon{font-size:14px;margin-right:6px}
.basket-chart-wrap{height:280px;position:relative}
.skeleton{background:linear-gradient(90deg,var(--surface2) 25%,var(--mist) 50%,var(--surface2) 75%);background-size:200% 100%;animation:shimmer 1.4s ease-in-out infinite;border-radius:4px}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.skeleton-card{background:var(--white);border:1px solid var(--mist);border-radius:var(--radius-lg);padding:18px;height:200px}
#main.compliance-mode .page-title{color:#4C1D95}#main.compliance-mode .panel{border-color:#DDD6FE}
.fade-in{animation:fadeIn 0.3s ease}.slide-in{animation:slideIn 0.25s cubic-bezier(0.4,0,0.2,1)}
@keyframes slideIn{from{transform:translateX(-12px);opacity:0}to{transform:translateX(0);opacity:1}}
.card-enter{animation:cardEnter 0.3s cubic-bezier(0.34,1.2,0.64,1) both}
@keyframes cardEnter{from{transform:translateY(12px) scale(0.97);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
#toast-container{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--navy);color:var(--white);padding:11px 18px;border-radius:10px;font-size:13px;font-weight:500;box-shadow:var(--shadow-lg);animation:toastIn 0.3s cubic-bezier(0.34,1.56,0.64,1);display:flex;align-items:center;gap:8px}
@keyframes toastIn{from{transform:translateX(20px);opacity:0}to{transform:translateX(0);opacity:1}}
.toast-success{border-left:4px solid #34D399}.toast-error{border-left:4px solid #F87171}
::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--mist);border-radius:3px}::-webkit-scrollbar-thumb:hover{background:var(--fog)}
@media(max-width:900px){:root{--nav-w:0px}#sidebar{display:none}#main{padding:18px}.dashboard-grid{grid-template-columns:1fr}.quick-stats{grid-template-columns:repeat(2,1fr)}.offering-grid{grid-template-columns:1fr}#view-toggle .view-btn span.label-text{display:none}.offering-table{font-size:12px}.offering-table td,.offering-table th{padding:7px 8px}.detail-two-col{grid-template-columns:1fr}.kd-grid{grid-template-columns:1fr}.detail-prev-next button{max-width:80px}}
/* ═══════════════════════════════════════════
   BASKET VIEW — Imported from Tear Sheet
═══════════════════════════════════════════ */
.bv{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:rgba(9,14,25,0.92);direction:ltr!important}
.bv .report{border:1px solid rgba(15,23,42,0.12);background:rgba(255,255,255,0.64);border-radius:16px;overflow:hidden;box-shadow:0 18px 60px rgba(15,23,42,0.12)}
.bv .r-hero{padding:16px 16px 14px;border-bottom:1px solid rgba(255,255,255,0.14);background:radial-gradient(900px 380px at 10% 0%,rgba(11,31,59,0.56),transparent 62%),radial-gradient(700px 360px at 95% 10%,rgba(28,58,99,0.38),transparent 58%),linear-gradient(180deg,rgba(6,18,34,0.86),rgba(16,35,60,0.72))}
.bv .topline{display:grid;grid-template-columns:1.2fr auto auto;gap:12px;align-items:start}
@media(max-width:980px){.bv .topline{grid-template-columns:1fr}}
.bv .r-title h2{margin:0;font-size:18px;font-weight:950;letter-spacing:.2px;line-height:1.2;color:rgba(255,255,255,0.98);text-shadow:0 6px 20px rgba(0,0,0,0.25)}
.bv .r-title .subline{margin-top:6px;font-size:12px;color:rgba(255,255,255,0.92);font-weight:850;text-shadow:0 6px 20px rgba(0,0,0,0.22)}
.bv .metaRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;align-items:center}
.bv .r-badge{display:inline-flex;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,0.22);background:rgba(255,255,255,0.12);color:rgba(255,255,255,0.86);font-size:11px;font-weight:850;backdrop-filter:blur(4px)}
.bv .r-badge strong{font-weight:950;color:rgba(255,255,255,0.96)}
.bv .hdrStatusWrap{border:1px solid rgba(255,255,255,0.20);background:rgba(255,255,255,0.12);border-radius:14px;padding:10px;min-height:92px;display:flex;align-items:stretch;gap:12px;min-width:280px;box-shadow:0 18px 44px rgba(0,0,0,0.14);backdrop-filter:blur(6px)}
@media(max-width:980px){.bv .hdrStatusWrap{height:auto;min-width:0}}
.bv .vStat{display:flex;gap:10px;align-items:stretch;min-width:0;flex:1 1 0}
.bv .vTrack{width:12px;border-radius:999px;border:1px solid rgba(255,255,255,0.22);background:rgba(255,255,255,0.10);overflow:hidden;position:relative;flex:0 0 12px}
.bv .vFill{position:absolute;left:0;right:0;bottom:0;height:0%;background:linear-gradient(180deg,rgba(52,211,153,0.96),rgba(16,185,129,0.98))}
.bv .vInfo{display:grid;grid-template-rows:auto 1fr;gap:6px;min-width:0;width:100%}
.bv .vHdr{display:flex;align-items:baseline;justify-content:space-between;gap:8px;min-width:0;white-space:nowrap}
.bv .vHdr .k{font-size:10px;font-weight:950;text-transform:uppercase;letter-spacing:.25px;color:rgba(255,255,255,0.92)}
.bv .vList{display:grid;gap:3px;align-content:start;min-width:0}
.bv .vLine{font-size:10px;font-weight:850;color:rgba(255,255,255,0.82);line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.bv .vLine b{font-weight:950;color:rgba(255,255,255,0.96)}
.bv .docsBox{display:grid;gap:8px;text-align:left;align-content:start;justify-items:start;position:relative}
.bv .docPopover{position:absolute;right:0;top:calc(100% + 10px);z-index:9999}
@media(max-width:980px){.bv .docPopover{right:auto;left:0}}
.bv .modal{max-width:540px;margin:0;border-radius:16px;border:1px solid rgba(15,23,42,0.14);background:radial-gradient(900px 420px at 20% 0%,rgba(11,31,59,0.12),transparent 65%),linear-gradient(180deg,rgba(255,255,255,0.94),rgba(238,242,246,0.90));box-shadow:0 24px 80px rgba(15,23,42,0.18);overflow:hidden;text-align:left}
.bv .modalHdr{padding:12px;border-bottom:1px solid rgba(15,23,42,0.10);display:flex;align-items:center;justify-content:space-between;gap:10px}
.bv .modalHdr .t{font-size:12px;font-weight:950;letter-spacing:.25px;text-transform:uppercase;color:rgba(9,14,25,0.84)}
.bv .modalBody{padding:12px;display:grid;gap:10px;max-height:55vh;overflow:auto}
.bv .docRow{border:1px solid rgba(15,23,42,0.12);background:rgba(255,255,255,0.74);border-radius:14px;padding:10px;display:flex;align-items:center;justify-content:space-between;gap:10px;box-shadow:0 10px 24px rgba(15,23,42,0.06)}
.bv .docRow .name{font-size:11px;font-weight:900;color:rgba(9,14,25,0.86);min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bv .docRow .right{display:flex;gap:8px;flex:0 0 auto}
.bv .docRow .na{font-size:11px;font-weight:850;color:rgba(9,14,25,0.52)}
.bv .kv-grid{padding:14px 16px;display:grid;grid-template-columns:1.1fr 0.9fr;gap:12px;border-bottom:1px solid rgba(15,23,42,0.10);background:rgba(255,255,255,0.54)}
@media(max-width:980px){.bv .kv-grid{grid-template-columns:1fr}}
.bv .callouts{display:grid;gap:10px}
.bv .callout{border:1px solid rgba(15,23,42,0.12);background:rgba(255,255,255,0.64);border-radius:14px;padding:12px;box-shadow:0 12px 26px rgba(15,23,42,0.06)}
.bv .callout h3{margin:0 0 8px 0;font-size:12px;text-transform:uppercase;letter-spacing:.25px;color:rgba(9,14,25,0.78);font-weight:950}
.bv .callout ul{margin:0;padding-left:18px;color:rgba(9,14,25,0.78);font-size:12px;line-height:1.55;font-weight:700}
.bv .callout li{margin:6px 0}
.bv .mapWrap{border:1px solid rgba(15,23,42,0.12);background:rgba(255,255,255,0.60);border-radius:14px;padding:12px;box-shadow:0 12px 28px rgba(15,23,42,0.06)}
.bv .mapHdr{display:flex;align-items:baseline;justify-content:space-between;gap:10px;margin-bottom:10px}
.bv .mapHdr .t{font-size:12px;font-weight:950;letter-spacing:.2px;color:rgba(9,14,25,0.88)}
.bv .mapHdr .s{font-size:11px;color:rgba(9,14,25,0.60);font-weight:800}
.bv .mapBox{height:270px;border-radius:14px;border:1px solid rgba(15,23,42,0.10);background:#EEF2F6;overflow:hidden}
.bv .legend{display:flex;align-items:center;gap:10px;margin-top:10px;color:rgba(9,14,25,0.62);font-size:11px;font-weight:800}
.bv .swatch{width:16px;height:10px;border-radius:999px;background:rgba(11,31,59,0.82);border:1px solid rgba(28,58,99,0.70)}
.bv .sections{padding:14px 16px 16px;display:grid;gap:14px}
.bv .sec{border:1px solid rgba(15,23,42,0.12);border-radius:14px;background:rgba(255,255,255,0.60);overflow:hidden;box-shadow:0 12px 30px rgba(15,23,42,0.06)}
.bv .secHdr{padding:12px;border-bottom:1px solid rgba(15,23,42,0.10);display:flex;align-items:baseline;justify-content:space-between;gap:10px;background:linear-gradient(135deg,rgba(11,31,59,0.08),rgba(255,255,255,0.74));flex-wrap:wrap;box-shadow:inset 0 2px 0 rgba(11,31,59,0.18)}
.bv .secHdr .h{font-size:12px;font-weight:950;letter-spacing:.25px;text-transform:uppercase;color:rgba(9,14,25,0.84)}
.bv .secHdr .hint{font-size:11px;color:rgba(9,14,25,0.58);font-weight:800}
.bv .secBody{padding:12px}
.bv .metricsGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media(max-width:980px){.bv .metricsGrid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:520px){.bv .metricsGrid{grid-template-columns:1fr}}
.bv .mBox{border:1px solid rgba(15,23,42,0.12);border-radius:14px;padding:10px;background:linear-gradient(180deg,rgba(255,255,255,0.78),rgba(238,242,246,0.78));min-width:0;position:relative;box-shadow:0 10px 24px rgba(15,23,42,0.06)}
.bv .mBox .k{font-size:10px;color:rgba(9,14,25,0.58);font-weight:950;text-transform:uppercase;letter-spacing:.25px;padding-right:56px}
.bv .mBox .v{margin-top:6px;font-size:14px;font-weight:950;letter-spacing:.15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:rgba(9,14,25,0.92)}
.bv .mBox .vs{margin-top:6px;font-size:11px;color:rgba(9,14,25,0.66);font-weight:800}
.bv .mCov{position:absolute;top:8px;right:8px;font-size:10px;font-weight:900;color:rgba(9,14,25,0.52);background:rgba(238,242,246,0.90);padding:2px 6px;border-radius:6px}
.bv .mCov.warn{color:rgba(198,137,42,0.92);background:rgba(198,137,42,0.12)}
.bv .delta{font-weight:900}.bv .delta.pos{color:rgba(31,157,107,0.96)}.bv .delta.neg{color:rgba(214,69,69,0.90)}
.bv .pctl{color:rgba(9,14,25,0.54);font-weight:850}
.bv .textBlock{font-size:12px;color:rgba(9,14,25,0.62);font-weight:700;line-height:1.6}
.bv .chartWrap{border:1px solid rgba(15,23,42,0.12);border-radius:14px;padding:12px;background:rgba(255,255,255,0.80);box-shadow:0 10px 24px rgba(15,23,42,0.06)}
.bv .chartHdr{display:flex;align-items:baseline;justify-content:space-between;gap:10px;margin-bottom:10px}
.bv .chartHdr .t{font-size:12px;font-weight:950;letter-spacing:.2px;color:rgba(9,14,25,0.86)}
.bv .chartHdr .s{font-size:11px;color:rgba(9,14,25,0.58);font-weight:800}
.bv .chartBox{height:320px;position:relative}
.bv .valHero{display:grid;gap:10px}
.bv .calloutRow{display:grid;grid-template-columns:1fr auto;gap:10px}
@media(max-width:700px){.bv .calloutRow{grid-template-columns:1fr}}
.bv .heroCall{border:1px solid rgba(15,23,42,0.14);border-radius:14px;padding:12px;background:linear-gradient(135deg,rgba(238,242,246,0.92),rgba(255,255,255,0.92));box-shadow:0 16px 36px rgba(15,23,42,0.08)}
.bv .heroCall.good{border-color:rgba(31,157,107,0.26);background:linear-gradient(135deg,rgba(31,157,107,0.08),rgba(255,255,255,0.92))}
.bv .heroCall.bad{border-color:rgba(214,69,69,0.22);background:linear-gradient(135deg,rgba(214,69,69,0.06),rgba(255,255,255,0.92))}
.bv .heroTop{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.bv .heroK{font-size:11px;font-weight:950;text-transform:uppercase;letter-spacing:.25px;color:rgba(9,14,25,0.68)}
.bv .heroMain{font-size:16px;font-weight:950;color:rgba(9,14,25,0.92);letter-spacing:.15px}
.bv .heroSub{font-size:12px;font-weight:850;color:rgba(9,14,25,0.72);margin-top:4px}
.bv .heroMeta{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
.bv .kv{font-size:11px;font-weight:800;color:rgba(9,14,25,0.66)}.bv .kv b{font-weight:950;color:rgba(9,14,25,0.82)}
.bv .miniCall{border:1px solid rgba(15,23,42,0.12);border-radius:14px;padding:12px;min-width:180px;background:rgba(255,255,255,0.74);box-shadow:0 10px 24px rgba(15,23,42,0.06)}
.bv .miniCall .k{font-size:11px;font-weight:950;text-transform:uppercase;letter-spacing:.25px;color:rgba(9,14,25,0.62);margin-bottom:6px}
.bv .miniCall .v{font-size:14px;font-weight:950;color:rgba(9,14,25,0.92)}
.bv .miniCall .s{margin-top:6px;font-size:11px;color:rgba(9,14,25,0.58);font-weight:750;line-height:1.5}
.bv .r-pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(15,23,42,0.12);background:rgba(255,255,255,0.62);color:rgba(9,14,25,0.64);font-size:11px;font-weight:850}
.bv .vcompWrap{border:1px solid rgba(15,23,42,0.12);background:rgba(255,255,255,0.64);border-radius:14px;overflow:hidden;box-shadow:0 12px 30px rgba(15,23,42,0.06)}
.bv .vcompTop{padding:12px;border-bottom:1px solid rgba(15,23,42,0.10);background:linear-gradient(135deg,rgba(11,31,59,0.08),rgba(255,255,255,0.74));display:flex;align-items:baseline;justify-content:space-between;gap:10px;flex-wrap:wrap;box-shadow:inset 0 2px 0 rgba(11,31,59,0.18)}
.bv .vcompTop .t{font-size:12px;font-weight:950;letter-spacing:.25px;text-transform:uppercase;color:rgba(9,14,25,0.84)}
.bv .vcompTop .s{font-size:11px;color:rgba(9,14,25,0.58);font-weight:800}
.bv .vcompScroller{overflow:auto;background:rgba(255,255,255,0.60)}
.bv .vcompTable{width:100%;border-collapse:separate;border-spacing:0;min-width:760px}
.bv .vcompTable th,.bv .vcompTable td{border-bottom:1px solid rgba(15,23,42,0.08);padding:10px;vertical-align:top;font-size:12px;color:rgba(9,14,25,0.82);font-weight:750}
.bv .vcompTable thead th{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid rgba(15,23,42,0.14);box-shadow:0 6px 14px rgba(15,23,42,0.06)}
.bv .vcompTable thead th:first-child{z-index:6}
.bv .vcompField{width:260px;min-width:240px;max-width:340px;color:rgba(9,14,25,0.68);font-weight:900}
.bv .vcompOfferHdr{font-size:11px;font-weight:950;color:rgba(9,14,25,0.88);letter-spacing:.2px;text-transform:uppercase;line-height:1.15}
.bv .vcompOfferSub{margin-top:4px;font-size:10px;font-weight:850;color:rgba(9,14,25,0.58);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.bv .vcompGroupRow td{background:rgba(238,242,246,0.94);border-top:1px solid rgba(15,23,42,0.10);border-bottom:1px solid rgba(15,23,42,0.10);padding:10px;font-size:11px;font-weight:950;text-transform:uppercase;letter-spacing:.25px;color:rgba(9,14,25,0.74)}
.bv .vcompVal{white-space:pre-wrap;word-break:break-word;line-height:1.55}
.bv .vcompNA{color:rgba(9,14,25,0.48);font-weight:850}
.bv .bv-btn{border:1px solid rgba(15,23,42,0.14);background:rgba(255,255,255,0.74);color:rgba(9,14,25,0.90);padding:4px 10px;border-radius:12px;font-size:11px;font-weight:900;cursor:pointer;transition:transform .08s ease,background .15s ease;user-select:none;white-space:nowrap;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 8px 22px rgba(15,23,42,0.06)}
.bv .bv-btn:hover{background:rgba(255,255,255,0.88)}
.bv .bv-btn:active{transform:translateY(1px)}
.bv .bv-btn.doc{border-color:rgba(255,255,255,0.20);color:rgba(255,255,255,0.98);background:linear-gradient(135deg,rgba(64,156,255,0.96),rgba(120,207,255,0.92));box-shadow:0 16px 44px rgba(30,136,229,0.20)}
.bv .bv-btn.doc:hover{filter:brightness(1.05)}
.bv .bv-btn:disabled{opacity:.55;cursor:not-allowed;pointer-events:none}
.bv .ico{width:14px;height:14px;display:inline-flex;align-items:center;justify-content:center;flex:0 0 14px;opacity:.98}
.bv .ico svg{width:14px;height:14px;display:block}
.bv .ftr{padding:10px 18px;border-top:1px solid rgba(15,23,42,0.10);display:flex;align-items:center;justify-content:space-between;gap:10px;font-size:10px;color:rgba(9,14,25,0.50);font-weight:800;background:rgba(255,255,255,0.60)}
.bv-dropdown-wrap{position:relative;display:inline-block}
.bv-dropdown{display:none;position:absolute;top:calc(100% + 6px);right:0;z-index:999;background:#fff;border:1px solid rgba(11,31,59,0.14);border-radius:12px;box-shadow:0 12px 40px rgba(11,31,59,0.18);padding:8px;min-width:340px;max-height:400px;overflow-y:auto}
.bv-dropdown.open{display:block}
.bv-dropdown::-webkit-scrollbar{width:8px}.bv-dropdown::-webkit-scrollbar-thumb{background:rgba(11,31,59,0.12);border-radius:8px}
.bv-select-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600;color:var(--navy);transition:background .12s}
.bv-select-item:hover{background:var(--ice)}
.bv-select-item.checked{background:rgba(11,31,59,0.06);font-weight:700}
.bv-select-item.disabled{opacity:.45;cursor:not-allowed}
.bv-select-item input[type="checkbox"]{accent-color:var(--navy);width:16px;height:16px;flex-shrink:0;cursor:pointer}
.bv-select-item.disabled input{cursor:not-allowed}
.bv-select-name{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bv-select-x{flex-shrink:0;width:20px;height:20px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:rgba(153,27,27,0.08);color:var(--red);font-size:11px;font-weight:800;cursor:pointer;transition:background .12s}
.bv-select-x:hover{background:rgba(153,27,27,0.16)}
@media print{.bv .report{border:1px solid #ddd!important;background:#fff!important}.bv .r-hero .r-badge{color:#333!important;border-color:#ccc!important;background:#f0f0f0!important}.bv .sec,.bv .callout,.bv .mapWrap,.bv .valHero,.bv .chartWrap,.bv .vcompWrap{break-inside:avoid;page-break-inside:avoid}.bv .vcompScroller{overflow:visible!important}.bv .vcompTable thead th{position:static!important;box-shadow:none!important}*{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}}

</style>
</head>
<body>
<div id="app">
  <header id="header">
    <div id="logo"><div id="logo-mark">A</div><div><div id="logo-text">Alts Fund Link</div><div id="logo-sub">Intelligence Platform</div></div></div>
    <div id="view-toggle">
      <button class="view-btn active" data-view="advisor" onclick="switchMode('advisor')"><span class="view-dot"></span><span class="label-text">Advisor View</span></button>
      <button class="view-btn client-report" data-view="client_report" onclick="switchMode('client_report')"><span class="view-dot"></span><span class="label-text">Client Report</span></button>
      <button class="view-btn compliance" data-view="compliance" onclick="switchMode('compliance')"><span class="view-dot"></span><span class="label-text">Compliance</span></button>
    </div>
    <div id="data-status"><span class="pulse-dot loading" id="status-dot"></span><span id="status-text">Loading data…</span></div>
    <div id="client-badge" onclick="openProfileModal()"><div id="client-badge-icon">?</div><div id="client-badge-text"><span id="badge-name">No Client</span><small id="badge-equity">Set up client profile</small></div></div>
  </header>
  <div id="body-area">
    <nav id="sidebar"><div id="nav-advisor" class="nav-content"></div><div id="nav-client_report" class="nav-content" style="display:none"></div><div id="nav-compliance" class="nav-content" style="display:none"></div></nav>
    <main id="main"><div id="view-content" class="fade-in"></div></main>
  </div>
</div>
<div id="modal-container"></div>
<div id="toast-container"></div>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script>
/* ═══════════════════════════════════════════
   STATE & CONFIG
═══════════════════════════════════════════ */
const SHEET_ID = '1xVFw8pFrJzcxD8CH7ainimPKD6GW9tn1bb8ggHYUfRs';
const STATE = {
  mode: 'advisor',
  view: 'dashboard',
  funds: [],
  peer: {},
  client: loadClient(),
  selectedOfferingId: null,
  basket: JSON.parse(localStorage.getItem('afl_basket') || '[]'),
  browseLayout: 'card',
  browseSort: 'y1coc_desc',
  browseFilters: { status: 'all', propType: 'all', sponsor: 'all', sector: 'all', focus: 'all', cocMin: '', cocMax: '', search: '', clientEquity: false, quickDst: false, quickNoDebt: false, quickUpreit: false },
  incomeChart: null
};

function loadClient() {
  try { return JSON.parse(localStorage.getItem('afl_client')) || {}; } catch { return {}; }
}
function saveClient() { localStorage.setItem('afl_client', JSON.stringify(STATE.client)); }
function saveBasket() { localStorage.setItem('afl_basket', JSON.stringify(STATE.basket)); }
function fmtPct(v) { return v != null && !isNaN(v) ? v.toFixed(2) + '%' : '—'; }
function fmtMoney(v) { if (v == null || isNaN(v)) return '—'; if (v >= 1e6) return '$' + (v / 1e6).toFixed(1) + 'M'; if (v >= 1e3) return '$' + (v / 1e3).toFixed(0) + 'K'; return '$' + v.toLocaleString(); }
function fmtMoneyFull(v) { return v != null && !isNaN(v) ? '$' + v.toLocaleString() : '—'; }
function fmtNum(v, d = 2) { return v != null && !isNaN(v) ? v.toFixed(d) : '—'; }
function parsePct(s) { if (s == null || s === '') return null; let str = String(s).trim(); let hadPct = str.includes('%'); let n = parseFloat(str.replace(/[%,]/g, '')); if (isNaN(n)) return null; if (!hadPct && Math.abs(n) <= 1 && n !== 0) n = n * 100; return n; }
function parseMoney(s) { if (s == null || s === '') return null; let str = String(s).trim().replace(/[$,]/g, ''); let n = parseFloat(str); if (isNaN(n)) return null; return n; }
function parseMoneyM(s) { if (s == null || s === '') return null; let str = String(s).trim().replace(/[$,]/g, ''); let n = parseFloat(str); if (isNaN(n)) return null; if (n > 0 && n < 999) n = n * 1000000; return n; }
function parseDate(s) { if (!s) return null; if (typeof s === 'string' && s.startsWith('Date(')) { let parts = s.replace('Date(','').replace(')','').split(',').map(Number); return new Date(parts[0], parts[1], parts[2]); } let d = new Date(s); return isNaN(d) ? null : d; }
function peerDelta(val, avg, unit) { if (val == null || avg == null) return ''; let d = val - avg; let u = unit || '%'; let arrow = d > 0.1 ? '↑' : d < -0.1 ? '↓' : '~'; let cls = d > 0.1 ? 'up' : d < -0.1 ? 'down' : 'neutral'; return `<span class="peer-delta ${cls}">${arrow} ${Math.abs(d).toFixed(1)}${u} vs avg</span>`; }
function toast(msg, type = 'success') { let t = document.createElement('div'); t.className = 'toast toast-' + type; t.innerHTML = (type === 'success' ? '✓' : '⚠') + ' ' + msg; document.getElementById('toast-container').appendChild(t); setTimeout(() => t.remove(), 3200); }

/* ═══════════════════════════════════════════
   DATA LAYER — Google Sheets via GViz
═══════════════════════════════════════════ */
function fetchSheetData() {
  const dot = document.getElementById('status-dot');
  const txt = document.getElementById('status-text');
  dot.className = 'pulse-dot loading'; txt.textContent = 'Loading data…';
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
  fetch(url)
    .then(r => r.text())
    .then(raw => {
      const json = JSON.parse(raw.substring(raw.indexOf('{'), raw.lastIndexOf('}') + 1));
      const cols = json.table.cols.map(c => c.label || '');
      STATE.headers = cols;
      const rows = json.table.rows;
      STATE.funds = rows.map((row, idx) => {
        const g = (label) => { let ci = cols.findIndex(c => c.trim() === label.trim()); return ci >= 0 && row.c[ci] ? (row.c[ci].v ?? null) : null; };
        const gf = (label) => { let ci = cols.findIndex(c => c.trim() === label.trim()); return ci >= 0 && row.c[ci] ? (row.c[ci].f || row.c[ci].v || null) : null; };
        const income = [];
        for (let y = 1; y <= 10; y++) { income.push(parsePct(g('Year ' + y))); }
        if (income[0] == null) income[0] = parsePct(g('Year 1 Cash on Cash'));

        // Status: derive from dates + structure
        let status = 'Open';
        const oClose = parseDate(gf('Offering Close'));
        const oOpen = parseDate(gf('Offering Open'));
        const struct = g('Offering Structure') || '';
        const now = new Date();
        if (oOpen && oOpen > now) status = 'Coming Soon';
        else if (oClose && oClose < now) status = 'Closed';
        else if (oClose) { const daysLeft = (oClose - now) / 86400000; if (daysLeft < 60) status = 'Closing'; }

        // Compute pctRaised from Filed vs Remaining
        const filedRaise = parseMoneyM(g('Filed Raise'));
        const currentRaise = parseMoneyM(g('Current Raise'));
        const remainingRaise = parseMoneyM(g('Remaining Raise'));
        const totalRaise = currentRaise || filedRaise;
        let pctRaised = null;
        let pctRemaining = null;
        if (filedRaise && remainingRaise != null) {
          pctRemaining = Math.round((remainingRaise / filedRaise) * 100);
          pctRaised = 100 - pctRemaining;
          if (pctRemaining < 0) pctRemaining = 0;
          if (pctRemaining > 100) pctRemaining = 100;
          if (pctRaised < 0) pctRaised = 0;
          if (pctRaised > 100) pctRaised = 100;
        }

        // Compute months on market
        let monthsOnMarket = null;
        if (oOpen) { monthsOnMarket = Math.round((now - oOpen) / (30.44 * 86400000)); if (monthsOnMarket < 0) monthsOnMarket = null; }

        return {
          id: idx,
          name: g('Offering Name') || 'Unnamed',
          sponsor: g('Sponsor') || '',
          status: status,
          propType: g('Asset Class') || '',
          sector: g('Sector') || '',
          focus: g('Focus') || '',
          location: g('Property Location(s)') || '',
          y1coc: parsePct(g('Year 1 Cash on Cash')),
          avgCoc: null,
          minInvest: parseMoney(g('Minimum - DST')),
          totalRaise: totalRaise,
          filedRaise: filedRaise,
          currentRaise: currentRaise,
          equityRemaining: remainingRaise,
          pctRaised: pctRaised,
          pctRemaining: pctRemaining,
          ltv: parsePct(g('Loan to Value')),
          dscr: null,
          dscrStress: null,
          holdPeriod: parseInt(g('Hold Period')) || null,
          occupancy: parsePct(g('% Leased')),
          purchasePrice: parseMoneyM(g('Purchase Price (Unloaded)')),
          appraisedValue: parseMoneyM(g('Appraised Valuation')),
          loadedPrice: parseMoneyM(g('Loaded Price')),
          units: parseInt(g('# Assets')) || null,
          sqft: null,
          pricePerUnit: null,
          pricePerSqFt: null,
          acqCapRate: parsePct(g('Acquisition Cap Rate')),
          avgLeaseTerm: parseFloat(g('Average Lease Term Remaining')) || null,
          tenantCredit: '',
          leaseTerms: g('Lease Terms') || '',
          debtTerms: g('Debt Terms') || '',
          rentEscalations: g('Rent Escalations') || '',
          distFrequency: g('Distribution Frequency') || '',
          preferred: g('Preferred') || '',
          promote: g('Promote') || '',
          upReit: g('721 UpREIT') || '',
          exemption: g('Exemption') || '',
          taxReporting: g('Tax Reporting') || '',
          repComp: g('Rep Comp') || '',
          salesLoad: g('Sales Load') || '',
          reserve: g('Reserve') || '',
          gpCommit: g('GP Commit') || '',
          buildingAge: g('Building Age (Avg)') || '',
          brochureUrl: g('Brochure'),
          ppmUrl: g('PPM'),
          trackRecordUrl: g('Track Record'),
          salesTeamUrl: g('Sales Team Map'),
          videoUrl: g('Video'),
          sponsorNewsUrl: g('Sponsor News'),
          aiChatUrl: g('AI Offering Chat'),
          sponsorAum: g('Sponsor AUM') || '',
          sponsorOfferings: g('Number of Sponsor Offerings') || '',
          sponsorExits: g('Sponsor Full Cycle Exits') || '',
          sponsorAvgIrr: parsePct(g('Sponsor Average IRR')),
          sponsorBestIrr: parsePct(g('Sponsor Best IRR')),
          sponsorWorstIrr: parsePct(g('Sponsor Worst IRR')),
          sponsorExperience: g('Sponsor Experience') || '',
          openDate: oOpen,
          closeDate: oClose,
          monthsOnMarket: monthsOnMarket,
          income: income,
          _raw: row.c
        };
      }).filter(f => f.name !== 'Unnamed');
      computePeerStats();
      dot.className = 'pulse-dot'; txt.textContent = STATE.funds.length + ' offerings live';
      renderApp();
    })
    .catch(err => {
      console.error('Fetch error:', err);
      dot.className = 'pulse-dot error'; txt.textContent = 'Data error';
    });
}

function computePeerStats() {
  const fs = STATE.funds;
  const vals = (fn) => fs.map(fn).filter(v => v != null);
  const avg = (arr) => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : null;
  STATE.peer = {
    avgY1CoC: avg(vals(f => f.y1coc)),
    avgLTV: avg(vals(f => f.ltv)),
    avgOccupancy: avg(vals(f => f.occupancy)),
    avgMinInvest: avg(vals(f => f.minInvest)),
    avgDSCR: avg(vals(f => f.dscr)),
    avgHold: avg(vals(f => f.holdPeriod)),
    avgLeaseTerm: avg(vals(f => f.avgLeaseTerm)),
    count: fs.length
  };
}

/* ═══════════════════════════════════════════
   NAVIGATION & RENDER ENGINE
═══════════════════════════════════════════ */
function switchMode(mode) {
  STATE.mode = mode;
  document.querySelectorAll('.view-btn').forEach(b => b.classList.toggle('active', b.dataset.view === mode));
  const sb = document.getElementById('sidebar');
  sb.className = mode === 'compliance' ? 'compliance-mode' : mode === 'client_report' ? 'report-mode' : '';
  document.querySelectorAll('.nav-content').forEach(n => n.style.display = 'none');
  document.getElementById('nav-' + mode).style.display = '';
  STATE.view = mode === 'advisor' ? 'dashboard' : mode === 'client_report' ? 'report_summary' : 'comp_dashboard';
  renderApp();
}

function navigateTo(view, offeringId) {
  // Route offering_detail clicks to basket view with that offering selected
  if (view === 'offering_detail' && offeringId !== undefined) {
    if (!STATE.basket.includes(offeringId)) {
      // Clear basket and set to just this offering for single-view
      STATE.basket = [offeringId];
      saveBasket();
    }
    STATE.view = 'basket';
    renderApp();
    return;
  }
  STATE.view = view;
  if (offeringId !== undefined) STATE.selectedOfferingId = offeringId;
  renderApp();
}

function renderApp() {
  buildNav();
  const container = document.getElementById('view-content');
  container.className = 'fade-in' + (STATE.mode === 'compliance' ? ' compliance-mode' : '');
  let html = '';
  switch (STATE.view) {
    case 'dashboard': html = renderDashboard(); break;
    case 'browse': html = renderBrowse(); break;
    case 'basket': html = renderBasket(); break;
    default: html = renderPlaceholder(STATE.view);
  }
  container.innerHTML = html;
  attachViewHandlers();
}

function renderPlaceholder(view) {
  const labels = {
    portfolio_builder: 'Portfolio Builder', model: 'Model for Client', comp_dashboard: 'Compliance Dashboard',
    comp_review: 'Offering Review Queue', comp_reports: 'Compliance Reports', comp_audit: 'Audit Trail',
    report_summary: 'Client Report Summary', report_builder: 'Report Builder', report_templates: 'Report Templates'
  };
  return `<div class="empty-state"><div class="empty-state-icon">🚧</div><h3>${labels[view] || view}</h3><p>Coming in Phase 2. This module will be built out in the next development sprint.</p></div>`;
}

function buildNav() {
  const advisorNav = [
    { icon: '📊', label: 'Dashboard', view: 'dashboard' },
    { icon: '🔍', label: 'Browse Offerings', view: 'browse', badge: STATE.funds.length },
    { icon: '🛒', label: 'Basket', view: 'basket', badge: STATE.basket.length || null },
    { icon: '📐', label: 'Portfolio Builder', view: 'portfolio_builder' },
    { icon: '🧮', label: 'Model for Client', view: 'model' }
  ];
  const compNav = [
    { icon: '🛡️', label: 'Dashboard', view: 'comp_dashboard' },
    { icon: '📋', label: 'Offering Review', view: 'comp_review' },
    { icon: '📊', label: 'Reports', view: 'comp_reports' },
    { icon: '📜', label: 'Audit Trail', view: 'comp_audit' }
  ];
  const reportNav = [
    { icon: '📄', label: 'Summary', view: 'report_summary' },
    { icon: '🛠️', label: 'Builder', view: 'report_builder' },
    { icon: '📋', label: 'Templates', view: 'report_templates' }
  ];
  const renderNavItems = (items) => items.map(i => `<button class="nav-item ${STATE.view === i.view ? 'active' : ''}" onclick="navigateTo('${i.view}')"><span class="nav-icon">${i.icon}</span>${i.label}${i.badge ? `<span class="nav-badge">${i.badge}</span>` : ''}</button>`).join('');
  document.getElementById('nav-advisor').innerHTML = `<div class="nav-section"><div class="nav-label">Platform</div>${renderNavItems(advisorNav)}</div>`;
  document.getElementById('nav-compliance').innerHTML = `<div class="nav-section"><div class="nav-label">Compliance</div>${renderNavItems(compNav)}</div>`;
  document.getElementById('nav-client_report').innerHTML = `<div class="nav-section"><div class="nav-label">Client Reports</div>${renderNavItems(reportNav)}</div>`;
}

function updateClientBadge() {
  const c = STATE.client;
  const icon = document.getElementById('client-badge-icon');
  const name = document.getElementById('badge-name');
  const eq = document.getElementById('badge-equity');
  if (c.name) {
    icon.textContent = c.name.split(' ').map(w => w[0]).join('').substring(0, 2);
    name.textContent = c.name;
    eq.textContent = c.exchangeAmount ? fmtMoney(c.exchangeAmount) + ' exchange' : c.firm || 'Client active';
  } else {
    icon.textContent = '?'; name.textContent = 'No Client'; eq.textContent = 'Set up client profile';
  }
}

/* ═══════════════════════════════════════════
   CLIENT PROFILE MODAL
═══════════════════════════════════════════ */
function openProfileModal() {
  const c = STATE.client;
  document.getElementById('modal-container').innerHTML = `
    <div class="modal-overlay" onclick="if(event.target===this)closeModal()">
      <div class="modal">
        <div class="modal-header"><div><div class="modal-title">Client Profile</div><div class="modal-subtitle">Configure client parameters for suitability matching</div></div><button class="modal-close" onclick="closeModal()">✕</button></div>
        <div class="modal-body">
          <div class="form-grid">
            <div class="form-group"><label class="form-label">Client Name</label><input class="form-input" id="cp-name" value="${c.name || ''}" placeholder="Full name"></div>
            <div class="form-group"><label class="form-label">Firm / BD</label><input class="form-input" id="cp-firm" value="${c.firm || ''}" placeholder="Broker-dealer"></div>
            <div class="form-group"><label class="form-label">Age</label><input class="form-input" type="number" id="cp-age" value="${c.age || ''}" placeholder="65"></div>
            <div class="form-group"><label class="form-label">Filing Status</label><select class="form-select" id="cp-filing"><option value="">Select</option><option value="single" ${c.filing === 'single' ? 'selected' : ''}>Single</option><option value="married" ${c.filing === 'married' ? 'selected' : ''}>Married Filing Jointly</option><option value="trust" ${c.filing === 'trust' ? 'selected' : ''}>Trust</option></select></div>
            <div class="form-group"><label class="form-label">1031 Exchange Amount</label><input class="form-input" id="cp-exchange" value="${c.exchangeAmount || ''}" placeholder="$500,000"></div>
            <div class="form-group"><label class="form-label">Annual Income</label><input class="form-input" id="cp-income" value="${c.annualIncome || ''}" placeholder="$200,000"></div>
            <div class="form-group"><label class="form-label">Net Worth</label><input class="form-input" id="cp-networth" value="${c.netWorth || ''}" placeholder="$2,000,000"></div>
            <div class="form-group"><label class="form-label">Risk Tolerance</label><select class="form-select" id="cp-risk"><option value="">Select</option><option value="conservative" ${c.riskTolerance === 'conservative' ? 'selected' : ''}>Conservative</option><option value="moderate" ${c.riskTolerance === 'moderate' ? 'selected' : ''}>Moderate</option><option value="growth" ${c.riskTolerance === 'growth' ? 'selected' : ''}>Growth</option></select></div>
            <div class="form-group"><label class="form-label">Investment Horizon</label><select class="form-select" id="cp-horizon"><option value="">Select</option><option value="short" ${c.horizon === 'short' ? 'selected' : ''}>Short (3-5 yr)</option><option value="medium" ${c.horizon === 'medium' ? 'selected' : ''}>Medium (5-10 yr)</option><option value="long" ${c.horizon === 'long' ? 'selected' : ''}>Long (10+ yr)</option></select></div>
            <div class="form-group"><label class="form-label">State</label><input class="form-input" id="cp-state" value="${c.state || ''}" placeholder="CA, TX, FL..."></div>
            <div class="form-group form-grid-full"><label class="form-label">Investment Objective</label><div class="checkbox-group" id="cp-objectives">${['Income', 'Preservation', 'Growth', 'Tax Deferral', 'Diversification', 'Estate Planning'].map(o => `<label class="checkbox-pill ${(c.objectives || []).includes(o) ? 'checked' : ''}" onclick="this.classList.toggle('checked')"><input type="checkbox" value="${o}" ${(c.objectives || []).includes(o) ? 'checked' : ''}>${o}</label>`).join('')}</div></div>
            <div class="form-group form-grid-full"><label class="form-label">Property Type Preferences</label><div class="checkbox-group" id="cp-proptypes">${['Multifamily', 'Industrial', 'NNN Retail', 'Medical', 'Office', 'Self-Storage', 'Hospitality', 'Senior Living', 'Student Housing'].map(p => `<label class="checkbox-pill ${(c.propTypes || []).includes(p) ? 'checked' : ''}" onclick="this.classList.toggle('checked')"><input type="checkbox" value="${p}" ${(c.propTypes || []).includes(p) ? 'checked' : ''}>${p}</label>`).join('')}</div></div>
            <div class="form-group form-grid-full"><label class="form-label">Notes</label><textarea class="form-input" id="cp-notes" style="height:60px;padding:10px;resize:vertical" placeholder="Additional notes...">${c.notes || ''}</textarea></div>
          </div>
        </div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveProfile()">💾 Save Profile</button></div>
      </div>
    </div>`;
}

function saveProfile() {
  STATE.client = {
    name: document.getElementById('cp-name').value.trim(),
    firm: document.getElementById('cp-firm').value.trim(),
    age: parseInt(document.getElementById('cp-age').value) || null,
    filing: document.getElementById('cp-filing').value,
    exchangeAmount: parseMoney(document.getElementById('cp-exchange').value),
    annualIncome: parseMoney(document.getElementById('cp-income').value),
    netWorth: parseMoney(document.getElementById('cp-networth').value),
    riskTolerance: document.getElementById('cp-risk').value,
    horizon: document.getElementById('cp-horizon').value,
    state: document.getElementById('cp-state').value.trim(),
    objectives: [...document.querySelectorAll('#cp-objectives .checked input')].map(i => i.value),
    propTypes: [...document.querySelectorAll('#cp-proptypes .checked input')].map(i => i.value),
    notes: document.getElementById('cp-notes').value.trim()
  };
  saveClient();
  updateClientBadge();
  closeModal();
  toast('Client profile saved');
  if (STATE.view === 'dashboard') renderApp();
}

function closeModal() { document.getElementById('modal-container').innerHTML = ''; }

/* ═══════════════════════════════════════════
   DASHBOARD VIEW
═══════════════════════════════════════════ */
function renderDashboard() {
  const c = STATE.client;
  const fs = STATE.funds;
  const hasClient = !!c.name;
  const profileCard = `
    <div class="profile-card">
      <div class="profile-card-header"><h3>Active Client</h3>
        <div class="profile-card-name">${c.name || 'No Client Set'}</div>
        <div class="profile-card-firm">${c.firm || 'Configure client profile to begin'}</div>
      </div>
      <div class="profile-card-body">
        ${hasClient ? `
          ${c.exchangeAmount ? `<div class="profile-row"><span class="profile-key">1031 Exchange</span><span class="profile-val">${fmtMoney(c.exchangeAmount)}</span></div>` : ''}
          ${c.age ? `<div class="profile-row"><span class="profile-key">Age</span><span class="profile-val">${c.age}</span></div>` : ''}
          ${c.riskTolerance ? `<div class="profile-row"><span class="profile-key">Risk Tolerance</span><span class="profile-val" style="text-transform:capitalize">${c.riskTolerance}</span></div>` : ''}
          ${c.horizon ? `<div class="profile-row"><span class="profile-key">Horizon</span><span class="profile-val" style="text-transform:capitalize">${c.horizon}</span></div>` : ''}
          ${c.objectives && c.objectives.length ? `<div class="profile-row"><span class="profile-key">Objectives</span><span class="profile-val" style="font-size:11px">${c.objectives.join(', ')}</span></div>` : ''}
          ${c.state ? `<div class="profile-row"><span class="profile-key">State</span><span class="profile-val">${c.state}</span></div>` : ''}
        ` : '<div style="text-align:center;padding:12px 0;color:var(--slate2);font-size:13px">Click to set up client profile</div>'}
      </div>
      <div class="profile-card-footer">
        <button class="btn btn-secondary btn-sm" onclick="openProfileModal()" style="flex:1">✏️ ${hasClient ? 'Edit' : 'Set Up'} Profile</button>
        ${hasClient ? `<button class="btn btn-ghost btn-sm" onclick="clearClient()">Clear</button>` : ''}
      </div>
    </div>`;

  const suitScores = hasClient ? fs.slice(0, 5).map(f => {
    let score = 50;
    if (c.riskTolerance === 'conservative' && f.ltv && f.ltv < 60) score += 15;
    if (c.riskTolerance === 'conservative' && f.ltv && f.ltv > 70) score -= 20;
    if (c.riskTolerance === 'growth' && f.y1coc && f.y1coc > 6) score += 15;
    if (c.exchangeAmount && f.minInvest && f.minInvest <= c.exchangeAmount * 0.3) score += 10;
    if (c.propTypes && c.propTypes.length && c.propTypes.some(p => f.propType.toLowerCase().includes(p.toLowerCase()))) score += 15;
    if (c.objectives && c.objectives.includes('Income') && f.y1coc && f.y1coc > (STATE.peer.avgY1CoC || 5)) score += 10;
    if (c.age && f.holdPeriod && (c.age + f.holdPeriod) > 85) score -= 15;
    score = Math.max(10, Math.min(98, score));
    return { ...f, suitScore: score };
  }).sort((a, b) => b.suitScore - a.suitScore) : [];

  const topPicks = hasClient ? suitScores.slice(0, 3).map((f, i) => `
    <div class="offering-card card-enter" style="animation-delay:${i * 0.08}s" onclick="navigateTo('offering_detail',${f.id})">
      <div class="offering-card-header">
        <div><div class="offering-name">${f.name}</div><div class="offering-sponsor">${f.sponsor}</div></div>
        <span class="suit-score ${f.suitScore >= 70 ? 'high' : f.suitScore >= 45 ? 'medium' : 'low'}">${f.suitScore}% match</span>
      </div>
      <div class="offering-metrics">
        <div class="offering-metric-item"><div class="label">Y1 CoC</div><div class="value">${fmtPct(f.y1coc)}</div></div>
        <div class="offering-metric-item"><div class="label">LTV</div><div class="value">${fmtPct(f.ltv)}</div></div>
      </div>
      <div class="offering-badges"><span class="badge badge-navy">${f.propType || 'DST'}</span><span class="badge badge-green">${f.status}</span></div>
    </div>
  `).join('') : '';

  const statsHtml = `
    <div class="quick-stats">
      <div class="stat-card card-enter" style="animation-delay:0s"><div class="stat-val">${fs.length}</div><div class="stat-label">Active Offerings</div></div>
      <div class="stat-card card-enter" style="animation-delay:0.06s"><div class="stat-val">${fmtPct(STATE.peer.avgY1CoC)}</div><div class="stat-label">Avg Y1 CoC</div></div>
      <div class="stat-card card-enter" style="animation-delay:0.12s"><div class="stat-val">${STATE.basket.length}</div><div class="stat-label">In Basket</div></div>
      <div class="stat-card card-enter" style="animation-delay:0.18s"><div class="stat-val">${fs.filter(f => f.status === 'Open').length}</div><div class="stat-label">Open Now</div></div>
    </div>`;

  return `
    <div class="page-header"><div><div class="page-title">Dashboard</div><div class="page-subtitle">${hasClient ? 'Personalized for ' + c.name : 'Set up a client profile to enable matching'}</div></div></div>
    ${statsHtml}
    <div class="dashboard-grid">
      ${profileCard}
      <div>
        ${hasClient ? `
          <div class="suggested-header"><div><div class="suggested-title">Top Matches</div><div class="suggested-sub">Based on client profile suitability</div></div>
            <button class="btn btn-secondary btn-sm" onclick="navigateTo('browse')">View All →</button>
          </div>
          <div class="offering-grid" style="grid-template-columns:repeat(auto-fill,minmax(240px,1fr))">${topPicks}</div>
        ` : `
          <div class="start-here-card"><div class="start-here-icon">🎯</div><div class="start-here-title">Start by Setting Up a Client</div>
            <div class="start-here-text">Configure your client's profile — age, exchange amount, risk tolerance, and property preferences — to unlock personalized DST matching and suitability scores across all ${fs.length} offerings.</div>
            <button class="btn btn-primary" onclick="openProfileModal()">⚙️ Set Up Client Profile</button>
          </div>
        `}
      </div>
    </div>`;
}

function clearClient() { STATE.client = {}; saveClient(); updateClientBadge(); renderApp(); toast('Client cleared'); }

/* ═══════════════════════════════════════════
   BROWSE VIEW
═══════════════════════════════════════════ */
function getFilteredFunds() {
  const f = STATE.browseFilters;
  let funds = [...STATE.funds];
  if (f.status !== 'all') funds = funds.filter(x => x.status === f.status);
  if (f.propType !== 'all') funds = funds.filter(x => x.propType.toLowerCase().includes(f.propType.toLowerCase()));
  if (f.sponsor !== 'all') funds = funds.filter(x => x.sponsor === f.sponsor);
  if (f.sector !== 'all') funds = funds.filter(x => x.sector === f.sector);
  if (f.focus !== 'all') funds = funds.filter(x => x.focus === f.focus);
  if (f.cocMin) funds = funds.filter(x => x.y1coc != null && x.y1coc >= parseFloat(f.cocMin));
  if (f.cocMax) funds = funds.filter(x => x.y1coc != null && x.y1coc <= parseFloat(f.cocMax));
  if (f.clientEquity && STATE.client.exchangeAmount) funds = funds.filter(x => x.minInvest && x.minInvest <= STATE.client.exchangeAmount);
  if (f.quickDst) funds = funds.filter(x => (x.propType || '').toLowerCase().includes('dst') || (x._raw && STATE.headers && (() => { const ci = STATE.headers.findIndex(h => h.trim() === 'Offering Structure'); return ci >= 0 && x._raw[ci] && String(x._raw[ci].v || x._raw[ci].f || '').toLowerCase().includes('dst'); })()));
  if (f.quickNoDebt) funds = funds.filter(x => { const ltv = x.ltv; const raw = String(x.debtTerms || '').toLowerCase(); return (ltv != null && Math.abs(ltv) < 0.01) || raw.includes('no debt') || raw.includes('all cash') || raw.includes('all-cash'); });
  if (f.quickUpreit) funds = funds.filter(x => String(x.upReit || '').toLowerCase().includes('721 only'));
  if (f.search) { let s = f.search.toLowerCase(); funds = funds.filter(x => x.name.toLowerCase().includes(s) || x.sponsor.toLowerCase().includes(s) || x.propType.toLowerCase().includes(s) || x.location.toLowerCase().includes(s)); }
  const sortMap = {
    y1coc_desc: (a, b) => (b.y1coc || 0) - (a.y1coc || 0),
    y1coc_asc: (a, b) => (a.y1coc || 0) - (b.y1coc || 0),
    ltv_asc: (a, b) => (a.ltv || 999) - (b.ltv || 999),
    ltv_desc: (a, b) => (b.ltv || 0) - (a.ltv || 0),
    min_asc: (a, b) => (a.minInvest || 999999) - (b.minInvest || 999999),
    name_asc: (a, b) => a.name.localeCompare(b.name),
    status: (a, b) => { const o = { 'Open': 0, 'Closing': 1, 'Coming Soon': 2 }; return (o[a.status] || 9) - (o[b.status] || 9); }
  };
  funds.sort(sortMap[STATE.browseSort] || sortMap.y1coc_desc);
  return funds;
}

function renderBrowse() {
  const funds = getFilteredFunds();
  const sponsors = [...new Set(STATE.funds.map(f => f.sponsor).filter(Boolean))].sort();
  const propTypes = [...new Set(STATE.funds.map(f => f.propType).filter(Boolean))].sort();
  const sectors = [...new Set(STATE.funds.map(f => f.sector).filter(Boolean))].sort();
  const focuses = [...new Set(STATE.funds.map(f => f.focus).filter(Boolean))].sort();
  const f = STATE.browseFilters;
  const activeFilters = [];
  if (f.status !== 'all') activeFilters.push({ label: f.status, key: 'status' });
  if (f.propType !== 'all') activeFilters.push({ label: f.propType, key: 'propType' });
  if (f.sponsor !== 'all') activeFilters.push({ label: f.sponsor, key: 'sponsor' });
  if (f.sector !== 'all') activeFilters.push({ label: f.sector, key: 'sector' });
  if (f.focus !== 'all') activeFilters.push({ label: f.focus, key: 'focus' });
  if (f.cocMin || f.cocMax) activeFilters.push({ label: `CoC ${f.cocMin || '0'}–${f.cocMax || '∞'}%`, key: 'coc' });
  if (f.clientEquity) activeFilters.push({ label: 'Fits Exchange', key: 'clientEquity' });
  if (f.quickDst) activeFilters.push({ label: 'DST Only', key: 'quickDst' });
  if (f.quickNoDebt) activeFilters.push({ label: 'No Debt', key: 'quickNoDebt' });
  if (f.quickUpreit) activeFilters.push({ label: '721 UpREIT Only', key: 'quickUpreit' });

  const filterHtml = `
    <div class="filter-bar">
      <input class="search-input" placeholder="Search offerings..." value="${f.search}" oninput="STATE.browseFilters.search=this.value;renderApp()">
      <select class="filter-select" onchange="STATE.browseFilters.status=this.value;renderApp()">
        <option value="all" ${f.status === 'all' ? 'selected' : ''}>All Status</option>
        <option value="Open" ${f.status === 'Open' ? 'selected' : ''}>Open</option>
        <option value="Closing" ${f.status === 'Closing' ? 'selected' : ''}>Closing</option>
        <option value="Coming Soon" ${f.status === 'Coming Soon' ? 'selected' : ''}>Coming Soon</option>
      </select>
      <select class="filter-select" onchange="STATE.browseFilters.propType=this.value;renderApp()">
        <option value="all" ${f.propType === 'all' ? 'selected' : ''}>All Types</option>
        ${propTypes.map(p => `<option value="${p}" ${f.propType === p ? 'selected' : ''}>${p}</option>`).join('')}
      </select>
      <select class="filter-select" onchange="STATE.browseFilters.sponsor=this.value;renderApp()">
        <option value="all" ${f.sponsor === 'all' ? 'selected' : ''}>All Sponsors</option>
        ${sponsors.map(s => `<option value="${s}" ${f.sponsor === s ? 'selected' : ''}>${s}</option>`).join('')}
      </select>
      <select class="filter-select" onchange="STATE.browseFilters.sector=this.value;renderApp()">
        <option value="all" ${f.sector === 'all' ? 'selected' : ''}>All Sectors</option>
        ${sectors.map(s => `<option value="${s}" ${f.sector === s ? 'selected' : ''}>${s}</option>`).join('')}
      </select>
      <select class="filter-select" onchange="STATE.browseFilters.focus=this.value;renderApp()">
        <option value="all" ${f.focus === 'all' ? 'selected' : ''}>All Focus</option>
        ${focuses.map(s => `<option value="${s}" ${f.focus === s ? 'selected' : ''}>${s}</option>`).join('')}
      </select>
    </div>
    <div class="quick-filter-bar">
      <span class="quick-filter-label">Quick Filters</span>
      <button class="quick-filter-btn ${f.quickDst ? 'active' : ''}" onclick="STATE.browseFilters.quickDst=!STATE.browseFilters.quickDst;renderApp()">DST Only</button>
      <button class="quick-filter-btn ${f.quickNoDebt ? 'active' : ''}" onclick="STATE.browseFilters.quickNoDebt=!STATE.browseFilters.quickNoDebt;renderApp()">No Debt</button>
      <button class="quick-filter-btn ${f.quickUpreit ? 'active' : ''}" onclick="STATE.browseFilters.quickUpreit=!STATE.browseFilters.quickUpreit;renderApp()">721 UpREIT Only</button>
    </div>
    <div class="filter-row-2">
      <div class="range-filter"><span>CoC</span><input placeholder="min" value="${f.cocMin}" oninput="STATE.browseFilters.cocMin=this.value;renderApp()"><span>–</span><input placeholder="max" value="${f.cocMax}" oninput="STATE.browseFilters.cocMax=this.value;renderApp()"><span>%</span></div>
      ${STATE.client.exchangeAmount ? `<div class="equity-filter ${f.clientEquity ? 'active' : ''}" onclick="STATE.browseFilters.clientEquity=!STATE.browseFilters.clientEquity;renderApp()">💰 Fits ${fmtMoney(STATE.client.exchangeAmount)}</div>` : ''}
      <div style="flex:1"></div>
      <select class="sort-select" onchange="STATE.browseSort=this.value;renderApp()">
        <option value="y1coc_desc" ${STATE.browseSort === 'y1coc_desc' ? 'selected' : ''}>CoC: High → Low</option>
        <option value="y1coc_asc" ${STATE.browseSort === 'y1coc_asc' ? 'selected' : ''}>CoC: Low → High</option>
        <option value="ltv_asc" ${STATE.browseSort === 'ltv_asc' ? 'selected' : ''}>LTV: Low → High</option>
        <option value="ltv_desc" ${STATE.browseSort === 'ltv_desc' ? 'selected' : ''}>LTV: High → Low</option>
        <option value="min_asc" ${STATE.browseSort === 'min_asc' ? 'selected' : ''}>Min Invest: Low → High</option>
        <option value="name_asc" ${STATE.browseSort === 'name_asc' ? 'selected' : ''}>Name: A → Z</option>
        <option value="status" ${STATE.browseSort === 'status' ? 'selected' : ''}>Status</option>
      </select>
      <div class="view-toggle-group">
        <button class="view-toggle-btn ${STATE.browseLayout === 'card' ? 'active' : ''}" onclick="STATE.browseLayout='card';renderApp()">▦</button>
        <button class="view-toggle-btn ${STATE.browseLayout === 'table' ? 'active' : ''}" onclick="STATE.browseLayout='table';renderApp()">☰</button>
      </div>
    </div>`;

  const resultBar = `<div class="result-bar"><span class="result-count">${funds.length}</span> offerings${activeFilters.length ? ' · <span class="active-filter-chips">' + activeFilters.map(a => `<span class="filter-chip">${a.label}<button onclick="clearFilter('${a.key}')">✕</button></span>`).join('') + '</span>' : ''}</div>`;

  let listHtml = '';
  if (STATE.browseLayout === 'card') {
    listHtml = `<div class="offering-grid">${funds.map((fund, i) => renderOfferingCard(fund, i)).join('')}</div>`;
  } else {
    listHtml = renderOfferingTable(funds);
  }

  return `<div class="page-header"><div><div class="page-title">Browse Offerings</div><div class="page-subtitle">All active DST offerings from approved sponsors</div></div></div>${filterHtml}${resultBar}${listHtml}`;
}

function clearFilter(key) {
  if (key === 'coc') { STATE.browseFilters.cocMin = ''; STATE.browseFilters.cocMax = ''; }
  else if (key === 'clientEquity') STATE.browseFilters.clientEquity = false;
  else if (key === 'quickDst') STATE.browseFilters.quickDst = false;
  else if (key === 'quickNoDebt') STATE.browseFilters.quickNoDebt = false;
  else if (key === 'quickUpreit') STATE.browseFilters.quickUpreit = false;
  else STATE.browseFilters[key] = 'all';
  renderApp();
}

function renderOfferingCard(fund, i) {
  const inBasket = STATE.basket.includes(fund.id);
  const statusCls = fund.status === 'Open' ? 'open' : fund.status === 'Closing' ? 'closing' : 'coming';
  const pctRaised = fund.pctRaised; const pctRemaining = fund.pctRemaining;
  return `
    <div class="offering-card card-enter" style="animation-delay:${Math.min(i * 0.04, 0.5)}s" onclick="navigateTo('offering_detail',${fund.id})">
      <div class="card-status-strip ${statusCls}"></div>
      <div class="offering-card-header">
        <div><div class="offering-name">${fund.name}</div><div class="offering-sponsor">${fund.sponsor}</div></div>
        <span class="badge badge-${statusCls === 'open' ? 'green' : statusCls === 'closing' ? 'amber' : 'blue'}">${fund.status}</span>
      </div>
      ${fund.location ? `<div class="offering-location">📍 ${fund.location}</div>` : ''}
      <div class="offering-metrics">
        <div class="offering-metric-item"><div class="label">Y1 CoC</div><div class="value">${fmtPct(fund.y1coc)}</div>${peerDelta(fund.y1coc, STATE.peer.avgY1CoC)}</div>
        <div class="offering-metric-item"><div class="label">LTV</div><div class="value">${fmtPct(fund.ltv)}</div>${peerDelta(fund.ltv, STATE.peer.avgLTV)}</div>
        <div class="offering-metric-item"><div class="label">Min Invest</div><div class="value">${fmtMoney(fund.minInvest)}</div></div>
        <div class="offering-metric-item"><div class="label">Hold</div><div class="value">${fund.holdPeriod ? fund.holdPeriod + ' yr' : '—'}</div></div>
      </div>
      <div class="offering-badges"><span class="badge badge-navy">${fund.propType || 'DST'}</span>${fund.occupancy ? `<span class="badge badge-green">${fmtPct(fund.occupancy)} Occupied</span>` : ''}</div>
      <div class="offering-card-footer">
        ${pctRemaining != null ? `<div style="flex:1"><div style="font-size:11px;color:var(--slate2)">${pctRemaining}% remaining${fund.equityRemaining ? ' · ' + fmtMoney(fund.equityRemaining) : ''}</div><div class="raise-bar"><div class="raise-fill" style="width:${Math.min(100 - pctRemaining, 100)}%"></div></div></div>` : '<div style="flex:1"></div>'}
        <button class="btn btn-sm ${inBasket ? 'btn-primary' : 'btn-secondary'}" onclick="event.stopPropagation();toggleBasket(${fund.id})">${inBasket ? '✓ In Basket' : '+ Basket'}</button>
      </div>
    </div>`;
}

function renderOfferingTable(funds) {
  const rows = funds.map(f => `
    <tr onclick="navigateTo('offering_detail',${f.id})">
      <td class="name-cell"><div>${f.name}</div><div style="font-size:11px;font-weight:400;color:var(--slate2)">${f.sponsor}</div></td>
      <td><span class="badge badge-${f.status === 'Open' ? 'green' : f.status === 'Closing' ? 'amber' : 'blue'}">${f.status}</span></td>
      <td>${f.propType}</td>
      <td class="num-cell ${f.y1coc && STATE.peer.avgY1CoC && f.y1coc > STATE.peer.avgY1CoC ? 'highlight-green' : ''}">${fmtPct(f.y1coc)}</td>
      <td class="num-cell ${f.ltv && f.ltv > 65 ? 'highlight-red' : ''}">${fmtPct(f.ltv)}</td>
      <td class="num-cell">${fmtMoney(f.minInvest)}</td>
      <td class="num-cell">${f.holdPeriod ? f.holdPeriod + 'yr' : '—'}</td>
      <td class="num-cell">${fmtPct(f.occupancy)}</td>
      <td><button class="btn btn-sm ${STATE.basket.includes(f.id) ? 'btn-primary' : 'btn-secondary'}" onclick="event.stopPropagation();toggleBasket(${f.id})">${STATE.basket.includes(f.id) ? '✓' : '+'}</button></td>
    </tr>`).join('');
  return `<div class="table-wrapper"><table class="offering-table"><thead><tr><th>Offering</th><th>Status</th><th>Type</th><th>Y1 CoC</th><th>LTV</th><th>Min</th><th>Hold</th><th>Occ</th><th></th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

function toggleBasket(id) {
  const idx = STATE.basket.indexOf(id);
  if (idx >= 0) { STATE.basket.splice(idx, 1); }
  else { if (STATE.basket.length >= 3) { toast('Maximum 3 offerings. Remove one first.', 'error'); return; } STATE.basket.push(id); }
  saveBasket(); renderApp();
  toast(idx >= 0 ? 'Removed from basket' : 'Added to basket');
}

/* ═══════════════════════════════════════════
   STEP 5: OFFERING DETAIL VIEW (ENHANCED)
═══════════════════════════════════════════ */
function renderOfferingDetail() {
  const fund = STATE.funds.find(f => f.id === STATE.selectedOfferingId);
  if (!fund) return `<div class="empty-state"><div class="empty-state-icon">🔍</div><h3>No Offering Selected</h3><p>Select an offering from Browse or Dashboard.</p><button class="btn btn-primary" onclick="navigateTo('browse')">Browse Offerings</button></div>`;

  const inBasket = STATE.basket.includes(fund.id);
  const p = STATE.peer;
  const curIdx = STATE.funds.findIndex(f => f.id === fund.id);
  const prevFund = curIdx > 0 ? STATE.funds[curIdx - 1] : null;
  const nextFund = curIdx < STATE.funds.length - 1 ? STATE.funds[curIdx + 1] : null;

  // ── Navigation strip ──
  const navStrip = `
    <div class="detail-nav-strip">
      <div class="breadcrumb">
        <span style="cursor:pointer;text-decoration:underline" onclick="navigateTo('browse')">Browse</span>
        <span>›</span>
        <span class="crumb-name">${fund.name}</span>
      </div>
      <div class="detail-prev-next">
        <button ${prevFund ? `onclick="navigateTo('offering_detail',${prevFund.id})"` : 'disabled'}>← ${prevFund ? prevFund.name.substring(0, 18) : 'Prev'}</button>
        <button ${nextFund ? `onclick="navigateTo('offering_detail',${nextFund.id})"` : 'disabled'}>${nextFund ? nextFund.name.substring(0, 18) : 'Next'} →</button>
      </div>
    </div>`;

  // ── Hero Header ──
  const statusCls = fund.status === 'Open' ? 'green' : fund.status === 'Closing' ? 'amber' : 'blue';
  const heroTiles = [
    { label: 'Y1 Cash on Cash', value: fmtPct(fund.y1coc), delta: peerDelta(fund.y1coc, p.avgY1CoC) },
    { label: 'Loan to Value', value: fmtPct(fund.ltv), delta: peerDelta(fund.ltv, p.avgLTV) },
    { label: 'Min Investment', value: fmtMoney(fund.minInvest), delta: '' },
    { label: 'Hold Period', value: fund.holdPeriod ? fund.holdPeriod + ' yr' : '—', delta: '' }
  ];
  const hero = `
    <div class="panel detail-section" style="background:linear-gradient(135deg,var(--navy) 0%,var(--navy2) 100%);color:var(--white);border:none">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px;flex-wrap:wrap;gap:10px">
        <div><div style="font-size:22px;font-weight:800;letter-spacing:-0.02em">${fund.name}</div>
          <div style="font-size:13px;color:rgba(255,255,255,0.55);margin-top:3px">${fund.sponsor}${fund.location ? ' · ' + fund.location : ''}</div></div>
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <span class="badge badge-${statusCls}">${fund.status}</span>
          <span class="badge badge-navy">${fund.propType || 'DST'}</span>
        </div>
      </div>
      <div class="metric-grid" style="grid-template-columns:repeat(4,1fr)">
        ${heroTiles.map(t => `<div class="metric-tile" style="background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.12)"><div class="metric-label" style="color:rgba(255,255,255,0.5)">${t.label}</div><div class="metric-value" style="color:#fff">${t.value}</div>${t.delta ? `<div style="margin-top:3px">${t.delta}</div>` : ''}</div>`).join('')}
      </div>
    </div>`;

  // ── Document Buttons & Action Bar ──
  const docBtns = [
    { label: 'Brochure', url: fund.brochureUrl, icon: '📄' },
    { label: 'PPM', url: fund.ppmUrl, icon: '📋' },
    { label: 'Track Record', url: fund.trackRecordUrl, icon: '📊' },
    { label: 'Sales Team', url: fund.salesTeamUrl, icon: '👥' },
    { label: 'Video', url: fund.videoUrl, icon: '🎬' },
    { label: 'Sponsor News', url: fund.sponsorNewsUrl, icon: '📰' },
    { label: 'AI Chat', url: fund.aiChatUrl, icon: '🤖' }
  ];
  const docRow = `<div class="doc-btn-row"><span class="doc-label">Documents</span>${docBtns.map(d => `<button class="btn btn-sm btn-secondary" ${d.url ? `onclick="window.open('${d.url}','_blank')"` : 'disabled style="opacity:0.4"'}>${d.icon} ${d.label}</button>`).join('')}</div>`;
  const actionBar = `<div class="action-bar">
    <button class="btn ${inBasket ? 'btn-primary' : 'btn-secondary'}" onclick="toggleBasket(${fund.id})">${inBasket ? '✓ In Basket' : '🛒 Add to Basket'}</button>
    <button class="btn btn-secondary" onclick="toast('Portfolio Builder coming Phase 2','error')">📐 Build Portfolio</button>
    <button class="btn btn-secondary" onclick="toast('Model coming Phase 2','error')">🧮 Model for Client</button>
    <button class="btn btn-ghost" onclick="toast('Compliance Report coming Phase 2','error')">🛡️ Compliance Report</button>
  </div>`;

  // ── Raise Progress & Timeline ──
  const pctRaised = fund.pctRaised; const pctRemaining = fund.pctRemaining;
  const daysRemaining = fund.closeDate ? Math.max(0, Math.round((fund.closeDate - new Date()) / 86400000)) : null;
  const totalDays = (fund.openDate && fund.closeDate) ? Math.max(1, Math.round((fund.closeDate - fund.openDate) / 86400000)) : null;
  const pctTimeElapsed = (totalDays && daysRemaining != null) ? Math.round(((totalDays - daysRemaining) / totalDays) * 100) : null;
  const pctTimeRemaining = pctTimeElapsed != null ? (100 - pctTimeElapsed) : null;
  const raiseSection = `
    <div class="panel detail-section">
      <div class="panel-title">\u{1F4CA} Raise Progress & Timeline</div>
      <div style="display:grid;gap:24px">
        <div>
          <div style="font-size:12px;font-weight:700;color:var(--slate);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:10px">Capital Raise</div>
          ${pctRemaining != null ? `
            <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px">
              <span style="font-weight:700;color:var(--navy)">${pctRemaining}% Remaining</span>
              <span style="color:var(--slate2)">${100 - pctRemaining}% Raised</span>
            </div>
            <div class="raise-bar" style="height:14px;border-radius:7px"><div class="raise-fill" style="width:${Math.min(100 - pctRemaining, 100)}%;border-radius:7px"></div></div>
            <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:12px;color:var(--slate)">
              <div style="display:flex;gap:14px;flex-wrap:wrap">
                ${fund.equityRemaining ? `<span>Remaining: <strong style="color:var(--navy)">${fmtMoney(fund.equityRemaining)}</strong></span>` : ''}
                ${fund.currentRaise ? `<span>Current Raise: <strong>${fmtMoney(fund.currentRaise)}</strong></span>` : ''}
              </div>
              <div>Filed Raise: <strong>${fmtMoney(fund.filedRaise)}</strong></div>
            </div>
          ` : '<div style="font-size:13px;color:var(--slate2)">Raise data not available</div>'}
        </div>
        <div>
          <div style="font-size:12px;font-weight:700;color:var(--slate);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:10px">Offering Timeline</div>
          ${pctTimeRemaining != null ? `
            <div style="display:flex;justify-content:space-between;font-size:13px;margin-bottom:6px">
              <span style="font-weight:700;color:var(--navy)">${daysRemaining} Days Remaining</span>
              <span style="color:var(--slate2)">${fund.monthsOnMarket ? fund.monthsOnMarket + ' months on market' : pctTimeElapsed + '% elapsed'}</span>
            </div>
            <div class="timeline-bar" style="height:14px;border-radius:7px"><div class="timeline-fill" style="width:${Math.min(pctTimeElapsed, 100)}%;border-radius:7px"></div></div>
            <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:12px;color:var(--slate)">
              <span>Opened: <strong>${fund.openDate ? fund.openDate.toLocaleDateString() : '\u2014'}</strong></span>
              ${fund.monthsOnMarket ? `<span>On Market: <strong>${fund.monthsOnMarket} mo</strong></span>` : ''}
              <span>Est. Close: <strong>${fund.closeDate ? fund.closeDate.toLocaleDateString() : '\u2014'}</strong></span>
            </div>
          ` : `
            <div style="font-size:13px;color:var(--slate2)">
              ${fund.openDate ? 'Opened: <strong>' + fund.openDate.toLocaleDateString() + '</strong>' : ''}
              ${fund.monthsOnMarket ? ' \u00B7 On Market: <strong>' + fund.monthsOnMarket + ' mo</strong>' : ''}
              ${fund.closeDate ? ' \u00B7 Est. Close: <strong>' + fund.closeDate.toLocaleDateString() + '</strong>' : 'Timeline data not available'}
            </div>
          `}
        </div>
      </div>
    </div>`;




  // ── Purchase Price & Valuation ──
  const valDiscount = (fund.appraisedValue && fund.purchasePrice) ? ((fund.appraisedValue - fund.purchasePrice) / fund.appraisedValue * 100) : null;
  const valSection = `
    <div class="panel detail-section">
      <div class="panel-title">🏷️ Purchase Price & Valuation</div>
      ${valDiscount != null ? `
        <div class="val-callout ${valDiscount > 0 ? 'discount' : 'premium'}" style="margin-bottom:14px">
          <div class="val-pct">${valDiscount > 0 ? '-' : '+'}${Math.abs(valDiscount).toFixed(1)}%</div>
          <div>${valDiscount > 0 ? 'Purchased below appraised value — built-in equity' : 'Purchased above appraised value — loaded pricing'}</div>
        </div>` : ''}
      <div class="metric-grid" style="grid-template-columns:repeat(3,1fr)">
        <div class="metric-tile"><div class="metric-label">Purchase Price</div><div class="metric-value" style="font-size:18px">${fmtMoney(fund.purchasePrice)}</div></div>
        <div class="metric-tile"><div class="metric-label">Appraised Value</div><div class="metric-value" style="font-size:18px">${fmtMoney(fund.appraisedValue)}</div></div>
        <div class="metric-tile"><div class="metric-label">Loaded Price</div><div class="metric-value" style="font-size:18px">${fmtMoney(fund.loadedPrice)}</div></div>
      </div>
      ${fund.pricePerUnit || fund.pricePerSqFt ? `
        <div style="display:flex;gap:16px;margin-top:12px">
          ${fund.pricePerUnit ? `<div style="font-size:12.5px;color:var(--slate)">Price/Unit: <strong>${fmtMoney(fund.pricePerUnit)}</strong></div>` : ''}
          ${fund.pricePerSqFt ? `<div style="font-size:12.5px;color:var(--slate)">Price/SF: <strong>${fmtMoney(fund.pricePerSqFt)}</strong></div>` : ''}
          ${fund.units ? `<div style="font-size:12.5px;color:var(--slate)">Units: <strong>${fund.units}</strong></div>` : ''}
        </div>` : ''}
    </div>`;

  // ── Debt & Lease Terms ──
  const debtSection = `
    <div class="panel detail-section">
      <div class="panel-title">🏦 Debt & Lease Terms</div>
      <div class="detail-two-col">
        <div>
          <div class="metric-grid" style="grid-template-columns:1fr 1fr;gap:10px">
            <div class="metric-tile"><div class="metric-label">LTV</div><div class="metric-value" style="font-size:18px">${fmtPct(fund.ltv)}</div>${peerDelta(fund.ltv, p.avgLTV)}</div>
            <div class="metric-tile"><div class="metric-label">DSCR (Base)</div><div class="metric-value" style="font-size:18px">${fund.dscr ? fmtNum(fund.dscr, 2) + 'x' : '—'}</div></div>
            <div class="metric-tile"><div class="metric-label">DSCR (Stress)</div><div class="metric-value" style="font-size:18px">${fund.dscrStress ? fmtNum(fund.dscrStress, 2) + 'x' : '—'}</div></div>
            <div class="metric-tile"><div class="metric-label">Hold Period</div><div class="metric-value" style="font-size:18px">${fund.holdPeriod ? fund.holdPeriod + ' yr' : '—'}</div></div>
          </div>
        </div>
        <div>
          <div class="metric-grid" style="grid-template-columns:1fr 1fr;gap:10px">
            <div class="metric-tile"><div class="metric-label">Avg Lease Term</div><div class="metric-value" style="font-size:18px">${fund.avgLeaseTerm ? fmtNum(fund.avgLeaseTerm, 1) + ' yr' : '—'}</div>${peerDelta(fund.avgLeaseTerm, p.avgLeaseTerm, ' yr')}</div>
            <div class="metric-tile"><div class="metric-label">Occupancy</div><div class="metric-value" style="font-size:18px">${fmtPct(fund.occupancy)}</div>${peerDelta(fund.occupancy, p.avgOccupancy)}</div>
            <div class="metric-tile" style="grid-column:1/-1"><div class="metric-label">Tenant Credit</div><div class="metric-value" style="font-size:14px">${fund.tenantCredit || '—'}</div></div>
          </div>
        </div>
      </div>
    </div>`;

  // ── Key Drivers ──
  const drivers = generateKeyDrivers(fund);
  const keyDriversSection = drivers.length ? `
    <div class="panel detail-section">
      <div class="panel-title">⚡ Key Drivers</div>
      <div class="kd-grid">${drivers.map(d => `<div class="kd-item ${d.cls}"><span class="kd-icon">${d.icon}</span><div>${d.text}</div></div>`).join('')}</div>
    </div>` : '';

  // ── Projected Annual Distributions (Chart.js) ──
  const hasIncome = fund.income.some(v => v != null);
  const chartSection = hasIncome ? `
    <div class="panel detail-section">
      <div class="panel-title">📈 Projected Annual Distributions</div>
      <div class="detail-chart-wrap"><canvas id="income-chart"></canvas></div>
    </div>` : '';

  // ── 8-Year Projections Table ──
  const projYears = fund.income.map((v, i) => v != null ? i : -1).filter(i => i >= 0);
  const maxProj = Math.min(projYears.length, 8);
  const projSection = maxProj > 1 ? `
    <div class="panel detail-section">
      <div class="panel-title">📊 Distribution Projections</div>
      <table class="proj-table">
        <thead><tr><th></th>${projYears.slice(0, maxProj).map((yi, idx) => `<th class="${idx === 0 ? 'highlight' : ''}">Year ${yi + 1}</th>`).join('')}</tr></thead>
        <tbody>
          <tr><td>CoC Return</td>${projYears.slice(0, maxProj).map((yi, idx) => `<td class="${idx === 0 ? 'highlight' : ''}">${fmtPct(fund.income[yi])}</td>`).join('')}</tr>
          ${STATE.client.exchangeAmount ? `<tr><td>Est. Distribution</td>${projYears.slice(0, maxProj).map((yi, idx) => `<td class="${idx === 0 ? 'highlight' : ''}">${fund.income[yi] != null ? fmtMoney(STATE.client.exchangeAmount * fund.income[yi] / 100) : '—'}</td>`).join('')}</tr>
          <tr><td>Cumulative</td>${projYears.slice(0, maxProj).map((yi, idx) => { let cum = 0; for (let j = 0; j <= idx; j++) { let yj = projYears[j]; if (fund.income[yj] != null) cum += STATE.client.exchangeAmount * fund.income[yj] / 100; } return `<td class="${idx === 0 ? 'highlight' : ''}">${fmtMoney(cum)}</td>`; }).join('')}</tr>` : ''}
        </tbody>
      </table>
    </div>` : '';

  // ── Key Takeaways ──
  const takeaways = generateTakeaways(fund);
  const takeawaySection = takeaways.length ? `
    <div class="panel detail-section">
      <div class="panel-title">🎯 Key Takeaways</div>
      <div style="display:grid;gap:8px">${takeaways.map(t => `<div style="display:flex;align-items:flex-start;gap:8px;font-size:13px;line-height:1.6;color:var(--navy)"><span style="flex-shrink:0;color:var(--blue)">▸</span><span>${t}</span></div>`).join('')}</div>
    </div>` : '';

  // ── AI Narrative Sections ──
  const narrativeOverview = generateNarrativeOverview(fund);
  const narrativeProperty = generateNarrativeProperty(fund);
  const narrativeFinancial = generateNarrativeFinancial(fund);

  const narrativeSections = `
    <div class="panel detail-section"><div class="panel-title">🤖 AI Overview</div><div style="font-size:13px;line-height:1.75;color:var(--navy)">${narrativeOverview}</div></div>
    <div class="detail-two-col detail-section">
      <div class="panel"><div class="panel-title">🏢 Property & Market</div><div style="font-size:13px;line-height:1.75;color:var(--navy)">${narrativeProperty}</div></div>
      <div class="panel"><div class="panel-title">💰 Financial Structure</div><div style="font-size:13px;line-height:1.75;color:var(--navy)">${narrativeFinancial}</div></div>
    </div>`;

  // ── Q&A (Phase 2 locked) ──
  const qaSection = `
    <div class="panel detail-section" style="opacity:0.5">
      <div class="panel-title">💬 Q&A — Coming Phase 2</div>
      <div style="text-align:center;padding:20px;font-size:13px;color:var(--slate2)">AI-powered Q&A will be available in the next release. Ask any question about this offering's structure, risks, or suitability.</div>
    </div>`;

  // ── Sponsor Track Record ──
  const sponsorSection = `
    <div class="panel detail-section">
      <div class="panel-title">🏛️ Sponsor Track Record — ${fund.sponsor}</div>
      <div style="font-size:13px;line-height:1.75;color:var(--navy)">${generateSponsorNarrative(fund)}</div>
    </div>`;

  return navStrip + hero + docRow + actionBar + raiseSection + valSection + debtSection + keyDriversSection + chartSection + projSection + takeawaySection + narrativeSections + qaSection + sponsorSection;
}

/* ═══════════════════════════════════════════
   KEY DRIVERS & TAKEAWAYS GENERATORS
═══════════════════════════════════════════ */
function generateKeyDrivers(fund) {
  const d = [];
  const p = STATE.peer;

  // Income signal
  if (fund.y1coc != null && p.avgY1CoC != null) {
    if (fund.y1coc >= p.avgY1CoC + 1) d.push({ cls: 'positive', icon: '📈', text: `Y1 CoC of ${fmtPct(fund.y1coc)} exceeds peer average (${fmtPct(p.avgY1CoC)}) — above-market yield` });
    else if (fund.y1coc >= p.avgY1CoC - 0.5) d.push({ cls: 'info', icon: '📊', text: `Y1 CoC of ${fmtPct(fund.y1coc)} is in-line with peer average (${fmtPct(p.avgY1CoC)})` });
    else d.push({ cls: 'caution', icon: '📉', text: `Y1 CoC of ${fmtPct(fund.y1coc)} trails peer average (${fmtPct(p.avgY1CoC)}) — below-market entry yield` });
  }

  // Leverage
  if (fund.ltv != null) {
    if (fund.ltv > 70) d.push({ cls: 'risk', icon: '⚠️', text: `LTV of ${fmtPct(fund.ltv)} indicates high leverage — reduced debt cushion in a downturn` });
    else if (fund.ltv > 60) d.push({ cls: 'caution', icon: '🔶', text: `Moderate leverage at ${fmtPct(fund.ltv)} LTV — within typical DST range` });
    else d.push({ cls: 'positive', icon: '🛡️', text: `Conservative leverage at ${fmtPct(fund.ltv)} LTV — strong downside protection` });
  }

  // DSCR
  if (fund.dscr != null) {
    if (fund.dscr < 1.15) d.push({ cls: 'risk', icon: '🚨', text: `DSCR of ${fmtNum(fund.dscr, 2)}x is thin — limited margin to cover debt service` });
    else if (fund.dscr < 1.30) d.push({ cls: 'caution', icon: '📐', text: `DSCR of ${fmtNum(fund.dscr, 2)}x provides adequate but not generous debt coverage` });
    else d.push({ cls: 'positive', icon: '✅', text: `Strong DSCR of ${fmtNum(fund.dscr, 2)}x — healthy margin above debt service requirements` });
  }

  // Occupancy
  if (fund.occupancy != null) {
    if (fund.occupancy >= 95) d.push({ cls: 'positive', icon: '🏢', text: `${fmtPct(fund.occupancy)} occupied — stabilized income stream with minimal vacancy risk` });
    else if (fund.occupancy >= 85) d.push({ cls: 'info', icon: '🔵', text: `${fmtPct(fund.occupancy)} occupancy — healthy but with some lease-up potential` });
    else d.push({ cls: 'caution', icon: '⚡', text: `${fmtPct(fund.occupancy)} occupancy — elevated vacancy risk, requires lease-up execution` });
  }

  // Valuation
  if (fund.appraisedValue && fund.purchasePrice) {
    const disc = ((fund.appraisedValue - fund.purchasePrice) / fund.appraisedValue * 100);
    if (disc > 2) d.push({ cls: 'positive', icon: '🏷️', text: `Purchased at ${disc.toFixed(1)}% below appraised value — built-in equity cushion` });
    else if (disc < -2) d.push({ cls: 'caution', icon: '💲', text: `Purchase price exceeds appraisal by ${Math.abs(disc).toFixed(1)}% — loaded pricing above market value` });
  }

  // Hold period vs client age
  if (fund.holdPeriod && STATE.client.age) {
    const endAge = STATE.client.age + fund.holdPeriod;
    if (endAge > 85) d.push({ cls: 'caution', icon: '⏳', text: `${fund.holdPeriod}-year hold extends to client age ${endAge} — consider liquidity needs` });
    else if (endAge > 75) d.push({ cls: 'info', icon: '📅', text: `${fund.holdPeriod}-year hold period ends at client age ${endAge}` });
    else d.push({ cls: 'positive', icon: '⏱️', text: `${fund.holdPeriod}-year hold is well within client's investment horizon (age ${endAge} at exit)` });
  }

  // Raise momentum
  const pctRaised = fund.pctRaised; const pctRemaining = fund.pctRemaining;
  if (pctRaised != null) {
    if (pctRaised >= 85) d.push({ cls: 'caution', icon: '🔥', text: `${pctRaised}% raised — limited equity remaining, act promptly if interested` });
    else if (pctRaised >= 50) d.push({ cls: 'info', icon: '📊', text: `${pctRaised}% raised — moderate market adoption, equity still available` });
  }

  return d;
}

function generateTakeaways(fund) {
  const t = [];
  const p = STATE.peer;

  if (fund.y1coc != null && p.avgY1CoC != null) {
    const diff = fund.y1coc - p.avgY1CoC;
    t.push(`Year 1 cash-on-cash of ${fmtPct(fund.y1coc)} is ${Math.abs(diff).toFixed(1)}% ${diff >= 0 ? 'above' : 'below'} the current peer average of ${fmtPct(p.avgY1CoC)} across ${p.count} active DST offerings.`);
  }

  if (fund.ltv != null && p.avgLTV != null) {
    t.push(`Leverage of ${fmtPct(fund.ltv)} LTV ${fund.ltv < p.avgLTV ? 'is below' : 'exceeds'} the peer average of ${fmtPct(p.avgLTV)}, ${fund.ltv <= 55 ? 'reflecting a conservative capital structure.' : fund.ltv <= 65 ? 'within the typical DST range.' : 'indicating an above-average debt load.'}`);
  }

  if (fund.occupancy != null) {
    t.push(`Occupancy of ${fmtPct(fund.occupancy)} ${fund.occupancy >= 95 ? 'suggests a fully stabilized asset with predictable cash flows.' : fund.occupancy >= 85 ? 'is healthy with minor upside from lease-up.' : 'presents elevated vacancy risk but potential upside as leasing improves.'}`);
  }

  if (fund.dscr != null) {
    t.push(`Debt service coverage ratio of ${fmtNum(fund.dscr, 2)}x ${fund.dscr >= 1.3 ? 'provides a strong buffer against income disruption.' : fund.dscr >= 1.15 ? 'offers adequate protection.' : 'is slim — income disruptions could stress debt service.'}`);
  }

  if (STATE.client.exchangeAmount && fund.minInvest) {
    const pctOfExchange = (fund.minInvest / STATE.client.exchangeAmount * 100).toFixed(0);
    t.push(`Minimum investment of ${fmtMoney(fund.minInvest)} represents ${pctOfExchange}% of the client's ${fmtMoney(STATE.client.exchangeAmount)} 1031 exchange — ${parseInt(pctOfExchange) <= 25 ? 'allowing significant diversification across multiple DSTs.' : parseInt(pctOfExchange) <= 50 ? 'allowing room for one or two additional positions.' : 'consuming a large share of available equity.'}`);
  }

  return t;
}

/* ═══════════════════════════════════════════
   AI NARRATIVE GENERATORS (Template-based)
═══════════════════════════════════════════ */
function generateNarrativeOverview(fund) {
  const statusText = fund.status === 'Open' ? 'currently open for investment' : fund.status === 'Closing' ? 'in its final closing phase' : 'coming soon to market';
  return `<strong>${fund.name}</strong> is a ${fund.propType || 'real estate'} Delaware Statutory Trust offering sponsored by <strong>${fund.sponsor}</strong>, ${statusText}. ${fund.location ? `The property is located in <strong>${fund.location}</strong>, ` : ''}${fund.totalRaise ? `with a total equity raise of <strong>${fmtMoney(fund.totalRaise)}</strong>` : ''}${fund.minInvest ? ` and a minimum investment of <strong>${fmtMoney(fund.minInvest)}</strong>` : ''}.
  ${fund.y1coc ? `<br><br>The offering targets a Year 1 cash-on-cash return of <strong>${fmtPct(fund.y1coc)}</strong>` : ''}${fund.holdPeriod ? ` over a projected <strong>${fund.holdPeriod}-year</strong> hold period` : ''}${fund.avgCoc ? `, with an average projected CoC of <strong>${fmtPct(fund.avgCoc)}</strong> across the hold` : ''}.
  ${fund.ltv ? ` The capital structure incorporates <strong>${fmtPct(fund.ltv)}</strong> loan-to-value leverage` : ''}${fund.dscr ? ` with a debt service coverage ratio of <strong>${fmtNum(fund.dscr, 2)}x</strong>` : ''}.`;
}

function generateNarrativeProperty(fund) {
  let text = '';
  if (fund.propType) text += `This is a <strong>${fund.propType}</strong> asset`;
  if (fund.location) text += ` situated in <strong>${fund.location}</strong>`;
  if (fund.units) text += `, comprising <strong>${fund.units} units</strong>`;
  if (fund.sqft) text += `${fund.units ? ' totaling' : ', encompassing'} approximately <strong>${fmtMoney(fund.sqft)} square feet</strong>`;
  text += '. ';
  if (fund.occupancy) text += `The property is currently <strong>${fmtPct(fund.occupancy)} occupied</strong>, ${fund.occupancy >= 95 ? 'reflecting a fully stabilized income stream.' : fund.occupancy >= 85 ? 'indicating healthy tenant demand with minor vacancy.' : 'suggesting lease-up potential that could drive income growth.'}`;
  if (fund.avgLeaseTerm) text += ` Average remaining lease term is <strong>${fmtNum(fund.avgLeaseTerm, 1)} years</strong>, ${fund.avgLeaseTerm >= 7 ? 'providing excellent cash flow visibility.' : fund.avgLeaseTerm >= 4 ? 'offering moderate income predictability.' : 'which introduces near-term rollover risk.'}`;
  if (fund.tenantCredit) text += ` Tenant credit profile: <strong>${fund.tenantCredit}</strong>.`;
  return text || 'Property and market details will be available when data is complete.';
}

function generateNarrativeFinancial(fund) {
  let text = '';
  if (fund.purchasePrice) text += `The property was acquired for <strong>${fmtMoney(fund.purchasePrice)}</strong>`;
  if (fund.appraisedValue) {
    const disc = ((fund.appraisedValue - fund.purchasePrice) / fund.appraisedValue * 100);
    text += ` against an appraised value of <strong>${fmtMoney(fund.appraisedValue)}</strong>, representing a <strong>${disc > 0 ? disc.toFixed(1) + '% discount' : Math.abs(disc).toFixed(1) + '% premium'}</strong> to appraised value`;
  }
  text += '. ';
  if (fund.ltv) text += `Leverage is set at <strong>${fmtPct(fund.ltv)} LTV</strong>`;
  if (fund.dscr) text += `, generating a base DSCR of <strong>${fmtNum(fund.dscr, 2)}x</strong>`;
  if (fund.dscrStress) text += ` (${fmtNum(fund.dscrStress, 2)}x under stress)`;
  text += '. ';
  const hasIncome = fund.income.some(v => v != null);
  if (hasIncome) {
    const yrs = fund.income.filter(v => v != null);
    const minY = Math.min(...yrs);
    const maxY = Math.max(...yrs);
    text += `Projected distributions range from <strong>${fmtPct(minY)}</strong> to <strong>${fmtPct(maxY)}</strong> across the hold period`;
    if (fund.income[0] && fund.income[yrs.length - 1]) {
      const trend = fund.income[yrs.length - 1] - fund.income[0];
      text += `, showing a <strong>${trend > 0 ? 'rising' : trend < 0 ? 'declining' : 'flat'} distribution trajectory</strong>`;
    }
    text += '.';
  }
  return text || 'Financial structure details will be available when data is complete.';
}

function generateSponsorNarrative(fund) {
  let text = `<strong>${fund.sponsor}</strong> is a DST program sponsor active on the Alts Fund Link platform.`;
  if (fund.sponsorAum) text += ` The firm manages approximately <strong>${fund.sponsorAum}</strong> in assets under management.`;
  if (fund.sponsorOfferings) text += ` They have launched <strong>${fund.sponsorOfferings}</strong> offerings`;
  if (fund.sponsorExits) text += ` with <strong>${fund.sponsorExits}</strong> full-cycle exits to date.`;
  else text += '.';
  if (fund.sponsorAvgIrr) text += ` Historical average IRR is <strong>${fmtPct(fund.sponsorAvgIrr)}</strong>`;
  if (fund.sponsorBestIrr) text += ` (best: ${fmtPct(fund.sponsorBestIrr)}`;
  if (fund.sponsorWorstIrr) text += `, worst: ${fmtPct(fund.sponsorWorstIrr)})`;
  else if (fund.sponsorBestIrr) text += ')';
  if (fund.sponsorAvgIrr) text += '.';
  if (fund.sponsorExperience) text += `<br><br><strong>Experience:</strong> ${fund.sponsorExperience}`;
  if (fund.trackRecordUrl) text += '<br><br>Detailed track record documentation is available via the document links above.';
  return text;
}

/* ═══════════════════════════════════════════
   INCOME CHART (Chart.js)
═══════════════════════════════════════════ */
function renderIncomeChart(fund) {
  const ctx = document.getElementById('income-chart');
  if (!ctx) return;

  // Destroy previous chart instance
  if (STATE.incomeChart) { STATE.incomeChart.destroy(); STATE.incomeChart = null; }

  const labels = [];
  const data = [];
  fund.income.forEach((v, i) => {
    if (v != null) { labels.push('Y' + (i + 1)); data.push(v); }
  });
  if (!data.length) return;

  const peerAvg = STATE.peer.avgY1CoC;

  STATE.incomeChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'CoC Return %',
          data: data,
          backgroundColor: data.map((v, i) => i === 0 ? '#1C3A63' : '#3B82F6'),
          borderRadius: 4,
          borderSkipped: false,
          barPercentage: 0.65
        },
        ...(peerAvg ? [{
          label: 'Peer Avg',
          data: data.map(() => peerAvg),
          type: 'line',
          borderColor: '#F59E0B',
          borderDash: [6, 3],
          borderWidth: 2,
          pointRadius: 0,
          fill: false,
          order: 0
        }] : [])
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { intersect: false, mode: 'index' },
      plugins: {
        legend: {
          display: !!peerAvg,
          position: 'top',
          align: 'end',
          labels: { boxWidth: 12, font: { family: "'DM Sans'", size: 11 }, color: '#5C7A99' }
        },
        tooltip: {
          backgroundColor: '#0B1F3B',
          titleFont: { family: "'DM Sans'", size: 12 },
          bodyFont: { family: "'DM Mono'", size: 12 },
          padding: 10,
          cornerRadius: 8,
          callbacks: {
            label: function(ctx) {
              if (ctx.dataset.label === 'Peer Avg') return 'Peer Avg: ' + ctx.raw.toFixed(2) + '%';
              let line = ctx.raw.toFixed(2) + '%';
              if (STATE.client.exchangeAmount) line += ' (' + fmtMoney(STATE.client.exchangeAmount * ctx.raw / 100) + '/yr)';
              return line;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: v => v + '%', font: { family: "'DM Mono'", size: 11 }, color: '#8FA3BA' },
          grid: { color: '#E8F0F8' },
          border: { display: false }
        },
        x: {
          ticks: { font: { family: "'DM Sans'", size: 11, weight: 600 }, color: '#3A5270' },
          grid: { display: false },
          border: { display: false }
        }
      }
    }
  });
}

/* ═══════════════════════════════════════════
   BASKET VIEW
═══════════════════════════════════════════ */
/* ═══════════════════════════════════════════
   BASKET VIEW — Tear Sheet Integration
   Ported from standalone Basket Builder
═══════════════════════════════════════════ */

// ── Basket utilities ──
const BV = {};
BV.escapeHTML = (s) => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
BV.isNum = (x) => typeof x === 'number' && isFinite(x);
BV.clamp = (n, a, b) => Math.max(a, Math.min(b, n));
BV.fmtDate = (d) => (d instanceof Date && !isNaN(d.getTime())) ? d.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'2-digit' }) : '—';
BV.fmtPct = (p, digits) => BV.isNum(p) ? p.toFixed(digits ?? 2) + '%' : '—';
BV.fmtMoney = (n) => { if (!BV.isNum(n)) return '—'; const a = Math.abs(n); if (a >= 1e9) return '$' + (n/1e9).toFixed(2) + 'B'; if (a >= 1e6) return '$' + (n/1e6).toFixed(3) + 'M'; if (a >= 1e3) return '$' + (n/1e3).toFixed(1) + 'K'; return '$' + n.toFixed(0); };
BV.fmtMoneyFull = (n) => { if (!BV.isNum(n)) return '—'; try { return new Intl.NumberFormat(undefined, { style:'currency', currency:'USD', maximumFractionDigits:0 }).format(n); } catch(e) { return '$' + Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ','); } };
BV.normalizeHeader = (s) => String(s ?? '').toLowerCase().replace(/\s+/g, ' ').replace(/[^a-z0-9%#()$\/\- ]+/g, '').trim();
BV.uniqSorted = (arr) => Array.from(new Set(arr.map(x => String(x||'').trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
BV.parseNumberLoose = (v) => { if (v == null) return null; if (typeof v === 'number') return isFinite(v) ? v : null; const s = String(v).trim(); if (!s || /^na$/i.test(s)) return null; const m = s.replace(/,/g,'').match(/-?\d+(\.\d+)?/); return m ? parseFloat(m[0]) : null; };
BV.parsePercent = (v) => { if (v == null) return null; if (typeof v === 'number') { if (!isFinite(v)) return null; if (Math.abs(v) <= 1) return v * 100; return v; } const s0 = String(v).trim(); if (!s0 || /^na$/i.test(s0)) return null; const s = s0.replace(/,/g, ''); if (/%/.test(s)) { const m = s.match(/-?\d+(\.\d+)?/); if (!m) return null; const num = parseFloat(m[0]); if (!isFinite(num)) return null; return num; } const m = s.match(/-?\d+(\.\d+)?/); if (!m) return null; const num = parseFloat(m[0]); if (!isFinite(num)) return null; if (Math.abs(num) <= 1) return num * 100; return num; };
BV.parseMoney = (v) => { if (v == null) return null; if (typeof v === 'number') return isFinite(v) ? v : null; const s0 = String(v).trim(); if (!s0 || /^na$/i.test(s0)) return null; const s = s0.replace(/,/g, ''); const m = s.match(/-?\$?\s*(\d+(\.\d+)?)(\s*[kKmMbB])?/); if (!m) return null; let num = parseFloat(m[1]); const suf = (m[3]||'').trim().toUpperCase(); if (suf === 'K') num *= 1e3; if (suf === 'M') num *= 1e6; if (suf === 'B') num *= 1e9; return isFinite(num) ? num : null; };
BV.parseDate = (v) => { if (v == null) return null; if (v instanceof Date) return isNaN(v.getTime()) ? null : v; if (typeof v === 'number' && isFinite(v)) { if (v > 1e11) { const d = new Date(v); return isNaN(d.getTime()) ? null : d; } const base = new Date(Date.UTC(1899,11,30)); const d = new Date(base.getTime() + v * 86400000); return isNaN(d.getTime()) ? null : d; } const s = String(v).trim(); if (!s || /^na$/i.test(s)) return null; const m = s.match(/(?:Date|Datetime)\(\s*([^)]+)\s*\)/i); if (m) { const parts = m[1].split(',').map(x=>parseInt(x.trim(),10)).filter(x=>!isNaN(x)); if (parts.length >= 3) { const d = new Date(parts[0], parts[1], parts[2]); return isNaN(d.getTime()) ? null : d; } } const d = new Date(s); return isNaN(d.getTime()) ? null : d; };
BV.parseHoldPeriodYears = (v) => { if (v == null) return null; const s = String(v).trim().toLowerCase(); if (!s || s === 'na') return null; const range = s.match(/(\d+(\.\d+)?)\s*(to|\-)\s*(\d+(\.\d+)?)/); if (range) return (parseFloat(range[1]) + parseFloat(range[4])) / 2; const single = s.match(/(\d+(\.\d+)?)/); return single ? parseFloat(single[1]) : null; };
BV.normalizeDocUrl = (u) => { u = String(u || '').trim(); if (!u || /^na$/i.test(u)) return ''; const openId = u.match(/drive\.google\.com\/open\?id=([^&]+)/i); if (openId) return 'https://drive.google.com/file/d/' + openId[1] + '/view'; const fileId = u.match(/drive\.google\.com\/file\/d\/([^\/]+)/i); if (fileId) return 'https://drive.google.com/file/d/' + fileId[1] + '/view'; if (/^www\./i.test(u)) return 'https://' + u; if (!/^https?:\/\//i.test(u) && /\./.test(u)) return 'https://' + u; return u; };

// ── State extraction helpers ──
BV.STATE_ABBR = new Set(["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY","DC"]);
BV.STATE_NAME_TO_ABBR = {"ALABAMA":"AL","ALASKA":"AK","ARIZONA":"AZ","ARKANSAS":"AR","CALIFORNIA":"CA","COLORADO":"CO","CONNECTICUT":"CT","DELAWARE":"DE","FLORIDA":"FL","GEORGIA":"GA","HAWAII":"HI","IDAHO":"ID","ILLINOIS":"IL","INDIANA":"IN","IOWA":"IA","KANSAS":"KS","KENTUCKY":"KY","LOUISIANA":"LA","MASSACHUSETTS":"MA","MARYLAND":"MD","MAINE":"ME","MICHIGAN":"MI","MINNESOTA":"MN","MISSISSIPPI":"MS","MISSOURI":"MO","MONTANA":"MT","NEBRASKA":"NE","NEVADA":"NV","NEW HAMPSHIRE":"NH","NEW JERSEY":"NJ","NEW MEXICO":"NM","NEW YORK":"NY","NORTH CAROLINA":"NC","NORTH DAKOTA":"ND","OHIO":"OH","OKLAHOMA":"OK","OREGON":"OR","PENNSYLVANIA":"PA","RHODE ISLAND":"RI","SOUTH CAROLINA":"SC","SOUTH DAKOTA":"SD","TENNESSEE":"TN","TEXAS":"TX","UTAH":"UT","VERMONT":"VT","VIRGINIA":"VA","WASHINGTON":"WA","WEST VIRGINIA":"WV","WISCONSIN":"WI","WYOMING":"WY","DISTRICT OF COLUMBIA":"DC"};
BV.extractStates = (locationText) => { const s = String(locationText ?? '').toUpperCase(); if (!s || s === 'NA') return []; const found = new Set(); const abbrMatches = s.match(/\b[A-Z]{2}\b/g) || []; for (const ab of abbrMatches) { if (BV.STATE_ABBR.has(ab)) found.add(ab); } for (const [name, ab] of Object.entries(BV.STATE_NAME_TO_ABBR)) { if (s.includes(name)) found.add(ab); } return Array.from(found).filter(x => x !== 'AK' && x !== 'HI').sort(); };
BV.summarizeStates = (states, max) => { max = max || 6; const arr = BV.uniqSorted(states); if (!arr.length) return '—'; if (arr.length <= max) return arr.join(', '); return arr.slice(0, max).join(', ') + '…'; };
BV.pctDelta = (a, b) => { if (!BV.isNum(a) || !BV.isNum(b) || b === 0) return null; return (a - b) / b * 100; };
BV.moneyDelta = (a, b) => { if (!BV.isNum(a) || !BV.isNum(b)) return null; return a - b; };

BV.iconSvg = (type) => { const common = 'width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"'; const wrap = (inner) => '<span class="ico"><svg ' + common + '>' + inner + '</svg></span>'; const icons = { brochure: wrap('<path d="M14 2H7a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7z"/><path d="M14 2v5h5"/><path d="M9 13h6"/><path d="M9 17h6"/>'), ppm: wrap('<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/><path d="M8 6h8"/><path d="M8 10h8"/>'), video: wrap('<path d="M15 10l4.5-2.5v9L15 14"/><rect x="3" y="7" width="12" height="10" rx="2" ry="2"/>'), ai_offering_chat: wrap('<path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/><path d="M8 9h8"/><path d="M8 13h6"/>'), track_record: wrap('<path d="M3 3v18h18"/><path d="M7 14l3-3 3 2 5-6"/>'), sponsor_news: wrap('<rect x="3" y="4" width="18" height="16" rx="2"/><path d="M7 8h10"/><path d="M7 12h6"/><path d="M7 16h8"/>'), sales_team_map: wrap('<path d="M21 10c0 6-9 12-9 12S3 16 3 10a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>') }; return icons[type] || wrap('<circle cx="12" cy="12" r="9"/>'); };

// ── Percentile rank ──
BV.lowerBound = (arr, x) => { let lo = 0, hi = arr.length; while (lo < hi) { const mid = (lo + hi) >> 1; if (arr[mid] < x) lo = mid + 1; else hi = mid; } return lo; };
BV.upperBound = (arr, x) => { let lo = 0, hi = arr.length; while (lo < hi) { const mid = (lo + hi) >> 1; if (arr[mid] <= x) lo = mid + 1; else hi = mid; } return lo; };
BV.percentileRank = (sorted, x) => { if (!sorted || !sorted.length || !BV.isNum(x)) return null; const n = sorted.length; const lo = BV.lowerBound(sorted, x); const hi = BV.upperBound(sorted, x); return BV.clamp((lo + 0.5 * (hi - lo)) / n * 100, 0, 100); };
BV.ordinal = (n) => { n = Math.round(n); const v = n % 100; const s = ['th','st','nd','rd']; return n + (s[(v-20)%10] || s[v] || s[0]); };
BV.pctileText = (p) => p == null ? '' : BV.ordinal(p) + ' pctile';

// ── Adapter: convert platform fund → basket fund format ──
BV.adaptFund = (f) => {
  if (!f) return null;
  const parseCellValue = (cell) => { if (!cell) return ''; if (cell.p && typeof cell.p === 'object') { for (const k of ['link','url','href','hyperlink']) { if (typeof cell.p[k] === 'string' && cell.p[k].trim()) return cell.p[k].trim(); } } const v = cell.v; const fmt = cell.f; if (typeof v === 'number' && isFinite(v)) return v; if (v instanceof Date && !isNaN(v.getTime())) return v; if (typeof v === 'string' && v.trim()) return v.trim(); if (typeof fmt === 'string' && fmt.trim() !== '') return fmt.trim(); if (v == null) return ''; return v; };

  // Build raw row array from _raw cells
  const rawRow = f._raw ? f._raw.map(parseCellValue) : [];

  const m = {};
  m.year1_coc = f.y1coc;
  m.ltv = f.ltv;
  m.cap_rate = f.acqCapRate;
  m.hold_period_years = f.holdPeriod;
  m.minimum_investment = f.minInvest;
  m.pct_leased = f.occupancy;
  m.num_assets = f.units;
  m.rent_escalations = BV.parseNumberLoose(f.rentEscalations);
  m.avg_lease_term_remaining = f.avgLeaseTerm;
  m.purchase_price_unloaded = f.purchasePrice;
  m.appraised_valuation = f.appraisedValue;
  m.loaded_price = f.loadedPrice;
  m.filed_raise = f.filedRaise;
  m.current_raise = f.currentRaise;
  m.remaining_raise = f.equityRemaining;
  m.pct_raise_remaining = f.pctRemaining;
  m.offering_open = f.openDate;
  m.offering_close = f.closeDate;
  m.states = BV.extractStates(f.location);
  for (let i = 1; i <= 10; i++) m['income_y' + i] = f.income[i - 1];

  return {
    id: f.id,
    sponsor: f.sponsor,
    offering_name: f.name,
    displayLabel: f.sponsor + ' — ' + f.name,
    asset_class: f.propType,
    sector_focus: f.sector || f.focus || '',
    offering_structure: f.propType,
    distribution_frequency: f.distFrequency,
    debt_terms: f.debtTerms,
    lease_terms: f.leaseTerms,
    preferred: f.preferred,
    promote: f.promote,
    upreit_721: f.upReit,
    gp_commit: f.gpCommit,
    property_locations: f.location,
    year_built_avg: f.buildingAge,
    metrics: m,
    docs: {
      brochure: BV.normalizeDocUrl(f.brochureUrl),
      ppm: BV.normalizeDocUrl(f.ppmUrl),
      video: BV.normalizeDocUrl(f.videoUrl),
      ai_offering_chat: BV.normalizeDocUrl(f.aiChatUrl),
      track_record: BV.normalizeDocUrl(f.trackRecordUrl),
      sponsor_news: BV.normalizeDocUrl(f.sponsorNewsUrl),
      sales_team_map: BV.normalizeDocUrl(f.salesTeamUrl)
    },
    __rawRow: rawRow
  };
};

// ── Peer stats for basket ──
BV.PEER_KEYS = ['year1_coc','ltv','hold_period_years','minimum_investment','pct_leased','rent_escalations','avg_lease_term_remaining','num_assets','purchase_price_unloaded','appraised_valuation','loaded_price','cap_rate'];
BV.SNAPSHOT_KEYS = ['year1_coc','ltv','hold_period_years','minimum_investment','pct_leased','rent_escalations','avg_lease_term_remaining','num_assets'];
BV.INCOME_KEYS = Array.from({length:10}, (_,i) => 'income_y' + (i+1));
BV.DISCLOSURES = 'For informational purposes only. This material does not constitute investment advice, an offer to sell, or a solicitation of an offer to buy any security or interest. Figures are shown as provided in the underlying data source and may be incomplete, unaudited, or subject to change. Verify all information with official offering documents and your firm\'s compliance requirements. Peer averages shown are simple averages of the currently listed offerings in the data set (excluding blanks/NA). For Broker Dealer and Investment Advisor home office due diligence use only. Always validate data with official offering documents and compliance requirements. Alts Fund LINK, LLC is not responsible for data errors or omissions.';

BV.computePeerStats = (allFunds) => {
  const stats = {}; const dist = {};
  for (const key of BV.PEER_KEYS) {
    const vals = allFunds.map(f => f.metrics?.[key]).filter(BV.isNum);
    if (!vals.length) continue;
    stats[key] = { avg: vals.reduce((a,b)=>a+b,0)/vals.length, min: Math.min(...vals), max: Math.max(...vals), n: vals.length };
    dist[key] = vals.slice().sort((a,b)=>a-b);
  }
  return { stats, dist };
};

BV.metricLabel = (key) => {
  const labels = { year1_coc:'Year 1 Cash-on-Cash', ltv:'Loan-to-Value (LTV)', hold_period_years:'Hold Period', minimum_investment:'Minimum Investment (Sum)', pct_leased:'Occupancy (% Leased)', rent_escalations:'Rent Escalations', avg_lease_term_remaining:'Avg Lease Term Remaining', num_assets:'# Assets', purchase_price_unloaded:'Purchase Price (Unloaded)', appraised_valuation:'Appraised Valuation', loaded_price:'Loaded Price', cap_rate:'Acquisition Cap Rate' };
  if (/^income_y\d+$/.test(key)) return 'Client Income (%) — Year ' + key.match(/\d+/)[0];
  return labels[key] || key;
};

BV.metricFormatter = (key, val) => {
  if (!BV.isNum(val)) return '—';
  if (key === 'minimum_investment') return BV.fmtMoney(val);
  if (key === 'hold_period_years' || key === 'avg_lease_term_remaining') return val.toFixed(1) + ' yrs';
  if (key === 'num_assets') return Math.round(val) + '';
  if (key === 'purchase_price_unloaded' || key === 'appraised_valuation' || key === 'loaded_price') return BV.fmtMoney(val);
  return BV.fmtPct(val, 2);
};

BV.coverageForKey = (funds, key) => { const total = funds.length; const present = funds.map(f => f.metrics?.[key]).filter(BV.isNum).length; return { total, present, missing: Math.max(0, total - present) }; };
BV.covText = (cov) => (!cov || !cov.total) ? '' : cov.present + '/' + cov.total;
BV.covBadgeHtml = (cov) => { if (!cov || !cov.total) return ''; const warn = cov.missing > 0 ? ' warn' : ''; const title = cov.missing > 0 ? 'Missing ' + cov.missing + ' of ' + cov.total + ' data points' : 'All ' + cov.total + ' selected have data'; return '<span class="mCov' + warn + '" title="' + BV.escapeHTML(title) + '">Data ' + BV.escapeHTML(BV.covText(cov)) + '</span>'; };

BV.peerVsLine = (key, val, peer, cov) => {
  const p = peer.stats[key];
  const covPart = (cov && cov.total) ? ' • <span class="pctl">Data ' + BV.escapeHTML(BV.covText(cov)) + '</span>' : '';
  if (!p || !BV.isNum(val) || !BV.isNum(p.avg)) return 'Peer avg: —' + covPart;
  const d = val - p.avg;
  const cls = d >= 0 ? 'pos' : 'neg';
  let deltaStr = '';
  if (key === 'minimum_investment' || key === 'purchase_price_unloaded' || key === 'appraised_valuation' || key === 'loaded_price') deltaStr = (d>=0?'+':'−') + BV.fmtMoney(Math.abs(d));
  else if (key === 'hold_period_years' || key === 'avg_lease_term_remaining') deltaStr = (d>=0?'+':'−') + Math.abs(d).toFixed(2) + ' yrs';
  else if (key === 'num_assets') deltaStr = (d>=0?'+':'−') + Math.abs(d).toFixed(0);
  else deltaStr = (d>=0?'+':'−') + Math.abs(d).toFixed(2) + ' pts';
  const pctl = BV.percentileRank(peer.dist[key], val);
  const pctlHtml = pctl == null ? '' : ' • <span class="pctl">' + BV.escapeHTML(BV.pctileText(pctl)) + '</span>';
  return 'Peer avg: ' + BV.escapeHTML(BV.metricFormatter(key, p.avg)) + ' • <span class="delta ' + cls + '">' + BV.escapeHTML(deltaStr) + '</span>' + pctlHtml + covPart;
};

// ── Aggregation ──
BV.aggregate = (selectedFunds) => {
  const n = selectedFunds.length;
  const agg = { __isAggregate: n > 1, selectedCount: n, displayLabel: n === 1 ? selectedFunds[0].displayLabel : 'Selected Offerings (' + n + ')', sponsor: n === 1 ? selectedFunds[0].sponsor : '', offering_name: n === 1 ? selectedFunds[0].offering_name : '', asset_class: n === 1 ? selectedFunds[0].asset_class : '', sector_focus: n === 1 ? selectedFunds[0].sector_focus : '', offering_structure: n === 1 ? selectedFunds[0].offering_structure : '', distribution_frequency: n === 1 ? selectedFunds[0].distribution_frequency : '', debt_lease_list: selectedFunds.map(f => ({ label: f.displayLabel, debt_terms: f.debt_terms, lease_terms: f.lease_terms })), docs_list: selectedFunds.map(f => ({ label: f.displayLabel, docs: f.docs })), property_states: BV.uniqSorted(selectedFunds.flatMap(f => (f.metrics?.states || []))), property_locations_summary: BV.summarizeStates(selectedFunds.flatMap(f => (f.metrics?.states || []))), metrics: {}, coverage: {} };

  const allKeys = [...new Set([...BV.PEER_KEYS, ...BV.SNAPSHOT_KEYS, 'filed_raise', 'current_raise', 'remaining_raise', 'cap_rate', ...BV.INCOME_KEYS])];
  for (const key of allKeys) {
    const cov = BV.coverageForKey(selectedFunds, key);
    agg.coverage[key] = cov;
    const vals = selectedFunds.map(f => f.metrics?.[key]).filter(BV.isNum);
    agg.metrics[key] = key === 'minimum_investment' ? (vals.length ? vals.reduce((a,b)=>a+b,0) : null) : (vals.length ? vals.reduce((a,b)=>a+b,0) / vals.length : null);
  }
  if (n === 1) { agg.metrics.offering_open = selectedFunds[0].metrics.offering_open; agg.metrics.offering_close = selectedFunds[0].metrics.offering_close; agg.metrics.filed_raise = selectedFunds[0].metrics.filed_raise; agg.metrics.current_raise = selectedFunds[0].metrics.current_raise; agg.metrics.remaining_raise = selectedFunds[0].metrics.remaining_raise; } else { agg.metrics.offering_open = null; agg.metrics.offering_close = null; }
  return agg;
};

// ── Insights ──
BV.buildInsights = (agg, selectedFunds, peer) => {
  const takeaways = [], considerations = [];
  const m = agg.metrics; const n = selectedFunds.length;
  const cov = (key) => agg.coverage?.[key] || { total:n, present:0, missing:n };
  const covMark = (key) => { const c = cov(key); return c.missing > 0 ? ' (Data ' + c.present + '/' + c.total + ')' : ''; };

  if (BV.isNum(m.ltv)) { const p = peer.stats.ltv; if (p && BV.isNum(p.avg)) { const delta = m.ltv - p.avg; takeaways.push('Loan-to-value (LTV) is ' + (delta <= 0 ? 'below' : 'above') + ' the current peer average (' + BV.fmtPct(m.ltv,2) + ' vs ' + BV.fmtPct(p.avg,2) + ').' + covMark('ltv')); } }

  const addVsPeer = (key, dir, friendly) => {
    const p = peer.stats[key]; const v = m[key]; const c = cov(key);
    if (!p || !BV.isNum(v) || !BV.isNum(p.avg)) { if (c.missing > 0) considerations.push(friendly + ' has missing data (Data ' + c.present + '/' + c.total + ').'); return; }
    const delta = v - p.avg;
    const th = { year1_coc:0.50, ltv:5.0, hold_period_years:1.0, minimum_investment:25000, pct_leased:5.0, rent_escalations:0.25, avg_lease_term_remaining:0.5, num_assets:1 }[key] ?? 0;
    if (Math.abs(delta) < th) return;
    const up = delta > 0; const suffix = c.missing > 0 ? ' (Data ' + c.present + '/' + c.total + ')' : '';
    if (dir === 'higher_is_better' && up) takeaways.push(friendly + ' is above the current peer average (' + BV.metricFormatter(key, v) + ' vs ' + BV.metricFormatter(key, p.avg) + ').' + suffix);
    else if (dir === 'higher_is_better' && !up) considerations.push(friendly + ' is below the current peer average (' + BV.metricFormatter(key, v) + ' vs ' + BV.metricFormatter(key, p.avg) + ').' + suffix);
    else if (dir === 'lower_is_better' && !up) takeaways.push(friendly + ' is below the current peer average (' + BV.metricFormatter(key, v) + ' vs ' + BV.metricFormatter(key, p.avg) + ').' + suffix);
    else if (dir === 'lower_is_better' && up) considerations.push(friendly + ' is above the current peer average (' + BV.metricFormatter(key, v) + ' vs ' + BV.metricFormatter(key, p.avg) + ').' + suffix);
  };
  addVsPeer('year1_coc','higher_is_better','Year 1 cash-on-cash');
  addVsPeer('minimum_investment','lower_is_better','Minimum investment (sum)');
  addVsPeer('pct_leased','higher_is_better','Occupancy (% leased)');
  addVsPeer('rent_escalations','higher_is_better','Rent escalations');
  addVsPeer('avg_lease_term_remaining','higher_is_better','Avg lease term remaining');
  if (!agg.__isAggregate) { const close = selectedFunds[0].metrics.offering_close; if (close instanceof Date && !isNaN(close.getTime())) { const days = (close.getTime() - Date.now()) / (1000*60*60*24); if (days <= 45 && days >= -365) considerations.push('Offering close date is near (' + BV.fmtDate(close) + '). Confirm allocation availability.'); } }
  const st = agg.property_states || [];
  if (st.length) takeaways.push('Property footprint includes ' + st.length + ' state' + (st.length===1?'':'s') + ' (' + st.join(', ') + ').');
  return { takeaways: takeaways.slice(0,6), considerations: considerations.slice(0,6) };
};

// ── Render: Status Module ──
BV.renderStatusModule = (singleFund) => {
  const m = singleFund.metrics;
  const filed = m.filed_raise; const current = m.current_raise; const remaining = m.remaining_raise;
  const filledRatio = (BV.isNum(filed) && filed > 0 && BV.isNum(current)) ? BV.clamp(current/filed, 0, 1) : null;
  const filledPct = BV.isNum(filledRatio) ? (filledRatio*100).toFixed(1) + '%' : '—';
  const filledLine = filledPct === '—' ? '—' : filledPct + ' raised';
  const openD = m.offering_open; const closeD = m.offering_close; const now = new Date();
  let timeRemRatio = null;
  if (openD instanceof Date && closeD instanceof Date && !isNaN(openD.getTime()) && !isNaN(closeD.getTime()) && closeD > openD) { timeRemRatio = BV.clamp((closeD - now) / (closeD - openD), 0, 1); }
  const timePct = BV.isNum(timeRemRatio) ? (timeRemRatio*100).toFixed(1) + '%' : '—';
  const timeLine = timePct === '—' ? '—' : timePct + ' left';
  let daysLeftText = '—';
  if (openD instanceof Date && closeD instanceof Date && closeD > openD) { const days = Math.max(0, Math.ceil((closeD - now) / 86400000)); daysLeftText = days + ' day' + (days===1?'':'s'); }
  const raiseH = BV.isNum(filledRatio) ? Math.round(filledRatio*100) : 0;
  const winH = BV.isNum(timeRemRatio) ? Math.round(timeRemRatio*100) : 0;
  const e = BV.escapeHTML;
  return '<div class="hdrStatusWrap"><div class="vStat" title="Raise Progress"><div class="vTrack"><div class="vFill" style="height:'+raiseH+'%"></div></div><div class="vInfo"><div class="vHdr"><div class="k">Raise</div></div><div class="vList"><div class="vLine"><b>'+e(filledLine)+'</b></div><div class="vLine"><b>Filed:</b> '+e(BV.fmtMoney(filed))+'</div><div class="vLine"><b>Curr:</b> '+e(BV.fmtMoney(current))+'</div><div class="vLine"><b>Rem:</b> '+e(BV.fmtMoney(remaining))+'</div></div></div></div><div class="vStat" title="Raise Window"><div class="vTrack"><div class="vFill" style="height:'+winH+'%"></div></div><div class="vInfo"><div class="vHdr"><div class="k">Raise Window</div></div><div class="vList"><div class="vLine"><b>'+e(timeLine)+'</b></div><div class="vLine"><b>Open:</b> '+e(BV.fmtDate(openD))+'</div><div class="vLine"><b>Close:</b> '+e(BV.fmtDate(closeD))+'</div><div class="vLine"><b>Days left:</b> '+e(daysLeftText)+'</div></div></div></div></div>';
};

// ── Render: Purchase Valuation ──
BV.renderPurchaseValuation = (agg) => {
  const m = agg.metrics; const e = BV.escapeHTML;
  const unloaded = m.purchase_price_unloaded; const loaded = m.loaded_price; const appraised = m.appraised_valuation;
  const primaryPct = BV.pctDelta(unloaded, appraised); const primary$ = BV.moneyDelta(unloaded, appraised);
  const loadComp$ = BV.moneyDelta(loaded, unloaded); const loadCompPct = (BV.isNum(loadComp$) && BV.isNum(unloaded) && unloaded !== 0) ? (loadComp$ / unloaded * 100) : null;
  const isDiscount = BV.isNum(primaryPct) ? (primaryPct <= 0) : null;
  const heroClass = isDiscount == null ? '' : (isDiscount ? ' good' : ' bad');
  const heroWord = isDiscount == null ? '—' : (isDiscount ? 'Discount to Appraisal' : 'Premium to Appraisal');
  const heroPctStr = BV.isNum(primaryPct) ? (primaryPct<=0?'−':'+')+Math.abs(primaryPct).toFixed(1)+'%' : '—';
  const hero$Str = BV.isNum(primary$) ? (primary$<=0?'−':'+')+BV.fmtMoney(Math.abs(primary$)) : '—';
  const secPctStr = BV.isNum(loadCompPct) ? (loadCompPct>=0?'+':'−')+Math.abs(loadCompPct).toFixed(1)+'%' : '—';
  const sec$Str = BV.isNum(loadComp$) ? (loadComp$>=0?'+':'−')+BV.fmtMoney(Math.abs(loadComp$)) : '—';
  const explain = isDiscount == null ? 'Provide Purchase Price and Appraised Valuation to compute premium/discount.' : (isDiscount ? 'Purchase price is below the reported appraisal (favorable entry point).' : 'Purchase price is above the reported appraisal (confirm underwriting assumptions).');
  return '<div class="sec"><div class="secHdr"><div class="h">Purchase Price & Valuation</div><div class="hint">Advisor headline: purchase discount/premium vs appraisal</div></div><div class="secBody"><div class="valHero"><div class="calloutRow"><div class="heroCall'+heroClass+'"><div class="heroTop"><div class="heroK">Purchase Price (Unloaded) vs Appraised Valuation</div><span class="r-pill">Primary client message</span></div><div class="heroMain">'+e(heroWord)+'</div><div class="heroSub"><b>'+e(heroPctStr)+'</b> ('+e(hero$Str)+') vs appraisal</div><div class="heroMeta"><span class="kv"><b>Appraised:</b> '+e(BV.fmtMoney(appraised))+'</span><span class="kv"><b>Purchase:</b> '+e(BV.fmtMoney(unloaded))+'</span></div><div class="textBlock" style="font-size:11px;color:rgba(9,14,25,0.62)">'+e(explain)+'</div></div><div class="miniCall"><div class="k">Client Load</div><div class="v">'+e(sec$Str)+' <span style="font-size:12px;color:rgba(9,14,25,0.62);font-weight:850">('+e(secPctStr)+')</span></div><div class="s"><b>Loaded Price:</b> '+e(BV.fmtMoney(loaded))+'<br>Loaded minus Unloaded purchase price.</div></div></div><div class="textBlock" style="font-size:11px;color:rgba(9,14,25,0.58)">Tip: Advisors can say: "We\'re buying at a <b>'+e(heroPctStr)+'</b> ('+e(hero$Str)+') discount/premium to the reported appraisal."</div></div></div></div>';
};

// ── Render: Doc buttons ──
BV.DOC_TYPES = ['brochure','ppm','video','ai_offering_chat','track_record','sponsor_news','sales_team_map'];
BV.docAvailability = (funds) => { const avail = {}; for (const t of BV.DOC_TYPES) avail[t] = funds.some(f => f.docs && f.docs[t]); return avail; };

BV.renderDocButtons = (selectedFunds) => {
  const avail = BV.docAvailability(selectedFunds);
  const mkBtn = (en, type, label) => en ? '<button class="bv-btn doc" data-bv-docbtn="'+BV.escapeHTML(type)+'">'+BV.iconSvg(type)+BV.escapeHTML(label)+'</button>' : '<button class="bv-btn" disabled>'+BV.escapeHTML(label)+' (NA)</button>';
  return '<div style="display:grid;gap:8px;justify-items:start;align-items:start"><div style="display:grid;gap:6px;justify-items:start"><div style="font-size:10px;font-weight:950;text-transform:uppercase;letter-spacing:.25px;color:rgba(255,255,255,0.92)">Offering Diligence</div><div style="display:flex;gap:10px;flex-wrap:wrap">'+mkBtn(avail.brochure,'brochure','Brochure')+mkBtn(avail.ppm,'ppm','PPM')+mkBtn(avail.video,'video','Video')+mkBtn(avail.ai_offering_chat,'ai_offering_chat','AI Chat')+'</div></div><div style="display:grid;gap:6px;justify-items:start"><div style="font-size:10px;font-weight:950;text-transform:uppercase;letter-spacing:.25px;color:rgba(255,255,255,0.92)">Sponsor Diligence</div><div style="display:flex;gap:10px;flex-wrap:wrap">'+mkBtn(avail.track_record,'track_record','Track Record')+mkBtn(avail.sponsor_news,'sponsor_news','Sponsor News')+mkBtn(avail.sales_team_map,'sales_team_map','Sales Team Map')+'</div></div><div id="bv-doc-modal"></div></div>';
};

BV.renderDocModal = (selectedFunds, type) => {
  const titleMap = { brochure:'Brochure', ppm:'PPM', video:'Video', ai_offering_chat:'AI Offering Chat', track_record:'Track Record', sponsor_news:'Sponsor News', sales_team_map:'Sales Team Map' };
  const tLabel = titleMap[type] || 'Document'; const e = BV.escapeHTML;
  const rows = selectedFunds.map(f => { const url = f.docs?.[type] || ''; return '<div class="docRow"><div class="name" title="'+e(f.displayLabel)+'">'+e(f.displayLabel)+'</div><div class="right">'+(url ? '<a class="bv-btn doc" href="'+e(url)+'" target="_blank" rel="noopener noreferrer">'+BV.iconSvg(type)+'Open</a>' : '<span class="na">NA</span>')+'</div></div>'; }).join('');
  return '<div class="docPopover"><div class="modal"><div class="modalHdr"><div class="t">'+e(tLabel)+' Picker</div><button class="bv-btn" onclick="document.getElementById(\'bv-doc-modal\').innerHTML=\'\'">Close</button></div><div class="modalBody">'+rows+'</div></div></div>';
};

// ── Vertical Comparison Table ──
BV.isExcludedHeader = (hNorm) => { if (!hNorm) return true; if (/^year\s*(10|[1-9])$/.test(hNorm)) return true; if (hNorm === 'brochure' || hNorm.includes('brochure')) return true; if (hNorm === 'ppm' || hNorm.includes('private placement') || (hNorm.includes('ppm') && !hNorm.includes('gp'))) return true; if (hNorm === 'video' || hNorm.includes('video url') || (hNorm.includes('video') && hNorm.includes('url'))) return true; if (hNorm.includes('ai offering chat')) return true; if (hNorm.includes('track record')) return true; if (hNorm.includes('sponsor news')) return true; if (hNorm.includes('sales team map') || (hNorm.includes('sales') && hNorm.includes('map'))) return true; if (hNorm.includes('property image')) return true; return false; };

BV.groupForHeader = (hNorm) => { const has = (s) => hNorm.includes(s); if (hNorm === 'sponsor' || has('offering name') || hNorm === 'name') return 'Identity'; if (has('asset class') || has('sector') || has('offering structure') || has('distribution frequency')) return 'Identity'; if (has('focus')) return 'Identity'; if (has('rep comp') || (has('rep') && has('comp'))) return 'Identity'; if ((has('minimum') && has('dst')) || has('minimum - dst')) return 'Identity'; if (has('filed raise') || has('current raise') || has('remaining raise') || (has('remains') && has('%'))) return 'Raise & Timeline'; if (has('offering open') || has('offering close') || has('term') || has('close date') || has('open date')) return 'Raise & Timeline'; if (has('cash on cash') || has('cap rate') || hNorm === 'ltv' || has('loan to value') || has('hold period')) return 'Economics & Returns'; if (has('purchase price') || has('loaded price') || has('appraised') || has('valuation')) return 'Economics & Returns'; if (has('minimum investment') || has('min investment')) return 'Economics & Returns'; if (has('% leased') || has('occupancy') || has('rent escalations') || has('lease term')) return 'Economics & Returns'; if (has('debt terms') || has('lease terms')) return 'Economics & Returns'; if (has('reserve')) return 'Economics & Returns'; if (has('sales load')) return 'Economics & Returns'; if (has('# assets') || has('number assets') || has('num assets')) return 'Property & Operations'; if (has('property location') || has('year built') || has('building age') || has('location')) return 'Property & Operations'; if (has('preferred') || has('promote') || has('gp commit') || has('gp')) return 'Structure, Fees & Tax'; if (has('upreit') || has('721') || has('exemption') || has('tax reporting')) return 'Structure, Fees & Tax'; return 'Sponsor'; };

BV.VCOMP_GROUP_ORDERS = { 'Identity': [(h)=>h==='sponsor', (h)=>h.includes('offering name')||h==='name', (h)=>h.includes('asset class'), (h)=>h.includes('offering structure'), (h)=>h.includes('sector'), (h)=>h.includes('focus'), (h)=>h.includes('distribution'), (h)=>(h.includes('minimum')&&h.includes('dst')), (h)=>h.includes('rep comp')], 'Raise & Timeline': [(h)=>h.includes('offering open'), (h)=>h.includes('offering close'), (h)=>h.includes('filed raise'), (h)=>h.includes('current raise'), (h)=>h.includes('remaining raise')], 'Economics & Returns': [(h)=>h.includes('year 1')&&h.includes('cash'), (h)=>hNorm==='ltv'||h.includes('loan to value'), (h)=>h.includes('hold period'), (h)=>h.includes('% leased')||h.includes('occupancy'), (h)=>h.includes('rent escalations'), (h)=>h.includes('lease term'), (h)=>h.includes('debt terms'), (h)=>h.includes('minimum investment'), (h)=>h.includes('cap rate'), (h)=>h.includes('reserve'), (h)=>h.includes('purchase price'), (h)=>h.includes('appraised'), (h)=>h.includes('loaded price'), (h)=>h.includes('sales load')], 'Property & Operations': [(h)=>h.includes('# assets'), (h)=>h.includes('property location'), (h)=>h.includes('building age')||h.includes('year built')], 'Sponsor': [(h)=>h.includes('sponsor aum'), (h)=>h.includes('sponsor experience'), (h)=>h.includes('number of sponsor offerings'), (h)=>h.includes('sponsor full cycle exits'), (h)=>h.includes('sponsor average irr'), (h)=>h.includes('sponsor best irr'), (h)=>h.includes('sponsor worst irr')] };

BV.GROUP_ORDER = ['Identity','Raise & Timeline','Economics & Returns','Property & Operations','Structure, Fees & Tax','Sponsor'];

BV.vcompIsPercentField = (hNorm) => (hNorm.includes('year 1')&&hNorm.includes('cash'))||hNorm==='ltv'||hNorm.includes('loan to value')||hNorm.includes('% leased')||hNorm.includes('occupancy')||hNorm.includes('rent escalations')||hNorm.includes('cap rate')||hNorm.includes('sales load')||hNorm.includes('rep comp')||hNorm.includes('sponsor average irr')||hNorm.includes('sponsor best irr')||hNorm.includes('sponsor worst irr');
BV.vcompIsMoneyField = (hNorm) => hNorm.includes('reserve')||(hNorm.includes('purchase price'))||hNorm.includes('appraised')||hNorm.includes('valuation')||hNorm.includes('loaded price')||((hNorm.includes('minimum')&&hNorm.includes('dst')));
BV.valueToDisplay = (v) => { if (v == null) return '—'; if (v instanceof Date && !isNaN(v.getTime())) return BV.fmtDate(v); if (typeof v === 'number' && isFinite(v)) return String(v); const s = String(v).trim(); if (!s || /^na$/i.test(s)) return '—'; if (/^(Date|Datetime)\(/i.test(s)) { const d = BV.parseDate(s); return d ? BV.fmtDate(d) : s; } return s; };
BV.vcompFormatValue = (hNorm, raw) => { if (raw instanceof Date) return BV.fmtDate(raw); if (typeof raw === 'string' && /^(Date|Datetime)\(/i.test(raw.trim())) { const d = BV.parseDate(raw); return d ? BV.fmtDate(d) : raw; } if (BV.vcompIsPercentField(hNorm)) { let num = typeof raw === 'number' ? raw : BV.parseNumberLoose(raw); if (num == null) return BV.valueToDisplay(raw); if (Math.abs(num) <= 1) num *= 100; return BV.fmtPct(num, 2); } if (BV.vcompIsMoneyField(hNorm)) { let num = typeof raw === 'number' ? raw : BV.parseMoney(raw); if (num == null) return BV.valueToDisplay(raw); return BV.fmtMoneyFull(num); } return BV.valueToDisplay(raw); };

BV.renderVerticalCompTable = (selectedFunds, headers) => {
  if (!selectedFunds || !selectedFunds.length || !headers || !headers.length) return '';
  const e = BV.escapeHTML;
  const cols = headers.map((h, idx) => ({ idx, h, norm: BV.normalizeHeader(h) })).filter(c => c.h && c.norm && !BV.isExcludedHeader(c.norm));
  const grouped = new Map();
  for (const c of cols) { const g = BV.groupForHeader(c.norm); if (!grouped.has(g)) grouped.set(g, []); grouped.get(g).push(c); }
  for (const [g, arr] of grouped.entries()) {
    const rules = BV.VCOMP_GROUP_ORDERS[g];
    arr.sort((a,b) => { if (!rules) return a.h.localeCompare(b.h); let ai = null, bi = null; for (let i=0; i<rules.length; i++) { try { if (rules[i](a.norm)) ai = i; } catch(e){} try { if (rules[i](b.norm)) bi = i; } catch(e){} } if (ai!=null && bi!=null) return ai-bi; if (ai!=null) return -1; if (bi!=null) return 1; return a.h.localeCompare(b.h); });
    if (g === 'Identity') { let kept = false; grouped.set(g, arr.filter(c => { if (c.norm.includes('offering name') || c.norm === 'name') { if (kept) return false; kept = true; } return true; })); }
  }
  const groupsOut = [];
  for (const g of BV.GROUP_ORDER) { const arr = grouped.get(g); if (arr && arr.length) groupsOut.push({ group: g, cols: arr }); }
  for (const [g, arr] of grouped.entries()) { if (!BV.GROUP_ORDER.includes(g) && arr.length) groupsOut.push({ group: g, cols: arr }); }
  if (!groupsOut.length) return '<div class="sec"><div class="secHdr"><div class="h">Vertical Comparison Table</div></div><div class="secBody"><div style="padding:12px;color:rgba(9,14,25,0.58)">No comparable columns found.</div></div></div>';

  const offerHdrs = selectedFunds.map(f => ({ title: f.offering_name || '(Unnamed)', sub: f.sponsor || '—', full: f.displayLabel }));
  const thead = '<thead><tr><th class="vcompField">Field</th>' + offerHdrs.map(o => '<th><div class="vcompOfferHdr" title="'+e(o.full)+'">'+e(o.title)+'</div><div class="vcompOfferSub" title="'+e(o.sub)+'">'+e(o.sub)+'</div></th>').join('') + '</tr></thead>';

  const bodyRows = groupsOut.map(g => {
    let html = '<tr class="vcompGroupRow"><td colspan="'+(1+selectedFunds.length)+'">'+e(g.group)+'</td></tr>';
    html += g.cols.map(c => {
      const fieldLabel = c.h || '—';
      const vals = selectedFunds.map(f => {
        const raw = (f.__rawRow && Array.isArray(f.__rawRow)) ? f.__rawRow[c.idx] : '';
        const shouldFormat = (g.group === 'Economics & Returns') || (g.group === 'Identity' && ((c.norm.includes('minimum') && c.norm.includes('dst')) || c.norm.includes('rep comp'))) || (g.group === 'Sponsor' && (c.norm.includes('sponsor average irr') || c.norm.includes('sponsor best irr') || c.norm.includes('sponsor worst irr')));
        const disp = shouldFormat ? BV.vcompFormatValue(c.norm, raw) : BV.valueToDisplay(raw);
        return disp === '—' ? '<td><div class="vcompNA">—</div></td>' : '<td><div class="vcompVal">'+e(disp)+'</div></td>';
      }).join('');
      return '<tr><td class="vcompField">'+e(fieldLabel)+'</td>'+vals+'</tr>';
    }).join('');
    return html;
  }).join('');

  return '<div class="sec"><div class="secHdr"><div class="h">Vertical Side-by-Side Comparison</div><div class="hint">All columns except Year 1–10 and doc URLs • Sticky headers</div></div><div class="secBody"><div class="vcompWrap"><div class="vcompTop"><div class="t">Comparison Table</div><div class="s">Scroll down — headers stay pinned</div></div><div class="vcompScroller"><table class="vcompTable">' + thead + '<tbody>' + bodyRows + '</tbody></table></div></div></div></div>';
};

// ── Main renderBasket() ──
function renderBasket() {
  const basketIds = STATE.basket;
  const platformFunds = basketIds.map(id => STATE.funds.find(f => f.id === id)).filter(Boolean);
  if (!platformFunds.length) return '<div class="page-header"><div><div class="page-title">Basket & Comparison</div><div class="page-subtitle">Add offerings from Browse to compare side-by-side</div></div></div><div class="empty-state"><div class="empty-state-icon">🛒</div><h3>Basket is Empty</h3><p>Add up to 3 offerings from Browse to unlock full tear sheet comparison with peer benchmarking, valuation analysis, income charts, and vertical comparison tables.</p><button class="btn btn-primary" onclick="navigateTo(\'browse\')">Browse Offerings</button></div>';

  // Adapt platform funds to basket format
  const selectedFunds = platformFunds.map(BV.adaptFund).filter(Boolean);
  const allAdapted = STATE.funds.map(BV.adaptFund).filter(Boolean);
  const peer = BV.computePeerStats(allAdapted);
  const agg = BV.aggregate(selectedFunds);
  const isMulti = agg.__isAggregate;
  const insights = BV.buildInsights(agg, selectedFunds, peer);
  const st = agg.property_states || [];
  const e = BV.escapeHTML;
  const n = selectedFunds.length;

  // ── Platform nav header with multi-select dropdown ──
  const offeringOpts = STATE.funds.map(f => {
    const checked = STATE.basket.includes(f.id);
    const disabled = !checked && STATE.basket.length >= 3;
    return '<label class="bv-select-item' + (checked ? ' checked' : '') + (disabled ? ' disabled' : '') + '" onclick="event.stopPropagation()"><input type="checkbox" value="' + f.id + '"' + (checked ? ' checked' : '') + (disabled ? ' disabled' : '') + ' onchange="bvToggleOffering(' + f.id + ')"><span class="bv-select-name">' + BV.escapeHTML(f.sponsor + ' — ' + f.name) + '</span>' + (checked ? '<span class="bv-select-x" onclick="event.preventDefault();bvToggleOffering(' + f.id + ')">✕</span>' : '') + '</label>';
  }).join('');
  const navHeader = '<div class="page-header"><div><div class="page-title">Basket</div><div class="page-subtitle">' + n + ' offering' + (n>1?'s':'') + ' selected' + (n > 1 ? ' — comparison mode' : '') + '</div></div><div style="display:flex;gap:8px;align-items:center"><div class="bv-dropdown-wrap"><button class="btn btn-secondary" onclick="document.getElementById(\'bv-offering-dropdown\').classList.toggle(\'open\')">Offerings (' + n + '/3) ▾</button><div class="bv-dropdown" id="bv-offering-dropdown">' + offeringOpts + '</div></div><button class="btn btn-secondary" onclick="navigateTo(\'browse\')">← Browse</button><button class="btn btn-ghost" onclick="STATE.basket=[];saveBasket();renderApp();toast(\'Basket cleared\')">Clear All</button></div></div>';

  // ── Hero ──
  const heroTitle = isMulti ? 'Selected Offerings (' + n + ')' : selectedFunds[0].displayLabel;
  const heroSub = isMulti ? 'As of: ' + new Date().toLocaleDateString() + ' • Combined metrics are averages (except Min Investment = sum)' : 'As of: ' + new Date().toLocaleDateString();
  const metaBadges = (() => {
    if (isMulti) {
      const sponsors = BV.uniqSorted(selectedFunds.map(f=>f.sponsor).filter(Boolean));
      const asset = BV.uniqSorted(selectedFunds.map(f=>f.asset_class).filter(Boolean));
      return (sponsors.length ? '<span class="r-badge"><strong>Sponsors:</strong> '+e(sponsors.slice(0,3).join(', ')+(sponsors.length>3?'…':''))+'</span>' : '') + (asset.length ? '<span class="r-badge">'+e(asset.slice(0,3).join(', ')+(asset.length>3?'…':''))+'</span>' : '');
    }
    const f = selectedFunds[0];
    return (f.asset_class ? '<span class="r-badge">'+e(f.asset_class)+'</span>' : '') + (f.sector_focus ? '<span class="r-badge">'+e(f.sector_focus)+'</span>' : '') + (f.offering_structure ? '<span class="r-badge">'+e(f.offering_structure)+'</span>' : '');
  })();
  const statusHtml = !isMulti ? BV.renderStatusModule(selectedFunds[0]) : '';
  const hero = '<div class="r-hero"><div class="topline"><div class="r-title"><h2>'+e(heroTitle)+'</h2><div class="subline">'+e(heroSub)+'</div><div class="metaRow">'+metaBadges+'</div></div>'+statusHtml+'<div class="docsBox">'+BV.renderDocButtons(selectedFunds)+'</div></div></div>';

  // ── Key Takeaways + Map ──
  const insightsHtml = '<div class="kv-grid"><div class="callouts"><div class="callout"><h3>Key Takeaways</h3><ul>'+(insights.takeaways.length ? insights.takeaways : ['No standout signals from current data.']).map(x=>'<li>'+e(x)+'</li>').join('')+'</ul></div><div class="callout"><h3>Potential Considerations</h3><ul>'+(insights.considerations.length ? insights.considerations : ['No specific considerations flagged.']).map(x=>'<li>'+e(x)+'</li>').join('')+'</ul></div></div><div class="mapWrap"><div class="mapHdr"><div class="t">Footprint (Contiguous US)</div><div class="s">'+(st.length ? st.length+' state'+(st.length===1?'':'s') : 'No states parsed')+'</div></div><div class="mapBox" id="bv-map"></div><div class="legend"><span class="swatch"></span><span>States in <b>Property Location(s)</b></span></div><div class="textBlock" style="margin-top:10px"><b>Locations:</b> '+e(agg.property_locations_summary||'—')+'</div></div></div>';

  // ── Snapshot Metrics ──
  const snapshotHtml = '<div class="sec"><div class="secHdr"><div class="h">Snapshot Metrics</div><div class="hint">Peer averages + rank percentile • data coverage per tile</div></div><div class="secBody"><div class="metricsGrid">' + BV.SNAPSHOT_KEYS.map(k => {
    const cov = agg.coverage[k]; const v = agg.metrics[k];
    return '<div class="mBox">'+BV.covBadgeHtml(cov)+'<div class="k">'+e(BV.metricLabel(k))+'</div><div class="v">'+e(BV.metricFormatter(k, v))+'</div><div class="vs">'+BV.peerVsLine(k, v, peer, cov)+'</div></div>';
  }).join('') + '</div></div></div>';

  // ── Income Chart ──
  const incomeKeys = BV.INCOME_KEYS;
  const covAny = incomeKeys.some(k => (agg.coverage?.[k]?.present || 0) > 0);
  const covSummary = incomeKeys.map(k => agg.coverage?.[k]).filter(Boolean);
  const avgCov = covSummary.length ? Math.round(covSummary.reduce((a,c)=>a+(c.present/c.total),0)/covSummary.length*100) : 0;
  const incomeHtml = '<div class="sec"><div class="secHdr"><div class="h">Client Income (%), Years 1–10</div><div class="hint">'+(isMulti ? 'Bars are averaged across selected offerings' : 'Bars reflect selected offering')+'</div></div><div class="secBody"><div class="chartWrap"><div class="chartHdr"><div class="t">Client Income (%) by Year</div><div class="s">'+(covAny ? 'Avg data coverage ~'+avgCov+'%' : 'No income data found')+'</div></div><div class="chartBox"><canvas id="bv-income-chart"></canvas></div></div></div></div>';

  // ── Debt & Lease ──
  let debtHtml = '<div class="sec"><div class="secHdr"><div class="h">Debt & Lease</div><div class="hint">'+(isMulti ? 'Separate per offering' : 'As entered')+'</div></div><div class="secBody">';
  if (isMulti) { debtHtml += agg.debt_lease_list.map(x => '<div class="mBox" style="margin-bottom:10px"><div class="k">'+e(x.label)+'</div><div class="textBlock" style="margin-top:8px"><b>Debt Terms</b><br>'+(x.debt_terms ? e(x.debt_terms) : '—')+'<br><br><b>Lease Terms</b><br>'+(x.lease_terms ? e(x.lease_terms) : '—')+'</div></div>').join(''); }
  else { debtHtml += '<div class="textBlock"><b>Debt Terms</b><br>'+(selectedFunds[0].debt_terms ? e(selectedFunds[0].debt_terms) : '—')+'<br><br><b>Lease Terms</b><br>'+(selectedFunds[0].lease_terms ? e(selectedFunds[0].lease_terms) : '—')+'</div>'; }
  debtHtml += '</div></div>';

  // ── Vertical Comparison ──
  const vcompHtml = BV.renderVerticalCompTable(selectedFunds, STATE.headers || []);

  // ── Disclosures ──
  const disclosuresHtml = '<div class="sec"><div class="secHdr"><div class="h">Important Disclosures</div><div class="hint">Compliance footer</div></div><div class="secBody"><div class="textBlock">'+e(BV.DISCLOSURES)+'</div></div></div>';

  // ── Footer ──
  const ftrHtml = '<div class="ftr"><div>Data loaded: ' + new Date().toLocaleDateString() + '</div><div>Alts Fund LINK Platform</div></div>';

  const report = '<div class="bv"><div class="report">' + hero + insightsHtml + '<div class="sections">' + snapshotHtml + incomeHtml + BV.renderPurchaseValuation(agg) + debtHtml + vcompHtml + disclosuresHtml + '</div>' + ftrHtml + '</div></div>';
  return navHeader + report;
}

// ── Basket offering toggle (from dropdown) ──
function bvToggleOffering(id) {
  const idx = STATE.basket.indexOf(id);
  if (idx >= 0) {
    STATE.basket.splice(idx, 1);
  } else {
    if (STATE.basket.length >= 3) { toast('Maximum 3 offerings. Remove one first.', 'error'); return; }
    STATE.basket.push(id);
  }
  saveBasket();
  renderApp();
}

// ── Basket post-render hooks ──
function basketPostRender() {
  // Close dropdown on click outside
  document.addEventListener('click', function bvDropClose(e) {
    const wrap = document.querySelector('.bv-dropdown-wrap');
    if (wrap && !wrap.contains(e.target)) {
      const dd = document.getElementById('bv-offering-dropdown');
      if (dd) dd.classList.remove('open');
    }
  }, { once: false, capture: true });

  // Wire doc buttons
  document.querySelectorAll('[data-bv-docbtn]').forEach(btn => {
    btn.addEventListener('click', () => {
      const type = btn.getAttribute('data-bv-docbtn');
      const platformFunds = STATE.basket.map(id => STATE.funds.find(f => f.id === id)).filter(Boolean);
      const selectedFunds = platformFunds.map(BV.adaptFund).filter(Boolean);
      const modal = document.getElementById('bv-doc-modal');
      if (modal) modal.innerHTML = BV.renderDocModal(selectedFunds, type);
    });
  });

  // Draw US map
  basketDrawMap();

  // Draw income chart
  basketDrawIncomeChart();
}

let bvChartsPromise = null;
function loadGoogleCharts() {
  if (bvChartsPromise) return bvChartsPromise;
  bvChartsPromise = new Promise((resolve, reject) => {
    if (window.google && google.charts && google.visualization) { resolve(); return; }
    const s = document.createElement('script');
    s.src = 'https://www.gstatic.com/charts/loader.js';
    s.async = true;
    s.onload = () => { try { google.charts.load('current', { packages: ['geochart'] }); google.charts.setOnLoadCallback(resolve); } catch(e) { reject(e); } };
    s.onerror = () => reject(new Error('Failed to load Google Charts'));
    document.head.appendChild(s);
  });
  return bvChartsPromise;
}

function basketDrawMap() {
  const el = document.getElementById('bv-map');
  if (!el) return;
  const platformFunds = STATE.basket.map(id => STATE.funds.find(f => f.id === id)).filter(Boolean);
  const states = BV.uniqSorted(platformFunds.flatMap(f => BV.extractStates(f.location)));
  if (!states.length) { el.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:rgba(9,14,25,0.52);font-size:12px;font-weight:800">No states detected from Property Location(s)</div>'; return; }
  loadGoogleCharts().then(() => {
    const dataRows = [['State', 'Presence']];
    states.forEach(s => dataRows.push(['US-' + s, 1]));
    const data = google.visualization.arrayToDataTable(dataRows);
    el.innerHTML = '';
    const chart = new google.visualization.GeoChart(el);
    chart.draw(data, { region: 'US', resolution: 'provinces', legend: 'none', backgroundColor: { fill: 'transparent' }, datalessRegionColor: 'rgba(15,23,42,0.06)', defaultColor: 'rgba(15,23,42,0.06)', colorAxis: { colors: ['#0B1F3B', '#0B1F3B'] }, keepAspectRatio: true });
  }).catch(() => { el.innerHTML = '<div style="padding:20px;text-align:center;color:rgba(9,14,25,0.52);font-size:11px">Map unavailable</div>'; });
}

function basketDrawIncomeChart() {
  const canvas = document.getElementById('bv-income-chart');
  if (!canvas || !window.Chart) return;
  if (STATE.incomeChart) { STATE.incomeChart.destroy(); STATE.incomeChart = null; }

  const platformFunds = STATE.basket.map(id => STATE.funds.find(f => f.id === id)).filter(Boolean);
  const selectedFunds = platformFunds.map(BV.adaptFund).filter(Boolean);
  if (!selectedFunds.length) return;

  const agg = BV.aggregate(selectedFunds);
  const labels = Array.from({length:10}, (_,i) => 'Year '+(i+1));
  const vals = BV.INCOME_KEYS.map(k => agg.metrics?.[k] ?? null);

  STATE.incomeChart = new Chart(canvas, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Client Income (%)', data: vals.map(v => BV.isNum(v) ? v : null), borderWidth: 0, borderRadius: 8, backgroundColor: 'rgba(11,31,59,0.70)', hoverBackgroundColor: 'rgba(28,58,99,0.78)' }] },
    options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => { const v = vals[ctx.dataIndex]; return 'Income: ' + (BV.isNum(v) ? v.toFixed(2) + '%' : '—'); } } } }, scales: { x: { ticks: { color: 'rgba(9,14,25,0.70)', font: { family: 'Inter', weight: '700' } }, grid: { color: 'rgba(15,23,42,0.08)' } }, y: { beginAtZero: true, ticks: { color: 'rgba(9,14,25,0.70)', callback: (v) => v + '%', font: { family: 'Inter', weight: '700' } }, grid: { color: 'rgba(15,23,42,0.08)' } } } }
  });
}


/* ═══════════════════════════════════════════
   EVENT HANDLERS & INIT
═══════════════════════════════════════════ */
function attachViewHandlers() {
  if (STATE.view === 'basket') {
    requestAnimationFrame(() => basketPostRender());
  } else {
    if (STATE.incomeChart) { STATE.incomeChart.destroy(); STATE.incomeChart = null; }
  }
}

// ── Boot ──
updateClientBadge();
fetchSheetData();
</script>
</body>
</html>
