<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alts Fund Link — Alternative Asset Diligence Intelligence</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700;9..40,800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="shared.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3/dist/topojson-client.min.js"></script>
<style>
/* ── Reset ── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }
body { font-family: 'DM Sans', sans-serif; background: #F4F7FB; color: #3A5270; }

/* ── Design tokens ── */
:root {
  --navy:    #0B1F3B;
  --navy2:   #1C3A63;
  --navy3:   #2A4D7A;
  --slate:   #3A5270;
  --slate2:  #5C7A99;
  --fog:     #8FA3BA;
  --mist:    #C8D8E8;
  --ice:     #E8F0F8;
  --white:   #FFFFFF;
  --surface: #F4F7FB;
  --surface2:#EEF3FA;
  --green:   #1A7A4A;
  --green-lt:#E8F7EF;
  --amber:   #B45309;
  --amber-lt:#FEF3C7;
  --red:     #991B1B;
  --red-lt:  #FEE2E2;
  --blue:    #1D4ED8;
  --blue-lt: #EFF6FF;
  --radius:  8px;
  --radius-lg: 14px;
  --shadow-sm: 0 1px 3px rgba(11,31,59,0.08), 0 1px 2px rgba(11,31,59,0.05);
  --shadow:    0 4px 12px rgba(11,31,59,0.10);
  --shadow-lg: 0 12px 32px rgba(11,31,59,0.14);
  --header-h: 60px;
  --sidebar-w: 218px;
  --transition: 0.18s cubic-bezier(0.4,0,0.2,1);
}

/* ══════════════════════════════════════════
   HEADER
══════════════════════════════════════════ */
#shell-header {
  position: fixed;
  top: 0; left: 0; right: 0;
  height: var(--header-h);
  background: var(--navy);
  display: flex;
  align-items: center;
  padding: 0 20px;
  gap: 16px;
  z-index: 1000;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}

/* Logo */
.header-logo {
  display: flex;
  align-items: center;
  gap: 10px;
  text-decoration: none;
  flex-shrink: 0;
  cursor: pointer;
}
.logo-mark {
  width: 34px;
  height: 34px;
  background: linear-gradient(135deg, #2A6FDB 0%, #1A4A9A 100%);
  border-radius: 9px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  font-weight: 800;
  color: var(--white);
  letter-spacing: -0.03em;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  flex-shrink: 0;
}
.logo-text {
  display: flex;
  flex-direction: column;
  line-height: 1;
}
.logo-text-top {
  font-size: 14px;
  font-weight: 800;
  color: var(--white);
  letter-spacing: -0.01em;
}
.logo-text-bottom {
  font-size: 9px;
  font-weight: 500;
  color: rgba(255,255,255,0.45);
  letter-spacing: 0.06em;
  text-transform: uppercase;
  margin-top: 1px;
}

/* View mode tabs */
.header-nav {
  display: flex;
  align-items: center;
  gap: 2px;
  background: rgba(255,255,255,0.07);
  border-radius: 10px;
  padding: 3px;
  margin-left: 8px;
}
.header-nav-tab {
  font-size: 12px;
  font-weight: 600;
  padding: 5px 14px;
  border-radius: 7px;
  border: none;
  background: transparent;
  color: rgba(255,255,255,0.55);
  cursor: pointer;
  transition: all var(--transition);
  white-space: nowrap;
  letter-spacing: 0.01em;
}
.header-nav-tab:hover { color: rgba(255,255,255,0.85); background: rgba(255,255,255,0.08); }
.header-nav-tab.active { background: rgba(255,255,255,0.15); color: var(--white); }

/* Status pill */
.header-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  font-weight: 600;
  color: rgba(255,255,255,0.5);
  letter-spacing: 0.04em;
  white-space: nowrap;
}
.status-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: #22c55e;
  box-shadow: 0 0 6px #22c55e;
  animation: pulse-dot 2.5s ease-in-out infinite;
  flex-shrink: 0;
}
@keyframes pulse-dot {
  0%,100% { opacity: 1; transform: scale(1); }
  50%      { opacity: 0.7; transform: scale(0.85); }
}

.header-spacer { flex: 1; }

/* Client badge */
.header-client-badge {
  display: flex;
  align-items: center;
  gap: 8px;
  background: rgba(255,255,255,0.09);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 100px;
  padding: 5px 12px 5px 8px;
  cursor: pointer;
  transition: all var(--transition);
  max-width: 200px;
}
.header-client-badge:hover { background: rgba(255,255,255,0.14); }
.client-avatar {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--navy2), var(--navy3));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: 700;
  color: rgba(255,255,255,0.9);
  flex-shrink: 0;
  border: 1.5px solid rgba(255,255,255,0.2);
}
.client-name {
  font-size: 12px;
  font-weight: 600;
  color: rgba(255,255,255,0.85);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.client-name.placeholder { color: rgba(255,255,255,0.4); font-weight: 500; }

/* Basket button */
.header-basket-btn {
  display: flex;
  align-items: center;
  gap: 7px;
  background: rgba(255,255,255,0.09);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 10px;
  padding: 7px 14px;
  cursor: pointer;
  transition: all var(--transition);
  color: rgba(255,255,255,0.8);
  font-family: 'DM Sans', sans-serif;
  font-size: 13px;
  font-weight: 600;
  white-space: nowrap;
  flex-shrink: 0;
}
.header-basket-btn:hover { background: rgba(255,255,255,0.16); color: var(--white); }
.header-basket-btn svg { width: 15px; height: 15px; opacity: 0.85; }
.basket-count-pill {
  background: #2A6FDB;
  color: var(--white);
  font-size: 10px;
  font-weight: 800;
  padding: 1px 6px;
  border-radius: 100px;
  min-width: 18px;
  text-align: center;
  display: none;
}
.basket-count-pill.visible { display: inline-block; }

/* ══════════════════════════════════════════
   LAYOUT BODY
══════════════════════════════════════════ */
#shell-body {
  display: flex;
  height: 100vh;
  padding-top: var(--header-h);
}

/* ══════════════════════════════════════════
   SIDEBAR
══════════════════════════════════════════ */
#shell-sidebar {
  width: var(--sidebar-w);
  min-width: var(--sidebar-w);
  background: var(--white);
  border-right: 1px solid var(--mist);
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  overflow-x: hidden;
  flex-shrink: 0;
}
#shell-sidebar::-webkit-scrollbar { width: 4px; }
#shell-sidebar::-webkit-scrollbar-thumb { background: var(--mist); border-radius: 2px; }

.sidebar-section-label {
  font-size: 10px;
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
  color: var(--fog);
  padding: 18px 16px 6px;
}

.sidebar-nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 16px;
  font-size: 13px;
  font-weight: 500;
  color: var(--slate2);
  cursor: pointer;
  border-radius: 0;
  transition: all var(--transition);
  position: relative;
  text-decoration: none;
  border-left: 3px solid transparent;
  user-select: none;
}
.sidebar-nav-item:hover {
  background: var(--surface);
  color: var(--navy);
}
.sidebar-nav-item.active {
  background: var(--blue-lt);
  color: var(--navy2);
  font-weight: 600;
  border-left-color: var(--navy2);
}
.sidebar-nav-item svg {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
  opacity: 0.7;
}
.sidebar-nav-item.active svg { opacity: 1; }

.sidebar-badge {
  margin-left: auto;
  font-size: 10px;
  font-weight: 700;
  padding: 1px 7px;
  border-radius: 100px;
  background: var(--ice);
  color: var(--slate2);
  border: 1px solid var(--mist);
}
.sidebar-badge.blue {
  background: var(--blue-lt);
  color: var(--blue);
  border-color: rgba(29,78,216,0.2);
}
.sidebar-badge.green {
  background: var(--green-lt);
  color: var(--green);
  border-color: rgba(26,122,74,0.2);
}

.sidebar-divider {
  height: 1px;
  background: var(--mist);
  margin: 8px 16px;
}

.sidebar-bottom {
  margin-top: auto;
  padding-bottom: 12px;
  border-top: 1px solid var(--mist);
  padding-top: 8px;
}

/* ══════════════════════════════════════════
   MAIN CONTENT
══════════════════════════════════════════ */
#app-content {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  background: var(--surface);
  min-width: 0;
  position: relative;
}
#app-content::-webkit-scrollbar { width: 6px; }
#app-content::-webkit-scrollbar-thumb { background: var(--mist); border-radius: 3px; }

/* ── Loading overlay ── */
#shell-loader {
  position: absolute;
  inset: 0;
  background: var(--surface);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  z-index: 10;
  transition: opacity 0.3s ease;
}
#shell-loader.hidden { opacity: 0; pointer-events: none; }
.loader-logo {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, #2A6FDB 0%, #1A4A9A 100%);
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 800;
  color: var(--white);
  box-shadow: var(--shadow);
  animation: loader-pulse 1.5s ease-in-out infinite;
}
@keyframes loader-pulse {
  0%,100% { transform: scale(1); box-shadow: var(--shadow); }
  50%      { transform: scale(1.06); box-shadow: var(--shadow-lg); }
}
.loader-text {
  font-size: 13px;
  font-weight: 500;
  color: var(--fog);
}
.loader-bar-track {
  width: 160px;
  height: 3px;
  background: var(--mist);
  border-radius: 2px;
  overflow: hidden;
}
.loader-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--navy2), #2A6FDB);
  border-radius: 2px;
  animation: loader-bar 1.6s ease-in-out infinite;
}
@keyframes loader-bar {
  0%   { transform: translateX(-100%); }
  100% { transform: translateX(200%); }
}

/* ── Module error state ── */
#module-error {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 20px;
  text-align: center;
  gap: 12px;
}
#module-error.visible { display: flex; }
#module-error .err-icon { font-size: 36px; opacity: 0.4; }
#module-error h3 { font-size: 16px; font-weight: 700; color: var(--slate2); }
#module-error p  { font-size: 13px; color: var(--fog); max-width: 320px; }
.btn-retry {
  font-family: 'DM Sans', sans-serif;
  font-size: 13px;
  font-weight: 600;
  padding: 8px 20px;
  background: var(--navy2);
  color: var(--white);
  border: none;
  border-radius: var(--radius);
  cursor: pointer;
  transition: background var(--transition);
}
.btn-retry:hover { background: var(--navy3); }

/* ── Toast notifications ── */
#toast-container {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 8px;
  pointer-events: none;
}
.toast {
  background: var(--navy);
  color: var(--white);
  font-size: 13px;
  font-weight: 500;
  padding: 10px 16px;
  border-radius: var(--radius);
  box-shadow: var(--shadow-lg);
  animation: toast-in 0.25s ease forwards;
  max-width: 320px;
  pointer-events: auto;
}
.toast.success { border-left: 3px solid #22c55e; }
.toast.error   { border-left: 3px solid var(--red); }
.toast.info    { border-left: 3px solid #2A6FDB; }
@keyframes toast-in {
  from { transform: translateY(12px); opacity: 0; }
  to   { transform: translateY(0);    opacity: 1; }
}
</style>
</head>
<body>

<!-- ══════════════════════════════════════
     HEADER
══════════════════════════════════════ -->
<header id="shell-header">

  <!-- Logo -->
  <div class="header-logo" onclick="AFL.navigate('browse')">
    <div class="logo-mark">AFL</div>
    <div class="logo-text">
      <span class="logo-text-top">Alts Fund Link</span>
      <span class="logo-text-bottom">Diligence Intelligence</span>
    </div>
  </div>

  <!-- View mode tabs -->
  <nav class="header-nav">
    <button class="header-nav-tab active" data-mode="advisor">Advisor View</button>
    <button class="header-nav-tab" data-mode="client">Client Report</button>
    <button class="header-nav-tab" data-mode="compliance">Compliance</button>
  </nav>

  <!-- Live offerings status -->
  <div class="header-status">
    <span class="status-dot"></span>
    <span id="header-fund-count">— offerings live</span>
  </div>

  <div class="header-spacer"></div>

  <!-- Client badge -->
  <div class="header-client-badge" id="header-client-badge" onclick="AFL.navigate('client')" title="Set client profile">
    <div class="client-avatar" id="header-client-avatar">—</div>
    <span class="client-name placeholder" id="header-client-name">Set Client Profile</span>
  </div>

  <!-- Basket -->
  <button class="header-basket-btn" id="header-basket-btn" onclick="AFL.navigate('offering', {fromBasket: true})">
    <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
      <path d="M3 3h10l-1.5 7H4.5L3 3z"/>
      <path d="M1 1h2l.5 2"/>
      <circle cx="6" cy="13" r="0.8" fill="currentColor" stroke="none"/>
      <circle cx="11" cy="13" r="0.8" fill="currentColor" stroke="none"/>
    </svg>
    Basket
    <span class="basket-count-pill" id="header-basket-count"></span>
  </button>

</header>

<!-- ══════════════════════════════════════
     BODY: SIDEBAR + CONTENT
══════════════════════════════════════ -->
<div id="shell-body">

  <!-- Sidebar -->
  <aside id="shell-sidebar">

    <div class="sidebar-section-label">Platform</div>

    <div class="sidebar-nav-item active" data-module="browse">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
        <rect x="1" y="1" width="6" height="6" rx="1.2"/>
        <rect x="9" y="1" width="6" height="6" rx="1.2"/>
        <rect x="1" y="9" width="6" height="6" rx="1.2"/>
        <rect x="9" y="9" width="6" height="6" rx="1.2"/>
      </svg>
      Browse
      <span class="sidebar-badge green" id="sidebar-fund-count">—</span>
    </div>

    <div class="sidebar-nav-item" data-module="offering" data-params='{"fromBasket":true}'>
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 3h10l-1.5 7H4.5L3 3z"/>
        <path d="M1 1h2l.5 2"/>
        <circle cx="6" cy="13" r="0.8" fill="currentColor" stroke="none"/>
        <circle cx="11" cy="13" r="0.8" fill="currentColor" stroke="none"/>
      </svg>
      Basket
      <span class="sidebar-badge blue" id="sidebar-basket-count" style="display:none"></span>
    </div>

        <div class="sidebar-nav-item" data-module="model">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
        <path d="M2 14L6 8l3 3 2.5-4L14 10"/>
        <circle cx="14" cy="4" r="2"/>
      </svg>
      1031 Modeler
    </div>

    <div class="sidebar-divider"></div>
    <div class="sidebar-section-label">Client</div>

    <div class="sidebar-nav-item" data-module="client">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="8" cy="5" r="3"/>
        <path d="M2 14c0-3.3 2.7-6 6-6s6 2.7 6 6"/>
      </svg>
      Client Profile
      <span class="sidebar-badge" id="sidebar-client-badge" style="display:none">Active</span>
    </div>

    <div class="sidebar-divider"></div>
    <div class="sidebar-section-label">Sponsors</div>

    <div class="sidebar-nav-item" data-module="sponsor">
      <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
        <rect x="2" y="7" width="12" height="8" rx="1"/>
        <path d="M5 7V5a3 3 0 016 0v2"/>
        <circle cx="8" cy="11" r="1.2" fill="currentColor" stroke="none"/>
      </svg>
      Sponsors
    </div>

    <!-- Bottom settings -->
    <div class="sidebar-bottom">
      <div class="sidebar-nav-item" id="sidebar-refresh-btn" style="color:var(--fog);font-size:12px;">
        <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
          <path d="M13.5 8A5.5 5.5 0 112.5 5.5"/>
          <path d="M2.5 2v3.5H6"/>
        </svg>
        Refresh Data
      </div>
    </div>

  </aside>

  <!-- Main content -->
  <main id="app-content">

    <!-- Loading state -->
    <div id="shell-loader">
      <div class="loader-logo">AFL</div>
      <div class="loader-text">Loading platform…</div>
      <div class="loader-bar-track">
        <div class="loader-bar-fill"></div>
      </div>
    </div>

    <!-- Module error state -->
    <div id="module-error">
      <div class="err-icon">⚠️</div>
      <h3>Module failed to load</h3>
      <p id="module-error-msg">There was a problem loading this page.</p>
      <button class="btn-retry" id="btn-retry">Try Again</button>
    </div>

    <!-- Module HTML injected here by router -->
    <div id="module-mount"></div>

  </main>
</div>

<!-- Toast container -->
<div id="toast-container"></div>

<!-- ══════════════════════════════════════
     SHELL ROUTER + LOGIC
══════════════════════════════════════ -->
<script>
(function () {
  'use strict';

  // ── Tell modules they're inside the shell ──
  window._aflShellActive = true;

  // ── Module file map ──
  const MODULE_FILES = {
    browse   : 'browse.html',
    offering : 'offering.html',
    builder  : 'builder.html',
    model    : 'model.html',
    client   : 'client.html',
    sponsor  : 'sponsor.html',
  };

  // ── DOM refs ──
  const $mount   = document.getElementById('module-mount');
  const $loader  = document.getElementById('shell-loader');
  const $errBox  = document.getElementById('module-error');
  const $errMsg  = document.getElementById('module-error-msg');
  const $retry   = document.getElementById('btn-retry');

  let currentModuleName = null;
  let lastParams = {};

  // ── Show / hide loader ──
  function showLoader()  { $loader.classList.remove('hidden'); $errBox.classList.remove('visible'); }
  function hideLoader()  { $loader.classList.add('hidden'); }
  function showError(msg){ hideLoader(); $errMsg.textContent = msg; $errBox.classList.add('visible'); }

  // ── Toast ──
  function toast(msg, type = 'info', ms = 3000) {
    const el = document.createElement('div');
    el.className = `toast ${type}`;
    el.textContent = msg;
    document.getElementById('toast-container').appendChild(el);
    setTimeout(() => el.remove(), ms);
  }

  // ── Header update ──
  function updateHeader(data = {}) {
    // Basket count
    const count = AFL.basket.count();
    const pill  = document.getElementById('header-basket-count');
    const sbBadge = document.getElementById('sidebar-basket-count');
    if (count > 0) {
      pill.textContent = count;
      pill.classList.add('visible');
      sbBadge.textContent = count;
      sbBadge.style.display = '';
    } else {
      pill.classList.remove('visible');
      sbBadge.style.display = 'none';
    }

    // Client badge
    const client = AFL.state.client;
    const nameEl  = document.getElementById('header-client-name');
    const avatarEl= document.getElementById('header-client-avatar');
    const clientBadge = document.getElementById('sidebar-client-badge');
    if (client && client.name) {
      nameEl.textContent = client.name;
      nameEl.classList.remove('placeholder');
      avatarEl.textContent = client.name.split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();
      clientBadge.style.display = '';
    } else {
      nameEl.textContent = 'Set Client Profile';
      nameEl.classList.add('placeholder');
      avatarEl.textContent = '—';
      clientBadge.style.display = 'none';
    }

    // Fund count
    const fc = AFL.state.funds.length;
    if (fc > 0) {
      document.getElementById('header-fund-count').textContent = fc + ' offerings live';
      document.getElementById('sidebar-fund-count').textContent = fc;
    }
  }

  // Expose so modules can call it
  AFL.updateHeader = updateHeader;

  // ── Sidebar active state ──
  function setActiveSidebarItem(moduleName) {
    document.querySelectorAll('.sidebar-nav-item').forEach(el => {
      el.classList.toggle('active', el.dataset.module === moduleName);
    });
  }

  // ── Core router: load a module ──
  async function loadModule(moduleName, params = {}) {
    if (!MODULE_FILES[moduleName]) {
      showError(`Unknown module: "${moduleName}"`);
      return;
    }

    showLoader();
    $mount.innerHTML = '';
    window.currentModule = null;
    currentModuleName = moduleName;
    lastParams = params;

    AFL.state.nav = moduleName;
    setActiveSidebarItem(moduleName);

    try {
      // Fetch the module HTML
      const res = await fetch(MODULE_FILES[moduleName] + '?v=' + Date.now());
      if (!res.ok) throw new Error(`HTTP ${res.status} — ${MODULE_FILES[moduleName]} not found`);
      const html = await res.text();

      // Parse the fetched HTML
      const parser  = new DOMParser();
      const doc     = parser.parseFromString(html, 'text/html');

      // Extract and inject <style> tags
      doc.querySelectorAll('style').forEach(style => {
        // Avoid duplicating styles on re-navigation
        const existing = document.querySelector(`style[data-module="${moduleName}"]`);
        if (existing) existing.remove();
        const clone = style.cloneNode(true);
        clone.setAttribute('data-module', moduleName);
        document.head.appendChild(clone);
      });

      // Inject body content into mount point
      $mount.innerHTML = doc.body.innerHTML;

      // Execute any <script> tags in the module
      // (innerHTML doesn't run scripts; we must re-create them)
      const scripts = $mount.querySelectorAll('script');
      for (const oldScript of scripts) {
        const newScript = document.createElement('script');
        if (oldScript.src) {
          newScript.src = oldScript.src;
          await new Promise((res, rej) => {
            newScript.onload = res;
            newScript.onerror = rej;
          });
        } else {
          newScript.textContent = oldScript.textContent;
        }
        oldScript.replaceWith(newScript);
      }

      hideLoader();

      // Call the module's init function
      if (window.currentModule && typeof window.currentModule.init === 'function') {
        await window.currentModule.init({
          client : AFL.state.client,
          basket : AFL.basket.get(),
          params : params,
          viewMode: AFL.state.viewMode,
        });
      } else {
        console.warn(`[Shell] Module "${moduleName}" did not export window.currentModule.init`);
      }

      updateHeader();

      // Scroll content area to top
      document.getElementById('app-content').scrollTop = 0;

    } catch (err) {
      console.error(`[Shell] Failed to load module "${moduleName}":`, err);
      if (err.message.includes('not found') || err.message.includes('404')) {
        showError(`${MODULE_FILES[moduleName]} hasn't been built yet. Coming soon!`);
      } else {
        showError(`Failed to load ${moduleName}: ${err.message}`);
      }
    }
  }

  // ── Navigate API (called by modules and header/sidebar) ──
  function navigate(moduleName, params = {}) {
    loadModule(moduleName, params);
  }

  // Expose on AFL object
  AFL.navigate = navigate;

  // ── Listen for afl:navigate events (from modules) ──
  window.addEventListener('afl:navigate', e => {
    const { module, params } = e.detail;
    loadModule(module, params || {});
  });

  // ── Listen for afl:header-update events (from modules) ──
  window.addEventListener('afl:header-update', () => updateHeader());

  // ── Sidebar nav clicks ──
  document.querySelectorAll('.sidebar-nav-item[data-module]').forEach(item => {
    item.addEventListener('click', () => {
      const moduleName = item.dataset.module;
      let params = {};
      try { params = item.dataset.params ? JSON.parse(item.dataset.params) : {}; } catch(e) {}
      navigate(moduleName, params);
    });
  });

  // ── Header view mode tabs ──
  document.querySelectorAll('.header-nav-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.header-nav-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      AFL.view.set(tab.dataset.mode);
      // Re-init current module with new view mode
      if (currentModuleName && window.currentModule && typeof window.currentModule.init === 'function') {
        window.currentModule.init({
          client  : AFL.state.client,
          basket  : AFL.basket.get(),
          params  : lastParams,
          viewMode: tab.dataset.mode,
        });
      }
    });
  });

  // ── Retry button ──
  $retry.addEventListener('click', () => {
    if (currentModuleName) loadModule(currentModuleName, lastParams);
  });

  // ── Refresh data button ──
  document.getElementById('sidebar-refresh-btn').addEventListener('click', async () => {
    toast('Refreshing offering data…', 'info');
    sessionStorage.removeItem('afl_funds');
    AFL.state.funds = [];
    await AFL.loadFunds(true);
    updateHeader();
    if (currentModuleName) loadModule(currentModuleName, lastParams);
    toast('Data refreshed ✓', 'success');
  });

  // ── AFL.toast exposed for modules ──
  AFL.toast = toast;

  // ── Boot: load initial module ──
  async function boot() {
    // Wait for AFL to be ready (shared.js loaded synchronously above, so should be immediate)
    if (!window.AFL) {
      console.error('[Shell] AFL not found — is shared.js loading?');
      showError('shared.js failed to load. Check the console.');
      return;
    }

    // Restore view mode tab state
    const savedMode = AFL.state.viewMode || 'advisor';
    document.querySelectorAll('.header-nav-tab').forEach(t => {
      t.classList.toggle('active', t.dataset.mode === savedMode);
    });

    // Determine starting module
    // Check URL hash first: #browse, #offering, etc.
    const hash = window.location.hash.replace('#','').trim();
    const startModule = (hash && MODULE_FILES[hash]) ? hash : (AFL.state.nav || 'browse');

    // Pre-load funds in background while first module loads
    AFL.loadFunds().then(funds => {
      updateHeader();
    }).catch(err => {
      console.warn('[Shell] Fund pre-load failed:', err);
    });

    loadModule(startModule);
  }

  // Handle URL hash navigation
  window.addEventListener('hashchange', () => {
    const hash = window.location.hash.replace('#','').trim();
    if (hash && MODULE_FILES[hash]) loadModule(hash);
  });

  // Update URL hash on navigation (for bookmarking)
  const _origNavigate = AFL.navigate;
  AFL.navigate = function(moduleName, params) {
    window.location.hash = moduleName;
    _origNavigate(moduleName, params);
  };

  // Boot when DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', boot);
  } else {
    boot();
  }

})();
</script>
</body>
</html>
